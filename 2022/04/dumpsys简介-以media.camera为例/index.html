<!DOCTYPE html>
<html lang="en-us">
  <head>
    
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Hugo 0.85.0 with theme Tranquilpeak 0.4.8-BETA">
<meta name="author" content="Yang Ju">
<meta name="keywords" content="">
<meta name="description" content="dumpsys是一种在Android设备上运行的工具，可提供有关系统服务的信息。在相机开发的过程中，关于一些相机的配置可以直接dumpsyss media.camera来查看。">


<meta property="og:description" content="dumpsys是一种在Android设备上运行的工具，可提供有关系统服务的信息。在相机开发的过程中，关于一些相机的配置可以直接dumpsyss media.camera来查看。">
<meta property="og:type" content="article">
<meta property="og:title" content="dumpsys简介 以media.camera为例">
<meta name="twitter:title" content="dumpsys简介 以media.camera为例">
<meta property="og:url" content="https://yangyang48.github.io/2022/04/dumpsys%E7%AE%80%E4%BB%8B-%E4%BB%A5media.camera%E4%B8%BA%E4%BE%8B/">
<meta property="twitter:url" content="https://yangyang48.github.io/2022/04/dumpsys%E7%AE%80%E4%BB%8B-%E4%BB%A5media.camera%E4%B8%BA%E4%BE%8B/">
<meta property="og:site_name" content="欢迎来到我的博客~">
<meta property="og:description" content="dumpsys是一种在Android设备上运行的工具，可提供有关系统服务的信息。在相机开发的过程中，关于一些相机的配置可以直接dumpsyss media.camera来查看。">
<meta name="twitter:description" content="dumpsys是一种在Android设备上运行的工具，可提供有关系统服务的信息。在相机开发的过程中，关于一些相机的配置可以直接dumpsyss media.camera来查看。">
<meta property="og:locale" content="zh-cn">

  
    <meta property="article:published_time" content="2022-04-17T00:00:00">
  
  
    <meta property="article:modified_time" content="2022-04-17T00:00:00">
  
  
  
    
      <meta property="article:section" content="dumpsys">
    
      <meta property="article:section" content="media.camera">
    
      <meta property="article:section" content="2022">
    
      <meta property="article:section" content="April">
    
  
  
    
      <meta property="article:tag" content="java">
    
      <meta property="article:tag" content="C&#43;&#43;">
    
      <meta property="article:tag" content="Android">
    
      <meta property="article:tag" content="源码">
    
  


<meta name="twitter:card" content="summary">







  <meta property="og:image" content="https://yangyang48.github.io/dumpsys/dumpsys_thumb.jpg">
  <meta property="twitter:image" content="https://yangyang48.github.io/dumpsys/dumpsys_thumb.jpg">


  <meta property="og:image" content="https://yangyang48.github.io/dumpsys/dumpsys_cover.jpg">
  <meta property="twitter:image" content="https://yangyang48.github.io/dumpsys/dumpsys_cover.jpg">




  <meta property="og:image" content="https://img-blog.csdnimg.cn/20210711204627625.jpg">
  <meta property="twitter:image" content="https://img-blog.csdnimg.cn/20210711204627625.jpg">


    <title>dumpsys简介 以media.camera为例</title>

    <link rel="icon" href="https://yangyang48.github.io/favicon.png">
    

    

    <link rel="canonical" href="https://yangyang48.github.io/2022/04/dumpsys%E7%AE%80%E4%BB%8B-%E4%BB%A5media.camera%E4%B8%BA%E4%BE%8B/">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.min.css" integrity="sha256-vuXZ9LGmmwtjqFX1F+EKin1ThZMub58gKULUyf0qECk=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/helpers/jquery.fancybox-thumbs.min.css" integrity="sha256-SEa4XYAHihTcEP1f5gARTB2K26Uk8PsndQYHQC1f4jU=" crossorigin="anonymous" />
    
    
    <link rel="stylesheet" href="https://yangyang48.github.io/css/style-twzjdbqhmnnacqs0pwwdzcdbt8yhv8giawvjqjmyfoqnvazl0dalmnhdkvp7.min.css" />
    
    
      
        <link rel="stylesheet"  href="https://yangyang48.github.io/css/copy-to-clipboard.css">
      
    

    
      
    
    

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="4">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://yangyang48.github.io/">欢迎来到我的博客~</a>
  </div>
  
    
      <a class="header-right-picture "
         href="https://yangyang48.github.io/#about">
    
    
    
      
        <img class="header-picture" src="https://img-blog.csdnimg.cn/20210711204627625.jpg" alt="作者的图片" />
      
    
    </a>
  
</header>

      <nav id="sidebar" data-behavior="4">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://yangyang48.github.io/#about">
          <img class="sidebar-profile-picture" src="https://img-blog.csdnimg.cn/20210711204627625.jpg" alt="作者的图片" />
        </a>
        <h4 class="sidebar-profile-name">Yang Ju</h4>
        
          <h5 class="sidebar-profile-bio">Nanjing University of Science and Technology</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://yangyang48.github.io/">
    
      <i class="sidebar-button-icon fa fa-lg fa-home"></i>
      
      <span class="sidebar-button-desc">首页</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://yangyang48.github.io/categories">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">分类</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://yangyang48.github.io/tags">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">标签</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://yangyang48.github.io/archives">
    
      <i class="sidebar-button-icon fa fa-lg fa-archive"></i>
      
      <span class="sidebar-button-desc">归档</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://yangyang48.github.io/#about">
    
      <i class="sidebar-button-icon fa fa-lg fa-question"></i>
      
      <span class="sidebar-button-desc">关于</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/YangYang48" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-github"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://blog.csdn.net/yangju147532896" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-chain"></i>
      
      <span class="sidebar-button-desc">CSDN</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
  </div>
</nav>

      
  <div class="post-header-cover
              text-center
              "
       style="background-image:url('/dumpsys/dumpsys_cover.jpg')"
       data-behavior="4">
    
  </div>


      <div id="main" data-behavior="4"
        class="hasCover
               hasCoverMetaOut
               ">
        <article class="post" itemscope itemType="http://schema.org/BlogPosting">
          
          
            <div class="post-header main-content-wrap text-center">
  
    <h1 class="post-title" itemprop="headline">
      dumpsys简介 以media.camera为例
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time itemprop="datePublished" datetime="2022-04-17T00:00:00Z">
        
  四月 17, 2022

      </time>
    
    
  
  
    <span>发布在</span>
    
      <a class="category-link" href="https://yangyang48.github.io/categories/dumpsys">dumpsys</a>, 
    
      <a class="category-link" href="https://yangyang48.github.io/categories/media.camera">media.camera</a>, 
    
      <a class="category-link" href="https://yangyang48.github.io/categories/2022">2022</a>, 
    
      <a class="category-link" href="https://yangyang48.github.io/categories/april">April</a>
    
  

  </div>

</div>
          
		  
		  <h5 id="wc" style="font-size: 1rem;text-align: center;">6200 Words|Read in about 29 Min|本文总阅读量<span id="busuanzi_value_page_pv"></span>次</h5>
		  
          <div class="post-content markdown" itemprop="articleBody">
            <div class="main-content-wrap">
              <p>dumpsys是一种在Android设备上运行的工具，可提供有关系统服务的信息。在相机开发的过程中，关于一些相机的配置可以直接dumpsyss media.camera来查看。</p>
<h1 id="1dumpsys">1dumpsys</h1>
<p>dumpsys是一种在Android设备上运行的工具，可提供有关系统服务的信息。可以通过ADB命令行调用dumpsys获取在连接的设备上运行的系统服务的诊断输出。</p>
<h2 id="11dumpsys-常见指令">1.1dumpsys 常见指令</h2>
<h3 id="111dumpsys---help">1.1.1dumpsys &ndash;help</h3>
<p>dumpsys工具的帮助文本</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>dumpsys --help
</code></pre></div>

 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/dumpsys/dumpsys_2.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/dumpsys/dumpsys_2.png" >
  
    </a>
  
  
</div>

<blockquote>
<p>对上面的AEGS打印整理</p>
<table>
<thead>
<tr>
<th>选项</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>-t timeout</td>
<td>指定超时期限（秒）。如果未指定，默认值为 10 秒。</td>
</tr>
<tr>
<td>-T TIMEOUT_MS</td>
<td>指定超时期限（毫秒）。如果未指定，默认值为 10 秒。</td>
</tr>
<tr>
<td>&ndash;help</td>
<td>输出 <code>dumpsys</code> 工具的帮助文本</td>
</tr>
<tr>
<td>-l</td>
<td>输出可与 <code>dumpsys</code> 配合使用的系统服务的完整列表</td>
</tr>
<tr>
<td>&ndash;skip services</td>
<td>指定不希望包含在输出中的 services</td>
</tr>
<tr>
<td>service [arguments]</td>
<td>指定希望输出的 service。某些服务可能允许您传递可选 arguments，可以通过将 <code>-h</code> 选项与服务名称一起传递来了解这些可选参数<!-- raw HTML omitted -->dumpsys activity -h</td>
</tr>
<tr>
<td>-c</td>
<td>指定某些服务时，附加此选项能以计算机可读的格式输出数据</td>
</tr>
<tr>
<td>-h</td>
<td>对于某些服务，附加此选项可查看该服务的帮助文本和其他选项</td>
</tr>
<tr>
<td>&ndash;proto</td>
<td>过滤支持以proto格式dump数据的服务，默认是全部打印，proto用于种结构化数据进行序列化</td>
</tr>
<tr>
<td>&ndash;priority LEVEL</td>
<td>根据指定的优先级过滤服务，LEVEL只能是三种里面选择，CRITICAL |  HIGH | NORMAL，分别是紧急，高和普通三种选项</td>
</tr>
</tbody>
</table>
</blockquote>
<h3 id="112dumpsys--l">1.1.2dumpsys -l</h3>
<p>输出所有支持dumpsys工具的系统服务的完整列表</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>dumpsys -l
</code></pre></div><blockquote>
<p>内容比较多，笔者这里划分成了常用服务和不常用服务用于区分。</p>
<table>
<thead>
<tr>
<th>服务名</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td>activity</td>
<td>AMS相关信息，可以打印一些activity的信息</td>
</tr>
<tr>
<td>adb</td>
<td>adb调试相关，adb的状态和一些信息</td>
</tr>
<tr>
<td>appops</td>
<td>app使用情况</td>
</tr>
<tr>
<td>audio</td>
<td>查看声音信息</td>
</tr>
<tr>
<td>cpuinfo</td>
<td>CPU统计相关</td>
</tr>
<tr>
<td>input</td>
<td>IMS，可以打印一些输入相关信息</td>
</tr>
<tr>
<td>media.audio_flinger</td>
<td>音频管理器</td>
</tr>
<tr>
<td>media.audio_policy</td>
<td>音频配置</td>
</tr>
<tr>
<td>media.camera</td>
<td>相机信息，具体会在后面详述</td>
</tr>
<tr>
<td>meminfo</td>
<td>内存相关，用于查看当前的内存使用情况</td>
</tr>
<tr>
<td>netstats</td>
<td>网络接口状态信息，监控TCP/IP网络的情况</td>
</tr>
<tr>
<td>permission</td>
<td>权限相关</td>
</tr>
<tr>
<td>package</td>
<td>PMS相关，打印一些package的信息</td>
</tr>
<tr>
<td>SurfaceFlinger</td>
<td>图像相关</td>
</tr>
<tr>
<td>window</td>
<td>WMS相关，主要是布局相关，可以查看栈顶的activity</td>
</tr>
<tr>
<td>wifi</td>
<td>网络相关，历史连接信心等等</td>
</tr>
</tbody>
</table>
<p>不常用的服务，除了本身的系统之外，一些芯片产商和手机产商会有自定义的服务</p>
<table>
<thead>
<tr>
<th>accessibility</th>
<th>account</th>
<th>activity_task</th>
<th>alarm</th>
<th>android.security.keystore</th>
</tr>
</thead>
<tbody>
<tr>
<td>app_binding</td>
<td>app_prediction</td>
<td>appwidget</td>
<td>autofill</td>
<td>ashmem_device_service</td>
</tr>
<tr>
<td>backup</td>
<td>battery</td>
<td>batteryproperties</td>
<td>batterystats</td>
<td>binder_calls_stats</td>
</tr>
<tr>
<td>biometric</td>
<td>bluetooth_manager</td>
<td>bsgamepad</td>
<td>bugreport</td>
<td></td>
</tr>
<tr>
<td>carrier_config</td>
<td>clipboard</td>
<td>color_display</td>
<td>companiondevice</td>
<td>com.goodix.FingerprintService</td>
</tr>
<tr>
<td>connectivity</td>
<td>connmetrics</td>
<td>consumer_ir</td>
<td>content</td>
<td>com.qualcomm.location.izat.IzatService</td>
</tr>
<tr>
<td>content_suggestions</td>
<td>contexthub</td>
<td>crossprofileapps</td>
<td>country_detector</td>
<td></td>
</tr>
<tr>
<td>DockObserver</td>
<td>dbinfo</td>
<td>device_config</td>
<td>device_identifiers</td>
<td>devicestoragemonitor</td>
</tr>
<tr>
<td>device_policy</td>
<td>deviceidle</td>
<td>diskstats</td>
<td>display</td>
<td>drm.drmManager</td>
</tr>
<tr>
<td>dpmservice</td>
<td>dreams</td>
<td>dropbox</td>
<td>dynamic_system</td>
<td></td>
</tr>
<tr>
<td>ethernet</td>
<td>extphone</td>
<td>external_vibrator_service</td>
<td></td>
<td></td>
</tr>
<tr>
<td>fingerprint</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>gfxinfo</td>
<td>gpu</td>
<td>graphicsstats</td>
<td></td>
<td></td>
</tr>
<tr>
<td>hardware_properties</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>idmap</td>
<td>imms</td>
<td>input_method</td>
<td>inputflinger</td>
<td>incidentcompanion</td>
</tr>
<tr>
<td>ions</td>
<td>ipsec</td>
<td>ircs</td>
<td>isms</td>
<td>iphonesubinfo</td>
</tr>
<tr>
<td>isub</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>jobscheduler</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>launcherapps</td>
<td>location</td>
<td>locationpolicy</td>
<td>lock_settings</td>
<td>looper_stats</td>
</tr>
<tr>
<td>media.aaudio</td>
<td>media.camera.proxy</td>
<td>media.drm</td>
<td>media.extractor</td>
<td>media.resource_manager</td>
</tr>
<tr>
<td>media.metrics</td>
<td>media.player</td>
<td>media_projection</td>
<td>media_router</td>
<td>media.sound_trigger_hw</td>
</tr>
<tr>
<td>media_session</td>
<td>midi</td>
<td>mount</td>
<td>media_resource_monitor</td>
<td></td>
</tr>
<tr>
<td>miui.fdpp</td>
<td>miui.face.FaceService</td>
<td>miui.sedc</td>
<td>miui.shell</td>
<td>miui.contentcatcher.ContentCatcherService</td>
</tr>
<tr>
<td>miui.whetstone.klo</td>
<td>miui.whetstone.mcd</td>
<td>miuiboosterservice</td>
<td>miui.mqsas.MQSService</td>
<td>miui.mqsas.IMQSNative</td>
</tr>
<tr>
<td>miui.whetstone.power</td>
<td>MiuiBackup</td>
<td>MiuiInit</td>
<td></td>
<td></td>
</tr>
<tr>
<td>netd_listener</td>
<td>netpolicy</td>
<td>netstats</td>
<td>network_score</td>
<td>network_management</td>
</tr>
<tr>
<td>network_stack</td>
<td>network_watchlist</td>
<td>nfc</td>
<td>notification</td>
<td>network_time_update_service</td>
</tr>
<tr>
<td>oem_lock</td>
<td>otadexopt</td>
<td>overlay</td>
<td></td>
<td></td>
</tr>
<tr>
<td>ProcessManager</td>
<td>package_native</td>
<td>perfshielder</td>
<td>phone</td>
<td>persistent_data_block</td>
</tr>
<tr>
<td>pinner</td>
<td>power</td>
<td>print</td>
<td>processinfo</td>
<td>procstats</td>
</tr>
<tr>
<td>qspmsvc</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>recovery</td>
<td>restrictions</td>
<td>role</td>
<td>rollback</td>
<td>runtime</td>
</tr>
<tr>
<td>search</td>
<td>secure_element</td>
<td>security</td>
<td>scheduling_policy</td>
<td>sec_key_att_app_id_provider</td>
</tr>
<tr>
<td>sensor_privacy</td>
<td>sensorservice</td>
<td>serial</td>
<td>settings</td>
<td>servicediscovery</td>
</tr>
<tr>
<td>shortcut</td>
<td>sip</td>
<td>slice</td>
<td>simphonebook</td>
<td>soundtrigger</td>
</tr>
<tr>
<td>stats</td>
<td>statscompanion</td>
<td>statusbar</td>
<td>storaged</td>
<td>storaged_pri</td>
</tr>
<tr>
<td>storagestats</td>
<td>system_update</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>telecom</td>
<td>testharness</td>
<td>textclassification</td>
<td>textservices</td>
<td>telephony.registry</td>
</tr>
<tr>
<td>thermalservice</td>
<td>time_detector</td>
<td>trust</td>
<td></td>
<td></td>
</tr>
<tr>
<td>uimode</td>
<td>updatelock</td>
<td>uri_grants</td>
<td>usagestats</td>
<td>usb</td>
</tr>
<tr>
<td>user</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>vibrator</td>
<td>voiceinteraction</td>
<td>vendor.perfservice</td>
<td>vendor.audio.vrservice</td>
<td></td>
</tr>
<tr>
<td>wallpaper</td>
<td>webviewupdate</td>
<td>wifi</td>
<td>wifiaware</td>
<td>whetstone.activity</td>
</tr>
<tr>
<td>wificond</td>
<td>wifip2p</td>
<td>wifirtt</td>
<td>wifiscanner</td>
<td></td>
</tr>
<tr>
<td>xiaomi.joyose</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<h3 id="113dumpsys--t">1.1.3dumpsys -t</h3>
<p>指定dumpsys工具的超时期限</p>
<p>举一个例子，dumpsys中meminfo的dump输出会比较耗时。</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>dumpsys -t <span class="m">2</span> meminfo
</code></pre></div>

 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/dumpsys/dumpsys_1.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/dumpsys/dumpsys_1.png" >
  
    </a>
  
  
</div>

<h3 id="114dumpsys---skip">1.1.4dumpsys &ndash;skip</h3>
<p>指定不希望包含在输出中的 services</p>
<p>笔者这里去除所有，只留下adb的服务，这样一下就能发现</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>dumpsys --skip DockObserver   MiuiBackup   MiuiInit   ProcessManager   SurfaceFlinger   accessibility   account   activity   activity_task    alarm   android.security.keystore   app_binding   app_prediction   appops   appwidget   ashmem_device_service   audio   autofill   backup   battery   batteryproperties   batterystats   binder_calls_stats   biometric   bluetooth_manager   bsgamepad   bugreport   carrier_config clipboard   color_display   com.goodix.FingerprintService   com.qualcomm.location.izat.IzatService   companiondevice   connectivity   connmetrics   consumer_ir   content   content_suggestions   contexthub   country_detector   cpuinfo   crossprofileapps   dbinfo device_config   device_identifiers   device_policy   deviceidle   devicestoragemonitor  diskstats   display   dpmservice   dreams   drm.drmManager   dropbox   dynamic_system  ethernet   external_vibrator_service   extphone   fingerprint   gfxinfo   gpu   graphicsstats   hardware_properties   idmap   imms   incidentcompanion   input   input_method  inputflinger   ions   iphonesubinfo   ipsec   ircs   isms   isub   jobscheduler   launcherapps   location   locationpolicy   lock_settings   looper_stats   media.aaudio   media.audio_flinger   media.audio_policy   media.camera   media.camera.proxy   media.drm media.extractor   media.metrics   media.player   media.resource_manager   media.sound_trigger_hw   media_projection   media_resource_monitor   media_router   media_session   meminfo   midi   miui.contentcatcher.ContentCatcherService   miui.face.FaceService   miui.fdpp   miui.mqsas.IMQSNative   miui.mqsas.MQSService   miui.sedc   miui.shell   miui.whetstone.klo   miui.whetstone.mcd   miui.whetstone.power   miuiboosterservice   mount   netd_listener   netpolicy   netstats   network_management   network_score   network_stack  network_time_update_service   network_watchlist   nfc   notification   oem_lock   otadexopt   overlay   package   package_native   perfshielder   permission   persistent_data_block   phone   pinner   power   print   processinfo   procstats   qspmsvc   recovery restrictions   role   rollback   runtime   scheduling_policy   search   sec_key_att_app_id_provider   secure_element   security   sensor_privacy   sensorservice   serial   servicediscovery   settings   shortcut   simphonebook   sip   slice   soundtrigger   stats  statscompanion   statusbar   storaged   storaged_pri   storagestats   system_update telecom   telephony.registry   testharness   textclassification   textservices   thermalservice   time_detector   trust   uimode   updatelock   uri_grants   usagestats   usb user   vendor.audio.vrservice   vendor.perfservice   vibrator   voiceinteraction   wallpaper   webviewupdate   whetstone.activity   wifi   wifiaware   wificond   wifip2p   wifirtt   wifiscanner   window   xiaomi.joyose
</code></pre></div><p>这里截取部分输出信息，可以看到如果被skip包含进去的service，后面会被追加skipped的标志位，然后输出的时候就会被自动过滤掉。然后接着会输出未被skipped标志的所有服务，这里只有adb服务，那么下面就会输出dump这个adb的服务内容。</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/dumpsys/dumpsys_3.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/dumpsys/dumpsys_3.png" >
  
    </a>
  
  
</div>



 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/dumpsys/dumpsys_4.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/dumpsys/dumpsys_4.png" >
  
    </a>
  
  
</div>

<h3 id="115dumpsys---priority">1.1.5dumpsys &ndash;priority</h3>
<p>根据指定的优先级过滤服务，LEVEL只能是三种里面选择</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/dumpsys/dumpsys_8.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/dumpsys/dumpsys_8.png" >
  
    </a>
  
  
</div>

<p>这里默认有三种等级的服务，分别有CRITICAL |  HIGH | NORMAL。这里只能打印显示三种优先级的服务，如果需要自定义添加删除，需要在对应的服务添加的时候去修改。这里暂且按下不表，在后面的源码过程中会比较清楚。</p>
<h3 id="116dumpsys-service">1.1.6dumpsys SERVICE</h3>
<p>指定希望输出的 service。某些服务可能允许您传递可选 arguments</p>
<p>这里包含两部分，一部分是指定service，另一部分除了指定service之外，还可以增加参数</p>
<p>有些是支持参数的，可以通过-h查询</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>dumpsys activity -h
</code></pre></div>

 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/dumpsys/dumpsys_6.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/dumpsys/dumpsys_6.png" >
  
    </a>
  
  
</div>

<p>还有一些是不支持的，比如adb</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>dumpsys adb -h
</code></pre></div>

 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/dumpsys/dumpsys_5.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/dumpsys/dumpsys_5.png" >
  
    </a>
  
  
</div>

<h3 id="117dumpsys---proto">1.1.7dumpsys &ndash;proto</h3>
<p>过滤支持以proto格式dump数据的服务</p>
<p>可以看到比如window这个服务是支持proto的，那么我可以直接以这种方式输出，proto可以认为是一种序列化方式。</p>
<p>关于是否支持proto，可以通过直接在一个服务中-h，先查询是否可以有&ndash;proto的选项，有的话那就支持。</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>dumpsys window --proto
</code></pre></div>

 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/dumpsys/dumpsys_7.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/dumpsys/dumpsys_7.png" >
  
    </a>
  
  
</div>

<p>打印出来是乱码，这是因为输出默认就是protocol的格式，是一种二进制文件，需要特定的方式还原到可以阅读的方式，具体dump出来的proto数据，如何解析可以查看<a href="https://www.jianshu.com/p/1cc7615f030f?utm_campaign=maleskine&amp;utm_content=note&amp;utm_medium=seo_notes&amp;utm_source=recommendation">这里</a>。</p>
<h2 id="12实例">1.2实例</h2>
<p>例如常见的指令</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>dumpsys --help
<span class="ln">2</span>dumpsys adb
<span class="ln">3</span>dumpsys window -h
<span class="ln">4</span>dumpsys activity --proto
<span class="ln">5</span>dumpsys --skip meminfo
<span class="ln">6</span>dumpsys --priority HIGH -l
</code></pre></div><h1 id="2dumpsys源码分析">2dumpsys源码分析</h1>
<p>dumpsys是Android自带的强大debug工具，它其实是一个进程，类似源码目录下的external目录下的一些工程文件用于自定义进程，apk等等。本文以android 11源码做分析。</p>
<p>目录结构如下所示</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/dumpsys/dumpsys_10.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/dumpsys/dumpsys_10.png" >
  
    </a>
  
  
</div>

<p>因为这个dumpsys是一个进程没被定义在bp文件中，dumpsys是被编译成了一个可执行的文件，并放在了系统中，路径在/system/bin目录下面</p>
<div class="highlight"><pre class="chroma"><code class="language-makefile" data-lang="makefile"><span class="ln"> 1</span><span class="err">//frameworks/native/cmds/dumpsys/Android.bp</span>
<span class="ln"> 2</span><span class="err">//</span>
<span class="ln"> 3</span><span class="err">//</span> <span class="err">Executable</span>
<span class="ln"> 4</span><span class="err">//</span>
<span class="ln"> 5</span>
<span class="ln"> 6</span><span class="err">cc_binary</span> <span class="err">{</span>
<span class="ln"> 7</span>    <span class="nf">name</span><span class="o">:</span> &#34;<span class="n">dumpsys</span>&#34;<span class="p">,</span>
<span class="ln"> 8</span>
<span class="ln"> 9</span>    defaults: <span class="o">[</span><span class="s2">&#34;dumpsys_defaults&#34;</span><span class="o">]</span>,
<span class="ln">10</span>
<span class="ln">11</span>    srcs: <span class="o">[</span>
<span class="ln">12</span>        <span class="s2">&#34;main.cpp&#34;</span>,
<span class="ln">13</span>    <span class="o">]</span>,
<span class="ln">14</span><span class="err">}</span>
</code></pre></div><p>通过bp文件调用到main.cpp的函数入口，main函数</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//frameworks/native/cmds/dumpsys/main.cpp#main
</span><span class="ln"> 2</span><span class="c1"></span><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="k">const</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
<span class="ln"> 3</span>    <span class="n">signal</span><span class="p">(</span><span class="n">SIGPIPE</span><span class="p">,</span> <span class="n">SIG_IGN</span><span class="p">);</span>
<span class="ln"> 4</span>    <span class="c1">//获取大管家serviceManager
</span><span class="ln"> 5</span><span class="c1"></span>    <span class="n">sp</span><span class="o">&lt;</span><span class="n">IServiceManager</span><span class="o">&gt;</span> <span class="n">sm</span> <span class="o">=</span> <span class="n">defaultServiceManager</span><span class="p">();</span>
<span class="ln"> 6</span>    <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
<span class="ln"> 7</span>    <span class="k">if</span> <span class="p">(</span><span class="n">sm</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 8</span>        <span class="n">ALOGE</span><span class="p">(</span><span class="s">&#34;Unable to get default service manager!&#34;</span><span class="p">);</span>
<span class="ln"> 9</span>        <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;dumpsys: Unable to get default service manager!&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="ln">10</span>        <span class="k">return</span> <span class="mi">20</span><span class="p">;</span>
<span class="ln">11</span>    <span class="p">}</span>
<span class="ln">12</span>    <span class="c1">//最终调用到了这里的main
</span><span class="ln">13</span><span class="c1"></span>    <span class="n">Dumpsys</span> <span class="n">dumpsys</span><span class="p">(</span><span class="n">sm</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
<span class="ln">14</span>    <span class="k">return</span> <span class="n">dumpsys</span><span class="p">.</span><span class="n">main</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
<span class="ln">15</span><span class="p">}</span>
</code></pre></div><p>最终会调用到这里，因为代码比较冗长，这里<strong>笔者人为的分成三段</strong>。</p>
<h2 id="21dumpsys的option处理">2.1Dumpsys的Option处理</h2>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//frameworks/native/cmds/dumpsys/dumpsys.cpp#Dumpsys::main#1
</span><span class="ln"> 2</span><span class="c1"></span><span class="kt">int</span> <span class="n">Dumpsys</span><span class="o">::</span><span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="k">const</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
<span class="ln"> 3</span>    <span class="n">Vector</span><span class="o">&lt;</span><span class="n">String16</span><span class="o">&gt;</span> <span class="n">services</span><span class="p">;</span>
<span class="ln"> 4</span>    <span class="n">Vector</span><span class="o">&lt;</span><span class="n">String16</span><span class="o">&gt;</span> <span class="n">args</span><span class="p">;</span>
<span class="ln"> 5</span>    <span class="n">String16</span> <span class="n">priorityType</span><span class="p">;</span>
<span class="ln"> 6</span>    <span class="n">Vector</span><span class="o">&lt;</span><span class="n">String16</span><span class="o">&gt;</span> <span class="n">skippedServices</span><span class="p">;</span>
<span class="ln"> 7</span>    <span class="n">Vector</span><span class="o">&lt;</span><span class="n">String16</span><span class="o">&gt;</span> <span class="n">protoServices</span><span class="p">;</span>
<span class="ln"> 8</span>    <span class="kt">bool</span> <span class="n">showListOnly</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="ln"> 9</span>    <span class="kt">bool</span> <span class="n">skipServices</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="ln">10</span>    <span class="kt">bool</span> <span class="n">asProto</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="ln">11</span>    <span class="n">Type</span> <span class="n">type</span> <span class="o">=</span> <span class="n">Type</span><span class="o">::</span><span class="n">DUMP</span><span class="p">;</span>
<span class="ln">12</span>    <span class="kt">int</span> <span class="n">timeoutArgMs</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>
<span class="ln">13</span>    <span class="kt">int</span> <span class="n">priorityFlags</span> <span class="o">=</span> <span class="n">IServiceManager</span><span class="o">::</span><span class="n">DUMP_FLAG_PRIORITY_ALL</span><span class="p">;</span>
<span class="ln">14</span>    <span class="k">static</span> <span class="k">struct</span> <span class="nc">option</span> <span class="n">longOptions</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{{</span><span class="s">&#34;pid&#34;</span><span class="p">,</span> <span class="n">no_argument</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
<span class="ln">15</span>                                          <span class="p">{</span><span class="s">&#34;priority&#34;</span><span class="p">,</span> <span class="n">required_argument</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
<span class="ln">16</span>                                          <span class="p">{</span><span class="s">&#34;proto&#34;</span><span class="p">,</span> <span class="n">no_argument</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
<span class="ln">17</span>                                          <span class="p">{</span><span class="s">&#34;skip&#34;</span><span class="p">,</span> <span class="n">no_argument</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
<span class="ln">18</span>                                          <span class="p">{</span><span class="s">&#34;help&#34;</span><span class="p">,</span> <span class="n">no_argument</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
<span class="ln">19</span>                                          <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}};</span>
<span class="ln">20</span>    <span class="n">optind</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="ln">21</span>    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">22</span>        <span class="kt">int</span> <span class="n">c</span><span class="p">;</span>
<span class="ln">23</span>        <span class="kt">int</span> <span class="n">optionIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="ln">24</span>		<span class="c1">//这个函数比较重要，需要结合longOptions分析
</span><span class="ln">25</span><span class="c1"></span>        <span class="n">c</span> <span class="o">=</span> <span class="n">getopt_long</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="s">&#34;+t:T:l&#34;</span><span class="p">,</span> <span class="n">longOptions</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">optionIndex</span><span class="p">);</span>
<span class="ln">26</span>
<span class="ln">27</span>        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">28</span>            <span class="k">break</span><span class="p">;</span>
<span class="ln">29</span>        <span class="p">}</span>
<span class="ln">30</span>
<span class="ln">31</span>        <span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">32</span>        <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
<span class="ln">33</span>            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">longOptions</span><span class="p">[</span><span class="n">optionIndex</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="s">&#34;skip&#34;</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">34</span>                <span class="n">skipServices</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="ln">35</span>            <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">longOptions</span><span class="p">[</span><span class="n">optionIndex</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="s">&#34;proto&#34;</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">36</span>                <span class="n">asProto</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="ln">37</span>            <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">longOptions</span><span class="p">[</span><span class="n">optionIndex</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="s">&#34;help&#34;</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">38</span>                <span class="n">usage</span><span class="p">();</span>
<span class="ln">39</span>                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="ln">40</span>            <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">longOptions</span><span class="p">[</span><span class="n">optionIndex</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="s">&#34;priority&#34;</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">41</span>                <span class="n">priorityType</span> <span class="o">=</span> <span class="n">String16</span><span class="p">(</span><span class="n">String8</span><span class="p">(</span><span class="n">optarg</span><span class="p">));</span>
<span class="ln">42</span>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ConvertPriorityTypeToBitmask</span><span class="p">(</span><span class="n">priorityType</span><span class="p">,</span> <span class="n">priorityFlags</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">43</span>                    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
<span class="ln">44</span>                    <span class="n">usage</span><span class="p">();</span>
<span class="ln">45</span>                    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="ln">46</span>                <span class="p">}</span>
<span class="ln">47</span>            <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">longOptions</span><span class="p">[</span><span class="n">optionIndex</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="s">&#34;pid&#34;</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">48</span>                <span class="n">type</span> <span class="o">=</span> <span class="n">Type</span><span class="o">::</span><span class="n">PID</span><span class="p">;</span>
<span class="ln">49</span>            <span class="p">}</span>
<span class="ln">50</span>            <span class="k">break</span><span class="p">;</span>
<span class="ln">51</span>
<span class="ln">52</span>        <span class="k">case</span> <span class="sc">&#39;t&#39;</span><span class="o">:</span>
<span class="ln">53</span>            <span class="p">{</span>
<span class="ln">54</span>                <span class="kt">char</span><span class="o">*</span> <span class="n">endptr</span><span class="p">;</span>
<span class="ln">55</span>                <span class="n">timeoutArgMs</span> <span class="o">=</span> <span class="n">strtol</span><span class="p">(</span><span class="n">optarg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">endptr</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
<span class="ln">56</span>                <span class="n">timeoutArgMs</span> <span class="o">=</span> <span class="n">timeoutArgMs</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
<span class="ln">57</span>                <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">endptr</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span> <span class="o">||</span> <span class="n">timeoutArgMs</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">58</span>                    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Error: invalid timeout(seconds) number: &#39;%s&#39;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">optarg</span><span class="p">);</span>
<span class="ln">59</span>                    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="ln">60</span>                <span class="p">}</span>
<span class="ln">61</span>            <span class="p">}</span>
<span class="ln">62</span>            <span class="k">break</span><span class="p">;</span>
<span class="ln">63</span>
<span class="ln">64</span>        <span class="k">case</span> <span class="sc">&#39;T&#39;</span><span class="o">:</span>
<span class="ln">65</span>            <span class="p">{</span>
<span class="ln">66</span>                <span class="kt">char</span><span class="o">*</span> <span class="n">endptr</span><span class="p">;</span>
<span class="ln">67</span>                <span class="n">timeoutArgMs</span> <span class="o">=</span> <span class="n">strtol</span><span class="p">(</span><span class="n">optarg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">endptr</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
<span class="ln">68</span>                <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">endptr</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span> <span class="o">||</span> <span class="n">timeoutArgMs</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">69</span>                    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Error: invalid timeout(milliseconds) number: &#39;%s&#39;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">optarg</span><span class="p">);</span>
<span class="ln">70</span>                    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="ln">71</span>                <span class="p">}</span>
<span class="ln">72</span>            <span class="p">}</span>
<span class="ln">73</span>            <span class="k">break</span><span class="p">;</span>
<span class="ln">74</span>
<span class="ln">75</span>        <span class="k">case</span> <span class="sc">&#39;l&#39;</span><span class="o">:</span>
<span class="ln">76</span>            <span class="n">showListOnly</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="ln">77</span>            <span class="k">break</span><span class="p">;</span>
<span class="ln">78</span>
<span class="ln">79</span>        <span class="k">default</span><span class="o">:</span>
<span class="ln">80</span>            <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
<span class="ln">81</span>            <span class="n">usage</span><span class="p">();</span>
<span class="ln">82</span>            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="ln">83</span>        <span class="p">}</span>
<span class="ln">84</span>    <span class="p">}</span>
<span class="ln">85</span>    <span class="p">...</span>
<span class="ln">86</span><span class="p">}</span>
</code></pre></div><blockquote>
<p>上述有几个陌生的函数，这里稍微提一下</p>
<p>getopt_long</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln">1</span><span class="kt">int</span> <span class="nf">getopt_long</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">argv</span><span class="p">[],</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">optstring</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="nc">option</span> <span class="o">*</span><span class="n">longopts</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">longindex</span><span class="p">);</span>
</code></pre></div><p>1、<strong>argc和argv</strong>和main函数的两个参数一致</p>
<p>2、<strong>optstring:</strong> 表示短选项字符串。这里用到了&quot;+t:T:l&quot;，实际上是由三个函数，t和T都带一个参数，l后面不带参数，</p>
<div class="highlight"><pre class="chroma"><code class="language-tex" data-lang="tex"><span class="ln">1</span>形式如“a:b::cd:“，分别表示程序支持的命令行短选项有-a、-b、-c、-d，冒号含义如下：
<span class="ln">2</span>(1)只有一个字符，不带冒号——只表示选项， 如-c 
<span class="ln">3</span>(2)一个字符，后接一个冒号——表示选项后面带一个参数，如-a 100
<span class="ln">4</span>(3)一个字符，后接两个冒号——表示选项后面带一个可选参数，即参数可有可无， 如果带参数，则选项与参数直接不能有空格
<span class="ln">5</span>    形式应该如-b200
</code></pre></div><p>3、<strong>longopts</strong>：表示长选项结构体，这里可自定义参数</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="k">struct</span> <span class="nc">option</span> 
<span class="ln"> 2</span><span class="p">{</span>  
<span class="ln"> 3</span>    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>  
<span class="ln"> 4</span>    <span class="kt">int</span>         <span class="n">has_arg</span><span class="p">;</span>  
<span class="ln"> 5</span>    <span class="kt">int</span>        <span class="o">*</span><span class="n">flag</span><span class="p">;</span>  
<span class="ln"> 6</span>    <span class="kt">int</span>         <span class="n">val</span><span class="p">;</span>  
<span class="ln"> 7</span><span class="p">};</span>
<span class="ln"> 8</span><span class="c1">//本文自定的内容如下
</span><span class="ln"> 9</span><span class="c1"></span><span class="k">static</span> <span class="k">struct</span> <span class="nc">option</span> <span class="n">longOptions</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{{</span><span class="s">&#34;pid&#34;</span><span class="p">,</span> <span class="n">no_argument</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
<span class="ln">10</span>                                      <span class="p">{</span><span class="s">&#34;priority&#34;</span><span class="p">,</span> <span class="n">required_argument</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
<span class="ln">11</span>                                      <span class="p">{</span><span class="s">&#34;proto&#34;</span><span class="p">,</span> <span class="n">no_argument</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
<span class="ln">12</span>                                      <span class="p">{</span><span class="s">&#34;skip&#34;</span><span class="p">,</span> <span class="n">no_argument</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
<span class="ln">13</span>                                      <span class="p">{</span><span class="s">&#34;help&#34;</span><span class="p">,</span> <span class="n">no_argument</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
<span class="ln">14</span>                                      <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}};</span>
</code></pre></div><p>这里的option结构体有四个成员</p>
<ol>
<li>
<p>name:表示选项的名称,比如pid,priority,proto等。</p>
</li>
<li>
<p>has_arg:表示选项后面是否携带参数。该参数有三个不同值，如下：</p>
<p>a:  no_argument(或者是0)时   ——参数后面不跟参数值，eg: &ndash;help</p>
<p>b: required_argument(或者是1)时 ——参数输入格式为：&ndash;参数 值 或者 &ndash;参数=值。eg:&ndash;dir=/home</p>
<p>c: optional_argument(或者是2)时  ——参数输入格式只能为：&ndash;参数=值</p>
</li>
<li>
<p>flag:这个参数有两个意思，空或者非空。</p>
<p>a:<strong>如果参数为空NULL，那么当选中某个长选项的时候，getopt_long将返回val值</strong>。</p>
<p>eg，可执行程序 &ndash;help，getopt_long的返回值为h.</p>
<p>b:如果参数不为空，那么当选中某个长选项的时候，getopt_long将返回0，并且将flag指针参数指向val值。</p>
<p>eg: 可执行程序 &ndash;http-proxy=127.0.0.1:80 那么getopt_long返回值为0，并且flag指向的值为1。</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln">1</span><span class="k">static</span> <span class="k">struct</span> <span class="nc">option</span> <span class="n">longOpts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="ln">2</span>    <span class="p">{</span> <span class="s">&#34;daemon&#34;</span><span class="p">,</span> <span class="n">no_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="sc">&#39;D&#39;</span> <span class="p">},</span>
<span class="ln">3</span>    <span class="p">{</span> <span class="s">&#34;dir&#34;</span><span class="p">,</span> <span class="n">required_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="sc">&#39;d&#39;</span> <span class="p">},</span>
<span class="ln">4</span>    <span class="p">{</span> <span class="s">&#34;http-proxy&#34;</span><span class="p">,</span> <span class="n">required_argument</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flag</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
<span class="ln">5</span>    <span class="p">{</span> <span class="s">&#34;version&#34;</span><span class="p">,</span> <span class="n">no_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="sc">&#39;v&#39;</span> <span class="p">},</span>
<span class="ln">6</span>    <span class="p">{</span> <span class="s">&#34;help&#34;</span><span class="p">,</span> <span class="n">no_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="sc">&#39;h&#39;</span> <span class="p">},</span>
<span class="ln">7</span>    <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}</span>
<span class="ln">8</span><span class="p">};</span>
</code></pre></div></li>
<li>
<p>val：表示指定函数找到该选项时的返回值，或者当flag非空时指定flag指向的数据的值val。</p>
</li>
</ol>
<p>4、<strong>longindex：longindex</strong>非空，它指向的变量将记录当前找到参数符合longopts里的第几个元素的描述，即是longopts的下标值</p>
<p>补充注意点：</p>
<ul>
<li>如果 optstring 的第一个字符是 <strong>'+'</strong> 或设置了环境变量 POSIXLY_CORRECT，则一旦遇到<strong>非选项参数</strong>，选项处理就会停止</li>
<li>如果 optstring 的第一个字符是 &lsquo;-'，则每个非选项 argv 元素都被处理为就好像<strong>它是具有字符代码 1 的选项的参数</strong>一样</li>
<li>如果 getopt() 不能识别选项字符，它会向 stderr 打印一条错误消息，将该字符存储在 optopt 中，然后返回“？”</li>
<li>如果 optstring 的第一个字符（在上述任何可选的 &lsquo;+&rsquo; 或 &lsquo;-&rsquo; 之后）是冒号 (':')，则 getopt() 返回 &lsquo;:&rsquo; 而不是 &lsquo;?'，表示缺少选项参数。</li>
<li>如果检测到错误，并且 optstring 的第一个字符不是冒号，并且外部变量 opterr 不为零（这是默认值），则 getopt() 会打印一条错误消息。</li>
<li>更多详细的内容，可通过man getopt_long在linux c函数中查看。</li>
</ul>
</blockquote>
<h3 id="211-getopt_long">2.1.1 getopt_long</h3>
<p>那么本文的getopt_long(argc, argv, &ldquo;+t:T:l&rdquo;, longOptions, &amp;optionIndex);含义就是</p>
<p>总共会有四种返回值，分别是t，T，l和0。因为自定义的longOpts里面的val都为0，所以返回值为0的又会有5种情况，分别对应结构体的5个name，&ldquo;pid&rdquo;，&ldquo;priority&rdquo;，&ldquo;proto&rdquo;，&ldquo;skip&rdquo;，&ldquo;help&rdquo;。</p>
<h3 id="212-convertprioritytypetobitmask">2.1.2 ConvertPriorityTypeToBitmask</h3>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//frameworks/native/cmds/dumpsys/dumpsys.cpp#ConvertPriorityTypeToBitmask
</span><span class="ln"> 2</span><span class="c1"></span><span class="k">static</span> <span class="kt">bool</span> <span class="nf">ConvertPriorityTypeToBitmask</span><span class="p">(</span><span class="k">const</span> <span class="n">String16</span><span class="o">&amp;</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span><span class="o">&amp;</span> <span class="n">bitmask</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 3</span>    <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">PriorityDumper</span><span class="o">::</span><span class="n">PRIORITY_ARG_CRITICAL</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 4</span>        <span class="n">bitmask</span> <span class="o">=</span> <span class="n">IServiceManager</span><span class="o">::</span><span class="n">DUMP_FLAG_PRIORITY_CRITICAL</span><span class="p">;</span>
<span class="ln"> 5</span>        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="ln"> 6</span>    <span class="p">}</span>
<span class="ln"> 7</span>    <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">PriorityDumper</span><span class="o">::</span><span class="n">PRIORITY_ARG_HIGH</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 8</span>        <span class="n">bitmask</span> <span class="o">=</span> <span class="n">IServiceManager</span><span class="o">::</span><span class="n">DUMP_FLAG_PRIORITY_HIGH</span><span class="p">;</span>
<span class="ln"> 9</span>        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="ln">10</span>    <span class="p">}</span>
<span class="ln">11</span>    <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">PriorityDumper</span><span class="o">::</span><span class="n">PRIORITY_ARG_NORMAL</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">12</span>        <span class="n">bitmask</span> <span class="o">=</span> <span class="n">IServiceManager</span><span class="o">::</span><span class="n">DUMP_FLAG_PRIORITY_NORMAL</span><span class="p">;</span>
<span class="ln">13</span>        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="ln">14</span>    <span class="p">}</span>
<span class="ln">15</span>    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="ln">16</span><span class="p">}</span>
</code></pre></div><p>这个函数用来打印优先级的服务，比如根据上述1.1.5过程中的图片，我们只能打印优先级的服务</p>
<p>如果我们需要自己添加删除服务优先级的话，也是可以的。比如对于activity的修改，首先打开AMS。可以看到只要对应修改DUMP_FLAG_PRIORITY_的值即可。</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//framworks/base/services/core/java/com/android/server/am/ActivityManagerService.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="k">public</span> <span class="kt">void</span> <span class="nf">setSystemProcess</span><span class="p">()</span> <span class="p">{</span>
<span class="ln"> 3</span>    <span class="k">try</span> <span class="p">{</span>
<span class="ln"> 4</span>        <span class="c1">//这里的Context.ACTIVITY_SERVICE里面有CRITICAL和NORMAL，如果需要在HIGH中添加，在添加一个DUMP_FLAG_PRIORITY_HIGH即可
</span><span class="ln"> 5</span><span class="c1"></span>        <span class="n">ServiceManager</span><span class="p">.</span><span class="n">addService</span><span class="p">(</span><span class="n">Context</span><span class="p">.</span><span class="n">ACTIVITY_SERVICE</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="cm">/* allowIsolated= */</span> <span class="nb">true</span><span class="p">,</span>
<span class="ln"> 6</span>                                  <span class="n">DUMP_FLAG_PRIORITY_CRITICAL</span> <span class="o">|</span> <span class="n">DUMP_FLAG_PRIORITY_NORMAL</span> <span class="o">|</span> <span class="n">DUMP_FLAG_PROTO</span><span class="p">);</span>
<span class="ln"> 7</span>        <span class="n">ServiceManager</span><span class="p">.</span><span class="n">addService</span><span class="p">(</span><span class="n">ProcessStats</span><span class="p">.</span><span class="n">SERVICE_NAME</span><span class="p">,</span> <span class="n">mProcessStats</span><span class="p">);</span>
<span class="ln"> 8</span>        <span class="c1">//对应的meminfo，默认是在优先级HIGH中的
</span><span class="ln"> 9</span><span class="c1"></span>        <span class="n">ServiceManager</span><span class="p">.</span><span class="n">addService</span><span class="p">(</span><span class="s">&#34;meminfo&#34;</span><span class="p">,</span> <span class="k">new</span> <span class="n">MemBinder</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="cm">/* allowIsolated= */</span> <span class="nb">false</span><span class="p">,</span>
<span class="ln">10</span>                                  <span class="n">DUMP_FLAG_PRIORITY_HIGH</span><span class="p">);</span>
<span class="ln">11</span>        <span class="n">ServiceManager</span><span class="p">.</span><span class="n">addService</span><span class="p">(</span><span class="s">&#34;gfxinfo&#34;</span><span class="p">,</span> <span class="k">new</span> <span class="n">GraphicsBinder</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
<span class="ln">12</span>        <span class="n">ServiceManager</span><span class="p">.</span><span class="n">addService</span><span class="p">(</span><span class="s">&#34;dbinfo&#34;</span><span class="p">,</span> <span class="k">new</span> <span class="n">DbBinder</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
<span class="ln">13</span>        <span class="k">if</span> <span class="p">(</span><span class="n">MONITOR_CPU_USAGE</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">14</span>            <span class="n">ServiceManager</span><span class="p">.</span><span class="n">addService</span><span class="p">(</span><span class="s">&#34;cpuinfo&#34;</span><span class="p">,</span> <span class="k">new</span> <span class="n">CpuBinder</span><span class="p">(</span><span class="k">this</span><span class="p">),</span>
<span class="ln">15</span>                                      <span class="cm">/* allowIsolated= */</span> <span class="nb">false</span><span class="p">,</span> <span class="n">DUMP_FLAG_PRIORITY_CRITICAL</span><span class="p">);</span>
<span class="ln">16</span>        <span class="p">}</span>
<span class="ln">17</span>        <span class="n">ServiceManager</span><span class="p">.</span><span class="n">addService</span><span class="p">(</span><span class="s">&#34;permission&#34;</span><span class="p">,</span> <span class="k">new</span> <span class="n">PermissionController</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
<span class="ln">18</span>        <span class="n">ServiceManager</span><span class="p">.</span><span class="n">addService</span><span class="p">(</span><span class="s">&#34;processinfo&#34;</span><span class="p">,</span> <span class="k">new</span> <span class="n">ProcessInfoService</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
<span class="ln">19</span>        <span class="n">ServiceManager</span><span class="p">.</span><span class="n">addService</span><span class="p">(</span><span class="s">&#34;cacheinfo&#34;</span><span class="p">,</span> <span class="k">new</span> <span class="n">CacheBinder</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
<span class="ln">20</span>        <span class="p">...</span>
<span class="ln">21</span>    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">PackageManager</span><span class="p">.</span><span class="n">NameNotFoundException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">22</span>        <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="p">(</span>
<span class="ln">23</span>            <span class="s">&#34;Unable to find android system package&#34;</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
<span class="ln">24</span>    <span class="p">}</span>
<span class="ln">25</span>
<span class="ln">26</span>    <span class="p">...</span>
<span class="ln">27</span><span class="p">}</span>
<span class="ln">28</span>
</code></pre></div>

 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/dumpsys/dumpsys_9.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/dumpsys/dumpsys_9.png" >
  
    </a>
  
  
</div>

<h2 id="22dumpsys-services的处理">2.2Dumpsys services的处理</h2>
<p>这里做了service的操作，用于标记是否为skipped，标记过skipped的服务，会在最后打印过程中列出，并且显示(skipped)</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//frameworks/native/cmds/dumpsys/dumpsys.cpp#Dumpsys::main#2
</span><span class="ln"> 2</span><span class="c1"></span><span class="kt">int</span> <span class="n">Dumpsys</span><span class="o">::</span><span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="k">const</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
<span class="ln"> 3</span>    <span class="p">...</span>
<span class="ln"> 4</span>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">optind</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 5</span>        <span class="k">if</span> <span class="p">(</span><span class="n">skipServices</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 6</span>            <span class="c1">//如果是skip关键字后的服务，那么就存到这个数组中
</span><span class="ln"> 7</span><span class="c1"></span>            <span class="n">skippedServices</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">String16</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
<span class="ln"> 8</span>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="ln"> 9</span>            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">optind</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">10</span>                <span class="c1">//这个optind实际上是保存的service，类似dumpsys activity
</span><span class="ln">11</span><span class="c1"></span>                <span class="n">services</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">String16</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
<span class="ln">12</span>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="ln">13</span>                <span class="k">const</span> <span class="n">String16</span> <span class="nf">arg</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="ln">14</span>                <span class="n">args</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
<span class="ln">15</span>				<span class="c1">//这里面的PriorityDumper::PROTO_ARG为 u&#34;--proto&#34;
</span><span class="ln">16</span><span class="c1"></span>                <span class="c1">//用于判断单个服务后面跟的参数是proto类型
</span><span class="ln">17</span><span class="c1"></span>                <span class="c1">//比如dumpsys activity --proto就会走到这里
</span><span class="ln">18</span><span class="c1"></span>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asProto</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">arg</span><span class="p">.</span><span class="n">compare</span><span class="p">(</span><span class="n">String16</span><span class="p">(</span><span class="n">PriorityDumper</span><span class="o">::</span><span class="n">PROTO_ARG</span><span class="p">)))</span> <span class="p">{</span>
<span class="ln">19</span>                    <span class="n">asProto</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="ln">20</span>                <span class="p">}</span>
<span class="ln">21</span>            <span class="p">}</span>
<span class="ln">22</span>        <span class="p">}</span>
<span class="ln">23</span>    <span class="p">}</span>
<span class="ln">24</span>
<span class="ln">25</span>    <span class="k">if</span> <span class="p">((</span><span class="n">skipServices</span> <span class="o">&amp;&amp;</span> <span class="n">skippedServices</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="o">||</span>
<span class="ln">26</span>            <span class="p">(</span><span class="n">showListOnly</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">services</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">||</span> <span class="o">!</span><span class="n">skippedServices</span><span class="p">.</span><span class="n">empty</span><span class="p">())))</span> <span class="p">{</span>
<span class="ln">27</span>        <span class="n">usage</span><span class="p">();</span>
<span class="ln">28</span>        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="ln">29</span>    <span class="p">}</span>
<span class="ln">30</span>
<span class="ln">31</span>    <span class="k">if</span> <span class="p">(</span><span class="n">services</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">||</span> <span class="n">showListOnly</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">32</span>        <span class="c1">//有两种情况会把所有的服务添加到services数组，一个进行skip操作，另外一种-l或者是什么参数都不加
</span><span class="ln">33</span><span class="c1"></span>        <span class="n">services</span> <span class="o">=</span> <span class="n">listServices</span><span class="p">(</span><span class="n">priorityFlags</span><span class="p">,</span> <span class="n">asProto</span><span class="p">);</span>
<span class="ln">34</span>        <span class="n">setServiceArgs</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">asProto</span><span class="p">,</span> <span class="n">priorityFlags</span><span class="p">);</span>
<span class="ln">35</span>    <span class="p">}</span>
<span class="ln">36</span>
<span class="ln">37</span>    <span class="k">const</span> <span class="n">size_t</span> <span class="n">N</span> <span class="o">=</span> <span class="n">services</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<span class="ln">38</span>    <span class="k">if</span> <span class="p">(</span><span class="n">N</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">39</span>        <span class="c1">// first print a list of the current services
</span><span class="ln">40</span><span class="c1"></span>        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Currently running services:&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="ln">41</span>
<span class="ln">42</span>        <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">43</span>            <span class="c1">//校验是否service存在，如果没有这个服务就会有提示不存在
</span><span class="ln">44</span><span class="c1"></span>            <span class="n">sp</span><span class="o">&lt;</span><span class="n">IBinder</span><span class="o">&gt;</span> <span class="n">service</span> <span class="o">=</span> <span class="n">sm_</span><span class="o">-&gt;</span><span class="n">checkService</span><span class="p">(</span><span class="n">services</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="ln">45</span>            <span class="c1">//这里主要判断是都需要加(skipped)标记
</span><span class="ln">46</span><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="n">service</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">47</span>                <span class="kt">bool</span> <span class="n">skipped</span> <span class="o">=</span> <span class="n">IsSkipped</span><span class="p">(</span><span class="n">skippedServices</span><span class="p">,</span> <span class="n">services</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="ln">48</span>                <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;  &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">services</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">skipped</span> <span class="o">?</span> <span class="s">&#34; (skipped)&#34;</span> <span class="o">:</span> <span class="s">&#34;&#34;</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="ln">49</span>            <span class="p">}</span>
<span class="ln">50</span>        <span class="p">}</span>
<span class="ln">51</span>    <span class="p">}</span>
<span class="ln">52</span>
<span class="ln">53</span>    <span class="k">if</span> <span class="p">(</span><span class="n">showListOnly</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">54</span>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="ln">55</span>    <span class="p">}</span>
<span class="ln">56</span>    <span class="p">...</span>
<span class="ln">57</span><span class="p">}</span>
</code></pre></div><p>这里的逻辑比较简单，主要是判断是否存在&ndash;skip的存在，并将一系列的skip的services保存起来。</p>
<p>有两种情况，一种只有skip标志位，还有一种是service+可加参数组合</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/dumpsys/dumpsys_11.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/dumpsys/dumpsys_11.png" >
  
    </a>
  
  
</div>



 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/dumpsys/dumpsys_12.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/dumpsys/dumpsys_12.png" >
  
    </a>
  
  
</div>

<h3 id="221listservices">2.2.1listServices</h3>
<p>这个函数的作用，<strong>是将priorityFilterFlags类型的服务添加到services数组中，对做一个排序</strong>，这里排序用到了STL的仿函数，仿函数为sort_func。</p>
<p>如果这个函数的filterByProto是true，那么这些服务可以进行proto操作，会将原本存在services数组中的服务数组转移到另外一个叫protoServices的数组中。</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//frameworks/native/cmds/dumpsys/dumpsys.cpp#Dumpsys::listServices
</span><span class="ln"> 2</span><span class="c1"></span><span class="n">Vector</span><span class="o">&lt;</span><span class="n">String16</span><span class="o">&gt;</span> <span class="n">Dumpsys</span><span class="o">::</span><span class="n">listServices</span><span class="p">(</span><span class="kt">int</span> <span class="n">priorityFilterFlags</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">filterByProto</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
<span class="ln"> 3</span>    <span class="n">Vector</span><span class="o">&lt;</span><span class="n">String16</span><span class="o">&gt;</span> <span class="n">services</span> <span class="o">=</span> <span class="n">sm_</span><span class="o">-&gt;</span><span class="n">listServices</span><span class="p">(</span><span class="n">priorityFilterFlags</span><span class="p">);</span>
<span class="ln"> 4</span>    <span class="n">services</span><span class="p">.</span><span class="n">sort</span><span class="p">(</span><span class="n">sort_func</span><span class="p">);</span>
<span class="ln"> 5</span>    <span class="k">if</span> <span class="p">(</span><span class="n">filterByProto</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 6</span>        <span class="n">Vector</span><span class="o">&lt;</span><span class="n">String16</span><span class="o">&gt;</span> <span class="n">protoServices</span> <span class="o">=</span> <span class="n">sm_</span><span class="o">-&gt;</span><span class="n">listServices</span><span class="p">(</span><span class="n">IServiceManager</span><span class="o">::</span><span class="n">DUMP_FLAG_PROTO</span><span class="p">);</span>
<span class="ln"> 7</span>        <span class="n">protoServices</span><span class="p">.</span><span class="n">sort</span><span class="p">(</span><span class="n">sort_func</span><span class="p">);</span>
<span class="ln"> 8</span>        <span class="n">Vector</span><span class="o">&lt;</span><span class="n">String16</span><span class="o">&gt;</span> <span class="n">intersection</span><span class="p">;</span>
<span class="ln"> 9</span>        <span class="n">std</span><span class="o">::</span><span class="n">set_intersection</span><span class="p">(</span><span class="n">services</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">services</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">protoServices</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span>
<span class="ln">10</span>                              <span class="n">protoServices</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">std</span><span class="o">::</span><span class="n">back_inserter</span><span class="p">(</span><span class="n">intersection</span><span class="p">));</span>
<span class="ln">11</span>        <span class="n">services</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">intersection</span><span class="p">);</span>
<span class="ln">12</span>    <span class="p">}</span>
<span class="ln">13</span>    <span class="k">return</span> <span class="n">services</span><span class="p">;</span>
<span class="ln">14</span><span class="p">}</span>
<span class="ln">15</span>
<span class="ln">16</span><span class="c1">//仿函数
</span><span class="ln">17</span><span class="c1"></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">sort_func</span><span class="p">(</span><span class="k">const</span> <span class="n">String16</span><span class="o">*</span> <span class="n">lhs</span><span class="p">,</span> <span class="k">const</span> <span class="n">String16</span><span class="o">*</span> <span class="n">rhs</span><span class="p">)</span>
<span class="ln">18</span><span class="p">{</span>
<span class="ln">19</span>    <span class="k">return</span> <span class="n">lhs</span><span class="o">-&gt;</span><span class="n">compare</span><span class="p">(</span><span class="o">*</span><span class="n">rhs</span><span class="p">);</span>
<span class="ln">20</span><span class="p">}</span>
</code></pre></div><p>无proto操作</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/dumpsys/dumpsys_13.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/dumpsys/dumpsys_13.png" >
  
    </a>
  
  
</div>

<p>proto操作</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/dumpsys/dumpsys_14.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/dumpsys/dumpsys_14.png" >
  
    </a>
  
  
</div>

<p>这个函数调用listServices(priorityFlags, asProto)，入参为priorityFlags和asProto，默认priorityFlags为DUMP_FLAG_PRIORITY_ALL。其中的DUMP_FLAG_PRIORITY_ALL就是15，也就是包含所有服务的意思。asProto是判断这个服务是否可以进行Proto序列化的操作输出。</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln">1</span><span class="c1">//frameworks/native/libs/binder/include/binder/IServiceManager.h        
</span><span class="ln">2</span><span class="c1"></span><span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">DUMP_FLAG_PRIORITY_CRITICAL</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">;</span>									<span class="c1">//1
</span><span class="ln">3</span><span class="c1"></span><span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">DUMP_FLAG_PRIORITY_HIGH</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>										<span class="c1">//2
</span><span class="ln">4</span><span class="c1"></span><span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">DUMP_FLAG_PRIORITY_NORMAL</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>									<span class="c1">//4
</span><span class="ln">5</span><span class="c1"></span><span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">DUMP_FLAG_PRIORITY_DEFAULT</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>									<span class="c1">//8
</span><span class="ln">6</span><span class="c1"></span><span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">DUMP_FLAG_PRIORITY_ALL</span> <span class="o">=</span> <span class="n">DUMP_FLAG_PRIORITY_CRITICAL</span> <span class="o">|</span>
<span class="ln">7</span>    <span class="n">DUMP_FLAG_PRIORITY_HIGH</span> <span class="o">|</span> <span class="n">DUMP_FLAG_PRIORITY_NORMAL</span> <span class="o">|</span> <span class="n">DUMP_FLAG_PRIORITY_DEFAULT</span><span class="p">;</span>	<span class="c1">//15
</span><span class="ln">8</span><span class="c1"></span><span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">DUMP_FLAG_PROTO</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>												<span class="c1">//16
</span></code></pre></div><h2 id="23dumpsys-services的实现">2.3dumpsys services的实现</h2>
<p>通过上面的三个vector数组和标志位，再加上对services的检查，开始针对对应的services进行dumpsys数据。默认不加参数也是dumpsys所有的services。</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//frameworks/native/cmds/dumpsys/dumpsys.cpp#Dumpsys::main#3
</span><span class="ln"> 2</span><span class="c1"></span><span class="kt">int</span> <span class="n">Dumpsys</span><span class="o">::</span><span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="k">const</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
<span class="ln"> 3</span>    <span class="p">...</span>
<span class="ln"> 4</span>    <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 5</span>        <span class="k">const</span> <span class="n">String16</span><span class="o">&amp;</span> <span class="n">serviceName</span> <span class="o">=</span> <span class="n">services</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="ln"> 6</span>        <span class="k">if</span> <span class="p">(</span><span class="n">IsSkipped</span><span class="p">(</span><span class="n">skippedServices</span><span class="p">,</span> <span class="n">serviceName</span><span class="p">))</span> <span class="k">continue</span><span class="p">;</span>
<span class="ln"> 7</span>
<span class="ln"> 8</span>        <span class="c1">//检查是否状态值为OK
</span><span class="ln"> 9</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">startDumpThread</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">serviceName</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="n">OK</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">10</span>            <span class="kt">bool</span> <span class="n">addSeparator</span> <span class="o">=</span> <span class="p">(</span><span class="n">N</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">);</span>
<span class="ln">11</span>            <span class="k">if</span> <span class="p">(</span><span class="n">addSeparator</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">12</span>                <span class="n">writeDumpHeader</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="n">serviceName</span><span class="p">,</span> <span class="n">priorityFlags</span><span class="p">);</span>
<span class="ln">13</span>            <span class="p">}</span>
<span class="ln">14</span>            <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">elapsedDuration</span><span class="p">;</span>
<span class="ln">15</span>            <span class="n">size_t</span> <span class="n">bytesWritten</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="ln">16</span>            
<span class="ln">17</span>            <span class="n">status_t</span> <span class="n">status</span> <span class="o">=</span>
<span class="ln">18</span>                <span class="n">writeDump</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="n">serviceName</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">milliseconds</span><span class="p">(</span><span class="n">timeoutArgMs</span><span class="p">),</span>
<span class="ln">19</span>                          <span class="n">asProto</span><span class="p">,</span> <span class="n">elapsedDuration</span><span class="p">,</span> <span class="n">bytesWritten</span><span class="p">);</span>
<span class="ln">20</span>
<span class="ln">21</span>            <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">TIMED_OUT</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">22</span>                <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span>
<span class="ln">23</span>                     <span class="o">&lt;&lt;</span> <span class="s">&#34;*** SERVICE &#39;&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">serviceName</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;&#39; DUMP TIMEOUT (&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">timeoutArgMs</span>
<span class="ln">24</span>                     <span class="o">&lt;&lt;</span> <span class="s">&#34;ms) EXPIRED ***&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span>
<span class="ln">25</span>                     <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="ln">26</span>            <span class="p">}</span>
<span class="ln">27</span>
<span class="ln">28</span>            <span class="k">if</span> <span class="p">(</span><span class="n">addSeparator</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">29</span>                <span class="n">writeDumpFooter</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="n">serviceName</span><span class="p">,</span> <span class="n">elapsedDuration</span><span class="p">);</span>
<span class="ln">30</span>            <span class="p">}</span>
<span class="ln">31</span>            <span class="kt">bool</span> <span class="n">dumpComplete</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">OK</span><span class="p">);</span>
<span class="ln">32</span>            <span class="n">stopDumpThread</span><span class="p">(</span><span class="n">dumpComplete</span><span class="p">);</span>
<span class="ln">33</span>        <span class="p">}</span>
<span class="ln">34</span>    <span class="p">}</span>
<span class="ln">35</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="ln">36</span><span class="p">}</span>
</code></pre></div><h3 id="231startdumpthread">2.3.1startDumpThread</h3>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//frameworks/native/cmds/dumpsys/dumpsys.cpp#Dumpsys::startDumpThread
</span><span class="ln"> 2</span><span class="c1"></span><span class="n">status_t</span> <span class="n">Dumpsys</span><span class="o">::</span><span class="n">startDumpThread</span><span class="p">(</span><span class="n">Type</span> <span class="n">type</span><span class="p">,</span> <span class="k">const</span> <span class="n">String16</span><span class="o">&amp;</span> <span class="n">serviceName</span><span class="p">,</span>
<span class="ln"> 3</span>                                  <span class="k">const</span> <span class="n">Vector</span><span class="o">&lt;</span><span class="n">String16</span><span class="o">&gt;&amp;</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 4</span>    <span class="c1">//如果输入的只有一个service，那么这里需要去进行服务校验
</span><span class="ln"> 5</span><span class="c1"></span>    <span class="n">sp</span><span class="o">&lt;</span><span class="n">IBinder</span><span class="o">&gt;</span> <span class="n">service</span> <span class="o">=</span> <span class="n">sm_</span><span class="o">-&gt;</span><span class="n">checkService</span><span class="p">(</span><span class="n">serviceName</span><span class="p">);</span>
<span class="ln"> 6</span>    <span class="k">if</span> <span class="p">(</span><span class="n">service</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 7</span>        <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Can&#39;t find service: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">serviceName</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="ln"> 8</span>        <span class="k">return</span> <span class="n">NAME_NOT_FOUND</span><span class="p">;</span>
<span class="ln"> 9</span>    <span class="p">}</span>
<span class="ln">10</span>    
<span class="ln">11</span>    
<span class="ln">12</span>    <span class="kt">int</span> <span class="n">sfd</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="ln">13</span>    <span class="k">if</span> <span class="p">(</span><span class="n">pipe</span><span class="p">(</span><span class="n">sfd</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">14</span>        <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Failed to create pipe to dump service info for &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">serviceName</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;: &#34;</span>
<span class="ln">15</span>             <span class="o">&lt;&lt;</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="ln">16</span>        <span class="k">return</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>
<span class="ln">17</span>    <span class="p">}</span>
<span class="ln">18</span>
<span class="ln">19</span>    <span class="n">redirectFd_</span> <span class="o">=</span> <span class="n">unique_fd</span><span class="p">(</span><span class="n">sfd</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="ln">20</span>    <span class="n">unique_fd</span> <span class="nf">remote_end</span><span class="p">(</span><span class="n">sfd</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="ln">21</span>    <span class="n">sfd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sfd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="ln">22</span>
<span class="ln">23</span>    <span class="c1">//用异步回调的方式调用到真是的service-&gt;dump
</span><span class="ln">24</span><span class="c1"></span>    <span class="n">activeThread_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="p">([</span><span class="o">=</span><span class="p">,</span> <span class="n">remote_end</span><span class="p">{</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">remote_end</span><span class="p">)}]()</span> <span class="k">mutable</span> <span class="p">{</span>
<span class="ln">25</span>        <span class="n">status_t</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="ln">26</span>
<span class="ln">27</span>        <span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">28</span>        <span class="k">case</span> <span class="n">Type</span><span class="o">::</span><span class="nl">DUMP</span><span class="p">:</span>
<span class="ln">29</span>            <span class="c1">//这里是默认的dump
</span><span class="ln">30</span><span class="c1"></span>            <span class="n">err</span> <span class="o">=</span> <span class="n">service</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">(</span><span class="n">remote_end</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">args</span><span class="p">);</span>
<span class="ln">31</span>            <span class="k">break</span><span class="p">;</span>
<span class="ln">32</span>        <span class="k">case</span> <span class="n">Type</span><span class="o">::</span><span class="nl">PID</span><span class="p">:</span>
<span class="ln">33</span>            <span class="n">err</span> <span class="o">=</span> <span class="n">dumpPidToFd</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">remote_end</span><span class="p">);</span>
<span class="ln">34</span>            <span class="k">break</span><span class="p">;</span>
<span class="ln">35</span>        <span class="k">default</span><span class="o">:</span>
<span class="ln">36</span>            <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Unknown dump type&#34;</span> <span class="o">&lt;&lt;</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="ln">37</span>            <span class="k">return</span><span class="p">;</span>
<span class="ln">38</span>        <span class="p">}</span>
<span class="ln">39</span>
<span class="ln">40</span>        <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="n">OK</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">41</span>            <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Error dumping service info status_t: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">statusToString</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; &#34;</span>
<span class="ln">42</span>                 <span class="o">&lt;&lt;</span> <span class="n">serviceName</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="ln">43</span>        <span class="p">}</span>
<span class="ln">44</span>    <span class="p">});</span>
<span class="ln">45</span>    <span class="k">return</span> <span class="n">OK</span><span class="p">;</span>
<span class="ln">46</span><span class="p">}</span>
</code></pre></div><blockquote>
<p>这里用到了管道pipe函数，管道是一种把两个进程之间的标准输入和标准输出连接起来的机制，从而提供一种让多个进程间通信的方法。如下图所示。</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/dumpsys/dumpsys_15.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/dumpsys/dumpsys_15.png" >
  
    </a>
  
  
</div>

<p>特别如下：</p>
<ul>
<li><strong>数据只能从管道的一端写入，从另一端读出</strong></li>
<li>写入管道的数据遵循先入先从出的规则</li>
<li><strong>管道不是普通的文件，不属于某个文件系统，其只存在于内存中</strong></li>
<li>管道在内存中对应一个缓冲区，不同的系统其大小不一定相同</li>
<li><strong>从管道读数据是一次性操作，数据一旦被读走，它就从管道中丢弃，释放空间以便写更多的数据</strong></li>
</ul>
<p>而本文中的通过新启动一个线程，将fd数组的fd[0]去做读的操作，fd[1]去做write操作，如下unique_fd参数中的读写操作。</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln">1</span><span class="c1">//system/core/base/include/android-base/unique_fd.h
</span><span class="ln">2</span><span class="c1"></span><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Closer</span><span class="o">&gt;</span>
<span class="ln">3</span><span class="kr">inline</span> <span class="kt">bool</span> <span class="n">Pipe</span><span class="p">(</span><span class="n">unique_fd_impl</span><span class="o">&lt;</span><span class="n">Closer</span><span class="o">&gt;*</span> <span class="n">read</span><span class="p">,</span> <span class="n">unique_fd_impl</span><span class="o">&lt;</span><span class="n">Closer</span><span class="o">&gt;*</span> <span class="n">write</span><span class="p">,</span>
<span class="ln">4</span>                 <span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">O_CLOEXEC</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">5</span>    <span class="p">...</span>
<span class="ln">6</span>    <span class="n">read</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">(</span><span class="n">pipefd</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="ln">7</span>    <span class="n">write</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">(</span><span class="n">pipefd</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="ln">8</span>    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="ln">9</span><span class="p">}</span>
</code></pre></div>

 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/dumpsys/dumpsys_18.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/dumpsys/dumpsys_18.png" >
  
    </a>
  
  
</div>

<p>写入操作的fd[1]就是remote_end，会传入到对应service::dump中去，把dump的数据写入到管道中。</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln">1</span><span class="c1">//这里是默认的dump
</span><span class="ln">2</span><span class="c1"></span><span class="n">err</span> <span class="o">=</span> <span class="n">service</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">(</span><span class="n">remote_end</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">args</span><span class="p">);</span>
</code></pre></div></blockquote>
<p>关于如何获取ServiceManager和Service这个后续会在Binder篇章中详细解析，这个先按下不表。</p>
<p>由前面的原理可知， 先要查询sm-&gt;checkService(“media.camera”)，这里得到的是CameraService，那么也就意味着上述命令等价于调用CameraService.dump()。 同理其他的命令也是类似的方式。</p>
<h3 id="232writedump">2.3.2writeDump</h3>
<p>这个函数比较复杂，涉及到linux的poll机制。跟上面的写入管道操作对应，这里是从管道中读出，<code>redirectFd_</code>对应是fd[0]，这里的<code>redirectFd_</code>是全局变量，所以在startDumpThread的异步操作写入到管道中，这里的writeDump可以从管道中读出数据。</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//frameworks/native/cmds/dumpsys/dumpsys.cpp#Dumpsys::writeDump
</span><span class="ln"> 2</span><span class="c1"></span><span class="n">status_t</span> <span class="n">Dumpsys</span><span class="o">::</span><span class="n">writeDump</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">const</span> <span class="n">String16</span><span class="o">&amp;</span> <span class="n">serviceName</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">milliseconds</span> <span class="n">timeout</span><span class="p">,</span>
<span class="ln"> 3</span>                            <span class="kt">bool</span> <span class="n">asProto</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;&amp;</span> <span class="n">elapsedDuration</span><span class="p">,</span>
<span class="ln"> 4</span>                            <span class="n">size_t</span><span class="o">&amp;</span> <span class="n">bytesWritten</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
<span class="ln"> 5</span>    <span class="n">status_t</span> <span class="n">status</span> <span class="o">=</span> <span class="n">OK</span><span class="p">;</span>
<span class="ln"> 6</span>    <span class="n">size_t</span> <span class="n">totalBytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="ln"> 7</span>    <span class="k">auto</span> <span class="n">start</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
<span class="ln"> 8</span>    <span class="k">auto</span> <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">timeout</span><span class="p">;</span>
<span class="ln"> 9</span>
<span class="ln">10</span>    <span class="kt">int</span> <span class="n">serviceDumpFd</span> <span class="o">=</span> <span class="n">redirectFd_</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>
<span class="ln">11</span>    <span class="k">if</span> <span class="p">(</span><span class="n">serviceDumpFd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">12</span>        <span class="k">return</span> <span class="n">INVALID_OPERATION</span><span class="p">;</span>
<span class="ln">13</span>    <span class="p">}</span>
<span class="ln">14</span>
<span class="ln">15</span>    <span class="k">struct</span> <span class="nc">pollfd</span> <span class="n">pfd</span> <span class="o">=</span> <span class="p">{.</span><span class="n">fd</span> <span class="o">=</span> <span class="n">serviceDumpFd</span><span class="p">,</span> <span class="p">.</span><span class="n">events</span> <span class="o">=</span> <span class="n">POLLIN</span><span class="p">};</span>
<span class="ln">16</span>
<span class="ln">17</span>    <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">18</span>        <span class="c1">// Wrap this in a lambda so that TEMP_FAILURE_RETRY recalculates the timeout.
</span><span class="ln">19</span><span class="c1"></span>        <span class="k">auto</span> <span class="n">time_left_ms</span> <span class="o">=</span> <span class="p">[</span><span class="n">end</span><span class="p">]()</span> <span class="p">{</span>
<span class="ln">20</span>            <span class="k">auto</span> <span class="n">now</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
<span class="ln">21</span>            <span class="k">auto</span> <span class="n">diff</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">milliseconds</span><span class="o">&gt;</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">now</span><span class="p">);</span>
<span class="ln">22</span>            <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">diff</span><span class="p">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0LL</span><span class="p">);</span>
<span class="ln">23</span>        <span class="p">};</span>
<span class="ln">24</span>
<span class="ln">25</span>        <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">TEMP_FAILURE_RETRY</span><span class="p">(</span><span class="n">poll</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pfd</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">time_left_ms</span><span class="p">()));</span>
<span class="ln">26</span>        <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">27</span>            <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Error in poll while dumping service &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">serviceName</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; : &#34;</span>
<span class="ln">28</span>                 <span class="o">&lt;&lt;</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="ln">29</span>            <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>
<span class="ln">30</span>            <span class="k">break</span><span class="p">;</span>
<span class="ln">31</span>        <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">32</span>            <span class="n">status</span> <span class="o">=</span> <span class="n">TIMED_OUT</span><span class="p">;</span>
<span class="ln">33</span>            <span class="k">break</span><span class="p">;</span>
<span class="ln">34</span>        <span class="p">}</span>
<span class="ln">35</span>
<span class="ln">36</span>        <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">4096</span><span class="p">];</span>
<span class="ln">37</span>        <span class="c1">//从管道中读出数据，每次管道输出4096个字节大小
</span><span class="ln">38</span><span class="c1"></span>        <span class="n">rc</span> <span class="o">=</span> <span class="n">TEMP_FAILURE_RETRY</span><span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">redirectFd_</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)));</span>
<span class="ln">39</span>        <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">40</span>            <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Failed to read while dumping service &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">serviceName</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;: &#34;</span>
<span class="ln">41</span>                 <span class="o">&lt;&lt;</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="ln">42</span>            <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>
<span class="ln">43</span>            <span class="k">break</span><span class="p">;</span>
<span class="ln">44</span>        <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">45</span>            <span class="c1">// EOF.
</span><span class="ln">46</span><span class="c1"></span>            <span class="k">break</span><span class="p">;</span>
<span class="ln">47</span>        <span class="p">}</span>
<span class="ln">48</span>
<span class="ln">49</span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">WriteFully</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">rc</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">50</span>            <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Failed to write while dumping service &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">serviceName</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;: &#34;</span>
<span class="ln">51</span>                 <span class="o">&lt;&lt;</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="ln">52</span>            <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>
<span class="ln">53</span>            <span class="k">break</span><span class="p">;</span>
<span class="ln">54</span>        <span class="p">}</span>
<span class="ln">55</span>        <span class="n">totalBytes</span> <span class="o">+=</span> <span class="n">rc</span><span class="p">;</span>
<span class="ln">56</span>    <span class="p">}</span>
<span class="ln">57</span>
<span class="ln">58</span>    <span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">==</span> <span class="n">TIMED_OUT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">asProto</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">59</span>        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">StringPrintf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">*** SERVICE &#39;%s&#39; DUMP TIMEOUT (%llums) EXPIRED ***</span><span class="se">\n\n</span><span class="s">&#34;</span><span class="p">,</span>
<span class="ln">60</span>                                       <span class="n">String8</span><span class="p">(</span><span class="n">serviceName</span><span class="p">).</span><span class="n">string</span><span class="p">(),</span> <span class="n">timeout</span><span class="p">.</span><span class="n">count</span><span class="p">());</span>
<span class="ln">61</span>        <span class="n">WriteStringToFd</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">fd</span><span class="p">);</span>
<span class="ln">62</span>    <span class="p">}</span>
<span class="ln">63</span>
<span class="ln">64</span>    <span class="n">elapsedDuration</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="o">::</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>
<span class="ln">65</span>    <span class="n">bytesWritten</span> <span class="o">=</span> <span class="n">totalBytes</span><span class="p">;</span>
<span class="ln">66</span>    <span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="ln">67</span><span class="p">}</span>
</code></pre></div><h1 id="3dumpsys-mediacamera">3dumpsys media.camera</h1>
<h2 id="31打印结果">3.1打印结果</h2>
<p>这里开始解释一下名词，和详细的信息，因为笔者没有高通对接的Camera源码，也只能通过例子结合网上说明去解释。</p>
<p>这里的打印主要分成这六种信息，下面对几种信息简单概述，具体可在文末可以下载具体的dump信息。</p>
<h3 id="311service-global-info">3.1.1Service global info</h3>
<div class="highlight"><pre class="chroma"><code class="language-tex" data-lang="tex"><span class="ln"> 1</span>Number of camera devices: 10
<span class="ln"> 2</span>Number of normal camera devices: 6
<span class="ln"> 3</span>    Device 0 maps to &#34;0&#34;
<span class="ln"> 4</span>    Device 1 maps to &#34;1&#34;
<span class="ln"> 5</span>    Device 2 maps to &#34;2&#34;
<span class="ln"> 6</span>    Device 3 maps to &#34;3&#34;
<span class="ln"> 7</span>    Device 4 maps to &#34;8&#34;
<span class="ln"> 8</span>    Device 5 maps to &#34;9&#34;
<span class="ln"> 9</span>Active Camera Clients:
<span class="ln">10</span>[
<span class="ln">11</span>(Camera ID: 0, Cost: 99, PID: 14259, Score: -900, State: 0User Id: 0, Client Package Name: com.android.camera, Conflicting Client Devices: <span class="nb">{</span>6, <span class="nb">}</span>)
<span class="ln">12</span>]
<span class="ln">13</span>Allowed user IDs: 0, 999
</code></pre></div><p>上面的含义是总共有十个摄像头可支持，但是目前能用的是6个，其中当前用的摄像头是设备0。</p>
<p>这里解释一下，以红米K30说明。其中的device 0是后摄，device 1是前摄，device 2是微距，device 3是专业模式，device 6是人像模式。</p>
<h3 id="312eventlog">3.1.2EventLog</h3>
<div class="highlight"><pre class="chroma"><code class="language-tex" data-lang="tex"><span class="ln">1</span>04-15 22:35:16 : CONNECT device 0 client for package com.android.camera (PID 14259)
<span class="ln">2</span>04-15 16:12:04 : DISCONNECT device 0 client for package com.eg.android.AlipayGphone (PID 30996)
<span class="ln">3</span>04-15 16:12:00 : CONNECT device 0 client for package com.eg.android.AlipayGphone (PID 30996)
<span class="ln">4</span>04-15 14:55:08 : DISCONNECT device 0 client for package com.zte.softda (PID 24784)
<span class="ln">5</span>04-15 14:55:06 : CONNECT device 0 client for package com.zte.softda (PID 24784)
<span class="ln">6</span>04-15 10:17:27 : DISCONNECT device 0 client for package com.tencent.mm (PID 13858)
<span class="ln">7</span>04-15 10:17:24 : CONNECT device 0 client for package com.tencent.mm (PID 13858)
<span class="ln">8</span>...
</code></pre></div><p>正常能够容纳100条，历史使用摄像头记录。包括时间，哪种设备连接摄像头，以及连接哪个device的摄像头情况。</p>
<h3 id="313camera-device-dynamic-info">3.1.3Camera device dynamic info</h3>
<div class="highlight"><pre class="chroma"><code class="language-tex" data-lang="tex"><span class="ln"> 1</span>  Camera1 API shim is using parameters:
<span class="ln"> 2</span>        CameraParameters::dump: mMap.size = 59
<span class="ln"> 3</span>        antibanding: auto
<span class="ln"> 4</span>        antibanding-values: off,50hz,60hz,auto
<span class="ln"> 5</span>        auto-exposure-lock: false
<span class="ln"> 6</span>        auto-exposure-lock-supported: true
<span class="ln"> 7</span>        auto-whitebalance-lock: false
<span class="ln"> 8</span>        auto-whitebalance-lock-supported: true
<span class="ln"> 9</span>        effect: none
<span class="ln">10</span>        effect-values: none,mono,negative,solarize,sepia,posterize,aqua,blackboard,whiteboard
<span class="ln">11</span>        exposure-compensation: 0
<span class="ln">12</span>        exposure-compensation-step: 0.166667
<span class="ln">13</span>        flash-mode: off
<span class="ln">14</span>        flash-mode-values: off,auto,on,torch
<span class="ln">15</span>        focal-length: 5.43
<span class="ln">16</span>        focus-areas: (0,0,0,0,0)
<span class="ln">17</span>        focus-distances: Infinity,Infinity,Infinity
<span class="ln">18</span>        focus-mode: auto
<span class="ln">19</span>        focus-mode-values: infinity,auto,macro,continuous-video,continuous-picture
<span class="ln">20</span>        horizontal-view-angle: 68.5295
<span class="ln">21</span>        jpeg-quality: 90
<span class="ln">22</span>        jpeg-thumbnail-height: 154
<span class="ln">23</span>        jpeg-thumbnail-quality: 90
<span class="ln">24</span>        jpeg-thumbnail-size-values: 0x0,176x144,205x154,240x144,256x144,240x160,256x154,246x184,240x240,320x240
<span class="ln">25</span>        jpeg-thumbnail-width: 205
<span class="ln">26</span>        max-exposure-compensation: 24
<span class="ln">27</span>        max-num-detected-faces-hw: 10
<span class="ln">28</span>        max-num-detected-faces-sw: 0
<span class="ln">29</span>        max-num-focus-areas: 1
<span class="ln">30</span>        max-num-metering-areas: 1
<span class="ln">31</span>        max-zoom: 99
<span class="ln">32</span>        metering-areas: (0,0,0,0,0)
<span class="ln">33</span>        min-exposure-compensation: -24
<span class="ln">34</span>        picture-format: jpeg
<span class="ln">35</span>        picture-format-values: jpeg
<span class="ln">36</span>        picture-size: 4624x3472
<span class="ln">37</span>        picture-size-values: 4624x3472,4624x2600,4624x2080,3472x3472,4096x2160,3840x2160,3264x2448,2592x1944,2592x1940,2400x1080,2160x1080,1920x1080,1600x1200,1440x1080,1280x960,1560x720,1440x720,1280x720,864x480,800x600,800x480,800x400,720x480,640x480,640x360,
<span class="ln">38</span>        preferred-preview-size-for-video: 1920x1080
<span class="ln">39</span>        preview-format: yuv420sp
<span class="ln">40</span>        preview-format-values: yuv420p,yuv420sp,
<span class="ln">41</span>        preview-fps-range: 14000,30000
<span class="ln">42</span>        preview-fps-range-values: (15000,15000),(14000,20000),(20000,20000),(14000,30000),(30000,30000)
<span class="ln">43</span>        preview-frame-rate: 30
<span class="ln">44</span>        preview-frame-rate-values: 15,20,30
<span class="ln">45</span>        preview-size: 1920x1080
<span class="ln">46</span>        preview-size-values: 1920x1080,1600x1200,1440x1080,1280x960,1560x720,1440x720,1280x720,864x480,800x600,800x480,800x400,720x480,640x480,640x360,352x288,320x240,176x144
<span class="ln">47</span>        recording-hint: false
<span class="ln">48</span>        rotation: 0
<span class="ln">49</span>        smooth-zoom-supported: false
<span class="ln">50</span>        vertical-view-angle: 54.1821
<span class="ln">51</span>        video-frame-format: android-opaque
<span class="ln">52</span>        video-size: 1920x1080
<span class="ln">53</span>        video-size-values: 4096x2160,3840x2160,2592x1944,2592x1940,2400x1080,2160x1080,1920x1080,1600x1200,1440x1080,1280x960,1560x720,1440x720,1280x720,864x480,800x600,800x480,800x400,720x480,640x480,640x360,352x288,320x240,176x144
<span class="ln">54</span>        video-snapshot-supported: false
<span class="ln">55</span>        video-stabilization: false
<span class="ln">56</span>        video-stabilization-supported: true
<span class="ln">57</span>        whitebalance: auto
<span class="ln">58</span>        whitebalance-values: auto,incandescent,fluorescent,warm-fluorescent,daylight,cloudy-daylight,twilight,shade,
<span class="ln">59</span>        zoom: 0
<span class="ln">60</span>        zoom-ratios: 100,109,118,127,136,145,154,163,172,181,190,200,209,218,227,236,245,254,263,272,281,290,299,309,318,327,336,345,354,363,372,381,390,399,409,418,427,436,445,454,463,472,481,490,499,509,518,527,536,545,554,563,572,581,590,599,609,618,627,636,
<span class="ln">61</span>        zoom-supported: true
<span class="ln">62</span>        ...
</code></pre></div><p>主要记录摄像头的一些基本信息，包括图像格式，分辨率，缩放大小，帧率，旋转角度等等。</p>
<p>其中还包含图像的histogram图，从0-255，分别对应四个通道的颜色，BGGR，这个需要按照sensor的Bayer pattern layout</p>
<div class="highlight"><pre class="chroma"><code class="language-tex" data-lang="tex"><span class="ln">  1</span>[363760 84623 85493 96276 ]
<span class="ln">  2</span>[98224 98574 103085 106812 ]
<span class="ln">  3</span>[106479 109762 108894 109744 ]
<span class="ln">  4</span>[110569 109656 107188 105870 ]
<span class="ln">  5</span>[103437 101058 98766 95246 ]
<span class="ln">  6</span>[93007 90480 87229 83466 ]
<span class="ln">  7</span>[80494 77153 73958 70434 ]
<span class="ln">  8</span>[66901 64467 60989 57368 ]
<span class="ln">  9</span>[54882 51618 49085 45944 ]
<span class="ln"> 10</span>[43575 40909 38256 36107 ]
<span class="ln"> 11</span>[34225 31701 29517 27736 ]
<span class="ln"> 12</span>[25599 24098 22416 20808 ]
<span class="ln"> 13</span>[19247 18045 16468 15184 ]
<span class="ln"> 14</span>[14115 13101 11864 10886 ]
<span class="ln"> 15</span>[10162 9292 8389 7766 ]
<span class="ln"> 16</span>[7243 6516 5858 5336 ]
<span class="ln"> 17</span>[4904 4508 4042 3583 ]
<span class="ln"> 18</span>[3239 2890 2661 2466 ]
<span class="ln"> 19</span>[2239 1977 1764 1637 ]
<span class="ln"> 20</span>[1420 1269 1135 1002 ]
<span class="ln"> 21</span>[881 825 686 591 ]
<span class="ln"> 22</span>[561 475 411 419 ]
<span class="ln"> 23</span>[339 293 244 219 ]
<span class="ln"> 24</span>[200 160 160 146 ]
<span class="ln"> 25</span>[122 109 92 72 ]
<span class="ln"> 26</span>[63 56 61 40 ]
<span class="ln"> 27</span>[35 28 28 24 ]
<span class="ln"> 28</span>[17 18 21 17 ]
<span class="ln"> 29</span>[9 8 12 2 ]
<span class="ln"> 30</span>[4 5 8 2 ]
<span class="ln"> 31</span>[5 2 3 1 ]
<span class="ln"> 32</span>[1 0 1 1 ]
<span class="ln"> 33</span>[1 0 1 3 ]
<span class="ln"> 34</span>[1 0 0 1 ]
<span class="ln"> 35</span>[0 2 0 0 ]
<span class="ln"> 36</span>[0 0 0 0 ]
<span class="ln"> 37</span>[0 0 0 0 ]
<span class="ln"> 38</span>[0 0 0 0 ]
<span class="ln"> 39</span>[0 0 0 0 ]
<span class="ln"> 40</span>[0 0 0 0 ]
<span class="ln"> 41</span>[0 0 0 0 ]
<span class="ln"> 42</span>[0 0 0 0 ]
<span class="ln"> 43</span>[0 0 0 0 ]
<span class="ln"> 44</span>[0 0 0 0 ]
<span class="ln"> 45</span>[0 0 0 0 ]
<span class="ln"> 46</span>[0 0 0 0 ]
<span class="ln"> 47</span>[0 0 0 0 ]
<span class="ln"> 48</span>[0 0 0 0 ]
<span class="ln"> 49</span>[0 0 0 0 ]
<span class="ln"> 50</span>[0 0 0 0 ]
<span class="ln"> 51</span>[0 0 0 0 ]
<span class="ln"> 52</span>[0 0 0 0 ]
<span class="ln"> 53</span>[0 0 0 0 ]
<span class="ln"> 54</span>[0 0 0 0 ]
<span class="ln"> 55</span>[0 0 0 0 ]
<span class="ln"> 56</span>[0 0 0 0 ]
<span class="ln"> 57</span>[0 0 0 0 ]
<span class="ln"> 58</span>[0 0 0 0 ]
<span class="ln"> 59</span>[0 0 0 0 ]
<span class="ln"> 60</span>[0 0 0 0 ]
<span class="ln"> 61</span>[0 0 0 0 ]
<span class="ln"> 62</span>[0 0 0 0 ]
<span class="ln"> 63</span>[0 0 0 0 ]
<span class="ln"> 64</span>[0 0 0 0 ]
<span class="ln"> 65</span>[0 0 0 0 ]
<span class="ln"> 66</span>[0 0 0 0 ]
<span class="ln"> 67</span>[0 0 0 0 ]
<span class="ln"> 68</span>[0 0 0 0 ]
<span class="ln"> 69</span>[0 0 0 0 ]
<span class="ln"> 70</span>[0 0 0 0 ]
<span class="ln"> 71</span>[0 0 0 0 ]
<span class="ln"> 72</span>[0 0 0 0 ]
<span class="ln"> 73</span>[0 0 0 0 ]
<span class="ln"> 74</span>[0 0 0 0 ]
<span class="ln"> 75</span>[0 0 0 0 ]
<span class="ln"> 76</span>[0 0 0 0 ]
<span class="ln"> 77</span>[0 0 0 0 ]
<span class="ln"> 78</span>[0 0 0 0 ]
<span class="ln"> 79</span>[0 0 0 0 ]
<span class="ln"> 80</span>[0 0 0 0 ]
<span class="ln"> 81</span>[0 0 0 0 ]
<span class="ln"> 82</span>[0 0 0 0 ]
<span class="ln"> 83</span>[0 0 0 0 ]
<span class="ln"> 84</span>[0 0 0 0 ]
<span class="ln"> 85</span>[0 0 0 0 ]
<span class="ln"> 86</span>[0 0 0 0 ]
<span class="ln"> 87</span>[0 0 0 0 ]
<span class="ln"> 88</span>[0 0 0 0 ]
<span class="ln"> 89</span>[0 0 0 0 ]
<span class="ln"> 90</span>[0 0 0 0 ]
<span class="ln"> 91</span>[0 0 0 0 ]
<span class="ln"> 92</span>[0 0 0 0 ]
<span class="ln"> 93</span>[0 0 0 0 ]
<span class="ln"> 94</span>[0 0 0 0 ]
<span class="ln"> 95</span>[0 0 0 0 ]
<span class="ln"> 96</span>[0 0 0 0 ]
<span class="ln"> 97</span>[0 0 0 0 ]
<span class="ln"> 98</span>[0 0 0 0 ]
<span class="ln"> 99</span>[0 0 0 0 ]
<span class="ln">100</span>[0 0 0 0 ]
<span class="ln">101</span>[0 0 0 0 ]
<span class="ln">102</span>[0 0 0 0 ]
<span class="ln">103</span>[0 0 0 0 ]
<span class="ln">104</span>[0 0 0 0 ]
<span class="ln">105</span>[0 0 0 0 ]
<span class="ln">106</span>[0 0 0 0 ]
<span class="ln">107</span>[0 0 0 0 ]
<span class="ln">108</span>[0 0 0 0 ]
<span class="ln">109</span>[0 0 0 0 ]
<span class="ln">110</span>[0 0 0 0 ]
<span class="ln">111</span>[0 0 0 0 ]
<span class="ln">112</span>[0 0 0 0 ]
<span class="ln">113</span>[0 0 0 0 ]
<span class="ln">114</span>[0 0 0 0 ]
<span class="ln">115</span>[0 0 0 0 ]
<span class="ln">116</span>[0 0 0 0 ]
<span class="ln">117</span>[0 0 0 0 ]
<span class="ln">118</span>[0 0 0 0 ]
<span class="ln">119</span>[0 0 0 0 ]
<span class="ln">120</span>[0 0 0 0 ]
<span class="ln">121</span>[0 0 0 0 ]
<span class="ln">122</span>[0 0 0 0 ]
<span class="ln">123</span>[0 0 0 0 ]
<span class="ln">124</span>[0 0 0 0 ]
<span class="ln">125</span>[0 0 0 0 ]
<span class="ln">126</span>[0 0 0 0 ]
<span class="ln">127</span>[0 0 0 0 ]
<span class="ln">128</span>[0 0 0 0 ]
<span class="ln">129</span>[0 0 0 0 ]
<span class="ln">130</span>[0 0 0 0 ]
<span class="ln">131</span>[0 0 0 0 ]
<span class="ln">132</span>[0 0 0 0 ]
<span class="ln">133</span>[0 0 0 0 ]
<span class="ln">134</span>[0 0 0 0 ]
<span class="ln">135</span>[0 0 0 0 ]
<span class="ln">136</span>[0 0 0 0 ]
<span class="ln">137</span>[0 0 0 0 ]
<span class="ln">138</span>[0 0 0 0 ]
<span class="ln">139</span>[0 0 0 0 ]
<span class="ln">140</span>[0 0 0 0 ]
<span class="ln">141</span>[0 0 0 0 ]
<span class="ln">142</span>[0 0 0 0 ]
<span class="ln">143</span>[0 0 0 0 ]
<span class="ln">144</span>[0 0 0 0 ]
<span class="ln">145</span>[0 0 0 0 ]
<span class="ln">146</span>[0 0 0 0 ]
<span class="ln">147</span>[0 0 0 0 ]
<span class="ln">148</span>[0 0 0 0 ]
<span class="ln">149</span>[0 0 0 0 ]
<span class="ln">150</span>[0 0 0 0 ]
<span class="ln">151</span>[0 0 0 0 ]
<span class="ln">152</span>[0 0 0 0 ]
<span class="ln">153</span>[0 0 0 0 ]
<span class="ln">154</span>[0 0 0 0 ]
<span class="ln">155</span>[0 0 0 0 ]
<span class="ln">156</span>[0 0 0 0 ]
<span class="ln">157</span>[0 0 0 0 ]
<span class="ln">158</span>[0 0 0 0 ]
<span class="ln">159</span>[0 0 0 0 ]
<span class="ln">160</span>[0 0 0 0 ]
<span class="ln">161</span>[0 0 0 0 ]
<span class="ln">162</span>[0 0 0 0 ]
<span class="ln">163</span>[0 0 0 0 ]
<span class="ln">164</span>[0 0 0 0 ]
<span class="ln">165</span>[0 0 0 0 ]
<span class="ln">166</span>[0 0 0 0 ]
<span class="ln">167</span>[0 0 0 0 ]
<span class="ln">168</span>[0 0 0 0 ]
<span class="ln">169</span>[0 0 0 0 ]
<span class="ln">170</span>[0 0 0 0 ]
<span class="ln">171</span>[0 0 0 0 ]
<span class="ln">172</span>[0 0 0 0 ]
<span class="ln">173</span>[0 0 0 0 ]
<span class="ln">174</span>[0 0 0 0 ]
<span class="ln">175</span>[0 0 0 0 ]
<span class="ln">176</span>[0 0 0 0 ]
<span class="ln">177</span>[0 0 0 0 ]
<span class="ln">178</span>[0 0 0 0 ]
<span class="ln">179</span>[0 0 0 0 ]
<span class="ln">180</span>[0 0 0 0 ]
<span class="ln">181</span>[0 0 0 0 ]
<span class="ln">182</span>[0 0 0 0 ]
<span class="ln">183</span>[0 0 0 0 ]
<span class="ln">184</span>[0 0 0 0 ]
<span class="ln">185</span>[0 0 0 0 ]
<span class="ln">186</span>[0 0 0 0 ]
<span class="ln">187</span>[0 0 0 0 ]
<span class="ln">188</span>[0 0 0 0 ]
<span class="ln">189</span>[0 0 0 0 ]
<span class="ln">190</span>[0 0 0 0 ]
<span class="ln">191</span>[0 0 0 0 ]
<span class="ln">192</span>[0 0 0 0 ]
<span class="ln">193</span>[0 0 0 0 ]
<span class="ln">194</span>[0 0 0 0 ]
<span class="ln">195</span>[0 0 0 0 ]
<span class="ln">196</span>[0 0 0 0 ]
<span class="ln">197</span>[0 0 0 0 ]
<span class="ln">198</span>[0 0 0 0 ]
<span class="ln">199</span>[0 0 0 0 ]
<span class="ln">200</span>[0 0 0 0 ]
<span class="ln">201</span>[0 0 0 0 ]
<span class="ln">202</span>[0 0 0 0 ]
<span class="ln">203</span>[0 0 0 0 ]
<span class="ln">204</span>[0 0 0 0 ]
<span class="ln">205</span>[0 0 0 0 ]
<span class="ln">206</span>[0 0 0 0 ]
<span class="ln">207</span>[0 0 0 0 ]
<span class="ln">208</span>[0 0 0 0 ]
<span class="ln">209</span>[0 0 0 0 ]
<span class="ln">210</span>[0 0 0 0 ]
<span class="ln">211</span>[0 0 0 0 ]
<span class="ln">212</span>[0 0 0 0 ]
<span class="ln">213</span>[0 0 0 0 ]
<span class="ln">214</span>[0 0 0 0 ]
<span class="ln">215</span>[0 0 0 0 ]
<span class="ln">216</span>[0 0 0 0 ]
<span class="ln">217</span>[0 0 0 0 ]
<span class="ln">218</span>[0 0 0 0 ]
<span class="ln">219</span>[0 0 0 0 ]
<span class="ln">220</span>[0 0 0 0 ]
<span class="ln">221</span>[0 0 0 0 ]
<span class="ln">222</span>[0 0 0 0 ]
<span class="ln">223</span>[0 0 0 0 ]
<span class="ln">224</span>[0 0 0 0 ]
<span class="ln">225</span>[0 0 0 0 ]
<span class="ln">226</span>[0 0 0 0 ]
<span class="ln">227</span>[0 0 0 0 ]
<span class="ln">228</span>[0 0 0 0 ]
<span class="ln">229</span>[0 0 0 0 ]
<span class="ln">230</span>[0 0 0 0 ]
<span class="ln">231</span>[0 0 0 0 ]
<span class="ln">232</span>[0 0 0 0 ]
<span class="ln">233</span>[0 0 0 0 ]
<span class="ln">234</span>[0 0 0 0 ]
<span class="ln">235</span>[0 0 0 0 ]
<span class="ln">236</span>[0 0 0 0 ]
<span class="ln">237</span>[0 0 0 0 ]
<span class="ln">238</span>[0 0 0 0 ]
<span class="ln">239</span>[0 0 0 0 ]
<span class="ln">240</span>[0 0 0 0 ]
<span class="ln">241</span>[0 0 0 0 ]
<span class="ln">242</span>[0 0 0 0 ]
<span class="ln">243</span>[0 0 0 0 ]
<span class="ln">244</span>[0 0 0 0 ]
<span class="ln">245</span>[0 0 0 0 ]
<span class="ln">246</span>[0 0 0 0 ]
<span class="ln">247</span>[0 0 0 0 ]
<span class="ln">248</span>[0 0 0 0 ]
<span class="ln">249</span>[0 0 0 0 ]
<span class="ln">250</span>[0 0 0 0 ]
<span class="ln">251</span>[0 0 0 0 ]
<span class="ln">252</span>[0 0 0 0 ]
<span class="ln">253</span>[0 0 0 0 ]
<span class="ln">254</span>[0 0 0 0 ]
<span class="ln">255</span>[0 0 0 0 ]
<span class="ln">256</span>[0 0 0 0 ]
</code></pre></div><p>会有两个通道的输出</p>
<div class="highlight"><pre class="chroma"><code class="language-tex" data-lang="tex"><span class="ln"> 1</span>Stream[0]: Output
<span class="ln"> 2</span>      Consumer name: SurfaceTexture-1-14259-1
<span class="ln"> 3</span>      State: 4
<span class="ln"> 4</span>      Dims: 1440 x 1080, format 0x22, dataspace 0x0
<span class="ln"> 5</span>      Max size: 0
<span class="ln"> 6</span>      Combined usage: 133376, max HAL buffers: 8
<span class="ln"> 7</span>      Frames produced: 43, last timestamp: 1430362607248159 ns
<span class="ln"> 8</span>      Total buffers: 10, currently dequeued: 6
<span class="ln"> 9</span>      DequeueBuffer latency histogram: (49) samples
<span class="ln">10</span>        5     10     15     20     25     30     35     40     45    inf (max ms)
<span class="ln">11</span>     95.92   4.08   0.00   0.00   0.00   0.00   0.00   0.00   0.00   0.00 (<span class="c">%)
</span><span class="ln">12</span><span class="c"></span>Stream[1]: Output
<span class="ln">13</span>      Consumer name: ImageReader-4624x3472f23m10-14259-1
<span class="ln">14</span>      State: 4
<span class="ln">15</span>      Dims: 4624 x 3472, format 0x23, dataspace 0x8c20000
<span class="ln">16</span>      Max size: 0
<span class="ln">17</span>      Combined usage: 131075, max HAL buffers: 8
<span class="ln">18</span>      Frames produced: 0, last timestamp: 0 ns
<span class="ln">19</span>      Total buffers: 18, currently dequeued: 0
</code></pre></div><h3 id="314cameraprovidermanager">3.1.4CameraProviderManager</h3>
<div class="highlight"><pre class="chroma"><code class="language-tex" data-lang="tex"><span class="ln"> 1</span>== Camera Provider HAL legacy/0 (v2.5, remote) static info: 10 devices: ==
<span class="ln"> 2</span>== Camera HAL device device@3.5/legacy/0 (v3.5) static information: ==
<span class="ln"> 3</span>  Resource cost: 99
<span class="ln"> 4</span>  Conflicting devices:
<span class="ln"> 5</span>    6
<span class="ln"> 6</span>  API1 info:
<span class="ln"> 7</span>    Has a flash unit: true
<span class="ln"> 8</span>    Facing: Back
<span class="ln"> 9</span>    Orientation: 90
<span class="ln">10</span>  API2 camera characteristics:
<span class="ln">11</span>    Dumping camera metadata array: 141 / 141 entries, 18344 / 18344 bytes of extra data.
<span class="ln">12</span>
<span class="ln">13</span>      Version: 1, Flags: 00000000
<span class="ln">14</span>      android.colorCorrection.availableAberrationModes (00004): byte[3]
<span class="ln">15</span>        [0 1 2 ]
<span class="ln">16</span>      android.control.aeAvailableAntibandingModes (10012): byte[4]
<span class="ln">17</span>        [0 1 2 3 ]
<span class="ln">18</span>      android.control.aeAvailableModes (10013): byte[4]
<span class="ln">19</span>        [0 1 2 3 ]
<span class="ln">20</span>      android.control.aeAvailableTargetFpsRanges (10014): int32[10]
<span class="ln">21</span>        [15 15 14 20 ]
<span class="ln">22</span>        [20 20 14 30 ]
<span class="ln">23</span>        [30 30 ]
<span class="ln">24</span>      android.control.aeCompensationRange (10015): int32[2]
<span class="ln">25</span>        [-24 24 ]
<span class="ln">26</span>      android.control.aeCompensationStep (10016): rational[1]
<span class="ln">27</span>        [(1 / 6) ]
<span class="ln">28</span>      android.control.afAvailableModes (10017): byte[5]
<span class="ln">29</span>        [0 1 2 3 4 ]
<span class="ln">30</span>      android.control.availableEffects (10018): byte[9]
<span class="ln">31</span>        [0 1 2 3 4 5 8 7 6 ]
<span class="ln">32</span>      android.control.availableSceneModes (10019): byte[16]
<span class="ln">33</span>        [0 1 2 3 4 5 6 7 8 9 10 12 13 14 15 18 ]
<span class="ln">34</span>        ...
</code></pre></div><p>这里的CameraProvider和Camera Hal是在一起出现的，这里用的是Provider2.5版本，Hal3.5版本，从/legacy/0到/legacy/9。主要是用于isp参数的配置还有通过预设一些参数和操作，某些平台可以拍raw图，qcom平台不太熟悉，可能也会有这种操作。</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>//查看相机支持的preview size和picture size
<span class="ln">2</span>HAL_PIXEL_FORMAT_RAW16 = 32;
<span class="ln">3</span>HAL_PIXEL_FORMAT_BLOB = 33;
<span class="ln">4</span>HAL_PIXEL_FORMAT_IMPLEMENTATION_DEFINED = 34;
<span class="ln">5</span>HAL_PIXEL_FORMAT_YCbCr_420_888 = 35;
<span class="ln">6</span>HAL_PIXEL_FORMAT_RAW_OPAQUE = 36;
<span class="ln">7</span>HAL_PIXEL_FORMAT_RAW10 = 37;
<span class="ln">8</span>HAL_PIXEL_FORMAT_RAW12 = 38;
</code></pre></div><p>这里可以看出,preview和capture最大尺寸都是4624*3472，从拍照的图片信息也同样确认是正确的。</p>
<div class="highlight"><pre class="chroma"><code class="language-tex" data-lang="tex"><span class="ln">1</span>[34 4624 3472 OUTPUT ]//最大预览尺寸
<span class="ln">2</span>[34 4624 3472 INPUT ]
<span class="ln">3</span>[35 4624 3472 OUTPUT ]
<span class="ln">4</span>[35 4624 3472 INPUT ]
<span class="ln">5</span>[33 4624 3472 OUTPUT ]//最大图片尺寸
</code></pre></div>

 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/dumpsys/dumpsys_16.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/dumpsys/dumpsys_16.png" >
  
    </a>
  
  
</div>

<p>RAW的尺寸设置可以更大，9248*6944的大小</p>
<div class="highlight"><pre class="chroma"><code class="language-tex" data-lang="tex"><span class="ln">1</span>android.scaler.availableRawSizes (d0008): int32[14]
<span class="ln">2</span>[9248 6944 4624 3472 ]
<span class="ln">3</span>[1152 1720 4624 2600 ]
<span class="ln">4</span>[1152 1296 2312 1300 ]
<span class="ln">5</span>[2312 1300 ]
</code></pre></div><p>实际帧率范围</p>
<div class="highlight"><pre class="chroma"><code class="language-tex" data-lang="tex"><span class="ln">1</span>android.control.aeTargetFpsRange (10005): int32[2]
<span class="ln">2</span>[14 30 ]
</code></pre></div><h3 id="315globalvendortagdescriptor">3.1.5GlobalVendorTagDescriptor</h3>
<div class="highlight"><pre class="chroma"><code class="language-tex" data-lang="tex"><span class="ln"> 1</span>== Vendor tags: ==
<span class="ln"> 2</span>  Dumping vendor tag descriptors for vendor with id 3854507339
<span class="ln"> 3</span>  Dumping configured vendor tag descriptors: 617 entries
<span class="ln"> 4</span>    0x80000000 (private<span class="nb">_</span>property) with type 0 (byte) defined in section org.codeaurora.qcamera3.internal<span class="nb">_</span>private
<span class="ln"> 5</span>    0x80010000 (exposure<span class="nb">_</span>metering<span class="nb">_</span>mode) with type 1 (int32) defined in section org.codeaurora.qcamera3.exposure<span class="nb">_</span>metering
<span class="ln"> 6</span>    0x80010001 (available<span class="nb">_</span>modes) with type 1 (int32) defined in section org.codeaurora.qcamera3.exposure<span class="nb">_</span>metering
<span class="ln"> 7</span>    0x80020000 (aec<span class="nb">_</span>speed) with type 2 (float) defined in section org.codeaurora.qcamera3.aec<span class="nb">_</span>convergence<span class="nb">_</span>speed
<span class="ln"> 8</span>    0x80030000 (strength) with type 1 (int32) defined in section org.codeaurora.qcamera3.sharpness
<span class="ln"> 9</span>    0x80030001 (range) with type 1 (int32) defined in section org.codeaurora.qcamera3.sharpness
<span class="ln">10</span>    0x80040000 (level) with type 1 (int32) defined in section org.codeaurora.qcamera3.contrast
</code></pre></div><p>这里就是entry的描述，大概有617条，用于描述一些vendor的细节，这里不展开</p>
<h3 id="316cameratraces">3.1.6CameraTraces</h3>
<div class="highlight"><pre class="chroma"><code class="language-tex" data-lang="tex"><span class="ln">1</span>== Camera error traces (0): ==
<span class="ln">2</span>  No camera traces collected.
</code></pre></div><p>通常来说，这里没有systrace，也没有出现异常，所以不会出现trace，是正常现象。</p>
<h2 id="32从dumpsys到cameraservice">3.2从dumpsys到CameraService</h2>
<p>这里主要分成几步，从CameraSever启动，启动CameraService服务并添加到servicemanager，启动CameraServiceProxy服务和CameraService服务的AIDL使用。其实说白了，也是一种Binder通信的实例，关于CameraService的AIDL通信，可以点击<a href="https://yangyang48.github.io/2022/03/aidl3-java%E5%92%8Cc-%E9%80%9A%E4%BF%A1/">这里</a>。</p>
<p>总的顺序图如下所示，其中进程后面的括号是实际开发板中的进程号，进程号越小越早启动。</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/dumpsys/dumpsys_17.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/dumpsys/dumpsys_17.png" >
  
    </a>
  
  
</div>

<h3 id="321camerasever启动">3.2.1CameraSever启动</h3>
<p>关于CameraService启动流程，这里展开描述一下。</p>
<p>首先分成几个过程，涉及到android系统的开机流程，这里只描述CameraService部分。</p>
<h4 id="3211init进程会初始化属性服务并且解析rc文件">3.2.1.1init进程会初始化属性服务，并且解析.rc文件</h4>
<p>开机之后，Linux内核启动1号进程，对应的源文件是system/core/init/main.cpp。而这个文件源文件，会调用到system/core/init/init.cpp。这个init.cpp非常关键，会去解析<strong>init.rc</strong>配置文件和其他文件。我们这边只看解析部分。</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//system/core/init/init.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="k">static</span> <span class="kt">void</span> <span class="nf">LoadBootScripts</span><span class="p">(</span><span class="n">ActionManager</span><span class="o">&amp;</span> <span class="n">action_manager</span><span class="p">,</span> <span class="n">ServiceList</span><span class="o">&amp;</span> <span class="n">service_list</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 3</span>    <span class="n">Parser</span> <span class="n">parser</span> <span class="o">=</span> <span class="n">CreateParser</span><span class="p">(</span><span class="n">action_manager</span><span class="p">,</span> <span class="n">service_list</span><span class="p">);</span>
<span class="ln"> 4</span>
<span class="ln"> 5</span>    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">bootscript</span> <span class="o">=</span> <span class="n">GetProperty</span><span class="p">(</span><span class="s">&#34;ro.boot.init_rc&#34;</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">);</span>
<span class="ln"> 6</span>    <span class="k">if</span> <span class="p">(</span><span class="n">bootscript</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
<span class="ln"> 7</span>        <span class="n">parser</span><span class="p">.</span><span class="n">ParseConfig</span><span class="p">(</span><span class="s">&#34;/system/etc/init/hw/init.rc&#34;</span><span class="p">);</span>
<span class="ln"> 8</span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">parser</span><span class="p">.</span><span class="n">ParseConfig</span><span class="p">(</span><span class="s">&#34;/system/etc/init&#34;</span><span class="p">))</span> <span class="p">{</span>
<span class="ln"> 9</span>            <span class="n">late_import_paths</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="s">&#34;/system/etc/init&#34;</span><span class="p">);</span>
<span class="ln">10</span>        <span class="p">}</span>
<span class="ln">11</span>        <span class="n">parser</span><span class="p">.</span><span class="n">ParseConfig</span><span class="p">(</span><span class="s">&#34;/system_ext/etc/init&#34;</span><span class="p">);</span>
<span class="ln">12</span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">parser</span><span class="p">.</span><span class="n">ParseConfig</span><span class="p">(</span><span class="s">&#34;/product/etc/init&#34;</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">13</span>            <span class="n">late_import_paths</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="s">&#34;/product/etc/init&#34;</span><span class="p">);</span>
<span class="ln">14</span>        <span class="p">}</span>
<span class="ln">15</span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">parser</span><span class="p">.</span><span class="n">ParseConfig</span><span class="p">(</span><span class="s">&#34;/odm/etc/init&#34;</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">16</span>            <span class="n">late_import_paths</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="s">&#34;/odm/etc/init&#34;</span><span class="p">);</span>
<span class="ln">17</span>        <span class="p">}</span>
<span class="ln">18</span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">parser</span><span class="p">.</span><span class="n">ParseConfig</span><span class="p">(</span><span class="s">&#34;/vendor/etc/init&#34;</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">19</span>            <span class="n">late_import_paths</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="s">&#34;/vendor/etc/init&#34;</span><span class="p">);</span>
<span class="ln">20</span>        <span class="p">}</span>
<span class="ln">21</span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="ln">22</span>        <span class="n">parser</span><span class="p">.</span><span class="n">ParseConfig</span><span class="p">(</span><span class="n">bootscript</span><span class="p">);</span>
<span class="ln">23</span>    <span class="p">}</span>
<span class="ln">24</span><span class="p">}</span>
</code></pre></div><p>可以看到这里有4个目录&quot;/system/etc/init&quot;,&quot;/product/etc/init&quot;,&quot;/odm/etc/init&quot;,&quot;/vendor/etc/init&quot;。等init.rc解析完成后，会来解析4个目录中的rc文件，用来执行相关的动作。</p>
<h4 id="3212解析cameraserverrc文件并启动cameraserver">3.2.1.2解析cameraserver.rc文件，并启动cameraserver</h4>
<p>下面的Android.bp可以看到init_rc: [&ldquo;cameraserver.rc&rdquo;]，说明rc文件编译到/system/etc/init中。而上面的开机流程的init.cpp中会去解析这个目录，那么这个cameraserver.rc这个目录就会被解析出来。那么实际上，解析完成之后，就会启动&quot;cameraserver.rc&quot;。</p>
<div class="highlight"><pre class="chroma"><code class="language-makefile" data-lang="makefile"><span class="ln"> 1</span><span class="c">#frameworks/av/camera/cameraserver/Android.bp
</span><span class="ln"> 2</span><span class="c"></span><span class="err">cc_binary</span> <span class="err">{</span>
<span class="ln"> 3</span>    <span class="nf">name</span><span class="o">:</span> &#34;<span class="n">cameraserver</span>&#34;<span class="p">,</span>
<span class="ln"> 4</span>
<span class="ln"> 5</span>    srcs: <span class="o">[</span><span class="s2">&#34;main_cameraserver.cpp&#34;</span><span class="o">]</span>,
<span class="ln"> 6</span>
<span class="ln"> 7</span>    header_libs: <span class="o">[</span>
<span class="ln"> 8</span>        <span class="s2">&#34;libmedia_headers&#34;</span>,
<span class="ln"> 9</span>    <span class="o">]</span>,
<span class="ln">10</span>
<span class="ln">11</span>    shared_libs: <span class="o">[</span>
<span class="ln">12</span>        <span class="s2">&#34;libcameraservice&#34;</span>,
<span class="ln">13</span>        <span class="s2">&#34;liblog&#34;</span>,
<span class="ln">14</span>        <span class="s2">&#34;libutils&#34;</span>,
<span class="ln">15</span>        <span class="s2">&#34;libui&#34;</span>,
<span class="ln">16</span>        <span class="s2">&#34;libgui&#34;</span>,
<span class="ln">17</span>        <span class="s2">&#34;libbinder&#34;</span>,
<span class="ln">18</span>        <span class="s2">&#34;libhidlbase&#34;</span>,
<span class="ln">19</span>        <span class="s2">&#34;android.hardware.camera.common@1.0&#34;</span>,
<span class="ln">20</span>        <span class="s2">&#34;android.hardware.camera.provider@2.4&#34;</span>,
<span class="ln">21</span>        <span class="s2">&#34;android.hardware.camera.provider@2.5&#34;</span>,
<span class="ln">22</span>        <span class="s2">&#34;android.hardware.camera.provider@2.6&#34;</span>,
<span class="ln">23</span>        <span class="s2">&#34;android.hardware.camera.device@1.0&#34;</span>,
<span class="ln">24</span>        <span class="s2">&#34;android.hardware.camera.device@3.2&#34;</span>,
<span class="ln">25</span>        <span class="s2">&#34;android.hardware.camera.device@3.4&#34;</span>,
<span class="ln">26</span>    <span class="o">]</span>,
<span class="ln">27</span>    compile_multilib: <span class="s2">&#34;32&#34;</span>,
<span class="ln">28</span>    cflags: <span class="o">[</span>
<span class="ln">29</span>        <span class="s2">&#34;-Wall&#34;</span>,
<span class="ln">30</span>        <span class="s2">&#34;-Wextra&#34;</span>,
<span class="ln">31</span>        <span class="s2">&#34;-Werror&#34;</span>,
<span class="ln">32</span>        <span class="s2">&#34;-Wno-unused-parameter&#34;</span>,
<span class="ln">33</span>    <span class="o">]</span>,
<span class="ln">34</span>    <span class="c1">#rc文件编译到/system/etc/init中</span>
<span class="ln">35</span>    init_rc: <span class="o">[</span><span class="s2">&#34;cameraserver.rc&#34;</span><span class="o">]</span>,
<span class="ln">36</span>
<span class="ln">37</span>    vintf_fragments: <span class="o">[</span>
<span class="ln">38</span>        <span class="s2">&#34;manifest_android.frameworks.cameraservice.service@2.1.xml&#34;</span>,
<span class="ln">39</span>    <span class="o">]</span>,
<span class="ln">40</span><span class="err">}</span>
</code></pre></div><p>可以看到这个rc文件解析之后，被开启cameraserver，这个cameraserver实际上是一个进程，位于/system/bin/cameraserver。这里的cameraserver的rc文件，<strong>里面没有设置oneshot，说明会自重启</strong>，没有设置disable，说明不需要其他应用显示启动它，具体rc语法点击<a href="https://blog.csdn.net/feigebangni/article/details/50300063">这里</a>。</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>#frameworks/av/camera/cameraserver/cameraserver.rc 
<span class="ln">2</span>service cameraserver /system/bin/cameraserver
<span class="ln">3</span>    class main
<span class="ln">4</span>     user cameraserver
<span class="ln">5</span>     group audio camera input drmrpc
<span class="ln">6</span>     ioprio rt 4
<span class="ln">7</span>     task_profiles CameraServiceCapacity MaxPerformance
<span class="ln">8</span>     rlimit rtprio 10 10
</code></pre></div><h4 id="3213cameraserviceinstantiate">3.2.1.3CameraService::instantiate</h4>
<p>最终会进入到进程的的main函数中，这个main_cameraserver.cpp中有CameraService::instantiate()，这个是后续添加服务到ServiceManager中。</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//frameworks/av/camera/cameraserver/main_cameraserver.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span> <span class="n">__unused</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span> <span class="n">__unused</span><span class="p">)</span>
<span class="ln"> 3</span><span class="p">{</span>
<span class="ln"> 4</span>    <span class="n">signal</span><span class="p">(</span><span class="n">SIGPIPE</span><span class="p">,</span> <span class="n">SIG_IGN</span><span class="p">);</span>
<span class="ln"> 5</span>
<span class="ln"> 6</span>    <span class="n">hardware</span><span class="o">::</span><span class="n">configureRpcThreadpool</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="cm">/*willjoin*/</span> <span class="nb">false</span><span class="p">);</span>
<span class="ln"> 7</span>
<span class="ln"> 8</span>    <span class="n">sp</span><span class="o">&lt;</span><span class="n">ProcessState</span><span class="o">&gt;</span> <span class="n">proc</span><span class="p">(</span><span class="n">ProcessState</span><span class="o">::</span><span class="n">self</span><span class="p">());</span>
<span class="ln"> 9</span>    <span class="n">sp</span><span class="o">&lt;</span><span class="n">IServiceManager</span><span class="o">&gt;</span> <span class="n">sm</span> <span class="o">=</span> <span class="n">defaultServiceManager</span><span class="p">();</span>
<span class="ln">10</span>    <span class="n">ALOGI</span><span class="p">(</span><span class="s">&#34;ServiceManager: %p&#34;</span><span class="p">,</span> <span class="n">sm</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
<span class="ln">11</span>    <span class="n">CameraService</span><span class="o">::</span><span class="n">instantiate</span><span class="p">();</span>
<span class="ln">12</span>    <span class="n">ALOGI</span><span class="p">(</span><span class="s">&#34;ServiceManager: %p done instantiate&#34;</span><span class="p">,</span> <span class="n">sm</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
<span class="ln">13</span>    <span class="n">ProcessState</span><span class="o">::</span><span class="n">self</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">startThreadPool</span><span class="p">();</span>
<span class="ln">14</span>    <span class="n">IPCThreadState</span><span class="o">::</span><span class="n">self</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">joinThreadPool</span><span class="p">();</span>
<span class="ln">15</span><span class="p">}</span>
</code></pre></div><p>来看CameraService类的定义(截取部分)：</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//frameworks/av/services/camera/libcameraservice/CameraService.h
</span><span class="ln"> 2</span><span class="c1"></span><span class="k">class</span> <span class="nc">CameraService</span> <span class="o">:</span>
<span class="ln"> 3</span>    <span class="k">public</span> <span class="n">BinderService</span><span class="o">&lt;</span><span class="n">CameraService</span><span class="o">&gt;</span><span class="p">,</span>
<span class="ln"> 4</span>    <span class="k">public</span> <span class="k">virtual</span> <span class="o">::</span><span class="n">android</span><span class="o">::</span><span class="n">hardware</span><span class="o">::</span><span class="n">BnCameraService</span><span class="p">,</span>
<span class="ln"> 5</span>    <span class="k">public</span> <span class="k">virtual</span> <span class="n">IBinder</span><span class="o">::</span><span class="n">DeathRecipient</span><span class="p">,</span>
<span class="ln"> 6</span>    <span class="k">public</span> <span class="k">virtual</span> <span class="n">CameraProviderManager</span><span class="o">::</span><span class="n">StatusListener</span>
<span class="ln"> 7</span><span class="p">{</span>
<span class="ln"> 8</span>    <span class="k">friend</span> <span class="k">class</span> <span class="nc">BinderService</span><span class="o">&lt;</span><span class="n">CameraService</span><span class="o">&gt;</span><span class="p">;</span>
<span class="ln"> 9</span>    <span class="k">friend</span> <span class="k">class</span> <span class="nc">CameraClient</span><span class="p">;</span>
<span class="ln">10</span>    <span class="k">friend</span> <span class="k">class</span> <span class="nc">CameraOfflineSessionClient</span><span class="p">;</span>
<span class="ln">11</span><span class="k">public</span><span class="o">:</span>
<span class="ln">12</span>    <span class="k">class</span> <span class="nc">Client</span><span class="p">;</span>
<span class="ln">13</span>    <span class="k">class</span> <span class="nc">BasicClient</span><span class="p">;</span>
<span class="ln">14</span>    <span class="k">class</span> <span class="nc">OfflineClient</span><span class="p">;</span>
<span class="ln">15</span>    
<span class="ln">16</span>    <span class="c1">// Implementation of BinderService&lt;T&gt;
</span><span class="ln">17</span><span class="c1"></span>    <span class="k">static</span> <span class="kt">char</span> <span class="k">const</span><span class="o">*</span> <span class="nf">getServiceName</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="s">&#34;media.camera&#34;</span><span class="p">;</span> <span class="p">}</span>
<span class="ln">18</span>
<span class="ln">19</span>                        <span class="n">CameraService</span><span class="p">();</span>
<span class="ln">20</span>    <span class="k">virtual</span>             <span class="o">~</span><span class="n">CameraService</span><span class="p">();</span>
<span class="ln">21</span>
<span class="ln">22</span>    <span class="k">virtual</span> <span class="n">status_t</span>    <span class="nf">dump</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">const</span> <span class="n">Vector</span><span class="o">&lt;</span><span class="n">String16</span><span class="o">&gt;&amp;</span> <span class="n">args</span><span class="p">);</span>
<span class="ln">23</span>    <span class="p">...</span>
<span class="ln">24</span><span class="p">}</span>
</code></pre></div><p>可以看到主要是getService和dump这两个类成员函数会用到，其他的函数暂时先不管。</p>
<h3 id="322启动cameraservice服务并添加到servicemanager">3.2.2启动CameraService服务并添加到servicemanager</h3>
<p>dumpsys那些信息的打印就是上述的dump函数负责实现的。</p>
<p>instantiate()来自 CameraService的父类BinderService，BinderService是一个模版类。最终这个会真正启动CameraService，对应的对应的binder是&quot;media.camera&quot;。</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//frameworks/native/libs/binder/include/binder/BinderService.h
</span><span class="ln"> 2</span><span class="c1"></span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">SERVICE</span><span class="o">&gt;</span>
<span class="ln"> 3</span><span class="k">class</span> <span class="nc">BinderService</span>
<span class="ln"> 4</span><span class="p">{</span>
<span class="ln"> 5</span><span class="k">public</span><span class="o">:</span>
<span class="ln"> 6</span>    <span class="k">static</span> <span class="n">status_t</span> <span class="n">publish</span><span class="p">(</span><span class="kt">bool</span> <span class="n">allowIsolated</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>
<span class="ln"> 7</span>                            <span class="kt">int</span> <span class="n">dumpFlags</span> <span class="o">=</span> <span class="n">IServiceManager</span><span class="o">::</span><span class="n">DUMP_FLAG_PRIORITY_DEFAULT</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 8</span>        <span class="n">sp</span><span class="o">&lt;</span><span class="n">IServiceManager</span><span class="o">&gt;</span> <span class="n">sm</span><span class="p">(</span><span class="n">defaultServiceManager</span><span class="p">());</span>
<span class="ln"> 9</span>        <span class="k">return</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">addService</span><span class="p">(</span><span class="n">String16</span><span class="p">(</span><span class="n">SERVICE</span><span class="o">::</span><span class="n">getServiceName</span><span class="p">()),</span> <span class="k">new</span> <span class="n">SERVICE</span><span class="p">(),</span> <span class="n">allowIsolated</span><span class="p">,</span>
<span class="ln">10</span>                              <span class="n">dumpFlags</span><span class="p">);</span>
<span class="ln">11</span>    <span class="p">}</span>
<span class="ln">12</span>
<span class="ln">13</span>    <span class="k">static</span> <span class="kt">void</span> <span class="nf">publishAndJoinThreadPool</span><span class="p">(</span>
<span class="ln">14</span>            <span class="kt">bool</span> <span class="n">allowIsolated</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>
<span class="ln">15</span>            <span class="kt">int</span> <span class="n">dumpFlags</span> <span class="o">=</span> <span class="n">IServiceManager</span><span class="o">::</span><span class="n">DUMP_FLAG_PRIORITY_DEFAULT</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">16</span>        <span class="n">publish</span><span class="p">(</span><span class="n">allowIsolated</span><span class="p">,</span> <span class="n">dumpFlags</span><span class="p">);</span>
<span class="ln">17</span>        <span class="n">joinThreadPool</span><span class="p">();</span>
<span class="ln">18</span>    <span class="p">}</span>
<span class="ln">19</span>
<span class="ln">20</span>    <span class="k">static</span> <span class="kt">void</span> <span class="nf">instantiate</span><span class="p">()</span> <span class="p">{</span> <span class="n">publish</span><span class="p">();</span> <span class="p">}</span>
<span class="ln">21</span>
<span class="ln">22</span>    <span class="k">static</span> <span class="n">status_t</span> <span class="nf">shutdown</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">NO_ERROR</span><span class="p">;</span> <span class="p">}</span>
<span class="ln">23</span>
<span class="ln">24</span><span class="k">private</span><span class="o">:</span>
<span class="ln">25</span>    <span class="k">static</span> <span class="kt">void</span> <span class="n">joinThreadPool</span><span class="p">()</span> <span class="p">{</span>
<span class="ln">26</span>        <span class="n">sp</span><span class="o">&lt;</span><span class="n">ProcessState</span><span class="o">&gt;</span> <span class="n">ps</span><span class="p">(</span><span class="n">ProcessState</span><span class="o">::</span><span class="n">self</span><span class="p">());</span>
<span class="ln">27</span>        <span class="n">ps</span><span class="o">-&gt;</span><span class="n">startThreadPool</span><span class="p">();</span>
<span class="ln">28</span>        <span class="n">ps</span><span class="o">-&gt;</span><span class="n">giveThreadPoolName</span><span class="p">();</span>
<span class="ln">29</span>        <span class="n">IPCThreadState</span><span class="o">::</span><span class="n">self</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">joinThreadPool</span><span class="p">();</span>
<span class="ln">30</span>    <span class="p">}</span>
<span class="ln">31</span><span class="p">};</span>
</code></pre></div><p>用 CameraService替换模版之后：</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="k">class</span> <span class="nc">BinderService</span>
<span class="ln"> 2</span><span class="p">{</span>
<span class="ln"> 3</span><span class="k">public</span><span class="o">:</span>
<span class="ln"> 4</span>    <span class="k">static</span> <span class="n">status_t</span> <span class="n">publish</span><span class="p">(</span><span class="kt">bool</span> <span class="n">allowIsolated</span> <span class="o">=</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 5</span>        <span class="n">sp</span><span class="o">&lt;</span><span class="n">IServiceManager</span><span class="o">&gt;</span> <span class="n">sm</span><span class="p">(</span><span class="n">defaultServiceManager</span><span class="p">());</span>
<span class="ln"> 6</span>        <span class="c1">//这里面涉及到两个过程：
</span><span class="ln"> 7</span><span class="c1"></span>        <span class="c1">//1.new CameraService会去真正启动CameraService
</span><span class="ln"> 8</span><span class="c1"></span>        <span class="c1">//2.sm-&gt;addService将实例化的CameraService添加到servicemanager中，标记binder为&#34;media.camera&#34;,其他进程可以在sm中唱过这个&#34;media.camera&#34;来获取这个服务，从而可以实现跨进程的Binder通信
</span><span class="ln"> 9</span><span class="c1"></span>        <span class="k">return</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">addService</span><span class="p">(</span>
<span class="ln">10</span>                <span class="n">String16</span><span class="p">(</span><span class="n">CameraService</span><span class="o">::</span><span class="n">getServiceName</span><span class="p">()),</span>
<span class="ln">11</span>                <span class="k">new</span> <span class="n">CameraService</span><span class="p">(),</span> <span class="n">allowIsolated</span><span class="p">);</span>
<span class="ln">12</span>    <span class="p">}</span>
<span class="ln">13</span> 
<span class="ln">14</span>    <span class="k">static</span> <span class="kt">void</span> <span class="nf">instantiate</span><span class="p">()</span> <span class="p">{</span> <span class="n">publish</span><span class="p">();</span> <span class="p">}</span>
<span class="ln">15</span><span class="p">};</span>
</code></pre></div><p>这样，通过IServiceManager#addService()服务 “media.camera”就被添加到了系统中。</p>
<h3 id="323启动cameraserviceproxy服务">3.2.3启动CameraServiceProxy服务</h3>
<h4 id="3231启动system_server进程">3.2.3.1启动system_server进程</h4>
<p>在上述解析init.rc配置文件和其他.rc文件之后，会启动zygote进程，而这个zygote进程会启动system_server</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="kd">private</span> <span class="kd">static</span> <span class="n">Runnable</span> <span class="nf">forkSystemServer</span><span class="o">(</span><span class="n">String</span> <span class="n">abiList</span><span class="o">,</span> <span class="n">String</span> <span class="n">socketName</span><span class="o">,</span>
<span class="ln"> 2</span>        <span class="n">ZygoteServer</span> <span class="n">zygoteServer</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 3</span>   
<span class="ln"> 4</span>    <span class="c1">//启动system_server的命令行参数
</span><span class="ln"> 5</span><span class="c1"></span>    <span class="n">String</span> <span class="n">args</span><span class="o">[]</span> <span class="o">=</span> <span class="o">{</span>
<span class="ln"> 6</span>            <span class="s">&#34;--setuid=1000&#34;</span><span class="o">,</span>
<span class="ln"> 7</span>            <span class="s">&#34;--setgid=1000&#34;</span><span class="o">,</span>
<span class="ln"> 8</span>            <span class="s">&#34;--setgroups=1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,1021,1023,&#34;</span>
<span class="ln"> 9</span>                    <span class="o">+</span> <span class="s">&#34;1024,1032,1065,3001,3002,3003,3006,3007,3009,3010,3011&#34;</span><span class="o">,</span>
<span class="ln">10</span>            <span class="s">&#34;--capabilities=&#34;</span> <span class="o">+</span> <span class="n">capabilities</span> <span class="o">+</span> <span class="s">&#34;,&#34;</span> <span class="o">+</span> <span class="n">capabilities</span><span class="o">,</span>
<span class="ln">11</span>            <span class="s">&#34;--nice-name=system_server&#34;</span><span class="o">,</span>
<span class="ln">12</span>            <span class="s">&#34;--runtime-args&#34;</span><span class="o">,</span>
<span class="ln">13</span>            <span class="s">&#34;--target-sdk-version=&#34;</span> <span class="o">+</span> <span class="n">VMRuntime</span><span class="o">.</span><span class="na">SDK_VERSION_CUR_DEVELOPMENT</span><span class="o">,</span>
<span class="ln">14</span>            <span class="s">&#34;com.android.server.SystemServer&#34;</span><span class="o">,</span>
<span class="ln">15</span>    <span class="o">};</span>
<span class="ln">16</span>    <span class="n">ZygoteArguments</span> <span class="n">parsedArgs</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="ln">17</span>
<span class="ln">18</span>    <span class="kt">int</span> <span class="n">pid</span><span class="o">;</span>
<span class="ln">19</span>
<span class="ln">20</span>        <span class="n">pid</span> <span class="o">=</span> <span class="n">Zygote</span><span class="o">.</span><span class="na">forkSystemServer</span><span class="o">(</span>
<span class="ln">21</span>                <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mUid</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mGid</span><span class="o">,</span>
<span class="ln">22</span>                <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mGids</span><span class="o">,</span>
<span class="ln">23</span>                <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mRuntimeFlags</span><span class="o">,</span>
<span class="ln">24</span>                <span class="kc">null</span><span class="o">,</span>
<span class="ln">25</span>                <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mPermittedCapabilities</span><span class="o">,</span>
<span class="ln">26</span>                <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mEffectiveCapabilities</span><span class="o">);</span>
<span class="ln">27</span>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IllegalArgumentException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">28</span>        <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span>
<span class="ln">29</span>    <span class="o">}</span>
<span class="ln">30</span>
<span class="ln">31</span>    <span class="cm">/* For child process */</span>
<span class="ln">32</span>    <span class="k">if</span> <span class="o">(</span><span class="n">pid</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">33</span>        <span class="k">if</span> <span class="o">(</span><span class="n">hasSecondZygote</span><span class="o">(</span><span class="n">abiList</span><span class="o">))</span> <span class="o">{</span>
<span class="ln">34</span>            <span class="n">waitForSecondaryZygote</span><span class="o">(</span><span class="n">socketName</span><span class="o">);</span>
<span class="ln">35</span>        <span class="o">}</span>
<span class="ln">36</span>
<span class="ln">37</span>        <span class="n">zygoteServer</span><span class="o">.</span><span class="na">closeServerSocket</span><span class="o">();</span>
<span class="ln">38</span>        <span class="c1">//这里真正启动SystemServer
</span><span class="ln">39</span><span class="c1"></span>        <span class="k">return</span> <span class="n">handleSystemServerProcess</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">);</span>
<span class="ln">40</span>    <span class="o">}</span>
<span class="ln">41</span>
<span class="ln">42</span>    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
<span class="ln">43</span><span class="o">}</span>
</code></pre></div><p>system_server进程的执行过程，回调用到run方法</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln">1</span><span class="c1">//frameworks/base/services/java/com/android/server/SystemServer.java#run
</span><span class="ln">2</span><span class="c1"></span><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">3</span>    <span class="k">new</span> <span class="n">SystemServer</span><span class="o">().</span><span class="na">run</span><span class="o">();</span>
<span class="ln">4</span><span class="o">}</span>
</code></pre></div><p>这个run方法有几个功能。创建 SystemServiceManager(用于管理后面服务的生命周期)、<strong>启动引导服务、启动核心服、启动其他服务</strong>等</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="kd">private</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
<span class="ln"> 2</span>    <span class="o">...</span>
<span class="ln"> 3</span>    <span class="c1">// 加载libandroid_servers.so
</span><span class="ln"> 4</span><span class="c1"></span>    <span class="n">System</span><span class="o">.</span><span class="na">loadLibrary</span><span class="o">(</span><span class="s">&#34;android_servers&#34;</span><span class="o">);</span>
<span class="ln"> 5</span>
<span class="ln"> 6</span>    <span class="c1">// 创建 SystemContext
</span><span class="ln"> 7</span><span class="c1"></span>    <span class="n">createSystemContext</span><span class="o">();</span>
<span class="ln"> 8</span>        
<span class="ln"> 9</span>    <span class="c1">// 创建 SystemServiceManager
</span><span class="ln">10</span><span class="c1"></span>    <span class="n">mSystemServiceManager</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SystemServiceManager</span><span class="o">(</span><span class="n">mSystemContext</span><span class="o">);</span>
<span class="ln">11</span>    <span class="n">LocalServices</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">SystemServiceManager</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">mSystemServiceManager</span><span class="o">);</span>       <span class="n">SystemServerInitThreadPool</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
<span class="ln">12</span>    <span class="o">...</span> 
<span class="ln">13</span>    <span class="c1">// Start services.
</span><span class="ln">14</span><span class="c1"></span>    <span class="k">try</span> <span class="o">{</span>
<span class="ln">15</span>        <span class="n">t</span><span class="o">.</span><span class="na">traceBegin</span><span class="o">(</span><span class="s">&#34;StartServices&#34;</span><span class="o">);</span>
<span class="ln">16</span>        <span class="c1">//启动引导服务
</span><span class="ln">17</span><span class="c1"></span>        <span class="n">startBootstrapServices</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
<span class="ln">18</span>        <span class="c1">//启动核心服务
</span><span class="ln">19</span><span class="c1"></span>        <span class="n">startCoreServices</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
<span class="ln">20</span>        <span class="c1">//启动其他服务
</span><span class="ln">21</span><span class="c1"></span>        <span class="n">startOtherServices</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
<span class="ln">22</span>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">23</span>        <span class="o">...</span>
<span class="ln">24</span>    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
<span class="ln">25</span>        <span class="n">t</span><span class="o">.</span><span class="na">traceEnd</span><span class="o">();</span> <span class="c1">// StartServices
</span><span class="ln">26</span><span class="c1"></span>    <span class="o">}</span>
<span class="ln">27</span>    <span class="o">...</span> 
<span class="ln">28</span><span class="o">}</span>
</code></pre></div><h4 id="3232启动cameraserviceproxy服务">3.2.3.2启动CameraServiceProxy服务</h4>
<p>因为上述system_server会创建其他服务，而这个CameraService就在其他服务中。这里截取小段，可知会真实启动CameraServiceProxy，对应的binder是&quot;media.camera.proxy&quot;</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln">1</span><span class="c1">//framworks/base/services/java/com/android/server/SystemServer.java#
</span><span class="ln">2</span><span class="c1"></span><span class="k">if</span> <span class="o">(!</span><span class="n">disableCameraService</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">3</span>    <span class="n">t</span><span class="o">.</span><span class="na">traceBegin</span><span class="o">(</span><span class="s">&#34;StartCameraServiceProxy&#34;</span><span class="o">);</span>
<span class="ln">4</span>    <span class="n">mSystemServiceManager</span><span class="o">.</span><span class="na">startService</span><span class="o">(</span><span class="n">CameraServiceProxy</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="ln">5</span>    <span class="n">t</span><span class="o">.</span><span class="na">traceEnd</span><span class="o">();</span>
<span class="ln">6</span><span class="o">}</span>
</code></pre></div><h3 id="324cameraservice服务的aidl使用">3.2.4CameraService服务的AIDL使用</h3>
<p>CameraManager类获取“media.camera”服务，通过它和摄像头打交道，通过AIDL将App的相机进程和CameraService进程互相通信。这里的getService，就是获取CameraService进程，因为之前的getname已经将&quot;media.camera&quot;和CameraService绑定，那么这里就可以直接调用到CameraService。App相机进程在servicemanager中查询&quot;media.camera&quot;这个标记binder的服务，查询之后和CameraService建立Binder通信，通过App进程中jar包Api，对应调用到CameraService中相应的实现。</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//以camera2为例
</span><span class="ln"> 2</span><span class="c1">//frameworks/base/core/java/android/hardware/camera2/CameraManager.java
</span><span class="ln"> 3</span><span class="c1"></span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">CAMERA_SERVICE_BINDER_NAME</span> <span class="o">=</span> <span class="s">&#34;media.camera&#34;</span><span class="o">;</span>
<span class="ln"> 4</span><span class="kd">private</span> <span class="kd">final</span> <span class="n">ICameraService</span> <span class="n">mCameraService</span><span class="o">;</span>
<span class="ln"> 5</span><span class="kd">private</span> <span class="kt">void</span> <span class="nf">connectCameraServiceLocked</span><span class="o">()</span> <span class="o">{</span>
<span class="ln"> 6</span>    <span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;Connecting to camera service&#34;</span><span class="o">);</span>
<span class="ln"> 7</span>
<span class="ln"> 8</span>    <span class="n">IBinder</span> <span class="n">cameraServiceBinder</span> <span class="o">=</span> <span class="n">ServiceManager</span><span class="o">.</span><span class="na">getService</span><span class="o">(</span><span class="n">CAMERA_SERVICE_BINDER_NAME</span><span class="o">);</span>
<span class="ln"> 9</span>
<span class="ln">10</span>    <span class="n">ICameraService</span> <span class="n">cameraService</span> <span class="o">=</span> <span class="n">ICameraService</span><span class="o">.</span><span class="na">Stub</span><span class="o">.</span><span class="na">asInterface</span><span class="o">(</span><span class="n">cameraServiceBinder</span><span class="o">);</span>
<span class="ln">11</span>
<span class="ln">12</span>    <span class="k">try</span> <span class="o">{</span>
<span class="ln">13</span>        <span class="n">CameraStatus</span><span class="o">[]</span> <span class="n">cameraStatuses</span> <span class="o">=</span> <span class="n">cameraService</span><span class="o">.</span><span class="na">addListener</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
<span class="ln">14</span>        <span class="k">for</span> <span class="o">(</span><span class="n">CameraStatus</span> <span class="n">c</span> <span class="o">:</span> <span class="n">cameraStatuses</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">15</span>            <span class="n">onStatusChangedLocked</span><span class="o">(</span><span class="n">c</span><span class="o">.</span><span class="na">status</span><span class="o">,</span> <span class="n">c</span><span class="o">.</span><span class="na">cameraId</span><span class="o">);</span>
<span class="ln">16</span>
<span class="ln">17</span>            <span class="k">if</span> <span class="o">(</span><span class="n">c</span><span class="o">.</span><span class="na">unavailablePhysicalCameras</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">18</span>                <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">unavailPhysicalCamera</span> <span class="o">:</span> <span class="n">c</span><span class="o">.</span><span class="na">unavailablePhysicalCameras</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">19</span>                    <span class="n">onPhysicalCameraStatusChangedLocked</span><span class="o">(</span>
<span class="ln">20</span>                        <span class="n">ICameraServiceListener</span><span class="o">.</span><span class="na">STATUS_NOT_PRESENT</span><span class="o">,</span>
<span class="ln">21</span>                        <span class="n">c</span><span class="o">.</span><span class="na">cameraId</span><span class="o">,</span> <span class="n">unavailPhysicalCamera</span><span class="o">);</span>
<span class="ln">22</span>                <span class="o">}</span>
<span class="ln">23</span>            <span class="o">}</span>
<span class="ln">24</span>        <span class="o">}</span>
<span class="ln">25</span>        <span class="n">mCameraService</span> <span class="o">=</span> <span class="n">cameraService</span><span class="o">;</span>
<span class="ln">26</span>
<span class="ln">27</span>    <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="n">ServiceSpecificException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">28</span>        <span class="c1">// Unexpected failure
</span><span class="ln">29</span><span class="c1"></span>        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span><span class="s">&#34;Failed to register a camera service listener&#34;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
<span class="ln">30</span>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">31</span>        <span class="c1">// Camera service is now down, leave mCameraService as null
</span><span class="ln">32</span><span class="c1"></span>    <span class="o">}</span>
<span class="ln">33</span><span class="o">}</span>
</code></pre></div><h2 id="33cameraservicedump">3.3CameraService::dump</h2>
<p>最终调用到CameraService这个动态库中，实际上是调用到CameraService.cpp</p>
<p>这里主要dump几点Service global info、EventLog、Camera device dynamic info、CameraProviderManager、GlobalVendorTagDescriptor、CameraTraces，这里的6项跟上述3.1的打印信息一一对应。</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln">  1</span><span class="c1">//frameworks/av/services/camera/libcameraservice/CameraService.cpp
</span><span class="ln">  2</span><span class="c1"></span><span class="n">status_t</span> <span class="n">CameraService</span><span class="o">::</span><span class="n">dump</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">const</span> <span class="n">Vector</span><span class="o">&lt;</span><span class="n">String16</span><span class="o">&gt;&amp;</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">  3</span>    <span class="n">ATRACE_CALL</span><span class="p">();</span>
<span class="ln">  4</span>
<span class="ln">  5</span>    <span class="k">if</span> <span class="p">(</span><span class="n">checkCallingPermission</span><span class="p">(</span><span class="n">sDumpPermission</span><span class="p">)</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">  6</span>        <span class="n">dprintf</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="s">&#34;Permission Denial: can&#39;t dump CameraService from pid=%d, uid=%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
<span class="ln">  7</span>                <span class="n">CameraThreadState</span><span class="o">::</span><span class="n">getCallingPid</span><span class="p">(),</span>
<span class="ln">  8</span>                <span class="n">CameraThreadState</span><span class="o">::</span><span class="n">getCallingUid</span><span class="p">());</span>
<span class="ln">  9</span>        <span class="k">return</span> <span class="n">NO_ERROR</span><span class="p">;</span>
<span class="ln"> 10</span>    <span class="p">}</span>
<span class="ln"> 11</span>    <span class="kt">bool</span> <span class="n">locked</span> <span class="o">=</span> <span class="n">tryLock</span><span class="p">(</span><span class="n">mServiceLock</span><span class="p">);</span>
<span class="ln"> 12</span>    <span class="c1">// failed to lock - CameraService is probably deadlocked
</span><span class="ln"> 13</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">locked</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 14</span>        <span class="n">dprintf</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="s">&#34;!! CameraService may be deadlocked !!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
<span class="ln"> 15</span>    <span class="p">}</span>
<span class="ln"> 16</span>
<span class="ln"> 17</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mInitialized</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 18</span>        <span class="n">dprintf</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="s">&#34;!! No camera HAL available !!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
<span class="ln"> 19</span>
<span class="ln"> 20</span>        <span class="c1">// Dump event log for error information
</span><span class="ln"> 21</span><span class="c1"></span>        <span class="n">dumpEventLog</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
<span class="ln"> 22</span>
<span class="ln"> 23</span>        <span class="k">if</span> <span class="p">(</span><span class="n">locked</span><span class="p">)</span> <span class="n">mServiceLock</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
<span class="ln"> 24</span>        <span class="k">return</span> <span class="n">NO_ERROR</span><span class="p">;</span>
<span class="ln"> 25</span>    <span class="p">}</span>
<span class="ln"> 26</span>    <span class="n">dprintf</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="s">&#34;</span><span class="se">\n</span><span class="s">== Service global info: ==</span><span class="se">\n\n</span><span class="s">&#34;</span><span class="p">);</span>
<span class="ln"> 27</span>    <span class="n">dprintf</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="s">&#34;Number of camera devices: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">mNumberOfCameras</span><span class="p">);</span>
<span class="ln"> 28</span>    <span class="n">dprintf</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="s">&#34;Number of normal camera devices: %zu</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">mNormalDeviceIds</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
<span class="ln"> 29</span>    <span class="n">dprintf</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="s">&#34;Number of public camera devices visible to API1: %zu</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
<span class="ln"> 30</span>            <span class="n">mNormalDeviceIdsWithoutSystemCamera</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
<span class="ln"> 31</span>    <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mNormalDeviceIds</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 32</span>        <span class="n">dprintf</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="s">&#34;    Device %zu maps to </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">mNormalDeviceIds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">c_str</span><span class="p">());</span>
<span class="ln"> 33</span>    <span class="p">}</span>
<span class="ln"> 34</span>    <span class="n">String8</span> <span class="n">activeClientString</span> <span class="o">=</span> <span class="n">mActiveClientManager</span><span class="p">.</span><span class="n">toString</span><span class="p">();</span>
<span class="ln"> 35</span>    <span class="n">dprintf</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="s">&#34;Active Camera Clients:</span><span class="se">\n</span><span class="s">%s&#34;</span><span class="p">,</span> <span class="n">activeClientString</span><span class="p">.</span><span class="n">string</span><span class="p">());</span>
<span class="ln"> 36</span>    <span class="n">dprintf</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="s">&#34;Allowed user IDs: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">toString</span><span class="p">(</span><span class="n">mAllowedUsers</span><span class="p">).</span><span class="n">string</span><span class="p">());</span>
<span class="ln"> 37</span>
<span class="ln"> 38</span>    <span class="n">dumpEventLog</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
<span class="ln"> 39</span>
<span class="ln"> 40</span>    <span class="kt">bool</span> <span class="n">stateLocked</span> <span class="o">=</span> <span class="n">tryLock</span><span class="p">(</span><span class="n">mCameraStatesLock</span><span class="p">);</span>
<span class="ln"> 41</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stateLocked</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 42</span>        <span class="n">dprintf</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="s">&#34;CameraStates in use, may be deadlocked</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
<span class="ln"> 43</span>    <span class="p">}</span>
<span class="ln"> 44</span>
<span class="ln"> 45</span>    <span class="kt">int</span> <span class="n">argSize</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<span class="ln"> 46</span>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">argSize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 47</span>        <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">TagMonitor</span><span class="o">::</span><span class="n">kMonitorOption</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 48</span>            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">argSize</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 49</span>                <span class="n">mMonitorTags</span> <span class="o">=</span> <span class="n">String8</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>
<span class="ln"> 50</span>            <span class="p">}</span>
<span class="ln"> 51</span>            <span class="k">break</span><span class="p">;</span>
<span class="ln"> 52</span>        <span class="p">}</span>
<span class="ln"> 53</span>    <span class="p">}</span>
<span class="ln"> 54</span>
<span class="ln"> 55</span>    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span> <span class="nl">state</span> <span class="p">:</span> <span class="n">mCameraStates</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 56</span>        <span class="n">String8</span> <span class="n">cameraId</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">first</span><span class="p">;</span>
<span class="ln"> 57</span>
<span class="ln"> 58</span>        <span class="n">dprintf</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="s">&#34;== Camera device %s dynamic info: ==</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">cameraId</span><span class="p">.</span><span class="n">string</span><span class="p">());</span>
<span class="ln"> 59</span>
<span class="ln"> 60</span>        <span class="n">CameraParameters</span> <span class="n">p</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">getShimParams</span><span class="p">();</span>
<span class="ln"> 61</span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">())</span> <span class="p">{</span>
<span class="ln"> 62</span>            <span class="n">dprintf</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="s">&#34;  Camera1 API shim is using parameters:</span><span class="se">\n</span><span class="s">        &#34;</span><span class="p">);</span>
<span class="ln"> 63</span>            <span class="n">p</span><span class="p">.</span><span class="n">dump</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
<span class="ln"> 64</span>        <span class="p">}</span>
<span class="ln"> 65</span>
<span class="ln"> 66</span>        <span class="k">auto</span> <span class="n">clientDescriptor</span> <span class="o">=</span> <span class="n">mActiveClientManager</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">cameraId</span><span class="p">);</span>
<span class="ln"> 67</span>        <span class="k">if</span> <span class="p">(</span><span class="n">clientDescriptor</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 68</span>            <span class="n">dprintf</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="s">&#34;  Device %s is open. Client instance dump:</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
<span class="ln"> 69</span>                    <span class="n">cameraId</span><span class="p">.</span><span class="n">string</span><span class="p">());</span>
<span class="ln"> 70</span>            <span class="n">dprintf</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="s">&#34;    Client priority score: %d state: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
<span class="ln"> 71</span>                    <span class="n">clientDescriptor</span><span class="o">-&gt;</span><span class="n">getPriority</span><span class="p">().</span><span class="n">getScore</span><span class="p">(),</span>
<span class="ln"> 72</span>                    <span class="n">clientDescriptor</span><span class="o">-&gt;</span><span class="n">getPriority</span><span class="p">().</span><span class="n">getState</span><span class="p">());</span>
<span class="ln"> 73</span>            <span class="n">dprintf</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="s">&#34;    Client PID: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">clientDescriptor</span><span class="o">-&gt;</span><span class="n">getOwnerId</span><span class="p">());</span>
<span class="ln"> 74</span>
<span class="ln"> 75</span>            <span class="k">auto</span> <span class="n">client</span> <span class="o">=</span> <span class="n">clientDescriptor</span><span class="o">-&gt;</span><span class="n">getValue</span><span class="p">();</span>
<span class="ln"> 76</span>            <span class="n">dprintf</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="s">&#34;    Client package: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
<span class="ln"> 77</span>                    <span class="n">String8</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">getPackageName</span><span class="p">()).</span><span class="n">string</span><span class="p">());</span>
<span class="ln"> 78</span>
<span class="ln"> 79</span>            <span class="n">client</span><span class="o">-&gt;</span><span class="n">dumpClient</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
<span class="ln"> 80</span>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="ln"> 81</span>            <span class="n">dprintf</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="s">&#34;  Device %s is closed, no client instance</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
<span class="ln"> 82</span>                    <span class="n">cameraId</span><span class="p">.</span><span class="n">string</span><span class="p">());</span>
<span class="ln"> 83</span>        <span class="p">}</span>
<span class="ln"> 84</span>
<span class="ln"> 85</span>    <span class="p">}</span>
<span class="ln"> 86</span>
<span class="ln"> 87</span>    <span class="k">if</span> <span class="p">(</span><span class="n">stateLocked</span><span class="p">)</span> <span class="n">mCameraStatesLock</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
<span class="ln"> 88</span>
<span class="ln"> 89</span>    <span class="k">if</span> <span class="p">(</span><span class="n">locked</span><span class="p">)</span> <span class="n">mServiceLock</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
<span class="ln"> 90</span>
<span class="ln"> 91</span>    <span class="n">mCameraProviderManager</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
<span class="ln"> 92</span>
<span class="ln"> 93</span>    <span class="n">dprintf</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="s">&#34;</span><span class="se">\n</span><span class="s">== Vendor tags: ==</span><span class="se">\n\n</span><span class="s">&#34;</span><span class="p">);</span>
<span class="ln"> 94</span>
<span class="ln"> 95</span>    <span class="n">sp</span><span class="o">&lt;</span><span class="n">VendorTagDescriptor</span><span class="o">&gt;</span> <span class="n">desc</span> <span class="o">=</span> <span class="n">VendorTagDescriptor</span><span class="o">::</span><span class="n">getGlobalVendorTagDescriptor</span><span class="p">();</span>
<span class="ln"> 96</span>    <span class="k">if</span> <span class="p">(</span><span class="n">desc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 97</span>        <span class="n">sp</span><span class="o">&lt;</span><span class="n">VendorTagDescriptorCache</span><span class="o">&gt;</span> <span class="n">cache</span> <span class="o">=</span>
<span class="ln"> 98</span>                <span class="n">VendorTagDescriptorCache</span><span class="o">::</span><span class="n">getGlobalVendorTagCache</span><span class="p">();</span>
<span class="ln"> 99</span>        <span class="k">if</span> <span class="p">(</span><span class="n">cache</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">100</span>            <span class="n">dprintf</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="s">&#34;No vendor tags.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
<span class="ln">101</span>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="ln">102</span>            <span class="n">cache</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="cm">/*verbosity*/</span><span class="mi">2</span><span class="p">,</span> <span class="cm">/*indentation*/</span><span class="mi">2</span><span class="p">);</span>
<span class="ln">103</span>        <span class="p">}</span>
<span class="ln">104</span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="ln">105</span>        <span class="n">desc</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="cm">/*verbosity*/</span><span class="mi">2</span><span class="p">,</span> <span class="cm">/*indentation*/</span><span class="mi">2</span><span class="p">);</span>
<span class="ln">106</span>    <span class="p">}</span>
<span class="ln">107</span>
<span class="ln">108</span>    <span class="c1">// Dump camera traces if there were any
</span><span class="ln">109</span><span class="c1"></span>    <span class="n">dprintf</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
<span class="ln">110</span>    <span class="n">camera3</span><span class="o">::</span><span class="n">CameraTraces</span><span class="o">::</span><span class="n">dump</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
<span class="ln">111</span>
<span class="ln">112</span>    <span class="c1">// Process dump arguments, if any
</span><span class="ln">113</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<span class="ln">114</span>    <span class="n">String16</span> <span class="nf">verboseOption</span><span class="p">(</span><span class="s">&#34;-v&#34;</span><span class="p">);</span>
<span class="ln">115</span>    <span class="n">String16</span> <span class="nf">unreachableOption</span><span class="p">(</span><span class="s">&#34;--unreachable&#34;</span><span class="p">);</span>
<span class="ln">116</span>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">117</span>        <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">verboseOption</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">118</span>            <span class="c1">// change logging level
</span><span class="ln">119</span><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
<span class="ln">120</span>            <span class="n">String8</span> <span class="nf">levelStr</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]);</span>
<span class="ln">121</span>            <span class="kt">int</span> <span class="n">level</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">levelStr</span><span class="p">.</span><span class="n">string</span><span class="p">());</span>
<span class="ln">122</span>            <span class="n">dprintf</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="s">&#34;</span><span class="se">\n</span><span class="s">Setting log level to %d.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
<span class="ln">123</span>            <span class="n">setLogLevel</span><span class="p">(</span><span class="n">level</span><span class="p">);</span>
<span class="ln">124</span>        <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">unreachableOption</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">125</span>            <span class="c1">// Dump memory analysis
</span><span class="ln">126</span><span class="c1"></span>            <span class="c1">// TODO - should limit be an argument parameter?
</span><span class="ln">127</span><span class="c1"></span>            <span class="n">UnreachableMemoryInfo</span> <span class="n">info</span><span class="p">;</span>
<span class="ln">128</span>            <span class="kt">bool</span> <span class="n">success</span> <span class="o">=</span> <span class="n">GetUnreachableMemory</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="cm">/*limit*/</span> <span class="mi">10000</span><span class="p">);</span>
<span class="ln">129</span>            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">success</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">130</span>                <span class="n">dprintf</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="s">&#34;</span><span class="se">\n</span><span class="s">== Unable to dump unreachable memory. &#34;</span>
<span class="ln">131</span>                        <span class="s">&#34;Try disabling SELinux enforcement. ==</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
<span class="ln">132</span>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="ln">133</span>                <span class="n">dprintf</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="s">&#34;</span><span class="se">\n</span><span class="s">== Dumping unreachable memory: ==</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
<span class="ln">134</span>                <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">s</span> <span class="o">=</span> <span class="n">info</span><span class="p">.</span><span class="n">ToString</span><span class="p">(</span><span class="cm">/*log_contents*/</span> <span class="nb">true</span><span class="p">);</span>
<span class="ln">135</span>                <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">s</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
<span class="ln">136</span>            <span class="p">}</span>
<span class="ln">137</span>        <span class="p">}</span>
<span class="ln">138</span>    <span class="p">}</span>
<span class="ln">139</span>    <span class="k">return</span> <span class="n">NO_ERROR</span><span class="p">;</span>
<span class="ln">140</span><span class="p">}</span>
</code></pre></div><blockquote>
<p>关于什么是dprintf，实际上跟printf是非常类似的。相对于printf加了一个句柄的指向。可以通过在linux中man dprintf查看。</p>
<p>NAME
printf,   fprintf,   dprintf,  sprintf,  snprintf,  vprintf,  vfprintf,
vdprintf, vsprintf, vsnprintf - formatted output conversion</p>
<p>SYNOPSIS
#include &lt;stdio.h&gt;</p>
<pre><code>   int printf(const char *format, ...);
   int fprintf(FILE *stream, const char *format, ...);
   int dprintf(int fd, const char *format, ...);
   int sprintf(char *str, const char *format, ...);
   int snprintf(char *str, size_t size, const char *format, ...);
</code></pre>
</blockquote>
<h1 id="总结">总结</h1>
<p>总的来说，就是通过简单的dumpsys进程的api调用，深入查看dumpsys media.camera背后做的事，里面其实涉及到Binder通信，管道，poll机制，主要的流程比较能够理解。本文是笔者用api和源码的角度去熟悉media.camera的过程，因为dumpsys里面的服务比较多，这里只是以一个Camera为例子，来说明整个dumpsys过程。</p>
<h1 id="下载">下载</h1>
<p>本文dumpsys的源码<a href="https://github.com/YangYang48/project/tree/master/dumpsys">点击这里</a></p>
<p>本文CameraService启动的源码<a href="https://github.com/YangYang48/project/tree/master/CameraService">点击这里</a></p>
<p>本文以手机红米K30为例的dumpsys的数据<a href="https://github.com/YangYang48/project/tree/master/cameradump_redmiK30">点击这里</a></p>
<p>本文以手机空米K30为例的dumpsys的proto数据<a href="https://github.com/YangYang48/project/tree/master/activity_dump_proto">点击这里</a></p>
<h1 id="参考">参考</h1>
<p><a href="https://blog.51cto.com/u_15152644/2690464">[1] 小驰笔记, Dump media.camera分析, 2021.</a></p>
<p><a href="https://blog.csdn.net/u013686019/article/details/72819908?spm=1001.2101.3001.6650.1&amp;utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-1.pc_relevant_default&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-1.pc_relevant_default&amp;utm_relevant_index=2">[2] <strong>2017</strong>, Android框架之Camera(1)Camera服务的前世今生, 2017.</a></p>
<p><a href="https://blog.csdn.net/weixin_39970855/article/details/111946828?spm=1001.2101.3001.6650.15&amp;utm_medium=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromBaidu~Rate-15.pc_relevant_default&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromBaidu~Rate-15.pc_relevant_default&amp;utm_relevant_index=25">[3] weixin_39970855, adb命令打开摄像头_Camera(一):查看Camera设备详细信息, 2020.</a></p>
<p><a href="http://gityuan.com/2015/08/22/tool-dumpsys/">[4] 袁辉辉, dumpsys源码, 2015.</a></p>
<p><a href="https://blog.csdn.net/tonglin12138/article/details/85467289">[5] 拥抱@, 详解C语言中的 %*s 和 %.*s, 2018.</a></p>
<p><a href="https://developer.android.google.cn/studio/command-line/dumpsys">[6] 谷歌官方, dumpsys, 2021.</a></p>
<p><a href="https://www.jianshu.com/p/1cc7615f030f?utm_campaign=maleskine&amp;utm_content=note&amp;utm_medium=seo_notes&amp;utm_source=recommendation">[7] Little丶Jerry, Android 解析 Protocol Buffers 格式数据, 2018.</a></p>
<p><a href="https://blog.csdn.net/ChaoY1116/article/details/109669865">[8] 猿氏悟语, Android Dumpsys命令使用以及实现原理详解, 2020.</a></p>
<p><a href="https://blog.csdn.net/qq_33850438/article/details/80172275">[9] andy cong, 浅谈linux的命令行解析参数之getopt_long函数, 2018.</a></p>
<p><a href="https://blog.csdn.net/qq_26498311/article/details/117128520">[10] 伟子时代, Android系统启动流程, 2021.</a></p>
<p><a href="https://blog.csdn.net/weixin_42463482/article/details/118880978">[11] 菜鸡UP, Android Camera之CameraServer的启动过程, 2022.</a></p>
<p><a href="https://blog.csdn.net/qq_37858386/article/details/121416871">[12] 海月汐辰, Android mk文件 LOCAL_INIT_RC 将RC文件编译到/system/etc/init或vendor/etc/init，system\core\init\init.cpp解析这些rc, 2022.</a></p>
<p><a href="https://blog.csdn.net/feigebangni/article/details/50300063">[13] astro-yang, init.rc语法详解, 2015.</a></p>
<p><a href="https://blog.csdn.net/weixin_44471948/article/details/120846877">[14] BBOrange丶, pipe()函数详解, 2021.</a></p>
              
            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">标签</span><br/>
                    
  <a class="tag tag--primary tag--small" href="https://yangyang48.github.io/tags/java/">java</a>

  <a class="tag tag--primary tag--small" href="https://yangyang48.github.io/tags/c&#43;&#43;/">C&#43;&#43;</a>

  <a class="tag tag--primary tag--small" href="https://yangyang48.github.io/tags/android/">Android</a>

  <a class="tag tag--primary tag--small" href="https://yangyang48.github.io/tags/%E6%BA%90%E7%A0%81/">源码</a>

                  </div>
                
              
            
            <div class="post-actions-wrap">
  
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://yangyang48.github.io/2022/05/%E5%88%9D%E8%AF%86choreographer/" data-tooltip="初识choreographer">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">下一篇</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://yangyang48.github.io/2022/04/threadlocal%E4%B9%8B%E5%AD%90%E7%88%B6%E7%BA%BF%E7%A8%8B%E7%9A%84%E6%81%A9%E7%88%B1%E6%83%85%E4%BB%87/" data-tooltip="ThreadLocal之子父线程的恩爱情仇">
              
                  <span class="hide-xs hide-sm text-small icon-mr">上一篇</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#disqus_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#">
        
          <i class="fa fa-list"></i>
        </a>
      </li>
    </ul>
  
</div>

            
              
                <div id="disqus_thread">
  <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
              
            
          </div>
        </article>
		
		<div class="post-comment main-content-wrap">
		
  
  <div id="vcomments"></div>
  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src='//unpkg.com/valine/dist/Valine.min.js'></script>
  <script type="text/javascript">
    new Valine({
        el: '#vcomments' ,
        appId: 'mwl8M1aQzLnRE6JIpIY3sgE5-9Nh9j0Va',
        appKey: 'mPGr6GMC0BuzAKkxinnd0IAr',
        notify:  true , 
        verify:  false , 
        avatar:'retro', 
        placeholder: '欢迎各位宝宝留言~',
        visitor:  true 
    });
  </script>

		</div>
        <footer id="footer" class="main-content-wrap">
  
  
  
  <span class="copyrights">
    &copy; 2022 Yang Ju. All Rights Reserved
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
        <div class="post-actions-wrap">
  
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://yangyang48.github.io/2022/05/%E5%88%9D%E8%AF%86choreographer/" data-tooltip="初识choreographer">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">下一篇</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://yangyang48.github.io/2022/04/threadlocal%E4%B9%8B%E5%AD%90%E7%88%B6%E7%BA%BF%E7%A8%8B%E7%9A%84%E6%81%A9%E7%88%B1%E6%83%85%E4%BB%87/" data-tooltip="ThreadLocal之子父线程的恩爱情仇">
              
                  <span class="hide-xs hide-sm text-small icon-mr">上一篇</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#disqus_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#">
        
          <i class="fa fa-list"></i>
        </a>
      </li>
    </ul>
  
</div>

      </div>
      <div id="share-options-bar" class="share-options-bar" data-behavior="4">
  <i id="btn-close-shareoptions" class="fa fa-close"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fyangyang48.github.io%2F2022%2F04%2Fdumpsys%25E7%25AE%2580%25E4%25BB%258B-%25E4%25BB%25A5media.camera%25E4%25B8%25BA%25E4%25BE%258B%2F">
          <i class="fa fa-facebook-official"></i><span>分享到 Facebook</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=https%3A%2F%2Fyangyang48.github.io%2F2022%2F04%2Fdumpsys%25E7%25AE%2580%25E4%25BB%258B-%25E4%25BB%25A5media.camera%25E4%25B8%25BA%25E4%25BE%258B%2F">
          <i class="fa fa-twitter"></i><span>分享到 Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=https%3A%2F%2Fyangyang48.github.io%2F2022%2F04%2Fdumpsys%25E7%25AE%2580%25E4%25BB%258B-%25E4%25BB%25A5media.camera%25E4%25B8%25BA%25E4%25BE%258B%2F">
          <i class="fa fa-google-plus"></i><span>分享到 Google&#43;</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>
    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="https://img-blog.csdnimg.cn/20210711204627625.jpg" alt="作者的图片" />
    
    <h4 id="about-card-name">Yang Ju</h4>
    
      <div id="about-card-bio">Nanjing University of Science and Technology</div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Software Development Engineer
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        NanJing,China
      </div>
    
  </div>
</div>

    

    
  
    
      <div id="cover" style="background-image:url('https://yangyang48.github.io/images/cover.jpg');"></div>
    
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.7/js/jquery.fancybox.min.js" integrity="sha256-GEAnjcTqVP+vBp3SSc8bEDQqvWAZMiHyUSIorrWwH50=" crossorigin="anonymous"></script>


<script src="https://yangyang48.github.io/js/script-pcw6v3xilnxydl1vddzazdverrnn9ctynvnxgwho987mfyqkuylcb1nlt.min.js"></script>


  
    <script src="https://yangyang48.github.io/js/copy-to-clipboard.js"></script>
  

<script lang="javascript">
window.onload = updateMinWidth;
window.onresize = updateMinWidth;
document.getElementById("sidebar").addEventListener("transitionend", updateMinWidth);
function updateMinWidth() {
  var sidebar = document.getElementById("sidebar");
  var main = document.getElementById("main");
  main.style.minWidth = "";
  var w1 = getComputedStyle(main).getPropertyValue("min-width");
  var w2 = getComputedStyle(sidebar).getPropertyValue("width");
  var w3 = getComputedStyle(sidebar).getPropertyValue("left");
  main.style.minWidth = `calc(${w1} - ${w2} - ${w3})`;
}
</script>

<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>


  
    
      <script>
        var disqus_config = function () {
          this.page.url = 'https:\/\/yangyang48.github.io\/2022\/04\/dumpsys%E7%AE%80%E4%BB%8B-%E4%BB%A5media.camera%E4%B8%BA%E4%BE%8B\/';
          
            this.page.identifier = '\/2022\/04\/dumpsys%E7%AE%80%E4%BB%8B-%E4%BB%A5media.camera%E4%B8%BA%E4%BE%8B\/'
          
        };
        (function() {
          
          
          if (window.location.hostname == "localhost") {
            return;
          }
          var d = document, s = d.createElement('script');
          var disqus_shortname = 'hugo-tranquilpeak-theme';
          s.src = '//' + disqus_shortname + '.disqus.com/embed.js';

          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();
      </script>
    
  




    
  </body>
</html>

