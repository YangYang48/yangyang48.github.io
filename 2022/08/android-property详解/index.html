<!DOCTYPE html>
<html lang="en-us">
  <head>
    
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Hugo 0.85.0 with theme Tranquilpeak 0.4.8-BETA">
<meta name="author" content="Yang Ju">
<meta name="keywords" content="">
<meta name="description" content="Android系统中的属性，我们可以通过get和set去获取，但是有时候App获取修改属性的操作被拒绝了，这个就需要深入了解属性系统。">


<meta property="og:description" content="Android系统中的属性，我们可以通过get和set去获取，但是有时候App获取修改属性的操作被拒绝了，这个就需要深入了解属性系统。">
<meta property="og:type" content="article">
<meta property="og:title" content="Android Property详解">
<meta name="twitter:title" content="Android Property详解">
<meta property="og:url" content="https://yangyang48.github.io/2022/08/android-property%E8%AF%A6%E8%A7%A3/">
<meta property="twitter:url" content="https://yangyang48.github.io/2022/08/android-property%E8%AF%A6%E8%A7%A3/">
<meta property="og:site_name" content="欢迎来到我的博客~">
<meta property="og:description" content="Android系统中的属性，我们可以通过get和set去获取，但是有时候App获取修改属性的操作被拒绝了，这个就需要深入了解属性系统。">
<meta name="twitter:description" content="Android系统中的属性，我们可以通过get和set去获取，但是有时候App获取修改属性的操作被拒绝了，这个就需要深入了解属性系统。">
<meta property="og:locale" content="zh-cn">

  
    <meta property="article:published_time" content="2022-08-21T00:00:00">
  
  
    <meta property="article:modified_time" content="2022-08-21T00:00:00">
  
  
  
    
      <meta property="article:section" content="Property">
    
      <meta property="article:section" content="2022">
    
      <meta property="article:section" content="August">
    
  
  
    
      <meta property="article:tag" content="Android">
    
      <meta property="article:tag" content="源码">
    
      <meta property="article:tag" content="SElinux">
    
      <meta property="article:tag" content="Trie">
    
      <meta property="article:tag" content="socket">
    
      <meta property="article:tag" content="mmap">
    
      <meta property="article:tag" content="共享内存">
    
      <meta property="article:tag" content="匿名私有内存">
    
      <meta property="article:tag" content="proto">
    
      <meta property="article:tag" content="rc文件">
    
      <meta property="article:tag" content="persist属性">
    
  


<meta name="twitter:card" content="summary">







  <meta property="og:image" content="https://yangyang48.github.io/property/property_thumb.jpg">
  <meta property="twitter:image" content="https://yangyang48.github.io/property/property_thumb.jpg">


  <meta property="og:image" content="https://yangyang48.github.io/property/property_cover.jpg">
  <meta property="twitter:image" content="https://yangyang48.github.io/property/property_cover.jpg">




  <meta property="og:image" content="https://img-blog.csdnimg.cn/20210711204627625.jpg">
  <meta property="twitter:image" content="https://img-blog.csdnimg.cn/20210711204627625.jpg">


    <title>Android Property详解</title>

    <link rel="icon" href="https://yangyang48.github.io/favicon.png">
    

    

    <link rel="canonical" href="https://yangyang48.github.io/2022/08/android-property%E8%AF%A6%E8%A7%A3/">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.min.css" integrity="sha256-vuXZ9LGmmwtjqFX1F+EKin1ThZMub58gKULUyf0qECk=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/helpers/jquery.fancybox-thumbs.min.css" integrity="sha256-SEa4XYAHihTcEP1f5gARTB2K26Uk8PsndQYHQC1f4jU=" crossorigin="anonymous" />
    
    
    <link rel="stylesheet" href="https://yangyang48.github.io/css/style-twzjdbqhmnnacqs0pwwdzcdbt8yhv8giawvjqjmyfoqnvazl0dalmnhdkvp7.min.css" />
    
    
      
        <link rel="stylesheet"  href="https://yangyang48.github.io/css/copy-to-clipboard.css">
      
    

    
      
    
    

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="4">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://yangyang48.github.io/">欢迎来到我的博客~</a>
  </div>
  
    
      <a class="header-right-picture "
         href="https://yangyang48.github.io/#about">
    
    
    
      
        <img class="header-picture" src="https://img-blog.csdnimg.cn/20210711204627625.jpg" alt="作者的图片" />
      
    
    </a>
  
</header>

      <nav id="sidebar" data-behavior="4">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://yangyang48.github.io/#about">
          <img class="sidebar-profile-picture" src="https://img-blog.csdnimg.cn/20210711204627625.jpg" alt="作者的图片" />
        </a>
        <h4 class="sidebar-profile-name">Yang Ju</h4>
        
          <h5 class="sidebar-profile-bio">Nanjing University of Science and Technology</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://yangyang48.github.io/">
    
      <i class="sidebar-button-icon fa fa-lg fa-home"></i>
      
      <span class="sidebar-button-desc">首页</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://yangyang48.github.io/categories">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">分类</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://yangyang48.github.io/tags">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">标签</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://yangyang48.github.io/archives">
    
      <i class="sidebar-button-icon fa fa-lg fa-archive"></i>
      
      <span class="sidebar-button-desc">归档</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://yangyang48.github.io/#about">
    
      <i class="sidebar-button-icon fa fa-lg fa-question"></i>
      
      <span class="sidebar-button-desc">关于</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/YangYang48" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-github"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://blog.csdn.net/yangju147532896" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-chain"></i>
      
      <span class="sidebar-button-desc">CSDN</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
  </div>
</nav>

      
  <div class="post-header-cover
              text-center
              "
       style="background-image:url('/property/property_cover.jpg')"
       data-behavior="4">
    
  </div>


      <div id="main" data-behavior="4"
        class="hasCover
               hasCoverMetaOut
               ">
        <article class="post" itemscope itemType="http://schema.org/BlogPosting">
          
          
            <div class="post-header main-content-wrap text-center">
  
    <h1 class="post-title" itemprop="headline">
      Android Property详解
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time itemprop="datePublished" datetime="2022-08-21T00:00:00Z">
        
  八月 21, 2022

      </time>
    
    
  
  
    <span>发布在</span>
    
      <a class="category-link" href="https://yangyang48.github.io/categories/property">Property</a>, 
    
      <a class="category-link" href="https://yangyang48.github.io/categories/2022">2022</a>, 
    
      <a class="category-link" href="https://yangyang48.github.io/categories/august">August</a>
    
  

  </div>

</div>
          
		  
		  <h5 id="wc" style="font-size: 1rem;text-align: center;">9600 Words|Read in about 45 Min|本文总阅读量<span id="busuanzi_value_page_pv"></span>次</h5>
		  
          <div class="post-content markdown" itemprop="articleBody">
            <div class="main-content-wrap">
              <p>Android系统中的属性，我们可以通过get和set去获取，但是有时候App获取修改属性的操作被拒绝了，这个就需要深入了解属性系统。</p>
<h1 id="android-property详解">Android Property详解</h1>
<h1 id="0属性介绍">0属性介绍</h1>
<h2 id="01简介">0.1简介</h2>
<p>在 android 系统中，为同一管理系统的属性，设计了一个统一的属性系统。每个属性都有一个名字和值，他们都是字符串格式。属性被大量使用在 Android 系统中，用来记录系统设置或进程之间的信息交换。属性是在整个系统中全局可见的。每个进程可以 <code>get/set</code> 属性。在编译的过程中会将各种系统参数汇总到 <code>build.proc</code> 以及 <code>default.proc</code> 这两个文件中，主要属性集中在 <code>build.proc</code> 中。系统在开机后将读取配置信息并构建共享缓冲区，加快查询速度。本文以<code>Android11</code>来介绍属性系统。</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/property/property_2.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/property/property_2.png" >
  
    </a>
  
  
</div>

<h2 id="02properties-type">0.2Properties Type</h2>
<p>​    系统属性根据不同的应用类型，分为不可变型，持久型，网络型，启动和停止服务等。</p>
<p><strong>特别属性：</strong></p>
<ul>
<li>属性名称以 <code>ro.</code> 开头，那么这个属性被视为只读属性。一旦设置，属性值不能改变。</li>
<li>属性名称以<code>persist.</code> 开头，当设置这个属性时，其值也将写入 <code>/data/property</code>。</li>
<li>属性名称以 <code>net.</code> 开头，当设置这个属性时，<code>net.change</code> 属性将会自动设置，以加入到最后修改的属性名。（这是很巧妙的。<code>netresolve</code> 模块的使用这个属性来追踪在 <code>net.*</code> 属性上的任何变化。）</li>
<li>属性 <code>ctrl.start</code> 和 <code>ctrl.stop</code> 是用来启动和停止服务。每一项服务必须在 <code>/init.rc</code> 中定义。系统启动时，与 <code>init</code> 守护进程将解析 <code>init.rc</code> 和启动属性服务。一旦收到设置 <code>ctrl.start</code> 属性的请求，属性服务将使用该属性值作为服务名找到该服务，启动该服务。这项服务的启动结果将会放入 <code>init.svc.&lt;服务名&gt;</code> 属性中。客户端应用程序可以轮训那个属性值，以确定结果。</li>
</ul>
<h2 id="03android-toolbox">0.3Android toolbox</h2>
<p>​    Android toolbox 程序提供了两个工具：<code>setprop</code> 和 <code>getprop</code> 获取和设置属性。其使用方法：</p>
<blockquote>
<p>getprop &lt;属性名&gt;</p>
<p>setprop &lt;属性名&gt; &lt;属性值&gt;</p>
</blockquote>
<p><strong>Java</strong></p>
<p>​    在 Java 应用程序可以使用 <code>System.getProperty()</code> 和 <code>System.setProperty()</code> 函数获取和设置属性。</p>
<p><strong>Action</strong></p>
<p>​     默认情况下，设置属性只会使 <code>init</code> 守护程序写入共享内存，它不会执行任何脚本或二进制程序。但是，您可以将您的想要的实现的操作与 <code>init.rc</code> 中某个属性的变化相关联。例如，在默认的 <code>init.rc</code> 中有：</p>
<div class="highlight"><pre class="chroma"><code class="language-vbnet" data-lang="vbnet"><span class="ln">1</span><span class="p">#</span> <span class="n">adbd</span> <span class="k">on</span> <span class="n">at</span> <span class="n">boot</span> <span class="ow">in</span> <span class="n">emulator</span>
<span class="ln">2</span><span class="k">on</span> <span class="n">property</span><span class="p">:</span><span class="n">ro</span><span class="p">.</span><span class="n">kernel</span><span class="p">.</span><span class="n">qemu</span><span class="o">=</span><span class="n">1</span>
<span class="ln">3</span><span class="n">start</span> <span class="n">adbd</span>
<span class="ln">4</span><span class="k">on</span> <span class="n">property</span><span class="p">:</span><span class="n">persist</span><span class="p">.</span><span class="n">service</span><span class="p">.</span><span class="n">adb</span><span class="p">.</span><span class="n">enbale</span><span class="o">=</span><span class="n">1</span>
<span class="ln">5</span><span class="n">start</span> <span class="n">adbd</span>
<span class="ln">6</span><span class="k">on</span> <span class="n">property</span><span class="p">:</span><span class="n">persist</span><span class="p">.</span><span class="n">service</span><span class="p">.</span><span class="n">adb</span><span class="p">.</span><span class="n">enable</span><span class="o">=</span><span class="n">0</span>
<span class="ln">7</span><span class="k">stop</span> <span class="n">adbd</span>
</code></pre></div><h2 id="04properties-source">0.4Properties Source</h2>
<p>属性的设置可以出现在 <strong>make android 的任何环节</strong>。</p>
<blockquote>
<p><code>alps/build/target/board/generic_arm64/system.prop</code></p>
<p><code>alps/build/target/product/core.mk</code></p>
<p><code>alps/buid/tools/buildinfo.sh</code></p>
</blockquote>
<p>编译好后，被设置的系统属性主要存放在：</p>
<p>这样，如果你设置 <code>persist.service.adb.enable</code> 为1，<code>init</code> 守护进程就知道需要采取行动：开启 <code>adbd</code> 服务。</p>
<blockquote>
<p><code>/default.prop</code>         手机厂商自己定制使用</p>
<p><code>/system/build.prop</code>     系统属性主要存放处</p>
<p><code>/system/default.prop</code>    default properties，存放与 security 相关的属性</p>
<p><code>/data/property/persistent_properties</code>       保存着持久属性</p>
</blockquote>
<h1 id="系统初始化属性">系统初始化属性</h1>
<p>初始化属性一定是在系统初始化的时候就存在，且存在的时刻不能太晚，后续好多rc文件去启动进程，都会大量的需要属性的读取和设置。</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln">1</span><span class="c1">//system/core/init/init.cpp
</span><span class="ln">2</span><span class="c1"></span><span class="k">static</span> <span class="kt">int</span> <span class="n">property_fd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="ln">3</span><span class="kt">int</span> <span class="nf">SecondStageMain</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">4</span>    <span class="n">PropertyInit</span><span class="p">();</span>
<span class="ln">5</span>    <span class="p">...</span>
<span class="ln">6</span>    <span class="n">StartPropertyService</span><span class="p">(</span><span class="o">&amp;</span><span class="n">property_fd</span><span class="p">);</span>
<span class="ln">7</span>    <span class="p">...</span>
<span class="ln">8</span><span class="p">}</span>
</code></pre></div><h1 id="1propertyinit">1PropertyInit</h1>
<p>用于属性的初始化，包括创建有关<code>PropertyInfo</code>的序列化，创建对应的<code>SElinux</code>的<code>Context</code>文件，初始化属性的导入，这里也会加载一些属性脚本文件等</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//system/core/init/property_service.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="kt">void</span> <span class="nf">PropertyInit</span><span class="p">()</span> <span class="p">{</span>
<span class="ln"> 3</span>    <span class="c1">//SElinux初始化配置，这个不是很重要
</span><span class="ln"> 4</span><span class="c1"></span>    <span class="n">selinux_callback</span> <span class="n">cb</span><span class="p">;</span>
<span class="ln"> 5</span>    <span class="n">cb</span><span class="p">.</span><span class="n">func_audit</span> <span class="o">=</span> <span class="n">PropertyAuditCallback</span><span class="p">;</span>
<span class="ln"> 6</span>    <span class="n">selinux_set_callback</span><span class="p">(</span><span class="n">SELINUX_CB_AUDIT</span><span class="p">,</span> <span class="n">cb</span><span class="p">);</span>
<span class="ln"> 7</span>	<span class="c1">//1.创建属性文件，用于序列化操作
</span><span class="ln"> 8</span><span class="c1"></span>    <span class="n">mkdir</span><span class="p">(</span><span class="s">&#34;/dev/__properties__&#34;</span><span class="p">,</span> <span class="n">S_IRWXU</span> <span class="o">|</span> <span class="n">S_IXGRP</span> <span class="o">|</span> <span class="n">S_IXOTH</span><span class="p">);</span>
<span class="ln"> 9</span>    <span class="n">CreateSerializedPropertyInfo</span><span class="p">();</span>
<span class="ln">10</span>    <span class="c1">//2.初始化属性域
</span><span class="ln">11</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">__system_property_area_init</span><span class="p">())</span> <span class="p">{</span>
<span class="ln">12</span>        <span class="n">LOG</span><span class="p">(</span><span class="n">FATAL</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Failed to initialize property area&#34;</span><span class="p">;</span>
<span class="ln">13</span>    <span class="p">}</span>
<span class="ln">14</span>    <span class="c1">//3.属性域的文件导入
</span><span class="ln">15</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">property_info_area</span><span class="p">.</span><span class="n">LoadDefaultPath</span><span class="p">())</span> <span class="p">{</span>
<span class="ln">16</span>        <span class="n">LOG</span><span class="p">(</span><span class="n">FATAL</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Failed to load serialized property info file&#34;</span><span class="p">;</span>
<span class="ln">17</span>    <span class="p">}</span>
<span class="ln">18</span>	<span class="c1">//4.其他的属性初始化
</span><span class="ln">19</span><span class="c1"></span>    <span class="n">ProcessKernelDt</span><span class="p">();</span>
<span class="ln">20</span>    <span class="n">ProcessKernelCmdline</span><span class="p">();</span>
<span class="ln">21</span>
<span class="ln">22</span>    <span class="n">ExportKernelBootProps</span><span class="p">();</span>
<span class="ln">23</span>    <span class="n">PropertyLoadBootDefaults</span><span class="p">();</span>
<span class="ln">24</span><span class="p">}</span>
<span class="ln">25</span>
</code></pre></div><h3 id="11创建属性文件用于序列化操作">1.1创建属性文件，用于序列化操作</h3>
<p>首先在设备中创建<code>/dev/__properties</code>__，这个目录后续会对其进行<strong>序列化</strong>。</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//system/core/init/property_service.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="kt">void</span> <span class="nf">CreateSerializedPropertyInfo</span><span class="p">()</span> <span class="p">{</span>
<span class="ln"> 3</span>    <span class="k">auto</span> <span class="n">property_infos</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">PropertyInfoEntry</span><span class="o">&gt;</span><span class="p">();</span>
<span class="ln"> 4</span>    <span class="k">if</span> <span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="s">&#34;/system/etc/selinux/plat_property_contexts&#34;</span><span class="p">,</span> <span class="n">R_OK</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 5</span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">LoadPropertyInfoFromFile</span><span class="p">(</span><span class="s">&#34;/system/etc/selinux/plat_property_contexts&#34;</span><span class="p">,</span>
<span class="ln"> 6</span>                                      <span class="o">&amp;</span><span class="n">property_infos</span><span class="p">))</span> <span class="p">{</span>
<span class="ln"> 7</span>            <span class="k">return</span><span class="p">;</span>
<span class="ln"> 8</span>        <span class="p">}</span>
<span class="ln"> 9</span>        <span class="c1">// Don&#39;t check for failure here, so we always have a sane list of properties.
</span><span class="ln">10</span><span class="c1"></span>        <span class="c1">// E.g. In case of recovery, the vendor partition will not have mounted and we
</span><span class="ln">11</span><span class="c1"></span>        <span class="c1">// still need the system / platform properties to function.
</span><span class="ln">12</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="s">&#34;/system_ext/etc/selinux/system_ext_property_contexts&#34;</span><span class="p">,</span> <span class="n">R_OK</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">13</span>            <span class="n">LoadPropertyInfoFromFile</span><span class="p">(</span><span class="s">&#34;/system_ext/etc/selinux/system_ext_property_contexts&#34;</span><span class="p">,</span>
<span class="ln">14</span>                                     <span class="o">&amp;</span><span class="n">property_infos</span><span class="p">);</span>
<span class="ln">15</span>        <span class="p">}</span>
<span class="ln">16</span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">LoadPropertyInfoFromFile</span><span class="p">(</span><span class="s">&#34;/vendor/etc/selinux/vendor_property_contexts&#34;</span><span class="p">,</span>
<span class="ln">17</span>                                      <span class="o">&amp;</span><span class="n">property_infos</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">18</span>            <span class="c1">// Fallback to nonplat_* if vendor_* doesn&#39;t exist.
</span><span class="ln">19</span><span class="c1"></span>            <span class="n">LoadPropertyInfoFromFile</span><span class="p">(</span><span class="s">&#34;/vendor/etc/selinux/nonplat_property_contexts&#34;</span><span class="p">,</span>
<span class="ln">20</span>                                     <span class="o">&amp;</span><span class="n">property_infos</span><span class="p">);</span>
<span class="ln">21</span>        <span class="p">}</span>
<span class="ln">22</span>        <span class="k">if</span> <span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="s">&#34;/product/etc/selinux/product_property_contexts&#34;</span><span class="p">,</span> <span class="n">R_OK</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">23</span>            <span class="n">LoadPropertyInfoFromFile</span><span class="p">(</span><span class="s">&#34;/product/etc/selinux/product_property_contexts&#34;</span><span class="p">,</span>
<span class="ln">24</span>                                     <span class="o">&amp;</span><span class="n">property_infos</span><span class="p">);</span>
<span class="ln">25</span>        <span class="p">}</span>
<span class="ln">26</span>        <span class="k">if</span> <span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="s">&#34;/odm/etc/selinux/odm_property_contexts&#34;</span><span class="p">,</span> <span class="n">R_OK</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">27</span>            <span class="n">LoadPropertyInfoFromFile</span><span class="p">(</span><span class="s">&#34;/odm/etc/selinux/odm_property_contexts&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">property_infos</span><span class="p">);</span>
<span class="ln">28</span>        <span class="p">}</span>
<span class="ln">29</span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="ln">30</span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">LoadPropertyInfoFromFile</span><span class="p">(</span><span class="s">&#34;/plat_property_contexts&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">property_infos</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">31</span>            <span class="k">return</span><span class="p">;</span>
<span class="ln">32</span>        <span class="p">}</span>
<span class="ln">33</span>        <span class="n">LoadPropertyInfoFromFile</span><span class="p">(</span><span class="s">&#34;/system_ext_property_contexts&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">property_infos</span><span class="p">);</span>
<span class="ln">34</span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">LoadPropertyInfoFromFile</span><span class="p">(</span><span class="s">&#34;/vendor_property_contexts&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">property_infos</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">35</span>            <span class="c1">// Fallback to nonplat_* if vendor_* doesn&#39;t exist.
</span><span class="ln">36</span><span class="c1"></span>            <span class="n">LoadPropertyInfoFromFile</span><span class="p">(</span><span class="s">&#34;/nonplat_property_contexts&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">property_infos</span><span class="p">);</span>
<span class="ln">37</span>        <span class="p">}</span>
<span class="ln">38</span>        <span class="n">LoadPropertyInfoFromFile</span><span class="p">(</span><span class="s">&#34;/product_property_contexts&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">property_infos</span><span class="p">);</span>
<span class="ln">39</span>        <span class="n">LoadPropertyInfoFromFile</span><span class="p">(</span><span class="s">&#34;/odm_property_contexts&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">property_infos</span><span class="p">);</span>
<span class="ln">40</span>    <span class="p">}</span>
<span class="ln">41</span>
<span class="ln">42</span>    <span class="k">auto</span> <span class="n">serialized_contexts</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">();</span>
<span class="ln">43</span>    <span class="k">auto</span> <span class="n">error</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">();</span>
<span class="ln">44</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">BuildTrie</span><span class="p">(</span><span class="n">property_infos</span><span class="p">,</span> <span class="s">&#34;u:object_r:default_prop:s0&#34;</span><span class="p">,</span> <span class="s">&#34;string&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">serialized_contexts</span><span class="p">,</span>
<span class="ln">45</span>                   <span class="o">&amp;</span><span class="n">error</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">46</span>        <span class="n">LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Unable to serialize property contexts: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">error</span><span class="p">;</span>
<span class="ln">47</span>        <span class="k">return</span><span class="p">;</span>
<span class="ln">48</span>    <span class="p">}</span>
<span class="ln">49</span>
<span class="ln">50</span>    <span class="k">constexpr</span> <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">kPropertyInfosPath</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&#34;/dev/__properties__/property_info&#34;</span><span class="p">;</span>
<span class="ln">51</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">WriteStringToFile</span><span class="p">(</span><span class="n">serialized_contexts</span><span class="p">,</span> <span class="n">kPropertyInfosPath</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">52</span>        <span class="n">PLOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Unable to write serialized property infos to file&#34;</span><span class="p">;</span>
<span class="ln">53</span>    <span class="p">}</span>
<span class="ln">54</span>    <span class="n">selinux_android_restorecon</span><span class="p">(</span><span class="n">kPropertyInfosPath</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="ln">55</span><span class="p">}</span>
</code></pre></div><p>这里的逻辑分成两块，第一块是<code>LoadPropertyInfoFromFile</code>用于将对应文件中的词条一条条导入到<code>property_infos</code>的数组中。</p>
<p>第二块是将上述的数组通过字典树的方式以二进制序列化的形式存储在变量<code>serialized_contexts</code>中，最后变成文件的形式存到<code>/dev/__properties__/property_info</code>里面。</p>
<h3 id="111loadpropertyinfofromfile">1.1.1LoadPropertyInfoFromFile</h3>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//system/core/init/property_service.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="kt">bool</span> <span class="nf">LoadPropertyInfoFromFile</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">filename</span><span class="p">,</span>
<span class="ln"> 3</span>                              <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">PropertyInfoEntry</span><span class="o">&gt;*</span> <span class="n">property_infos</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 4</span>    <span class="k">auto</span> <span class="n">file_contents</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">();</span>
<span class="ln"> 5</span>    <span class="c1">//将文件内容转化成字符串形式，导入到file_contents中
</span><span class="ln"> 6</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ReadFileToString</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">file_contents</span><span class="p">))</span> <span class="p">{</span>
<span class="ln"> 7</span>        <span class="n">PLOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Could not read properties from &#39;&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">filename</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;&#39;&#34;</span><span class="p">;</span>
<span class="ln"> 8</span>        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="ln"> 9</span>    <span class="p">}</span>
<span class="ln">10</span>
<span class="ln">11</span>    <span class="k">auto</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">{};</span>
<span class="ln">12</span>    <span class="kt">bool</span> <span class="n">require_prefix_or_exact</span> <span class="o">=</span> <span class="n">SelinuxGetVendorAndroidVersion</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">__ANDROID_API_R__</span><span class="p">;</span>
<span class="ln">13</span>    <span class="c1">//将对应的/system/etc/selinux/plat_property_contexts，
</span><span class="ln">14</span><span class="c1"></span>    <span class="c1">///system/etc/selinux/plat_property_contexts等文件
</span><span class="ln">15</span><span class="c1"></span>    <span class="c1">//依次变成字符串的形式去对应解析成PropertyInfoEntry数组的形式
</span><span class="ln">16</span><span class="c1"></span>    <span class="n">ParsePropertyInfoFile</span><span class="p">(</span><span class="n">file_contents</span><span class="p">,</span> <span class="n">require_prefix_or_exact</span><span class="p">,</span> <span class="n">property_infos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">errors</span><span class="p">);</span>
<span class="ln">17</span>    <span class="p">...</span>
<span class="ln">18</span>    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="ln">19</span><span class="p">}</span>
</code></pre></div><p>这里的property_infos类型是<code>vector&lt;PropertyInfoEntry&gt;*</code>，这个类似于函数运行结束的返回值写法，并且传入到ParsePropertyInfoFile函数中，是在这个函数中获取这个数组的。</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//system/core/property_service/libpropertyinfoserializer/property_info_file.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="kt">void</span> <span class="nf">ParsePropertyInfoFile</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">file_contents</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">require_prefix_or_exact</span><span class="p">,</span>
<span class="ln"> 3</span>                           <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">PropertyInfoEntry</span><span class="o">&gt;*</span> <span class="n">property_infos</span><span class="p">,</span>
<span class="ln"> 4</span>                           <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;*</span> <span class="n">errors</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 5</span>  <span class="n">errors</span><span class="o">-&gt;</span><span class="n">clear</span><span class="p">();</span>
<span class="ln"> 6</span>  <span class="c1">//将对应文件中的&#34;\n&#34;来分割文件内容，即按照行来分割文件内容，注释和空白行自动过滤掉
</span><span class="ln"> 7</span><span class="c1"></span>  <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">line</span> <span class="p">:</span> <span class="n">Split</span><span class="p">(</span><span class="n">file_contents</span><span class="p">,</span> <span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">))</span> <span class="p">{</span>
<span class="ln"> 8</span>    <span class="k">auto</span> <span class="n">trimmed_line</span> <span class="o">=</span> <span class="n">Trim</span><span class="p">(</span><span class="n">line</span><span class="p">);</span>
<span class="ln"> 9</span>    <span class="k">if</span> <span class="p">(</span><span class="n">trimmed_line</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">||</span> <span class="n">StartsWith</span><span class="p">(</span><span class="n">trimmed_line</span><span class="p">,</span> <span class="s">&#34;#&#34;</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">10</span>      <span class="k">continue</span><span class="p">;</span>
<span class="ln">11</span>    <span class="p">}</span>
<span class="ln">12</span>
<span class="ln">13</span>    <span class="k">auto</span> <span class="n">property_info_entry</span> <span class="o">=</span> <span class="n">PropertyInfoEntry</span><span class="p">{};</span>
<span class="ln">14</span>    <span class="k">auto</span> <span class="n">parse_error</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">{};</span>
<span class="ln">15</span>    <span class="c1">//最终通过行解析得到具体的数组值，一个PropertyInfoEntry类型的实例
</span><span class="ln">16</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ParsePropertyInfoLine</span><span class="p">(</span><span class="n">trimmed_line</span><span class="p">,</span> <span class="n">require_prefix_or_exact</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">property_info_entry</span><span class="p">,</span>
<span class="ln">17</span>                               <span class="o">&amp;</span><span class="n">parse_error</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">18</span>      <span class="n">errors</span><span class="o">-&gt;</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">parse_error</span><span class="p">);</span>
<span class="ln">19</span>      <span class="k">continue</span><span class="p">;</span>
<span class="ln">20</span>    <span class="p">}</span>
<span class="ln">21</span>
<span class="ln">22</span>    <span class="n">property_infos</span><span class="o">-&gt;</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">property_info_entry</span><span class="p">);</span>
<span class="ln">23</span>  <span class="p">}</span>
<span class="ln">24</span><span class="p">}</span>
</code></pre></div><p><code>ParsePropertyInfoLine</code></p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="kt">bool</span> <span class="nf">ParsePropertyInfoLine</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">line</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">require_prefix_or_exact</span><span class="p">,</span>
<span class="ln"> 2</span>                           <span class="n">PropertyInfoEntry</span><span class="o">*</span> <span class="n">out</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">*</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 3</span>  <span class="c1">//去除一行首部和尾部中的空格  
</span><span class="ln"> 4</span><span class="c1"></span>  <span class="k">auto</span> <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">SpaceTokenizer</span><span class="p">(</span><span class="n">line</span><span class="p">);</span>
<span class="ln"> 5</span>  <span class="c1">//获取第一列数据，为property的name（string类型）
</span><span class="ln"> 6</span><span class="c1"></span>  <span class="k">auto</span> <span class="n">property</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="p">.</span><span class="n">GetNext</span><span class="p">();</span>
<span class="ln"> 7</span>  <span class="p">...</span>
<span class="ln"> 8</span>  <span class="c1">//获取第二列数据，为SElinux的context（string类型）
</span><span class="ln"> 9</span><span class="c1"></span>  <span class="k">auto</span> <span class="n">context</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="p">.</span><span class="n">GetNext</span><span class="p">();</span>
<span class="ln">10</span>  <span class="p">...</span>
<span class="ln">11</span>  <span class="c1">//获取第三列数据，为exact/prefix/...参数
</span><span class="ln">12</span><span class="c1"></span>  <span class="k">auto</span> <span class="n">match_operation</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="p">.</span><span class="n">GetNext</span><span class="p">();</span>
<span class="ln">13</span>  <span class="k">auto</span> <span class="n">type_strings</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">{};</span>
<span class="ln">14</span>  <span class="c1">//获取第四列的数据类型，string/bool/int/uint/double/size/enum(定义在property_type.cpp中)
</span><span class="ln">15</span><span class="c1"></span>  <span class="k">auto</span> <span class="n">type</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="p">.</span><span class="n">GetNext</span><span class="p">();</span>
<span class="ln">16</span>  <span class="c1">//这里就是为了获取enum类型存在的
</span><span class="ln">17</span><span class="c1"></span>  <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">type</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
<span class="ln">18</span>    <span class="n">type_strings</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>
<span class="ln">19</span>    <span class="n">type</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="p">.</span><span class="n">GetNext</span><span class="p">();</span>
<span class="ln">20</span>  <span class="p">}</span>
<span class="ln">21</span>
<span class="ln">22</span>  <span class="kt">bool</span> <span class="n">exact_match</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="ln">23</span>  <span class="k">if</span> <span class="p">(</span><span class="n">match_operation</span> <span class="o">==</span> <span class="s">&#34;exact&#34;</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">24</span>    <span class="n">exact_match</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="ln">25</span>  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">match_operation</span> <span class="o">!=</span> <span class="s">&#34;prefix&#34;</span> <span class="o">&amp;&amp;</span> <span class="n">match_operation</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="o">&amp;&amp;</span> <span class="n">require_prefix_or_exact</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">26</span>    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="ln">27</span>  <span class="p">}</span>
<span class="ln">28</span>  <span class="p">...</span>
<span class="ln">29</span>  <span class="o">*</span><span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="n">property</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">Join</span><span class="p">(</span><span class="n">type_strings</span><span class="p">,</span> <span class="s">&#34; &#34;</span><span class="p">),</span> <span class="n">exact_match</span><span class="p">};</span>
<span class="ln">30</span>  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="ln">31</span><span class="p">}</span>
</code></pre></div><p>比如设备中的<code>/system/etc/selinux/plat_property_contexts</code>文件</p>
<div class="highlight"><pre class="chroma"><code class="language-txt" data-lang="txt"><span class="ln"> 1</span>#截取部分内容
<span class="ln"> 2</span>bluetooth.              u:object_r:bluetooth_prop:s0
<span class="ln"> 3</span>config.                 u:object_r:config_prop:s0
<span class="ln"> 4</span>ctl.bootanim            u:object_r:ctl_bootanim_prop:s0
<span class="ln"> 5</span>ctl.bugreport           u:object_r:ctl_bugreport_prop:s0
<span class="ln"> 6</span>...
<span class="ln"> 7</span>ro.boot.dynamic_partitions    u:object_r:exported_default_prop:s0              exact string
<span class="ln"> 8</span>aaudio.hw_burst_min_usec      u:object_r:exported_default_prop:s0              exact string
<span class="ln"> 9</span>ro.boot.hardware.revision     u:object_r:exported_default_prop:s0              exact string
<span class="ln">10</span>ro.surfaceflinger.primary_display_orientation u:object_r:exported_default_prop:s0 exact
<span class="ln">11</span> ORENTATION_0 ORENTATION_180 ORENTATION_270 ORENTATION_90
<span class="ln">12</span>cache_key.bluetooth           u:object_r:binder_cacherbluetooth_server_prop:s0 prefix string
<span class="ln">13</span>graphics_gpu.profiler.support u:object_r:graphics_config_prop:s0               exact bool
<span class="ln">14</span>...
</code></pre></div><p>转化为类似</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//PropertyInfoEntry类型数组
</span><span class="ln"> 2</span><span class="c1"></span><span class="p">...</span>
<span class="ln"> 3</span><span class="p">{</span><span class="n">ro</span><span class="p">.</span><span class="n">boot</span><span class="p">.</span><span class="n">dynamic_partitions</span><span class="p">,</span>   <span class="nl">u</span><span class="p">:</span><span class="nl">object_r</span><span class="p">:</span><span class="nl">exported_default_prop</span><span class="p">:</span><span class="n">s0</span><span class="p">,</span>              <span class="n">string</span><span class="p">,</span> <span class="nb">true</span><span class="p">},</span>
<span class="ln"> 4</span><span class="p">{</span><span class="n">aaudio</span><span class="p">.</span><span class="n">hw_burst_min_usec</span><span class="p">,</span>     <span class="nl">u</span><span class="p">:</span><span class="nl">object_r</span><span class="p">:</span><span class="nl">exported_default_prop</span><span class="p">:</span><span class="n">s0</span><span class="p">,</span>              <span class="n">string</span><span class="p">,</span> <span class="nb">true</span><span class="p">},</span>
<span class="ln"> 5</span><span class="p">{</span><span class="n">ro</span><span class="p">.</span><span class="n">boot</span><span class="p">.</span><span class="n">hardware</span><span class="p">.</span><span class="n">revision</span><span class="p">,</span>    <span class="nl">u</span><span class="p">:</span><span class="nl">object_r</span><span class="p">:</span><span class="nl">exported_default_prop</span><span class="p">:</span><span class="n">s0</span><span class="p">,</span>              <span class="n">string</span><span class="p">,</span> <span class="nb">true</span><span class="p">},</span>
<span class="ln"> 6</span><span class="p">{</span><span class="n">ro</span><span class="p">.</span><span class="n">surfaceflinger</span><span class="p">.</span><span class="n">primary_display_orientation</span><span class="p">,</span> <span class="nl">u</span><span class="p">:</span><span class="nl">object_r</span><span class="p">:</span><span class="nl">exported_default_prop</span><span class="p">:</span><span class="n">s0</span><span class="p">,</span> 
<span class="ln"> 7</span> <span class="p">{</span><span class="n">ORENTATION_0</span><span class="p">,</span> <span class="n">ORENTATION_180</span><span class="p">,</span> <span class="n">ORENTATION_270</span><span class="p">,</span> <span class="n">ORENTATION_90</span><span class="p">},</span> <span class="nb">true</span><span class="p">},</span>
<span class="ln"> 8</span><span class="p">{</span><span class="n">cache_key</span><span class="p">.</span><span class="n">bluetooth</span><span class="p">,</span>          <span class="nl">u</span><span class="p">:</span><span class="nl">object_r</span><span class="p">:</span><span class="nl">binder_cacherbluetooth_server_prop</span><span class="p">:</span><span class="n">s0</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="nb">false</span><span class="p">},</span>
<span class="ln"> 9</span><span class="p">{</span><span class="n">graphics_gpu</span><span class="p">.</span><span class="n">profiler</span><span class="p">.</span><span class="n">support</span><span class="p">,</span><span class="nl">u</span><span class="p">:</span><span class="nl">object_r</span><span class="p">:</span><span class="nl">graphics_config_prop</span><span class="p">:</span><span class="n">s0</span><span class="p">,</span>               <span class="kt">bool</span><span class="p">,</span>   <span class="nb">true</span><span class="p">},</span>
<span class="ln">10</span><span class="p">...</span>
</code></pre></div>

 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/property/property_4.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/property/property_4.png" >
  
    </a>
  
  
</div>

<h3 id="112buildtrie">1.1.2BuildTrie</h3>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//system/core/property_service/libpropertyinfoserializer/property_info_serializer.cpp
</span><span class="ln"> 2</span><span class="c1">//构建字典树，并且序列化
</span><span class="ln"> 3</span><span class="c1"></span><span class="kt">bool</span> <span class="nf">BuildTrie</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">PropertyInfoEntry</span><span class="o">&gt;&amp;</span> <span class="n">property_info</span><span class="p">,</span>
<span class="ln"> 4</span>               <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">default_context</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">default_type</span><span class="p">,</span>
<span class="ln"> 5</span>               <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">*</span> <span class="n">serialized_trie</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">*</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 6</span>  <span class="c1">// Check that names are legal first
</span><span class="ln"> 7</span><span class="c1"></span>  <span class="k">auto</span> <span class="n">trie_builder</span> <span class="o">=</span> <span class="n">TrieBuilder</span><span class="p">(</span><span class="n">default_context</span><span class="p">,</span> <span class="n">default_type</span><span class="p">);</span>
<span class="ln"> 8</span>
<span class="ln"> 9</span>  <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="p">[</span><span class="n">name</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">is_exact</span><span class="p">]</span> <span class="o">:</span> <span class="n">property_info</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">10</span>    <span class="c1">//生成字典树
</span><span class="ln">11</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">trie_builder</span><span class="p">.</span><span class="n">AddToTrie</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">is_exact</span><span class="p">,</span> <span class="n">error</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">12</span>      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="ln">13</span>    <span class="p">}</span>
<span class="ln">14</span>  <span class="p">}</span>
<span class="ln">15</span>  <span class="c1">//实例化字典树序列器
</span><span class="ln">16</span><span class="c1"></span>  <span class="k">auto</span> <span class="n">trie_serializer</span> <span class="o">=</span> <span class="n">TrieSerializer</span><span class="p">();</span>
<span class="ln">17</span>  <span class="c1">//字典树序列化
</span><span class="ln">18</span><span class="c1"></span>  <span class="o">*</span><span class="n">serialized_trie</span> <span class="o">=</span> <span class="n">trie_serializer</span><span class="p">.</span><span class="n">SerializeTrie</span><span class="p">(</span><span class="n">trie_builder</span><span class="p">);</span>
<span class="ln">19</span>  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="ln">20</span><span class="p">}</span>
</code></pre></div><p>显然，这边主要是一个装饰着模式的应用，主要的实现还在其他地方，这个函数主要作用就是用于把之前导入的属性构建成字典树然后将其序列化成字符串的形式，最终会调到<code>CreateSerializedPropertyInfo</code>函数，变成一个序列化的文件<code>/dev/__properties__/property_info</code></p>
<h4 id="1121triebuilder">1.1.2.1TrieBuilder</h4>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln">1</span><span class="c1">//system/core/property_service/libpropertyinfoserializer/trie_builder.cpp
</span><span class="ln">2</span><span class="c1"></span><span class="n">TrieBuilder</span><span class="o">::</span><span class="n">TrieBuilder</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">default_context</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">default_type</span><span class="p">)</span>
<span class="ln">3</span>    <span class="o">:</span> <span class="n">builder_root_</span><span class="p">(</span><span class="s">&#34;root&#34;</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">4</span>  <span class="k">auto</span><span class="o">*</span> <span class="n">context_pointer</span> <span class="o">=</span> <span class="n">StringPointerFromContainer</span><span class="p">(</span><span class="n">default_context</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">contexts_</span><span class="p">);</span>
<span class="ln">5</span>  <span class="n">builder_root_</span><span class="p">.</span><span class="n">set_context</span><span class="p">(</span><span class="n">context_pointer</span><span class="p">);</span>
<span class="ln">6</span>  <span class="k">auto</span><span class="o">*</span> <span class="n">type_pointer</span> <span class="o">=</span> <span class="n">StringPointerFromContainer</span><span class="p">(</span><span class="n">default_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">types_</span><span class="p">);</span>
<span class="ln">7</span>  <span class="n">builder_root_</span><span class="p">.</span><span class="n">set_type</span><span class="p">(</span><span class="n">type_pointer</span><span class="p">);</span>
<span class="ln">8</span><span class="p">}</span>
</code></pre></div><p>如下图所示，是字典树的数据结构，简化后如右图所示，只显示<code>TrieBuilder</code>构造完成后对应的关系的数据结构图</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/property/property_5.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/property/property_5.png" >
  
    </a>
  
  
</div>

<h4 id="1122addtotrie">1.1.2.2AddToTrie</h4>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//system/core/property_service/libpropertyinfoserializer/trie_builder.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="kt">bool</span> <span class="n">TrieBuilder</span><span class="o">::</span><span class="n">AddToTrie</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">context</span><span class="p">,</span>
<span class="ln"> 3</span>                            <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">type</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">exact</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">*</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 4</span>  <span class="k">auto</span><span class="o">*</span> <span class="n">context_pointer</span> <span class="o">=</span> <span class="n">StringPointerFromContainer</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">contexts_</span><span class="p">);</span>
<span class="ln"> 5</span>  <span class="k">auto</span><span class="o">*</span> <span class="n">type_pointer</span> <span class="o">=</span> <span class="n">StringPointerFromContainer</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">types_</span><span class="p">);</span>
<span class="ln"> 6</span>  <span class="k">return</span> <span class="nf">AddToTrie</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">context_pointer</span><span class="p">,</span> <span class="n">type_pointer</span><span class="p">,</span> <span class="n">exact</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
<span class="ln"> 7</span><span class="p">}</span>
<span class="ln"> 8</span>
<span class="ln"> 9</span><span class="kt">bool</span> <span class="n">TrieBuilder</span><span class="o">::</span><span class="n">AddToTrie</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">*</span> <span class="n">context</span><span class="p">,</span>
<span class="ln">10</span>                            <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">*</span> <span class="n">type</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">exact</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">*</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">11</span>  <span class="c1">//找到根结点，就是TrieBuilder构造完成的结点
</span><span class="ln">12</span><span class="c1"></span>  <span class="n">TrieBuilderNode</span><span class="o">*</span> <span class="n">current_node</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">builder_root_</span><span class="p">;</span>
<span class="ln">13</span>  <span class="c1">//通过属性name的点来划分属性名字，分成几段	
</span><span class="ln">14</span><span class="c1"></span>  <span class="k">auto</span> <span class="n">name_pieces</span> <span class="o">=</span> <span class="n">Split</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&#34;.&#34;</span><span class="p">);</span>
<span class="ln">15</span>
<span class="ln">16</span>  <span class="kt">bool</span> <span class="n">ends_with_dot</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="ln">17</span>  <span class="k">if</span> <span class="p">(</span><span class="n">name_pieces</span><span class="p">.</span><span class="n">back</span><span class="p">().</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
<span class="ln">18</span>    <span class="n">ends_with_dot</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="ln">19</span>    <span class="n">name_pieces</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span>
<span class="ln">20</span>  <span class="p">}</span>
<span class="ln">21</span>
<span class="ln">22</span>  <span class="c1">// Move us to the final node that we care about, adding incremental nodes if necessary.
</span><span class="ln">23</span><span class="c1"></span>  <span class="k">while</span> <span class="p">(</span><span class="n">name_pieces</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">24</span>    <span class="c1">//按照排列寻找对应的结点的每一段在字典树中查找（不排序）  
</span><span class="ln">25</span><span class="c1"></span>    <span class="k">auto</span> <span class="n">child</span> <span class="o">=</span> <span class="n">current_node</span><span class="o">-&gt;</span><span class="n">FindChild</span><span class="p">(</span><span class="n">name_pieces</span><span class="p">.</span><span class="n">front</span><span class="p">());</span>
<span class="ln">26</span>    <span class="k">if</span> <span class="p">(</span><span class="n">child</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">27</span>      <span class="c1">//找不到字典树对应的结点，就新增一个结点（数组中添加）  
</span><span class="ln">28</span><span class="c1"></span>      <span class="n">child</span> <span class="o">=</span> <span class="n">current_node</span><span class="o">-&gt;</span><span class="n">AddChild</span><span class="p">(</span><span class="n">name_pieces</span><span class="p">.</span><span class="n">front</span><span class="p">());</span>
<span class="ln">29</span>    <span class="p">}</span>
<span class="ln">30</span>    <span class="k">if</span> <span class="p">(</span><span class="n">child</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">31</span>      <span class="o">*</span><span class="n">error</span> <span class="o">=</span> <span class="s">&#34;Unable to allocate Trie node&#34;</span><span class="p">;</span>
<span class="ln">32</span>      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="ln">33</span>    <span class="p">}</span>
<span class="ln">34</span>    <span class="n">current_node</span> <span class="o">=</span> <span class="n">child</span><span class="p">;</span>
<span class="ln">35</span>    <span class="n">name_pieces</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">name_pieces</span><span class="p">.</span><span class="n">begin</span><span class="p">());</span>
<span class="ln">36</span>  <span class="p">}</span>
<span class="ln">37</span>
<span class="ln">38</span>  <span class="c1">//传入到这里代表着属性name点的最后一段，根据传入的exact参数值判断是否是exact类型或者是prefix类型来添加对应的结点
</span><span class="ln">39</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">exact</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">40</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">current_node</span><span class="o">-&gt;</span><span class="n">AddExactMatchContext</span><span class="p">(</span><span class="n">name_pieces</span><span class="p">.</span><span class="n">front</span><span class="p">(),</span> <span class="n">context</span><span class="p">,</span> <span class="n">type</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">41</span>      <span class="o">*</span><span class="n">error</span> <span class="o">=</span> <span class="s">&#34;Duplicate exact match detected for &#39;&#34;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&#34;&#39;&#34;</span><span class="p">;</span>
<span class="ln">42</span>      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="ln">43</span>    <span class="p">}</span>
<span class="ln">44</span>  <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ends_with_dot</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">45</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">current_node</span><span class="o">-&gt;</span><span class="n">AddPrefixContext</span><span class="p">(</span><span class="n">name_pieces</span><span class="p">.</span><span class="n">front</span><span class="p">(),</span> <span class="n">context</span><span class="p">,</span> <span class="n">type</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">46</span>      <span class="o">*</span><span class="n">error</span> <span class="o">=</span> <span class="s">&#34;Duplicate prefix match detected for &#39;&#34;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&#34;&#39;&#34;</span><span class="p">;</span>
<span class="ln">47</span>      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="ln">48</span>    <span class="p">}</span>
<span class="ln">49</span>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="ln">50</span>    <span class="k">auto</span> <span class="n">child</span> <span class="o">=</span> <span class="n">current_node</span><span class="o">-&gt;</span><span class="n">FindChild</span><span class="p">(</span><span class="n">name_pieces</span><span class="p">.</span><span class="n">front</span><span class="p">());</span>
<span class="ln">51</span>    <span class="k">if</span> <span class="p">(</span><span class="n">child</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">52</span>      <span class="n">child</span> <span class="o">=</span> <span class="n">current_node</span><span class="o">-&gt;</span><span class="n">AddChild</span><span class="p">(</span><span class="n">name_pieces</span><span class="p">.</span><span class="n">front</span><span class="p">());</span>
<span class="ln">53</span>    <span class="p">}</span>
<span class="ln">54</span>    <span class="k">if</span> <span class="p">(</span><span class="n">child</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">55</span>      <span class="o">*</span><span class="n">error</span> <span class="o">=</span> <span class="s">&#34;Unable to allocate Trie node&#34;</span><span class="p">;</span>
<span class="ln">56</span>      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="ln">57</span>    <span class="p">}</span>
<span class="ln">58</span>    <span class="k">if</span> <span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">()</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="o">||</span> <span class="n">child</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">()</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">59</span>      <span class="o">*</span><span class="n">error</span> <span class="o">=</span> <span class="s">&#34;Duplicate prefix match detected for &#39;&#34;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&#34;&#39;&#34;</span><span class="p">;</span>
<span class="ln">60</span>      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="ln">61</span>    <span class="p">}</span>
<span class="ln">62</span>    <span class="n">child</span><span class="o">-&gt;</span><span class="n">set_context</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
<span class="ln">63</span>    <span class="n">child</span><span class="o">-&gt;</span><span class="n">set_type</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>
<span class="ln">64</span>  <span class="p">}</span>
<span class="ln">65</span>  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="ln">66</span><span class="p">}</span>
</code></pre></div><p>真正开始添加成为一棵树，并开始添加子节点，以1.1.1中的<code>PropertyInfoEntry</code>类型数组为例说明</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/property/property_6.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/property/property_6.png" >
  
    </a>
  
  
</div>

<h4 id="1123serializetrie">1.1.2.3SerializeTrie</h4>
<div class="highlight"><pre class="chroma"><code class="language-C++" data-lang="C++"><span class="ln"> 1</span><span class="c1">//system/core/property_service/libpropertyinfoserializer/trie_serializer.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">TrieSerializer</span><span class="o">::</span><span class="n">SerializeTrie</span><span class="p">(</span><span class="k">const</span> <span class="n">TrieBuilder</span><span class="o">&amp;</span> <span class="n">trie_builder</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 3</span>  <span class="n">arena_</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span> <span class="n">TrieNodeArena</span><span class="p">());</span>
<span class="ln"> 4</span>  <span class="c1">//arena_指针是TrieNodeArena类型的，也就是这里的arena_所指的data_的头部为PropertyInfoAreaHeader类型
</span><span class="ln"> 5</span><span class="c1"></span>  <span class="c1">//PropertyInfoAreaHeader类型是为了记录TrieBuilder中各个元素距离data_指针的偏移
</span><span class="ln"> 6</span><span class="c1"></span>  <span class="k">auto</span> <span class="n">header</span> <span class="o">=</span> <span class="n">arena_</span><span class="o">-&gt;</span><span class="n">AllocateObject</span><span class="o">&lt;</span><span class="n">PropertyInfoAreaHeader</span><span class="o">&gt;</span><span class="p">(</span><span class="k">nullptr</span><span class="p">);</span>
<span class="ln"> 7</span>  <span class="n">header</span><span class="o">-&gt;</span><span class="n">current_version</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="ln"> 8</span>  <span class="n">header</span><span class="o">-&gt;</span><span class="n">minimum_supported_version</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="ln"> 9</span>  <span class="c1">//开始存储TrieBuilder数据结构中的contexts_,并记录当前的位置，这个位置是与data_指针相差的距离
</span><span class="ln">10</span><span class="c1"></span>  <span class="n">header</span><span class="o">-&gt;</span><span class="n">contexts_offset</span> <span class="o">=</span> <span class="n">arena_</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span>
<span class="ln">11</span>  <span class="n">SerializeStrings</span><span class="p">(</span><span class="n">trie_builder</span><span class="p">.</span><span class="n">contexts</span><span class="p">());</span>
<span class="ln">12</span>  <span class="c1">//开始存储TrieBuilder数据结构中的types_,并记录当前的位置，这个位置是与data_指针相差的距离
</span><span class="ln">13</span><span class="c1"></span>  <span class="n">header</span><span class="o">-&gt;</span><span class="n">types_offset</span> <span class="o">=</span> <span class="n">arena_</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span>
<span class="ln">14</span>  <span class="n">SerializeStrings</span><span class="p">(</span><span class="n">trie_builder</span><span class="p">.</span><span class="n">types</span><span class="p">());</span>
<span class="ln">15</span>  <span class="c1">//记录types_之后的位置，主要是用于TrieBuilderNode序列化的寻址
</span><span class="ln">16</span><span class="c1"></span>  <span class="n">header</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">arena_</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span>
<span class="ln">17</span>  <span class="c1">//开始对TrieBuilderNode这个数据结构图进行序列化
</span><span class="ln">18</span><span class="c1"></span>  <span class="kt">uint32_t</span> <span class="n">root_trie_offset</span> <span class="o">=</span> <span class="n">WriteTrieNode</span><span class="p">(</span><span class="n">trie_builder</span><span class="p">.</span><span class="n">builder_root</span><span class="p">());</span>
<span class="ln">19</span>  <span class="c1">//root_offset记录的是TrieNodeInternal类型和data_指针的偏移地址
</span><span class="ln">20</span><span class="c1"></span>  <span class="n">header</span><span class="o">-&gt;</span><span class="n">root_offset</span> <span class="o">=</span> <span class="n">root_trie_offset</span><span class="p">;</span>
<span class="ln">21</span>  <span class="c1">//最终记录TrieBuilderNode的与data_指针的偏移地址
</span><span class="ln">22</span><span class="c1"></span>  <span class="n">header</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">arena_</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span>
<span class="ln">23</span>  <span class="c1">//截断多余的空间，使得data_使用空间大小和current_data_point_相等
</span><span class="ln">24</span><span class="c1"></span>  <span class="k">return</span> <span class="n">arena_</span><span class="o">-&gt;</span><span class="n">truncated_data</span><span class="p">();</span>
<span class="ln">25</span><span class="p">}</span>
</code></pre></div><p>关于<code>arena_</code>，<code>TrieNodeArena</code>等定义都在下面的头文件中，这个头文件比较重要，包含了<strong>如何序列化的一些函数</strong></p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/property/property_7.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/property/property_7.png" >
  
    </a>
  
  
</div>

<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//system/core/property_service/libpropertyinfoserializer/trie_node_arena.h
</span><span class="ln"> 2</span><span class="c1"></span><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="ln"> 3</span><span class="k">class</span> <span class="nc">ArenaObjectPointer</span> <span class="p">{</span>
<span class="ln"> 4</span>    <span class="k">public</span><span class="o">:</span>
<span class="ln"> 5</span>    <span class="n">ArenaObjectPointer</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">arena_data</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">offset</span><span class="p">)</span>
<span class="ln"> 6</span>        <span class="o">:</span> <span class="n">arena_data_</span><span class="p">(</span><span class="n">arena_data</span><span class="p">),</span> <span class="n">offset_</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="p">{}</span>
<span class="ln"> 7</span>
<span class="ln"> 8</span>    <span class="n">T</span><span class="o">*</span> <span class="k">operator</span><span class="o">-&gt;</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">T</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">arena_data_</span><span class="p">.</span><span class="n">data</span><span class="p">()</span> <span class="o">+</span> <span class="n">offset_</span><span class="p">);</span> <span class="p">}</span>
<span class="ln"> 9</span>
<span class="ln">10</span>    <span class="k">private</span><span class="o">:</span>
<span class="ln">11</span>    <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">arena_data_</span><span class="p">;</span>
<span class="ln">12</span>    <span class="kt">uint32_t</span> <span class="n">offset_</span><span class="p">;</span>
<span class="ln">13</span><span class="p">};</span>
<span class="ln">14</span>
<span class="ln">15</span><span class="k">class</span> <span class="nc">TrieNodeArena</span> <span class="p">{</span>
<span class="ln">16</span>    <span class="k">public</span><span class="o">:</span>
<span class="ln">17</span>    <span class="n">TrieNodeArena</span><span class="p">()</span> <span class="o">:</span> <span class="n">current_data_pointer_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{}</span>
<span class="ln">18</span>
<span class="ln">19</span>    <span class="c1">// We can&#39;t return pointers to objects since data_ may move when reallocated, thus invalidating
</span><span class="ln">20</span><span class="c1"></span>    <span class="c1">// any pointers.  Therefore we return an ArenaObjectPointer, which always accesses elements via
</span><span class="ln">21</span><span class="c1"></span>    <span class="c1">// data_ + offset.
</span><span class="ln">22</span><span class="c1"></span>    <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="ln">23</span>    <span class="n">ArenaObjectPointer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">AllocateObject</span><span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span> <span class="n">return_offset</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">24</span>        <span class="kt">uint32_t</span> <span class="n">offset</span><span class="p">;</span>
<span class="ln">25</span>        <span class="n">AllocateData</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">T</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">offset</span><span class="p">);</span>
<span class="ln">26</span>        <span class="k">if</span> <span class="p">(</span><span class="n">return_offset</span><span class="p">)</span> <span class="o">*</span><span class="n">return_offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
<span class="ln">27</span>        <span class="k">return</span> <span class="n">ArenaObjectPointer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">data_</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
<span class="ln">28</span>    <span class="p">}</span>
<span class="ln">29</span>    <span class="kt">uint32_t</span> <span class="nf">AllocateUint32Array</span><span class="p">(</span><span class="kt">int</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">30</span>        <span class="kt">uint32_t</span> <span class="n">offset</span><span class="p">;</span>
<span class="ln">31</span>        <span class="n">AllocateData</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="o">*</span> <span class="n">length</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offset</span><span class="p">);</span>
<span class="ln">32</span>        <span class="k">return</span> <span class="n">offset</span><span class="p">;</span>
<span class="ln">33</span>    <span class="p">}</span>
<span class="ln">34</span>
<span class="ln">35</span>    <span class="kt">uint32_t</span><span class="o">*</span> <span class="nf">uint32_array</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">36</span>        <span class="k">return</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">data_</span><span class="p">.</span><span class="n">data</span><span class="p">()</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="ln">37</span>    <span class="p">}</span>
<span class="ln">38</span>
<span class="ln">39</span>    <span class="kt">uint32_t</span> <span class="nf">AllocateAndWriteString</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">string</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">40</span>        <span class="kt">uint32_t</span> <span class="n">offset</span><span class="p">;</span>
<span class="ln">41</span>        <span class="kt">char</span><span class="o">*</span> <span class="n">data</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">AllocateData</span><span class="p">(</span><span class="n">string</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offset</span><span class="p">));</span>
<span class="ln">42</span>        <span class="n">strcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">string</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="ln">43</span>        <span class="k">return</span> <span class="n">offset</span><span class="p">;</span>
<span class="ln">44</span>    <span class="p">}</span>
<span class="ln">45</span>
<span class="ln">46</span>    <span class="kt">void</span> <span class="nf">AllocateAndWriteUint32</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">47</span>        <span class="k">auto</span> <span class="n">location</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">AllocateData</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">),</span> <span class="k">nullptr</span><span class="p">));</span>
<span class="ln">48</span>        <span class="o">*</span><span class="n">location</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
<span class="ln">49</span>    <span class="p">}</span>
<span class="ln">50</span>
<span class="ln">51</span>    <span class="kt">void</span><span class="o">*</span> <span class="nf">AllocateData</span><span class="p">(</span><span class="n">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">uint32_t</span><span class="o">*</span> <span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">52</span>        <span class="c1">//这里的意思，实际上是数据结构的内存对齐，保证分配的大小是4的整数倍
</span><span class="ln">53</span><span class="c1"></span>        <span class="n">size_t</span> <span class="n">aligned_size</span> <span class="o">=</span> <span class="n">size</span> <span class="o">+</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="ln">54</span>
<span class="ln">55</span>        <span class="k">if</span> <span class="p">(</span><span class="n">current_data_pointer_</span> <span class="o">+</span> <span class="n">aligned_size</span> <span class="o">&gt;</span> <span class="n">data_</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
<span class="ln">56</span>            <span class="k">auto</span> <span class="n">new_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_data_pointer_</span> <span class="o">+</span> <span class="n">aligned_size</span> <span class="o">+</span> <span class="n">data_</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
<span class="ln">57</span>            <span class="n">data_</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">new_size</span><span class="p">,</span> <span class="sc">&#39;\0&#39;</span><span class="p">);</span>
<span class="ln">58</span>        <span class="p">}</span>
<span class="ln">59</span>        <span class="k">if</span> <span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="o">*</span><span class="n">offset</span> <span class="o">=</span> <span class="n">current_data_pointer_</span><span class="p">;</span>
<span class="ln">60</span>
<span class="ln">61</span>        <span class="kt">uint32_t</span> <span class="n">return_offset</span> <span class="o">=</span> <span class="n">current_data_pointer_</span><span class="p">;</span>
<span class="ln">62</span>        <span class="n">current_data_pointer_</span> <span class="o">+=</span> <span class="n">aligned_size</span><span class="p">;</span>
<span class="ln">63</span>        <span class="k">return</span> <span class="o">&amp;</span><span class="n">data_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">return_offset</span><span class="p">;</span>
<span class="ln">64</span>    <span class="p">}</span>
<span class="ln">65</span>
<span class="ln">66</span>    <span class="kt">uint32_t</span> <span class="nf">size</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">current_data_pointer_</span><span class="p">;</span> <span class="p">}</span>
<span class="ln">67</span>
<span class="ln">68</span>    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">data</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">data_</span><span class="p">;</span> <span class="p">}</span>
<span class="ln">69</span>    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">truncated_data</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
<span class="ln">70</span>        <span class="k">auto</span> <span class="n">result</span> <span class="o">=</span> <span class="n">data_</span><span class="p">;</span>
<span class="ln">71</span>        <span class="n">result</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">current_data_pointer_</span><span class="p">);</span>
<span class="ln">72</span>        <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="ln">73</span>    <span class="p">}</span>
<span class="ln">74</span>
<span class="ln">75</span>    <span class="k">private</span><span class="o">:</span>
<span class="ln">76</span>    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">data_</span><span class="p">;</span>
<span class="ln">77</span>    <span class="kt">uint32_t</span> <span class="n">current_data_pointer_</span><span class="p">;</span>
<span class="ln">78</span><span class="p">};</span>
</code></pre></div><p>序列化拆分的数据结构</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/property/property_8.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/property/property_8.png" >
  
    </a>
  
  
</div>

<p>文件<code>/dev/__properties__/property_info</code>中的数据结构如下所示，后续可根据对应的<code>PropertyInfoAreaHeader</code>、<code>TrieNodeInternal</code>、<code>PropertyEntry</code>三个结构体存储的内容来具体找到对应的属性中的偏移。</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/property/property_9.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/property/property_9.png" >
  
    </a>
  
  
</div>

<h3 id="12初始化属性域">1.2初始化属性域</h3>
<p>初始化属性域<code>__system_property_area_init</code></p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//bionic/libc/bionic/system_property_api.cpp
</span><span class="ln"> 2</span><span class="c1">//__BIONIC_WEAK_FOR_NATIVE_BRIDGE代表__attribute__((__weak__, __noinline__))
</span><span class="ln"> 3</span><span class="c1">//声明weak function,链接器不会从库中加载对象来解析弱引用。仅当由于其他原因在镜像中包含了定义时，它才能解析弱引用。
</span><span class="ln"> 4</span><span class="c1">//noinline设置函数为非内联函数
</span><span class="ln"> 5</span><span class="c1">//#define PROP_FILENAME &#34;/dev/__properties__&#34;
</span><span class="ln"> 6</span><span class="c1"></span> <span class="n">__BIONIC_WEAK_FOR_NATIVE_BRIDGE</span>
<span class="ln"> 7</span><span class="kt">int</span> <span class="nf">__system_property_area_init</span><span class="p">()</span> <span class="p">{</span>
<span class="ln"> 8</span>  <span class="kt">bool</span> <span class="n">fsetxattr_failed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="ln"> 9</span>  <span class="k">return</span> <span class="n">system_properties</span><span class="p">.</span><span class="n">AreaInit</span><span class="p">(</span><span class="n">PROP_FILENAME</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fsetxattr_failed</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">fsetxattr_failed</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="ln">10</span><span class="p">}</span>
</code></pre></div><p><code>system_properties.AreaInit</code></p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//bionic/libc/system_properties/system_properties.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="kt">bool</span> <span class="n">SystemProperties</span><span class="o">::</span><span class="n">AreaInit</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filename</span><span class="p">,</span> <span class="kt">bool</span><span class="o">*</span> <span class="n">fsetxattr_failed</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 3</span>  <span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">PROP_FILENAME_MAX</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 4</span>    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="ln"> 5</span>  <span class="p">}</span>
<span class="ln"> 6</span>  <span class="n">strcpy</span><span class="p">(</span><span class="n">property_filename_</span><span class="p">,</span> <span class="n">filename</span><span class="p">);</span>
<span class="ln"> 7</span>
<span class="ln"> 8</span>  <span class="n">contexts_</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="n">contexts_data_</span><span class="p">)</span> <span class="n">ContextsSerialized</span><span class="p">();</span>
<span class="ln"> 9</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">contexts_</span><span class="o">-&gt;</span><span class="n">Initialize</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span> <span class="n">property_filename_</span><span class="p">,</span> <span class="n">fsetxattr_failed</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">10</span>    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="ln">11</span>  <span class="p">}</span>
<span class="ln">12</span>  <span class="c1">//初始化结束之后，会把initialized_设置为true
</span><span class="ln">13</span><span class="c1"></span>  <span class="n">initialized_</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="ln">14</span>  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="ln">15</span><span class="p">}</span>
</code></pre></div><p>这里主要<code>property_filename</code>_赋值为<code>/dev/__properties__</code>，另外对<code>contexts_</code>进行序列化初值，并且初始化，这里的初始化传参是true，跟app传参false区别开来，说明只有系统root用户才有权限写入操作。</p>
<h3 id="121contextsserialized">1.2.1ContextsSerialized</h3>
<p><code>contexts_</code>的基类是<code>Contexts</code>，<code>ContextsSerialized</code>是<code>Contexts</code>的子类。</p>
<p>记录<code>ContextsSerialized</code>类的组成</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln">1</span><span class="k">class</span> <span class="nc">ContextsSerialized</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Contexts</span> <span class="p">{</span>
<span class="ln">2</span>  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filename_</span><span class="p">;</span>
<span class="ln">3</span>  <span class="n">android</span><span class="o">::</span><span class="n">properties</span><span class="o">::</span><span class="n">PropertyInfoAreaFile</span> <span class="n">property_info_area_file_</span><span class="p">;</span>
<span class="ln">4</span>  <span class="n">ContextNode</span><span class="o">*</span> <span class="n">context_nodes_</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
<span class="ln">5</span>  <span class="n">size_t</span> <span class="n">num_context_nodes_</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="ln">6</span>  <span class="n">size_t</span> <span class="n">context_nodes_mmap_size_</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="ln">7</span>  <span class="n">prop_area</span><span class="o">*</span> <span class="n">serial_prop_area_</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
<span class="ln">8</span><span class="p">};</span>
</code></pre></div>

 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/property/property_15.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/property/property_15.png" >
  
    </a>
  
  
</div>

<h3 id="122initialize">1.2.2Initialize</h3>
<p>这个没有定义构造函数，那么就是默认的构造函数<code>contexts_-&gt;Initialize</code></p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//bionic/libc/system_properties/contexts_serialized.cpp
</span><span class="ln"> 2</span><span class="c1">//初始化的进程是init进程，所有有root读取权限修改，传入的writable是true，传入的filename是&#34;/dev/__properties__&#34;
</span><span class="ln"> 3</span><span class="c1"></span><span class="kt">bool</span> <span class="n">ContextsSerialized</span><span class="o">::</span><span class="n">Initialize</span><span class="p">(</span><span class="kt">bool</span> <span class="n">writable</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filename</span><span class="p">,</span> <span class="kt">bool</span><span class="o">*</span> <span class="n">fsetxattr_failed</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 4</span>  <span class="n">filename_</span> <span class="o">=</span> <span class="n">filename</span><span class="p">;</span>
<span class="ln"> 5</span>  <span class="c1">//是否成功初始化属性  
</span><span class="ln"> 6</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">InitializeProperties</span><span class="p">())</span> <span class="p">{</span>
<span class="ln"> 7</span>    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="ln"> 8</span>  <span class="p">}</span>
<span class="ln"> 9</span>
<span class="ln">10</span>  <span class="k">if</span> <span class="p">(</span><span class="n">writable</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">11</span>    <span class="n">mkdir</span><span class="p">(</span><span class="n">filename_</span><span class="p">,</span> <span class="n">S_IRWXU</span> <span class="o">|</span> <span class="n">S_IXGRP</span> <span class="o">|</span> <span class="n">S_IXOTH</span><span class="p">);</span>
<span class="ln">12</span>    <span class="kt">bool</span> <span class="n">open_failed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="ln">13</span>    <span class="k">if</span> <span class="p">(</span><span class="n">fsetxattr_failed</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">14</span>      <span class="o">*</span><span class="n">fsetxattr_failed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="ln">15</span>    <span class="p">}</span>
<span class="ln">16</span>
<span class="ln">17</span>    <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_context_nodes_</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">18</span>      <span class="c1">//开始创建context文件
</span><span class="ln">19</span><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">context_nodes_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Open</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span> <span class="n">fsetxattr_failed</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">20</span>        <span class="n">open_failed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="ln">21</span>      <span class="p">}</span>
<span class="ln">22</span>    <span class="p">}</span>
<span class="ln">23</span>    <span class="k">if</span> <span class="p">(</span><span class="n">open_failed</span> <span class="o">||</span> <span class="o">!</span><span class="n">MapSerialPropertyArea</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span> <span class="n">fsetxattr_failed</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">24</span>      <span class="n">FreeAndUnmap</span><span class="p">();</span>
<span class="ln">25</span>      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="ln">26</span>    <span class="p">}</span>
<span class="ln">27</span>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="ln">28</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">MapSerialPropertyArea</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">29</span>      <span class="n">FreeAndUnmap</span><span class="p">();</span>
<span class="ln">30</span>      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="ln">31</span>    <span class="p">}</span>
<span class="ln">32</span>  <span class="p">}</span>
<span class="ln">33</span>  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="ln">34</span><span class="p">}</span>
</code></pre></div><p>构造完成之后，<code>contexts_</code>的数据结构如下图所示</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/property/property_17.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/property/property_17.png" >
  
    </a>
  
  
</div>

<h4 id="1221initializeproperties">1.2.2.1InitializeProperties</h4>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//bionic/libc/system_properties/contexts_serialized.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="kt">bool</span> <span class="n">ContextsSerialized</span><span class="o">::</span><span class="n">InitializeProperties</span><span class="p">()</span> <span class="p">{</span>
<span class="ln"> 3</span>  <span class="c1">//导入1.1中完成序列化的property_info文件
</span><span class="ln"> 4</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">property_info_area_file_</span><span class="p">.</span><span class="n">LoadDefaultPath</span><span class="p">())</span> <span class="p">{</span>
<span class="ln"> 5</span>    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="ln"> 6</span>  <span class="p">}</span>
<span class="ln"> 7</span>  <span class="c1">//开始创建SElinux域文件  
</span><span class="ln"> 8</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">InitializeContextNodes</span><span class="p">())</span> <span class="p">{</span>
<span class="ln"> 9</span>    <span class="n">FreeAndUnmap</span><span class="p">();</span>
<span class="ln">10</span>    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="ln">11</span>  <span class="p">}</span>
<span class="ln">12</span>
<span class="ln">13</span>  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="ln">14</span><span class="p">}</span>
</code></pre></div><p>1）<code>LoadDefaultPath</code></p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//system/core/property_service/libpropertyinfoparser/property_info_parser.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="kt">bool</span> <span class="n">PropertyInfoAreaFile</span><span class="o">::</span><span class="n">LoadDefaultPath</span><span class="p">()</span> <span class="p">{</span>
<span class="ln"> 3</span>  <span class="k">return</span> <span class="nf">LoadPath</span><span class="p">(</span><span class="s">&#34;/dev/__properties__/property_info&#34;</span><span class="p">);</span>
<span class="ln"> 4</span><span class="p">}</span>
<span class="ln"> 5</span>
<span class="ln"> 6</span><span class="kt">bool</span> <span class="n">PropertyInfoAreaFile</span><span class="o">::</span><span class="n">LoadPath</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filename</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 7</span>  <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">O_CLOEXEC</span> <span class="o">|</span> <span class="n">O_NOFOLLOW</span> <span class="o">|</span> <span class="n">O_RDONLY</span><span class="p">);</span>
<span class="ln"> 8</span>
<span class="ln"> 9</span>  <span class="k">struct</span> <span class="nc">stat</span> <span class="n">fd_stat</span><span class="p">;</span>
<span class="ln">10</span>  <span class="k">if</span> <span class="p">(</span><span class="n">fstat</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fd_stat</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">11</span>    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
<span class="ln">12</span>    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="ln">13</span>  <span class="p">}</span>
<span class="ln">14</span>  <span class="c1">//判断打开的文件是不是init进程，必须是uid=0，gid=0，且文件大小需要大于PropertyInfoArea类型
</span><span class="ln">15</span><span class="c1"></span>  <span class="k">if</span> <span class="p">((</span><span class="n">fd_stat</span><span class="p">.</span><span class="n">st_uid</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">fd_stat</span><span class="p">.</span><span class="n">st_gid</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
<span class="ln">16</span>      <span class="p">((</span><span class="n">fd_stat</span><span class="p">.</span><span class="n">st_mode</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">S_IWGRP</span> <span class="o">|</span> <span class="n">S_IWOTH</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
<span class="ln">17</span>      <span class="p">(</span><span class="n">fd_stat</span><span class="p">.</span><span class="n">st_size</span> <span class="o">&lt;</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">off_t</span><span class="o">&gt;</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">PropertyInfoArea</span><span class="p">))))</span> <span class="p">{</span>
<span class="ln">18</span>    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
<span class="ln">19</span>    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="ln">20</span>  <span class="p">}</span>
<span class="ln">21</span>
<span class="ln">22</span>  <span class="k">auto</span> <span class="n">mmap_size</span> <span class="o">=</span> <span class="n">fd_stat</span><span class="p">.</span><span class="n">st_size</span><span class="p">;</span>
<span class="ln">23</span>  <span class="c1">//这里做了mmap操作，相当于做了读操作的共享区域的映射
</span><span class="ln">24</span><span class="c1"></span>  <span class="kt">void</span><span class="o">*</span> <span class="n">map_result</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="k">nullptr</span><span class="p">,</span> <span class="n">mmap_size</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="p">,</span> <span class="n">MAP_SHARED</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="ln">25</span>  <span class="k">if</span> <span class="p">(</span><span class="n">map_result</span> <span class="o">==</span> <span class="n">MAP_FAILED</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">26</span>    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
<span class="ln">27</span>    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="ln">28</span>  <span class="p">}</span>
<span class="ln">29</span>  <span class="c1">//共享区域映射之后的指针指向PropertyInfoArea类型
</span><span class="ln">30</span><span class="c1"></span>  <span class="k">auto</span> <span class="n">property_info_area</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">PropertyInfoArea</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">map_result</span><span class="p">);</span>
<span class="ln">31</span>  <span class="k">if</span> <span class="p">(</span><span class="n">property_info_area</span><span class="o">-&gt;</span><span class="n">minimum_supported_version</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">||</span>
<span class="ln">32</span>      <span class="n">property_info_area</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">()</span> <span class="o">!=</span> <span class="n">mmap_size</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">33</span>    <span class="n">munmap</span><span class="p">(</span><span class="n">map_result</span><span class="p">,</span> <span class="n">mmap_size</span><span class="p">);</span>
<span class="ln">34</span>    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
<span class="ln">35</span>    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="ln">36</span>  <span class="p">}</span>
<span class="ln">37</span>
<span class="ln">38</span>  <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
<span class="ln">39</span>  <span class="n">mmap_base_</span> <span class="o">=</span> <span class="n">map_result</span><span class="p">;</span>
<span class="ln">40</span>  <span class="n">mmap_size_</span> <span class="o">=</span> <span class="n">mmap_size</span><span class="p">;</span>
<span class="ln">41</span>  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="ln">42</span><span class="p">}</span>
</code></pre></div><blockquote>
<p><strong><code>mmap</code>说明</strong></p>
<p>关于<code>mmap</code>东西很多，这里之前浅谈一些基础<code>api</code>用法，具体可点击<a href="https://juejin.cn/post/7119116943256190990">这里</a>。</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln">1</span><span class="kt">void</span><span class="o">*</span> <span class="nf">mmap</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">addr</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">length</span><span class="p">,</span> <span class="kt">int</span> <span class="n">prot</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="n">off_t</span> <span class="n">offset</span><span class="p">);</span>
</code></pre></div><ul>
<li>addr 代表映射的虚拟内存起始地址；</li>
<li>length 代表该映射长度；</li>
<li>prot 描述了这块新的内存区域的访问权限；</li>
<li>flags 描述了该映射的类型；</li>
<li>fd 代表文件描述符；</li>
<li>offset 代表文件内的偏移值。</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">参数</th>
<th style="text-align:center">参数可选用的值</th>
<th>对应的含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>prot</code></td>
<td style="text-align:center"><code>PROT_EXEC</code></td>
<td>该内存映射有可执行权限，可以看成是代码段，通常存储CPU可执行机器码</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"><code>PROT_READ</code></td>
<td>该内存映射可读</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"><code>PROT_WRITE</code></td>
<td>该内存映射可写</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"><code>PROT_NONE</code></td>
<td>该内存映射不能被访问</td>
</tr>
<tr>
<td style="text-align:center"><code>flags</code></td>
<td style="text-align:center"><code>MAP_SHARED</code></td>
<td>创建一个共享映射区域</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"><code>MAP_PRIVATE</code></td>
<td>创建一个私有映射区域</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"><code>MAP_ANONYMOUS</code></td>
<td>创建一个匿名映射区域，该情况只需要传入-1即可</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"><code>MAP_FIXED</code></td>
<td>当操作系统以<code>addr为</code>起始地址进行内存映射时，如果发现不能满足长度或者权限要求时，将映射失败，如果非<code>MAP_FIXED</code>，则系统就会再找其他合适的区域进行映射</td>
</tr>
<tr>
<td style="text-align:center"><code>fd</code></td>
<td style="text-align:center">大于0</td>
<td>内存映射将与文件进行关联</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">-1</td>
<td>匿名映射，此时flags必为<code>MAP_ANONYMOUS</code></td>
</tr>
</tbody>
</table>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/property/property_10.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/property/property_10.png" >
  
    </a>
  
  
</div>

</blockquote>
<p>这里的强转的<code>property_info_area</code>指针其实对应着上文1.1中的<code>arena_</code>指针</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/property/property_11.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/property/property_11.png" >
  
    </a>
  
  
</div>

<p>2）<code>InitializeContextNodes</code></p>
<p>生成对应的<code>SElinux</code>域的文件</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//bionic/libc/system_properties/contexts_serialized.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="kt">bool</span> <span class="n">ContextsSerialized</span><span class="o">::</span><span class="n">InitializeContextNodes</span><span class="p">()</span> <span class="p">{</span>
<span class="ln"> 3</span>  <span class="c1">//num_context_nodes这里指的arena_头部结构体PropertyInfoAreaHeader中的contexts_个数
</span><span class="ln"> 4</span><span class="c1"></span>  <span class="k">auto</span> <span class="n">num_context_nodes</span> <span class="o">=</span> <span class="n">property_info_area_file_</span><span class="o">-&gt;</span><span class="n">num_contexts</span><span class="p">();</span>
<span class="ln"> 5</span>  <span class="c1">//计算出一个大小为ContextNode大小*contexts_个数的空间
</span><span class="ln"> 6</span><span class="c1"></span>  <span class="k">auto</span> <span class="n">context_nodes_mmap_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ContextNode</span><span class="p">)</span> <span class="o">*</span> <span class="n">num_context_nodes</span><span class="p">;</span>
<span class="ln"> 7</span>  <span class="c1">//使用mmap分配了一个私有匿名的内存，缓存在context_nodes_中
</span><span class="ln"> 8</span><span class="c1"></span>  <span class="kt">void</span><span class="o">*</span> <span class="k">const</span> <span class="n">map_result</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="k">nullptr</span><span class="p">,</span> <span class="n">context_nodes_mmap_size</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span>
<span class="ln"> 9</span>                                <span class="n">MAP_PRIVATE</span> <span class="o">|</span> <span class="n">MAP_ANONYMOUS</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="ln">10</span>  <span class="k">if</span> <span class="p">(</span><span class="n">map_result</span> <span class="o">==</span> <span class="n">MAP_FAILED</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">11</span>    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="ln">12</span>  <span class="p">}</span>
<span class="ln">13</span>  <span class="c1">//调用一次prctl使用PR_SET_VMA参数，功能是给addr和vsize指定的匿名内存区域命名了&#34;System property context nodes&#34;
</span><span class="ln">14</span><span class="c1"></span>  <span class="n">prctl</span><span class="p">(</span><span class="n">PR_SET_VMA</span><span class="p">,</span> <span class="n">PR_SET_VMA_ANON_NAME</span><span class="p">,</span> <span class="n">map_result</span><span class="p">,</span> <span class="n">context_nodes_mmap_size</span><span class="p">,</span>
<span class="ln">15</span>        <span class="s">&#34;System property context nodes&#34;</span><span class="p">);</span>
<span class="ln">16</span>
<span class="ln">17</span>  <span class="n">context_nodes_</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">ContextNode</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">map_result</span><span class="p">);</span>
<span class="ln">18</span>  <span class="n">num_context_nodes_</span> <span class="o">=</span> <span class="n">num_context_nodes</span><span class="p">;</span>
<span class="ln">19</span>  <span class="n">context_nodes_mmap_size_</span> <span class="o">=</span> <span class="n">context_nodes_mmap_size</span><span class="p">;</span>
<span class="ln">20</span>  <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_context_nodes</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">21</span>    <span class="c1">//对每一个Context进行实例化，并且默认的初始值传入
</span><span class="ln">22</span><span class="c1"></span>    <span class="c1">//这个property_info_area_file_-&gt;context(i)为具体的context内容，filename_为/dev/__properties__
</span><span class="ln">23</span><span class="c1"></span>    <span class="k">new</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">context_nodes_</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="n">ContextNode</span><span class="p">(</span><span class="n">property_info_area_file_</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">filename_</span><span class="p">);</span>
<span class="ln">24</span>  <span class="p">}</span>
<span class="ln">25</span>  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="ln">26</span><span class="p">}</span>
</code></pre></div><p>同<code>LoadDefaultPath</code>类似，这里也出现<code>mmap</code>操作，不过这里更像是<code>malloc</code>分配内存，这个<code>mmap</code>操作既是匿名的又是私有的，并且实例化<code>num_context_nodes</code>个<code>ContextNode</code>。</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/property/property_12.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/property/property_12.png" >
  
    </a>
  
  
</div>

<h4 id="1222open">1.2.2.2Open</h4>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//bionic/libc/system_properties/context_node.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="kt">bool</span> <span class="n">ContextNode</span><span class="o">::</span><span class="n">Open</span><span class="p">(</span><span class="kt">bool</span> <span class="n">access_rw</span><span class="p">,</span> <span class="kt">bool</span><span class="o">*</span> <span class="n">fsetxattr_failed</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 3</span>  <span class="c1">//这里的pa_是prop_area类型的指针，如果pa_域存在说明文件已经存在，直接退出  
</span><span class="ln"> 4</span><span class="c1"></span>  <span class="n">lock_</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span>
<span class="ln"> 5</span>  <span class="k">if</span> <span class="p">(</span><span class="n">pa_</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 6</span>    <span class="n">lock_</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
<span class="ln"> 7</span>    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="ln"> 8</span>  <span class="p">}</span>
<span class="ln"> 9</span>
<span class="ln">10</span>  <span class="kt">char</span> <span class="n">filename</span><span class="p">[</span><span class="n">PROP_FILENAME_MAX</span><span class="p">];</span>
<span class="ln">11</span>  <span class="c1">//filename 对应的是具体的SElinux的context
</span><span class="ln">12</span><span class="c1"></span>  <span class="c1">//比如/dev/__properties__/u:object_r:exported_default_prop:s0  
</span><span class="ln">13</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">async_safe_format_buffer</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="s">&#34;%s/%s&#34;</span><span class="p">,</span> <span class="n">filename_</span><span class="p">,</span> <span class="n">context_</span><span class="p">);</span>
<span class="ln">14</span>  <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">len</span> <span class="o">&gt;=</span> <span class="n">PROP_FILENAME_MAX</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">15</span>    <span class="n">lock_</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
<span class="ln">16</span>    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="ln">17</span>  <span class="p">}</span>
<span class="ln">18</span>
<span class="ln">19</span>  <span class="k">if</span> <span class="p">(</span><span class="n">access_rw</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">20</span>    <span class="c1">//创建对应的文件
</span><span class="ln">21</span><span class="c1"></span>    <span class="n">pa_</span> <span class="o">=</span> <span class="n">prop_area</span><span class="o">::</span><span class="n">map_prop_area_rw</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">context_</span><span class="p">,</span> <span class="n">fsetxattr_failed</span><span class="p">);</span>
<span class="ln">22</span>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="ln">23</span>    <span class="n">pa_</span> <span class="o">=</span> <span class="n">prop_area</span><span class="o">::</span><span class="n">map_prop_area</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
<span class="ln">24</span>  <span class="p">}</span>
<span class="ln">25</span>  <span class="n">lock_</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
<span class="ln">26</span>  <span class="k">return</span> <span class="n">pa_</span><span class="p">;</span>
<span class="ln">27</span><span class="p">}</span>
</code></pre></div><p><code>map_prop_area_rw</code></p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//bionic/libc/system_properties/prop_area.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="n">prop_area</span><span class="o">*</span> <span class="n">prop_area</span><span class="o">::</span><span class="n">map_prop_area_rw</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filename</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">context</span><span class="p">,</span>
<span class="ln"> 3</span>                                       <span class="kt">bool</span><span class="o">*</span> <span class="n">fsetxattr_failed</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 4</span>  <span class="c1">//打开文件，不存在就创建文件
</span><span class="ln"> 5</span><span class="c1"></span>  <span class="k">const</span> <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">O_RDWR</span> <span class="o">|</span> <span class="n">O_CREAT</span> <span class="o">|</span> <span class="n">O_NOFOLLOW</span> <span class="o">|</span> <span class="n">O_CLOEXEC</span> <span class="o">|</span> <span class="n">O_EXCL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="ln"> 6</span>  <span class="p">...</span>
<span class="ln"> 7</span>  <span class="c1">//文件大小设置为PA_SIZE（128 * 1024），多的大小那么就截断    
</span><span class="ln"> 8</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">ftruncate</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">PA_SIZE</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 9</span>    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
<span class="ln">10</span>    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
<span class="ln">11</span>  <span class="p">}</span>
<span class="ln">12</span>
<span class="ln">13</span>  <span class="n">pa_size_</span> <span class="o">=</span> <span class="n">PA_SIZE</span><span class="p">;</span>
<span class="ln">14</span>  <span class="n">pa_data_size_</span> <span class="o">=</span> <span class="n">pa_size_</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">prop_area</span><span class="p">);</span>
<span class="ln">15</span>  <span class="c1">//通过mmap映射了一个可读可写的共享区域
</span><span class="ln">16</span><span class="c1"></span>  <span class="kt">void</span><span class="o">*</span> <span class="k">const</span> <span class="n">memory_area</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="k">nullptr</span><span class="p">,</span> <span class="n">pa_size_</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_SHARED</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="ln">17</span>  <span class="k">if</span> <span class="p">(</span><span class="n">memory_area</span> <span class="o">==</span> <span class="n">MAP_FAILED</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">18</span>    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
<span class="ln">19</span>    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
<span class="ln">20</span>  <span class="p">}</span>
<span class="ln">21</span>  <span class="c1">//并且设置区域的开始为prop_area类型，且附上初值PROP_AREA_MAGIC = 0x504f5250，PROP_AREA_VERSION = 0xfc6ed0ab
</span><span class="ln">22</span><span class="c1"></span>  <span class="n">prop_area</span><span class="o">*</span> <span class="n">pa</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="n">memory_area</span><span class="p">)</span> <span class="n">prop_area</span><span class="p">(</span><span class="n">PROP_AREA_MAGIC</span><span class="p">,</span> <span class="n">PROP_AREA_VERSION</span><span class="p">);</span>
<span class="ln">23</span>
<span class="ln">24</span>  <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
<span class="ln">25</span>  <span class="k">return</span> <span class="n">pa</span><span class="p">;</span>
<span class="ln">26</span><span class="p">}</span>
</code></pre></div><p>这里第三次出现了<code>mmap</code>，而且是通过创建的<code>SElinux</code>域文件来映射对应的共享内存区域</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/property/property_13.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/property/property_13.png" >
  
    </a>
  
  
</div>

<h4 id="1223mapserialpropertyarea">1.2.2.3MapSerialPropertyArea</h4>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//bionic/libc/system_properties/contexts_serialized.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="kt">bool</span> <span class="n">ContextsSerialized</span><span class="o">::</span><span class="n">MapSerialPropertyArea</span><span class="p">(</span><span class="kt">bool</span> <span class="n">access_rw</span><span class="p">,</span> <span class="kt">bool</span><span class="o">*</span> <span class="n">fsetxattr_failed</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 3</span>  <span class="kt">char</span> <span class="n">filename</span><span class="p">[</span><span class="n">PROP_FILENAME_MAX</span><span class="p">];</span>
<span class="ln"> 4</span>  <span class="c1">//这里的filename是/dev/__properties__/properties_serial
</span><span class="ln"> 5</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">async_safe_format_buffer</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="s">&#34;%s/properties_serial&#34;</span><span class="p">,</span> <span class="n">filename_</span><span class="p">);</span>
<span class="ln"> 6</span>  <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">len</span> <span class="o">&gt;=</span> <span class="n">PROP_FILENAME_MAX</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 7</span>    <span class="n">serial_prop_area_</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
<span class="ln"> 8</span>    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="ln"> 9</span>  <span class="p">}</span>
<span class="ln">10</span>
<span class="ln">11</span>  <span class="k">if</span> <span class="p">(</span><span class="n">access_rw</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">12</span>    <span class="c1">//init进程肯定是走可读写权限，创建了对应的/dev/__properties__/properties_serial文件，大小为128K
</span><span class="ln">13</span><span class="c1"></span>    <span class="c1">//这里传入的context_跟上述不一致，这里是&#34;u:object_r:properties_serial:s0&#34;，主要用于校验作用
</span><span class="ln">14</span><span class="c1"></span>    <span class="n">serial_prop_area_</span> <span class="o">=</span>
<span class="ln">15</span>        <span class="n">prop_area</span><span class="o">::</span><span class="n">map_prop_area_rw</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#34;u:object_r:properties_serial:s0&#34;</span><span class="p">,</span> <span class="n">fsetxattr_failed</span><span class="p">);</span>
<span class="ln">16</span>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="ln">17</span>    <span class="n">serial_prop_area_</span> <span class="o">=</span> <span class="n">prop_area</span><span class="o">::</span><span class="n">map_prop_area</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
<span class="ln">18</span>  <span class="p">}</span>
<span class="ln">19</span>  <span class="k">return</span> <span class="n">serial_prop_area_</span><span class="p">;</span>
<span class="ln">20</span><span class="p">}</span>
</code></pre></div>

 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/property/property_14.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/property/property_14.png" >
  
    </a>
  
  
</div>

<h3 id="13属性域的文件导入">1.3属性域的文件导入</h3>
<p>这里跟1.2中的有重复部分，这里就不具体展开了，作用是为了二次确认是否<code>/dev/__properties__/property_info</code>是否映射正常</p>
<h3 id="14其他的属性初始化">1.4其他的属性初始化</h3>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln">1</span><span class="n">ProcessKernelDt</span><span class="p">();</span>
<span class="ln">2</span><span class="n">ProcessKernelCmdline</span><span class="p">();</span>
<span class="ln">3</span><span class="n">ExportKernelBootProps</span><span class="p">();</span>
<span class="ln">4</span><span class="n">PropertyLoadBootDefaults</span><span class="p">();</span>
</code></pre></div><h3 id="141processkerneldt">1.4.1ProcessKernelDt</h3>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//system/core/init/property_service.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="k">static</span> <span class="kt">void</span> <span class="nf">ProcessKernelDt</span><span class="p">()</span> <span class="p">{</span>
<span class="ln"> 3</span>    <span class="c1">//判断 /proc/device-tree/firmware/android/compatible 文件中的值是否为 android,firmware
</span><span class="ln"> 4</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_android_dt_value_expected</span><span class="p">(</span><span class="s">&#34;compatible&#34;</span><span class="p">,</span> <span class="s">&#34;android,firmware&#34;</span><span class="p">))</span> <span class="p">{</span>
<span class="ln"> 5</span>        <span class="k">return</span><span class="p">;</span>
<span class="ln"> 6</span>    <span class="p">}</span>
<span class="ln"> 7</span>    <span class="c1">//get_android_dt_dir()的值为/proc/device-tree/firmware/android
</span><span class="ln"> 8</span><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">DIR</span><span class="p">,</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="n">DIR</span><span class="o">*</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">dir</span><span class="p">(</span><span class="n">opendir</span><span class="p">(</span><span class="n">get_android_dt_dir</span><span class="p">().</span><span class="n">c_str</span><span class="p">()),</span> <span class="n">closedir</span><span class="p">);</span>
<span class="ln"> 9</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dir</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
<span class="ln">10</span>
<span class="ln">11</span>    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">dt_file</span><span class="p">;</span>
<span class="ln">12</span>    <span class="k">struct</span> <span class="nc">dirent</span><span class="o">*</span> <span class="n">dp</span><span class="p">;</span>
<span class="ln">13</span>    <span class="c1">////遍历dir中的文件
</span><span class="ln">14</span><span class="c1"></span>    <span class="k">while</span> <span class="p">((</span><span class="n">dp</span> <span class="o">=</span> <span class="n">readdir</span><span class="p">(</span><span class="n">dir</span><span class="p">.</span><span class="n">get</span><span class="p">()))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">15</span>        <span class="k">if</span> <span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">d_type</span> <span class="o">!=</span> <span class="n">DT_REG</span> <span class="o">||</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">,</span> <span class="s">&#34;compatible&#34;</span><span class="p">)</span> <span class="o">||</span>
<span class="ln">16</span>            <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">dp</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">,</span> <span class="s">&#34;name&#34;</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">17</span>            <span class="k">continue</span><span class="p">;</span>
<span class="ln">18</span>        <span class="p">}</span>
<span class="ln">19</span>
<span class="ln">20</span>        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">file_name</span> <span class="o">=</span> <span class="n">get_android_dt_dir</span><span class="p">()</span> <span class="o">+</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">;</span>
<span class="ln">21</span>
<span class="ln">22</span>        <span class="n">android</span><span class="o">::</span><span class="n">base</span><span class="o">::</span><span class="n">ReadFileToString</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dt_file</span><span class="p">);</span>
<span class="ln">23</span>        <span class="n">std</span><span class="o">::</span><span class="n">replace</span><span class="p">(</span><span class="n">dt_file</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">dt_file</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="sc">&#39;,&#39;</span><span class="p">,</span> <span class="sc">&#39;.&#39;</span><span class="p">);</span>
<span class="ln">24</span>        <span class="c1">// 将 ro.boot.文件名 作为key，文件内容为value，设置进属性
</span><span class="ln">25</span><span class="c1"></span>        <span class="n">InitPropertySet</span><span class="p">(</span><span class="s">&#34;ro.boot.&#34;</span><span class="n">s</span> <span class="o">+</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">,</span> <span class="n">dt_file</span><span class="p">);</span>
<span class="ln">26</span>    <span class="p">}</span>
<span class="ln">27</span><span class="p">}</span>
</code></pre></div><h3 id="142processkernelcmdline">1.4.2ProcessKernelCmdline</h3>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//system/core/init/property_service.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="k">static</span> <span class="kt">void</span> <span class="nf">ProcessKernelCmdline</span><span class="p">()</span> <span class="p">{</span>
<span class="ln"> 3</span>    <span class="kt">bool</span> <span class="n">for_emulator</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="ln"> 4</span>    <span class="n">ImportKernelCmdline</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 5</span>        <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="s">&#34;qemu&#34;</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 6</span>            <span class="n">for_emulator</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="ln"> 7</span>        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">StartsWith</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s">&#34;androidboot.&#34;</span><span class="p">))</span> <span class="p">{</span>
<span class="ln"> 8</span>            <span class="n">InitPropertySet</span><span class="p">(</span><span class="s">&#34;ro.boot.&#34;</span> <span class="o">+</span> <span class="n">key</span><span class="p">.</span><span class="n">substr</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span> <span class="n">value</span><span class="p">);</span>
<span class="ln"> 9</span>        <span class="p">}</span>
<span class="ln">10</span>    <span class="p">});</span>
<span class="ln">11</span>
<span class="ln">12</span>    <span class="k">if</span> <span class="p">(</span><span class="n">for_emulator</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">13</span>        <span class="n">ImportKernelCmdline</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">14</span>            <span class="c1">// In the emulator, export any kernel option with the &#34;ro.kernel.&#34; prefix.
</span><span class="ln">15</span><span class="c1"></span>            <span class="n">InitPropertySet</span><span class="p">(</span><span class="s">&#34;ro.kernel.&#34;</span> <span class="o">+</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="ln">16</span>        <span class="p">});</span>
<span class="ln">17</span>    <span class="p">}</span>
<span class="ln">18</span><span class="p">}</span>
</code></pre></div><p>主要展开讲一下<code>ProcessKernelCmdline</code>，主要是处理<code>kernel</code>预设的<code>Cmdline</code>的一些属性（在Android系统中，可以用<code>cat /proc/cmdline</code>查看），并且把<code>androidboot.</code>前缀的<code>key</code>值找出来，修改成<code>ro.boot.</code>的<code>key</code>，和把<code>androidboot.</code>前缀的对应的<code>value</code>值形成预设的属性值。</p>
<p>如果需要自定义一些在kernel阶段预设的属性进行设置，可以在<code>Uboot</code>阶段，进行设置</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln">1</span><span class="c1">//类似把androidboot.abc放入到cmdline中
</span><span class="ln">2</span><span class="c1">//Uboot代码中的setup_bootenv函数添加下面的语句
</span><span class="ln">3</span><span class="c1"></span><span class="n">Setenv2Bootargs</span><span class="p">(</span><span class="s">&#34;androidboot.abc=&#34;</span><span class="p">,</span> <span class="s">&#34;yangyang48&#34;</span><span class="p">);</span>
</code></pre></div><p>然后可以在设备上打印具体的<code>cmdline</code></p>
<div class="highlight"><pre class="chroma"><code class="language-txt" data-lang="txt"><span class="ln">1</span>vince:/ # cat /proc/cmdline
<span class="ln">2</span>cat /proc/cmdline
<span class="ln">3</span>sched_enable_hmp=1 sched_enable_power_aware=1 console=ttyHSL0,115200,n8 androidboot.console=ttyHSL0 androidboot.hardware=qcom msm_rtb.filter=0x237 ehci-hcd.park=3 lpm_levels.sleep_disabled=1 androidboot.bootdevice=7824900.sdhci earlycon=msm_hsl_uart,0x78af000 buildvariant=user androidboot.emmc=true androidboot.verifiedbootstate=orange androidboot.veritymode=enforcing androidboot.keymaster=1 ddr_sorting=undo androidboot.abc=yangyang48 androidboot.serialno=357370480904 androidboot.secureboot=1 androidboot.product.region=cn androidboot.bootloader=MSM8953_DAISY1.0_20190902222450 androidboot.baseband=msm mdss_mdp.panel=1:dsi:0:qcom,mdss_dsi_td4310_fhdplus_video_e7:wpoint=03:1:none:cfg:single_dsi
</code></pre></div><p>通过上面的<code>ProcessKernelCmdline</code>，可以得知属性<code>ro.boot.abc</code>会被设置进去</p>
<h3 id="143exportkernelbootprops">1.4.3ExportKernelBootProps</h3>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//system/core/init/property_service.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="k">static</span> <span class="kt">void</span> <span class="nf">ExportKernelBootProps</span><span class="p">()</span> <span class="p">{</span>
<span class="ln"> 3</span>    <span class="k">constexpr</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">UNSET</span> <span class="o">=</span> <span class="s">&#34;&#34;</span><span class="p">;</span>
<span class="ln"> 4</span>    <span class="k">struct</span> <span class="p">{</span>
<span class="ln"> 5</span>        <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">src_prop</span><span class="p">;</span>
<span class="ln"> 6</span>        <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">dst_prop</span><span class="p">;</span>
<span class="ln"> 7</span>        <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">default_value</span><span class="p">;</span>
<span class="ln"> 8</span>    <span class="p">}</span> <span class="n">prop_map</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="ln"> 9</span>            <span class="c1">// clang-format off
</span><span class="ln">10</span><span class="c1"></span>        <span class="p">{</span> <span class="s">&#34;ro.boot.serialno&#34;</span><span class="p">,</span>   <span class="s">&#34;ro.serialno&#34;</span><span class="p">,</span>   <span class="n">UNSET</span><span class="p">,</span> <span class="p">},</span>
<span class="ln">11</span>        <span class="p">{</span> <span class="s">&#34;ro.boot.mode&#34;</span><span class="p">,</span>       <span class="s">&#34;ro.bootmode&#34;</span><span class="p">,</span>   <span class="s">&#34;unknown&#34;</span><span class="p">,</span> <span class="p">},</span>
<span class="ln">12</span>        <span class="p">{</span> <span class="s">&#34;ro.boot.baseband&#34;</span><span class="p">,</span>   <span class="s">&#34;ro.baseband&#34;</span><span class="p">,</span>   <span class="s">&#34;unknown&#34;</span><span class="p">,</span> <span class="p">},</span>
<span class="ln">13</span>        <span class="p">{</span> <span class="s">&#34;ro.boot.bootloader&#34;</span><span class="p">,</span> <span class="s">&#34;ro.bootloader&#34;</span><span class="p">,</span> <span class="s">&#34;unknown&#34;</span><span class="p">,</span> <span class="p">},</span>
<span class="ln">14</span>        <span class="p">{</span> <span class="s">&#34;ro.boot.hardware&#34;</span><span class="p">,</span>   <span class="s">&#34;ro.hardware&#34;</span><span class="p">,</span>   <span class="s">&#34;unknown&#34;</span><span class="p">,</span> <span class="p">},</span>
<span class="ln">15</span>        <span class="p">{</span> <span class="s">&#34;ro.boot.revision&#34;</span><span class="p">,</span>   <span class="s">&#34;ro.revision&#34;</span><span class="p">,</span>   <span class="s">&#34;0&#34;</span><span class="p">,</span> <span class="p">},</span>
<span class="ln">16</span>            <span class="c1">// clang-format on
</span><span class="ln">17</span><span class="c1"></span>    <span class="p">};</span>
<span class="ln">18</span>    <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">prop</span> <span class="p">:</span> <span class="n">prop_map</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">19</span>        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">value</span> <span class="o">=</span> <span class="n">GetProperty</span><span class="p">(</span><span class="n">prop</span><span class="p">.</span><span class="n">src_prop</span><span class="p">,</span> <span class="n">prop</span><span class="p">.</span><span class="n">default_value</span><span class="p">);</span>
<span class="ln">20</span>        <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="n">UNSET</span><span class="p">)</span> <span class="n">InitPropertySet</span><span class="p">(</span><span class="n">prop</span><span class="p">.</span><span class="n">dst_prop</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="ln">21</span>    <span class="p">}</span>
<span class="ln">22</span><span class="p">}</span>
</code></pre></div><p><code>ro.serialno</code>， 可见它是从内核启动参数<code>ro.boot.serialno</code>，如果这些<code>ro</code>属性没有被设置，那么通过这里的初始化来设置属性。</p>
<h3 id="144propertyloadbootdefaults">1.4.4PropertyLoadBootDefaults</h3>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="kt">void</span> <span class="nf">PropertyLoadBootDefaults</span><span class="p">()</span> <span class="p">{</span>
<span class="ln"> 2</span>    <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">properties</span><span class="p">;</span>
<span class="ln"> 3</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">load_properties_from_file</span><span class="p">(</span><span class="s">&#34;/system/etc/prop.default&#34;</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">properties</span><span class="p">))</span> <span class="p">{</span>
<span class="ln"> 4</span>        <span class="c1">// Try recovery path
</span><span class="ln"> 5</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">load_properties_from_file</span><span class="p">(</span><span class="s">&#34;/prop.default&#34;</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">properties</span><span class="p">))</span> <span class="p">{</span>
<span class="ln"> 6</span>            <span class="c1">// Try legacy path
</span><span class="ln"> 7</span><span class="c1"></span>            <span class="n">load_properties_from_file</span><span class="p">(</span><span class="s">&#34;/default.prop&#34;</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">properties</span><span class="p">);</span>
<span class="ln"> 8</span>        <span class="p">}</span>
<span class="ln"> 9</span>    <span class="p">}</span>
<span class="ln">10</span>    <span class="n">load_properties_from_file</span><span class="p">(</span><span class="s">&#34;/system/build.prop&#34;</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">properties</span><span class="p">);</span>
<span class="ln">11</span>    <span class="n">load_properties_from_file</span><span class="p">(</span><span class="s">&#34;/system_ext/build.prop&#34;</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">properties</span><span class="p">);</span>
<span class="ln">12</span>    <span class="n">load_properties_from_file</span><span class="p">(</span><span class="s">&#34;/vendor/default.prop&#34;</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">properties</span><span class="p">);</span>
<span class="ln">13</span>    <span class="n">load_properties_from_file</span><span class="p">(</span><span class="s">&#34;/vendor/build.prop&#34;</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">properties</span><span class="p">);</span>
<span class="ln">14</span>    <span class="k">if</span> <span class="p">(</span><span class="n">SelinuxGetVendorAndroidVersion</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">__ANDROID_API_Q__</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">15</span>        <span class="n">load_properties_from_file</span><span class="p">(</span><span class="s">&#34;/odm/etc/build.prop&#34;</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">properties</span><span class="p">);</span>
<span class="ln">16</span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="ln">17</span>        <span class="n">load_properties_from_file</span><span class="p">(</span><span class="s">&#34;/odm/default.prop&#34;</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">properties</span><span class="p">);</span>
<span class="ln">18</span>        <span class="n">load_properties_from_file</span><span class="p">(</span><span class="s">&#34;/odm/build.prop&#34;</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">properties</span><span class="p">);</span>
<span class="ln">19</span>    <span class="p">}</span>
<span class="ln">20</span>    <span class="n">load_properties_from_file</span><span class="p">(</span><span class="s">&#34;/product/build.prop&#34;</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">properties</span><span class="p">);</span>
<span class="ln">21</span>    <span class="n">load_properties_from_file</span><span class="p">(</span><span class="s">&#34;/factory/factory.prop&#34;</span><span class="p">,</span> <span class="s">&#34;ro.*&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">properties</span><span class="p">);</span>
<span class="ln">22</span>
<span class="ln">23</span>    <span class="k">if</span> <span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">kDebugRamdiskProp</span><span class="p">,</span> <span class="n">R_OK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">24</span>        <span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Loading &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">kDebugRamdiskProp</span><span class="p">;</span>
<span class="ln">25</span>        <span class="n">load_properties_from_file</span><span class="p">(</span><span class="n">kDebugRamdiskProp</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">properties</span><span class="p">);</span>
<span class="ln">26</span>    <span class="p">}</span>
<span class="ln">27</span>
<span class="ln">28</span>    <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="p">[</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">]</span> <span class="o">:</span> <span class="n">properties</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">29</span>        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">error</span><span class="p">;</span>
<span class="ln">30</span>        <span class="k">if</span> <span class="p">(</span><span class="n">PropertySet</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PROP_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">31</span>            <span class="n">LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Could not set &#39;&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">name</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;&#39; to &#39;&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">value</span>
<span class="ln">32</span>                       <span class="o">&lt;&lt;</span> <span class="s">&#34;&#39; while loading .prop files&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">error</span><span class="p">;</span>
<span class="ln">33</span>        <span class="p">}</span>
<span class="ln">34</span>    <span class="p">}</span>
<span class="ln">35</span>    <span class="c1">//关于ro.product.[brand|device|manufacturer|model|name]属性的配置
</span><span class="ln">36</span><span class="c1"></span>    <span class="n">property_initialize_ro_product_props</span><span class="p">();</span>
<span class="ln">37</span>    <span class="c1">//关于ro.build.[fingerprint|brand|name|device|version|id|type|tags]属性的配置
</span><span class="ln">38</span><span class="c1"></span>    <span class="n">property_derive_build_fingerprint</span><span class="p">();</span>
<span class="ln">39</span>	<span class="c1">//persist.sys.usb.config是否是adb连接，笔者连接时[persist.sys.usb.config]: [mtp,adb]
</span><span class="ln">40</span><span class="c1"></span>    <span class="n">update_sys_usb_config</span><span class="p">();</span>
<span class="ln">41</span><span class="p">}</span>
</code></pre></div><p>这个函数是用于导入一些默认的属性配置，一般工程开发会在这里面添加一些关于自定义但需要开机设置的一些属性。可以看到上面的属性都可以在这个阶段来进行初始化设置，属性会被添加到属性对应的<code>SElinux</code>域文件中。</p>
<p>通过键值对<code>map</code>来获取这些配置文件里面的属性，然后统一设置<strong>开机预置</strong>属性。(<code>map</code>默认按照<code>key</code>从小到大进行排序)</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/property/property_3.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/property/property_3.png" >
  
    </a>
  
  
</div>

<h2 id="2startpropertyservice">2StartPropertyService</h2>
<p>用于属性服务的初始化，这个服务是用于管控属性设置的</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//system/core/init/property_service.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="kt">void</span> <span class="nf">StartPropertyService</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span> <span class="n">epoll_socket</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 3</span>    <span class="n">InitPropertySet</span><span class="p">(</span><span class="s">&#34;ro.property_service.version&#34;</span><span class="p">,</span> <span class="s">&#34;2&#34;</span><span class="p">);</span>
<span class="ln"> 4</span>    <span class="c1">//初始化了双工通信，这里用于本地通信
</span><span class="ln"> 5</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">sockets</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="ln"> 6</span>    <span class="k">if</span> <span class="p">(</span><span class="n">socketpair</span><span class="p">(</span><span class="n">AF_UNIX</span><span class="p">,</span> <span class="n">SOCK_SEQPACKET</span> <span class="o">|</span> <span class="n">SOCK_CLOEXEC</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sockets</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 7</span>        <span class="n">PLOG</span><span class="p">(</span><span class="n">FATAL</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Failed to socketpair() between property_service and init&#34;</span><span class="p">;</span>
<span class="ln"> 8</span>    <span class="p">}</span>
<span class="ln"> 9</span>    <span class="c1">//这里的epoll_socket会被作为双工通信的发送端
</span><span class="ln">10</span><span class="c1"></span>    <span class="o">*</span><span class="n">epoll_socket</span> <span class="o">=</span> <span class="n">from_init_socket</span> <span class="o">=</span> <span class="n">sockets</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="ln">11</span>    <span class="c1">//这里的init_socket会被作为双工通信的接收端
</span><span class="ln">12</span><span class="c1"></span>    <span class="n">init_socket</span> <span class="o">=</span> <span class="n">sockets</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="ln">13</span>    <span class="c1">//这个用于rc文件中属性发生变化的时候的作用
</span><span class="ln">14</span><span class="c1"></span>    <span class="n">StartSendingMessages</span><span class="p">();</span>
<span class="ln">15</span>    <span class="c1">//建立一个socket，用于管理属性服务
</span><span class="ln">16</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="k">auto</span> <span class="n">result</span> <span class="o">=</span> <span class="n">CreateSocket</span><span class="p">(</span><span class="n">PROP_SERVICE_NAME</span><span class="p">,</span> <span class="n">SOCK_STREAM</span> <span class="o">|</span> <span class="n">SOCK_CLOEXEC</span> <span class="o">|</span> <span class="n">SOCK_NONBLOCK</span><span class="p">,</span>
<span class="ln">17</span>                                   <span class="nb">false</span><span class="p">,</span> <span class="mo">0666</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">{});</span>
<span class="ln">18</span>        <span class="n">result</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
<span class="ln">19</span>        <span class="n">property_set_fd</span> <span class="o">=</span> <span class="o">*</span><span class="n">result</span><span class="p">;</span>
<span class="ln">20</span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="ln">21</span>        <span class="n">LOG</span><span class="p">(</span><span class="n">FATAL</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;start_property_service socket creation failed: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">result</span><span class="p">.</span><span class="n">error</span><span class="p">();</span>
<span class="ln">22</span>    <span class="p">}</span>
<span class="ln">23</span>    <span class="c1">//监听socket，accept 队列长度为8，也就是已完成连接建立的队列长度
</span><span class="ln">24</span><span class="c1"></span>    <span class="n">listen</span><span class="p">(</span><span class="n">property_set_fd</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
<span class="ln">25</span>
<span class="ln">26</span>    <span class="k">auto</span> <span class="n">new_thread</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="p">{</span><span class="n">PropertyServiceThread</span><span class="p">};</span>
<span class="ln">27</span>    <span class="n">property_service_thread</span><span class="p">.</span><span class="n">swap</span><span class="p">(</span><span class="n">new_thread</span><span class="p">);</span>
<span class="ln">28</span><span class="p">}</span>
</code></pre></div><h2 id="21startsendingmessages">2.1StartSendingMessages</h2>
<p>主要是为了设置一个true的一个flag值，用于<code>rc</code>文件中的属性变化来起到触发作用</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln">1</span><span class="c1">//system/core/init/property_service.cpp
</span><span class="ln">2</span><span class="c1"></span><span class="kt">void</span> <span class="nf">StartSendingMessages</span><span class="p">()</span> <span class="p">{</span>
<span class="ln">3</span>    <span class="k">auto</span> <span class="n">lock</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="p">{</span><span class="n">accept_messages_lock</span><span class="p">};</span>
<span class="ln">4</span>    <span class="n">accept_messages</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="ln">5</span><span class="p">}</span>
</code></pre></div><blockquote>
<p>关于lock_guard也是一种比较新的特性，更加方便。<strong>构造时候加锁，析构的时候解锁</strong>，具体可以点击<a href="https://blog.csdn.net/gehong3641/article/details/124028976">这里</a>。</p>
<ol>
<li>
<p>lock_guard具有两种构造方法</p>
<p><code>lock_guard(mutex&amp; m)</code>，这种构造会加锁</p>
<p><code>lock_guard(mutex&amp; m, adopt_lock)</code>，这种构造不会加锁</p>
</li>
<li>
<p>lock_guard默认的析构方法</p>
<p>~lock_guard()，用于解锁</p>
</li>
</ol>
</blockquote>
<h2 id="22createsocket">2.2CreateSocket</h2>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//system/core/init/util.cpp
</span><span class="ln"> 2</span><span class="c1">//传入的name为&#34;property_service&#34;，passcred为false，perm为0666，uid，gid为0
</span><span class="ln"> 3</span><span class="c1"></span><span class="n">Result</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">CreateSocket</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">passcred</span><span class="p">,</span> <span class="n">mode_t</span> <span class="n">perm</span><span class="p">,</span> <span class="n">uid_t</span> <span class="n">uid</span><span class="p">,</span>
<span class="ln"> 4</span>                         <span class="n">gid_t</span> <span class="n">gid</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">socketcon</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 5</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">socketcon</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
<span class="ln"> 6</span>        <span class="k">if</span> <span class="p">(</span><span class="n">setsockcreatecon</span><span class="p">(</span><span class="n">socketcon</span><span class="p">.</span><span class="n">c_str</span><span class="p">())</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 7</span>            <span class="k">return</span> <span class="nf">ErrnoError</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;setsockcreatecon(</span><span class="se">\&#34;</span><span class="s">&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">socketcon</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;</span><span class="se">\&#34;</span><span class="s">) failed&#34;</span><span class="p">;</span>
<span class="ln"> 8</span>        <span class="p">}</span>
<span class="ln"> 9</span>    <span class="p">}</span>
<span class="ln">10</span>    <span class="c1">//使用本地协议PF_UNIX(或PF_LOCAL),type中包含SOCK_STREAM，因此创建本地通信的流式套接字为fd
</span><span class="ln">11</span><span class="c1"></span>    <span class="n">android</span><span class="o">::</span><span class="n">base</span><span class="o">::</span><span class="n">unique_fd</span> <span class="n">fd</span><span class="p">(</span><span class="n">socket</span><span class="p">(</span><span class="n">PF_UNIX</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
<span class="ln">12</span>    <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">13</span>        <span class="k">return</span> <span class="nf">ErrnoError</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Failed to open socket &#39;&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">name</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;&#39;&#34;</span><span class="p">;</span>
<span class="ln">14</span>    <span class="p">}</span>
<span class="ln">15</span>
<span class="ln">16</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">socketcon</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="n">setsockcreatecon</span><span class="p">(</span><span class="k">nullptr</span><span class="p">);</span>
<span class="ln">17</span>
<span class="ln">18</span>    <span class="k">struct</span> <span class="nc">sockaddr_un</span> <span class="n">addr</span><span class="p">;</span>
<span class="ln">19</span>    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">addr</span><span class="p">));</span>
<span class="ln">20</span>    <span class="n">addr</span><span class="p">.</span><span class="n">sun_family</span> <span class="o">=</span> <span class="n">AF_UNIX</span><span class="p">;</span>
<span class="ln">21</span>    <span class="c1">//ANDROID_SOCKET_DIR为&#34;/dev/socket&#34;，那么addr.sun_path为&#34;/dev/socket/property_service&#34;
</span><span class="ln">22</span><span class="c1"></span>    <span class="n">snprintf</span><span class="p">(</span><span class="n">addr</span><span class="p">.</span><span class="n">sun_path</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">addr</span><span class="p">.</span><span class="n">sun_path</span><span class="p">),</span> <span class="n">ANDROID_SOCKET_DIR</span> <span class="s">&#34;/%s&#34;</span><span class="p">,</span> <span class="n">name</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="ln">23</span>
<span class="ln">24</span>    <span class="k">if</span> <span class="p">((</span><span class="n">unlink</span><span class="p">(</span><span class="n">addr</span><span class="p">.</span><span class="n">sun_path</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">ENOENT</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">25</span>        <span class="k">return</span> <span class="nf">ErrnoError</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Failed to unlink old socket &#39;&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">name</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;&#39;&#34;</span><span class="p">;</span>
<span class="ln">26</span>    <span class="p">}</span>
<span class="ln">27</span>
<span class="ln">28</span>    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">secontext</span><span class="p">;</span>
<span class="ln">29</span>    <span class="c1">//对路径addr.sun_path的权限检测
</span><span class="ln">30</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">SelabelLookupFileContext</span><span class="p">(</span><span class="n">addr</span><span class="p">.</span><span class="n">sun_path</span><span class="p">,</span> <span class="n">S_IFSOCK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">secontext</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">secontext</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
<span class="ln">31</span>        <span class="n">setfscreatecon</span><span class="p">(</span><span class="n">secontext</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="ln">32</span>    <span class="p">}</span>
<span class="ln">33</span>
<span class="ln">34</span>    <span class="k">if</span> <span class="p">(</span><span class="n">passcred</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">35</span>        <span class="kt">int</span> <span class="n">on</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="ln">36</span>        <span class="k">if</span> <span class="p">(</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">SO_PASSCRED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">on</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">on</span><span class="p">)))</span> <span class="p">{</span>
<span class="ln">37</span>            <span class="k">return</span> <span class="nf">ErrnoError</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Failed to set SO_PASSCRED &#39;&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">name</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;&#39;&#34;</span><span class="p">;</span>
<span class="ln">38</span>        <span class="p">}</span>
<span class="ln">39</span>    <span class="p">}</span>
<span class="ln">40</span>
<span class="ln">41</span>    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">bind</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="nc">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">addr</span><span class="p">));</span>
<span class="ln">42</span>    <span class="kt">int</span> <span class="n">savederrno</span> <span class="o">=</span> <span class="n">errno</span><span class="p">;</span>
<span class="ln">43</span>    <span class="p">...</span>
<span class="ln">44</span>    <span class="k">return</span> <span class="n">fd</span><span class="p">.</span><span class="n">release</span><span class="p">();</span>
<span class="ln">45</span><span class="p">}</span>
</code></pre></div><p>创建了一个本地的<code>socket</code>，且路径为<code>/dev/socket/property_service</code></p>
<h2 id="23propertyservicethread">2.3PropertyServiceThread</h2>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//system/core/init/property_service.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="k">static</span> <span class="kt">void</span> <span class="nf">PropertyServiceThread</span><span class="p">()</span> <span class="p">{</span>
<span class="ln"> 3</span>    <span class="n">Epoll</span> <span class="n">epoll</span><span class="p">;</span>
<span class="ln"> 4</span>    <span class="k">if</span> <span class="p">(</span><span class="k">auto</span> <span class="n">result</span> <span class="o">=</span> <span class="n">epoll</span><span class="p">.</span><span class="n">Open</span><span class="p">();</span> <span class="o">!</span><span class="n">result</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
<span class="ln"> 5</span>        <span class="n">LOG</span><span class="p">(</span><span class="n">FATAL</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">result</span><span class="p">.</span><span class="n">error</span><span class="p">();</span>
<span class="ln"> 6</span>    <span class="p">}</span>
<span class="ln"> 7</span>    <span class="c1">//这里是封装了一层系统调用的epoll，通过监听fd来完成对函数的调用
</span><span class="ln"> 8</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="k">auto</span> <span class="n">result</span> <span class="o">=</span> <span class="n">epoll</span><span class="p">.</span><span class="n">RegisterHandler</span><span class="p">(</span><span class="n">property_set_fd</span><span class="p">,</span> <span class="n">handle_property_set_fd</span><span class="p">);</span>
<span class="ln"> 9</span>        <span class="o">!</span><span class="n">result</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
<span class="ln">10</span>        <span class="n">LOG</span><span class="p">(</span><span class="n">FATAL</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">result</span><span class="p">.</span><span class="n">error</span><span class="p">();</span>
<span class="ln">11</span>    <span class="p">}</span>
<span class="ln">12</span>    <span class="c1">//这里是封装了一层系统调用的epoll，通过监听fd来完成对函数的调用
</span><span class="ln">13</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="k">auto</span> <span class="n">result</span> <span class="o">=</span> <span class="n">epoll</span><span class="p">.</span><span class="n">RegisterHandler</span><span class="p">(</span><span class="n">init_socket</span><span class="p">,</span> <span class="n">HandleInitSocket</span><span class="p">);</span> <span class="o">!</span><span class="n">result</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
<span class="ln">14</span>        <span class="n">LOG</span><span class="p">(</span><span class="n">FATAL</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">result</span><span class="p">.</span><span class="n">error</span><span class="p">();</span>
<span class="ln">15</span>    <span class="p">}</span>
<span class="ln">16</span>    
<span class="ln">17</span>    <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">18</span>        <span class="k">auto</span> <span class="n">pending_functions</span> <span class="o">=</span> <span class="n">epoll</span><span class="p">.</span><span class="n">Wait</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">nullopt</span><span class="p">);</span>
<span class="ln">19</span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pending_functions</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
<span class="ln">20</span>            <span class="n">LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">pending_functions</span><span class="p">.</span><span class="n">error</span><span class="p">();</span>
<span class="ln">21</span>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="ln">22</span>            <span class="c1">//当上面的fd发生变化的时候，立刻调用对应注册的函数
</span><span class="ln">23</span><span class="c1"></span>            <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">function</span> <span class="p">:</span> <span class="o">*</span><span class="n">pending_functions</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">24</span>                <span class="p">(</span><span class="o">*</span><span class="n">function</span><span class="p">)();</span>
<span class="ln">25</span>            <span class="p">}</span>
<span class="ln">26</span>        <span class="p">}</span>
<span class="ln">27</span>    <span class="p">}</span>
<span class="ln">28</span><span class="p">}</span>
</code></pre></div><h3 id="231handle_property_set_fd">2.3.1handle_property_set_fd</h3>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//system/core/init/property_service.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_property_set_fd</span><span class="p">()</span> <span class="p">{</span>
<span class="ln"> 3</span>    <span class="k">static</span> <span class="k">constexpr</span> <span class="kt">uint32_t</span> <span class="n">kDefaultSocketTimeout</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">;</span> <span class="cm">/* ms */</span>
<span class="ln"> 4</span>    <span class="c1">//SOCK_CLOEXEC，用于防止父进程泄露打开的文件给子进程
</span><span class="ln"> 5</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="n">accept4</span><span class="p">(</span><span class="n">property_set_fd</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">,</span> <span class="n">SOCK_CLOEXEC</span><span class="p">);</span>
<span class="ln"> 6</span>    <span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 7</span>        <span class="k">return</span><span class="p">;</span>
<span class="ln"> 8</span>    <span class="p">}</span>
<span class="ln"> 9</span>
<span class="ln">10</span>    <span class="n">ucred</span> <span class="n">cr</span><span class="p">;</span>
<span class="ln">11</span>    <span class="n">socklen_t</span> <span class="n">cr_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cr</span><span class="p">);</span>
<span class="ln">12</span>    <span class="k">if</span> <span class="p">(</span><span class="n">getsockopt</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">SO_PEERCRED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cr_size</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">13</span>        <span class="n">close</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
<span class="ln">14</span>        <span class="n">PLOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;sys_prop: unable to get SO_PEERCRED&#34;</span><span class="p">;</span>
<span class="ln">15</span>        <span class="k">return</span><span class="p">;</span>
<span class="ln">16</span>    <span class="p">}</span>
<span class="ln">17</span>    <span class="c1">//将原本socket的句柄转交给SocketConnection，SocketConnection实际上也是用poll机制的封装
</span><span class="ln">18</span><span class="c1"></span>    <span class="n">SocketConnection</span> <span class="n">socket</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">cr</span><span class="p">);</span>
<span class="ln">19</span>    <span class="kt">uint32_t</span> <span class="n">timeout_ms</span> <span class="o">=</span> <span class="n">kDefaultSocketTimeout</span><span class="p">;</span>
<span class="ln">20</span>
<span class="ln">21</span>    <span class="kt">uint32_t</span> <span class="n">cmd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="ln">22</span>    <span class="c1">//接收消息，超过2s就自动退出
</span><span class="ln">23</span><span class="c1"></span>    <span class="c1">//消息体接收分别是cmd，name，value，context
</span><span class="ln">24</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">socket</span><span class="p">.</span><span class="n">RecvUint32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timeout_ms</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">25</span>        <span class="n">PLOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;sys_prop: error while reading command from the socket&#34;</span><span class="p">;</span>
<span class="ln">26</span>        <span class="n">socket</span><span class="p">.</span><span class="n">SendUint32</span><span class="p">(</span><span class="n">PROP_ERROR_READ_CMD</span><span class="p">);</span>
<span class="ln">27</span>        <span class="k">return</span><span class="p">;</span>
<span class="ln">28</span>    <span class="p">}</span>
<span class="ln">29</span>    <span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">30</span>    <span class="c1">//PROP_MSG_SETPROP这个是老版本的魔数，Android11已经不使用这个api了
</span><span class="ln">31</span><span class="c1"></span>    <span class="k">case</span> <span class="nl">PROP_MSG_SETPROP</span><span class="p">:</span> 
<span class="ln">32</span>         <span class="p">...</span>
<span class="ln">33</span>         <span class="k">break</span><span class="p">;</span>    
<span class="ln">34</span>    <span class="k">case</span> <span class="nl">PROP_MSG_SETPROP2</span><span class="p">:</span> <span class="p">{</span>
<span class="ln">35</span>        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name</span><span class="p">;</span>
<span class="ln">36</span>        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">value</span><span class="p">;</span>
<span class="ln">37</span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">socket</span><span class="p">.</span><span class="n">RecvString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timeout_ms</span><span class="p">)</span> <span class="o">||</span>
<span class="ln">38</span>            <span class="o">!</span><span class="n">socket</span><span class="p">.</span><span class="n">RecvString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timeout_ms</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">39</span>          <span class="n">PLOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;sys_prop(PROP_MSG_SETPROP2): error while reading name/value from the socket&#34;</span><span class="p">;</span>
<span class="ln">40</span>          <span class="n">socket</span><span class="p">.</span><span class="n">SendUint32</span><span class="p">(</span><span class="n">PROP_ERROR_READ_DATA</span><span class="p">);</span>
<span class="ln">41</span>          <span class="k">return</span><span class="p">;</span>
<span class="ln">42</span>        <span class="p">}</span>
<span class="ln">43</span>
<span class="ln">44</span>        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">source_context</span><span class="p">;</span>
<span class="ln">45</span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">socket</span><span class="p">.</span><span class="n">GetSourceContext</span><span class="p">(</span><span class="o">&amp;</span><span class="n">source_context</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">46</span>            <span class="n">PLOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Unable to set property &#39;&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">name</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;&#39;: getpeercon() failed&#34;</span><span class="p">;</span>
<span class="ln">47</span>            <span class="n">socket</span><span class="p">.</span><span class="n">SendUint32</span><span class="p">(</span><span class="n">PROP_ERROR_PERMISSION_DENIED</span><span class="p">);</span>
<span class="ln">48</span>            <span class="k">return</span><span class="p">;</span>
<span class="ln">49</span>        <span class="p">}</span>
<span class="ln">50</span>
<span class="ln">51</span>        <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">cr</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">cred</span><span class="p">();</span>
<span class="ln">52</span>        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">error</span><span class="p">;</span>
<span class="ln">53</span>        <span class="c1">//这里的接收比较简单，最终调用到HandlePropertySet这个地方
</span><span class="ln">54</span><span class="c1"></span>        <span class="kt">uint32_t</span> <span class="n">result</span> <span class="o">=</span> <span class="n">HandlePropertySet</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">source_context</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">socket</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
<span class="ln">55</span>        <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="n">PROP_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">56</span>            <span class="n">LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Unable to set property &#39;&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">name</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;&#39; from uid:&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">cr</span><span class="p">.</span><span class="n">uid</span>
<span class="ln">57</span>                       <span class="o">&lt;&lt;</span> <span class="s">&#34; gid:&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">cr</span><span class="p">.</span><span class="n">gid</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; pid:&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">cr</span><span class="p">.</span><span class="n">pid</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">error</span><span class="p">;</span>
<span class="ln">58</span>        <span class="p">}</span>
<span class="ln">59</span>        <span class="c1">//把成功的结果PROP_SUCCESS发送给对端
</span><span class="ln">60</span><span class="c1"></span>        <span class="n">socket</span><span class="p">.</span><span class="n">SendUint32</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
<span class="ln">61</span>        <span class="k">break</span><span class="p">;</span>
<span class="ln">62</span>      <span class="p">}</span>
<span class="ln">63</span>
<span class="ln">64</span>    <span class="k">default</span><span class="o">:</span>
<span class="ln">65</span>        <span class="n">LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;sys_prop: invalid command &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">cmd</span><span class="p">;</span>
<span class="ln">66</span>        <span class="n">socket</span><span class="p">.</span><span class="n">SendUint32</span><span class="p">(</span><span class="n">PROP_ERROR_INVALID_CMD</span><span class="p">);</span>
<span class="ln">67</span>        <span class="k">break</span><span class="p">;</span>
<span class="ln">68</span>    <span class="p">}</span>
<span class="ln">69</span><span class="p">}</span>
</code></pre></div><p>这里主要分成几块，将原本创建的本地通信的流式套接字移交给poll机制封装的<code>SocketConnection</code>，通过<code>SocketConnection</code>来完成对消息体的接收，然后消息体正常接收会调用到<code>HandlePropertySet</code>，这个地方用于设置属性。</p>
<h3 id="232handleinitsocket">2.3.2HandleInitSocket</h3>
<p>这个函数主要是处理persist属性的初始化，初始化会把文件中的persist属性导入到文件中去，导入完成之后在设置persist属性，并且设置一个完成导入属性的属性，<code>ro.persistent_properties.ready</code>的属性值为true，说明persist导入文件和设置属性完成。</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//system/core/init/property_service.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="k">static</span> <span class="kt">void</span> <span class="nf">HandleInitSocket</span><span class="p">()</span> <span class="p">{</span>
<span class="ln"> 3</span>    <span class="k">auto</span> <span class="n">message</span> <span class="o">=</span> <span class="n">ReadMessage</span><span class="p">(</span><span class="n">init_socket</span><span class="p">);</span>
<span class="ln"> 4</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">message</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
<span class="ln"> 5</span>        <span class="n">LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Could not read message from init_dedicated_recv_socket: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">message</span><span class="p">.</span><span class="n">error</span><span class="p">();</span>
<span class="ln"> 6</span>        <span class="k">return</span><span class="p">;</span>
<span class="ln"> 7</span>    <span class="p">}</span>
<span class="ln"> 8</span>    <span class="c1">//这里的InitMessage其实也是一个类，不过是proto格式转化为对应的c++格式的类
</span><span class="ln"> 9</span><span class="c1"></span>    <span class="k">auto</span> <span class="n">init_message</span> <span class="o">=</span> <span class="n">InitMessage</span><span class="p">{};</span>
<span class="ln">10</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">init_message</span><span class="p">.</span><span class="n">ParseFromString</span><span class="p">(</span><span class="o">*</span><span class="n">message</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">11</span>        <span class="n">LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Could not parse message from init&#34;</span><span class="p">;</span>
<span class="ln">12</span>        <span class="k">return</span><span class="p">;</span>
<span class="ln">13</span>    <span class="p">}</span>
<span class="ln">14</span>
<span class="ln">15</span>    <span class="k">switch</span> <span class="p">(</span><span class="n">init_message</span><span class="p">.</span><span class="n">msg_case</span><span class="p">())</span> <span class="p">{</span>
<span class="ln">16</span>        <span class="k">case</span> <span class="n">InitMessage</span><span class="o">::</span><span class="nl">kLoadPersistentProperties</span><span class="p">:</span> <span class="p">{</span>
<span class="ln">17</span>            <span class="n">load_override_properties</span><span class="p">();</span>
<span class="ln">18</span>            <span class="c1">//这里的persistent_properties的类是persistent_properties.proto中定义的
</span><span class="ln">19</span><span class="c1"></span>            <span class="k">auto</span> <span class="n">persistent_properties</span> <span class="o">=</span> <span class="n">LoadPersistentProperties</span><span class="p">();</span>
<span class="ln">20</span>            <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">persistent_property_record</span> <span class="p">:</span> <span class="n">persistent_properties</span><span class="p">.</span><span class="n">properties</span><span class="p">())</span> <span class="p">{</span>
<span class="ln">21</span>                <span class="n">InitPropertySet</span><span class="p">(</span><span class="n">persistent_property_record</span><span class="p">.</span><span class="n">name</span><span class="p">(),</span>
<span class="ln">22</span>                                <span class="n">persistent_property_record</span><span class="p">.</span><span class="n">value</span><span class="p">());</span>
<span class="ln">23</span>            <span class="p">}</span>
<span class="ln">24</span>            <span class="n">InitPropertySet</span><span class="p">(</span><span class="s">&#34;ro.persistent_properties.ready&#34;</span><span class="p">,</span> <span class="s">&#34;true&#34;</span><span class="p">);</span>
<span class="ln">25</span>            <span class="c1">//这个变量会在后面的设置属性中用到，如果这里没有初始化成功，后续的persist对应文件将无法保存
</span><span class="ln">26</span><span class="c1"></span>            <span class="n">persistent_properties_loaded</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="ln">27</span>            <span class="k">break</span><span class="p">;</span>
<span class="ln">28</span>        <span class="p">}</span>
<span class="ln">29</span>        <span class="k">default</span><span class="o">:</span>
<span class="ln">30</span>            <span class="n">LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Unknown message type from init: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">init_message</span><span class="p">.</span><span class="n">msg_case</span><span class="p">();</span>
<span class="ln">31</span>    <span class="p">}</span>
<span class="ln">32</span><span class="p">}</span>
</code></pre></div><p><code>InitMessage</code>这个类真正定义的地方，可以简单的理解为是一个<strong>序列化的消息体</strong>。而且<code>protobuf</code>会将对应的<code>proto</code>文件中的变量<code>load_persistent_properties</code>，变成<code>kLoadPersistentProperties</code>，这就是为什么本文涉及到的好多源码的变量前会带有字母<code>k</code>。</p>
<div class="highlight"><pre class="chroma"><code class="language-protobuf" data-lang="protobuf"><span class="ln"> 1</span><span class="c1">//system/core/init/property_service.proto
</span><span class="ln"> 2</span><span class="c1"></span><span class="n">syntax</span> <span class="o">=</span> <span class="s">&#34;proto2&#34;</span><span class="p">;</span><span class="err">
</span><span class="ln"> 3</span><span class="err"></span><span class="k">option</span> <span class="n">optimize_for</span> <span class="o">=</span> <span class="n">LITE_RUNTIME</span><span class="p">;</span><span class="err">
</span><span class="ln"> 4</span><span class="err">
</span><span class="ln"> 5</span><span class="err"></span><span class="kd">message</span> <span class="nc">PropertyMessage</span> <span class="p">{</span><span class="err">
</span><span class="ln"> 6</span><span class="err"></span>    <span class="kd">message</span> <span class="nc">ControlMessage</span> <span class="p">{</span><span class="err">
</span><span class="ln"> 7</span><span class="err"></span>        <span class="k">optional</span> <span class="kt">string</span> <span class="n">msg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span><span class="ln"> 8</span><span class="err"></span>        <span class="k">optional</span> <span class="kt">string</span> <span class="n">name</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span><span class="err">
</span><span class="ln"> 9</span><span class="err"></span>        <span class="k">optional</span> <span class="kt">int32</span> <span class="n">pid</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span><span class="err">
</span><span class="ln">10</span><span class="err"></span>        <span class="k">optional</span> <span class="kt">int32</span> <span class="n">fd</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span><span class="err">
</span><span class="ln">11</span><span class="err"></span>    <span class="p">}</span><span class="err">
</span><span class="ln">12</span><span class="err">
</span><span class="ln">13</span><span class="err"></span>    <span class="kd">message</span> <span class="nc">ChangedMessage</span> <span class="p">{</span><span class="err">
</span><span class="ln">14</span><span class="err"></span>        <span class="k">optional</span> <span class="kt">string</span> <span class="n">name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span><span class="ln">15</span><span class="err"></span>        <span class="k">optional</span> <span class="kt">string</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span><span class="err">
</span><span class="ln">16</span><span class="err"></span>    <span class="p">}</span><span class="err">
</span><span class="ln">17</span><span class="err">
</span><span class="ln">18</span><span class="err"></span>    <span class="k">oneof</span> <span class="n">msg</span> <span class="p">{</span><span class="err">
</span><span class="ln">19</span><span class="err"></span>        <span class="n">ControlMessage</span> <span class="n">control_message</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span><span class="ln">20</span><span class="err"></span>        <span class="n">ChangedMessage</span> <span class="n">changed_message</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span><span class="err">
</span><span class="ln">21</span><span class="err"></span>    <span class="p">};</span><span class="err">
</span><span class="ln">22</span><span class="err"></span><span class="p">}</span><span class="err">
</span><span class="ln">23</span><span class="err">
</span><span class="ln">24</span><span class="err"></span><span class="kd">message</span> <span class="nc">InitMessage</span> <span class="p">{</span><span class="err">
</span><span class="ln">25</span><span class="err"></span>    <span class="c1">//oneof关键字，可以简单的理解为是联合体的数据结构
</span><span class="ln">26</span><span class="c1"></span>    <span class="k">oneof</span> <span class="n">msg</span> <span class="p">{</span><span class="err">
</span><span class="ln">27</span><span class="err"></span>        <span class="kt">bool</span> <span class="n">load_persistent_properties</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span><span class="ln">28</span><span class="err"></span>        <span class="kt">bool</span> <span class="n">stop_sending_messages</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span><span class="err">
</span><span class="ln">29</span><span class="err"></span>        <span class="kt">bool</span> <span class="n">start_sending_messages</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span><span class="err">
</span><span class="ln">30</span><span class="err"></span>    <span class="p">};</span><span class="err">
</span><span class="ln">31</span><span class="err"></span><span class="p">}</span><span class="err">
</span></code></pre></div><blockquote>
<p>关于<code>proto</code>之前的<a href="https://yangyang48.github.io/2022/04/dumpsys%E7%AE%80%E4%BB%8B-%E4%BB%A5media.camera%E4%B8%BA%E4%BE%8B/"><code>dumpsys media.camera</code></a>文章中提到过一次，但没有具体深入，当然本文也不会特别深入。</p>
<p><code>Protobuf</code> 是一种与平台无关、语言无关、可扩展且轻便高效的<strong>序列化数据结构</strong>的协议，可以用于网络通信和<strong>数据存储</strong>。而且由于和语言无关，<code>proto</code>文件既可以转化成<code>c++</code>文件，也可以转化成<code>java</code>，<code>python</code>这类的文件。当然在源码中，可以直接理解为定义了一种数据类，专门用于序列化存储。</p>
<p>目前我们定义的<code>proto</code>文件，比如上面的<code>property_service.proto</code>，可以在下面的源码路径中找到</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text"><span class="ln">1</span>//其中xxx为具体的架构，有arm架构，arm架构等
<span class="ln">2</span>/out/soong/.intermediates/system/core/init/libinit/android_xxx_static/gen/proto/system/core/init/property_service.pb.h
<span class="ln">3</span>/out/soong/.intermediates/system/core/init/libinit/android_xxx_static/gen/proto/system/core/init/property_service.pb.cc
</code></pre></div><p>具体的规则如下，所指定的消息字段修饰符必须是如下之一：</p>
<ul>
<li>required：一个格式良好的消息一定要含有1个这种字段。表示该值是必须要设置的；</li>
<li>optional：消息格式中该字段可以有0个或1个值（不超过1个）。</li>
<li>repeated：在一个格式良好的消息中，这种字段可以重复任意多次（包括0次）。重复的值的顺序会被保留。表示该值可以重复，相当于java中的List。</li>
</ul>
<p>上面只是最简单的提到了<code>proto</code>，如果需要进一步了解语法规则，可以点击<a href="http://t.zoukankan.com/GarfieldEr007-p-10113328.html">这里</a>。</p>
</blockquote>
<h4 id="2321load_override_properties">2.3.2.1load_override_properties</h4>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//system/core/init/property_service.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="k">static</span> <span class="kt">void</span> <span class="nf">load_override_properties</span><span class="p">()</span> <span class="p">{</span>
<span class="ln"> 3</span>    <span class="c1">//如果存在/data/local.prop，那么就和1.4.4一样的操作即可
</span><span class="ln"> 4</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">ALLOW_LOCAL_PROP_OVERRIDE</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 5</span>        <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">properties</span><span class="p">;</span>
<span class="ln"> 6</span>        <span class="n">load_properties_from_file</span><span class="p">(</span><span class="s">&#34;/data/local.prop&#34;</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">properties</span><span class="p">);</span>
<span class="ln"> 7</span>        <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="p">[</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">]</span> <span class="o">:</span> <span class="n">properties</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 8</span>            <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">error</span><span class="p">;</span>
<span class="ln"> 9</span>            <span class="k">if</span> <span class="p">(</span><span class="n">PropertySet</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PROP_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">10</span>                <span class="n">LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Could not set &#39;&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">name</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;&#39; to &#39;&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">value</span>
<span class="ln">11</span>                           <span class="o">&lt;&lt;</span> <span class="s">&#34;&#39; in /data/local.prop: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">error</span><span class="p">;</span>
<span class="ln">12</span>            <span class="p">}</span>
<span class="ln">13</span>        <span class="p">}</span>
<span class="ln">14</span>    <span class="p">}</span>
<span class="ln">15</span><span class="p">}</span>
</code></pre></div><h4 id="2322loadpersistentproperties">2.3.2.2LoadPersistentProperties</h4>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//system/core/init/persistent_properties.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="n">PersistentProperties</span> <span class="nf">LoadPersistentProperties</span><span class="p">()</span> <span class="p">{</span>
<span class="ln"> 3</span>    <span class="c1">//如果这里导入正常，直接返回即可
</span><span class="ln"> 4</span><span class="c1"></span>    <span class="c1">//这里的persistent_properties结构是定义在persistent_properties.proto中定义的，
</span><span class="ln"> 5</span><span class="c1"></span>    <span class="k">auto</span> <span class="n">persistent_properties</span> <span class="o">=</span> <span class="n">LoadPersistentPropertyFile</span><span class="p">();</span>
<span class="ln"> 6</span>
<span class="ln"> 7</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">persistent_properties</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
<span class="ln"> 8</span>        <span class="n">LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Could not load single persistent property file, trying legacy directory: &#34;</span>
<span class="ln"> 9</span>                   <span class="o">&lt;&lt;</span> <span class="n">persistent_properties</span><span class="p">.</span><span class="n">error</span><span class="p">();</span>
<span class="ln">10</span>        <span class="n">persistent_properties</span> <span class="o">=</span> <span class="n">LoadLegacyPersistentProperties</span><span class="p">();</span>
<span class="ln">11</span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">persistent_properties</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
<span class="ln">12</span>            <span class="n">LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Unable to load legacy persistent properties: &#34;</span>
<span class="ln">13</span>                       <span class="o">&lt;&lt;</span> <span class="n">persistent_properties</span><span class="p">.</span><span class="n">error</span><span class="p">();</span>
<span class="ln">14</span>            <span class="k">return</span> <span class="p">{};</span>
<span class="ln">15</span>        <span class="p">}</span>
<span class="ln">16</span>        <span class="k">if</span> <span class="p">(</span><span class="k">auto</span> <span class="n">result</span> <span class="o">=</span> <span class="n">WritePersistentPropertyFile</span><span class="p">(</span><span class="o">*</span><span class="n">persistent_properties</span><span class="p">);</span> <span class="n">result</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
<span class="ln">17</span>            <span class="n">RemoveLegacyPersistentPropertyFiles</span><span class="p">();</span>
<span class="ln">18</span>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="ln">19</span>            <span class="n">LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Unable to write single persistent property file: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">result</span><span class="p">.</span><span class="n">error</span><span class="p">();</span>
<span class="ln">20</span>            <span class="c1">// Fall through so that we still set the properties that we&#39;ve read.
</span><span class="ln">21</span><span class="c1"></span>        <span class="p">}</span>
<span class="ln">22</span>    <span class="p">}</span>
<span class="ln">23</span>
<span class="ln">24</span>    <span class="k">return</span> <span class="o">*</span><span class="n">persistent_properties</span><span class="p">;</span>
<span class="ln">25</span><span class="p">}</span>
</code></pre></div><h5 id="23221persistent_propertiesproto">2.3.2.2.1persistent_properties.proto</h5>
<div class="highlight"><pre class="chroma"><code class="language-protobuf" data-lang="protobuf"><span class="ln"> 1</span><span class="c1">//system/core/init/persistent_properties.proto
</span><span class="ln"> 2</span><span class="c1"></span><span class="n">syntax</span> <span class="o">=</span> <span class="s">&#34;proto2&#34;</span><span class="p">;</span><span class="err">
</span><span class="ln"> 3</span><span class="err"></span><span class="k">option</span> <span class="n">optimize_for</span> <span class="o">=</span> <span class="n">LITE_RUNTIME</span><span class="p">;</span><span class="err">
</span><span class="ln"> 4</span><span class="err">
</span><span class="ln"> 5</span><span class="err"></span><span class="kd">message</span> <span class="nc">PersistentProperties</span> <span class="p">{</span><span class="err">
</span><span class="ln"> 6</span><span class="err"></span>    <span class="kd">message</span> <span class="nc">PersistentPropertyRecord</span> <span class="p">{</span><span class="err">
</span><span class="ln"> 7</span><span class="err"></span>        <span class="k">optional</span> <span class="kt">string</span> <span class="n">name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span><span class="ln"> 8</span><span class="err"></span>        <span class="k">optional</span> <span class="kt">string</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span><span class="err">
</span><span class="ln"> 9</span><span class="err"></span>    <span class="p">}</span><span class="err">
</span><span class="ln">10</span><span class="err"></span>    <span class="c1">//可以理解为是list&lt;PersistentPropertyRecord&gt;
</span><span class="ln">11</span><span class="c1"></span>    <span class="c1">//每一个PersistentPropertyRecord中都有name，value,但name，value不一定存在
</span><span class="ln">12</span><span class="c1"></span>    <span class="k">repeated</span> <span class="n">PersistentPropertyRecord</span> <span class="n">properties</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span><span class="ln">13</span><span class="err"></span><span class="p">}</span><span class="err">
</span></code></pre></div><h5 id="23222loadpersistentpropertyfile">2.3.2.2.2LoadPersistentPropertyFile</h5>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//system/core/init/persistent_properties.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="n">Result</span><span class="o">&lt;</span><span class="n">PersistentProperties</span><span class="o">&gt;</span> <span class="n">LoadPersistentPropertyFile</span><span class="p">()</span> <span class="p">{</span>
<span class="ln"> 3</span>    <span class="c1">//读取文件内容，如果内容不存在就直接返回
</span><span class="ln"> 4</span><span class="c1"></span>    <span class="k">auto</span> <span class="n">file_contents</span> <span class="o">=</span> <span class="n">ReadPersistentPropertyFile</span><span class="p">();</span>
<span class="ln"> 5</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">file_contents</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="k">return</span> <span class="n">file_contents</span><span class="p">.</span><span class="n">error</span><span class="p">();</span>
<span class="ln"> 6</span>    <span class="c1">//如果内容存在，那么把文件中的内容变成PersistentProperties的形式
</span><span class="ln"> 7</span><span class="c1"></span>    <span class="n">PersistentProperties</span> <span class="n">persistent_properties</span><span class="p">;</span>
<span class="ln"> 8</span>    <span class="k">if</span> <span class="p">(</span><span class="n">persistent_properties</span><span class="p">.</span><span class="n">ParseFromString</span><span class="p">(</span><span class="o">*</span><span class="n">file_contents</span><span class="p">))</span> <span class="k">return</span> <span class="n">persistent_properties</span><span class="p">;</span>
<span class="ln"> 9</span>    <span class="p">...</span>
<span class="ln">10</span><span class="p">}</span>
</code></pre></div><p><code>ReadPersistentPropertyFile</code></p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//system/core/init/persistent_properties.cpp
</span><span class="ln"> 2</span><span class="c1">//persistent_property_filename为&#34;/data/property/persistent_properties&#34;
</span><span class="ln"> 3</span><span class="c1"></span><span class="n">Result</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">ReadPersistentPropertyFile</span><span class="p">()</span> <span class="p">{</span>
<span class="ln"> 4</span>    <span class="c1">//查看是否还存在未完成的临时tmp文件，存在就删除
</span><span class="ln"> 5</span><span class="c1"></span>    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">temp_filename</span> <span class="o">=</span> <span class="n">persistent_property_filename</span> <span class="o">+</span> <span class="s">&#34;.tmp&#34;</span><span class="p">;</span>
<span class="ln"> 6</span>    <span class="k">if</span> <span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">temp_filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">F_OK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 7</span>        <span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span>
<span class="ln"> 8</span>            <span class="o">&lt;&lt;</span> <span class="s">&#34;Found temporary property file while attempting to persistent system properties&#34;</span>
<span class="ln"> 9</span>               <span class="s">&#34; a previous persistent property write may have failed&#34;</span><span class="p">;</span>
<span class="ln">10</span>        <span class="n">unlink</span><span class="p">(</span><span class="n">temp_filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="ln">11</span>    <span class="p">}</span>
<span class="ln">12</span>    <span class="c1">//读取对应的/data/property/persistent_properties，是否存在文件，第一次进来肯定是不存在的
</span><span class="ln">13</span><span class="c1"></span>    <span class="k">auto</span> <span class="n">file_contents</span> <span class="o">=</span> <span class="n">ReadFile</span><span class="p">(</span><span class="n">persistent_property_filename</span><span class="p">);</span>
<span class="ln">14</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">file_contents</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
<span class="ln">15</span>        <span class="k">return</span> <span class="nf">Error</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Unable to read persistent property file: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">file_contents</span><span class="p">.</span><span class="n">error</span><span class="p">();</span>
<span class="ln">16</span>    <span class="p">}</span>
<span class="ln">17</span>    <span class="k">return</span> <span class="o">*</span><span class="n">file_contents</span><span class="p">;</span>
<span class="ln">18</span><span class="p">}</span>
</code></pre></div><h5 id="23223loadlegacypersistentproperties">2.3.2.2.3LoadLegacyPersistentProperties</h5>
<p>因为第一次的时候文件<code>/data/property/persistent_properties</code>是不存在的，所以会走到这里，这里的遍历<code>/data/property</code>文件夹，实际上是为了兼容以前的<code>api</code>，现在的<code>api</code>只有一个<code>persistent_properties</code>，以前是一个个类似<code>persist.a.b.c</code>这样的一个文件组成的<code>/data/property</code>文件夹。</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//system/core/init/persistent_properties.cpp
</span><span class="ln"> 2</span><span class="c1">//这里的kLegacyPersistentPropertyDir是/data/property
</span><span class="ln"> 3</span><span class="c1"></span><span class="n">Result</span><span class="o">&lt;</span><span class="n">PersistentProperties</span><span class="o">&gt;</span> <span class="n">LoadLegacyPersistentProperties</span><span class="p">()</span> <span class="p">{</span>
<span class="ln"> 4</span>    <span class="c1">//打开对应的/data/property文件夹
</span><span class="ln"> 5</span><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">DIR</span><span class="p">,</span> <span class="k">decltype</span><span class="p">(</span><span class="o">&amp;</span><span class="n">closedir</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">dir</span><span class="p">(</span><span class="n">opendir</span><span class="p">(</span><span class="n">kLegacyPersistentPropertyDir</span><span class="p">),</span> <span class="n">closedir</span><span class="p">);</span>
<span class="ln"> 6</span>
<span class="ln"> 7</span>    <span class="n">PersistentProperties</span> <span class="n">persistent_properties</span><span class="p">;</span>
<span class="ln"> 8</span>    <span class="n">dirent</span><span class="o">*</span> <span class="n">entry</span><span class="p">;</span>
<span class="ln"> 9</span>    <span class="c1">//开始遍历文件夹中的文件，是否以persist开头
</span><span class="ln">10</span><span class="c1"></span>    <span class="k">while</span> <span class="p">((</span><span class="n">entry</span> <span class="o">=</span> <span class="n">readdir</span><span class="p">(</span><span class="n">dir</span><span class="p">.</span><span class="n">get</span><span class="p">()))</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">11</span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">StartsWith</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">,</span> <span class="s">&#34;persist.&#34;</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">12</span>            <span class="k">continue</span><span class="p">;</span>
<span class="ln">13</span>        <span class="p">}</span>
<span class="ln">14</span>        <span class="p">...</span>
<span class="ln">15</span>        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">value</span><span class="p">;</span>
<span class="ln">16</span>        <span class="c1">//存在的话，那么将该文件中的key，value写入到对应的persistent_properties中
</span><span class="ln">17</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">ReadFdToString</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">18</span>            <span class="n">AddPersistentProperty</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">persistent_properties</span><span class="p">);</span>
<span class="ln">19</span>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="ln">20</span>            <span class="n">PLOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Unable to read persistent property file &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">;</span>
<span class="ln">21</span>        <span class="p">}</span>
<span class="ln">22</span>    <span class="p">}</span>
<span class="ln">23</span>    <span class="k">return</span> <span class="n">persistent_properties</span><span class="p">;</span>
<span class="ln">24</span><span class="p">}</span>
</code></pre></div><h5 id="23224writepersistentpropertyfile">2.3.2.2.4WritePersistentPropertyFile</h5>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//system/core/init/persistent_properties.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="n">Result</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span> <span class="n">WritePersistentPropertyFile</span><span class="p">(</span><span class="k">const</span> <span class="n">PersistentProperties</span><span class="o">&amp;</span> <span class="n">persistent_properties</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 3</span>    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">temp_filename</span> <span class="o">=</span> <span class="n">persistent_property_filename</span> <span class="o">+</span> <span class="s">&#34;.tmp&#34;</span><span class="p">;</span>
<span class="ln"> 4</span>    <span class="n">unique_fd</span> <span class="nf">fd</span><span class="p">(</span><span class="n">TEMP_FAILURE_RETRY</span><span class="p">(</span>
<span class="ln"> 5</span>        <span class="n">open</span><span class="p">(</span><span class="n">temp_filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">O_WRONLY</span> <span class="o">|</span> <span class="n">O_CREAT</span> <span class="o">|</span> <span class="n">O_NOFOLLOW</span> <span class="o">|</span> <span class="n">O_TRUNC</span> <span class="o">|</span> <span class="n">O_CLOEXEC</span><span class="p">,</span> <span class="mo">0600</span><span class="p">)));</span>
<span class="ln"> 6</span>    <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 7</span>        <span class="k">return</span> <span class="nf">ErrnoError</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Could not open temporary properties file&#34;</span><span class="p">;</span>
<span class="ln"> 8</span>    <span class="p">}</span>
<span class="ln"> 9</span>    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">serialized_string</span><span class="p">;</span>
<span class="ln">10</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">persistent_properties</span><span class="p">.</span><span class="n">SerializeToString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serialized_string</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">11</span>        <span class="k">return</span> <span class="nf">Error</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Unable to serialize properties&#34;</span><span class="p">;</span>
<span class="ln">12</span>    <span class="p">}</span>
<span class="ln">13</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">WriteStringToFd</span><span class="p">(</span><span class="n">serialized_string</span><span class="p">,</span> <span class="n">fd</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">14</span>        <span class="k">return</span> <span class="nf">ErrnoError</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Unable to write file contents&#34;</span><span class="p">;</span>
<span class="ln">15</span>    <span class="p">}</span>
<span class="ln">16</span>    <span class="n">fsync</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
<span class="ln">17</span>    <span class="n">fd</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
<span class="ln">18</span>    <span class="c1">//将/data/property/persistent_properties.tmp文件更名为/data/property/persistent_properties
</span><span class="ln">19</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">rename</span><span class="p">(</span><span class="n">temp_filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">persistent_property_filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">()))</span> <span class="p">{</span>
<span class="ln">20</span>        <span class="p">...</span>
<span class="ln">21</span>    <span class="p">}</span>
<span class="ln">22</span>    <span class="c1">//文件的目录/data/property
</span><span class="ln">23</span><span class="c1"></span>    <span class="k">auto</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">Dirname</span><span class="p">(</span><span class="n">persistent_property_filename</span><span class="p">);</span>
<span class="ln">24</span>    <span class="c1">//判断是否存在这个目录
</span><span class="ln">25</span><span class="c1"></span>    <span class="k">auto</span> <span class="n">dir_fd</span> <span class="o">=</span> <span class="n">unique_fd</span><span class="p">{</span><span class="n">open</span><span class="p">(</span><span class="n">dir</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">O_DIRECTORY</span> <span class="o">|</span> <span class="n">O_RDONLY</span> <span class="o">|</span> <span class="n">O_CLOEXEC</span><span class="p">)};</span>
<span class="ln">26</span>    <span class="k">if</span> <span class="p">(</span><span class="n">dir_fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">27</span>        <span class="k">return</span> <span class="nf">ErrnoError</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Unable to open persistent properties directory for fsync()&#34;</span><span class="p">;</span>
<span class="ln">28</span>    <span class="p">}</span>
<span class="ln">29</span>    <span class="n">fsync</span><span class="p">(</span><span class="n">dir_fd</span><span class="p">);</span>
<span class="ln">30</span>
<span class="ln">31</span>    <span class="k">return</span> <span class="p">{};</span>
<span class="ln">32</span><span class="p">}</span>
</code></pre></div><p>具体的流程如下</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/property/property_18.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/property/property_18.png" >
  
    </a>
  
  
</div>

<h4 id="2323initpropertyset">2.3.2.3InitPropertySet</h4>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//system/core/init/property_service.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="kt">uint32_t</span> <span class="nf">InitPropertySet</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 3</span>    <span class="kt">uint32_t</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="ln"> 4</span>    <span class="n">ucred</span> <span class="n">cr</span> <span class="o">=</span> <span class="p">{.</span><span class="n">pid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">uid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">gid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">};</span>
<span class="ln"> 5</span>    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">error</span><span class="p">;</span>
<span class="ln"> 6</span>    <span class="n">result</span> <span class="o">=</span> <span class="n">HandlePropertySet</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">kInitContext</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
<span class="ln"> 7</span>    <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="n">PROP_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 8</span>        <span class="n">LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Init cannot set &#39;&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">name</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;&#39; to &#39;&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;&#39;: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">error</span><span class="p">;</span>
<span class="ln"> 9</span>    <span class="p">}</span>
<span class="ln">10</span>
<span class="ln">11</span>    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="ln">12</span><span class="p">}</span>
</code></pre></div><p>这里的<code>InitPropertySet</code>函数只增加了<code>cr</code>的参数，使得<code>cr</code>为第一个进程，且<code>uid</code>，<code>gid</code>都为0</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="kt">uint32_t</span> <span class="nf">HandlePropertySet</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">,</span>
<span class="ln"> 2</span>                           <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">source_context</span><span class="p">,</span> <span class="k">const</span> <span class="n">ucred</span><span class="o">&amp;</span> <span class="n">cr</span><span class="p">,</span>
<span class="ln"> 3</span>                           <span class="n">SocketConnection</span><span class="o">*</span> <span class="n">socket</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">*</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 4</span>    <span class="c1">//检查name，value，source_context三者的权限性
</span><span class="ln"> 5</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="k">auto</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">CheckPermissions</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">source_context</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span> <span class="n">ret</span> <span class="o">!=</span> <span class="n">PROP_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 6</span>        <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="ln"> 7</span>    <span class="p">}</span>
<span class="ln"> 8</span>    <span class="c1">//如果是ctl的属性，那么就调用到SendControlMessage去
</span><span class="ln"> 9</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">StartsWith</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&#34;ctl.&#34;</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">10</span>        <span class="k">return</span> <span class="n">SendControlMessage</span><span class="p">(</span><span class="n">name</span><span class="p">.</span><span class="n">c_str</span><span class="p">()</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">cr</span><span class="p">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">socket</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
<span class="ln">11</span>    <span class="p">}</span>
<span class="ln">12</span>    <span class="c1">//这个sys.powerctl使用与关机属性的
</span><span class="ln">13</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#34;sys.powerctl&#34;</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">14</span>        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">cmdline_path</span> <span class="o">=</span> <span class="n">StringPrintf</span><span class="p">(</span><span class="s">&#34;proc/%d/cmdline&#34;</span><span class="p">,</span> <span class="n">cr</span><span class="p">.</span><span class="n">pid</span><span class="p">);</span>
<span class="ln">15</span>        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">process_cmdline</span><span class="p">;</span>
<span class="ln">16</span>        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">process_log_string</span><span class="p">;</span>
<span class="ln">17</span>        <span class="k">if</span> <span class="p">(</span><span class="n">ReadFileToString</span><span class="p">(</span><span class="n">cmdline_path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">process_cmdline</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">18</span>            <span class="p">...</span>
<span class="ln">19</span>        <span class="p">}</span>
<span class="ln">20</span>        <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="s">&#34;reboot,userspace&#34;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_userspace_reboot_supported</span><span class="p">().</span><span class="n">value_or</span><span class="p">(</span><span class="nb">false</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">21</span>            <span class="p">...</span>
<span class="ln">22</span>        <span class="p">}</span>
<span class="ln">23</span>    <span class="p">}</span>
<span class="ln">24</span>
<span class="ln">25</span>    <span class="c1">//如果init以外的进程正在写入一个非空值，这意味着该进程正在请求init在&#39;value&#39;指定的路径上执行restorecon操作
</span><span class="ln">26</span><span class="c1"></span>    <span class="c1">//kRestoreconProperty为&#34;selinux.restorecon_recursive&#34;
</span><span class="ln">27</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="n">kRestoreconProperty</span> <span class="o">&amp;&amp;</span> <span class="n">cr</span><span class="p">.</span><span class="n">pid</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">value</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
<span class="ln">28</span>        <span class="k">static</span> <span class="n">AsyncRestorecon</span> <span class="n">async_restorecon</span><span class="p">;</span>
<span class="ln">29</span>        <span class="n">async_restorecon</span><span class="p">.</span><span class="n">TriggerRestorecon</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
<span class="ln">30</span>        <span class="k">return</span> <span class="n">PROP_SUCCESS</span><span class="p">;</span>
<span class="ln">31</span>    <span class="p">}</span>
<span class="ln">32</span>    <span class="c1">//检验完毕之后，最终会调用到PropertySet函数中
</span><span class="ln">33</span><span class="c1"></span>    <span class="k">return</span> <span class="n">PropertySet</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
<span class="ln">34</span><span class="p">}</span>
</code></pre></div><p><code>PropertySet</code></p>
<p>属性设置生效的地方</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//system/core/init/property_service.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="k">static</span> <span class="kt">uint32_t</span> <span class="nf">PropertySet</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">*</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 3</span>    <span class="n">size_t</span> <span class="n">valuelen</span> <span class="o">=</span> <span class="n">value</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<span class="ln"> 4</span>
<span class="ln"> 5</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IsLegalPropertyName</span><span class="p">(</span><span class="n">name</span><span class="p">))</span> <span class="p">{</span>
<span class="ln"> 6</span>        <span class="o">*</span><span class="n">error</span> <span class="o">=</span> <span class="s">&#34;Illegal property name&#34;</span><span class="p">;</span>
<span class="ln"> 7</span>        <span class="k">return</span> <span class="n">PROP_ERROR_INVALID_NAME</span><span class="p">;</span>
<span class="ln"> 8</span>    <span class="p">}</span>
<span class="ln"> 9</span>
<span class="ln">10</span>    <span class="k">if</span> <span class="p">(</span><span class="k">auto</span> <span class="n">result</span> <span class="o">=</span> <span class="n">IsLegalPropertyValue</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span> <span class="o">!</span><span class="n">result</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
<span class="ln">11</span>        <span class="o">*</span><span class="n">error</span> <span class="o">=</span> <span class="n">result</span><span class="p">.</span><span class="n">error</span><span class="p">().</span><span class="n">message</span><span class="p">();</span>
<span class="ln">12</span>        <span class="k">return</span> <span class="n">PROP_ERROR_INVALID_VALUE</span><span class="p">;</span>
<span class="ln">13</span>    <span class="p">}</span>
<span class="ln">14</span>    <span class="c1">//这里的属性设置，是通过name找到对应的prop_info
</span><span class="ln">15</span><span class="c1"></span>    <span class="n">prop_info</span><span class="o">*</span> <span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="n">prop_info</span><span class="o">*</span><span class="p">)</span> <span class="n">__system_property_find</span><span class="p">(</span><span class="n">name</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="ln">16</span>    <span class="k">if</span> <span class="p">(</span><span class="n">pi</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">17</span>        <span class="c1">//这里是限制ro属性第二次写入的操作
</span><span class="ln">18</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">StartsWith</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&#34;ro.&#34;</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">19</span>            <span class="o">*</span><span class="n">error</span> <span class="o">=</span> <span class="s">&#34;Read-only property was already set&#34;</span><span class="p">;</span>
<span class="ln">20</span>            <span class="k">return</span> <span class="n">PROP_ERROR_READ_ONLY_PROPERTY</span><span class="p">;</span>
<span class="ln">21</span>        <span class="p">}</span>
<span class="ln">22</span>        <span class="c1">//如果找到的是原本存在的name，直接更新对应的value即可
</span><span class="ln">23</span><span class="c1"></span>        <span class="n">__system_property_update</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">value</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">valuelen</span><span class="p">);</span>
<span class="ln">24</span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="ln">25</span>        <span class="c1">//如果没有找到对应的name，name直接添加属性，ro属性第一次写入也是这里添加进去的
</span><span class="ln">26</span><span class="c1"></span>        <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">__system_property_add</span><span class="p">(</span><span class="n">name</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">name</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span> <span class="n">value</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">valuelen</span><span class="p">);</span>
<span class="ln">27</span>        <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">28</span>            <span class="o">*</span><span class="n">error</span> <span class="o">=</span> <span class="s">&#34;__system_property_add failed&#34;</span><span class="p">;</span>
<span class="ln">29</span>            <span class="k">return</span> <span class="n">PROP_ERROR_SET_FAILED</span><span class="p">;</span>
<span class="ln">30</span>        <span class="p">}</span>
<span class="ln">31</span>    <span class="p">}</span>
<span class="ln">32</span>    <span class="c1">//能够调用到这里面，需要persistent_properties_loaded为true
</span><span class="ln">33</span><span class="c1"></span>    <span class="c1">//在2.3.2HandleInitSocket中完成文件导入和设置就会调用到这里
</span><span class="ln">34</span><span class="c1"></span>    <span class="c1">//也就是说默认的persist属性已经导入进去了，只有自定义的persist属性才会被再次写到persist的文件中
</span><span class="ln">35</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">persistent_properties_loaded</span> <span class="o">&amp;&amp;</span> <span class="n">StartsWith</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&#34;persist.&#34;</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">36</span>        <span class="n">WritePersistentProperty</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="ln">37</span>    <span class="p">}</span>
<span class="ln">38</span>    <span class="c1">//这里的accept_messages是在2.1StartSendingMessages初始化的时候就打开了，用于rc文件中的属性触发
</span><span class="ln">39</span><span class="c1"></span>    <span class="k">auto</span> <span class="n">lock</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="p">{</span><span class="n">accept_messages_lock</span><span class="p">};</span>
<span class="ln">40</span>    <span class="k">if</span> <span class="p">(</span><span class="n">accept_messages</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">41</span>        <span class="n">PropertyChanged</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="ln">42</span>    <span class="p">}</span>
<span class="ln">43</span>    <span class="k">return</span> <span class="n">PROP_SUCCESS</span><span class="p">;</span>
<span class="ln">44</span><span class="p">}</span>
</code></pre></div><p>属性设置的流程如下所示</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/property/property_20.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/property/property_20.png" >
  
    </a>
  
  
</div>

<h5 id="23231__system_property_find">2.3.2.3.1__system_property_find</h5>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln">1</span><span class="c1">//bionic/libc/bionic/system_property_api.cpp
</span><span class="ln">2</span><span class="c1"></span><span class="n">__BIONIC_WEAK_FOR_NATIVE_BRIDGE</span>
<span class="ln">3</span><span class="k">const</span> <span class="n">prop_info</span><span class="o">*</span> <span class="nf">__system_property_find</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">4</span>  <span class="k">return</span> <span class="n">system_properties</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
<span class="ln">5</span><span class="p">}</span>
</code></pre></div><p><code>system_properties.Find</code></p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//bionic/libc/system_properties/system_properties.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="k">const</span> <span class="n">prop_info</span><span class="o">*</span> <span class="n">SystemProperties</span><span class="o">::</span><span class="n">Find</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 3</span>  <span class="c1">//如果没有初始化过，直接返回空指针，这个在1.2中SystemProperties::AreaInit已经初始化  
</span><span class="ln"> 4</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">initialized_</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 5</span>    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
<span class="ln"> 6</span>  <span class="p">}</span>
<span class="ln"> 7</span>  <span class="c1">//通过属性名字，找到name对应的SElinux域
</span><span class="ln"> 8</span><span class="c1"></span>  <span class="n">prop_area</span><span class="o">*</span> <span class="n">pa</span> <span class="o">=</span> <span class="n">contexts_</span><span class="o">-&gt;</span><span class="n">GetPropAreaForName</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
<span class="ln"> 9</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pa</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">10</span>    <span class="n">async_safe_format_log</span><span class="p">(</span><span class="n">ANDROID_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;libc&#34;</span><span class="p">,</span> <span class="s">&#34;Access denied finding property </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="ln">11</span>    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
<span class="ln">12</span>  <span class="p">}</span>
<span class="ln">13</span>  <span class="c1">//SElinux域，那么查找这个域中完整的路径
</span><span class="ln">14</span><span class="c1"></span>  <span class="k">return</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">find</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
<span class="ln">15</span><span class="p">}</span>
</code></pre></div><p>1)<code>contexts_-&gt;GetPropAreaForName</code></p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//bionic/libc/system_properties/contexts_serialized.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="n">prop_area</span><span class="o">*</span> <span class="n">ContextsSerialized</span><span class="o">::</span><span class="n">GetPropAreaForName</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 3</span>  <span class="kt">uint32_t</span> <span class="n">index</span><span class="p">;</span>
<span class="ln"> 4</span>  <span class="c1">//从私有匿名区域查找name对应的SElinux域的ContextNode的编号
</span><span class="ln"> 5</span><span class="c1"></span>  <span class="n">property_info_area_file_</span><span class="o">-&gt;</span><span class="n">GetPropertyInfoIndexes</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">index</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">);</span>
<span class="ln"> 6</span>  <span class="p">...</span>
<span class="ln"> 7</span>  <span class="k">auto</span><span class="o">*</span> <span class="n">context_node</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">context_nodes_</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
<span class="ln"> 8</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">context_node</span><span class="o">-&gt;</span><span class="n">pa</span><span class="p">())</span> <span class="p">{</span>
<span class="ln"> 9</span>    <span class="c1">//不检查 no_access_，因为与foreach()的情况不同，希望为该函数中的每个非允许属性访问生成一个selinux
</span><span class="ln">10</span><span class="c1"></span>    <span class="n">context_node</span><span class="o">-&gt;</span><span class="n">Open</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">);</span>
<span class="ln">11</span>  <span class="p">}</span>
<span class="ln">12</span>  <span class="c1">//返回对应当前ContextNode指向的pa指针，也就是指向对应的SElinux域文件  
</span><span class="ln">13</span><span class="c1"></span>  <span class="k">return</span> <span class="n">context_node</span><span class="o">-&gt;</span><span class="n">pa</span><span class="p">();</span>
<span class="ln">14</span><span class="p">}</span>
</code></pre></div><p><code>GetPropertyInfoIndexes</code></p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//system/core/property_service/libpropertyinfoparser/property_info_parser.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="kt">void</span> <span class="n">PropertyInfoArea</span><span class="o">::</span><span class="n">GetPropertyInfoIndexes</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">,</span> <span class="kt">uint32_t</span><span class="o">*</span> <span class="n">context_index</span><span class="p">,</span>
<span class="ln"> 3</span>                                              <span class="kt">uint32_t</span><span class="o">*</span> <span class="n">type_index</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
<span class="ln"> 4</span>  <span class="kt">uint32_t</span> <span class="n">return_context_index</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0u</span><span class="p">;</span>
<span class="ln"> 5</span>  <span class="kt">uint32_t</span> <span class="n">return_type_index</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0u</span><span class="p">;</span>
<span class="ln"> 6</span>  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">remaining_name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
<span class="ln"> 7</span>  <span class="c1">//这里的root_node不是prop_bt中的root_node(),这里指的是PropertyInfoAreaHeader中的root_offset
</span><span class="ln"> 8</span><span class="c1"></span>  <span class="c1">//对应的还是/dev/__properties__/property_info 
</span><span class="ln"> 9</span><span class="c1"></span>  <span class="k">auto</span> <span class="n">trie_node</span> <span class="o">=</span> <span class="n">root_node</span><span class="p">();</span>
<span class="ln">10</span>  <span class="c1">//通过分隔符点来循环遍历，直到找到对应的index
</span><span class="ln">11</span><span class="c1"></span>  <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">12</span>    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">sep</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">remaining_name</span><span class="p">,</span> <span class="sc">&#39;.&#39;</span><span class="p">);</span>
<span class="ln">13</span>
<span class="ln">14</span>    <span class="c1">// Apply prefix match for prefix deliminated with &#39;.&#39;
</span><span class="ln">15</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">trie_node</span><span class="p">.</span><span class="n">context_index</span><span class="p">()</span> <span class="o">!=</span> <span class="o">~</span><span class="mi">0u</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">16</span>      <span class="n">return_context_index</span> <span class="o">=</span> <span class="n">trie_node</span><span class="p">.</span><span class="n">context_index</span><span class="p">();</span>
<span class="ln">17</span>    <span class="p">}</span>
<span class="ln">18</span>    <span class="k">if</span> <span class="p">(</span><span class="n">trie_node</span><span class="p">.</span><span class="n">type_index</span><span class="p">()</span> <span class="o">!=</span> <span class="o">~</span><span class="mi">0u</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">19</span>      <span class="n">return_type_index</span> <span class="o">=</span> <span class="n">trie_node</span><span class="p">.</span><span class="n">type_index</span><span class="p">();</span>
<span class="ln">20</span>    <span class="p">}</span>
<span class="ln">21</span>
<span class="ln">22</span>    <span class="c1">// Check prefixes at this node.  This comes after the node check since these prefixes are by
</span><span class="ln">23</span><span class="c1"></span>    <span class="c1">// definition longer than the node itself.
</span><span class="ln">24</span><span class="c1"></span>    <span class="n">CheckPrefixMatch</span><span class="p">(</span><span class="n">remaining_name</span><span class="p">,</span> <span class="n">trie_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">return_context_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">return_type_index</span><span class="p">);</span>
<span class="ln">25</span>
<span class="ln">26</span>    <span class="k">if</span> <span class="p">(</span><span class="n">sep</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">27</span>      <span class="k">break</span><span class="p">;</span>
<span class="ln">28</span>    <span class="p">}</span>
<span class="ln">29</span>
<span class="ln">30</span>    <span class="k">const</span> <span class="kt">uint32_t</span> <span class="n">substr_size</span> <span class="o">=</span> <span class="n">sep</span> <span class="o">-</span> <span class="n">remaining_name</span><span class="p">;</span>
<span class="ln">31</span>    <span class="n">TrieNode</span> <span class="n">child_node</span><span class="p">;</span>
<span class="ln">32</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">trie_node</span><span class="p">.</span><span class="n">FindChildForString</span><span class="p">(</span><span class="n">remaining_name</span><span class="p">,</span> <span class="n">substr_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">child_node</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">33</span>      <span class="k">break</span><span class="p">;</span>
<span class="ln">34</span>    <span class="p">}</span>
<span class="ln">35</span>
<span class="ln">36</span>    <span class="n">trie_node</span> <span class="o">=</span> <span class="n">child_node</span><span class="p">;</span>
<span class="ln">37</span>    <span class="n">remaining_name</span> <span class="o">=</span> <span class="n">sep</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="ln">38</span>  <span class="p">}</span>
<span class="ln">39</span>
<span class="ln">40</span>  <span class="c1">// We&#39;ve made it to a leaf node, so check contents and return appropriately.
</span><span class="ln">41</span><span class="c1"></span>  <span class="c1">// Check exact matches
</span><span class="ln">42</span><span class="c1"></span>  <span class="k">for</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">trie_node</span><span class="p">.</span><span class="n">num_exact_matches</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">43</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">c_string</span><span class="p">(</span><span class="n">trie_node</span><span class="p">.</span><span class="n">exact_match</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">name_offset</span><span class="p">),</span> <span class="n">remaining_name</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">44</span>      <span class="k">if</span> <span class="p">(</span><span class="n">context_index</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">45</span>        <span class="k">if</span> <span class="p">(</span><span class="n">trie_node</span><span class="p">.</span><span class="n">exact_match</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">context_index</span> <span class="o">!=</span> <span class="o">~</span><span class="mi">0u</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">46</span>          <span class="o">*</span><span class="n">context_index</span> <span class="o">=</span> <span class="n">trie_node</span><span class="p">.</span><span class="n">exact_match</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">context_index</span><span class="p">;</span>
<span class="ln">47</span>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="ln">48</span>          <span class="o">*</span><span class="n">context_index</span> <span class="o">=</span> <span class="n">return_context_index</span><span class="p">;</span>
<span class="ln">49</span>        <span class="p">}</span>
<span class="ln">50</span>      <span class="p">}</span>
<span class="ln">51</span>      <span class="k">if</span> <span class="p">(</span><span class="n">type_index</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">52</span>        <span class="k">if</span> <span class="p">(</span><span class="n">trie_node</span><span class="p">.</span><span class="n">exact_match</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">type_index</span> <span class="o">!=</span> <span class="o">~</span><span class="mi">0u</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">53</span>          <span class="o">*</span><span class="n">type_index</span> <span class="o">=</span> <span class="n">trie_node</span><span class="p">.</span><span class="n">exact_match</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">type_index</span><span class="p">;</span>
<span class="ln">54</span>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="ln">55</span>          <span class="o">*</span><span class="n">type_index</span> <span class="o">=</span> <span class="n">return_type_index</span><span class="p">;</span>
<span class="ln">56</span>        <span class="p">}</span>
<span class="ln">57</span>      <span class="p">}</span>
<span class="ln">58</span>      <span class="k">return</span><span class="p">;</span>
<span class="ln">59</span>    <span class="p">}</span>
<span class="ln">60</span>  <span class="p">}</span>
<span class="ln">61</span>  <span class="c1">// Check prefix matches for prefixes not deliminated with &#39;.&#39;
</span><span class="ln">62</span><span class="c1"></span>  <span class="n">CheckPrefixMatch</span><span class="p">(</span><span class="n">remaining_name</span><span class="p">,</span> <span class="n">trie_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">return_context_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">return_type_index</span><span class="p">);</span>
<span class="ln">63</span>  <span class="c1">// Return previously found prefix match.
</span><span class="ln">64</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">context_index</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="o">*</span><span class="n">context_index</span> <span class="o">=</span> <span class="n">return_context_index</span><span class="p">;</span>
<span class="ln">65</span>  <span class="k">if</span> <span class="p">(</span><span class="n">type_index</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="o">*</span><span class="n">type_index</span> <span class="o">=</span> <span class="n">return_type_index</span><span class="p">;</span>
<span class="ln">66</span>  <span class="k">return</span><span class="p">;</span>
<span class="ln">67</span><span class="p">}</span>
</code></pre></div><p>通过把属性<code>name</code>拆分出来分成若干个结点来找到对应的<code>index</code>，如果是<code>ro.boot.hardware.reversion</code>，那么就会通过一个个结点最终找到<code>reversion</code>这个结点对应序列化保存的<code>index</code>。</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/property/property_6.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/property/property_6.png" >
  
    </a>
  
  
</div>

<p>2)<code>pa-&gt;find</code></p>
<p>找到<code>index</code>之后，开始找对应的<code>prop_info</code>，对应的数据结构如下</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/property/property_16.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/property/property_16.png" >
  
    </a>
  
  
</div>

<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln">1</span><span class="c1">//bionic/libc/system_properties/prop_area.cpp
</span><span class="ln">2</span><span class="c1"></span><span class="k">const</span> <span class="n">prop_info</span><span class="o">*</span> <span class="n">prop_area</span><span class="o">::</span><span class="n">find</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">3</span>  <span class="c1">//这里的root_node()才是prop_bt中的函数
</span><span class="ln">4</span><span class="c1"></span>  <span class="k">return</span> <span class="nf">find_property</span><span class="p">(</span><span class="n">root_node</span><span class="p">(),</span> <span class="n">name</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="k">nullptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="ln">5</span><span class="p">}</span>
</code></pre></div><p><code>find_property</code></p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//bionic/libc/system_properties/prop_area.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="k">const</span> <span class="n">prop_info</span><span class="o">*</span> <span class="n">prop_area</span><span class="o">::</span><span class="n">find_property</span><span class="p">(</span><span class="n">prop_bt</span><span class="o">*</span> <span class="k">const</span> <span class="n">trie</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">namelen</span><span class="p">,</span>
<span class="ln"> 3</span>                                          <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">value</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">valuelen</span><span class="p">,</span>
<span class="ln"> 4</span>                                          <span class="kt">bool</span> <span class="n">alloc_if_needed</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 5</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">trie</span><span class="p">)</span> <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
<span class="ln"> 6</span>
<span class="ln"> 7</span>  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">remaining_name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
<span class="ln"> 8</span>  <span class="n">prop_bt</span><span class="o">*</span> <span class="n">current</span> <span class="o">=</span> <span class="n">trie</span><span class="p">;</span>
<span class="ln"> 9</span>  <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">10</span>    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">sep</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">remaining_name</span><span class="p">,</span> <span class="sc">&#39;.&#39;</span><span class="p">);</span>
<span class="ln">11</span>    <span class="k">const</span> <span class="kt">bool</span> <span class="n">want_subtree</span> <span class="o">=</span> <span class="p">(</span><span class="n">sep</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">);</span>
<span class="ln">12</span>    <span class="c1">//通过点分割后的字符串和未分割的字符串的长度相差，来判断是否是最后一个结点  
</span><span class="ln">13</span><span class="c1"></span>    <span class="k">const</span> <span class="kt">uint32_t</span> <span class="n">substr_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">want_subtree</span><span class="p">)</span> <span class="o">?</span> <span class="n">sep</span> <span class="o">-</span> <span class="nl">remaining_name</span> <span class="p">:</span> <span class="n">strlen</span><span class="p">(</span><span class="n">remaining_name</span><span class="p">);</span>
<span class="ln">14</span>
<span class="ln">15</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">substr_size</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">16</span>      <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
<span class="ln">17</span>    <span class="p">}</span>
<span class="ln">18</span>
<span class="ln">19</span>    <span class="n">prop_bt</span><span class="o">*</span> <span class="n">root</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
<span class="ln">20</span>    <span class="kt">uint_least32_t</span> <span class="n">children_offset</span> <span class="o">=</span> <span class="n">atomic_load_explicit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">children</span><span class="p">,</span> <span class="n">memory_order_relaxed</span><span class="p">);</span>
<span class="ln">21</span>    <span class="k">if</span> <span class="p">(</span><span class="n">children_offset</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">22</span>      <span class="c1">//查找到子结点  
</span><span class="ln">23</span><span class="c1"></span>      <span class="n">root</span> <span class="o">=</span> <span class="n">to_prop_bt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">children</span><span class="p">);</span>
<span class="ln">24</span>    <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">alloc_if_needed</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">25</span>      <span class="kt">uint_least32_t</span> <span class="n">new_offset</span><span class="p">;</span>
<span class="ln">26</span>      <span class="n">root</span> <span class="o">=</span> <span class="n">new_prop_bt</span><span class="p">(</span><span class="n">remaining_name</span><span class="p">,</span> <span class="n">substr_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_offset</span><span class="p">);</span>
<span class="ln">27</span>      <span class="k">if</span> <span class="p">(</span><span class="n">root</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">28</span>        <span class="n">atomic_store_explicit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">children</span><span class="p">,</span> <span class="n">new_offset</span><span class="p">,</span> <span class="n">memory_order_release</span><span class="p">);</span>
<span class="ln">29</span>      <span class="p">}</span>
<span class="ln">30</span>    <span class="p">}</span>
<span class="ln">31</span>
<span class="ln">32</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">root</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">33</span>      <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
<span class="ln">34</span>    <span class="p">}</span>
<span class="ln">35</span>    <span class="c1">//向左向右查找，根据字符串的字母顺序来排列
</span><span class="ln">36</span><span class="c1"></span>    <span class="n">current</span> <span class="o">=</span> <span class="n">find_prop_bt</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">remaining_name</span><span class="p">,</span> <span class="n">substr_size</span><span class="p">,</span> <span class="n">alloc_if_needed</span><span class="p">);</span>
<span class="ln">37</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">current</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">38</span>      <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
<span class="ln">39</span>    <span class="p">}</span>
<span class="ln">40</span>
<span class="ln">41</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">want_subtree</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
<span class="ln">42</span>
<span class="ln">43</span>    <span class="n">remaining_name</span> <span class="o">=</span> <span class="n">sep</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="ln">44</span>  <span class="p">}</span>
<span class="ln">45</span>  <span class="c1">//退出，说明name只剩下最后一个结点
</span><span class="ln">46</span><span class="c1"></span>  <span class="c1">//尝试查找对应的prop_info值
</span><span class="ln">47</span><span class="c1"></span>  <span class="kt">uint_least32_t</span> <span class="n">prop_offset</span> <span class="o">=</span> <span class="n">atomic_load_explicit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">prop</span><span class="p">,</span> <span class="n">memory_order_relaxed</span><span class="p">);</span>
<span class="ln">48</span>  <span class="k">if</span> <span class="p">(</span><span class="n">prop_offset</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">49</span>    <span class="c1">//找到就返回对应的prop_info
</span><span class="ln">50</span><span class="c1"></span>    <span class="k">return</span> <span class="nf">to_prop_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">prop</span><span class="p">);</span>
<span class="ln">51</span>  <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">alloc_if_needed</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">52</span>    <span class="kt">uint_least32_t</span> <span class="n">new_offset</span><span class="p">;</span>
<span class="ln">53</span>    <span class="n">prop_info</span><span class="o">*</span> <span class="n">new_info</span> <span class="o">=</span> <span class="n">new_prop_info</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">namelen</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">valuelen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_offset</span><span class="p">);</span>
<span class="ln">54</span>    <span class="k">if</span> <span class="p">(</span><span class="n">new_info</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">55</span>      <span class="n">atomic_store_explicit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">prop</span><span class="p">,</span> <span class="n">new_offset</span><span class="p">,</span> <span class="n">memory_order_release</span><span class="p">);</span>
<span class="ln">56</span>    <span class="p">}</span>
<span class="ln">57</span>    <span class="k">return</span> <span class="n">new_info</span><span class="p">;</span>
<span class="ln">58</span>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="ln">59</span>    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
<span class="ln">60</span>  <span class="p">}</span>
<span class="ln">61</span><span class="p">}</span>
</code></pre></div><p>如果查找<code>ro.boot.dynamic_partitions</code>，可以直接在下图中查找到，最后返回<code>ro.boot.dynamic_partitions</code>对应的<code>prop_info</code></p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/property/property_22.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/property/property_22.png" >
  
    </a>
  
  
</div>

<h5 id="23232__system_property_update">2.3.2.3.2__system_property_update</h5>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln">1</span><span class="c1">//bionic/libc/bionic/system_property_api.cpp
</span><span class="ln">2</span><span class="c1"></span><span class="n">__BIONIC_WEAK_FOR_NATIVE_BRIDGE</span>
<span class="ln">3</span><span class="kt">int</span> <span class="nf">__system_property_update</span><span class="p">(</span><span class="n">prop_info</span><span class="o">*</span> <span class="n">pi</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">value</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">4</span>  <span class="k">return</span> <span class="n">system_properties</span><span class="p">.</span><span class="n">Update</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="ln">5</span><span class="p">}</span>
</code></pre></div><p><code>system_properties.Update</code></p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//bionic/libc/system_properties/system_properties.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="kt">int</span> <span class="n">SystemProperties</span><span class="o">::</span><span class="n">Update</span><span class="p">(</span><span class="n">prop_info</span><span class="o">*</span> <span class="n">pi</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">value</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 3</span>  <span class="p">...</span>
<span class="ln"> 4</span>  <span class="c1">//新增了一个serial_pa的prop_area域，对应文件名是/dev/__properties__/properties_serial  
</span><span class="ln"> 5</span><span class="c1"></span>  <span class="n">prop_area</span><span class="o">*</span> <span class="n">serial_pa</span> <span class="o">=</span> <span class="n">contexts_</span><span class="o">-&gt;</span><span class="n">GetSerialPropArea</span><span class="p">();</span>
<span class="ln"> 6</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">serial_pa</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 7</span>    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="ln"> 8</span>  <span class="p">}</span>
<span class="ln"> 9</span>  <span class="c1">//同前面一样  
</span><span class="ln">10</span><span class="c1"></span>  <span class="n">prop_area</span><span class="o">*</span> <span class="n">pa</span> <span class="o">=</span> <span class="n">contexts_</span><span class="o">-&gt;</span><span class="n">GetPropAreaForName</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="ln">11</span>  <span class="c1">//找到prop_info中的serial
</span><span class="ln">12</span><span class="c1"></span>  <span class="kt">uint32_t</span> <span class="n">serial</span> <span class="o">=</span> <span class="n">atomic_load_explicit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">,</span> <span class="n">memory_order_relaxed</span><span class="p">);</span>
<span class="ln">13</span>  <span class="c1">//SERIAL_VALUE_LEN这个操作是右移运算，右移32位，得到value的长度
</span><span class="ln">14</span><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">old_len</span> <span class="o">=</span> <span class="n">SERIAL_VALUE_LEN</span><span class="p">(</span><span class="n">serial</span><span class="p">);</span>
<span class="ln">15</span>  <span class="c1">//只要设置了脏位，脏备份区域中就有一个未损坏的预脏值副本，确保在看到脏序列之前发布脏区更新
</span><span class="ln">16</span><span class="c1"></span>  <span class="n">memcpy</span><span class="p">(</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">dirty_backup_area</span><span class="p">(),</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span> <span class="n">old_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="ln">17</span>  <span class="n">atomic_thread_fence</span><span class="p">(</span><span class="n">memory_order_release</span><span class="p">);</span>
<span class="ln">18</span>  <span class="n">serial</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
<span class="ln">19</span>  <span class="c1">//更新value的前，序列号为奇数  
</span><span class="ln">20</span><span class="c1"></span>  <span class="n">atomic_store_explicit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">,</span> <span class="n">serial</span><span class="p">,</span> <span class="n">memory_order_relaxed</span><span class="p">);</span>
<span class="ln">21</span>  <span class="c1">//更新value的值  
</span><span class="ln">22</span><span class="c1"></span>  <span class="n">strlcpy</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="ln">23</span>  <span class="n">atomic_thread_fence</span><span class="p">(</span><span class="n">memory_order_release</span><span class="p">);</span>
<span class="ln">24</span>  <span class="c1">//serial,这里的prop_info中的serial，前八位是value的长度，后32位为序列数，如果开始更新则为奇数，更新完成则为偶数
</span><span class="ln">25</span><span class="c1"></span>  <span class="n">atomic_store_explicit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">,</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">serial</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffff</span><span class="p">),</span> <span class="n">memory_order_relaxed</span><span class="p">);</span>
<span class="ln">26</span>  <span class="n">__futex_wake</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">,</span> <span class="n">INT32_MAX</span><span class="p">);</span>  <span class="c1">// Fence by side effect
</span><span class="ln">27</span><span class="c1"></span>  <span class="c1">//只要有操作update的函数，就会对serial_pa中的serial_加1
</span><span class="ln">28</span><span class="c1"></span>  <span class="n">atomic_store_explicit</span><span class="p">(</span><span class="n">serial_pa</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">(),</span>
<span class="ln">29</span>                        <span class="n">atomic_load_explicit</span><span class="p">(</span><span class="n">serial_pa</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">(),</span> <span class="n">memory_order_relaxed</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
<span class="ln">30</span>                        <span class="n">memory_order_release</span><span class="p">);</span>
<span class="ln">31</span>  <span class="c1">// __futex_wake以及serial值用于控制更新操作的并发进行。
</span><span class="ln">32</span><span class="c1"></span>  <span class="n">__futex_wake</span><span class="p">(</span><span class="n">serial_pa</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">(),</span> <span class="n">INT32_MAX</span><span class="p">);</span>
<span class="ln">33</span>
<span class="ln">34</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="ln">35</span><span class="p">}</span>
</code></pre></div><p>每次<code>Update</code>的时候，会更新几处地方，第一<code>prop_info</code>的<code>value</code>会更新，第二<code>prop_info</code>的<code>serial</code>会更新，前八位是新<code>value</code>的长度，后32位记录数值，这个数值是被修改次数的2倍，如果为奇数，说明这个<code>value</code>正在写入<code>prop_info</code>中。第三，会更新<code>/dev/__properties__/properties_serial</code>所在的<code>prop_area</code>中的<code>serial_</code>值，目前有两种情况会变化，<code>Update</code>和<code>Add</code>的时候，都会增加1。</p>
<p>下面举例说明，在总共只有三个属性的情况下，对于<code>aaudio.hw_burst_min_usec</code>这个属性中，第一次更新了一次属性，那么<code>prop_info</code>中的<code>serial</code>为<code>0x04000002</code>，并且<code>/dev/__properties__/properties_serial</code>所在的<code>prop_area</code>中的<code>serial_</code>值为4。</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/property/property_23.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/property/property_23.png" >
  
    </a>
  
  
</div>

<h5 id="23233__system_property_add">2.3.2.3.3__system_property_add</h5>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln">1</span><span class="c1">//bionic/libc/bionic/system_property_api.cpp
</span><span class="ln">2</span><span class="c1"></span><span class="n">__BIONIC_WEAK_FOR_NATIVE_BRIDGE</span>
<span class="ln">3</span><span class="kt">int</span> <span class="nf">__system_property_add</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">namelen</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">value</span><span class="p">,</span>
<span class="ln">4</span>                          <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">valuelen</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">5</span>  <span class="k">return</span> <span class="n">system_properties</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">namelen</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">valuelen</span><span class="p">);</span>
<span class="ln">6</span><span class="p">}</span>
</code></pre></div><p><code>system_properties.Add</code></p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//bionic/libc/system_properties/system_properties.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="kt">int</span> <span class="n">SystemProperties</span><span class="o">::</span><span class="n">Add</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">namelen</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">value</span><span class="p">,</span>
<span class="ln"> 3</span>                          <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">valuelen</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 4</span>  <span class="p">...</span>
<span class="ln"> 5</span>  <span class="c1">//新增了一个serial_pa的prop_area域，对应文件名是/dev/__properties__/properties_serial    
</span><span class="ln"> 6</span><span class="c1"></span>  <span class="n">prop_area</span><span class="o">*</span> <span class="n">serial_pa</span> <span class="o">=</span> <span class="n">contexts_</span><span class="o">-&gt;</span><span class="n">GetSerialPropArea</span><span class="p">();</span>
<span class="ln"> 7</span>  <span class="k">if</span> <span class="p">(</span><span class="n">serial_pa</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 8</span>    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="ln"> 9</span>  <span class="p">}</span>
<span class="ln">10</span>  <span class="c1">//这里和前面一模一样，重新找到对应的prop_area域
</span><span class="ln">11</span><span class="c1"></span>  <span class="n">prop_area</span><span class="o">*</span> <span class="n">pa</span> <span class="o">=</span> <span class="n">contexts_</span><span class="o">-&gt;</span><span class="n">GetPropAreaForName</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
<span class="ln">12</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pa</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">13</span>    <span class="n">async_safe_format_log</span><span class="p">(</span><span class="n">ANDROID_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;libc&#34;</span><span class="p">,</span> <span class="s">&#34;Access denied adding property </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="ln">14</span>    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="ln">15</span>  <span class="p">}</span>
<span class="ln">16</span>  <span class="c1">//在这个域中添加对应的属性
</span><span class="ln">17</span><span class="c1"></span>  <span class="kt">bool</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">namelen</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">valuelen</span><span class="p">);</span>
<span class="ln">18</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">19</span>    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="ln">20</span>  <span class="p">}</span>
<span class="ln">21</span>
<span class="ln">22</span>  <span class="c1">//添加一个新属性，会使这个serial_pa对应的序列增加1
</span><span class="ln">23</span><span class="c1"></span>  <span class="n">atomic_store_explicit</span><span class="p">(</span><span class="n">serial_pa</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">(),</span>
<span class="ln">24</span>                        <span class="n">atomic_load_explicit</span><span class="p">(</span><span class="n">serial_pa</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">(),</span> <span class="n">memory_order_relaxed</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
<span class="ln">25</span>                        <span class="n">memory_order_release</span><span class="p">);</span>
<span class="ln">26</span>  <span class="n">__futex_wake</span><span class="p">(</span><span class="n">serial_pa</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">(),</span> <span class="n">INT32_MAX</span><span class="p">);</span>
<span class="ln">27</span>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="ln">28</span><span class="p">}</span>
</code></pre></div><p><code>pa-&gt;add</code></p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln">1</span><span class="c1">//bionic/libc/system_properties/prop_area.cpp
</span><span class="ln">2</span><span class="c1">//这里的添加操作和find方式区别就是，最后一个参数，最后一个参数找不到可以添加
</span><span class="ln">3</span><span class="c1"></span><span class="kt">bool</span> <span class="n">prop_area</span><span class="o">::</span><span class="n">add</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">namelen</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">value</span><span class="p">,</span>
<span class="ln">4</span>                    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">valuelen</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">5</span>  <span class="k">return</span> <span class="nf">find_property</span><span class="p">(</span><span class="n">root_node</span><span class="p">(),</span> <span class="n">name</span><span class="p">,</span> <span class="n">namelen</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">valuelen</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="ln">6</span><span class="p">}</span>
</code></pre></div><p>比如新增加一个属性<code>ro.boot.serialno</code>为<code>&quot;1234567890&quot;</code>，那么会更新对应的<code>prop_info</code>的<code>name</code>和<code>value</code>值，并且对应<code>/dev/__properties__/properties_serial</code>所在的<code>prop_area</code>中的<code>serial_</code>值会变成5。</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/property/property_24.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/property/property_24.png" >
  
    </a>
  
  
</div>

<h5 id="23234writepersistentproperty">2.3.2.3.4WritePersistentProperty</h5>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//system/core/init/persistent_properties.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="kt">void</span> <span class="nf">WritePersistentProperty</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 3</span>    <span class="c1">//先找/data/property/persistent_properties，是否存在这个文件，存在这个文件那么直接导入
</span><span class="ln"> 4</span><span class="c1"></span>    <span class="k">auto</span> <span class="n">persistent_properties</span> <span class="o">=</span> <span class="n">LoadPersistentPropertyFile</span><span class="p">();</span>
<span class="ln"> 5</span>
<span class="ln"> 6</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">persistent_properties</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
<span class="ln"> 7</span>        <span class="n">LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Recovering persistent properties from memory: &#34;</span>
<span class="ln"> 8</span>                   <span class="o">&lt;&lt;</span> <span class="n">persistent_properties</span><span class="p">.</span><span class="n">error</span><span class="p">();</span>
<span class="ln"> 9</span>        <span class="c1">//没有这个文件从私有匿名内存中找，并且把key，value导入到对应序列化格式中persistent_properties
</span><span class="ln">10</span><span class="c1"></span>        <span class="n">persistent_properties</span> <span class="o">=</span> <span class="n">LoadPersistentPropertiesFromMemory</span><span class="p">();</span>
<span class="ln">11</span>    <span class="p">}</span>
<span class="ln">12</span>    <span class="c1">//在序列化格式中查找是否存在name
</span><span class="ln">13</span><span class="c1"></span>    <span class="k">auto</span> <span class="n">it</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">find_if</span><span class="p">(</span><span class="n">persistent_properties</span><span class="o">-&gt;</span><span class="n">mutable_properties</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">(),</span>
<span class="ln">14</span>                           <span class="n">persistent_properties</span><span class="o">-&gt;</span><span class="n">mutable_properties</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">(),</span>
<span class="ln">15</span>                           <span class="p">[</span><span class="o">&amp;</span><span class="n">name</span><span class="p">](</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">record</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">record</span><span class="p">.</span><span class="n">name</span><span class="p">()</span> <span class="o">==</span> <span class="n">name</span><span class="p">;</span> <span class="p">});</span>
<span class="ln">16</span>    <span class="c1">//如果存在，更新value值
</span><span class="ln">17</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">it</span> <span class="o">!=</span> <span class="n">persistent_properties</span><span class="o">-&gt;</span><span class="n">mutable_properties</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
<span class="ln">18</span>        <span class="n">it</span><span class="o">-&gt;</span><span class="n">set_name</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
<span class="ln">19</span>        <span class="n">it</span><span class="o">-&gt;</span><span class="n">set_value</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
<span class="ln">20</span>    <span class="c1">//不存在的话新添加到序列化格式中
</span><span class="ln">21</span><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="ln">22</span>        <span class="n">AddPersistentProperty</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">persistent_properties</span><span class="p">.</span><span class="n">value</span><span class="p">());</span>
<span class="ln">23</span>    <span class="p">}</span>
<span class="ln">24</span>    <span class="c1">//将序列化格式写入到对应的文件中，就是重新写入到/data/property/persistent_properties文件中
</span><span class="ln">25</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="k">auto</span> <span class="n">result</span> <span class="o">=</span> <span class="n">WritePersistentPropertyFile</span><span class="p">(</span><span class="o">*</span><span class="n">persistent_properties</span><span class="p">);</span> <span class="o">!</span><span class="n">result</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
<span class="ln">26</span>        <span class="n">LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Could not store persistent property: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">result</span><span class="p">.</span><span class="n">error</span><span class="p">();</span>
<span class="ln">27</span>    <span class="p">}</span>
<span class="ln">28</span><span class="p">}</span>
</code></pre></div><p><code>LoadPersistentPropertiesFromMemory</code></p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//system/core/init/persistent_properties.cpp
</span><span class="ln"> 2</span><span class="c1">//相对来说这是一个比较高阶的用法，里面存在两个匿名的函数指针
</span><span class="ln"> 3</span><span class="c1">//简单说一下值的传递6-&gt;5-&gt;4-&gt;3-&gt;2-&gt;1
</span><span class="ln"> 4</span><span class="c1"></span><span class="n">PersistentProperties</span> <span class="nf">LoadPersistentPropertiesFromMemory</span><span class="p">()</span> <span class="p">{</span>
<span class="ln"> 5</span>    <span class="n">PersistentProperties</span> <span class="n">persistent_properties</span><span class="p">;</span>
<span class="ln"> 6</span>    <span class="n">__system_property_foreach</span><span class="p">(</span>
<span class="ln"> 7</span>        <span class="c1">//这里的cookie实际上就是persistent_properties，设定为2
</span><span class="ln"> 8</span><span class="c1"></span>        <span class="p">[](</span><span class="k">const</span> <span class="n">prop_info</span><span class="o">*</span> <span class="n">pi</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">cookie</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 9</span>            <span class="n">__system_property_read_callback</span><span class="p">(</span>
<span class="ln">10</span>                <span class="n">pi</span><span class="p">,</span>
<span class="ln">11</span>                <span class="c1">//这里cookie实际上是__system_property_read_callback中第三个参数，设定为4
</span><span class="ln">12</span><span class="c1"></span>                <span class="p">[](</span><span class="kt">void</span><span class="o">*</span> <span class="n">cookie</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">value</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">serial</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">13</span>                    <span class="k">if</span> <span class="p">(</span><span class="n">StartsWith</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&#34;persist.&#34;</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">14</span>                        <span class="c1">//这里的properties是__system_property_read_callback中的匿名函数指针参数cookie，设定为5
</span><span class="ln">15</span><span class="c1"></span>                        <span class="k">auto</span> <span class="n">properties</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">PersistentProperties</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">cookie</span><span class="p">);</span>
<span class="ln">16</span>                        <span class="c1">//这里的properties的修改，会对应影响到上面cookie，设定为6
</span><span class="ln">17</span><span class="c1"></span>                        <span class="n">AddPersistentProperty</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">properties</span><span class="p">);</span>
<span class="ln">18</span>                    <span class="p">}</span>
<span class="ln">19</span>                <span class="p">},</span>
<span class="ln">20</span>                <span class="c1">//这里的cookie实际上是前面__system_property_foreach的匿名函数指针的参数，设定为3
</span><span class="ln">21</span><span class="c1"></span>                <span class="n">cookie</span><span class="p">);</span>
<span class="ln">22</span>        <span class="p">},</span>
<span class="ln">23</span>        <span class="c1">//这个persistent_properties值是传入的原始值，设定为1
</span><span class="ln">24</span><span class="c1"></span>        <span class="o">&amp;</span><span class="n">persistent_properties</span><span class="p">);</span>
<span class="ln">25</span>    <span class="k">return</span> <span class="n">persistent_properties</span><span class="p">;</span>
<span class="ln">26</span><span class="p">}</span>
</code></pre></div><p>这个函数，实际上是第一次导入<code>persist</code>文件内容的函数。读取私有匿名区域中的<code>ContextNodes</code>，<strong>遍历所有<code>ContextNode</code>中指向的<code>SElinux</code>域文件的<code>prop_area</code>所形成的的字典树</strong>。即这里是开始创建<code>/data/property/persistent_properties</code>的函数。</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/property/property_19.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/property/property_19.png" >
  
    </a>
  
  
</div>

<h1 id="3获取属性">3获取属性</h1>
<p>这里包括非<code>init</code>进程和<code>init</code>进程获取属性，这里非<code>init</code>进程有两种方式，一种是在<code>App</code>调用<code>Java层</code>或者<code>Native层</code>调用获取属性的方式，另一种是直接<code>adb</code>敲命令<code>getprop</code>。</p>
<h2 id="31app读取属性流程分析java侧">3.1App读取属性流程分析（Java侧）</h2>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//App读取属性
</span><span class="ln"> 2</span><span class="c1">//除了获取字符串属性，还有getInt、getLong、getBoolean，都可以用反射来获取，这里只说明获取字符串属性
</span><span class="ln"> 3</span><span class="c1"></span><span class="kn">import</span> <span class="nn">android.os.SystemProperties</span><span class="o">;</span>
<span class="ln"> 4</span><span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">getProperty</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="n">String</span> <span class="n">defaultValue</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 5</span>    <span class="n">String</span> <span class="n">value</span> <span class="o">=</span> <span class="n">defaultValue</span><span class="o">;</span>
<span class="ln"> 6</span>    <span class="k">try</span> <span class="o">{</span>
<span class="ln"> 7</span>        <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">&#34;android.os.SystemProperties&#34;</span><span class="o">);</span>
<span class="ln"> 8</span>        <span class="n">Method</span> <span class="n">get</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="s">&#34;get&#34;</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="ln"> 9</span>        <span class="n">value</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="o">(</span><span class="n">get</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">defaultValue</span><span class="o">));</span>
<span class="ln">10</span>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">11</span>        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
<span class="ln">12</span>    <span class="o">}</span>
<span class="ln">13</span>    <span class="k">return</span> <span class="n">value</span><span class="o">;</span>
<span class="ln">14</span><span class="o">}</span>
<span class="ln">15</span>
<span class="ln">16</span><span class="n">String</span> <span class="n">strValue</span> <span class="o">=</span> <span class="n">getProperty</span><span class="o">(</span><span class="s">&#34;persist.a.b.c&#34;</span><span class="o">,</span> <span class="s">&#34;0&#34;</span><span class="o">);</span>
</code></pre></div><h3 id="311systempropertiesget">3.1.1<code>SystemProperties.get</code></h3>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/core/java/android/os/SystemProperties.java
</span><span class="ln"> 2</span><span class="c1">//这四个对外提供的接口都是隐藏的，通常需要用反射来调用
</span><span class="ln"> 3</span><span class="c1">//onKeyAccess是用于检查查询属性名的合法性
</span><span class="ln"> 4</span><span class="c1"></span><span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">get</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="n">String</span> <span class="n">def</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 5</span>    <span class="k">if</span> <span class="o">(</span><span class="n">TRACK_KEY_ACCESS</span><span class="o">)</span> <span class="n">onKeyAccess</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
<span class="ln"> 6</span>    <span class="k">return</span> <span class="n">native_get</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">def</span><span class="o">);</span>
<span class="ln"> 7</span><span class="o">}</span>
<span class="ln"> 8</span>
<span class="ln"> 9</span><span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">getInt</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="kt">int</span> <span class="n">def</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">10</span>    <span class="k">if</span> <span class="o">(</span><span class="n">TRACK_KEY_ACCESS</span><span class="o">)</span> <span class="n">onKeyAccess</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
<span class="ln">11</span>    <span class="k">return</span> <span class="n">native_get_int</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">def</span><span class="o">);</span>
<span class="ln">12</span><span class="o">}</span>
<span class="ln">13</span>
<span class="ln">14</span><span class="kd">public</span> <span class="kd">static</span> <span class="kt">long</span> <span class="nf">getLong</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="kt">long</span> <span class="n">def</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">15</span>    <span class="k">if</span> <span class="o">(</span><span class="n">TRACK_KEY_ACCESS</span><span class="o">)</span> <span class="n">onKeyAccess</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
<span class="ln">16</span>    <span class="k">return</span> <span class="n">native_get_long</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">def</span><span class="o">);</span>
<span class="ln">17</span><span class="o">}</span>
<span class="ln">18</span>
<span class="ln">19</span><span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">getBoolean</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">def</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">20</span>    <span class="k">if</span> <span class="o">(</span><span class="n">TRACK_KEY_ACCESS</span><span class="o">)</span> <span class="n">onKeyAccess</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
<span class="ln">21</span>    <span class="k">return</span> <span class="n">native_get_boolean</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">def</span><span class="o">);</span>
<span class="ln">22</span><span class="o">}</span>   
</code></pre></div><h3 id="312native_get">3.1.2<code>native_get</code></h3>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//frameworks\base\core\jni\android_os_SystemProperties.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="kt">int</span> <span class="nf">register_android_os_SystemProperties</span><span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">)</span>
<span class="ln"> 3</span><span class="p">{</span>
<span class="ln"> 4</span>    <span class="k">const</span> <span class="n">JNINativeMethod</span> <span class="n">method_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="ln"> 5</span>        <span class="c1">//字符串就是对应SystemProperties_getSS这个函数名
</span><span class="ln"> 6</span><span class="c1"></span>        <span class="p">{</span> <span class="s">&#34;native_get&#34;</span><span class="p">,</span>
<span class="ln"> 7</span>          <span class="s">&#34;(Ljava/lang/String;Ljava/lang/String;)Ljava/lang/String;&#34;</span><span class="p">,</span>
<span class="ln"> 8</span>          <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="n">SystemProperties_getSS</span> <span class="p">},</span>
<span class="ln"> 9</span>        <span class="p">{</span> <span class="s">&#34;native_get_int&#34;</span><span class="p">,</span> <span class="s">&#34;(Ljava/lang/String;I)I&#34;</span><span class="p">,</span>
<span class="ln">10</span>          <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="n">SystemProperties_get_integral</span><span class="o">&lt;</span><span class="n">jint</span><span class="o">&gt;</span> <span class="p">},</span>
<span class="ln">11</span>        <span class="p">{</span> <span class="s">&#34;native_get_long&#34;</span><span class="p">,</span> <span class="s">&#34;(Ljava/lang/String;J)J&#34;</span><span class="p">,</span>
<span class="ln">12</span>          <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="n">SystemProperties_get_integral</span><span class="o">&lt;</span><span class="n">jlong</span><span class="o">&gt;</span> <span class="p">},</span>
<span class="ln">13</span>        <span class="p">{</span> <span class="s">&#34;native_get_boolean&#34;</span><span class="p">,</span> <span class="s">&#34;(Ljava/lang/String;Z)Z&#34;</span><span class="p">,</span>
<span class="ln">14</span>          <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="n">SystemProperties_get_boolean</span> <span class="p">},</span>
<span class="ln">15</span>        <span class="p">{</span> <span class="s">&#34;native_find&#34;</span><span class="p">,</span>
<span class="ln">16</span>          <span class="s">&#34;(Ljava/lang/String;)J&#34;</span><span class="p">,</span>
<span class="ln">17</span>          <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="n">SystemProperties_find</span> <span class="p">},</span>
<span class="ln">18</span>        <span class="p">...</span>
<span class="ln">19</span>    <span class="p">};</span>
<span class="ln">20</span>    <span class="k">return</span> <span class="n">RegisterMethodsOrDie</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s">&#34;android/os/SystemProperties&#34;</span><span class="p">,</span>
<span class="ln">21</span>                                <span class="n">method_table</span><span class="p">,</span> <span class="n">NELEM</span><span class="p">(</span><span class="n">method_table</span><span class="p">));</span>
<span class="ln">22</span><span class="p">}</span>
<span class="ln">23</span><span class="c1">//最终根据传入不同的函数指针来完成不同类型的属性获取
</span><span class="ln">24</span><span class="c1"></span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Functor</span><span class="o">&gt;</span>
<span class="ln">25</span><span class="kt">void</span> <span class="n">ReadProperty</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span> <span class="n">jstring</span> <span class="n">keyJ</span><span class="p">,</span> <span class="n">Functor</span><span class="o">&amp;&amp;</span> <span class="n">functor</span><span class="p">)</span>
<span class="ln">26</span><span class="p">{</span>
<span class="ln">27</span>    <span class="n">ScopedUtfChars</span> <span class="nf">key</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">keyJ</span><span class="p">);</span>
<span class="ln">28</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">key</span><span class="p">.</span><span class="n">c_str</span><span class="p">())</span> <span class="p">{</span>
<span class="ln">29</span>        <span class="k">return</span><span class="p">;</span>
<span class="ln">30</span>    <span class="p">}</span>
<span class="ln">31</span><span class="c1">//下面这个__BIONIC__，在一开始编译bionic的时候就已经编译进去了    
</span><span class="ln">32</span><span class="c1"></span><span class="cp">#if defined(__BIONIC__)
</span><span class="ln">33</span><span class="cp"></span>    <span class="c1">//1.寻找到属性名对应的Selinux的域名
</span><span class="ln">34</span><span class="c1"></span>    <span class="k">const</span> <span class="n">prop_info</span><span class="o">*</span> <span class="n">prop</span> <span class="o">=</span> <span class="n">__system_property_find</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="ln">35</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prop</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">36</span>        <span class="k">return</span><span class="p">;</span>
<span class="ln">37</span>    <span class="p">}</span>
<span class="ln">38</span>    <span class="n">ReadProperty</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">Functor</span><span class="o">&gt;</span><span class="p">(</span><span class="n">functor</span><span class="p">));</span>
<span class="ln">39</span><span class="cp">#else
</span><span class="ln">40</span><span class="cp"></span>    <span class="n">std</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">Functor</span><span class="o">&gt;</span><span class="p">(</span><span class="n">functor</span><span class="p">)(</span>
<span class="ln">41</span>        <span class="n">android</span><span class="o">::</span><span class="n">base</span><span class="o">::</span><span class="n">GetProperty</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="s">&#34;&#34;</span><span class="p">).</span><span class="n">c_str</span><span class="p">());</span>
<span class="ln">42</span><span class="cp">#endif
</span><span class="ln">43</span><span class="cp"></span><span class="p">}</span>
<span class="ln">44</span>
<span class="ln">45</span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Functor</span><span class="o">&gt;</span>
<span class="ln">46</span><span class="kt">void</span> <span class="n">ReadProperty</span><span class="p">(</span><span class="k">const</span> <span class="n">prop_info</span><span class="o">*</span> <span class="n">prop</span><span class="p">,</span> <span class="n">Functor</span><span class="o">&amp;&amp;</span> <span class="n">functor</span><span class="p">)</span>
<span class="ln">47</span><span class="p">{</span>
<span class="ln">48</span><span class="cp">#if defined(__BIONIC__)
</span><span class="ln">49</span><span class="cp"></span>    <span class="k">auto</span> <span class="n">thunk</span> <span class="o">=</span> <span class="p">[](</span><span class="kt">void</span><span class="o">*</span> <span class="n">cookie</span><span class="p">,</span>
<span class="ln">50</span>                    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="cm">/*name*/</span><span class="p">,</span>
<span class="ln">51</span>                    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">value</span><span class="p">,</span>
<span class="ln">52</span>                    <span class="kt">uint32_t</span> <span class="cm">/*serial*/</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">53</span>        <span class="n">std</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">Functor</span><span class="o">&gt;</span><span class="p">(</span><span class="o">*</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Functor</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">cookie</span><span class="p">))(</span><span class="n">value</span><span class="p">);</span>
<span class="ln">54</span>    <span class="p">};</span>
<span class="ln">55</span>    <span class="c1">//2.进行属性名的读取
</span><span class="ln">56</span><span class="c1"></span>    <span class="n">__system_property_read_callback</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">thunk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">functor</span><span class="p">);</span>
<span class="ln">57</span><span class="cp">#else
</span><span class="ln">58</span><span class="cp"></span>    <span class="n">LOG</span><span class="p">(</span><span class="n">FATAL</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;fast property access supported only on device&#34;</span><span class="p">;</span>
<span class="ln">59</span><span class="cp">#endif
</span><span class="ln">60</span><span class="cp"></span><span class="p">}</span>
<span class="ln">61</span>
<span class="ln">62</span><span class="c1">//这个是字符串的属性获取
</span><span class="ln">63</span><span class="c1"></span><span class="n">jstring</span> <span class="nf">SystemProperties_getSS</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span> <span class="n">jclass</span> <span class="n">clazz</span><span class="p">,</span> <span class="n">jstring</span> <span class="n">keyJ</span><span class="p">,</span>
<span class="ln">64</span>                               <span class="n">jstring</span> <span class="n">defJ</span><span class="p">)</span>
<span class="ln">65</span><span class="p">{</span>
<span class="ln">66</span>    <span class="n">jstring</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">defJ</span><span class="p">;</span>
<span class="ln">67</span>    <span class="n">ReadProperty</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">keyJ</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">68</span>        <span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
<span class="ln">69</span>            <span class="n">ret</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">NewStringUTF</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
<span class="ln">70</span><span class="p">}</span>
<span class="ln">71</span>    <span class="p">});</span>
<span class="ln">72</span>    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="k">nullptr</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">env</span><span class="o">-&gt;</span><span class="n">ExceptionCheck</span><span class="p">())</span> <span class="p">{</span>
<span class="ln">73</span>      <span class="n">ret</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">NewStringUTF</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">);</span>  <span class="c1">// Legacy behavior
</span><span class="ln">74</span><span class="c1"></span>    <span class="p">}</span>
<span class="ln">75</span>    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="ln">76</span><span class="p">}</span>
<span class="ln">77</span><span class="c1">//这个是Int和Long的属性获取
</span><span class="ln">78</span><span class="c1"></span><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="ln">79</span><span class="n">T</span> <span class="n">SystemProperties_get_integral</span><span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span> <span class="n">jclass</span><span class="p">,</span> <span class="n">jstring</span> <span class="n">keyJ</span><span class="p">,</span>
<span class="ln">80</span>                                       <span class="n">T</span> <span class="n">defJ</span><span class="p">)</span>
<span class="ln">81</span><span class="p">{</span>
<span class="ln">82</span>    <span class="n">T</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">defJ</span><span class="p">;</span>
<span class="ln">83</span>    <span class="n">ReadProperty</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">keyJ</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">84</span>        <span class="n">android</span><span class="o">::</span><span class="n">base</span><span class="o">::</span><span class="n">ParseInt</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ret</span><span class="p">);</span>
<span class="ln">85</span>    <span class="p">});</span>
<span class="ln">86</span>    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="ln">87</span><span class="p">}</span>
<span class="ln">88</span><span class="c1">//这个是boolean的属性获取
</span><span class="ln">89</span><span class="c1"></span><span class="n">jboolean</span> <span class="nf">SystemProperties_get_boolean</span><span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span> <span class="n">jclass</span><span class="p">,</span> <span class="n">jstring</span> <span class="n">keyJ</span><span class="p">,</span>
<span class="ln">90</span>                                      <span class="n">jboolean</span> <span class="n">defJ</span><span class="p">)</span>
<span class="ln">91</span><span class="p">{</span>
<span class="ln">92</span>    <span class="n">ParseBoolResult</span> <span class="n">parseResult</span> <span class="o">=</span> <span class="n">ParseBoolResult</span><span class="o">::</span><span class="n">kError</span><span class="p">;</span>
<span class="ln">93</span>    <span class="n">ReadProperty</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">keyJ</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">94</span>        <span class="n">parseResult</span> <span class="o">=</span> <span class="n">android</span><span class="o">::</span><span class="n">base</span><span class="o">::</span><span class="n">ParseBool</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
<span class="ln">95</span>    <span class="p">});</span>
<span class="ln">96</span>    <span class="k">return</span> <span class="n">jbooleanFromParseBoolResult</span><span class="p">(</span><span class="n">parseResult</span><span class="p">,</span> <span class="n">defJ</span><span class="p">);</span>
<span class="ln">97</span><span class="p">}</span>
</code></pre></div><p>上面的逻辑就是如果定义了<code>__BIONIC__</code>，那么直接就是先调用<code>__system_property_find</code>，后调用<code>__system_property_read_callback</code>。没有定义<code>__BIONIC__</code>的话，只能调用<code>GetProperty</code>。</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln">1</span><span class="c1">//bionic/tools/versioner/current/sys/cdefs.h
</span><span class="ln">2</span><span class="c1"></span><span class="cp">#define __BIONIC__ 1	</span><span class="c1">//默认已经定义
</span></code></pre></div><h4 id="3121__system_property_find">3.1.2.1<code>__system_property_find</code></h4>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln">1</span><span class="c1">//bionic/libc/bionic/system_property_api.cpp
</span><span class="ln">2</span><span class="c1"></span><span class="n">__BIONIC_WEAK_FOR_NATIVE_BRIDGE</span>
<span class="ln">3</span><span class="k">const</span> <span class="n">prop_info</span><span class="o">*</span> <span class="nf">__system_property_find</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">4</span>  <span class="k">return</span> <span class="n">system_properties</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
<span class="ln">5</span><span class="p">}</span>
</code></pre></div><p><code>system_properties.Find</code></p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//bionic/libc/system_properties/system_properties.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="k">const</span> <span class="n">prop_info</span><span class="o">*</span> <span class="n">SystemProperties</span><span class="o">::</span><span class="n">Find</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 3</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">initialized_</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 4</span>    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
<span class="ln"> 5</span>  <span class="p">}</span>
<span class="ln"> 6</span>
<span class="ln"> 7</span>  <span class="n">prop_area</span><span class="o">*</span> <span class="n">pa</span> <span class="o">=</span> <span class="n">contexts_</span><span class="o">-&gt;</span><span class="n">GetPropAreaForName</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
<span class="ln"> 8</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pa</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 9</span>    <span class="n">async_safe_format_log</span><span class="p">(</span><span class="n">ANDROID_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;libc&#34;</span><span class="p">,</span> <span class="s">&#34;Access denied finding property </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="ln">10</span>    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
<span class="ln">11</span>  <span class="p">}</span>
<span class="ln">12</span>
<span class="ln">13</span>  <span class="k">return</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">find</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
<span class="ln">14</span><span class="p">}</span>
</code></pre></div><h4 id="3122__system_property_read_callback">3.1.2.2<code>__system_property_read_callback</code></h4>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln">1</span><span class="c1">//bionic/libc/bionic/system_property_api.cpp
</span><span class="ln">2</span><span class="c1"></span><span class="n">__BIONIC_WEAK_FOR_NATIVE_BRIDGE</span>
<span class="ln">3</span><span class="kt">void</span> <span class="nf">__system_property_read_callback</span><span class="p">(</span><span class="k">const</span> <span class="n">prop_info</span><span class="o">*</span> <span class="n">pi</span><span class="p">,</span>
<span class="ln">4</span>                                     <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)(</span><span class="kt">void</span><span class="o">*</span> <span class="n">cookie</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">,</span>
<span class="ln">5</span>                                                      <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">value</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">serial</span><span class="p">),</span>
<span class="ln">6</span>                                     <span class="kt">void</span><span class="o">*</span> <span class="n">cookie</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">7</span>  <span class="k">return</span> <span class="n">system_properties</span><span class="p">.</span><span class="n">ReadCallback</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">cookie</span><span class="p">);</span>
<span class="ln">8</span><span class="p">}</span>
</code></pre></div><p><code>system_properties.ReadCallback</code></p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//bionic/libc/system_properties/system_properties.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="kt">void</span> <span class="n">SystemProperties</span><span class="o">::</span><span class="n">ReadCallback</span><span class="p">(</span><span class="k">const</span> <span class="n">prop_info</span><span class="o">*</span> <span class="n">pi</span><span class="p">,</span>
<span class="ln"> 3</span>                                    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)(</span><span class="kt">void</span><span class="o">*</span> <span class="n">cookie</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">,</span>
<span class="ln"> 4</span>                                                     <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">value</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">serial</span><span class="p">),</span>
<span class="ln"> 5</span>                                    <span class="kt">void</span><span class="o">*</span> <span class="n">cookie</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 6</span>  <span class="p">...</span>
<span class="ln"> 7</span>  <span class="kt">char</span> <span class="n">value_buf</span><span class="p">[</span><span class="n">PROP_VALUE_MAX</span><span class="p">];</span>
<span class="ln"> 8</span>  <span class="kt">uint32_t</span> <span class="n">serial</span> <span class="o">=</span> <span class="n">ReadMutablePropertyValue</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">value_buf</span><span class="p">);</span>
<span class="ln"> 9</span>  <span class="n">callback</span><span class="p">(</span><span class="n">cookie</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">value_buf</span><span class="p">,</span> <span class="n">serial</span><span class="p">);</span>
<span class="ln">10</span>  <span class="p">}</span>
<span class="ln">11</span>
<span class="ln">12</span><span class="kt">uint32_t</span> <span class="n">SystemProperties</span><span class="o">::</span><span class="n">ReadMutablePropertyValue</span><span class="p">(</span><span class="k">const</span> <span class="n">prop_info</span><span class="o">*</span> <span class="n">pi</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">13</span>  <span class="kt">uint32_t</span> <span class="n">new_serial</span> <span class="o">=</span> <span class="n">load_const_atomic</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">,</span> <span class="n">memory_order_acquire</span><span class="p">);</span>
<span class="ln">14</span>  <span class="kt">uint32_t</span> <span class="n">serial</span><span class="p">;</span>
<span class="ln">15</span>  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
<span class="ln">16</span>  <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
<span class="ln">17</span>    <span class="n">serial</span> <span class="o">=</span> <span class="n">new_serial</span><span class="p">;</span>
<span class="ln">18</span>    <span class="n">len</span> <span class="o">=</span> <span class="n">SERIAL_VALUE_LEN</span><span class="p">(</span><span class="n">serial</span><span class="p">);</span>
<span class="ln">19</span>    <span class="k">if</span> <span class="p">(</span><span class="n">__predict_false</span><span class="p">(</span><span class="n">SERIAL_DIRTY</span><span class="p">(</span><span class="n">serial</span><span class="p">)))</span> <span class="p">{</span>
<span class="ln">20</span>      <span class="p">...</span>
<span class="ln">21</span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="ln">22</span>      <span class="n">memcpy</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="ln">23</span>  <span class="p">}</span>
<span class="ln">24</span>    <span class="n">atomic_thread_fence</span><span class="p">(</span><span class="n">memory_order_acquire</span><span class="p">);</span>
<span class="ln">25</span>    <span class="n">new_serial</span> <span class="o">=</span> <span class="n">load_const_atomic</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">,</span> <span class="n">memory_order_relaxed</span><span class="p">);</span>
<span class="ln">26</span>    <span class="k">if</span> <span class="p">(</span><span class="n">__predict_true</span><span class="p">(</span><span class="n">serial</span> <span class="o">==</span> <span class="n">new_serial</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">27</span>      <span class="k">break</span><span class="p">;</span>
<span class="ln">28</span>      <span class="p">}</span>
<span class="ln">29</span>    <span class="n">atomic_thread_fence</span><span class="p">(</span><span class="n">memory_order_acquire</span><span class="p">);</span>
<span class="ln">30</span>    <span class="p">}</span>
<span class="ln">31</span>  <span class="k">return</span> <span class="n">serial</span><span class="p">;</span>
<span class="ln">32</span><span class="p">}</span>
</code></pre></div>

 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/property/property_27.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/property/property_27.png" >
  
    </a>
  
  
</div>

<h2 id="32app读取属性流程分析native侧">3.2App读取属性流程分析（native侧）</h2>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln">1</span><span class="c1">//App通过封装的so进行读取属性
</span><span class="ln">2</span><span class="c1"></span><span class="cp">#include</span> <span class="cpf">&lt;cutils/properties.h&gt;</span><span class="cp">
</span><span class="ln">3</span><span class="cp">#define PROPERTY_KEY_MAX   32
</span><span class="ln">4</span><span class="cp">#define PROPERTY_VALUE_MAX  92
</span><span class="ln">5</span><span class="cp"></span><span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="o">=</span> <span class="k">new</span> <span class="kt">char</span><span class="p">[</span><span class="n">PROPERTY_VALUE_MAX</span><span class="p">];</span>
<span class="ln">6</span><span class="n">property_get</span><span class="p">(</span><span class="s">&#34;persist.a.b.c&#34;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="s">&#34;0&#34;</span><span class="p">);</span>
<span class="ln">7</span><span class="n">property_get_int32</span><span class="p">(</span><span class="s">&#34;persist.a.b.c.int&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="ln">8</span><span class="n">property_get_int64</span><span class="p">(</span><span class="s">&#34;persist.a.b.c.long&#34;</span><span class="p">,</span> <span class="mi">0L</span><span class="p">);</span>
<span class="ln">9</span><span class="n">property_get_bool</span><span class="p">(</span><span class="s">&#34;persist.a.b.c.boolean&#34;</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
</code></pre></div><h3 id="321property_get">3.2.1<code>property_get</code></h3>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//system/core/libcutils/properties.cpp
</span><span class="ln"> 2</span><span class="c1">//获取bool类型的属性，其实也是间接调用property_get，然后自己在封装成bool类型
</span><span class="ln"> 3</span><span class="c1"></span><span class="kt">int8_t</span> <span class="nf">property_get_bool</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">int8_t</span> <span class="n">default_value</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 4</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 5</span>        <span class="k">return</span> <span class="n">default_value</span><span class="p">;</span>
<span class="ln"> 6</span>  <span class="p">}</span>
<span class="ln"> 7</span>
<span class="ln"> 8</span>    <span class="kt">int8_t</span> <span class="n">result</span> <span class="o">=</span> <span class="n">default_value</span><span class="p">;</span>
<span class="ln"> 9</span>    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">PROPERTY_VALUE_MAX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="sc">&#39;\0&#39;</span><span class="p">};</span>
<span class="ln">10</span>
<span class="ln">11</span>    <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">property_get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">);</span>
<span class="ln">12</span>    <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">13</span>        <span class="kt">char</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="ln">14</span>        <span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="sc">&#39;0&#39;</span> <span class="o">||</span> <span class="n">ch</span> <span class="o">==</span> <span class="sc">&#39;n&#39;</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">15</span>            <span class="n">result</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="ln">16</span>        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="sc">&#39;1&#39;</span> <span class="o">||</span> <span class="n">ch</span> <span class="o">==</span> <span class="sc">&#39;y&#39;</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">17</span>            <span class="n">result</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="ln">18</span>        <span class="p">}</span>
<span class="ln">19</span>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">20</span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&#34;no&#34;</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&#34;false&#34;</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&#34;off&#34;</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">21</span>            <span class="n">result</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="ln">22</span>        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&#34;yes&#34;</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&#34;true&#34;</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&#34;on&#34;</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">23</span>            <span class="n">result</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="ln">24</span>  <span class="p">}</span>
<span class="ln">25</span><span class="p">}</span>
<span class="ln">26</span>
<span class="ln">27</span>    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="ln">28</span><span class="p">}</span>
<span class="ln">29</span><span class="c1">//获取Long和Int类型的属性，核心的内容是property_get，然后自己在封装成Long和Int类型
</span><span class="ln">30</span><span class="c1"></span><span class="k">static</span> <span class="n">intmax_t</span> <span class="nf">property_get_imax</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="n">intmax_t</span> <span class="n">lower_bound</span><span class="p">,</span> <span class="n">intmax_t</span> <span class="n">upper_bound</span><span class="p">,</span>
<span class="ln">31</span>                                  <span class="n">intmax_t</span> <span class="n">default_value</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">32</span>    <span class="p">...</span>
<span class="ln">33</span>    <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">property_get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">);</span>
<span class="ln">34</span>    <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">35</span>        <span class="kt">int</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">errno</span><span class="p">;</span>
<span class="ln">36</span>        <span class="n">errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="ln">37</span>
<span class="ln">38</span>        <span class="c1">// Infer base automatically
</span><span class="ln">39</span><span class="c1"></span>        <span class="n">result</span> <span class="o">=</span> <span class="n">strtoimax</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">end</span><span class="p">,</span> <span class="cm">/*base*/</span> <span class="mi">0</span><span class="p">);</span>
<span class="ln">40</span>        <span class="k">if</span> <span class="p">((</span><span class="n">result</span> <span class="o">==</span> <span class="n">INTMAX_MIN</span> <span class="o">||</span> <span class="n">result</span> <span class="o">==</span> <span class="n">INTMAX_MAX</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">errno</span> <span class="o">==</span> <span class="n">ERANGE</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">41</span>            <span class="c1">// Over or underflow
</span><span class="ln">42</span><span class="c1"></span>            <span class="n">result</span> <span class="o">=</span> <span class="n">default_value</span><span class="p">;</span>
<span class="ln">43</span>            <span class="n">ALOGV</span><span class="p">(</span><span class="s">&#34;%s(%s,%&#34;</span> <span class="n">PRIdMAX</span> <span class="s">&#34;) - overflow&#34;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default_value</span><span class="p">);</span>
<span class="ln">44</span>        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="n">lower_bound</span> <span class="o">||</span> <span class="n">result</span> <span class="o">&gt;</span> <span class="n">upper_bound</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">45</span>            <span class="c1">// Out of range of requested bounds
</span><span class="ln">46</span><span class="c1"></span>            <span class="n">result</span> <span class="o">=</span> <span class="n">default_value</span><span class="p">;</span>
<span class="ln">47</span>            <span class="n">ALOGV</span><span class="p">(</span><span class="s">&#34;%s(%s,%&#34;</span> <span class="n">PRIdMAX</span> <span class="s">&#34;) - out of range&#34;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default_value</span><span class="p">);</span>
<span class="ln">48</span>        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">==</span> <span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">49</span>            <span class="c1">// Numeric conversion failed
</span><span class="ln">50</span><span class="c1"></span>            <span class="n">result</span> <span class="o">=</span> <span class="n">default_value</span><span class="p">;</span>
<span class="ln">51</span>            <span class="n">ALOGV</span><span class="p">(</span><span class="s">&#34;%s(%s,%&#34;</span> <span class="n">PRIdMAX</span> <span class="s">&#34;) - numeric conversion failed&#34;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span>
<span class="ln">52</span>                  <span class="n">default_value</span><span class="p">);</span>
<span class="ln">53</span>        <span class="p">}</span>
<span class="ln">54</span>
<span class="ln">55</span>        <span class="n">errno</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
<span class="ln">56</span>  <span class="p">}</span>
<span class="ln">57</span>
<span class="ln">58</span>    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="ln">59</span>  <span class="p">}</span>
<span class="ln">60</span>
<span class="ln">61</span><span class="c1">//获取Long类型的属性
</span><span class="ln">62</span><span class="c1"></span><span class="kt">int64_t</span> <span class="nf">property_get_int64</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">int64_t</span> <span class="n">default_value</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">63</span>    <span class="k">return</span> <span class="p">(</span><span class="kt">int64_t</span><span class="p">)</span><span class="n">property_get_imax</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">INT64_MIN</span><span class="p">,</span> <span class="n">INT64_MAX</span><span class="p">,</span> <span class="n">default_value</span><span class="p">);</span>
<span class="ln">64</span><span class="p">}</span>
<span class="ln">65</span><span class="c1">//获取Int类型的属性
</span><span class="ln">66</span><span class="c1"></span><span class="kt">int32_t</span> <span class="nf">property_get_int32</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">int32_t</span> <span class="n">default_value</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">67</span>    <span class="k">return</span> <span class="p">(</span><span class="kt">int32_t</span><span class="p">)</span><span class="n">property_get_imax</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">INT32_MIN</span><span class="p">,</span> <span class="n">INT32_MAX</span><span class="p">,</span> <span class="n">default_value</span><span class="p">);</span>
<span class="ln">68</span><span class="p">}</span>
<span class="ln">69</span><span class="c1">//获取字符串类型的属性
</span><span class="ln">70</span><span class="c1"></span><span class="kt">int</span> <span class="nf">property_get</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">default_value</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">71</span>    <span class="c1">//最终调用的就是__system_property_get函数
</span><span class="ln">72</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">__system_property_get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="ln">73</span>    <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">74</span>        <span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="ln">75</span>    <span class="p">}</span>
<span class="ln">76</span>    <span class="k">if</span> <span class="p">(</span><span class="n">default_value</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">77</span>        <span class="n">len</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">default_value</span><span class="p">,</span> <span class="n">PROPERTY_VALUE_MAX</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="ln">78</span>        <span class="n">memcpy</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">default_value</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="ln">79</span>        <span class="n">value</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<span class="ln">80</span>    <span class="p">}</span>
<span class="ln">81</span>    <span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="ln">82</span><span class="p">}</span>
</code></pre></div><h3 id="322__system_property_get">3.2.2<code>__system_property_get</code></h3>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln">1</span><span class="c1">//bionic/libc/bionic/system_property_api.cpp
</span><span class="ln">2</span><span class="c1"></span> <span class="n">__BIONIC_WEAK_FOR_NATIVE_BRIDGE</span>
<span class="ln">3</span><span class="kt">int</span> <span class="nf">__system_property_get</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">4</span>    <span class="k">return</span> <span class="n">system_properties</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="ln">5</span><span class="p">}</span>
</code></pre></div><h3 id="323system_propertiesget">3.2.3<code>system_properties.Get</code></h3>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//bionic/libc/system_properties/system_properties.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="kt">int</span> <span class="n">SystemProperties</span><span class="o">::</span><span class="n">Get</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 3</span>  <span class="k">const</span> <span class="n">prop_info</span><span class="o">*</span> <span class="n">pi</span> <span class="o">=</span> <span class="n">Find</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
<span class="ln"> 4</span>
<span class="ln"> 5</span>  <span class="k">if</span> <span class="p">(</span><span class="n">pi</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 6</span>    <span class="k">return</span> <span class="nf">Read</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="ln"> 7</span>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="ln"> 8</span>    <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="ln"> 9</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="ln">10</span>  <span class="p">}</span>
<span class="ln">11</span>  <span class="p">}</span>
<span class="ln">12</span>
<span class="ln">13</span><span class="k">const</span> <span class="n">prop_info</span><span class="o">*</span> <span class="n">SystemProperties</span><span class="o">::</span><span class="n">Find</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">14</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">initialized_</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">15</span>    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
<span class="ln">16</span>  <span class="p">}</span>
<span class="ln">17</span>
<span class="ln">18</span>  <span class="n">prop_area</span><span class="o">*</span> <span class="n">pa</span> <span class="o">=</span> <span class="n">contexts_</span><span class="o">-&gt;</span><span class="n">GetPropAreaForName</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
<span class="ln">19</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pa</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">20</span>    <span class="n">async_safe_format_log</span><span class="p">(</span><span class="n">ANDROID_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;libc&#34;</span><span class="p">,</span> <span class="s">&#34;Access denied finding property </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="ln">21</span>    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
<span class="ln">22</span>  <span class="p">}</span>
<span class="ln">23</span>
<span class="ln">24</span>  <span class="k">return</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">find</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
<span class="ln">25</span>  <span class="p">}</span>
<span class="ln">26</span>
<span class="ln">27</span><span class="kt">int</span> <span class="n">SystemProperties</span><span class="o">::</span><span class="n">Read</span><span class="p">(</span><span class="k">const</span> <span class="n">prop_info</span><span class="o">*</span> <span class="n">pi</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">28</span>  <span class="kt">uint32_t</span> <span class="n">serial</span> <span class="o">=</span> <span class="n">ReadMutablePropertyValue</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="ln">29</span>  <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">30</span>    <span class="n">size_t</span> <span class="n">namelen</span> <span class="o">=</span> <span class="n">strlcpy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">PROP_NAME_MAX</span><span class="p">);</span>
<span class="ln">31</span>    <span class="k">if</span> <span class="p">(</span><span class="n">namelen</span> <span class="o">&gt;=</span> <span class="n">PROP_NAME_MAX</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">32</span>      <span class="n">async_safe_format_log</span><span class="p">(</span><span class="n">ANDROID_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;libc&#34;</span><span class="p">,</span>
<span class="ln">33</span>                            <span class="s">&#34;The property name length for </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s"> is &gt;= %d;&#34;</span>
<span class="ln">34</span>                            <span class="s">&#34; please use __system_property_read_callback&#34;</span>
<span class="ln">35</span>                            <span class="s">&#34; to read this property. (the name is truncated to </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">)&#34;</span><span class="p">,</span>
<span class="ln">36</span>                            <span class="n">pi</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">PROP_NAME_MAX</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="ln">37</span>    <span class="p">}</span>
<span class="ln">38</span>  <span class="p">}</span>
<span class="ln">39</span>  <span class="k">if</span> <span class="p">(</span><span class="n">is_read_only</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">is_long</span><span class="p">())</span> <span class="p">{</span>
<span class="ln">40</span>    <span class="n">async_safe_format_log</span><span class="p">(</span>
<span class="ln">41</span>        <span class="n">ANDROID_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;libc&#34;</span><span class="p">,</span>
<span class="ln">42</span>        <span class="s">&#34;The property </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s"> has a value with length %zu that is too large for&#34;</span>
<span class="ln">43</span>        <span class="s">&#34; __system_property_get()/__system_property_read(); use&#34;</span>
<span class="ln">44</span>        <span class="s">&#34; __system_property_read_callback() instead.&#34;</span><span class="p">,</span>
<span class="ln">45</span>        <span class="n">pi</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">long_value</span><span class="p">()));</span>
<span class="ln">46</span>  <span class="p">}</span>
<span class="ln">47</span>  <span class="k">return</span> <span class="nf">SERIAL_VALUE_LEN</span><span class="p">(</span><span class="n">serial</span><span class="p">);</span>
<span class="ln">48</span>  <span class="p">}</span>
<span class="ln">49</span>
<span class="ln">50</span><span class="kt">uint32_t</span> <span class="n">SystemProperties</span><span class="o">::</span><span class="n">ReadMutablePropertyValue</span><span class="p">(</span><span class="k">const</span> <span class="n">prop_info</span><span class="o">*</span> <span class="n">pi</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">51</span>  <span class="c1">// We assume the memcpy below gets serialized by the acquire fence.
</span><span class="ln">52</span><span class="c1"></span>  <span class="kt">uint32_t</span> <span class="n">new_serial</span> <span class="o">=</span> <span class="n">load_const_atomic</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">,</span> <span class="n">memory_order_acquire</span><span class="p">);</span>
<span class="ln">53</span>  <span class="kt">uint32_t</span> <span class="n">serial</span><span class="p">;</span>
<span class="ln">54</span>  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
<span class="ln">55</span>  <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
<span class="ln">56</span>    <span class="n">serial</span> <span class="o">=</span> <span class="n">new_serial</span><span class="p">;</span>
<span class="ln">57</span>    <span class="n">len</span> <span class="o">=</span> <span class="n">SERIAL_VALUE_LEN</span><span class="p">(</span><span class="n">serial</span><span class="p">);</span>
<span class="ln">58</span>    <span class="k">if</span> <span class="p">(</span><span class="n">__predict_false</span><span class="p">(</span><span class="n">SERIAL_DIRTY</span><span class="p">(</span><span class="n">serial</span><span class="p">)))</span> <span class="p">{</span>
<span class="ln">59</span>      <span class="c1">// See the comment in the prop_area constructor.
</span><span class="ln">60</span><span class="c1"></span>      <span class="n">prop_area</span><span class="o">*</span> <span class="n">pa</span> <span class="o">=</span> <span class="n">contexts_</span><span class="o">-&gt;</span><span class="n">GetPropAreaForName</span><span class="p">(</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="ln">61</span>      <span class="n">memcpy</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">dirty_backup_area</span><span class="p">(),</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="ln">62</span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="ln">63</span>      <span class="n">memcpy</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="ln">64</span><span class="p">}</span>
<span class="ln">65</span>    <span class="n">atomic_thread_fence</span><span class="p">(</span><span class="n">memory_order_acquire</span><span class="p">);</span>
<span class="ln">66</span>    <span class="n">new_serial</span> <span class="o">=</span> <span class="n">load_const_atomic</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">,</span> <span class="n">memory_order_relaxed</span><span class="p">);</span>
<span class="ln">67</span>    <span class="k">if</span> <span class="p">(</span><span class="n">__predict_true</span><span class="p">(</span><span class="n">serial</span> <span class="o">==</span> <span class="n">new_serial</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">68</span>      <span class="k">break</span><span class="p">;</span>
<span class="ln">69</span>  <span class="p">}</span>
<span class="ln">70</span>    <span class="n">atomic_thread_fence</span><span class="p">(</span><span class="n">memory_order_acquire</span><span class="p">);</span>
<span class="ln">71</span>  <span class="p">}</span>
<span class="ln">72</span>  <span class="k">return</span> <span class="n">serial</span><span class="p">;</span>
<span class="ln">73</span><span class="p">}</span>
</code></pre></div>

 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/property/property_28.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/property/property_28.png" >
  
    </a>
  
  
</div>

<blockquote>
<p>补充：关于<code>libc.so</code>是什么时候初始化的</p>
<p>关于在Android中的<code>libc.so</code>，实际上是<code>bionic/libc</code>，根据以下规则来生成对应的<code>libc.so</code></p>
<div class="highlight"><pre class="chroma"><code class="language-makefile" data-lang="makefile"><span class="ln"> 1</span><span class="err">//bionic/libc/Android.bp</span>
<span class="ln"> 2</span><span class="err">cc_library_static</span> <span class="err">{</span>
<span class="ln"> 3</span>    <span class="nf">name</span><span class="o">:</span> &#34;<span class="n">libc_init_dynamic</span>&#34;<span class="p">,</span>
<span class="ln"> 4</span>    defaults: <span class="o">[</span><span class="s2">&#34;libc_defaults&#34;</span><span class="o">]</span>,
<span class="ln"> 5</span>    srcs: <span class="o">[</span><span class="s2">&#34;bionic/libc_init_dynamic.cpp&#34;</span><span class="o">]</span>,
<span class="ln"> 6</span>    cflags: <span class="o">[</span><span class="s2">&#34;-fno-stack-protector&#34;</span><span class="o">]</span>,
<span class="ln"> 7</span><span class="err">}</span>
<span class="ln"> 8</span>
<span class="ln"> 9</span><span class="err">//</span> <span class="err">========================================================</span>
<span class="ln">10</span><span class="err">//</span> <span class="err">libc.a</span> <span class="err">+</span> <span class="err">libc.so</span>
<span class="ln">11</span><span class="err">//</span> <span class="err">========================================================</span>
<span class="ln">12</span><span class="err">cc_library</span> <span class="err">{</span>
<span class="ln">13</span>    <span class="nf">defaults</span><span class="o">:</span> [
<span class="ln">14</span>        <span class="s2">&#34;libc_defaults&#34;</span>,
<span class="ln">15</span>        <span class="s2">&#34;libc_native_allocator_defaults&#34;</span>,
<span class="ln">16</span>    <span class="o">]</span>,
<span class="ln">17</span>    name: <span class="s2">&#34;libc&#34;</span>,
<span class="ln">18</span>    static_ndk_lib: true,
<span class="ln">19</span>    export_include_dirs: <span class="o">[</span><span class="s2">&#34;include&#34;</span><span class="o">]</span>,
<span class="ln">20</span>    product_variables: <span class="o">{</span>
<span class="ln">21</span>        platform_sdk_version: <span class="o">{</span>
<span class="ln">22</span>            asflags: <span class="o">[</span><span class="s2">&#34;-DPLATFORM_SDK_VERSION=%d&#34;</span><span class="o">]</span>,
<span class="ln">23</span>        <span class="o">}</span>,
<span class="ln">24</span>    <span class="o">}</span>,
<span class="ln">25</span>    static: <span class="o">{</span>
<span class="ln">26</span>        srcs: <span class="o">[</span> <span class="s2">&#34;:libc_sources_static&#34;</span> <span class="o">]</span>,
<span class="ln">27</span>        cflags: <span class="o">[</span><span class="s2">&#34;-DLIBC_STATIC&#34;</span><span class="o">]</span>,
<span class="ln">28</span>        whole_static_libs: <span class="o">[</span>
<span class="ln">29</span>            <span class="s2">&#34;gwp_asan&#34;</span>,
<span class="ln">30</span>            <span class="s2">&#34;libc_init_static&#34;</span>,
<span class="ln">31</span>            <span class="s2">&#34;libc_common_static&#34;</span>,
<span class="ln">32</span>            <span class="s2">&#34;libc_unwind_static&#34;</span>,
<span class="ln">33</span>        <span class="o">]</span>,
<span class="ln">34</span>    <span class="o">}</span>,
<span class="ln">35</span>    shared: <span class="o">{</span>
<span class="ln">36</span>        srcs: <span class="o">[</span> <span class="s2">&#34;:libc_sources_shared&#34;</span> <span class="o">]</span>,
<span class="ln">37</span>        whole_static_libs: <span class="o">[</span>
<span class="ln">38</span>            <span class="s2">&#34;gwp_asan&#34;</span>,
<span class="ln">39</span>            <span class="s2">&#34;libc_init_dynamic&#34;</span>,
<span class="ln">40</span>            <span class="s2">&#34;libc_common_shared&#34;</span>,
<span class="ln">41</span>        <span class="o">]</span>,
<span class="ln">42</span>    <span class="o">}</span>,
<span class="ln">43</span>    ...
<span class="ln">44</span><span class="err">}</span>   
</code></pre></div><p>这里面实际上是<code>libc_init_dynamic.cpp</code>为<code>libc_init_dynamic.a</code>的源文件，而<code>libc.so</code>是依赖于这个<code>libc_init_dynamic.a</code>的静态库，也就是间接也依赖于<code>libc_init_dynamic.cpp</code>文件。<code>libc_init_dynamic.cpp</code>文件，是用于初始化属性系统的，用于<code>Api</code>访问。</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln">1</span><span class="c1">//bionic/libc/bionic/libc_init_dynamic.cpp
</span><span class="ln">2</span><span class="c1"></span><span class="n">__attribute__</span><span class="p">((</span><span class="n">constructor</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span> <span class="k">static</span> <span class="kt">void</span> <span class="n">__libc_preinit</span><span class="p">()</span> <span class="p">{</span>
<span class="ln">3</span>  <span class="n">__stack_chk_guard</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">uintptr_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">__get_tls</span><span class="p">()[</span><span class="n">TLS_SLOT_STACK_GUARD</span><span class="p">]);</span>
<span class="ln">4</span>  <span class="n">__libc_preinit_impl</span><span class="p">();</span>
<span class="ln">5</span><span class="p">}</span>
</code></pre></div><p>关于constructor(1)特性。<code>constructor</code>参数让系统执行<code>main()</code>函数之前调用函数(被<code>__attribute__((constructor))</code>修饰的函数).同理, <code>destructor</code>让系统在<code>main()</code>函数退出或者调用了<code>exit()</code>之后,调用我们的函数.带有这些修饰属性的函数,对于我们初始化一些在程序中使用的数据非常有用。具体原理可以点击<a href="https://www.jianshu.com/p/dd425b9dc9db">这里</a>。</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//bionic/libc/bionic/libc_init_dynamic.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="n">__attribute__</span><span class="p">((</span><span class="n">noinline</span><span class="p">))</span>
<span class="ln"> 3</span><span class="k">static</span> <span class="kt">void</span> <span class="n">__libc_preinit_impl</span><span class="p">()</span> <span class="p">{</span>
<span class="ln"> 4</span>  <span class="n">TlsModules</span><span class="o">&amp;</span> <span class="n">tls_modules</span> <span class="o">=</span> <span class="n">__libc_shared_globals</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">tls_modules</span><span class="p">;</span>
<span class="ln"> 5</span>  <span class="n">tls_modules</span><span class="p">.</span><span class="n">generation_libc_so</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__libc_tls_generation_copy</span><span class="p">;</span>
<span class="ln"> 6</span>  <span class="n">__libc_tls_generation_copy</span> <span class="o">=</span> <span class="n">tls_modules</span><span class="p">.</span><span class="n">generation</span><span class="p">;</span>
<span class="ln"> 7</span>
<span class="ln"> 8</span>  <span class="n">__libc_init_globals</span><span class="p">();</span>
<span class="ln"> 9</span>  <span class="n">__libc_init_common</span><span class="p">();</span>
<span class="ln">10</span>  <span class="p">...</span>
<span class="ln">11</span>  <span class="n">netdClientInit</span><span class="p">();</span>
<span class="ln">12</span><span class="p">}</span>
</code></pre></div><p>用于初始化一些通用的环境变量</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//bionic/libc/bionic/libc_init_common.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="kt">void</span> <span class="nf">__libc_init_common</span><span class="p">()</span> <span class="p">{</span>
<span class="ln"> 3</span>  <span class="c1">// Initialize various globals.
</span><span class="ln"> 4</span><span class="c1"></span>  <span class="n">environ</span> <span class="o">=</span> <span class="n">__libc_shared_globals</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">init_environ</span><span class="p">;</span>
<span class="ln"> 5</span>  <span class="n">errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="ln"> 6</span>  <span class="n">setprogname</span><span class="p">(</span><span class="n">__libc_shared_globals</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">init_progname</span> <span class="o">?:</span> <span class="s">&#34;&lt;unknown&gt;&#34;</span><span class="p">);</span>
<span class="ln"> 7</span>
<span class="ln"> 8</span><span class="cp">#if !defined(__LP64__)
</span><span class="ln"> 9</span><span class="cp"></span>  <span class="n">__check_max_thread_id</span><span class="p">();</span>
<span class="ln">10</span><span class="cp">#endif
</span><span class="ln">11</span><span class="cp"></span>
<span class="ln">12</span>  <span class="n">__libc_add_main_thread</span><span class="p">();</span>
<span class="ln">13</span>
<span class="ln">14</span>  <span class="n">__system_properties_init</span><span class="p">();</span> <span class="c1">// Requires &#39;environ&#39;.
</span><span class="ln">15</span><span class="c1"></span>  <span class="n">__libc_init_fdsan</span><span class="p">();</span> <span class="c1">// Requires system properties (for debug.fdsan).
</span><span class="ln">16</span><span class="c1"></span>  <span class="n">__libc_init_fdtrack</span><span class="p">();</span>
<span class="ln">17</span>
<span class="ln">18</span>  <span class="n">SetDefaultHeapTaggingLevel</span><span class="p">();</span>
<span class="ln">19</span><span class="p">}</span>
</code></pre></div><p><code>__system_properties_init</code></p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln">1</span><span class="c1">//bionic/libc/bionic/system_property_api.cpp
</span><span class="ln">2</span><span class="c1"></span><span class="cp">#define PROP_FILENAME &#34;/dev/__properties__&#34;
</span><span class="ln">3</span><span class="cp"></span><span class="kt">int</span> <span class="nf">__system_properties_init</span><span class="p">()</span> <span class="p">{</span>
<span class="ln">4</span>  <span class="k">return</span> <span class="n">system_properties</span><span class="p">.</span><span class="n">Init</span><span class="p">(</span><span class="n">PROP_FILENAME</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="ln">5</span><span class="p">}</span>
</code></pre></div><p><code>system_properties.Init</code></p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//bionic/libc/system_properties/system_properties.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="kt">bool</span> <span class="n">SystemProperties</span><span class="o">::</span><span class="n">Init</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filename</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 3</span>  <span class="c1">// This is called from __libc_init_common, and should leave errno at 0 (http://b/37248982).
</span><span class="ln"> 4</span><span class="c1"></span>  <span class="n">ErrnoRestorer</span> <span class="n">errno_restorer</span><span class="p">;</span>
<span class="ln"> 5</span>
<span class="ln"> 6</span>  <span class="k">if</span> <span class="p">(</span><span class="n">initialized_</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 7</span>    <span class="n">contexts_</span><span class="o">-&gt;</span><span class="n">ResetAccess</span><span class="p">();</span>
<span class="ln"> 8</span>    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="ln"> 9</span>  <span class="p">}</span>
<span class="ln">10</span>
<span class="ln">11</span>  <span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">PROP_FILENAME_MAX</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">12</span>    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="ln">13</span>  <span class="p">}</span>
<span class="ln">14</span>  <span class="n">strcpy</span><span class="p">(</span><span class="n">property_filename_</span><span class="p">,</span> <span class="n">filename</span><span class="p">);</span>
<span class="ln">15</span>  <span class="c1">//最重要的从这里开始
</span><span class="ln">16</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">is_dir</span><span class="p">(</span><span class="n">property_filename_</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">17</span>    <span class="k">if</span> <span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="s">&#34;/dev/__properties__/property_info&#34;</span><span class="p">,</span> <span class="n">R_OK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">18</span>      <span class="n">contexts_</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="n">contexts_data_</span><span class="p">)</span> <span class="n">ContextsSerialized</span><span class="p">();</span>
<span class="ln">19</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">contexts_</span><span class="o">-&gt;</span><span class="n">Initialize</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="n">property_filename_</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">20</span>        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="ln">21</span>      <span class="p">}</span>
<span class="ln">22</span>    <span class="p">}</span>
<span class="ln">23</span>    <span class="p">...</span>
<span class="ln">24</span>  <span class="p">}</span>    
<span class="ln">25</span>  <span class="n">initialized_</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="ln">26</span>  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="ln">27</span><span class="p">}</span>
</code></pre></div><p>因为是App调用到<code>Init</code>函数，这里的<code>Initialize</code>函数所传递的都为<code>false</code>，说明是没有可写入权限的。</p>
<p>ContextsSerialized函数，是用于实例化序列化的对象，然后调用序列化对象的<code>Initialize</code>函数。</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//bionic/libc/system_properties/contexts_serialized.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="kt">bool</span> <span class="n">ContextsSerialized</span><span class="o">::</span><span class="n">Initialize</span><span class="p">(</span><span class="kt">bool</span> <span class="n">writable</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filename</span><span class="p">,</span> <span class="kt">bool</span><span class="o">*</span> <span class="n">fsetxattr_failed</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 3</span>  <span class="n">filename_</span> <span class="o">=</span> <span class="n">filename</span><span class="p">;</span>
<span class="ln"> 4</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">InitializeProperties</span><span class="p">())</span> <span class="p">{</span>
<span class="ln"> 5</span>    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="ln"> 6</span>  <span class="p">}</span>
<span class="ln"> 7</span>
<span class="ln"> 8</span>  <span class="k">if</span> <span class="p">(</span><span class="n">writable</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 9</span>      <span class="p">...</span>
<span class="ln">10</span>  <span class="p">}</span>
<span class="ln">11</span>  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="ln">12</span><span class="p">}</span>
</code></pre></div><p><code>InitializeProperties</code></p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//bionic/libc/system_properties/contexts_serialized.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="kt">bool</span> <span class="n">ContextsSerialized</span><span class="o">::</span><span class="n">InitializeProperties</span><span class="p">()</span> <span class="p">{</span>
<span class="ln"> 3</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">property_info_area_file_</span><span class="p">.</span><span class="n">LoadDefaultPath</span><span class="p">())</span> <span class="p">{</span>
<span class="ln"> 4</span>    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="ln"> 5</span>  <span class="p">}</span>
<span class="ln"> 6</span>
<span class="ln"> 7</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">InitializeContextNodes</span><span class="p">())</span> <span class="p">{</span>
<span class="ln"> 8</span>    <span class="n">FreeAndUnmap</span><span class="p">();</span>
<span class="ln"> 9</span>    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="ln">10</span>  <span class="p">}</span>
<span class="ln">11</span>
<span class="ln">12</span>  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="ln">13</span><span class="p">}</span>
</code></pre></div><p>这里的流程跟前面1.2中的<code>__system_property_area_init</code>非常相似，但是区别是1.2中的<code>__system_property_area_init</code>初始化是在<code>Init</code>进程初始化的，具有<strong>可读写权限</strong>，而这里的<code>__system_properties_init</code>初始化是在<code>bionic/libc</code>这个so库初始化的，用于其他进程的调用，所以是没有<strong>可写权限</strong>的。</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/property/property_29.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/property/property_29.png" >
  
    </a>
  
  
</div>

</blockquote>
<h2 id="33adb获取属性">3.3adb获取属性</h2>
<p><code>adb</code>命令直接输入<code>getprop</code>，实际上是调用到一个<code>toolbox</code>当中的进程<code>getprop</code>，有两个参数<code>ZT</code>，不能一起使用，<code>-Z</code>是打印对应的<code>SElinux</code>域文件，<code>-T</code>是打印对应的value具体的类型，比如<code>string</code>，<code>bool</code>等。</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//system/core/toolbox/getprop.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="k">extern</span> <span class="s">&#34;C&#34;</span> <span class="kt">int</span> <span class="n">getprop_main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 3</span>    <span class="k">auto</span> <span class="n">result_type</span> <span class="o">=</span> <span class="n">ResultType</span><span class="o">::</span><span class="n">Value</span><span class="p">;</span>
<span class="ln"> 4</span>
<span class="ln"> 5</span>    <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 6</span>        <span class="p">...</span>
<span class="ln"> 7</span>        <span class="k">switch</span> <span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 8</span>            <span class="k">case</span> <span class="sc">&#39;h&#39;</span><span class="o">:</span>
<span class="ln"> 9</span>                <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;usage: getprop [-TZ] [NAME [DEFAULT]]</span><span class="se">\n</span><span class="s">&#34;</span>
<span class="ln">10</span>                             <span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span>
<span class="ln">11</span>                             <span class="s">&#34;Gets an Android system property, or lists them all.</span><span class="se">\n</span><span class="s">&#34;</span>
<span class="ln">12</span>                             <span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span>
<span class="ln">13</span>                             <span class="s">&#34;-T</span><span class="se">\t</span><span class="s">Show property types instead of values</span><span class="se">\n</span><span class="s">&#34;</span>
<span class="ln">14</span>                             <span class="s">&#34;-Z</span><span class="se">\t</span><span class="s">Show property contexts instead of values</span><span class="se">\n</span><span class="s">&#34;</span>
<span class="ln">15</span>                          <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="ln">16</span>                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="ln">17</span>            <span class="k">case</span> <span class="sc">&#39;T&#39;</span><span class="o">:</span>
<span class="ln">18</span>                <span class="p">...</span>
<span class="ln">19</span>                <span class="n">result_type</span> <span class="o">=</span> <span class="n">ResultType</span><span class="o">::</span><span class="n">Type</span><span class="p">;</span>
<span class="ln">20</span>                <span class="k">break</span><span class="p">;</span>
<span class="ln">21</span>            <span class="k">case</span> <span class="sc">&#39;Z&#39;</span><span class="o">:</span>
<span class="ln">22</span>                <span class="p">...</span>
<span class="ln">23</span>                <span class="n">result_type</span> <span class="o">=</span> <span class="n">ResultType</span><span class="o">::</span><span class="n">Context</span><span class="p">;</span>
<span class="ln">24</span>                <span class="k">break</span><span class="p">;</span>
<span class="ln">25</span>            <span class="p">...</span>
<span class="ln">26</span>    <span class="p">}</span>
<span class="ln">27</span>
<span class="ln">28</span>    <span class="k">if</span> <span class="p">(</span><span class="n">optind</span> <span class="o">&gt;=</span> <span class="n">argc</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">29</span>        <span class="c1">//不加任何参数答应所有的属性
</span><span class="ln">30</span><span class="c1"></span>        <span class="n">PrintAllProperties</span><span class="p">(</span><span class="n">result_type</span><span class="p">);</span>
<span class="ln">31</span>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="ln">32</span>    <span class="p">}</span>
<span class="ln">33</span>    <span class="p">...</span>
<span class="ln">34</span>    <span class="n">PrintProperty</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="p">],</span> <span class="p">(</span><span class="n">optind</span> <span class="o">==</span> <span class="n">argc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="s">&#34;&#34;</span> <span class="o">:</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">result_type</span><span class="p">);</span>
<span class="ln">35</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="ln">36</span><span class="p">}</span>
</code></pre></div><p><code>PrintProperty</code></p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//system/core/toolbox/getprop.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="kt">void</span> <span class="nf">PrintProperty</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">default_value</span><span class="p">,</span> <span class="n">ResultType</span> <span class="n">result_type</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 3</span>    <span class="k">switch</span> <span class="p">(</span><span class="n">result_type</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 4</span>        <span class="k">case</span> <span class="n">ResultType</span><span class="o">::</span><span class="nl">Value</span><span class="p">:</span>
<span class="ln"> 5</span>            <span class="c1">//实际上调用的GetProperty这个api方法
</span><span class="ln"> 6</span><span class="c1"></span>            <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">GetProperty</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">default_value</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="ln"> 7</span>            <span class="k">break</span><span class="p">;</span>
<span class="ln"> 8</span>        <span class="p">...</span>
<span class="ln"> 9</span>    <span class="p">}</span>
<span class="ln">10</span><span class="p">}</span>
</code></pre></div><p>到这里的GetProperty函数，就跟App的流程类似了。</p>
<p><code>GetProperty</code></p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//system/core/base/properties.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">GetProperty</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">default_value</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 3</span>  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">property_value</span><span class="p">;</span>
<span class="ln"> 4</span><span class="cp">#if defined(__BIONIC__)
</span><span class="ln"> 5</span><span class="cp"></span>  <span class="k">const</span> <span class="n">prop_info</span><span class="o">*</span> <span class="n">pi</span> <span class="o">=</span> <span class="n">__system_property_find</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="ln"> 6</span>  <span class="k">if</span> <span class="p">(</span><span class="n">pi</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="k">return</span> <span class="n">default_value</span><span class="p">;</span>
<span class="ln"> 7</span>
<span class="ln"> 8</span>  <span class="n">__system_property_read_callback</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span>
<span class="ln"> 9</span>                                  <span class="p">[](</span><span class="kt">void</span><span class="o">*</span> <span class="n">cookie</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">value</span><span class="p">,</span> <span class="kt">unsigned</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">10</span>                                    <span class="k">auto</span> <span class="n">property_value</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">cookie</span><span class="p">);</span>
<span class="ln">11</span>                                    <span class="o">*</span><span class="n">property_value</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
<span class="ln">12</span>                                  <span class="p">},</span>
<span class="ln">13</span>                                  <span class="o">&amp;</span><span class="n">property_value</span><span class="p">);</span>
<span class="ln">14</span><span class="cp">#else
</span><span class="ln">15</span><span class="cp"></span>  <span class="k">auto</span> <span class="n">it</span> <span class="o">=</span> <span class="n">g_properties</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
<span class="ln">16</span>  <span class="k">if</span> <span class="p">(</span><span class="n">it</span> <span class="o">==</span> <span class="n">g_properties</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="k">return</span> <span class="n">default_value</span><span class="p">;</span>
<span class="ln">17</span>  <span class="n">property_value</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
<span class="ln">18</span><span class="cp">#endif
</span><span class="ln">19</span><span class="cp"></span>  <span class="k">return</span> <span class="n">property_value</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">?</span> <span class="nl">default_value</span> <span class="p">:</span> <span class="n">property_value</span><span class="p">;</span>
<span class="ln">20</span><span class="p">}</span>
</code></pre></div><p><code>GetProperty</code>函数的内部逻辑，会根据<code>__BIONIC__</code>这个宏是否定义，分两个不同的逻辑。可以看到如果该宏已定义的话，会继续调用<code>__system_property_find</code>, 如果该宏未定义，则从全局变量<code>g_properties</code>中读取。</p>
<h2 id="34init进程获取属性">3.4Init进程获取属性</h2>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//system/core/init/property_service.cpp
</span><span class="ln"> 2</span><span class="c1">//实际上这里获取属性直接使用GetProperty来调用，跟adb方式一致
</span><span class="ln"> 3</span><span class="c1"></span><span class="k">static</span> <span class="kt">void</span> <span class="nf">ExportKernelBootProps</span><span class="p">()</span> <span class="p">{</span>
<span class="ln"> 4</span>    <span class="k">constexpr</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">UNSET</span> <span class="o">=</span> <span class="s">&#34;&#34;</span><span class="p">;</span>
<span class="ln"> 5</span>    <span class="k">struct</span> <span class="p">{</span>
<span class="ln"> 6</span>        <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">src_prop</span><span class="p">;</span>
<span class="ln"> 7</span>        <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">dst_prop</span><span class="p">;</span>
<span class="ln"> 8</span>        <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">default_value</span><span class="p">;</span>
<span class="ln"> 9</span>    <span class="p">}</span> <span class="n">prop_map</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="ln">10</span>            <span class="c1">// clang-format off
</span><span class="ln">11</span><span class="c1"></span>        <span class="p">{</span> <span class="s">&#34;ro.boot.serialno&#34;</span><span class="p">,</span>   <span class="s">&#34;ro.serialno&#34;</span><span class="p">,</span>   <span class="n">UNSET</span><span class="p">,</span> <span class="p">},</span>
<span class="ln">12</span>        <span class="p">{</span> <span class="s">&#34;ro.boot.mode&#34;</span><span class="p">,</span>       <span class="s">&#34;ro.bootmode&#34;</span><span class="p">,</span>   <span class="s">&#34;unknown&#34;</span><span class="p">,</span> <span class="p">},</span>
<span class="ln">13</span>        <span class="p">{</span> <span class="s">&#34;ro.boot.baseband&#34;</span><span class="p">,</span>   <span class="s">&#34;ro.baseband&#34;</span><span class="p">,</span>   <span class="s">&#34;unknown&#34;</span><span class="p">,</span> <span class="p">},</span>
<span class="ln">14</span>        <span class="p">{</span> <span class="s">&#34;ro.boot.bootloader&#34;</span><span class="p">,</span> <span class="s">&#34;ro.bootloader&#34;</span><span class="p">,</span> <span class="s">&#34;unknown&#34;</span><span class="p">,</span> <span class="p">},</span>
<span class="ln">15</span>        <span class="p">{</span> <span class="s">&#34;ro.boot.hardware&#34;</span><span class="p">,</span>   <span class="s">&#34;ro.hardware&#34;</span><span class="p">,</span>   <span class="s">&#34;unknown&#34;</span><span class="p">,</span> <span class="p">},</span>
<span class="ln">16</span>        <span class="p">{</span> <span class="s">&#34;ro.boot.revision&#34;</span><span class="p">,</span>   <span class="s">&#34;ro.revision&#34;</span><span class="p">,</span>   <span class="s">&#34;0&#34;</span><span class="p">,</span> <span class="p">},</span>
<span class="ln">17</span>            <span class="c1">// clang-format on
</span><span class="ln">18</span><span class="c1"></span>    <span class="p">};</span>
<span class="ln">19</span>    <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">prop</span> <span class="p">:</span> <span class="n">prop_map</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">20</span>        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">value</span> <span class="o">=</span> <span class="n">GetProperty</span><span class="p">(</span><span class="n">prop</span><span class="p">.</span><span class="n">src_prop</span><span class="p">,</span> <span class="n">prop</span><span class="p">.</span><span class="n">default_value</span><span class="p">);</span>
<span class="ln">21</span>        <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="n">UNSET</span><span class="p">)</span> <span class="n">InitPropertySet</span><span class="p">(</span><span class="n">prop</span><span class="p">.</span><span class="n">dst_prop</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="ln">22</span>    <span class="p">}</span>
<span class="ln">23</span><span class="p">}</span>
</code></pre></div>

 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/property/property_30.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/property/property_30.png" >
  
    </a>
  
  
</div>

<h2 id="35获取属性总结">3.5获取属性总结</h2>
<p>不管是<code>Init</code>进程还是非<code>Init</code>进程，最终都会调用到<code>/bionic/libc</code>这个动态库中，且会先后调用<code>__system_property_find</code>和<code>__system_property_read_callback</code>函数，前者函数是通过属性名，从<code>/dev/__properties__/property_info</code>找到属性名对应<code>Selinux</code>域，然后在<code>/dev/__properties__</code>目录中找到对应的<code>Selinux</code>域文件，根据字典树的方式来读取全属性名。后者函数在域文件中，如果能够找到对应的<code>prop_info</code>，那么读取对应的<code>value</code>值，如果找不到那么就会返回<code>null</code>（其中<code>App</code>调用的<code>Java</code>和<code>Native</code>层，在上层封装了默认值，会返回默认值）。</p>
<h1 id="4设置属性">4设置属性</h1>
<p>这里包括非<code>init</code>进程和<code>init</code>进程设置属性，这里非<code>init</code>进程有两种方式，一种是在<code>App</code>调用<code>Java层</code>或者<code>Native层</code>调用设置属性的方式，另一种是直接<code>adb</code>敲命令<code>setprop</code>。</p>
<h2 id="41app写入属性流程分析java侧">4.1App写入属性流程分析（Java侧）</h2>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//App设置属性
</span><span class="ln"> 2</span><span class="c1"></span><span class="kn">import</span> <span class="nn">android.os.SystemProperties</span><span class="o">;</span>
<span class="ln"> 3</span><span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">setProperty</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="n">String</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 4</span>    <span class="k">try</span> <span class="o">{</span>
<span class="ln"> 5</span>        <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">&#34;android.os.SystemProperties&#34;</span><span class="o">);</span>
<span class="ln"> 6</span>        <span class="n">Method</span> <span class="n">set</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="s">&#34;set&#34;</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="ln"> 7</span>        <span class="n">set</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
<span class="ln"> 8</span>        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="ln"> 9</span>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">10</span>        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
<span class="ln">11</span>    <span class="o">}</span>
<span class="ln">12</span>    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="ln">13</span><span class="o">}</span>
<span class="ln">14</span>
<span class="ln">15</span><span class="n">setProperty</span><span class="o">(</span><span class="s">&#34;persist.a.b.c&#34;</span><span class="o">,</span> <span class="s">&#34;1&#34;</span><span class="o">);</span>
</code></pre></div><h3 id="411setproperty">4.1.1<code>setProperty</code></h3>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/core/java/android/os/SystemProperties.java
</span><span class="ln"> 2</span><span class="c1">//需要通过反射来设置
</span><span class="ln"> 3</span><span class="c1"></span><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">set</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="n">String</span> <span class="n">val</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 4</span>    <span class="k">if</span> <span class="o">(</span><span class="n">val</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">val</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&#34;ro.&#34;</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">val</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">PROP_VALUE_MAX</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 5</span>        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;value of system property &#39;&#34;</span> <span class="o">+</span> <span class="n">key</span>
<span class="ln"> 6</span>                                           <span class="o">+</span> <span class="s">&#34;&#39; is longer than &#34;</span> <span class="o">+</span> <span class="n">PROP_VALUE_MAX</span> <span class="o">+</span> <span class="s">&#34; characters: &#34;</span> <span class="o">+</span> <span class="n">val</span><span class="o">);</span>
<span class="ln"> 7</span>    <span class="o">}</span>
<span class="ln"> 8</span>    <span class="k">if</span> <span class="o">(</span><span class="n">TRACK_KEY_ACCESS</span><span class="o">)</span> <span class="n">onKeyAccess</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
<span class="ln"> 9</span>    <span class="n">native_set</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">val</span><span class="o">);</span>
<span class="ln">10</span><span class="o">}</span>
</code></pre></div><h3 id="412native_set">4.1.2<code>native_set</code></h3>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//frameworks\base\core\jni\android_os_SystemProperties.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="kt">int</span> <span class="nf">register_android_os_SystemProperties</span><span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">)</span>
<span class="ln"> 3</span><span class="p">{</span>
<span class="ln"> 4</span>    <span class="k">const</span> <span class="n">JNINativeMethod</span> <span class="n">method_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="ln"> 5</span>        <span class="p">...</span>
<span class="ln"> 6</span>        <span class="c1">//设置属性就是这个SystemProperties_set函数 
</span><span class="ln"> 7</span><span class="c1"></span>        <span class="p">{</span> <span class="s">&#34;native_set&#34;</span><span class="p">,</span> <span class="s">&#34;(Ljava/lang/String;Ljava/lang/String;)V&#34;</span><span class="p">,</span>
<span class="ln"> 8</span>          <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="n">SystemProperties_set</span> <span class="p">},</span>
<span class="ln"> 9</span>    <span class="p">};</span>
<span class="ln">10</span>    <span class="k">return</span> <span class="n">RegisterMethodsOrDie</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s">&#34;android/os/SystemProperties&#34;</span><span class="p">,</span>
<span class="ln">11</span>                                <span class="n">method_table</span><span class="p">,</span> <span class="n">NELEM</span><span class="p">(</span><span class="n">method_table</span><span class="p">));</span>
<span class="ln">12</span><span class="p">}</span>
<span class="ln">13</span><span class="c1">//这里是设置属性的地方
</span><span class="ln">14</span><span class="c1"></span><span class="kt">void</span> <span class="nf">SystemProperties_set</span><span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">clazz</span><span class="p">,</span> <span class="n">jstring</span> <span class="n">keyJ</span><span class="p">,</span>
<span class="ln">15</span>                          <span class="n">jstring</span> <span class="n">valJ</span><span class="p">)</span>
<span class="ln">16</span><span class="p">{</span>
<span class="ln">17</span>    <span class="n">ScopedUtfChars</span> <span class="n">key</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">keyJ</span><span class="p">);</span>
<span class="ln">18</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">key</span><span class="p">.</span><span class="n">c_str</span><span class="p">())</span> <span class="p">{</span>
<span class="ln">19</span>        <span class="k">return</span><span class="p">;</span>
<span class="ln">20</span>    <span class="p">}</span>
<span class="ln">21</span>    <span class="n">std</span><span class="o">::</span><span class="n">optional</span><span class="o">&lt;</span><span class="n">ScopedUtfChars</span><span class="o">&gt;</span> <span class="n">value</span><span class="p">;</span>
<span class="ln">22</span>    <span class="k">if</span> <span class="p">(</span><span class="n">valJ</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">23</span>        <span class="n">value</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">valJ</span><span class="p">);</span>
<span class="ln">24</span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">value</span><span class="o">-&gt;</span><span class="n">c_str</span><span class="p">())</span> <span class="p">{</span>
<span class="ln">25</span>            <span class="k">return</span><span class="p">;</span>
<span class="ln">26</span>        <span class="p">}</span>
<span class="ln">27</span>    <span class="p">}</span>
<span class="ln">28</span>    <span class="kt">bool</span> <span class="n">success</span><span class="p">;</span>
<span class="ln">29</span>    <span class="c1">//最终会调用到这里的__system_property_set函数
</span><span class="ln">30</span><span class="c1"></span><span class="cp">#if defined(__BIONIC__)
</span><span class="ln">31</span><span class="cp"></span>    <span class="n">success</span> <span class="o">=</span> <span class="o">!</span><span class="n">__system_property_set</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">value</span> <span class="o">?</span> <span class="n">value</span><span class="o">-&gt;</span><span class="n">c_str</span><span class="p">()</span> <span class="o">:</span> <span class="s">&#34;&#34;</span><span class="p">);</span>
<span class="ln">32</span><span class="cp">#else
</span><span class="ln">33</span><span class="cp"></span>    <span class="n">success</span> <span class="o">=</span> <span class="n">android</span><span class="o">::</span><span class="n">base</span><span class="o">::</span><span class="n">SetProperty</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">value</span> <span class="o">?</span> <span class="n">value</span><span class="o">-&gt;</span><span class="n">c_str</span><span class="p">()</span> <span class="o">:</span> <span class="s">&#34;&#34;</span><span class="p">);</span>
<span class="ln">34</span><span class="cp">#endif
</span><span class="ln">35</span><span class="cp"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">success</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">36</span>        <span class="n">jniThrowException</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s">&#34;java/lang/RuntimeException&#34;</span><span class="p">,</span>
<span class="ln">37</span>                          <span class="s">&#34;failed to set system property (check logcat for reason)&#34;</span><span class="p">);</span>
<span class="ln">38</span>    <span class="p">}</span>
<span class="ln">39</span><span class="p">}</span>
</code></pre></div><h3 id="413__system_property_set">4.1.3<code>__system_property_set</code></h3>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//bionic/libc/bionic/system_property_set.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="n">__BIONIC_WEAK_FOR_NATIVE_BRIDGE</span>
<span class="ln"> 3</span><span class="kt">int</span> <span class="nf">__system_property_set</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">key</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 4</span>  <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="ln"> 5</span>  <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="n">value</span> <span class="o">=</span> <span class="s">&#34;&#34;</span><span class="p">;</span>
<span class="ln"> 6</span>  <span class="c1">//获取当前属性的版本号
</span><span class="ln"> 7</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">g_propservice_protocol_version</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 8</span>    <span class="n">detect_protocol_version</span><span class="p">();</span>
<span class="ln"> 9</span>  <span class="p">}</span>
<span class="ln">10</span>  <span class="c1">//比较当前的版本号，属性系统启动的时候就是设置为ro.property_service.version为2
</span><span class="ln">11</span><span class="c1"></span>  <span class="c1">//1的话为Android 8或者更早的系统版本
</span><span class="ln">12</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">g_propservice_protocol_version</span> <span class="o">==</span> <span class="n">kProtocolVersion1</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">13</span>    <span class="c1">// Old protocol does not support long names or values
</span><span class="ln">14</span><span class="c1"></span>    <span class="p">...</span>
<span class="ln">15</span>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="ln">16</span>    <span class="c1">// New protocol only allows long values for ro. properties only.
</span><span class="ln">17</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">PROP_VALUE_MAX</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s">&#34;ro.&#34;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="ln">18</span>    <span class="c1">// Use proper protocol
</span><span class="ln">19</span><span class="c1"></span>    <span class="n">PropertyServiceConnection</span> <span class="n">connection</span><span class="p">;</span>
<span class="ln">20</span>    <span class="p">...</span>
<span class="ln">21</span>    <span class="c1">//建立socket连接，这里连接的就是Init进程启动时候的Property_Service
</span><span class="ln">22</span><span class="c1"></span>    <span class="c1">//内部使用了writev，writev面向的是分散的数据块，两个函数的最终结果都是将内容写入连续的空间。
</span><span class="ln">23</span><span class="c1"></span>    <span class="n">SocketWriter</span> <span class="n">writer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">connection</span><span class="p">);</span>
<span class="ln">24</span>    <span class="c1">//发送tcp消息，首先是MSG类型，这里是属性系统版本v2.0，然后追加key和value的值
</span><span class="ln">25</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">writer</span><span class="p">.</span><span class="n">WriteUint32</span><span class="p">(</span><span class="n">PROP_MSG_SETPROP2</span><span class="p">).</span><span class="n">WriteString</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="n">WriteString</span><span class="p">(</span><span class="n">value</span><span class="p">).</span><span class="n">Send</span><span class="p">())</span> <span class="p">{</span>
<span class="ln">26</span>    <span class="p">...</span>
<span class="ln">27</span>  <span class="p">}</span>
<span class="ln">28</span><span class="p">}</span>
</code></pre></div><p><code>SocketWriter</code>的数据结构如下图所示</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/property/property_31.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/property/property_31.png" >
  
    </a>
  
  
</div>

<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//bionic/libc/bionic/system_property_set.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="n">SocketWriter</span><span class="o">&amp;</span> <span class="n">WriteUint32</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 3</span>    <span class="kt">uint32_t</span><span class="o">*</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">uint_buf_</span> <span class="o">+</span> <span class="n">uint_buf_index_</span><span class="p">;</span>
<span class="ln"> 4</span>    <span class="n">uint_buf_</span><span class="p">[</span><span class="n">uint_buf_index_</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
<span class="ln"> 5</span>    <span class="n">iov_</span><span class="p">[</span><span class="n">iov_index_</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
<span class="ln"> 6</span>    <span class="n">iov_</span><span class="p">[</span><span class="n">iov_index_</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">);</span>
<span class="ln"> 7</span>    <span class="o">++</span><span class="n">iov_index_</span><span class="p">;</span>
<span class="ln"> 8</span>    <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
<span class="ln"> 9</span><span class="p">}</span>
<span class="ln">10</span>
<span class="ln">11</span><span class="n">SocketWriter</span><span class="o">&amp;</span> <span class="n">WriteString</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">12</span>    <span class="kt">uint32_t</span> <span class="n">valuelen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
<span class="ln">13</span>    <span class="n">WriteUint32</span><span class="p">(</span><span class="n">valuelen</span><span class="p">);</span>
<span class="ln">14</span>    <span class="k">if</span> <span class="p">(</span><span class="n">valuelen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">15</span>    <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
<span class="ln">16</span>  <span class="p">}</span>
<span class="ln">17</span>
<span class="ln">18</span>    <span class="n">CHECK</span><span class="p">(</span><span class="n">iov_index_</span> <span class="o">&lt;</span> <span class="n">kIovSize</span><span class="p">);</span>
<span class="ln">19</span>    <span class="n">iov_</span><span class="p">[</span><span class="n">iov_index_</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="k">const_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
<span class="ln">20</span>    <span class="n">iov_</span><span class="p">[</span><span class="n">iov_index_</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">valuelen</span><span class="p">;</span>
<span class="ln">21</span>    <span class="o">++</span><span class="n">iov_index_</span><span class="p">;</span>
<span class="ln">22</span>    <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
<span class="ln">23</span><span class="p">}</span>
</code></pre></div><h4 id="4131writeuint32prop_msg_setprop2">4.1.3.1<code>WriteUint32(PROP_MSG_SETPROP2)</code></h4>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/property/property_32.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/property/property_32.png" >
  
    </a>
  
  
</div>

<h4 id="4132writestringpersistabc">4.1.3.2<code>WriteString(&quot;persist.a.b.c&quot;)</code></h4>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/property/property_33.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/property/property_33.png" >
  
    </a>
  
  
</div>

<h4 id="4333writestring1">4.3.3.3<code>WriteString(&quot;1&quot;)</code></h4>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/property/property_34.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/property/property_34.png" >
  
    </a>
  
  
</div>

<h2 id="42app写入属性流程分析native侧">4.2App写入属性流程分析（Native侧）</h2>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln">1</span><span class="c1">//App通过封装的so进行读取属性
</span><span class="ln">2</span><span class="c1"></span><span class="cp">#include</span> <span class="cpf">&lt;cutils/properties.h&gt;</span><span class="cp">
</span><span class="ln">3</span><span class="cp">#define PROPERTY_KEY_MAX   32
</span><span class="ln">4</span><span class="cp">#define PROPERTY_VALUE_MAX  92
</span><span class="ln">5</span><span class="cp"></span><span class="n">property_set</span><span class="p">(</span><span class="s">&#34;persist.a.b.c&#34;</span><span class="p">,</span> <span class="s">&#34;1&#34;</span><span class="p">);</span>
</code></pre></div><p><code>property_set</code></p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln">1</span><span class="c1">//system/core/libcutils/properties.cpp
</span><span class="ln">2</span><span class="c1"></span><span class="kt">int</span> <span class="nf">property_set</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">3</span>    <span class="k">return</span> <span class="n">__system_property_set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="ln">4</span><span class="p">}</span>
</code></pre></div><p><code>__system_property_set</code>跟上面4.1的流程一致，这里就不继续展开。</p>
<h2 id="43adb写入属性">4.3adb写入属性</h2>
<p><code>adb</code>命令直接输入<code>setprop</code>，实际上是调用到一个<code>toolbox</code>当中的进程<code>setprop</code>，需要有两个参数，<code>name</code>和<code>value</code>，且<code>name</code>和<code>value</code>必须符合规范（<code>name</code>长度小于32，<code>value</code>长度小于92）。</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//system/core/toolbox/setprop.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="k">extern</span> <span class="s">&#34;C&#34;</span> <span class="kt">int</span> <span class="n">setprop_main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 3</span>    <span class="p">...</span>
<span class="ln"> 4</span>    <span class="k">auto</span> <span class="n">name</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">{</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]};</span>
<span class="ln"> 5</span>    <span class="k">auto</span> <span class="n">value</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">{</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]};</span>
<span class="ln"> 6</span>    <span class="p">...</span>
<span class="ln"> 7</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SetProperty</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span> <span class="p">{</span>
<span class="ln"> 8</span>        <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Failed to set property &#39;&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">name</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;&#39; to &#39;&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">value</span>
<span class="ln"> 9</span>                  <span class="o">&lt;&lt;</span> <span class="s">&#34;&#39;.</span><span class="se">\n</span><span class="s">See dmesg for error reason.&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="ln">10</span>        <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
<span class="ln">11</span>    <span class="p">}</span>
<span class="ln">12</span>
<span class="ln">13</span>    <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="ln">14</span><span class="p">}</span>
</code></pre></div><p><code>SetProperty</code></p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln">1</span><span class="c1">//system/core/base/properties.cpp
</span><span class="ln">2</span><span class="c1"></span><span class="kt">bool</span> <span class="nf">SetProperty</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">3</span>  <span class="k">return</span> <span class="p">(</span><span class="n">__system_property_set</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">value</span><span class="p">.</span><span class="n">c_str</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
<span class="ln">4</span><span class="p">}</span>
</code></pre></div><p><code>__system_property_set</code>跟上面4.1的流程一致，这里就不继续展开。</p>
<h2 id="44init进程写入属性">4.4Init进程写入属性</h2>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln">1</span><span class="k">static</span> <span class="kt">void</span> <span class="nf">update_sys_usb_config</span><span class="p">()</span> <span class="p">{</span>
<span class="ln">2</span>    <span class="p">...</span>
<span class="ln">3</span>    <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">||</span> <span class="n">config</span> <span class="o">==</span> <span class="s">&#34;none&#34;</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">4</span>        <span class="n">InitPropertySet</span><span class="p">(</span><span class="s">&#34;persist.sys.usb.config&#34;</span><span class="p">,</span> <span class="n">is_debuggable</span> <span class="o">?</span> <span class="s">&#34;adb&#34;</span> <span class="o">:</span> <span class="s">&#34;none&#34;</span><span class="p">);</span>
<span class="ln">5</span>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_debuggable</span> <span class="o">&amp;&amp;</span> <span class="n">config</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#34;adb&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">::</span><span class="n">npos</span> <span class="o">&amp;&amp;</span>
<span class="ln">6</span>        <span class="p">...</span>
<span class="ln">7</span>        <span class="n">InitPropertySet</span><span class="p">(</span><span class="s">&#34;persist.sys.usb.config&#34;</span><span class="p">,</span> <span class="n">config</span><span class="p">);</span>
<span class="ln">8</span>    <span class="p">}</span>
<span class="ln">9</span><span class="p">}</span>
</code></pre></div><p><code>InitPropertySet</code></p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//system/core/init/property_service.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="kt">uint32_t</span> <span class="nf">InitPropertySet</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 3</span>    <span class="kt">uint32_t</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="ln"> 4</span>    <span class="n">ucred</span> <span class="n">cr</span> <span class="o">=</span> <span class="p">{.</span><span class="n">pid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">uid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">gid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">};</span>
<span class="ln"> 5</span>    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">error</span><span class="p">;</span>
<span class="ln"> 6</span>    <span class="n">result</span> <span class="o">=</span> <span class="n">HandlePropertySet</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">kInitContext</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>
<span class="ln"> 7</span>    <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="n">PROP_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 8</span>        <span class="n">LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Init cannot set &#39;&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">name</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;&#39; to &#39;&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;&#39;: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">error</span><span class="p">;</span>
<span class="ln"> 9</span>    <span class="p">}</span>
<span class="ln">10</span>
<span class="ln">11</span>    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="ln">12</span><span class="p">}</span>
</code></pre></div><p><code>HandlePropertySet</code></p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//system/core/init/property_service.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="kt">uint32_t</span> <span class="nf">HandlePropertySet</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">,</span>
<span class="ln"> 3</span>                           <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">source_context</span><span class="p">,</span> <span class="k">const</span> <span class="n">ucred</span><span class="o">&amp;</span> <span class="n">cr</span><span class="p">,</span>
<span class="ln"> 4</span>                           <span class="n">SocketConnection</span><span class="o">*</span> <span class="n">socket</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">*</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 5</span>    <span class="k">if</span> <span class="p">(</span><span class="k">auto</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">CheckPermissions</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">source_context</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span> <span class="n">ret</span> <span class="o">!=</span> <span class="n">PROP_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 6</span>        <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="ln"> 7</span>    <span class="p">}</span>
<span class="ln"> 8</span>
<span class="ln"> 9</span>    <span class="k">if</span> <span class="p">(</span><span class="n">StartsWith</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&#34;ctl.&#34;</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">10</span>        <span class="k">return</span> <span class="n">SendControlMessage</span><span class="p">(</span><span class="n">name</span><span class="p">.</span><span class="n">c_str</span><span class="p">()</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">cr</span><span class="p">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">socket</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
<span class="ln">11</span>    <span class="p">}</span>
<span class="ln">12</span>    <span class="p">...</span>
<span class="ln">13</span>    <span class="k">return</span> <span class="n">PropertySet</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
<span class="ln">14</span><span class="p">}</span>
</code></pre></div><p>这个<code>PropertySet</code>又回到了2.3.2.3，具体不继续展开。</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/property/property_35.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/property/property_35.png" >
  
    </a>
  
  
</div>

<h2 id="45设置属性总结">4.5设置属性总结</h2>
<p>不管是<code>Init</code>进程还是非<code>Init</code>进程，<strong>设置属性需要调用到<code>Init</code>进程去操作</strong>。如果是非<code>Init</code>进程，会通过本地<code>socket</code>通信，路径为<code>/dev/socket/property_service</code>与<code>Init</code>中的属性服务建立通信，让所有非<code>Init</code>进程的设置操作，全部在<code>Init</code>进程中操作。最终都会调用到<code>/bionic/libc</code>这个动态库中，且会先调用<code>__system_property_find</code>函数，通过属性名，从<code>/dev/__properties__/property_info</code>找到属性名对应<code>Selinux</code>域，然后在<code>/dev/__properties__</code>目录中找到对应的<code>Selinux</code>域文件。如果返回的<code>prop_info</code>存在，那么接着调用<code>__system_property_update</code>函数更新<code>value</code>值，如果<code>prop_info</code>不存在，那么接着调用<code>__system_property_Add</code>函数在域文件中按照字典树规则添加一个属性值。</p>
<h1 id="5关于属性变化">5关于属性变化</h1>
<p>在这个基础上Android推出了一个<code>init.rc</code>的机制，即<strong>类似通过读取配置文件的方式，来启动不同的进程</strong>，而不是通过传<code>exec</code>在代码中一个个的来执行进程。</p>
<blockquote>
<p><code>rc</code>是一个配置文件，内部由Android初始化语言编写（<code>Android Init Language</code>）编写的脚本。</p>
<p>具体可以参考**<code>/system/core/init/README.md</code>**这个文件，详细介绍了rc文件的语法。</p>
</blockquote>
<p>当属性变化之后，<code>rc</code>文件就会执行对应的<code>Command</code>，这个流程又是怎么样的呢？</p>
<p>我们知道，其它进程可以直接进行属性的读操作，但是属性系统的写操作只能在<code> init</code> 进程中进行，其它进程进行属性的写操作也需要通过 <code>init </code>进程。</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln">1</span><span class="c1">//system/core/init/property_service.cpp
</span><span class="ln">2</span><span class="c1"></span><span class="k">static</span> <span class="kt">uint32_t</span> <span class="nf">PropertySet</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">*</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">3</span>    <span class="p">...</span>
<span class="ln">4</span>    <span class="k">auto</span> <span class="n">lock</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="p">{</span><span class="n">accept_messages_lock</span><span class="p">};</span>
<span class="ln">5</span>    <span class="k">if</span> <span class="p">(</span><span class="n">accept_messages</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">6</span>        <span class="n">PropertyChanged</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="ln">7</span>    <span class="p">}</span>
<span class="ln">8</span>    <span class="k">return</span> <span class="n">PROP_SUCCESS</span><span class="p">;</span>
<span class="ln">9</span><span class="p">}</span>
</code></pre></div><p>其实就是在上述属性设置的末尾有一个判断是否接受信息的判断，<strong>默认是打开的</strong>，在<code>StartPropertyService</code>函数的时候就有打开</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="kt">void</span> <span class="nf">StartPropertyService</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span> <span class="n">epoll_socket</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 2</span>    <span class="p">...</span>
<span class="ln"> 3</span>    <span class="n">StartSendingMessages</span><span class="p">();</span>
<span class="ln"> 4</span>    <span class="p">...</span>
<span class="ln"> 5</span><span class="p">}</span>
<span class="ln"> 6</span>
<span class="ln"> 7</span><span class="kt">void</span> <span class="nf">StartSendingMessages</span><span class="p">()</span> <span class="p">{</span>
<span class="ln"> 8</span>    <span class="k">auto</span> <span class="n">lock</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="p">{</span><span class="n">accept_messages_lock</span><span class="p">};</span>
<span class="ln"> 9</span>    <span class="n">accept_messages</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="ln">10</span><span class="p">}</span>
</code></pre></div><p><code>PropertyChanged</code></p>
<p>如果属性是 <code>sys.powerctl</code>，我们绕过事件队列并<strong>立即处理</strong>它。这是为了确保 <code>init</code> 将始终立即关闭/重新启动，无论是否有其他待处理的事件要处理，或者 <code>init</code> 是否正在等待 <code>exec</code> 服务或等待属性。在非热关机情况下，将触发“关机”触发器以执行设备特定的命令。</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//system/core/init/init.cpp
</span><span class="ln"> 2</span><span class="c1"></span><span class="kt">void</span> <span class="nf">PropertyChanged</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span>    <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#34;sys.powerctl&#34;</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 5</span>        <span class="n">trigger_shutdown</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
<span class="ln"> 6</span>    <span class="p">}</span>
<span class="ln"> 7</span>	<span class="c1">//将rc文件中属性改变发生的命令或者事件添加到ActionManager内部队列中，等待轮询执行
</span><span class="ln"> 8</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">property_triggers_enabled</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 9</span>        <span class="n">ActionManager</span><span class="o">::</span><span class="n">GetInstance</span><span class="p">().</span><span class="n">QueuePropertyChange</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="ln">10</span>        <span class="n">WakeMainInitThread</span><span class="p">();</span>
<span class="ln">11</span>    <span class="p">}</span>
<span class="ln">12</span>
<span class="ln">13</span>    <span class="n">prop_waiter_state</span><span class="p">.</span><span class="n">CheckAndResetWait</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="ln">14</span><span class="p">}</span>
</code></pre></div><p>其中<code>ActionManager</code>定义是在属性服务初始化之后，立刻初始化</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//system/core/init/init.cpp
</span><span class="ln"> 2</span><span class="c1">//用于存放动作，包括init.cpp和rc文件
</span><span class="ln"> 3</span><span class="c1"></span><span class="kt">int</span> <span class="nf">SecondStageMain</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 4</span>    <span class="p">...</span>
<span class="ln"> 5</span>    <span class="n">ActionManager</span><span class="o">&amp;</span> <span class="n">am</span> <span class="o">=</span> <span class="n">ActionManager</span><span class="o">::</span><span class="n">GetInstance</span><span class="p">();</span>
<span class="ln"> 6</span>    <span class="c1">//用于存放服务，包括init.cpp和rc文件
</span><span class="ln"> 7</span><span class="c1"></span>    <span class="n">ServiceList</span><span class="o">&amp;</span> <span class="n">sm</span> <span class="o">=</span> <span class="n">ServiceList</span><span class="o">::</span><span class="n">GetInstance</span><span class="p">();</span>
<span class="ln"> 8</span>    <span class="c1">//解析rc文件，如果没有特殊配置ro.boot.init_rc，则解析./init.rc把/system/etc/init、/product/etc/init、/product_services/etc/init、/odm/etc/init、/vendor/etc/init 这几个路径加入init.rc之后解析的路径，在init.rc解析完成后，解析这些目录里的rc文件。
</span><span class="ln"> 9</span><span class="c1"></span>    <span class="n">LoadBootScripts</span><span class="p">(</span><span class="n">am</span><span class="p">,</span> <span class="n">sm</span><span class="p">);</span>
<span class="ln">10</span>    <span class="p">...</span>
<span class="ln">11</span>    <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">12</span>        <span class="p">...</span>
<span class="ln">13</span>        <span class="c1">//处理rc文件触发的事件
</span><span class="ln">14</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">prop_waiter_state</span><span class="p">.</span><span class="n">MightBeWaiting</span><span class="p">()</span> <span class="o">||</span> <span class="n">Service</span><span class="o">::</span><span class="n">is_exec_service_running</span><span class="p">()))</span> <span class="p">{</span>
<span class="ln">15</span>            <span class="n">m</span><span class="p">.</span><span class="n">ExecuteOneCommand</span><span class="p">();</span>
<span class="ln">16</span>        <span class="p">}</span>
<span class="ln">17</span>        <span class="c1">//处理关机/重启事件
</span><span class="ln">18</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IsShuttingDown</span><span class="p">())</span> <span class="p">{</span>
<span class="ln">19</span>            <span class="n">HandleControlMessages</span><span class="p">();</span>
<span class="ln">20</span>            <span class="n">SetUsbController</span><span class="p">();</span>
<span class="ln">21</span>        <span class="p">}</span>
<span class="ln">22</span>    <span class="p">}</span>
<span class="ln">23</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="ln">24</span><span class="p">}</span>
</code></pre></div><p>从代码中可以看到，<code>property_triggers_enabled</code> 是 <code>&lt;属性变化触发 action&gt;</code> 的使能点，开启之后每次属性发生变化都会调用 <code>ActionManager.QueuePropertyChange(name, value)</code> 函数</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln">1</span><span class="c1">//system/core/init/action_manager.cpp
</span><span class="ln">2</span><span class="c1"></span><span class="kt">void</span> <span class="n">ActionManager</span><span class="o">::</span><span class="n">QueueEventTrigger</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">trigger</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">3</span>    <span class="k">auto</span> <span class="n">lock</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="p">{</span><span class="n">event_queue_lock_</span><span class="p">};</span>
<span class="ln">4</span>    <span class="n">event_queue_</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">trigger</span><span class="p">);</span>
<span class="ln">5</span><span class="p">}</span>
</code></pre></div><p><code>QueuePropertyChange</code> 函数同样填充了 <code>event_queue_</code> 队列，将已改变属性的键值对作为参数。</p>
<p>运行队列中已经添加了该属性的变化触发条件，同样通过 <code>am.ExecuteOneCommand()</code> 函数遍历所有的 <code>_actions</code> 链表，执行相应的 <code>commands</code>。</p>
<h1 id="总结">总结</h1>
<p>本文主要对属性系统的初始化原理<code>PropertyInit</code>、<code>StartPropertyService</code>，获取属性、设置属性和属性变化这五个方面来展开详解，围绕着属性，<code>SElinux</code>，<code>mmap</code>，共享内存，匿名私有内存，<code>Trie</code>，<code>rc文件</code>，<code>persist</code>属性做了一个流程的介绍和分析。总的来说，属性看起来简单，内部机制还是比较复杂的。特别是由于笔者水平有限，关于设置属性的脏区和属性变化的介绍不够深入，这个需要读者发挥自己的主观能动性进一步完善。</p>
<h1 id="下载">下载</h1>
<p>本文源码<a href="https://github.com/YangYang48/project/tree/master/property">点击这里</a></p>
<h1 id="几个问题">几个问题</h1>
<blockquote>
<p>1）SElinux怎么跟属性对应起来的</p>
</blockquote>
<p>首先，<code>SElinux</code>是一种权限系统，也就是说每个文件都有自己对应的标签，比如每个文件都会有自己的标签。如果需要访问这个文件，需要有对应标签的类型的权限，访问<code>/sdcard/..ccdid</code>需要这个<code>u:object_r:sdcardfs:s0</code>标签的<code>dir</code>和<code>file</code>类型的<code>read</code>，<code>search</code>等权限，因为我需要访问到这个文件。</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln"> 1</span><span class="c1"># 这里的第五列实际上就是标签，文件会有标签。</span>
<span class="ln"> 2</span>picasso:/sdcard $ ls -laZ
<span class="ln"> 3</span>total <span class="m">12946</span>
<span class="ln"> 4</span>drwxrwx--x <span class="m">220</span> root sdcard_rw u:object_r:sdcardfs:s0   <span class="m">20480</span> 2022-09-10 02:20 .
<span class="ln"> 5</span>drwx--x--x   <span class="m">4</span> root sdcard_rw u:object_r:sdcardfs:s0    <span class="m">3488</span> 2022-09-07 18:41 ..
<span class="ln"> 6</span>-rw-rw----   <span class="m">1</span> root sdcard_rw u:object_r:sdcardfs:s0     <span class="m">301</span> 2022-09-08 08:51 ..ccdid
<span class="ln"> 7</span>-rw-rw----   <span class="m">1</span> root sdcard_rw u:object_r:sdcardfs:s0      <span class="m">57</span> 2022-09-08 08:51 ..ccvid
<span class="ln"> 8</span>-rw-rw----   <span class="m">1</span> root sdcard_rw u:object_r:sdcardfs:s0      <span class="m">96</span> 2020-06-27 10:59 .3deaedc28469674418c57af6b7cc832b
<span class="ln"> 9</span>drwxrwx--x   <span class="m">2</span> root sdcard_rw u:object_r:sdcardfs:s0    <span class="m">3488</span> 2022-03-01 17:48 .6226f7cbe59e99a90b5cef6f94f966fd
<span class="ln">10</span>drwxrwx--x   <span class="m">3</span> root sdcard_rw u:object_r:sdcardfs:s0    <span class="m">3488</span> 2020-05-30 14:01 .7934039a
<span class="ln">11</span>-rw-rw----   <span class="m">1</span> root sdcard_rw u:object_r:sdcardfs:s0      <span class="m">16</span> 2021-01-25 14:22 .AID_SYS
<span class="ln">12</span>drwxrwx--x   <span class="m">2</span> root sdcard_rw u:object_r:sdcardfs:s0    <span class="m">3488</span> 2022-09-10 13:35 .DataStorage
<span class="ln">13</span>drwxrwx--x   <span class="m">2</span> root sdcard_rw u:object_r:sdcardfs:s0    <span class="m">3488</span> 2020-12-10 14:03 .Download
<span class="ln">14</span>drwxrwx--x   <span class="m">3</span> root sdcard_rw u:object_r:sdcardfs:s0    <span class="m">3488</span> 2020-06-10 11:33 .INSTALLATION
<span class="ln">15</span>drwxrwx--x   <span class="m">2</span> root sdcard_rw u:object_r:sdcardfs:s0    <span class="m">3488</span> 2021-11-24 15:27 .RtcDataStorage
<span class="ln">16</span>-rw-rw----   <span class="m">1</span> root sdcard_rw u:object_r:sdcardfs:s0      <span class="m">36</span> 2021-01-25 14:22 .SID_SYS
<span class="ln">17</span>drwxrwx--x   <span class="m">2</span> root sdcard_rw u:object_r:sdcardfs:s0    <span class="m">3488</span> 2020-12-10 14:03 .Trusfort
<span class="ln">18</span>-rw-rw----   <span class="m">1</span> root sdcard_rw u:object_r:sdcardfs:s0     <span class="m">169</span> 2021-01-25 14:22 .UA_SYS
</code></pre></div><p>而属性域也是一样，所有的属性都会对应到一个标签，然后将默认设置的属性全部导入到一个文件中，也就是在本文1.1序列化的一个操作，<code>/dev/__properties__/property_info</code>，这里面保存了默认的所有属性对应的标签。再者，新建了一系列的属性域文件，包含了标签和对应的属性。访问一个属性的时候，首先会找到这个属性对应的标签，然后在<code>/dev/__properties__/</code>找到对应的属性域文件，找到之后，通过字典树的形式最终找到对应的属性。</p>
<blockquote>
<p>2）自定义属性怎么添加上去的</p>
</blockquote>
<p>自定义属性也是属于设置属性的范畴。其实就是简单的来说，分成三部分。</p>
<ol>
<li>找到对应属性的标签，如果没有找到那么就是缺省标签，<code>u:object_r:default_prop:s0</code></li>
<li>找到<code>/dev/__properties__/xxx</code>对应的文件，<code>xxx</code>为对应属性的标签，然后通过字典树访问，没有找到这个属性</li>
<li>重新添加这个属性，根据字典树的添加原理，按照方式添加这个自定义属性</li>
</ol>
<blockquote>
<p>3）自定义属性会对应哪个<code>SElinux</code>标签呢</p>
</blockquote>
<p>这个需要根据设置对前缀来区分，比如<code>bluetooth.</code>开头的属性都属于<code>u:object_r:bluetooth_prop:s0</code>标签的，访问对应的<code>bluetooth.</code>需要有<code>u:object_r:bluetooth_prop:s0</code>标签类型的权限。有些默认定义的属性访问权限很高，并不是随意一个进程或者<code>App</code>可以自由访问的。</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>bluetooth.              u:object_r:bluetooth_prop:s0
<span class="ln">2</span>config.                 u:object_r:config_prop:s0
</code></pre></div><p>比如自定义一个属性，没有任何与默认属性定义的冲突，那么就是默认缺省属性</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>persist.a.b.c.d         u:object_r:default_prop:s0
</code></pre></div><blockquote>
<p>4）persist属性为什么重启存在，我怎么删除自定义的persist属性呢</p>
</blockquote>
<p>i）首先回答第一个问题，为什么重启存在，因为除了像其他的属性一样会保存在<code>/dev/__properties__/</code>目录中，<code>persist.</code>开头的属性还会被保存在<code>/data/property/persistent_properties</code>这个文件中。开机的时候除了会重新初始化默认属性，还会将<code>/data/property/persistent_properties</code>这个文件中属性读到对应的<code>/dev/__properties__/</code>目录对应的域文件中。和上面的2.3.2.2.4的流程一样，只不过因为在第一次设置属性的时候用到了<code>LoadPersistentPropertiesFromMemory</code>，<code>/data/property/persistent_properties</code>文件已经创建。所以直接将该文件的内容从<code>proto</code>变成字符串的访问来设置即可。</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/property/property_25.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/property/property_25.png" >
  
    </a>
  
  
</div>

<p>ii）怎么删除自定义的<code>persist</code>属性，比如<code>persist.a.b.c.d</code></p>
<p><code>Android8.0</code>或者更低版本，只需要删除<code>/data/property/persist.a.b.c.d</code>的文件，并且删除<code>/data/property/persist.a.b.c.d</code>在<code>/dev/__properties__/</code>目录中的域文件。</p>
<p><code>Android11</code>版本，只需要删除或者更名<code>/data/property/</code>目录，并且删除<code>/data/property/persist.a.b.c.d</code>在<code>/dev/__properties__/</code>目录中的域文件。</p>
<p>删除自定义的persist属性，需要知其所以然，原理是清理掉<code>/data/property/persistent_properties</code>，并且不能让属性在下一次启动的时候，还原清理掉的文件<code>/data/property/persistent_properties</code>。</p>
<blockquote>
<p>这里需要了解几件事</p>
<ul>
<li>
<p>重启的过程中关机会设置属性<code>persist.sys.boot.reason</code>。这里假定我是通过<code>adb</code>方式重启，那么</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span><span class="o">[</span>persist.sys.boot.reason<span class="o">]</span>: <span class="o">[</span>reboot,shell<span class="o">]</span>
</code></pre></div></li>
<li>
<p>mmap在删除硬盘文件之后，进程依然能够让映射的内存区域进行读写操作，具体原理可以点击<a href="https://bbs.csdn.net/topics/360058295">这里</a>。简单的来讲就是，mmap机制，文件映射到逻辑地址空间的内存中，实际上也进程是一个持有文件句柄的过程。在建映射以后、解除映射之前，如果文件被删除，单个进程读写是没有问题，或者是多个进程在建映射以后、解除映射之前，如果文件被删除，多个进程读读没有问题。</p>
</li>
</ul>
</blockquote>
<p>高版本中，必须删除或者更名<code>/data/property/</code>目录，如果不对这个目录做处理，一旦重启依然会生效。</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="c1">//system/core/init/persistent_properties.cpp
</span><span class="ln"> 2</span><span class="c1">//这里才是真正让persist属性起不起作用的函数
</span><span class="ln"> 3</span><span class="c1"></span><span class="n">Result</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span> <span class="n">WritePersistentPropertyFile</span><span class="p">(</span><span class="k">const</span> <span class="n">PersistentProperties</span><span class="o">&amp;</span> <span class="n">persistent_properties</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 4</span>    <span class="c1">//创建一个临时文件/data/property/persistent_properties.tmp
</span><span class="ln"> 5</span><span class="c1"></span>    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">temp_filename</span> <span class="o">=</span> <span class="n">persistent_property_filename</span> <span class="o">+</span> <span class="s">&#34;.tmp&#34;</span><span class="p">;</span>
<span class="ln"> 6</span>    <span class="c1">//打开这个临时文件
</span><span class="ln"> 7</span><span class="c1"></span>    <span class="n">unique_fd</span> <span class="nf">fd</span><span class="p">(</span><span class="n">TEMP_FAILURE_RETRY</span><span class="p">(</span>
<span class="ln"> 8</span>        <span class="n">open</span><span class="p">(</span><span class="n">temp_filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">O_WRONLY</span> <span class="o">|</span> <span class="n">O_CREAT</span> <span class="o">|</span> <span class="n">O_NOFOLLOW</span> <span class="o">|</span> <span class="n">O_TRUNC</span> <span class="o">|</span> <span class="n">O_CLOEXEC</span><span class="p">,</span> <span class="mo">0600</span><span class="p">)));</span>
<span class="ln"> 9</span>    <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">10</span>        <span class="k">return</span> <span class="nf">ErrnoError</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Could not open temporary properties file&#34;</span><span class="p">;</span>
<span class="ln">11</span>    <span class="p">}</span>
<span class="ln">12</span>    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">serialized_string</span><span class="p">;</span>
<span class="ln">13</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">persistent_properties</span><span class="p">.</span><span class="n">SerializeToString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serialized_string</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">14</span>        <span class="k">return</span> <span class="nf">Error</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Unable to serialize properties&#34;</span><span class="p">;</span>
<span class="ln">15</span>    <span class="p">}</span>
<span class="ln">16</span>    <span class="c1">//将所有属性，这里的属性依然是包括persist.a.b.c.d的，写入到这个临时文件中
</span><span class="ln">17</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">WriteStringToFd</span><span class="p">(</span><span class="n">serialized_string</span><span class="p">,</span> <span class="n">fd</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">18</span>        <span class="k">return</span> <span class="nf">ErrnoError</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Unable to write file contents&#34;</span><span class="p">;</span>
<span class="ln">19</span>    <span class="p">}</span>
<span class="ln">20</span>    <span class="n">fsync</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
<span class="ln">21</span>    <span class="n">fd</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
<span class="ln">22</span>    <span class="c1">//将临时文件重命名为/data/property/persistent_properties
</span><span class="ln">23</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">rename</span><span class="p">(</span><span class="n">temp_filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">persistent_property_filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">()))</span> <span class="p">{</span>
<span class="ln">24</span>        <span class="kt">int</span> <span class="n">saved_errno</span> <span class="o">=</span> <span class="n">errno</span><span class="p">;</span>
<span class="ln">25</span>        <span class="n">unlink</span><span class="p">(</span><span class="n">temp_filename</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="ln">26</span>        <span class="k">return</span> <span class="nf">Error</span><span class="p">(</span><span class="n">saved_errno</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Unable to rename persistent property file&#34;</span><span class="p">;</span>
<span class="ln">27</span>    <span class="p">}</span>
<span class="ln">28</span>    <span class="c1">//这里是最关键的，找到/data/property/persistent_properties文件的目录，即/data/property
</span><span class="ln">29</span><span class="c1"></span>    <span class="c1">//因为我们已经将这个目录更改，所以磁盘中已经找不到这个目录，直接返回添加所有属性失败，属性中包括persist.a.b.c.d
</span><span class="ln">30</span><span class="c1"></span>    <span class="k">auto</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">Dirname</span><span class="p">(</span><span class="n">persistent_property_filename</span><span class="p">);</span>
<span class="ln">31</span>    <span class="k">auto</span> <span class="n">dir_fd</span> <span class="o">=</span> <span class="n">unique_fd</span><span class="p">{</span><span class="n">open</span><span class="p">(</span><span class="n">dir</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">O_DIRECTORY</span> <span class="o">|</span> <span class="n">O_RDONLY</span> <span class="o">|</span> <span class="n">O_CLOEXEC</span><span class="p">)};</span>
<span class="ln">32</span>    <span class="k">if</span> <span class="p">(</span><span class="n">dir_fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">33</span>        <span class="k">return</span> <span class="nf">ErrnoError</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Unable to open persistent properties directory for fsync()&#34;</span><span class="p">;</span>
<span class="ln">34</span>    <span class="p">}</span>
<span class="ln">35</span>    <span class="n">fsync</span><span class="p">(</span><span class="n">dir_fd</span><span class="p">);</span>
<span class="ln">36</span>
<span class="ln">37</span>    <span class="k">return</span> <span class="p">{};</span>
<span class="ln">38</span><span class="p">}</span>
</code></pre></div><p>删除<code>/data/property/persistent_properties</code>和删除<code>persist.a.b.c.d</code>在<code>/dev/__properties__/</code>目录中的域文件。重启关机过程中，会设置关机的原因属性，那么会重新导入<code>/dev/__properties__/</code>定义的<code>Selinux</code>域对应的所有的<code>ContextNode</code>中的属性(删除<code>persist.a.b.c.d</code>在<code>/dev/__properties__/</code>目录中的域文件，<strong>进程依然可以读文件所映射的逻辑地址</strong>)，其中包括<code>persist.a.b.c.d</code>属性，那么在关机的过程中会重新生成<code>/data/property/persistent_properties</code>文件，那么下一次开机过程中，会从<code>/data/property/persistent_properties</code>文件导入所有的<code>persist.</code>开头的属性，那么自然<code>persist.a.b.c.d</code>属性也会被导入。因此，<strong>必须对<code>/data/property</code>目录进行更改。</strong></p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/property/property_26.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/property/property_26.png" >
  
    </a>
  
  
</div>

<blockquote>
<p>5）属性系统预置的<code>SElinux</code>规则文件和预置写入的属性文件在哪个目录</p>
</blockquote>
<p><code>SElinux</code>规则文件，通常是下面几个目录文件，其中这些带有<code>selinux</code>目录是通过<code>mmm system/sepolicy</code>生成的，重启系统之后<code>SElinux</code>新的规则就能生效，通常对于<code>SElinux</code>修改都是在<code>/device</code>对应的<code>sepolicy</code>目录修改。</p>
<div class="highlight"><pre class="chroma"><code class="language-txt" data-lang="txt"><span class="ln">1</span>/system/etc/selinux/plat_property_contexts
<span class="ln">2</span>/system_ext/etc/selinux/system_ext_property_contexts
<span class="ln">3</span>/vendor/etc/selinux/vendor_property_contexts
<span class="ln">4</span>/product/etc/selinux/product_property_contexts
<span class="ln">5</span>/odm/etc/selinux/odm_property_contexts
</code></pre></div><p>预置写入的属性文件，通常是下面几个目录文件，也是在<code>/device</code>对应目录<code>mk</code>中修改，修改完成之后更新几个目录文件，重启之后即可生效。当然如果是修改类似<code>ro.boot</code>这种属性需要在<code>uboot</code>修改，<code>mk</code>修改是不起作用的。</p>
<div class="highlight"><pre class="chroma"><code class="language-txt" data-lang="txt"><span class="ln"> 1</span>#并不是所有的文件都会存在设置属性的值
<span class="ln"> 2</span>/system/etc/prop.default
<span class="ln"> 3</span>/prop.default              #recovery path
<span class="ln"> 4</span>/default.prop              #legacy path
<span class="ln"> 5</span>/system/build.prop
<span class="ln"> 6</span>/system_ext/build.prop
<span class="ln"> 7</span>/vendor/default.prop
<span class="ln"> 8</span>/vendor/build.prop
<span class="ln"> 9</span>/odm/etc/build.prop
<span class="ln">10</span>/product/build.prop
<span class="ln">11</span>/factory/factory.prop
</code></pre></div><h1 id="参考">参考</h1>
<p><a href="https://wangzhengyi.blog.csdn.net/article/details/44999103">[1] 低调小一, Android init进程——属性服务, 2015.</a></p>
<p><a href="https://blog.csdn.net/zhangjg_blog/article/details/122057945">[2] 昨夜星辰_zhangjg, Android是如何使用selinux来保护系统属性的, 2021.</a></p>
<p><a href="https://blog.csdn.net/lijie2664989/article/details/107826733">[3] apigfly, 深入Android系统（二）Bionic库, 2020.</a></p>
<p><a href="https://youranhongcha.blog.csdn.net/article/details/48379239">[4] 悠然红茶, 深入讲解Android Property机制, 2015.</a></p>
<p><a href="https://blog.csdn.net/sanchuyayun/article/details/54944820">[5] sanchuyayun, SEAndroid策略分析, 2017.</a></p>
<p><a href="https://haili-tian.blog.csdn.net/article/details/7014300">[6] thl789, Android属性之build.prop生成过程分析, 2011.</a></p>
<p><a href="https://blog.csdn.net/qq_36063677/article/details/116750095">[7] 淡陌羿格, 安卓property service系统分析, 2021.</a></p>
<p><a href="https://blog.csdn.net/u014674293/article/details/119147063">[8] BestW2Y, [Android 基础] &ndash; Android 属性系统简介, 2021.</a></p>
<p><a href="https://blog.csdn.net/qq_33249042/article/details/122972301">[9] YJer, Notepad++ 安装 HexEditor 插件, 2022.</a></p>
<p><a href="https://blog.csdn.net/xufei5789651/article/details/125961599">[10] 流金岁月5789651, Framework学习之旅：init 进程启动过程, 2022.</a></p>
<p><a href="https://cloud.tencent.com/developer/article/1854375">[11] 微信终端开发团队, 快速缓解 32 位 Android 环境下虚拟内存地址空间不足的“黑科技”, 2021.</a></p>
<p><a href="https://blog.canyie.top/2022/04/09/property-implementation-and-isolation/">[12] canyie, Android Property 实现解析与黑魔法, 2022.</a></p>
<p><a href="https://www.cnblogs.com/bastard/archive/2012/10/11/2720314.html">[13] Dufresne, Android 系统属性SystemProperty分析, 2012.</a></p>
<p><a href="https://wenku.baidu.com/view/b012e4c049fe04a1b0717fd5360cba1aa8118cdb?pcf=2&amp;bfetype=new&amp;bfetype=new">[14] android系统之属性系统详解.</a></p>
<p><a href="https://blog.csdn.net/iteye_563/article/details/82601798">[15] iteye_563, SEAndroid安全机制对Android属性访问的保护分析, 2014.</a></p>
<p><a href="https://blog.csdn.net/qq_19923217/article/details/82014989">[16] 岁月斑驳7, Android 8.1 开机流程分析（2）, 2018.</a></p>
<p><a href="https://blog.csdn.net/xufei5789651/article/details/125961599">[17] 流金岁月5789651, Framework学习之旅：init 进程启动过程, 2022.</a></p>
<p><a href="https://qingsong.blog.csdn.net/article/details/108438071">[18] 静思心远, C语言变长数组(柔性数组) struct中char data[0]的用法, 2020.</a></p>
<p><a href="https://blog.csdn.net/itzyjr/article/details/123544141">[19] itzyjr, ❥关于C++之私有继承, 2022.</a></p>
<p><a href="https://blog.csdn.net/u012542095/article/details/85850434">[20] 2013我笑了, android property属性property_set()&amp;&amp; property_get() selinux权限问题, 2019.</a></p>
<p><a href="https://blog.csdn.net/gehong3641/article/details/124028976">[21] 水墨长天, std::lock_guard的原理和应用, 2022.</a></p>
<p><a href="https://juejin.cn/post/7119116943256190990">[22] i校长, 深入理解MMAP原理，大厂爱不释手的技术手段, 2022.</a></p>
<p><a href="https://blog.csdn.net/swq463/article/details/109738256">[23] beOkWithAnything, mmap 父子进程共享内存通信, 2020.</a></p>
<p><a href="https://www.cnblogs.com/GarfieldEr007/p/10113328.html">[24] GarfieldEr007, Protobuf 语法指南, 2018.</a></p>
<p><a href="https://yaoyz.blog.csdn.net/article/details/93189219">[25] yaoyz105, Protobuf 学习（一）proto文件, 2022.</a></p>
<p><a href="https://justinwei.blog.csdn.net/article/details/120560637">[26] 私房菜, Android protobuf 生成c++ 文件详解, 2021.</a></p>
<p><a href="https://www.cnblogs.com/orangeform/archive/2013/01/02/2841485.html">[27] OrangeAdmin, 专注于中台化代码生成器, 2013.</a></p>
<p><a href="https://blog.csdn.net/gehong3641/article/details/124028976">[28] 水墨长天, std::lock_guard的原理和应用, 2022.</a></p>
<p><a href="https://blog.csdn.net/21aspnet/article/details/8196671">[29] 深度Java, ACCEPT()和ACCEPT4(), 2012.</a></p>
<p><a href="https://blog.csdn.net/konga/article/details/39062691">[30] konga, open中的 O_CLOEXEC 标志, 2014.</a></p>
<p><a href="https://www.thinbug.com/q/42961339">[31] Thinbug, 删除文件后删除mmap（）, 2017.</a></p>
<p><a href="https://bbs.csdn.net/topics/360058295">[32] cxz7531, mmap函数建立文件的内存映射后，删除文件，能正常读取内容吗？, 2011.</a></p>
<p><a href="https://blog.csdn.net/weaiken/article/details/88085360">[33] weaiken, <code>__attribute__ </code>机制详解, 2019.</a></p>
<p><a href="https://www.jianshu.com/p/dd425b9dc9db">[34] kenny肉桂, <code>__attribute__</code>((constructor))用法解析, 2016.</a></p>
<p><a href="https://blog.csdn.net/linuxheik/article/details/76125411">[35] linuxheik, writev, 2017.</a></p>
<p><a href="https://blog.csdn.net/weixin_43829445/article/details/116497954">[36] winsonCCCC, Linux网络编程之sockaddr与sockaddr_in,sockaddr_un分析, 2021.</a></p>
              
            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">标签</span><br/>
                    
  <a class="tag tag--primary tag--small" href="https://yangyang48.github.io/tags/android/">Android</a>

  <a class="tag tag--primary tag--small" href="https://yangyang48.github.io/tags/%E6%BA%90%E7%A0%81/">源码</a>

  <a class="tag tag--primary tag--small" href="https://yangyang48.github.io/tags/selinux/">SElinux</a>

  <a class="tag tag--primary tag--small" href="https://yangyang48.github.io/tags/trie/">Trie</a>

  <a class="tag tag--primary tag--small" href="https://yangyang48.github.io/tags/socket/">socket</a>

  <a class="tag tag--primary tag--small" href="https://yangyang48.github.io/tags/mmap/">mmap</a>

  <a class="tag tag--primary tag--small" href="https://yangyang48.github.io/tags/%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98/">共享内存</a>

  <a class="tag tag--primary tag--small" href="https://yangyang48.github.io/tags/%E5%8C%BF%E5%90%8D%E7%A7%81%E6%9C%89%E5%86%85%E5%AD%98/">匿名私有内存</a>

  <a class="tag tag--primary tag--small" href="https://yangyang48.github.io/tags/proto/">proto</a>

  <a class="tag tag--primary tag--small" href="https://yangyang48.github.io/tags/rc%E6%96%87%E4%BB%B6/">rc文件</a>

  <a class="tag tag--primary tag--small" href="https://yangyang48.github.io/tags/persist%E5%B1%9E%E6%80%A7/">persist属性</a>

                  </div>
                
              
            
            <div class="post-actions-wrap">
  
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://yangyang48.github.io/2022/08/leetcode-394%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%A7%A3%E7%A0%81/" data-tooltip="LeetCode 394字符串解码">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">下一篇</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://yangyang48.github.io/2022/08/leetcode%E4%B9%8B%E5%89%91%E6%8C%87offer-22%E9%93%BE%E8%A1%A8%E4%B8%AD%E5%80%92%E6%95%B0%E7%AC%ACk%E4%B8%AA%E8%8A%82%E7%82%B9/" data-tooltip="LeetCode之剑指Offer 22链表中倒数第k个节点">
              
                  <span class="hide-xs hide-sm text-small icon-mr">上一篇</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#disqus_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#">
        
          <i class="fa fa-list"></i>
        </a>
      </li>
    </ul>
  
</div>

            
              
                <div id="disqus_thread">
  <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
              
            
          </div>
        </article>
		
		<div class="post-comment main-content-wrap">
		
  
  <div id="vcomments"></div>
  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src='//unpkg.com/valine/dist/Valine.min.js'></script>
  <script type="text/javascript">
    new Valine({
        el: '#vcomments' ,
        appId: 'mwl8M1aQzLnRE6JIpIY3sgE5-9Nh9j0Va',
        appKey: 'mPGr6GMC0BuzAKkxinnd0IAr',
        notify:  true , 
        verify:  false , 
        avatar:'retro', 
        placeholder: '欢迎各位宝宝留言~',
        visitor:  true 
    });
  </script>

		</div>
        <footer id="footer" class="main-content-wrap">
  
  
  
  <span class="copyrights">
    &copy; 2022 Yang Ju. All Rights Reserved
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
        <div class="post-actions-wrap">
  
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://yangyang48.github.io/2022/08/leetcode-394%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%A7%A3%E7%A0%81/" data-tooltip="LeetCode 394字符串解码">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">下一篇</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://yangyang48.github.io/2022/08/leetcode%E4%B9%8B%E5%89%91%E6%8C%87offer-22%E9%93%BE%E8%A1%A8%E4%B8%AD%E5%80%92%E6%95%B0%E7%AC%ACk%E4%B8%AA%E8%8A%82%E7%82%B9/" data-tooltip="LeetCode之剑指Offer 22链表中倒数第k个节点">
              
                  <span class="hide-xs hide-sm text-small icon-mr">上一篇</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#disqus_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#">
        
          <i class="fa fa-list"></i>
        </a>
      </li>
    </ul>
  
</div>

      </div>
      <div id="share-options-bar" class="share-options-bar" data-behavior="4">
  <i id="btn-close-shareoptions" class="fa fa-close"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fyangyang48.github.io%2F2022%2F08%2Fandroid-property%25E8%25AF%25A6%25E8%25A7%25A3%2F">
          <i class="fa fa-facebook-official"></i><span>分享到 Facebook</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=https%3A%2F%2Fyangyang48.github.io%2F2022%2F08%2Fandroid-property%25E8%25AF%25A6%25E8%25A7%25A3%2F">
          <i class="fa fa-twitter"></i><span>分享到 Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=https%3A%2F%2Fyangyang48.github.io%2F2022%2F08%2Fandroid-property%25E8%25AF%25A6%25E8%25A7%25A3%2F">
          <i class="fa fa-google-plus"></i><span>分享到 Google&#43;</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>
    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="https://img-blog.csdnimg.cn/20210711204627625.jpg" alt="作者的图片" />
    
    <h4 id="about-card-name">Yang Ju</h4>
    
      <div id="about-card-bio">Nanjing University of Science and Technology</div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Software Development Engineer
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        NanJing,China
      </div>
    
  </div>
</div>

    

    
  
    
      <div id="cover" style="background-image:url('https://yangyang48.github.io/images/cover.jpg');"></div>
    
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.7/js/jquery.fancybox.min.js" integrity="sha256-GEAnjcTqVP+vBp3SSc8bEDQqvWAZMiHyUSIorrWwH50=" crossorigin="anonymous"></script>


<script src="https://yangyang48.github.io/js/script-pcw6v3xilnxydl1vddzazdverrnn9ctynvnxgwho987mfyqkuylcb1nlt.min.js"></script>


  
    <script src="https://yangyang48.github.io/js/copy-to-clipboard.js"></script>
  

<script lang="javascript">
window.onload = updateMinWidth;
window.onresize = updateMinWidth;
document.getElementById("sidebar").addEventListener("transitionend", updateMinWidth);
function updateMinWidth() {
  var sidebar = document.getElementById("sidebar");
  var main = document.getElementById("main");
  main.style.minWidth = "";
  var w1 = getComputedStyle(main).getPropertyValue("min-width");
  var w2 = getComputedStyle(sidebar).getPropertyValue("width");
  var w3 = getComputedStyle(sidebar).getPropertyValue("left");
  main.style.minWidth = `calc(${w1} - ${w2} - ${w3})`;
}
</script>

<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>


  
    
      <script>
        var disqus_config = function () {
          this.page.url = 'https:\/\/yangyang48.github.io\/2022\/08\/android-property%E8%AF%A6%E8%A7%A3\/';
          
            this.page.identifier = '\/2022\/08\/android-property%E8%AF%A6%E8%A7%A3\/'
          
        };
        (function() {
          
          
          if (window.location.hostname == "localhost") {
            return;
          }
          var d = document, s = d.createElement('script');
          var disqus_shortname = 'hugo-tranquilpeak-theme';
          s.src = '//' + disqus_shortname + '.disqus.com/embed.js';

          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();
      </script>
    
  




    
  </body>
</html>

