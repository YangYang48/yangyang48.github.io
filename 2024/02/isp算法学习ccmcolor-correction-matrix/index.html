<!DOCTYPE html>
<html lang="en-us">
  <head>
    
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Hugo 0.85.0 with theme Tranquilpeak 0.4.8-BETA">
<meta name="author" content="Yang Ju">
<meta name="keywords" content="">
<meta name="description" content="本文是isp算法学习的第十二篇章，主要是讲述CCM。">


<meta property="og:description" content="本文是isp算法学习的第十二篇章，主要是讲述CCM。">
<meta property="og:type" content="article">
<meta property="og:title" content="isp算法学习CCM（Color Correction Matrix）">
<meta name="twitter:title" content="isp算法学习CCM（Color Correction Matrix）">
<meta property="og:url" content="https://yangyang48.github.io/2024/02/isp%E7%AE%97%E6%B3%95%E5%AD%A6%E4%B9%A0ccmcolor-correction-matrix/">
<meta property="twitter:url" content="https://yangyang48.github.io/2024/02/isp%E7%AE%97%E6%B3%95%E5%AD%A6%E4%B9%A0ccmcolor-correction-matrix/">
<meta property="og:site_name" content="欢迎来到我的博客~">
<meta property="og:description" content="本文是isp算法学习的第十二篇章，主要是讲述CCM。">
<meta name="twitter:description" content="本文是isp算法学习的第十二篇章，主要是讲述CCM。">
<meta property="og:locale" content="zh-cn">

  
    <meta property="article:published_time" content="2024-02-07T00:00:00">
  
  
    <meta property="article:modified_time" content="2024-02-07T00:00:00">
  
  
  
    
      <meta property="article:section" content="2024">
    
      <meta property="article:section" content="February">
    
      <meta property="article:section" content="camera">
    
  
  
    
      <meta property="article:tag" content="CCM">
    
      <meta property="article:tag" content="CIE RGB颜色模型">
    
      <meta property="article:tag" content="CIE XYZ颜色空间">
    
      <meta property="article:tag" content="CIE xy色度图">
    
      <meta property="article:tag" content="sRGB色域">
    
      <meta property="article:tag" content="CIE Lab颜色空间">
    
      <meta property="article:tag" content="CIE Luv颜色空间">
    
  


<meta name="twitter:card" content="summary">







  <meta property="og:image" content="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm_thumb.jpg">
  <meta property="twitter:image" content="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm_thumb.jpg">


  <meta property="og:image" content="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm_cover.jpg">
  <meta property="twitter:image" content="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm_cover.jpg">




  <meta property="og:image" content="https://yangyang48.github.io/thumb/20210711204627625.jpg">
  <meta property="twitter:image" content="https://yangyang48.github.io/thumb/20210711204627625.jpg">


    <title>isp算法学习CCM（Color Correction Matrix）</title>

    <link rel="icon" href="https://yangyang48.github.io/favicon.png">
    

    

    <link rel="canonical" href="https://yangyang48.github.io/2024/02/isp%E7%AE%97%E6%B3%95%E5%AD%A6%E4%B9%A0ccmcolor-correction-matrix/">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.min.css" integrity="sha256-vuXZ9LGmmwtjqFX1F+EKin1ThZMub58gKULUyf0qECk=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/helpers/jquery.fancybox-thumbs.min.css" integrity="sha256-SEa4XYAHihTcEP1f5gARTB2K26Uk8PsndQYHQC1f4jU=" crossorigin="anonymous" />
    
    
    <link rel="stylesheet" href="https://yangyang48.github.io/css/style-twzjdbqhmnnacqs0pwwdzcdbt8yhv8giawvjqjmyfoqnvazl0dalmnhdkvp7.min.css" />
    
    
      
        <link rel="stylesheet"  href="https://yangyang48.github.io/css/copy-to-clipboard.css">
      
    

    
      
    
    

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="4">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://yangyang48.github.io/">欢迎来到我的博客~</a>
  </div>
  
    
      <a class="header-right-picture "
         href="https://yangyang48.github.io/#about">
    
    
    
      
        <img class="header-picture" src="https://yangyang48.github.io/thumb/20210711204627625.jpg" alt="作者的图片" />
      
    
    </a>
  
</header>

      <nav id="sidebar" data-behavior="4">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://yangyang48.github.io/#about">
          <img class="sidebar-profile-picture" src="https://yangyang48.github.io/thumb/20210711204627625.jpg" alt="作者的图片" />
        </a>
        <h4 class="sidebar-profile-name">Yang Ju</h4>
        
          <h5 class="sidebar-profile-bio">Nanjing University of Science and Technology</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://yangyang48.github.io/">
    
      <i class="sidebar-button-icon fa fa-lg fa-home"></i>
      
      <span class="sidebar-button-desc">首页</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://yangyang48.github.io/categories">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">分类</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://yangyang48.github.io/tags">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">标签</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://yangyang48.github.io/archives">
    
      <i class="sidebar-button-icon fa fa-lg fa-archive"></i>
      
      <span class="sidebar-button-desc">归档</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://yangyang48.github.io/#about">
    
      <i class="sidebar-button-icon fa fa-lg fa-question"></i>
      
      <span class="sidebar-button-desc">关于</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/YangYang48" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-github"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://blog.csdn.net/yangju147532896" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-chain"></i>
      
      <span class="sidebar-button-desc">CSDN</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
  </div>
</nav>

      
  <div class="post-header-cover
              text-center
              "
       style="background-image:url('/camera/algorithmlearning/ccm/ccm_cover.jpg')"
       data-behavior="4">
    
  </div>


      <div id="main" data-behavior="4"
        class="hasCover
               hasCoverMetaOut
               ">
        <article class="post" itemscope itemType="http://schema.org/BlogPosting">
          
          
            <div class="post-header main-content-wrap text-center">
  
    <h1 class="post-title" itemprop="headline">
      isp算法学习CCM（Color Correction Matrix）
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time itemprop="datePublished" datetime="2024-02-07T00:00:00Z">
        
  二月 7, 2024

      </time>
    
    
  
  
    <span>发布在</span>
    
      <a class="category-link" href="https://yangyang48.github.io/categories/2024">2024</a>, 
    
      <a class="category-link" href="https://yangyang48.github.io/categories/february">February</a>, 
    
      <a class="category-link" href="https://yangyang48.github.io/categories/camera">camera</a>
    
  

  </div>

</div>
          
		  
		  <h5 id="wc" style="font-size: 1rem;text-align: center;">1700 Words|Read in about 8 Min|本文总阅读量<span id="busuanzi_value_page_pv"></span>次</h5>
      
          <div class="post-content markdown" itemprop="articleBody">
            <div class="main-content-wrap">
              <p>本文是isp算法学习的第十二篇章，主要是讲述CCM。</p>
<div style="text-align: center;">
<iframe 
    frameborder="no" border="1"
    marginwidth="0" marginheight="0"
    width=400 height=100
    src="//music.163.com/outchain/player?type=2&id=1313107594&auto=1&height=66"></iframe>
</div>
<h1 id="0开篇介绍">0开篇介绍</h1>
<h2 id="01人眼波长反应曲线">0.1人眼波长反应曲线</h2>
<p>人眼之所以能感受到自然界的颜色是因为人眼的<strong>视锥细胞</strong>在起作用。人眼主要通过三种视锥细胞感受三种不同波长的光从而感受颜色。如图所示是<strong>人眼感受不同波长的反应曲线</strong>，分别对应三种不同的波长，所以通常用RGB三原色来表示颜色。</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm10.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm10.png" >
  
    </a>
  
  
</div>

<h2 id="02sensor波长响应曲线">0.2sensor波长响应曲线</h2>
<p>如图是IMX415C和ICX262AQ两种sensor的感光特性，可以看出来和人眼的感光曲线有很大的不同，而且同样SONY生产的sensor各自的感光曲线的特性也有很大差异，所以如果直接用sensor感光的特性来表示颜色回合人眼有很大的差异，且同一种颜色通过不同sensor感光后得到的数据是不一样的，而对于显示器而言就会表现出不同的颜色，这是我们不希望看到的，我们希望同一种颜色即使使用不同的sensor也能得到相同的RGB数据且和人眼感受的颜色一致或者接近。</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm11.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm11.png" >
  
    </a>
  
  
</div>

<p>IMX415C的sensor的感光特性图</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm12.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm12.png" >
  
    </a>
  
  
</div>

<p>ICX262AQsensor的感光特性图</p>
<p>为了达到上述的要求，我们可以理解为人眼对物体感受的颜色是我们的目标，那么就需要将sensor感光数据经过某种变换达到我们的目标。假设人眼能感受到的颜色种类有m种，那么自然界的颜色就可以表示为一个3Xm的矩阵，同理sensor对自然界的感光也可以得到一个3Xm的矩阵。</p>
<p>那么我们需要做的就是将右侧sensor感光的数据转换到左侧人眼感光的数据上来。（左侧为人眼感光数据矩阵，右侧为sensor感光数据矩阵），其中M的9个元素为3X3的CCM矩阵。</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm13.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm13.png" >
  
    </a>
  
  
</div>

<h2 id="03ccm">0.3CCM</h2>
<p>CCM(Color Correction Matrix)的作用就是通过一个3X3的矩阵使得颜色更接近人眼所感受的颜色。</p>
<h1 id="1颜色学基础">1颜色学基础</h1>
<h3 id="11cie-rgb">1.1CIE RGB</h3>
<p>这里就不得不提到<strong>颜色匹配实验</strong>了。</p>
<p>在20世纪初，大卫·赖特和约翰·吉尔德独立地与人类观察者进行了实验，在实验中，测试对象试图将红、绿、蓝光源的光谱颜色以10纳米的增量相匹配。这个实验非常类似于我们用滑块来匹配目标颜色，作为其他三种颜色的组合。</p>
<p>该实验原理如下图所示，右侧有两个屏幕，一侧有一个可以改变波长的光源，一侧是固定三种波长（红绿蓝）的光源，然后人眼通过一个角度去看这两个屏幕。f光源改变不同的波长呈现出不同的颜色，然后通过P1，P2，P3三个波长的光源不同的强度的混合，使得人眼感受到两个屏幕的颜色一致，然后记录下此时的三色值，那么该三色值就表示f测波长对应的颜色值。</p>
<p>国际照明委员会（CIE）于1931年提出了一个RGB颜色模型</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm14.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm14.png" >
  
    </a>
  
  
</div>

<p>从下图中可以看到CIE RGB有数据是负数，这个是因为某个波长r(λ)颜色的光通过P1，P2，P3在一侧混合无法得到，那么就需要将某个光源放到f测去才能到达这种效果，那么此时就相当于对改颜色做了减法，那么就出现了负数。</p>
<p><strong>光谱三刺激值</strong></p>
<p>如果待测色光是辐射能量都相同的单色光（光谱色，光波段为380-760nm），我们把得到的<strong>三原色光强度值称之为：光谱三刺激值</strong>，用 r(λ),g(λ),r(λ)表示。颜色匹配过程可用公式表示如下：
$$
C_\lambda=\overline{r}(R)+\overline{g}(G)+\overline{b}(B)
$$</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm15.png" title="光谱三刺激值曲线图" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm15.png"  alt="光谱三刺激值曲线图">
  
    </a>
  
   
    <span class="caption">光谱三刺激值曲线图</span>
  
</div>

<p>CIE将实验的参考光源CIE R标准化为波长为700.0 nm的单色光，参考光源CIE G标准化为546.1 nm，参考光源CIE B标准化为435.8 nm，并给出了它们之间的相对强度比。这是我们讨论颜色的关键一步——我们最终基于一些物理上可测量的属性。</p>
<p>让我们看看黄色波长570nm。从颜色匹配图中我们可以看出，颜色匹配需要0.16768个单位的CIE R, 0.17087个单位的CIE G和- 0.00135个单位的CIE B。一组三个RGB坐标只是为了三维的呈现。如果我们读取每个波长的颜色匹配值，我们得到下面的图:</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm16.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm16.png" >
  
    </a>
  
  
</div>

<blockquote>
<p>Q:为什么光谱曲线没有经过CIE RGB立方体的纯红、绿或蓝端点，</p>
<p>A:它只是委员会对颜色匹配函数进行规范化和缩放的结果。在合理的范围内，光源可以根据需要被构造成强大的，所以什么构成“1.0”总是被任意地定义。</p>
</blockquote>
<h2 id="12cie-xyz">1.2CIE XYZ</h2>
<p>因为发现这个上述RGB模型存在缺陷，其中红色响应在435.1~546.1波段出现了负值，给配色造成了极大不便。CIE RGB色彩空间植根于单色光的具体物理特性，我们可以用它来定义任何颜色感觉。然而，委员会努力创造一个衍生空间，将有一些有用的属性，其中两个值得注意:</p>
<ul>
<li>没有光谱颜色的负坐标</li>
<li>色度(色调和色彩)与亮度(亮度的视觉感知)的分离</li>
</ul>
<p>经过一番考虑，我们得到了下面的一组方程:
$$
X = 2.769×R_{CIE} + 1.752×G_{CIE} + 1.130×B_{CIE}\<br>
Y = 1.000×R_{CIE} + 4.591×G_{CIE} + 0.061×B_{CIE}\<br>
Z = 0.000×R_{CIE} + 0.057×G_{CIE} + 5.594×B_{CIE}<br>
$$
这些因素可能看起来是任意的，在某种意义上它们是，但这只是另一个从一个空间到另一个空间的值映射，类似于我们用RGB到R&rsquo;G&rsquo;B&rsquo;变换所做的。选择Y分量作为亮度分量，而X和Z定义色度。</p>
<p>国际照明委员会（CIE）于1931年首次用纯数学的方法定义了一种颜色空间模型，即CIE 1931 XYZ 颜色空间，它覆盖了人眼所能感知的全部颜色，而且不依赖于任何特定的物理实现。当一个颜色以XYZ 形式表示时，在任何支持XYZ标准的显示器上都会渲染出一致的颜色，与显示器的具体物理特性无关。</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm17.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm17.png" >
  
    </a>
  
  
</div>

<p>你可以看到XYZ空间是如何围绕光谱曲线设计的，以确保它符合正八分区。它的小尺寸并不是一个真正的问题，通过确保感知到的最亮波长555nm的Y值为1，缩放使事情更方便使用。作为最后一步，我们可以单独显示XYZ空间和光谱颜色:</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm18.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm18.png" >
  
    </a>
  
  
</div>

<p>由于CIE XYZ空间源自CIE RGB，它也基于可测量的物理量。XYZ色彩空间是用于<strong>所有基于矩阵的RGB显示色彩空间转换的基本色彩空间</strong>。任何两个色彩空间之间的映射都是通过一个通用的CIE XYZ中间体完成的。这简化了颜色变换，因为我们不需要知道如何在任意两个颜色空间之间转换颜色，我们只需要能够将它们都转换到XYZ空间。</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm38.png" title="CIE 1931 XYZ系统光谱三刺激值曲线图" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm38.png"  alt="CIE 1931 XYZ系统光谱三刺激值曲线图">
  
    </a>
  
   
    <span class="caption">CIE 1931 XYZ系统光谱三刺激值曲线图</span>
  
</div>

<h2 id="13cie-xy色度图">1.3CIE xy色度图</h2>
<p>三维图表玩起来很有趣，但它们通常不是特别实用——2D图表通常更容易处理和推理。由于XYZ空间的Y分量没有任何色彩和色调，所以我们只剩下两个影响颜色色度的分量。我们可以执行三种旨在降低空间维数的操作（这里归一化处理）:
$$
x = X / (X + Y + Z)\<br>
y = Y / (X + Y + Z)\<br>
z = Z / (X + Y + Z)<br>
$$
小写和大写的区别在这里很重要——x和X不一样。这些看似任意的方程有一个简单的视觉解释——它是在XYZ坐标<code>[1.0,0.0,0.0]</code>和<code>[0.0,1.0,0.0]</code>和<code>[0.0,0.0,1.0]</code>之间的三角形上的投影。</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm19.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm19.png" >
  
    </a>
  
  
</div>

<p>注意到x, y, z加起来等于1，所以我们可以去掉最后一个分量，因为它是冗余的——我们总是可以通过从1中减去x和y来重新生成它。拒绝z等于在xy平面上的平面投影:</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm20.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm20.png" >
  
    </a>
  
  
</div>

<p>如果我们对光谱颜色的每个组合重复这一步骤，我们最终可以呈现出被称为CIE xy<strong>色度图</strong>的2D图。你以前可能见过这个马蹄形:</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm21.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm21.png" >
  
    </a>
  
  
</div>

<blockquote>
<p>补充说明</p>
<p>1.色觉异常的色度学表现</p>
<p>大部分色觉异常者仅有一种锥细胞无法正常工作，而剩余的锥细胞依然能提供“彩色”的视觉信息。因此，<strong>色觉异常者眼中的世界并非只有黑白两色，只不过他们的辨色能力比普通人更弱，他们所“看见”的世界也和普通人的不同。</strong></p>
<p>由于辨色能力的缺陷，很多普通人看来明显不同的颜色，色觉异常者却认为几乎一致，这种现象称为颜色混同（color confusion）**。**研究者在CIE1931色品图上绘制出了混同线，来标识色觉异常者难以辨别的颜色。从图中可以看出，红、绿色盲都难以分辨红色和绿色，红色盲还无法分辨蓝色和紫色，可能将青色视为灰色，而绿色盲容易混淆青色和紫色。</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm34.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm34.png" >
  
    </a>
  
  
</div>

<p>2.等色温线</p>
<p>色温是由英国物理学家洛德·开尔文于19世纪末提出的，其通过对比光源的颜色和理想黑体来确定。当某光源所呈现的颜色与黑体在某一温度下的颜色相同时，则此时黑体的温度就称为该光源的颜色温度，简称色温。由于某些光源的光谱分布与黑体相差较远，它们在某一温度时的相对光谱功率分布所决定的色品坐标不一定准确地落在色品图的黑体温度轨迹上，这时不能用色温来描述其颜色，而采用相关色温来表征这类光源的光色特性。<strong>相关色温定义为当光源的颜色与黑体在某一温度下的颜色最接近时的黑体温度</strong>。一般，日常生活中所提到的色温是指相关色温。（不同色温下的黑体轨迹和等色温线）</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm33.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm33.png" >
  
    </a>
  
  
</div>

</blockquote>
<h2 id="14srgb色域">1.4sRGB色域</h2>
<p>sRGB代表了标准的红、绿、蓝，即CRT显示器、LCD面板、投影机、打印机以及其他设备中色彩再现所使用的三个基本色素。sRGB的色彩空间基于独立的色彩坐标，可以使色彩在不同的设备使用传输中对应于同一的色彩坐标体系，而不受这些设备各自具有的不同色彩坐标的影响。 投影显示系统的sRGB是微软公司与精工爱普生公司、三菱公司合作开发的，目的是建立一个可以<strong>满足计算机和投影显示需求的色彩管理标准</strong>，使得显示设备无须经过特别的色彩信息分析，就可以正确地表现出图象文件。<strong>sRGB消除了不同显示系统在色彩还原上的原有差异</strong>。不同显示设备间的RGB色彩，自然会发生一些变化，因而经过不同的显示设备后就无法正确地再现色彩。</p>
<p>因为现实器也不可能现实自然界所有的颜色，所以就在xy坐标系中选取一个三角形范围作为现实器的显示色域。同时通过定义不同的区域还有Adobe RGB色域空间和其他。</p>
<p>常用的设备无关颜色空间是CIE XYZ颜色空间。而生活中常用的设备无关颜色空间还有sRGB、AdobeRGB和ProPhoto RGB颜色空间。通常浏览网页时，我们看到的图像使用的就是sRGB颜色空间。目前ISP中CCM的目标通常是以sRGB为常用的<strong>设备无关颜色空间</strong>。</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm22.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm22.png" >
  
    </a>
  
  
</div>

<blockquote>
<p><strong>颜色管理流程示例</strong></p>
<p>之所以图像在跨设备进行传输时产生了变化，主要的原因是两台设备采用设备相关的RGB传输，而输入相同的RGB值在不同设备中却对应不同的实际颜色所致。</p>
<p>在设备相关颜色空间与设备无关颜色空间之间尽可能准确地建立数学映射关系就是颜色特征化。简单来说，颜色特征化能通过设备的数字驱动值RGB精确预测出设备显现的实际颜色。因此，设备的颜色特征化是颜色管理的基础步骤和关键环节，它可以精确控制颜色信息在图像设备之间的复制与传递。</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm27.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm27.png" >
  
    </a>
  
  
</div>

</blockquote>
<h2 id="15lab和luv">1.5<code>L*A*B</code>和LUV</h2>
<p>生活中我们经常使用设备相关的RGB颜色空间进行颜色的处理和表征。但是，发现RGB间距相同的颜色组合所产生的颜色<strong>感知差异是不同的</strong>，这是因为在该颜色空间中，各色区的颜色感知差异容限大小不等。虽然在驱动值RGB间距相等的颜色对，但是人眼感知还是有差异，左边会觉得差异更大。</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm28.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm28.png" >
  
    </a>
  
  
</div>

<h3 id="151颜色空间的非均匀性">1.5.1颜色空间的非均匀性</h3>
<p>上述问题同样存在于国际照明委员会（CIE）推荐的CIE1931和CIE1964标准色度系统中，这也使得在工业生产中难以使用标准色度系统对颜色进行精确的比较和评价。</p>
<p>1942年麦克亚当对CIE-xy色品图的非均匀性进行了详细的实验研究，他选定了25个颜色中心，在5~9个方向上用加混色进行多次颜色匹配测试。在实验中，他采用2°观察视场并保持颜色亮度不变。实验表明，即使对某一确定的方向，每次实验的结果也是不同的，并在视觉可识别的界限内变动。麦克亚当将不同方向上该变动的标准偏差在色品图上描点，得到下图的麦克亚当椭圆 (<strong>图中椭圆放大了10 倍</strong>)。</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm29.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm29.png" >
  
    </a>
  
  
</div>

<p>通过麦克亚当椭圆在CIE-xy色品图上的分布，我们可以看出CIE-xy色品图是非常不均匀的。在色品图左下方的蓝紫色区，色品坐标稍有变化就能识别，而对于上方的绿色区，色品坐标约变化前者的10倍才能分辨。理想的均匀色品图应满足图上任何位置的麦克亚当椭圆都是半径相等的圆。</p>
<h3 id="152均匀颜色空间">1.5.2均匀颜色空间</h3>
<p>国际照明委员会根据麦克亚当的工作对CIE-xy色品图进行适当的变换，对色品图的非均匀性进行了一定程度的改善。同时，在结合明度与亮度的非线性关系，对亮度因数进行修正后，于1976年推荐了<code>CIE1976 L*u*v</code>颜色空间（也称CIELUV颜色空间）和<code>CIE1976 L*a*b</code>颜色空间（也称CIELAB颜色空间），分别用于电视工业等加混色和表面色料工业等减混色的表示和评价。</p>
<h4 id="1521cie1976-luv颜色空间">1.5.2.1<code>CIE1976 L*u*v</code>*颜色空间</h4>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm36.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm36.png" >
  
    </a>
  
  
</div>

<p>在<code>CIE1976 L*u*v</code><em>颜色空间中，<code>L*</code>为明度，<code>u*</code>、<code>v*</code>表示色品坐标，其计算公式为
$$
\begin{cases}
L^</em>=116(Y/Y_n)^{1/3}-16,&amp;&amp;Y/Y_n&gt;(24/116)^3\<br>
u^<em>=13L</em>(u'-u'_n)\<br>
v^<em>=13L</em>(v'-v'_n)<br>
\end{cases}
$$
式中，u'、v&rsquo;和u'<!-- raw HTML omitted -->n<!-- raw HTML omitted -->、v'<!-- raw HTML omitted -->n<!-- raw HTML omitted -->分别是颜色样品和CIE标准照明体的CIE1976 UCS色品坐标；X、Y、Z为颜色样品的三刺激值，X<!-- raw HTML omitted -->n<!-- raw HTML omitted -->、Y<!-- raw HTML omitted -->n<!-- raw HTML omitted -->、Z<!-- raw HTML omitted -->n<!-- raw HTML omitted -->为CIE标准照明体照射在完全漫反射体上，然后反射到观察者眼中的三刺激值，其中Y<!-- raw HTML omitted -->n<!-- raw HTML omitted -->=100。</p>
<p>如果 u* 和 v* 都是正值，则 h<!-- raw HTML omitted -->uv<!-- raw HTML omitted --> 在 0° 和 90° 之间；</p>
<p>如果 v* 是正值，而 u* 是负值，则 h<!-- raw HTML omitted -->uv<!-- raw HTML omitted --> 在 90° 和 180° 之间；</p>
<p>如果 v<em>和 u</em> 都是负值，则 h<!-- raw HTML omitted -->uv<!-- raw HTML omitted -->在 180° 和 270° 之间；</p>
<p>如果 v* 是负值，而 u* 是正值，则 h<!-- raw HTML omitted -->uv<!-- raw HTML omitted --> 在 270° 和 360° 之间。</p>
<h4 id="1522cie1976-lab颜色空间">1.5.2.2<code>CIE1976 L*a*b</code>*颜色空间</h4>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm35.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm35.png" >
  
    </a>
  
  
</div>

<p><code>CIE L*a*b*</code>又称<strong>CIELAB</strong>颜色空间，是目前应用最广的颜色空间之一，它的主要优点是颜色之间的距离与人的知觉更好地符合线性关系，尤其是描述较暗的颜色准确度更高。轻微的不足是描述黄色区域时线性关系会有一定变化，即颜色宽容量的圆圈在黄色附近直径会有变化。</p>
<p><strong>CIELAB</strong> 颜色空间在知觉均匀性方面与CIE 1976 UCS类似，两种标准都不是十全十美的，但都取得了广泛的应用。关于这两个颜色空间哪一个会更均匀一些，学术界还没有形成明确的结论。目前似乎是CIELAB的应用会更多一些。</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm37.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm37.png" >
  
    </a>
  
  
</div>

<p>在<code>CIE1976 L*a*b</code><em>颜色空间中，<code>L*</code>为明度，<code>a*</code>、<code>b*</code>表示色品坐标，其计算公式为
$$
\begin{cases}
L^</em>=116(Y/Y_n)^{1/3}-16,&amp;&amp;Y/Y_n&gt;(24/116)^3\<br>
a^<em>=500[f(X/X_n)-f(Y/Y_n)]\<br>
b^</em>=200[f(Y/Y_n)-f(Z/Z_n)]<br>
\end{cases}
$$
式中，X、Y、Z和X<!-- raw HTML omitted -->n<!-- raw HTML omitted -->、Y<!-- raw HTML omitted -->n<!-- raw HTML omitted -->、Z<!-- raw HTML omitted -->n<!-- raw HTML omitted -->的含义与CIELUV颜色空间的对应参数相同。</p>
<p>如果 a* 和 b* 均为正值，h<!-- raw HTML omitted -->ab<!-- raw HTML omitted --> 位于 0° 和 90° 之间；</p>
<p>如果 b* 为正值，a* 为负值，h<!-- raw HTML omitted -->ab<!-- raw HTML omitted --> 位于 90° 和 180° 之间；</p>
<p>如果 b* 和 a* 均为负值，h<!-- raw HTML omitted -->ab<!-- raw HTML omitted --> 位于 180° 和 270° 之间；</p>
<p>如果 b* 为负值，a* 为正值，h<!-- raw HTML omitted -->ab<!-- raw HTML omitted --> 位于 270° 和 360° 之间。</p>
<p>此外，在CIELUV和CIELAB颜色空间中还各有一组与心理量近似对应的感知属性，即明度（L*，如上）以及彩度和色调角，以下是具体计算公式，并以下标“uv”和“ab”来区分。</p>
<h4 id="1523彩度">1.5.2.3彩度</h4>
<p>$$
\begin{cases}
C_{uv}^*=(u^{*2}+v^{*2})^{1/2}\<br>
C_{ab}^*=(a^{*2}+b^{*2})^{1/2}<br>
\end{cases}
$$</p>
<h4 id="1524色调角">1.5.2.4色调角</h4>
<p>$$
\begin{cases}
h_{uv}^*=arctan(v^*/u^*)\<br>
h_{ab}^*=arctan(b^*/a^*)<br>
\end{cases}
$$</p>
<h4 id="1525饱和度">1.5.2.5饱和度</h4>
<p>另外，在CIELUV颜色空间中还有一个心理相关量即饱和度，其计算公式为
$$
S_{uv}=13[(u'-u'_n)^2+(v'-v'_n)^2]^{1/2}=C_{uv}^*/L^*
$$
CIELUV和CIELAB颜色空间由CIE XYZ系统的非线性变换推导而来，以其转换公式简单、颜色空间相对均匀等优点，在色彩行业得到了广泛的应用</p>
<h3 id="153计算色差">1.5.3计算色差</h3>
<p>色差公式旨在提供成对颜色样品之间感知色差的定量表示，理想的色差公式应基于真正视觉感知均匀的颜色空间，其预测的色差应与目视判断具有良好的一致性。颜色科学工作者对色差评价进行了大量研究，并提出了多种色差公式，其中应用广泛的典型色差评价模型包括CIELAB、CMC(<em>l</em>:<em>c</em>)、CIE94以及CIEDE2000色差公式。</p>
<h4 id="1531cieluv和cielab色差公式">1.5.3.1CIELUV和CIELAB色差公式</h4>
<p>CIELUV和CIELAB色差公式以被比较颜色点在对应颜色空间中的欧氏距离表示色差，即
$$
\begin{cases}
\Delta{E_{uv}^*}=(\Delta{L^*}^2+\Delta{u^*}^2+\Delta{v^*}^2)^{1/2}\<br>
\Delta{E_{ab}^*}=(\Delta{L^*}^2+\Delta{a^*}^2+\Delta{b^*}^2)^{1/2}<br>
\end{cases}
$$
然而，随着更多心理物理学实验的开展，人们逐渐发现上述两个色差方程并不能准确量化中小幅度的色差，并且在<code>u*v*</code>、<code>a*b*</code>平面中麦克亚当椭圆的形状和分布也不均匀规整。(色差相同的颜色对呈现出不一致的感知差异，很明显左边的色差更大)</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm32.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm32.png" >
  
    </a>
  
  
</div>

<h4 id="1532cmclc色差公式">1.5.3.2CMC(l:c)色差公式</h4>
<p>CMC(<em>l</em>:<em>c</em>)色差公式克服了当时其它色差公式在深色及中性色范围计算结果与视觉感知偏差较大的现象，具有比CIELAB公式更好的视觉一致性，并于1995年成为纺织行业的国际标准。CMC(<em>l</em>:<em>c</em>)色差模型的具体计算公式如下：
$$
\Delta{E_{CMC(l:c)}}={[\Delta{L_{ab}^*}/(lS_L)]^2+[\Delta{C_{ab}^*}/(cS_C)]^2+[\Delta{H_{ab}^*}/S_H]^2}^{1/2}
$$
式中，<code>△L*ab</code>、<code>△C*ab</code>和<code>△H*ab</code>分别对应于CIELAB颜色空间的明度差、彩度差和色调差；、和定义容差椭球体的半轴长度，分别对应明度、彩度和色调方向；明度权重因子*l*和彩度权重因子*c*分别用来调整明度和彩度对总色差的影响程度，所以在不同的应用场合应取其不同的比值。大量实验表明，对色差的可接受性评价时，推荐采用<code>l:c=2:1</code>，如在纺织业界对产品的质量控制大多采用CMC(2:1)公式；而对色差的可察觉性评价时，推荐采用<code>l:c=1:1</code>，如对数字系统的色度校正以及涂料或塑料等行业一般采用CMC(1:1)公式。</p>
<h4 id="1533cie94色差公式">1.5.3.3CIE94色差公式</h4>
<p>国际照明委员会于1994年推荐了CIE94色差公式。它具有与 CMC(<code>l:c</code>)色差公式相似的结构，但具有更简单的加权函数。该公式探讨了色差距离的均匀性和参量对知觉色差的影响，并对参照条件进行了严格的说明。然而，在实际观察条件与其不符时，需要调整明度、彩度和色调分色差在总色差中的相对权重。CIE94色差模型的具体计算公式如下：
$$
\Delta{E_{94}^*}={[\Delta{L^*}/(K_LS_L)]^2+[\Delta{C_{ab}^*/(K_CS_C)}]^2+[\Delta{H_{ab}^*/(K_HS_H)}]^2}^{1/2}
$$
式中，参数因子K<!-- raw HTML omitted -->L<!-- raw HTML omitted -->、K<!-- raw HTML omitted -->C<!-- raw HTML omitted -->和K<!-- raw HTML omitted -->H<!-- raw HTML omitted -->用以调整明度、彩度和色调分色差的相对权重，S<!-- raw HTML omitted -->L<!-- raw HTML omitted -->、S<!-- raw HTML omitted -->C<!-- raw HTML omitted -->和S<!-- raw HTML omitted -->H<!-- raw HTML omitted -->的意义与CMC(*l*:*c*)色差公式相似。对于除纺织业以外的一般应用，建议所有参数因子的比值均为1；对于纺织行业，建议采用2:1:1的比值。</p>
<h4 id="1534ciede2000色差公式">1.5.3.4CIEDE2000色差公式</h4>
<p>为进一步改善工业色差评价的视觉一致性，国际照明委员会成立了TC1-47技术委员会，对已有色差模型和视觉评价数据进行大量分析，并于2000年推荐了新的色差评价公式，即
$$
\Delta{E_{00}}={[\Delta{L'}/(k_LS_L)]^2+[\Delta{C'_{ab}}/(k_CS_C)]^2+[\Delta{H'_{ab}}/(k_HS_H)]^2\<br>
+R_T[\Delta{C'_{ab}}/(k_CS_C)]}^{1/2}
$$
式中，为R<!-- raw HTML omitted -->T<!-- raw HTML omitted -->为旋转项，其余因子意义与上述公式相似。CIEDE2000色差公式不仅包括明度、彩度和色调加权函数，还包括彩度差和色调差的交互项，提高了蓝色区域的色差预测性能，也是**CIE目前推荐的最新色差评价公式**。</p>
<h4 id="1534不同色差公式的计算结果">1.5.3.4不同色差公式的计算结果</h4>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm31.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm31.png" >
  
    </a>
  
  
</div>

<h2 id="16-24色卡">1.6 24色卡</h2>
<p>ColorChecker Classic色卡由4行6列共计24种不同的色块组成，这些色块涵盖了经科学配制的自然色、原色以及中性色，可在不同光源下与其代表的物体色相匹配，以实现颜色的准确再现。其中，第一行代表了常见的物体色（natural colors），例如深肤色、浅肤色、树叶、天空等；第二行则包含了自然界除上述典型物体色之外的其它颜色（miscellaneous colors）；第三行的色块为饱和度较高的三基色或其组合色（primary and secondary colors），通常用于测试、校准设备的色域边界；最后一行均为中性色块（grayscale colors），是白平衡校正、灰阶校正的重要参考依据，如下图所示。</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm23.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm23.png" >
  
    </a>
  
  
</div>

<p>下表列出了ColorChecker Classic各色块的色名以及所对应的sRGB颜色外貌与参考数值，其中序号20至23中性色块色名中的数字表示其孟塞尔明度值。以第22号色块（neutral 5）为例，其孟塞尔标号为N5，表面反射率约为18.4%。</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm24.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm24.png" >
  
    </a>
  
  
</div>

<p>24个色块在CIE1931 xy色品图上的分布情况，可见其色域基本覆盖了sRGB，适用于绝大多数颜色管理场景。</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm25.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm25.png" >
  
    </a>
  
  
</div>

<p>另外，航空航天中视频画面传输也会被用到，红色区域所示即为24色卡</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm26.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm26.png" >
  
    </a>
  
  
</div>

<h1 id="2算法与案例精选">2算法与案例精选</h1>
<h2 id="21关于ccm">2.1关于CCM</h2>
<h3 id="211卢瑟条件">2.1.1<strong>卢瑟条件</strong></h3>
<p>卢瑟条件（Luther condition）大意是说三个线性无关的原色，经过混合能够表示任意一种颜色。</p>
<h3 id="212what-is-ccm--why-ccm">2.1.2<strong>What is CCM &amp; Why CCM</strong></h3>
<p>由于相机的颜色匹配特性通常不满足卢瑟条件（也就是说sensor的RGB响应通常不是线性无关的），即相机的颜色匹配特性与CIE标准观察者之间并不存在线性关系。因此，我们需要某种方法来校正相机的特性，使其接近标准观察者。在实际的ISP处理中，这种方法通常以3x3矩阵的形式出现，称为色彩校正矩阵（colour correction matrix）</p>
<p>CCM的作用主要有两个：</p>
<ol>
<li>完成了sensor_RGB色彩空间到设备无关的<strong>颜色空间sRGB色彩空间的转换</strong></li>
<li>使得相机的颜色匹配特性满足卢瑟条件，具体效果如下图所示</li>
</ol>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm39.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm39.png" >
  
    </a>
  
  
</div>

<h3 id="213ccm公式的物理意义">2.1.3CCM公式的物理意义</h3>
<p>CCM公式的物理意义是从<strong>一种颜色种减除另外两种颜色的成分，以增加该颜色的饱和度</strong>，使变换的结果接近人的视觉感受，或者更符合人的主观审美。由于输入颜色可以有上千万种组合，而CCM参数却只有9个，所以CCM实际上只能优先保证几个最重要的颜色在人看来是“正确”的，而不可能面面俱到地保证所有颜色在所有条件下都是最优的。</p>
<h3 id="214ccm基本约束">2.1.4CCM基本约束</h3>
<p>CCM公式的一个基本约束就是不能破坏白平衡，即对于任何R=G=B的输入，必须保证输出满足R'=G'=B'。正式由于这个原因，颜色校正操作只能放在白平衡调整之后执行。通常归一化之后，每一行都会是固定值，比如每一行和为1。</p>
<p>实践中通常使用X-Rite 24色卡上的18个彩色色块为标准计算校正系数，基本原理是用摄像机拍摄色卡，提取18个色块的平均颜色（Rn, Gn, Bn），n=1..18 构成输入矩阵
$$
S=
\begin{bmatrix}
R_1 &amp; R_2 &amp; R_3 &amp;&hellip;&amp;R_n\<br>
G_1 &amp; G_2 &amp; G_3 &amp;&hellip;&amp;G_n\<br>
B_1 &amp; B_2 &amp; B_3 &amp;&hellip;&amp;B_n<br>
\end{bmatrix}
$$
用24色卡上的18个彩色色块的标准sRGB值构成目标矩阵
$$
S'=
\begin{bmatrix}
R_1' &amp; R_2' &amp; R_3' &amp;&hellip;&amp;R_n'\<br>
G_1' &amp; G_2' &amp; G_3' &amp;&hellip;&amp;G_n'\<br>
B_1' &amp; B_2' &amp; B_3' &amp;&hellip;&amp;B_n'<br>
\end{bmatrix}
$$
则有关于CCM的矩阵方程
$$
S'=M·S\<br>
\begin{bmatrix}
R_1' &amp; R_2' &amp; R_3' &amp;&hellip;&amp;R_n'\<br>
G_1' &amp; G_2' &amp; G_3' &amp;&hellip;&amp;G_n'\<br>
B_1' &amp; B_2' &amp; B_3' &amp;&hellip;&amp;B_n'<br>
\end{bmatrix}=
\begin{bmatrix}
a_{11} &amp; a_{12} &amp; a_{13}\<br>
a_{21} &amp; a_{22} &amp; a_{23}\<br>
a_{31} &amp; a_{32} &amp; a_{33}<br>
\end{bmatrix}
\begin{bmatrix}
R_1 &amp; R_2 &amp; R_3 &amp;&hellip;&amp;R_n\<br>
G_1 &amp; G_2 &amp; G_3 &amp;&hellip;&amp;G_n\<br>
B_1 &amp; B_2 &amp; B_3 &amp;&hellip;&amp;B_n<br>
\end{bmatrix}\<br>
其中\begin{bmatrix}
a_{11} &amp; a_{12} &amp; a_{13}\<br>
a_{21} &amp; a_{22} &amp; a_{23}\<br>
a_{31} &amp; a_{32} &amp; a_{33}<br>
\end{bmatrix}=<br>
\begin{bmatrix}
r_1 &amp; r_2 &amp; r_3\<br>
g_1 &amp; g_2 &amp; g_3\<br>
b_1 &amp; b_2 &amp; b_3<br>
\end{bmatrix}=<br>
\begin{bmatrix}
RR &amp; GR &amp; BR\<br>
RG &amp; GG &amp; BG\<br>
RB &amp; GB &amp; BB<br>
\end{bmatrix}
$$
求解M的过程为
$$
S'·S^T=M·S·S^T\<br>
M=S'·S^T(S·S^T)^{-1}
$$
上述过程需要使用某种色卡，因此称为patch-based方法。</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm40.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm40.png" >
  
    </a>
  
  
</div>

<h3 id="215ccm常见的调试方法">2.1.5CCM常见的调试方法</h3>
<p>1）将参数在<code>L*a*b*</code> 色域中标注出来:</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm41.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm41.png" >
  
    </a>
  
  
</div>



 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm42.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm42.png" >
  
    </a>
  
  
</div>

<p>2）重点关注RGB三原色的色相，往哪边偏就把对应的数值减小，把相邻的数值加大</p>
<p>例如，R向M方向偏，就需要把①对应的数值减小，把②对应的数值加大。</p>
<p>3）用主色分量上的值补偿之前的修改，使每行之和恒等于1</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm43.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm43.png" >
  
    </a>
  
  
</div>

<p>4）饱和度</p>
<p>单一颜色的饱和度可以将<strong>主色分量所在列</strong>的另外两个分量减小或加大相同的比例。</p>
<p>例如，要加大R的饱和度，需要将g1，b1减小相同的比例；</p>
<p>要减小R的饱和度，需要将g1，b1加大相同的比例。</p>
<p>5）调试小技巧</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm44.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm44.png" >
  
    </a>
  
  
</div>

<table>
<thead>
<tr>
<th>问题现象</th>
<th>调试方向</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>红色偏深</td>
<td>减rg和减rb</td>
<td>红色比例增多，相应的要增加gg，bb，则绿色和蓝色饱和度会提高</td>
</tr>
<tr>
<td>绿色更嫩</td>
<td>减gb和减gr</td>
<td>gb越小，绿色越黄；gr越小，绿色越青</td>
</tr>
<tr>
<td>肤色偏黄</td>
<td>加gb</td>
<td>蓝和黄相对时，蓝色会变淡</td>
</tr>
<tr>
<td>肤色变红</td>
<td>减br或加bg</td>
<td>br越小，蓝色越青</td>
</tr>
<tr>
<td>肤色偏红</td>
<td>加br</td>
<td>br越大，蓝色越紫</td>
</tr>
<tr>
<td>红色偏桔</td>
<td>减gr或加rb</td>
<td>rg越小，红色越粉</td>
</tr>
<tr>
<td>红色偏粉</td>
<td>加rg或减rb</td>
<td>rg越大，红色越桔，红色系饱和度回收</td>
</tr>
<tr>
<td>黄色偏红</td>
<td>加br或减bg</td>
<td>br越大，黄色越绿</td>
</tr>
<tr>
<td>黄色偏绿</td>
<td>减br或加bg</td>
<td>br越小，黄色越红</td>
</tr>
<tr>
<td>绿色偏青</td>
<td>加gr</td>
<td></td>
</tr>
<tr>
<td>绿色偏黄</td>
<td>加gb</td>
<td>蓝黄相对，蓝色变淡</td>
</tr>
<tr>
<td>蓝色变淡</td>
<td>减gb</td>
<td>gb越小，绿色越黄，且绿色饱和度下降，反之增加</td>
</tr>
<tr>
<td>蓝色偏青</td>
<td>加br或减bg</td>
<td>br越大，蓝色越紫</td>
</tr>
<tr>
<td>蓝色偏紫</td>
<td>减br或加bg</td>
<td>br越小，蓝色越青；加bg，蓝色和绿色饱和度都下降，但整体饱和度增加</td>
</tr>
</tbody>
</table>
<h2 id="22关于ccm算法">2.2关于CCM算法</h2>
<p>这里叫颜色校正算法其实主要是针对转换过程而言，因为CCM只是转换算法的一种。上面我们已经知道我们整个过程其实就是将一个矩阵转换为另外一个矩阵，那么我们首先能想到的就是LUT，就是将两个矩阵表示的颜色都通过一张表来表示对应的关系，那么进来一个颜色就可以通过查表快速得到想要的颜色。</p>
<h3 id="221-3d-lut">2.2.1 3D-LUT</h3>
<p>之前使用过2D的LUT（Look up table），现在用到的是三维空间的查找法。左边与设备无关，RGB通常是三维的空间，三个值都是0-255；和sensor相关的就是右边的颜色空间，通过3D-LUT来获取对应的颜值值。如果新空间到老的空间有对应的点就直接复制，没有的话通过插值的方式来获取。这里会使用3D插值，四个点组成一个四棱锥，获取四棱锥里面四个点距离通过比例进行三维插值。</p>
<p>这种方式用的比较少。</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm6.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm6.png" >
  
    </a>
  
  
</div>

<h2 id="22多项式拟合">2.2多项式拟合</h2>
<p>实际中大多数厂商用得都是这种，求的是CCM矩阵。多项式拟合有分成好多种，这里只介绍典型的。</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm7.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm7.png" >
  
    </a>
  
  
</div>



 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm8.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm8.png" >
  
    </a>
  
  
</div>

<h3 id="221算法">2.2.1算法</h3>
<p>imatest官网有对应的算法，具体网址可以<a href="https://www.imatest.com/support/docs/24-1/color-correction-matrix-ccm/">点击这里</a></p>
<div class="highlight"><pre class="chroma"><code class="language-matlab" data-lang="matlab"><span class="ln"> 1</span><span class="k">function</span> <span class="nf">ccm_test</span>
<span class="ln"> 2</span><span class="c">% Test program for applying Color Correction matrix.</span>
<span class="ln"> 3</span><span class="c">% Output for display gamma = 2.2 -- sRGB and Adobe RGB color spaces.</span>
<span class="ln"> 4</span>
<span class="ln"> 5</span><span class="c">% Read image file </span>
<span class="ln"> 6</span><span class="nb">disp</span><span class="p">(</span><span class="s">&#39;Enter the file for the Color Correction Matrix (CCM)&#39;</span><span class="p">);</span>
<span class="ln"> 7</span><span class="n">imagefile</span> <span class="p">=</span> <span class="n">input</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;s&#39;</span><span class="p">);</span>
<span class="ln"> 8</span>
<span class="ln"> 9</span><span class="nb">gamma</span>     <span class="p">=</span> <span class="n">input</span><span class="p">(</span><span class="s">&#39;Enter encoding gamma (typically 0.5 to 1)  &#39;</span><span class="p">);</span>
<span class="ln">10</span>
<span class="ln">11</span><span class="n">imageRGB</span>  <span class="p">=</span> <span class="n">imread</span><span class="p">(</span><span class="n">imagefile</span><span class="p">);</span>
<span class="ln">12</span><span class="n">imtype</span> <span class="p">=</span> <span class="n">class</span><span class="p">(</span><span class="n">imageRGB</span><span class="p">);</span>  <span class="c">% Image type: typically uint8 or uint16.</span>
<span class="ln">13</span><span class="n">imageRGB</span>  <span class="p">=</span> <span class="n">double</span><span class="p">(</span><span class="n">imageRGB</span><span class="p">)</span><span class="o">/</span><span class="n">double</span><span class="p">(</span><span class="n">intmax</span><span class="p">(</span><span class="n">imtype</span><span class="p">));</span>  <span class="c">% Normalize to maximum for image type.</span>
<span class="ln">14</span><span class="n">figure</span><span class="p">;</span>  <span class="n">image</span><span class="p">(</span><span class="n">imageRGB</span><span class="p">);</span>
<span class="ln">15</span><span class="n">title</span><span class="p">([</span><span class="s">&#39;Original image:  gamma = &#39;</span> <span class="n">num2str</span><span class="p">(</span><span class="nb">gamma</span><span class="p">)]);</span>  <span class="c">% Works without Image Processing Toolbox.</span>
<span class="ln">16</span>
<span class="ln">17</span><span class="n">linearRGB</span> <span class="p">=</span> <span class="n">imageRGB</span><span class="o">.^</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="nb">gamma</span><span class="p">);</span>  <span class="c">% Linearize the image (apply inverse of encoding gamma).</span>
<span class="ln">18</span>
<span class="ln">19</span><span class="c">% The CCM has 3 lines, which makes it tricky to enter.</span>
<span class="ln">20</span><span class="nb">disp</span><span class="p">(</span><span class="s">&#39;(Calculate a 3x3 CCM in Color/Tone Interactive, then press File, &#39;&#39;Copy Color Matrix to Clipboard&#39;&#39;).&#39;</span><span class="p">);</span>
<span class="ln">21</span><span class="nb">disp</span><span class="p">(</span><span class="s">&#39;Press &#39;&#39;enter&#39;&#39; when the the CCM is in the clipboard&#39;</span><span class="p">);</span>
<span class="ln">22</span><span class="n">inp</span> <span class="p">=</span> <span class="n">input</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;s&#39;</span><span class="p">);</span>  <span class="c">% pause fails after copy to clipboard. inp is not used.</span>
<span class="ln">23</span>
<span class="ln">24</span><span class="n">ccm</span> <span class="p">=</span> <span class="n">clipboard</span><span class="p">(</span><span class="s">&#39;paste&#39;</span><span class="p">);</span>
<span class="ln">25</span><span class="n">ccm</span>     <span class="p">=</span> <span class="n">strrep</span><span class="p">(</span><span class="n">ccm</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="s">&#39;;&#39;</span><span class="p">);</span>  <span class="c">% Bring back semicolons.</span>
<span class="ln">26</span><span class="n">ccmnum</span>  <span class="p">=</span> <span class="n">str2num</span><span class="p">(</span><span class="n">ccm</span><span class="p">),</span>  <span class="c">% str2double doesn&#39;t work.</span>
<span class="ln">27</span><span class="c">% Change to 2D to apply matrix; then change back.</span>
<span class="ln">28</span><span class="p">[</span><span class="n">my</span><span class="p">,</span> <span class="n">mx</span><span class="p">,</span> <span class="n">mc</span><span class="p">]</span> <span class="p">=</span> <span class="nb">size</span><span class="p">(</span><span class="n">linearRGB</span><span class="p">);</span>  <span class="c">% rows, columns, colors (3)</span>
<span class="ln">29</span><span class="n">linearRGB</span> <span class="p">=</span> <span class="nb">reshape</span><span class="p">(</span><span class="n">linearRGB</span><span class="p">,</span><span class="n">my</span><span class="o">*</span><span class="n">mx</span><span class="p">,</span><span class="n">mc</span><span class="p">);</span> 
<span class="ln">30</span><span class="n">correctedRGB</span> <span class="p">=</span> <span class="n">linearRGB</span><span class="o">*</span><span class="n">ccmnum</span><span class="p">;</span>  
<span class="ln">31</span><span class="n">correctedRGB</span> <span class="p">=</span> <span class="n">min</span><span class="p">(</span><span class="n">correctedRGB</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>  <span class="n">correctedRGB</span> <span class="p">=</span> <span class="n">max</span><span class="p">(</span><span class="n">correctedRGB</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>  <span class="c">% Place limits on output.</span>
<span class="ln">32</span><span class="n">correctedRGB</span> <span class="p">=</span> <span class="n">correctedRGB</span><span class="o">.^</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mf">2.2</span><span class="p">);</span>  <span class="c">% Apply gamma for sRGB, Adobe RGB color space.</span>
<span class="ln">33</span><span class="c">% Deal with saturated pixels. Not perfect, but this is what cameras do. Related to &#34;purple fringing&#34;.</span>
<span class="ln">34</span><span class="n">correctedRGB</span><span class="p">(</span><span class="n">linearRGB</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c">% Don&#39;t change saturated pixels. (We don&#39;t know HOW saturated.)</span>
<span class="ln">35</span><span class="n">correctedRGB</span> <span class="p">=</span> <span class="nb">reshape</span><span class="p">(</span><span class="n">correctedRGB</span><span class="p">,</span> <span class="n">my</span><span class="p">,</span> <span class="n">mx</span><span class="p">,</span> <span class="n">mc</span><span class="p">);</span> 
<span class="ln">36</span>
<span class="ln">37</span><span class="n">figure</span><span class="p">;</span>  <span class="n">image</span><span class="p">(</span><span class="n">correctedRGB</span><span class="p">);</span>  <span class="n">title</span><span class="p">(</span><span class="s">&#39;Corrected image&#39;</span><span class="p">);</span>
</code></pre></div><h3 id="222其他形式">2.2.2其他形式</h3>
<p>多项式拟合还存在一种根多项式和多次项式</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm46.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm46.png" >
  
    </a>
  
  
</div>

<h3 id="223多项式拟合原理">2.2.3多项式拟合原理</h3>
<p>其中我们sensorRGB与sRGB之间有下面的关系</p>
<ul>
<li>sensorRGB到sensor XYZ颜色空间，需要矩阵M1</li>
<li>sensor XYZ颜色空间到sensor <code>L*a*b*</code>颜色空间，需要矩阵M2</li>
<li>sensor <code>L*a*b*</code>颜色空间到目标的 <code>L*a*b*</code>颜色空间，需要矩阵M3</li>
<li>目标的 <code>L*a*b*</code>颜色空间到目标的XYZ颜色空间，需要矩阵M4</li>
<li>目标的XYZ颜色空间到sRGB颜色空间，需要矩阵M5</li>
</ul>
<p>上述M2，M4，M5都是已知的，通过sensor <code>L*a*b*</code>颜色空间到目标的 <code>L*a*b*</code>颜色空间，可以求出M3，再通过sensorRGB到sensor XYZ颜色空间，需要矩阵M1，最终<code>M1*M2*M3*M4*M5</code>的综合为所需的CCM矩阵。</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm47.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm47.png" >
  
    </a>
  
  
</div>

<h2 id="33神经网络拟合">3.3神经网络拟合</h2>
<p>当然实际中没法把所有的颜色的数据都得到，那么就通过采样的到部分坐标的数据形成一个三维表，其他不在采样点位置的数据就可以通过插值的方式求出来。</p>
<p>除了上述的LUT的方式还有神经网络的方式，因为其实输入就是一个矩阵，输出也是一个矩阵，那么中间通过网络连接，然后通过数据训练也能得到一个转换的网络参数。</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm45.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm45.png" >
  
    </a>
  
  
</div>

<h1 id="3算法代码实现">3算法代码实现</h1>
<p>这里参考QiuJueqin的CCM实现，添加CCM算法，可框选24色卡,，具体<a href="https://github.com/YangYang48/ISPAlgorithm/tree/master/CCM/color-correction-toolbox">点击这里</a></p>
<h2 id="31demo1">3.1demo1</h2>
<p>这个demo1主要是140个色块的CCM校正</p>
<div class="highlight"><pre class="chroma"><code class="language-matlab" data-lang="matlab"><span class="ln">  1</span><span class="n">clear</span><span class="p">;</span> <span class="n">close</span> <span class="n">all</span><span class="p">;</span> <span class="n">clc</span><span class="p">;</span>
<span class="ln">  2</span>
<span class="ln">  3</span><span class="c">%% data preparation</span>
<span class="ln">  4</span>
<span class="ln">  5</span><span class="c">% load DSG color checker&#39;s spectral reflectance data</span>
<span class="ln">  6</span><span class="c">% 加载光谱反射数据</span>
<span class="ln">  7</span><span class="n">load</span><span class="p">(</span><span class="s">&#39;spectral_reflectance_data.mat&#39;</span><span class="p">);</span>
<span class="ln">  8</span><span class="n">spectra</span> <span class="p">=</span> <span class="n">spectral_reflectance_data</span><span class="p">.</span><span class="n">XRite_DSG</span><span class="p">;</span>
<span class="ln">  9</span>
<span class="ln"> 10</span><span class="c">% calculate the XYZ values for the color checker under D65</span>
<span class="ln"> 11</span><span class="c">%这里计算出来的是目标的XYZ颜色空间</span>
<span class="ln"> 12</span><span class="n">XYZ</span> <span class="p">=</span> <span class="n">spectra2colors</span><span class="p">(</span><span class="n">spectra</span><span class="p">,</span> <span class="mi">400</span><span class="p">:</span><span class="mi">5</span><span class="p">:</span><span class="mi">700</span><span class="p">,</span><span class="c">...</span>
<span class="ln"> 13</span>                     <span class="s">&#39;spd&#39;</span><span class="p">,</span> <span class="s">&#39;D65&#39;</span><span class="p">);</span>
<span class="ln"> 14</span>
<span class="ln"> 15</span><span class="c">% split the left half as training samples and the right half as validation</span>
<span class="ln"> 16</span><span class="c">%将左半部分作为训练样本，右半部分作为验证样本</span>
<span class="ln"> 17</span><span class="n">XYZ</span> <span class="p">=</span> <span class="nb">reshape</span><span class="p">(</span><span class="n">XYZ</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="ln"> 18</span><span class="n">XYZ_train</span> <span class="p">=</span> <span class="nb">reshape</span><span class="p">(</span><span class="n">XYZ</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:),</span> <span class="p">[],</span> <span class="mi">3</span><span class="p">);</span>
<span class="ln"> 19</span><span class="n">XYZ_val</span> <span class="p">=</span> <span class="nb">reshape</span><span class="p">(</span><span class="n">XYZ</span><span class="p">(</span><span class="mi">8</span><span class="p">:</span><span class="mi">14</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:),</span> <span class="p">[],</span> <span class="mi">3</span><span class="p">);</span>
<span class="ln"> 20</span>
<span class="ln"> 21</span><span class="c">% visualize the target colors</span>
<span class="ln"> 22</span><span class="n">figureFullScreen</span><span class="p">(</span><span class="s">&#39;color&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">);</span>
<span class="ln"> 23</span><span class="n">ax1</span> <span class="p">=</span> <span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="ln"> 24</span><span class="c">%把点变成像色卡一样的块状填充到画面上，形成拟合出来的色卡</span>
<span class="ln"> 25</span><span class="n">colors2checker</span><span class="p">(</span><span class="n">xyz2rgb</span><span class="p">(</span><span class="n">XYZ_train</span><span class="p">),</span><span class="c">...</span>
<span class="ln"> 26</span>               <span class="s">&#39;layout&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span><span class="c">...</span>
<span class="ln"> 27</span>               <span class="s">&#39;squaresize&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span><span class="c">...</span>
<span class="ln"> 28</span>               <span class="s">&#39;parent&#39;</span><span class="p">,</span> <span class="n">ax1</span><span class="p">);</span>
<span class="ln"> 29</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Training samples (target sRGB)&#39;</span><span class="p">);</span>
<span class="ln"> 30</span>           
<span class="ln"> 31</span><span class="n">ax2</span> <span class="p">=</span> <span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
<span class="ln"> 32</span><span class="n">colors2checker</span><span class="p">(</span><span class="n">xyz2rgb</span><span class="p">(</span><span class="n">XYZ_val</span><span class="p">),</span><span class="c">...</span>
<span class="ln"> 33</span>               <span class="s">&#39;layout&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span><span class="c">...</span>
<span class="ln"> 34</span>               <span class="s">&#39;squaresize&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span><span class="c">...</span>
<span class="ln"> 35</span>               <span class="s">&#39;parent&#39;</span><span class="p">,</span> <span class="n">ax2</span><span class="p">);</span>
<span class="ln"> 36</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Validation samples (target sRGB)&#39;</span><span class="p">);</span>
<span class="ln"> 37</span>
<span class="ln"> 38</span><span class="c">% read color checker image and extract color responses</span>
<span class="ln"> 39</span><span class="c">% the darkness level and the spatial non-uniformity has been corrected for</span>
<span class="ln"> 40</span><span class="c">% this image</span>
<span class="ln"> 41</span><span class="c">%真实sensor显示的RGB</span>
<span class="ln"> 42</span><span class="n">dsg_img</span> <span class="p">=</span> <span class="n">imread</span><span class="p">(</span><span class="s">&#39;dsg_Nikon_D3x.tiff&#39;</span><span class="p">);</span>
<span class="ln"> 43</span>
<span class="ln"> 44</span><span class="c">% you can also manually select roi for the color checker</span>
<span class="ln"> 45</span><span class="c">%选择的区域，也可以手动选择ROI区域</span>
<span class="ln"> 46</span><span class="n">roi</span> <span class="p">=</span> <span class="p">[</span><span class="mi">519</span><span class="p">,</span><span class="mi">310</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">669</span><span class="p">,</span><span class="mi">309</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">819</span><span class="p">,</span><span class="mi">308</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">969</span><span class="p">,</span><span class="mi">307</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1120</span><span class="p">,</span><span class="mi">306</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1270</span><span class="p">,</span><span class="mi">306</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1421</span><span class="p">,</span><span class="mi">305</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1572</span><span class="p">,</span><span class="mi">304</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1722</span><span class="p">,</span><span class="mi">303</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1873</span><span class="p">,</span><span class="mi">302</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2025</span><span class="p">,</span><span class="mi">301</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2176</span><span class="p">,</span><span class="mi">300</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2327</span><span class="p">,</span><span class="mi">299</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2479</span><span class="p">,</span><span class="mi">299</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">519</span><span class="p">,</span><span class="mi">460</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">669</span><span class="p">,</span><span class="mi">459</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">819</span><span class="p">,</span><span class="mi">458</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">970</span><span class="p">,</span><span class="mi">457</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1120</span><span class="p">,</span><span class="mi">456</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1271</span><span class="p">,</span><span class="mi">456</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1421</span><span class="p">,</span><span class="mi">455</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1572</span><span class="p">,</span><span class="mi">454</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1723</span><span class="p">,</span><span class="mi">453</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1874</span><span class="p">,</span><span class="mi">452</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2025</span><span class="p">,</span><span class="mi">452</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2176</span><span class="p">,</span><span class="mi">451</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2328</span><span class="p">,</span><span class="mi">450</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2479</span><span class="p">,</span><span class="mi">449</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">519</span><span class="p">,</span><span class="mi">650</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">669</span><span class="p">,</span><span class="mi">609</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">820</span><span class="p">,</span><span class="mi">608</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">970</span><span class="p">,</span><span class="mi">607</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1120</span><span class="p">,</span><span class="mi">607</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1271</span><span class="p">,</span><span class="mi">606</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1422</span><span class="p">,</span><span class="mi">605</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1572</span><span class="p">,</span><span class="mi">604</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1723</span><span class="p">,</span><span class="mi">604</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1874</span><span class="p">,</span><span class="mi">603</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2026</span><span class="p">,</span><span class="mi">602</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2177</span><span class="p">,</span><span class="mi">601</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2328</span><span class="p">,</span><span class="mi">601</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2480</span><span class="p">,</span><span class="mi">600</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">520</span><span class="p">,</span><span class="mi">760</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">670</span><span class="p">,</span><span class="mi">759</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">820</span><span class="p">,</span><span class="mi">758</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">970</span><span class="p">,</span><span class="mi">758</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1121</span><span class="p">,</span><span class="mi">757</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1271</span><span class="p">,</span><span class="mi">756</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1422</span><span class="p">,</span><span class="mi">755</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1573</span><span class="p">,</span><span class="mi">755</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1724</span><span class="p">,</span><span class="mi">754</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1875</span><span class="p">,</span><span class="mi">753</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2026</span><span class="p">,</span><span class="mi">753</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2177</span><span class="p">,</span><span class="mi">752</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2329</span><span class="p">,</span><span class="mi">751</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2480</span><span class="p">,</span><span class="mi">751</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">520</span><span class="p">,</span><span class="mi">910</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">670</span><span class="p">,</span><span class="mi">909</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">820</span><span class="p">,</span><span class="mi">908</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">971</span><span class="p">,</span><span class="mi">908</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1121</span><span class="p">,</span><span class="mi">907</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1272</span><span class="p">,</span><span class="mi">907</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1422</span><span class="p">,</span><span class="mi">906</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1573</span><span class="p">,</span><span class="mi">905</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1724</span><span class="p">,</span><span class="mi">905</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1875</span><span class="p">,</span><span class="mi">904</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2027</span><span class="p">,</span><span class="mi">903</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2178</span><span class="p">,</span><span class="mi">903</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2329</span><span class="p">,</span><span class="mi">902</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2481</span><span class="p">,</span><span class="mi">901</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">520</span><span class="p">,</span><span class="mi">1060</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">670</span><span class="p">,</span><span class="mi">1059</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">820</span><span class="p">,</span><span class="mi">1059</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">971</span><span class="p">,</span><span class="mi">1058</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1121</span><span class="p">,</span><span class="mi">1057</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1272</span><span class="p">,</span><span class="mi">1057</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1423</span><span class="p">,</span><span class="mi">1056</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1574</span><span class="p">,</span><span class="mi">1056</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1725</span><span class="p">,</span><span class="mi">1055</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1876</span><span class="p">,</span><span class="mi">1055</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2027</span><span class="p">,</span><span class="mi">1054</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2179</span><span class="p">,</span><span class="mi">1053</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2330</span><span class="p">,</span><span class="mi">1053</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2482</span><span class="p">,</span><span class="mi">1052</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">520</span><span class="p">,</span><span class="mi">1210</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">670</span><span class="p">,</span><span class="mi">1209</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">821</span><span class="p">,</span><span class="mi">1209</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">971</span><span class="p">,</span><span class="mi">1208</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1122</span><span class="p">,</span><span class="mi">1208</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1272</span><span class="p">,</span><span class="mi">1207</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1423</span><span class="p">,</span><span class="mi">1207</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1574</span><span class="p">,</span><span class="mi">1206</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1725</span><span class="p">,</span><span class="mi">1206</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1876</span><span class="p">,</span><span class="mi">1205</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2028</span><span class="p">,</span><span class="mi">1205</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2179</span><span class="p">,</span><span class="mi">1204</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2331</span><span class="p">,</span><span class="mi">1204</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2482</span><span class="p">,</span><span class="mi">1203</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">520</span><span class="p">,</span><span class="mi">1360</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">671</span><span class="p">,</span><span class="mi">1360</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">821</span><span class="p">,</span><span class="mi">1359</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">972</span><span class="p">,</span><span class="mi">1359</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1122</span><span class="p">,</span><span class="mi">1358</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1273</span><span class="p">,</span><span class="mi">1358</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1424</span><span class="p">,</span><span class="mi">1357</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1575</span><span class="p">,</span><span class="mi">1357</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1726</span><span class="p">,</span><span class="mi">1357</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1877</span><span class="p">,</span><span class="mi">1356</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2028</span><span class="p">,</span><span class="mi">1356</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2180</span><span class="p">,</span><span class="mi">1355</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2331</span><span class="p">,</span><span class="mi">1355</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2483</span><span class="p">,</span><span class="mi">1354</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">521</span><span class="p">,</span><span class="mi">1510</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">671</span><span class="p">,</span><span class="mi">1510</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">821</span><span class="p">,</span><span class="mi">1510</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">972</span><span class="p">,</span><span class="mi">1509</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1122</span><span class="p">,</span><span class="mi">1509</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1273</span><span class="p">,</span><span class="mi">1508</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1424</span><span class="p">,</span><span class="mi">1508</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1575</span><span class="p">,</span><span class="mi">1508</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1726</span><span class="p">,</span><span class="mi">1507</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1877</span><span class="p">,</span><span class="mi">1507</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2029</span><span class="p">,</span><span class="mi">1507</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2180</span><span class="p">,</span><span class="mi">1506</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2332</span><span class="p">,</span><span class="mi">1506</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2484</span><span class="p">,</span><span class="mi">1505</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">521</span><span class="p">,</span><span class="mi">1661</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">671</span><span class="p">,</span><span class="mi">1660</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">822</span><span class="p">,</span><span class="mi">1660</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">972</span><span class="p">,</span><span class="mi">1660</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1123</span><span class="p">,</span><span class="mi">1659</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1274</span><span class="p">,</span><span class="mi">1659</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1424</span><span class="p">,</span><span class="mi">1659</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1576</span><span class="p">,</span><span class="mi">1658</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1727</span><span class="p">,</span><span class="mi">1658</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1878</span><span class="p">,</span><span class="mi">1658</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2029</span><span class="p">,</span><span class="mi">1657</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2181</span><span class="p">,</span><span class="mi">1657</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2332</span><span class="p">,</span><span class="mi">1657</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2484</span><span class="p">,</span><span class="mi">1656</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">];</span>
<span class="ln"> 47</span><span class="c">%计算选择的140个色块区域平均的RGB值</span>
<span class="ln"> 48</span><span class="n">RGB</span> <span class="p">=</span> <span class="n">checker2colors</span><span class="p">(</span><span class="n">dsg_img</span><span class="p">,</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">14</span><span class="p">],</span><span class="c">...</span>
<span class="ln"> 49</span>                     <span class="s">&#39;roi&#39;</span><span class="p">,</span> <span class="n">roi</span><span class="p">,</span><span class="c">...</span>
<span class="ln"> 50</span>                     <span class="s">&#39;scale&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span> <span class="c">% scaling only for better visualization</span>
<span class="ln"> 51</span>
<span class="ln"> 52</span><span class="c">% split the left half as training samples and the right half as validation</span>
<span class="ln"> 53</span><span class="c">%跟上述类似，一半训练，一半验证</span>
<span class="ln"> 54</span><span class="n">RGB</span> <span class="p">=</span> <span class="nb">reshape</span><span class="p">(</span><span class="n">RGB</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="ln"> 55</span><span class="n">RGB_train</span> <span class="p">=</span> <span class="nb">reshape</span><span class="p">(</span><span class="n">RGB</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:),</span> <span class="p">[],</span> <span class="mi">3</span><span class="p">);</span>
<span class="ln"> 56</span><span class="n">RGB_val</span> <span class="p">=</span> <span class="nb">reshape</span><span class="p">(</span><span class="n">RGB</span><span class="p">(</span><span class="mi">8</span><span class="p">:</span><span class="mi">14</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:),</span> <span class="p">[],</span> <span class="mi">3</span><span class="p">);</span>
<span class="ln"> 57</span>
<span class="ln"> 58</span><span class="c">% visualize the camera colors</span>
<span class="ln"> 59</span><span class="n">figureFullScreen</span><span class="p">(</span><span class="s">&#39;color&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">);</span>
<span class="ln"> 60</span><span class="n">ax1</span> <span class="p">=</span> <span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="ln"> 61</span>
<span class="ln"> 62</span><span class="n">colors2checker</span><span class="p">(</span><span class="n">RGB_train</span><span class="p">,</span><span class="c">...</span>
<span class="ln"> 63</span>               <span class="s">&#39;layout&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span><span class="c">...</span>
<span class="ln"> 64</span>               <span class="s">&#39;squaresize&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span><span class="c">...</span>
<span class="ln"> 65</span>               <span class="s">&#39;parent&#39;</span><span class="p">,</span> <span class="n">ax1</span><span class="p">);</span>
<span class="ln"> 66</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Training samples (camera RGB, w/o gamma)&#39;</span><span class="p">);</span>
<span class="ln"> 67</span>
<span class="ln"> 68</span><span class="n">ax2</span> <span class="p">=</span> <span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
<span class="ln"> 69</span><span class="n">colors2checker</span><span class="p">(</span><span class="n">RGB_val</span><span class="p">,</span><span class="c">...</span>
<span class="ln"> 70</span>               <span class="s">&#39;layout&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span><span class="c">...</span>
<span class="ln"> 71</span>               <span class="s">&#39;squaresize&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span><span class="c">...</span>
<span class="ln"> 72</span>               <span class="s">&#39;parent&#39;</span><span class="p">,</span> <span class="n">ax2</span><span class="p">);</span>
<span class="ln"> 73</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Validation samples (camera RGB, w/o gamma)&#39;</span><span class="p">);</span>
<span class="ln"> 74</span>
<span class="ln"> 75</span><span class="n">clearvars</span> <span class="o">-</span><span class="n">except</span> <span class="n">XYZ_train</span> <span class="n">XYZ_val</span> <span class="n">RGB_train</span> <span class="n">RGB_val</span>
<span class="ln"> 76</span>
<span class="ln"> 77</span><span class="c">%% color correction</span>
<span class="ln"> 78</span>
<span class="ln"> 79</span><span class="c">% training</span>
<span class="ln"> 80</span><span class="c">%可以定义3x3模型，也可以定义其他模型，这里是6x3模型</span>
<span class="ln"> 81</span><span class="n">model</span> <span class="p">=</span> <span class="s">&#39;root6x3&#39;</span><span class="p">;</span> <span class="c">% color correction model</span>
<span class="ln"> 82</span><span class="c">%根据光谱特性，sRGB转换到了XYZ颜色空间</span>
<span class="ln"> 83</span><span class="n">targetcolorspace</span> <span class="p">=</span> <span class="s">&#39;XYZ&#39;</span><span class="p">;</span>
<span class="ln"> 84</span><span class="c">%这里用到的计算方式是CIE △E2000的方式求解</span>
<span class="ln"> 85</span><span class="c">% OPTIONAL PARAMETERS:</span>
<span class="ln"> 86</span><span class="c">% loss:              loss function to be minimized.</span>
<span class="ln"> 87</span><span class="c">%                    &#39;mse&#39; | &#39;ciede00&#39; (default) | &#39;ciede94&#39; |</span>
<span class="ln"> 88</span><span class="c">%                    &#39;ciedelab&#39; | &#39;cmcde&#39;</span>
<span class="ln"> 89</span><span class="c">% model:             color correction model, based on which the camera</span>
<span class="ln"> 90</span><span class="c">%                    responses will be expanded.</span>
<span class="ln"> 91</span><span class="c">%                    &#39;linear3x3&#39; (default) | &#39;root6x3&#39; | &#39;root13x3&#39; |</span>
<span class="ln"> 92</span><span class="c">%                    &#39;poly4x3&#39; | &#39;poly6x3&#39; | &#39;poly7x3&#39; | &#39;poly9x3&#39;</span>
<span class="ln"> 93</span><span class="n">metrics</span> <span class="p">=</span> <span class="p">{</span><span class="s">&#39;mse&#39;</span><span class="p">,</span> <span class="s">&#39;ciede00&#39;</span><span class="p">,</span> <span class="s">&#39;ciedelab&#39;</span><span class="p">};</span> <span class="c">% only for evaluation</span>
<span class="ln"> 94</span>
<span class="ln"> 95</span><span class="c">% default loss function: ciede00</span>
<span class="ln"> 96</span><span class="c">% if RGB_train has been white-balanced, consider using &#39;preservewhite&#39; and</span>
<span class="ln"> 97</span><span class="c">% &#39;whitepoint&#39; parameters.</span>
<span class="ln"> 98</span><span class="p">[</span><span class="n">matrix</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">XYZ_train_pred</span><span class="p">,</span> <span class="n">errs_train</span><span class="p">]</span> <span class="p">=</span> <span class="n">ccmtrain</span><span class="p">(</span><span class="n">RGB_train</span><span class="p">,</span><span class="c">...</span>
<span class="ln"> 99</span>                                                       <span class="n">XYZ_train</span><span class="p">,</span><span class="c">...</span>
<span class="ln">100</span>                                                       <span class="s">&#39;model&#39;</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span><span class="c">...</span>
<span class="ln">101</span>                                                       <span class="s">&#39;bias&#39;</span><span class="p">,</span> <span class="n">true</span><span class="p">,</span><span class="c">...</span>
<span class="ln">102</span>                                                       <span class="s">&#39;targetcolorspace&#39;</span><span class="p">,</span> <span class="n">targetcolorspace</span><span class="p">,</span><span class="c">...</span>
<span class="ln">103</span>                                                       <span class="s">&#39;metric&#39;</span><span class="p">,</span> <span class="n">metrics</span><span class="p">);</span>
<span class="ln">104</span><span class="c">% validation</span>
<span class="ln">105</span><span class="p">[</span><span class="n">XYZ_val_pred</span><span class="p">,</span> <span class="n">errs_val</span><span class="p">]</span> <span class="p">=</span> <span class="n">ccmvalidate</span><span class="p">(</span><span class="n">RGB_val</span><span class="p">,</span><span class="c">...</span>
<span class="ln">106</span>                                       <span class="n">XYZ_val</span><span class="p">,</span><span class="c">...</span>
<span class="ln">107</span>                                       <span class="n">model</span><span class="p">,</span><span class="c">...</span>
<span class="ln">108</span>                                       <span class="n">matrix</span><span class="p">,</span><span class="c">...</span>
<span class="ln">109</span>                                       <span class="n">scale</span><span class="p">,</span><span class="c">...</span>
<span class="ln">110</span>                                       <span class="s">&#39;targetcolorspace&#39;</span><span class="p">,</span> <span class="n">targetcolorspace</span><span class="p">,</span><span class="c">...</span>
<span class="ln">111</span>                                       <span class="s">&#39;metric&#39;</span><span class="p">,</span> <span class="n">metrics</span><span class="p">);</span>
<span class="ln">112</span><span class="c">% visualize final results</span>
<span class="ln">113</span><span class="n">figureFullScreen</span><span class="p">(</span><span class="s">&#39;color&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">);</span>
<span class="ln">114</span><span class="n">ax1</span> <span class="p">=</span> <span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="ln">115</span><span class="n">colors2checker</span><span class="p">({</span><span class="n">xyz2rgb</span><span class="p">(</span><span class="n">XYZ_train</span><span class="p">),</span> <span class="n">xyz2rgb</span><span class="p">(</span><span class="n">XYZ_train_pred</span><span class="p">)},</span><span class="c">...</span>
<span class="ln">116</span>               <span class="s">&#39;layout&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span><span class="c">...</span>
<span class="ln">117</span>               <span class="s">&#39;squaresize&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span><span class="c">...</span>
<span class="ln">118</span>               <span class="s">&#39;legend&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;Ground-truth&#39;</span><span class="p">,</span> <span class="s">&#39;Predicted&#39;</span><span class="p">},</span><span class="c">...</span>
<span class="ln">119</span>               <span class="s">&#39;parent&#39;</span><span class="p">,</span> <span class="n">ax1</span><span class="p">);</span>
<span class="ln">120</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Training samples comparison&#39;</span><span class="p">);</span>
<span class="ln">121</span>
<span class="ln">122</span><span class="n">ax2</span> <span class="p">=</span> <span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
<span class="ln">123</span><span class="n">colors2checker</span><span class="p">({</span><span class="n">xyz2rgb</span><span class="p">(</span><span class="n">XYZ_val</span><span class="p">),</span> <span class="n">xyz2rgb</span><span class="p">(</span><span class="n">XYZ_val_pred</span><span class="p">)},</span><span class="c">...</span>
<span class="ln">124</span>               <span class="s">&#39;layout&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span><span class="c">...</span>
<span class="ln">125</span>               <span class="s">&#39;squaresize&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span><span class="c">...</span>
<span class="ln">126</span>               <span class="s">&#39;legend&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;Ground-truth&#39;</span><span class="p">,</span> <span class="s">&#39;Predicted&#39;</span><span class="p">},</span><span class="c">...</span>
<span class="ln">127</span>               <span class="s">&#39;parent&#39;</span><span class="p">,</span> <span class="n">ax2</span><span class="p">);</span>
<span class="ln">128</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Validation samples comparison&#39;</span><span class="p">);</span>
</code></pre></div><p>框选的区域是DIGITAL SG的卡，有140个色块</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm48.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm48.png" >
  
    </a>
  
  
</div>

<p>140分成两部分，其中70为训练集，另外70个为实际结果的验证</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm49.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/camera/algorithmlearning/ccm/ccm49.png" >
  
    </a>
  
  
</div>

<h2 id="32demo2">3.2demo2</h2>
<p>跟demo1区别，加了白点的保持</p>
<div class="highlight"><pre class="chroma"><code class="language-matlab" data-lang="matlab"><span class="ln"> 1</span><span class="n">clear</span><span class="p">;</span> <span class="n">close</span> <span class="n">all</span><span class="p">;</span> <span class="n">clc</span><span class="p">;</span>
<span class="ln"> 2</span>
<span class="ln"> 3</span><span class="c">%% data preparation</span>
<span class="ln"> 4</span>
<span class="ln"> 5</span><span class="c">% load DSG color checker&#39;s spectral reflectance data</span>
<span class="ln"> 6</span><span class="n">load</span><span class="p">(</span><span class="s">&#39;spectral_reflectance_data.mat&#39;</span><span class="p">);</span>
<span class="ln"> 7</span><span class="n">spectra</span> <span class="p">=</span> <span class="n">spectral_reflectance_data</span><span class="p">.</span><span class="n">XRite_DSG</span><span class="p">;</span>
<span class="ln"> 8</span>
<span class="ln"> 9</span><span class="c">% calculate the XYZ values for the color checker under D65</span>
<span class="ln">10</span><span class="n">XYZ</span> <span class="p">=</span> <span class="n">spectra2colors</span><span class="p">(</span><span class="n">spectra</span><span class="p">,</span> <span class="mi">400</span><span class="p">:</span><span class="mi">5</span><span class="p">:</span><span class="mi">700</span><span class="p">,</span><span class="c">...</span>
<span class="ln">11</span>                     <span class="s">&#39;spd&#39;</span><span class="p">,</span> <span class="s">&#39;D65&#39;</span><span class="p">);</span>
<span class="ln">12</span>
<span class="ln">13</span><span class="c">% read color checker image and extract color responses</span>
<span class="ln">14</span><span class="c">% the darkness level and the spatial non-uniformity has been corrected for</span>
<span class="ln">15</span><span class="c">% this image</span>
<span class="ln">16</span><span class="n">dsg_img</span> <span class="p">=</span> <span class="n">imread</span><span class="p">(</span><span class="s">&#39;dsg_Nikon_D3x.tiff&#39;</span><span class="p">);</span>
<span class="ln">17</span>
<span class="ln">18</span><span class="c">% you can also manually select roi for the color checker</span>
<span class="ln">19</span><span class="n">roi</span> <span class="p">=</span> <span class="p">[</span><span class="mi">519</span><span class="p">,</span><span class="mi">310</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">669</span><span class="p">,</span><span class="mi">309</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">819</span><span class="p">,</span><span class="mi">308</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">969</span><span class="p">,</span><span class="mi">307</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1120</span><span class="p">,</span><span class="mi">306</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1270</span><span class="p">,</span><span class="mi">306</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1421</span><span class="p">,</span><span class="mi">305</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1572</span><span class="p">,</span><span class="mi">304</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1722</span><span class="p">,</span><span class="mi">303</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1873</span><span class="p">,</span><span class="mi">302</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2025</span><span class="p">,</span><span class="mi">301</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2176</span><span class="p">,</span><span class="mi">300</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2327</span><span class="p">,</span><span class="mi">299</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2479</span><span class="p">,</span><span class="mi">299</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">519</span><span class="p">,</span><span class="mi">460</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">669</span><span class="p">,</span><span class="mi">459</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">819</span><span class="p">,</span><span class="mi">458</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">970</span><span class="p">,</span><span class="mi">457</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1120</span><span class="p">,</span><span class="mi">456</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1271</span><span class="p">,</span><span class="mi">456</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1421</span><span class="p">,</span><span class="mi">455</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1572</span><span class="p">,</span><span class="mi">454</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1723</span><span class="p">,</span><span class="mi">453</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1874</span><span class="p">,</span><span class="mi">452</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2025</span><span class="p">,</span><span class="mi">452</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2176</span><span class="p">,</span><span class="mi">451</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2328</span><span class="p">,</span><span class="mi">450</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2479</span><span class="p">,</span><span class="mi">449</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">519</span><span class="p">,</span><span class="mi">650</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">669</span><span class="p">,</span><span class="mi">609</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">820</span><span class="p">,</span><span class="mi">608</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">970</span><span class="p">,</span><span class="mi">607</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1120</span><span class="p">,</span><span class="mi">607</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1271</span><span class="p">,</span><span class="mi">606</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1422</span><span class="p">,</span><span class="mi">605</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1572</span><span class="p">,</span><span class="mi">604</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1723</span><span class="p">,</span><span class="mi">604</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1874</span><span class="p">,</span><span class="mi">603</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2026</span><span class="p">,</span><span class="mi">602</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2177</span><span class="p">,</span><span class="mi">601</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2328</span><span class="p">,</span><span class="mi">601</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2480</span><span class="p">,</span><span class="mi">600</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">520</span><span class="p">,</span><span class="mi">760</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">670</span><span class="p">,</span><span class="mi">759</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">820</span><span class="p">,</span><span class="mi">758</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">970</span><span class="p">,</span><span class="mi">758</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1121</span><span class="p">,</span><span class="mi">757</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1271</span><span class="p">,</span><span class="mi">756</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1422</span><span class="p">,</span><span class="mi">755</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1573</span><span class="p">,</span><span class="mi">755</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1724</span><span class="p">,</span><span class="mi">754</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1875</span><span class="p">,</span><span class="mi">753</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2026</span><span class="p">,</span><span class="mi">753</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2177</span><span class="p">,</span><span class="mi">752</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2329</span><span class="p">,</span><span class="mi">751</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2480</span><span class="p">,</span><span class="mi">751</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">520</span><span class="p">,</span><span class="mi">910</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">670</span><span class="p">,</span><span class="mi">909</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">820</span><span class="p">,</span><span class="mi">908</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">971</span><span class="p">,</span><span class="mi">908</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1121</span><span class="p">,</span><span class="mi">907</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1272</span><span class="p">,</span><span class="mi">907</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1422</span><span class="p">,</span><span class="mi">906</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1573</span><span class="p">,</span><span class="mi">905</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1724</span><span class="p">,</span><span class="mi">905</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1875</span><span class="p">,</span><span class="mi">904</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2027</span><span class="p">,</span><span class="mi">903</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2178</span><span class="p">,</span><span class="mi">903</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2329</span><span class="p">,</span><span class="mi">902</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2481</span><span class="p">,</span><span class="mi">901</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">520</span><span class="p">,</span><span class="mi">1060</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">670</span><span class="p">,</span><span class="mi">1059</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">820</span><span class="p">,</span><span class="mi">1059</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">971</span><span class="p">,</span><span class="mi">1058</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1121</span><span class="p">,</span><span class="mi">1057</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1272</span><span class="p">,</span><span class="mi">1057</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1423</span><span class="p">,</span><span class="mi">1056</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1574</span><span class="p">,</span><span class="mi">1056</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1725</span><span class="p">,</span><span class="mi">1055</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1876</span><span class="p">,</span><span class="mi">1055</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2027</span><span class="p">,</span><span class="mi">1054</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2179</span><span class="p">,</span><span class="mi">1053</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2330</span><span class="p">,</span><span class="mi">1053</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2482</span><span class="p">,</span><span class="mi">1052</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">520</span><span class="p">,</span><span class="mi">1210</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">670</span><span class="p">,</span><span class="mi">1209</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">821</span><span class="p">,</span><span class="mi">1209</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">971</span><span class="p">,</span><span class="mi">1208</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1122</span><span class="p">,</span><span class="mi">1208</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1272</span><span class="p">,</span><span class="mi">1207</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1423</span><span class="p">,</span><span class="mi">1207</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1574</span><span class="p">,</span><span class="mi">1206</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1725</span><span class="p">,</span><span class="mi">1206</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1876</span><span class="p">,</span><span class="mi">1205</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2028</span><span class="p">,</span><span class="mi">1205</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2179</span><span class="p">,</span><span class="mi">1204</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2331</span><span class="p">,</span><span class="mi">1204</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2482</span><span class="p">,</span><span class="mi">1203</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">520</span><span class="p">,</span><span class="mi">1360</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">671</span><span class="p">,</span><span class="mi">1360</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">821</span><span class="p">,</span><span class="mi">1359</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">972</span><span class="p">,</span><span class="mi">1359</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1122</span><span class="p">,</span><span class="mi">1358</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1273</span><span class="p">,</span><span class="mi">1358</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1424</span><span class="p">,</span><span class="mi">1357</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1575</span><span class="p">,</span><span class="mi">1357</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1726</span><span class="p">,</span><span class="mi">1357</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1877</span><span class="p">,</span><span class="mi">1356</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2028</span><span class="p">,</span><span class="mi">1356</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2180</span><span class="p">,</span><span class="mi">1355</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2331</span><span class="p">,</span><span class="mi">1355</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2483</span><span class="p">,</span><span class="mi">1354</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">521</span><span class="p">,</span><span class="mi">1510</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">671</span><span class="p">,</span><span class="mi">1510</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">821</span><span class="p">,</span><span class="mi">1510</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">972</span><span class="p">,</span><span class="mi">1509</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1122</span><span class="p">,</span><span class="mi">1509</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1273</span><span class="p">,</span><span class="mi">1508</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1424</span><span class="p">,</span><span class="mi">1508</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1575</span><span class="p">,</span><span class="mi">1508</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1726</span><span class="p">,</span><span class="mi">1507</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1877</span><span class="p">,</span><span class="mi">1507</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2029</span><span class="p">,</span><span class="mi">1507</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2180</span><span class="p">,</span><span class="mi">1506</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2332</span><span class="p">,</span><span class="mi">1506</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2484</span><span class="p">,</span><span class="mi">1505</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">521</span><span class="p">,</span><span class="mi">1661</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">671</span><span class="p">,</span><span class="mi">1660</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">822</span><span class="p">,</span><span class="mi">1660</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">972</span><span class="p">,</span><span class="mi">1660</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1123</span><span class="p">,</span><span class="mi">1659</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1274</span><span class="p">,</span><span class="mi">1659</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1424</span><span class="p">,</span><span class="mi">1659</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1576</span><span class="p">,</span><span class="mi">1658</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1727</span><span class="p">,</span><span class="mi">1658</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">1878</span><span class="p">,</span><span class="mi">1658</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2029</span><span class="p">,</span><span class="mi">1657</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2181</span><span class="p">,</span><span class="mi">1657</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2332</span><span class="p">,</span><span class="mi">1657</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">;</span><span class="mi">2484</span><span class="p">,</span><span class="mi">1656</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">65</span><span class="p">];</span>
<span class="ln">20</span><span class="n">RGB</span> <span class="p">=</span> <span class="n">checker2colors</span><span class="p">(</span><span class="n">dsg_img</span><span class="p">,</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">14</span><span class="p">],</span><span class="c">...</span>
<span class="ln">21</span>                     <span class="s">&#39;roi&#39;</span><span class="p">,</span> <span class="n">roi</span><span class="p">,</span><span class="c">...</span>
<span class="ln">22</span>                     <span class="s">&#39;show&#39;</span><span class="p">,</span> <span class="n">false</span><span class="p">,</span><span class="c">...</span>
<span class="ln">23</span>                     <span class="s">&#39;scale&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span> <span class="c">% scaling only for better visualization</span>
<span class="ln">24</span>
<span class="ln">25</span><span class="n">clearvars</span> <span class="o">-</span><span class="n">except</span> <span class="n">XYZ</span> <span class="n">RGB</span>
<span class="ln">26</span>
<span class="ln">27</span>
<span class="ln">28</span><span class="c">%% color correction with white point preserved</span>
<span class="ln">29</span>
<span class="ln">30</span><span class="c">% white balancing RGB values</span>
<span class="ln">31</span><span class="c">%增加了白平衡RGB值</span>
<span class="ln">32</span><span class="n">neutral_patches_idx</span> <span class="p">=</span> <span class="p">[</span><span class="mi">61</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">65</span><span class="p">];</span>
<span class="ln">33</span><span class="n">gains</span> <span class="p">=</span> <span class="p">[</span><span class="n">RGB</span><span class="p">(</span><span class="n">neutral_patches_idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">\</span> <span class="n">RGB</span><span class="p">(</span><span class="n">neutral_patches_idx</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span><span class="c">...</span>
<span class="ln">34</span>         <span class="mi">1</span><span class="p">,</span><span class="c">...</span>
<span class="ln">35</span>         <span class="n">RGB</span><span class="p">(</span><span class="n">neutral_patches_idx</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">\</span> <span class="n">RGB</span><span class="p">(</span><span class="n">neutral_patches_idx</span><span class="p">,</span> <span class="mi">2</span><span class="p">)];</span>
<span class="ln">36</span>     
<span class="ln">37</span><span class="n">RGB_wb</span> <span class="p">=</span> <span class="n">RGB</span> <span class="o">.*</span> <span class="n">gains</span><span class="p">;</span>
<span class="ln">38</span>
<span class="ln">39</span><span class="c">% use D65&#39;s XYZ value as white point to be preserved after color correction</span>
<span class="ln">40</span><span class="n">white_point</span> <span class="p">=</span> <span class="n">whitepoint</span><span class="p">(</span><span class="s">&#39;d65&#39;</span><span class="p">);</span>
<span class="ln">41</span>
<span class="ln">42</span><span class="c">% training</span>
<span class="ln">43</span><span class="n">model</span> <span class="p">=</span> <span class="s">&#39;root6x3&#39;</span><span class="p">;</span>
<span class="ln">44</span><span class="p">[</span><span class="n">matrix</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">XYZ_pred</span><span class="p">,</span> <span class="n">errs_train</span><span class="p">]</span> <span class="p">=</span> <span class="n">ccmtrain</span><span class="p">(</span><span class="n">RGB_wb</span><span class="p">,</span><span class="c">...</span>
<span class="ln">45</span>                                                 <span class="n">XYZ</span><span class="p">,</span><span class="c">...</span>
<span class="ln">46</span>                                                 <span class="s">&#39;model&#39;</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span><span class="c">...</span>
<span class="ln">47</span>                                                 <span class="s">&#39;targetcolorspace&#39;</span><span class="p">,</span> <span class="s">&#39;xyz&#39;</span><span class="p">,</span><span class="c">...</span>
<span class="ln">48</span>                                                 <span class="s">&#39;whitepoint&#39;</span><span class="p">,</span> <span class="n">white_point</span><span class="p">);</span>
<span class="ln">49</span>
<span class="ln">50</span><span class="c">% check if [1, 1, 1] has been preserved as [0.9505, 1.0000, 1.0888]</span>
<span class="ln">51</span><span class="n">predicted_white_point</span> <span class="p">=</span> <span class="n">ccmapply</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span><span class="c">...</span>
<span class="ln">52</span>                                 <span class="n">model</span><span class="p">,</span><span class="c">...</span>
<span class="ln">53</span>                                 <span class="n">matrix</span><span class="p">);</span>
<span class="ln">54</span>                        
<span class="ln">55</span><span class="n">white_point_err</span> <span class="p">=</span> <span class="nb">sqrt</span><span class="p">(</span><span class="n">sum</span><span class="p">((</span><span class="n">predicted_white_point</span> <span class="o">-</span> <span class="n">white_point</span><span class="p">)</span><span class="o">.^</span><span class="mi">2</span><span class="p">));</span>
<span class="ln">56</span><span class="n">fprintf</span><span class="p">(</span><span class="s">&#39;residual error between user-specified and predicted white points: %.3e\n&#39;</span><span class="p">,</span> <span class="n">white_point_err</span><span class="p">);</span>
<span class="ln">57</span>
<span class="ln">58</span><span class="c">% visualization</span>
<span class="ln">59</span><span class="n">figureFullScreen</span><span class="p">(</span><span class="s">&#39;color&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">);</span>
<span class="ln">60</span><span class="n">ax1</span> <span class="p">=</span> <span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="ln">61</span><span class="n">colors2checker</span><span class="p">(</span><span class="n">RGB_wb</span> <span class="o">.^</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mf">2.2</span><span class="p">),</span><span class="c">...</span>
<span class="ln">62</span>               <span class="s">&#39;layout&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">14</span><span class="p">],</span><span class="c">...</span>
<span class="ln">63</span>               <span class="s">&#39;squaresize&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span><span class="c">...</span>
<span class="ln">64</span>               <span class="s">&#39;parent&#39;</span><span class="p">,</span> <span class="n">ax1</span><span class="p">);</span>
<span class="ln">65</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;White balaned camera responses before color correction (gamma = 1/2.2)&#39;</span><span class="p">);</span>
<span class="ln">66</span>
<span class="ln">67</span><span class="n">ax2</span> <span class="p">=</span> <span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
<span class="ln">68</span><span class="n">colors2checker</span><span class="p">(</span><span class="n">xyz2rgb</span><span class="p">(</span><span class="n">XYZ_pred</span><span class="p">),</span><span class="c">...</span>
<span class="ln">69</span>               <span class="s">&#39;layout&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">14</span><span class="p">],</span><span class="c">...</span>
<span class="ln">70</span>               <span class="s">&#39;squaresize&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span><span class="c">...</span>
<span class="ln">71</span>               <span class="s">&#39;parent&#39;</span><span class="p">,</span> <span class="n">ax2</span><span class="p">);</span>
<span class="ln">72</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Camera responses (sRGB) after color correction&#39;</span><span class="p">);</span>
</code></pre></div><h1 id="参考">参考</h1>
<p><a href="https://blog.csdn.net/VinagerJoe/article/details/129736452?app_version=6.2.4&amp;code=app_1562916241&amp;csdn_share_tail=%7B%22type%22%3A%22blog%22%2C%22rType%22%3A%22article%22%2C%22rId%22%3A%22129736452%22%2C%22source%22%3A%22yangju147532896%22%7D&amp;uLinkId=usr1mkqgl919blen&amp;utm_source=app">[1] Vinegar. CCM调试的理论依据, 2023.</a></p>
<p><a href="https://blog.csdn.net/weixin_52005944/article/details/120820278?app_version=6.2.4&amp;code=app_1562916241&amp;csdn_share_tail=%7B%22type%22%3A%22blog%22%2C%22rType%22%3A%22article%22%2C%22rId%22%3A%22120820278%22%2C%22source%22%3A%22yangju147532896%22%7D&amp;uLinkId=usr1mkqgl919blen&amp;utm_source=app">[2] piliweant. CCM 调节笔记, 2021.</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/413851281?utm_psn=1721847184872562688">[3] 碉堡了的少年. CCM-色彩校正矩阵, 2022.</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/31911875?utm_psn=1735434256514576384">[4] 烫手的洋芋. Color Correction Tuning Guide, 2018.</a></p>
<p><a href="https://ciechanow.ski/color-spaces/">[5] Bartosz Ciechanowski. Color Spaces, 2019.</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/98831426">[6] 刘斯宁. Understanding ISP Pipeline - CCM, 2021.</a></p>
              
            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">标签</span><br/>
                    
  <a class="tag tag--primary tag--small" href="https://yangyang48.github.io/tags/ccm/">CCM</a>

  <a class="tag tag--primary tag--small" href="https://yangyang48.github.io/tags/cie-rgb%E9%A2%9C%E8%89%B2%E6%A8%A1%E5%9E%8B/">CIE RGB颜色模型</a>

  <a class="tag tag--primary tag--small" href="https://yangyang48.github.io/tags/cie-xyz%E9%A2%9C%E8%89%B2%E7%A9%BA%E9%97%B4/">CIE XYZ颜色空间</a>

  <a class="tag tag--primary tag--small" href="https://yangyang48.github.io/tags/cie-xy%E8%89%B2%E5%BA%A6%E5%9B%BE/">CIE xy色度图</a>

  <a class="tag tag--primary tag--small" href="https://yangyang48.github.io/tags/srgb%E8%89%B2%E5%9F%9F/">sRGB色域</a>

  <a class="tag tag--primary tag--small" href="https://yangyang48.github.io/tags/cie-lab%E9%A2%9C%E8%89%B2%E7%A9%BA%E9%97%B4/">CIE Lab颜色空间</a>

  <a class="tag tag--primary tag--small" href="https://yangyang48.github.io/tags/cie-luv%E9%A2%9C%E8%89%B2%E7%A9%BA%E9%97%B4/">CIE Luv颜色空间</a>

                  </div>
                
              
            
            <div class="post-actions-wrap">
  
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://yangyang48.github.io/2021/07/leetcode-hot100/" data-tooltip="LeetCode hot100">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">下一篇</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://yangyang48.github.io/2024/01/rk-camera%E9%A9%B1%E5%8A%A8%E8%B0%83%E8%AF%95%E5%AD%A6%E4%B9%A0/" data-tooltip="rk camera驱动调试学习">
              
                  <span class="hide-xs hide-sm text-small icon-mr">上一篇</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#disqus_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#">
        
          <i class="fa fa-list"></i>
        </a>
      </li>
    </ul>
  
</div>

            
              
                <div id="disqus_thread">
  <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
              
            
          </div>
        </article>
		
		<div class="post-comment main-content-wrap">
		
  
  <div id="vcomments"></div>
  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src='//unpkg.com/valine/dist/Valine.min.js'></script>
  <script type="text/javascript">
    new Valine({
        el: '#vcomments' ,
        appId: 'mwl8M1aQzLnRE6JIpIY3sgE5-9Nh9j0Va',
        appKey: 'mPGr6GMC0BuzAKkxinnd0IAr',
        notify:  true , 
        verify:  false , 
        avatar:'retro', 
        placeholder: '欢迎各位宝宝留言~',
        visitor:  true 
    });
  </script>

		</div>
        <footer id="footer" class="main-content-wrap">
  
  
  
  <span class="copyrights">
    &copy; 2024 Yang Ju. All Rights Reserved
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
        <div class="post-actions-wrap">
  
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://yangyang48.github.io/2021/07/leetcode-hot100/" data-tooltip="LeetCode hot100">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">下一篇</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://yangyang48.github.io/2024/01/rk-camera%E9%A9%B1%E5%8A%A8%E8%B0%83%E8%AF%95%E5%AD%A6%E4%B9%A0/" data-tooltip="rk camera驱动调试学习">
              
                  <span class="hide-xs hide-sm text-small icon-mr">上一篇</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#disqus_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#">
        
          <i class="fa fa-list"></i>
        </a>
      </li>
    </ul>
  
</div>

      </div>
      <div id="share-options-bar" class="share-options-bar" data-behavior="4">
  <i id="btn-close-shareoptions" class="fa fa-close"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fyangyang48.github.io%2F2024%2F02%2Fisp%25E7%25AE%2597%25E6%25B3%2595%25E5%25AD%25A6%25E4%25B9%25A0ccmcolor-correction-matrix%2F">
          <i class="fa fa-facebook-official"></i><span>分享到 Facebook</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=https%3A%2F%2Fyangyang48.github.io%2F2024%2F02%2Fisp%25E7%25AE%2597%25E6%25B3%2595%25E5%25AD%25A6%25E4%25B9%25A0ccmcolor-correction-matrix%2F">
          <i class="fa fa-twitter"></i><span>分享到 Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=https%3A%2F%2Fyangyang48.github.io%2F2024%2F02%2Fisp%25E7%25AE%2597%25E6%25B3%2595%25E5%25AD%25A6%25E4%25B9%25A0ccmcolor-correction-matrix%2F">
          <i class="fa fa-google-plus"></i><span>分享到 Google&#43;</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>
    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="https://yangyang48.github.io/thumb/20210711204627625.jpg" alt="作者的图片" />
    
    <h4 id="about-card-name">Yang Ju</h4>
    
      <div id="about-card-bio">Nanjing University of Science and Technology</div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Software Development Engineer
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        NanJing,China
      </div>
    
  </div>
</div>

    

    
  
    
      <div id="cover" style="background-image:url('https://yangyang48.github.io/images/cover.jpg');"></div>
    
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.7/js/jquery.fancybox.min.js" integrity="sha256-GEAnjcTqVP+vBp3SSc8bEDQqvWAZMiHyUSIorrWwH50=" crossorigin="anonymous"></script>


<script src="https://yangyang48.github.io/js/script-pcw6v3xilnxydl1vddzazdverrnn9ctynvnxgwho987mfyqkuylcb1nlt.min.js"></script>


  
    <script src="https://yangyang48.github.io/js/copy-to-clipboard.js"></script>
  

<script lang="javascript">
window.onload = updateMinWidth;
window.onresize = updateMinWidth;
document.getElementById("sidebar").addEventListener("transitionend", updateMinWidth);
function updateMinWidth() {
  var sidebar = document.getElementById("sidebar");
  var main = document.getElementById("main");
  main.style.minWidth = "";
  var w1 = getComputedStyle(main).getPropertyValue("min-width");
  var w2 = getComputedStyle(sidebar).getPropertyValue("width");
  var w3 = getComputedStyle(sidebar).getPropertyValue("left");
  main.style.minWidth = `calc(${w1} - ${w2} - ${w3})`;
}
</script>

<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>


  
    
      <script>
        var disqus_config = function () {
          this.page.url = 'https:\/\/yangyang48.github.io\/2024\/02\/isp%E7%AE%97%E6%B3%95%E5%AD%A6%E4%B9%A0ccmcolor-correction-matrix\/';
          
            this.page.identifier = '\/2024\/02\/isp%E7%AE%97%E6%B3%95%E5%AD%A6%E4%B9%A0ccmcolor-correction-matrix\/'
          
        };
        (function() {
          
          
          if (window.location.hostname == "localhost") {
            return;
          }
          var d = document, s = d.createElement('script');
          var disqus_shortname = 'hugo-tranquilpeak-theme';
          s.src = '//' + disqus_shortname + '.disqus.com/embed.js';

          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();
      </script>
    
  


  <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS_CHTML-full" integrity="sha256-GhM+5JHb6QUzOQPXSJLEWP7R73CbkisjzK5Eyij4U9w=" crossorigin="anonymous"></script>
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      CommonHTML: { linebreaks: { automatic: true } },
      tex2jax: { inlineMath: [ ['$', '$'], ['\\(','\\)'] ], displayMath: [ ['$$','$$'], ['\\[', '\\]'] ], processEscapes: false },
      messageStyle: 'none'
    });
  </script>



    
  </body>
</html>

