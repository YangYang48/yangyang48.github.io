<!DOCTYPE html>
<html lang="en-us">
  <head>
    
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Hugo 0.85.0 with theme Tranquilpeak 0.4.8-BETA">
<meta name="author" content="Yang Ju">
<meta name="keywords" content="">
<meta name="description" content="SELinux(Security Enhanced Linux)是一个Linux内核模块，也是一个安全子系统。用于最大限度地减小系统中服务进程可访问的资源（最小权限原则）。">


<meta property="og:description" content="SELinux(Security Enhanced Linux)是一个Linux内核模块，也是一个安全子系统。用于最大限度地减小系统中服务进程可访问的资源（最小权限原则）。">
<meta property="og:type" content="article">
<meta property="og:title" content="一文带你了解SElinux那点事">
<meta name="twitter:title" content="一文带你了解SElinux那点事">
<meta property="og:url" content="https://yangyang48.github.io/2023/01/%E4%B8%80%E6%96%87%E5%B8%A6%E4%BD%A0%E4%BA%86%E8%A7%A3selinux%E9%82%A3%E7%82%B9%E4%BA%8B/">
<meta property="twitter:url" content="https://yangyang48.github.io/2023/01/%E4%B8%80%E6%96%87%E5%B8%A6%E4%BD%A0%E4%BA%86%E8%A7%A3selinux%E9%82%A3%E7%82%B9%E4%BA%8B/">
<meta property="og:site_name" content="欢迎来到我的博客~">
<meta property="og:description" content="SELinux(Security Enhanced Linux)是一个Linux内核模块，也是一个安全子系统。用于最大限度地减小系统中服务进程可访问的资源（最小权限原则）。">
<meta name="twitter:description" content="SELinux(Security Enhanced Linux)是一个Linux内核模块，也是一个安全子系统。用于最大限度地减小系统中服务进程可访问的资源（最小权限原则）。">
<meta property="og:locale" content="zh-cn">

  
    <meta property="article:published_time" content="2023-01-07T05:00:00">
  
  
    <meta property="article:modified_time" content="2023-01-07T05:00:00">
  
  
  
    
      <meta property="article:section" content="SElinux">
    
      <meta property="article:section" content="2023">
    
      <meta property="article:section" content="January">
    
  
  
    
      <meta property="article:tag" content="DAC">
    
      <meta property="article:tag" content="MAC">
    
      <meta property="article:tag" content="TE">
    
      <meta property="article:tag" content="avc">
    
      <meta property="article:tag" content="cts">
    
      <meta property="article:tag" content="源码">
    
      <meta property="article:tag" content="makefile">
    
      <meta property="article:tag" content="正则表达式">
    
  


<meta name="twitter:card" content="summary">







  <meta property="og:image" content="https://yangyang48.github.io/SElinux/selinux_thumb.jpg">
  <meta property="twitter:image" content="https://yangyang48.github.io/SElinux/selinux_thumb.jpg">


  <meta property="og:image" content="https://yangyang48.github.io/SElinux/selinux_cover.png">
  <meta property="twitter:image" content="https://yangyang48.github.io/SElinux/selinux_cover.png">




  <meta property="og:image" content="https://img-blog.csdnimg.cn/20210711204627625.jpg">
  <meta property="twitter:image" content="https://img-blog.csdnimg.cn/20210711204627625.jpg">


    <title>一文带你了解SElinux那点事</title>

    <link rel="icon" href="https://yangyang48.github.io/favicon.png">
    

    

    <link rel="canonical" href="https://yangyang48.github.io/2023/01/%E4%B8%80%E6%96%87%E5%B8%A6%E4%BD%A0%E4%BA%86%E8%A7%A3selinux%E9%82%A3%E7%82%B9%E4%BA%8B/">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.min.css" integrity="sha256-vuXZ9LGmmwtjqFX1F+EKin1ThZMub58gKULUyf0qECk=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/helpers/jquery.fancybox-thumbs.min.css" integrity="sha256-SEa4XYAHihTcEP1f5gARTB2K26Uk8PsndQYHQC1f4jU=" crossorigin="anonymous" />
    
    
    <link rel="stylesheet" href="https://yangyang48.github.io/css/style-twzjdbqhmnnacqs0pwwdzcdbt8yhv8giawvjqjmyfoqnvazl0dalmnhdkvp7.min.css" />
    
    
      
        <link rel="stylesheet"  href="https://yangyang48.github.io/css/copy-to-clipboard.css">
      
    

    
      
    
    

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="4">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://yangyang48.github.io/">欢迎来到我的博客~</a>
  </div>
  
    
      <a class="header-right-picture "
         href="https://yangyang48.github.io/#about">
    
    
    
      
        <img class="header-picture" src="https://img-blog.csdnimg.cn/20210711204627625.jpg" alt="作者的图片" />
      
    
    </a>
  
</header>

      <nav id="sidebar" data-behavior="4">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://yangyang48.github.io/#about">
          <img class="sidebar-profile-picture" src="https://img-blog.csdnimg.cn/20210711204627625.jpg" alt="作者的图片" />
        </a>
        <h4 class="sidebar-profile-name">Yang Ju</h4>
        
          <h5 class="sidebar-profile-bio">Nanjing University of Science and Technology</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://yangyang48.github.io/">
    
      <i class="sidebar-button-icon fa fa-lg fa-home"></i>
      
      <span class="sidebar-button-desc">首页</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://yangyang48.github.io/categories">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">分类</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://yangyang48.github.io/tags">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">标签</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://yangyang48.github.io/archives">
    
      <i class="sidebar-button-icon fa fa-lg fa-archive"></i>
      
      <span class="sidebar-button-desc">归档</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://yangyang48.github.io/#about">
    
      <i class="sidebar-button-icon fa fa-lg fa-question"></i>
      
      <span class="sidebar-button-desc">关于</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/YangYang48" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-github"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://blog.csdn.net/yangju147532896" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-chain"></i>
      
      <span class="sidebar-button-desc">CSDN</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
  </div>
</nav>

      
  <div class="post-header-cover
              text-center
              "
       style="background-image:url('/SElinux/selinux_cover.png')"
       data-behavior="4">
    
  </div>


      <div id="main" data-behavior="4"
        class="hasCover
               hasCoverMetaOut
               ">
        <article class="post" itemscope itemType="http://schema.org/BlogPosting">
          
          
            <div class="post-header main-content-wrap text-center">
  
    <h1 class="post-title" itemprop="headline">
      一文带你了解SElinux那点事
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time itemprop="datePublished" datetime="2023-01-07T05:00:00Z">
        
  一月 7, 2023

      </time>
    
    
  
  
    <span>发布在</span>
    
      <a class="category-link" href="https://yangyang48.github.io/categories/selinux">SElinux</a>, 
    
      <a class="category-link" href="https://yangyang48.github.io/categories/2023">2023</a>, 
    
      <a class="category-link" href="https://yangyang48.github.io/categories/january">January</a>
    
  

  </div>

</div>
          
		  
		  <h5 id="wc" style="font-size: 1rem;text-align: center;">12800 Words|Read in about 60 Min|本文总阅读量<span id="busuanzi_value_page_pv"></span>次</h5>
		  
          <div class="post-content markdown" itemprop="articleBody">
            <div class="main-content-wrap">
              <p>SELinux(Security Enhanced Linux)是一个Linux内核模块，也是一个安全子系统。用于最大限度地减小系统中服务进程可访问的资源（最小权限原则）。</p>
<h1 id="1介绍">1介绍</h1>
<p>SELinux(Security Enhanced Linux是一个Linux内核模块，也是Linux的一个安全子系统
SELinux主要作用: 最大限度地减小系统中服务进程可访问的资源（最小权限原则）</p>
<p>SELinux存在的意义是什么？
更安全吧，即使某个进程被黑了或者直接被获取了root权限，也没有拥有所有权限，没有在te策略文件里面声明的权限都不允许</p>
<p>前面提到了即使被root了，也不一定有权限操作，但是我们在板子上su获取root之后，不是拥有权限setenforce吗，直接关了SELinux不就完了？
在userdebug版本中，为了方便调试，Google原生是有给su足够的权限去操作很多事情的，基本上root就是无敌的存在，所以我们可以直接用setenforce命令去关闭SELinux</p>
<p>user版本中，权限收紧，即使是su获取了root权限，有很多命令都是没有权限执行的，也就是说user版本的系统打开SELinux之后才是最安全的</p>
<h2 id="11dac-和-mac">1.1DAC 和 MAC</h2>
<p>正如很多文章都会提到的两个概念：DAC 和 MAC</p>
<p>DAC：Discretionary Access Control 自主访问控制</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/SElinux/selinux_1.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/SElinux/selinux_1.png" >
  
    </a>
  
  
</div>

<p>进程理论上所拥有的权限与执行它的用户的权限相同，只要获得root权限，几乎无所不能</p>
<p>比如上面的图片，user是没有权限写入test.txt的</p>
<p>但是可以获取root权限，接着就能写入了</p>
<p>MAC：Mandatory Access Control 强制访问控制</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/SElinux/selinux_2.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/SElinux/selinux_2.png" >
  
    </a>
  
  
</div>

<p>相比DAC，这里进程和文件都被打上了安全上下文，user在写入test.txt的时候，除了要拥有写权限，同时也要在规则库里面声明权限，才能正常写入。</p>
<p>任何进程想在 SELinux 系统上干任何事情，都必须在安全策略文件中赋予权限，凡是没有出现在安全策略文件中的权限都不拥有；即使你是root，也不一定拥有权限操作，这个并不能做到防御一切攻击，但是能将损失降到最小</p>
<h2 id="12selinux规则">1.2SElinux规则</h2>
<h3 id="121安全上下文security-context">1.2.1安全上下文（Security Context）</h3>
<p>完整的 Security Context 字符串为：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln">1</span>user:role:type<span class="o">[</span>:range<span class="o">]</span>
</code></pre></div><p>SELinux给每一个文件、进程、属性、服务都给打上一个标签，叫安全上下文（Security Context）</p>
<p>用下面的命令可以分别查看对应的安全上下文</p>
<ul>
<li>id -Z 查看当前进程的scontext</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln">1</span>picasso:/ $ id -Z
<span class="ln">2</span><span class="nv">context</span><span class="o">=</span>u:r:shell:s0
<span class="ln">3</span> 
<span class="ln">4</span>picasso:/ <span class="c1"># id -Z</span>
<span class="ln">5</span><span class="nv">context</span><span class="o">=</span>u:r:su:s0
</code></pre></div><ul>
<li>ls -Z 查看文件的scontext</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln">1</span>picasso:/ <span class="c1"># ps -AZ | grep surface</span>
<span class="ln">2</span>u:r:surfaceflinger:s0          system        <span class="m">2930</span>     <span class="m">1</span>   <span class="m">67104</span>  <span class="m">12856</span> SyS_epoll_wait      <span class="m">0</span> S surfaceflinger
</code></pre></div><ul>
<li>getprop -Z 查看属性的scontext</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln">1</span>picasso:/ <span class="c1"># getprop -Z | grep selinux</span>
<span class="ln">2</span><span class="o">[</span>ro.boot.selinux<span class="o">]</span>: <span class="o">[</span>u:object_r:default_prop:s0<span class="o">]</span>
<span class="ln">3</span><span class="o">[</span>ro.boottime.init.selinux<span class="o">]</span>: <span class="o">[</span>u:object_r:boottime_prop:s0<span class="o">]</span>
<span class="ln">4</span><span class="o">[</span>selinux.restorecon_recursive<span class="o">]</span>: <span class="o">[</span>u:object_r:restorecon_prop:s0<span class="o">]</span>
</code></pre></div><ul>
<li>user：用户，Android里面就一个 u</li>
<li>role：角色，进程用 r ，文件用 object_r</li>
<li>type ：类型，对进程而言也通常叫域，都是一个概念</li>
<li>range，也就是上面的s0，是Multi-Level Security（MLS）的等级，这个有个概念就行了，MLS 将系统的进程和文件进行了分级，不同级别的资源需要对应级别的进程才能访问</li>
</ul>
<p>安全上下文其实就是一个字符串，我们最需要关注的就是type，MAC基本管理单位是TEAC（Type Enforcement Accesc Control）</p>
<h3 id="122te-type-enforcement">1.2.2TE （Type Enforcement）</h3>
<h4 id="1221-selinux策略规则语句格式">1.2.2.1 SELinux策略规则语句格式</h4>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln">1</span>rules domains types:classes permissions<span class="p">;</span>
</code></pre></div><ul>
<li>
<p>rules 包括的规则有四个：allow、neverallow、dontaudit、auditallow</p>
<p>allow ： 允许主体对客体进行操作</p>
<p>neverallow ：拒绝主体对客体进行操作</p>
<p>dontaudit ： 表示不记录某条违反规则的决策信息</p>
<p>auditallow ：记录某项决策信息，通常 SElinux 只记录失败的信息，应用这条规则后会记录成功的决策信息</p>
</li>
<li>
<p>domains 一个进程或一组进程的标签。也称为域类型，因为它只是指进程的类型</p>
</li>
<li>
<p>types 一个对象（例如：文件、属性）或一组对象的标签</p>
</li>
<li>
<p>classes 要访问的对象（例如：文件、属性）的类型</p>
</li>
<li>
<p>permissions 要执行的操作（例如：读、写）</p>
</li>
</ul>
<p>规则库以白名单的形式存在，要求所有允许的操作都必须要用allow规则来定义，不然都会被禁止操作</p>
<p>domains、types、classes、permissions都可以是单独的一个，也可以是一个集合，用花括号括起来</p>
<p>其中的domains和types，既可以指定一个type，也可以指定一组type（也就是attribute），这些定义在te文件里面</p>
<p>classes的定义在/android/system/sepolicy/private/security_classes</p>
<p>permissions的定义在/android/system/sepolicy/private/access_vectors</p>
<p>上面这些规则我们用最多的就是allow和neverallow，搞清楚这两个之后其他的规则是一样的道理</p>
<h4 id="1222type和attribute">1.2.2.2type和attribute</h4>
<p><strong>1、type的定义规则</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln">1</span><span class="nb">type</span> type_name <span class="o">[</span><span class="nb">alias</span> alias_set<span class="o">]</span> <span class="o">[</span>, attribute_set<span class="o">]</span> <span class="p">;</span>
</code></pre></div><p>比如system_app.te里面定义：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln">1</span><span class="nb">type</span> system_app, domain<span class="p">;</span>
</code></pre></div><p>type的名字是system_app</p>
<p>alias定义的是别名，在Android里面这个基本没有用到，见不到它的身影</p>
<p>逗号后面的是属性（attribute），也就是说domain是一个属性，type可以关联多个属性，后面用逗号分割，比如：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln">1</span><span class="nb">type</span> traced_probes, domain, coredomain, mlstrustedsubject<span class="p">;</span>
</code></pre></div><p>表示traced_probes这个type关联上了domain、coredomain、mlstrustedsubject这三个属性</p>
<p>如果在type定义的时候没有关联属性，后面也可以通过typeattribute关键字来关联</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln">1</span>typeattribute type_name attribute_name<span class="p">;</span>
</code></pre></div><p><strong>2、attribute的定义规则</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln">1</span>attribute attribute_name<span class="p">;</span>
</code></pre></div><p>代码里面属性的定义在：</p>
<p>/android/system/sepolicy/public/attributes</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln"> 1</span><span class="c1"># All types used for processes.</span>
<span class="ln"> 2</span>attribute domain<span class="p">;</span>
<span class="ln"> 3</span> 
<span class="ln"> 4</span><span class="c1"># All types used for files that can exist on a labeled fs.</span>
<span class="ln"> 5</span><span class="c1"># Do not use for pseudo file types.</span>
<span class="ln"> 6</span><span class="c1"># On change, update CHECK_FC_ASSERT_ATTRS</span>
<span class="ln"> 7</span><span class="c1"># definition in tools/checkfc.c.</span>
<span class="ln"> 8</span>attribute file_type<span class="p">;</span>
<span class="ln"> 9</span> 
<span class="ln">10</span><span class="c1"># All types used for domain entry points.</span>
<span class="ln">11</span>attribute exec_type<span class="p">;</span>
<span class="ln">12</span> 
<span class="ln">13</span><span class="c1"># All types used for /data files.</span>
<span class="ln">14</span>attribute data_file_type<span class="p">;</span>
<span class="ln">15</span>expandattribute data_file_type false<span class="p">;</span>
<span class="ln">16</span><span class="c1"># All types in /data, not in /data/vendor</span>
<span class="ln">17</span>attribute core_data_file_type<span class="p">;</span>
<span class="ln">18</span>expandattribute core_data_file_type false<span class="p">;</span>
<span class="ln">19</span><span class="c1"># All types in /vendor</span>
<span class="ln">20</span>attribute vendor_file_type<span class="p">;</span>
<span class="ln">21</span>......
</code></pre></div><p><strong>3、type和attribute的区别</strong></p>
<p>关于type和attribute，一开始接触，很难理解这两个的区别</p>
<p>它们两个有很多类似的点，但是又不大一样：</p>
<ul>
<li>type和attribute都是不能重复定义的，它们位于同一个命令空间，也就意味着定义一个type之后，就不能定义一个同名的attribute</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln">1</span>下面的都会定义会报错提示，重复定义
<span class="ln">2</span>
<span class="ln">3</span><span class="nb">type</span> system_app, domain<span class="p">;</span>
<span class="ln">4</span>attribute system_app<span class="p">;</span>
<span class="ln">5</span> 
<span class="ln">6</span> 
<span class="ln">7</span><span class="nb">type</span> system_app, domain<span class="p">;</span>
<span class="ln">8</span><span class="nb">type</span> system_app, coredomain, mlstrustedsubject<span class="p">;</span>
</code></pre></div><ul>
<li>type就是一个类型；attribute可以找到所有关联了这个属性的type，可以把它当成一个集合、组、标签</li>
</ul>
<p>attribute其实就是为了方便书写te规则，我们可以用attribute找到所有关联了属性的type集合，而不用每一个都写出来</p>
<h4 id="1223例子">1.2.2.3例子</h4>
<p>上面的概念比较抽象，通常我们能比较快理解的是如何在te文件里使用allow语句添加权限，但是对于neverallow语句所表达的意思就很难理解了</p>
<p>下面我用例子来解释（<strong>提到的权限只是示例，并不一定是代码里面的，也有可能违反neverallow规则</strong>）</p>
<p>1、假如有几个文件，以及它们的安全上下文：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln">1</span>picasso:/ <span class="c1"># ls -Z /data/test.txt</span>
<span class="ln">2</span>u:object_r:system_data_file:s0 /data/test.txt
<span class="ln">3</span> 
<span class="ln">4</span>picasso:/ <span class="c1"># ls -Z /data/vendor/log_test.txt</span>
<span class="ln">5</span>u:object_r:vendor_data_file:s0 /data/vendor/log_test.txt
<span class="ln">6</span> 
<span class="ln">7</span>picasso:/ <span class="c1"># ls -Z /data/media/media_test.txt</span>
<span class="ln">8</span>u:object_r:media_rw_data_file:s0 /data/media/media_test.txt
</code></pre></div><p><strong>2、有如下几个脚本，内容都一样</strong></p>
<p>/system/bin/testA.sh</p>
<p>/vendor/bin/testB.sh</p>
<p>/vendor/bin/testC.sh</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln">1</span><span class="nb">echo</span> <span class="s2">&#34;hello world&#34;</span> &gt; /data/test.txt
<span class="ln">2</span><span class="nb">echo</span> <span class="s2">&#34;hello world&#34;</span> &gt; /data/vendor/log_test.txt
<span class="ln">3</span><span class="nb">echo</span> <span class="s2">&#34;hello world&#34;</span> &gt; /data/media/media_test.txt
</code></pre></div><p><strong>3、init.rc里面的定义如下：</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln"> 1</span>service testA /system/bin/testA.sh
<span class="ln"> 2</span>    user root
<span class="ln"> 3</span>    group root
<span class="ln"> 4</span>    disabled
<span class="ln"> 5</span>    oneshot
<span class="ln"> 6</span>    seclabel u:r:testA:s0
<span class="ln"> 7</span> 
<span class="ln"> 8</span>service testB /vendor/bin/testB.sh
<span class="ln"> 9</span>    user root
<span class="ln">10</span>    group root
<span class="ln">11</span>    disabled
<span class="ln">12</span>    oneshot
<span class="ln">13</span>    seclabel u:r:testB:s0
<span class="ln">14</span> 
<span class="ln">15</span>service testC /vendor/bin/testC.sh
<span class="ln">16</span>    user root
<span class="ln">17</span>    group root
<span class="ln">18</span>    disabled
<span class="ln">19</span>    oneshot
<span class="ln">20</span>    seclabel u:r:testC:s0
</code></pre></div><p><strong>4、假设系统里面定义的type和attribute只有下面这些：</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln"> 1</span><span class="nb">type</span> system_server, coredomain, domain<span class="p">;</span>
<span class="ln"> 2</span><span class="nb">type</span> testA, domain<span class="p">;</span>
<span class="ln"> 3</span><span class="nb">type</span> testB, domain<span class="p">;</span>
<span class="ln"> 4</span><span class="nb">type</span> performanced, domain, coredomain<span class="p">;</span>
<span class="ln"> 5</span><span class="nb">type</span> kernel, domain, data_between_core_and_vendor_violators<span class="p">;</span>
<span class="ln"> 6</span><span class="nb">type</span> testC, domain<span class="p">;</span>
<span class="ln"> 7</span><span class="nb">type</span> init, domain, data_between_core_and_vendor_violators<span class="p">;</span>
<span class="ln"> 8</span> 
<span class="ln"> 9</span><span class="nb">type</span> system_data_file, file_type, data_file_type, core_data_file_type<span class="p">;</span>
<span class="ln">10</span><span class="nb">type</span> vendor_data_file, file_type, data_file_type<span class="p">;</span>
<span class="ln">11</span><span class="nb">type</span> media_rw_data_file, file_type, data_file_type, core_data_file_type<span class="p">;</span>
<span class="ln">12</span> 
<span class="ln">13</span>attribute domain<span class="p">;</span>
<span class="ln">14</span>attribute coredomain<span class="p">;</span>
<span class="ln">15</span>attribute data_between_core_and_vendor_violators<span class="p">;</span>
<span class="ln">16</span>attribute file_type<span class="p">;</span>
<span class="ln">17</span>attribute data_file_type<span class="p">;</span>
<span class="ln">18</span>attribute core_data_file_type<span class="p">;</span>
</code></pre></div>

 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/SElinux/selinux_10.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/SElinux/selinux_10.png" >
  
    </a>
  
  
</div>

<p>正如前面提到的概念：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln">1</span>1、属性domain是type集合 ： <span class="o">{</span> system_server testA testB performanced kernel testC init <span class="o">}</span>
<span class="ln">2</span>2、属性coredomain是type集合 ： <span class="o">{</span> system_server performanced <span class="o">}</span>
<span class="ln">3</span>3、属性data_between_core_and_vendor_violators是type集合 ： <span class="o">{</span> kernel init <span class="o">}</span>
<span class="ln">4</span>4、属性file_type是type集合 ：<span class="o">{</span> system_data_file vendor_data_file media_rw_data_file <span class="o">}</span>
<span class="ln">5</span>5、属性data_file_type是type集合 ： <span class="o">{</span> system_data_file vendor_data_file media_rw_data_file <span class="o">}</span>
<span class="ln">6</span>6、属性core_data_file_type是type集合 ： <span class="o">{</span> system_data_file media_rw_data_file <span class="o">}</span>
</code></pre></div><p>脚本testA.sh运行起来之后，脚本的进程所在的安全上下文是u:r:testA:s0</p>
<p>如果要想写文件 /data/test.txt，就要给它足够的权限才行：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>allow testA system_data_file:file { read write open create };
</code></pre></div><p>这句话的意思是type为testA的进程，拥有对type为system_data_file的文件（file）的read write open create权限</p>
<p>此时写第二个文件 /data/vendor/log_test.txt 就没有权限了，因为文件log_test.txt的type是vendor_data_file</p>
<p>同样的得添加权限</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>allow testA vendor_data_file:file { read write open create };
</code></pre></div><p>同理，/data/media/media_test.txt也是一样的道理</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>allow testA media_rw_data_file:file { read write open create };
</code></pre></div><p>上面的allow语句大家很容易理解</p>
<p>再比如：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>allow coredomain data_file_type:file { read write open create };
</code></pre></div><p>这里coredomain和data_file_type是一个属性（一个type集合，而不仅仅是一个type了），等价于</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>allow { system_server performanced } { system_data_file vendor_data_file media_rw_data_file }:file { read write open create };
</code></pre></div><p>当然，Android系统里面关联data_file_type这个属性的不止这三个，那么data_file_type其实就是所有关联了这个属性的type的集合</p>
<p>domain是所有进程type的总和，因为所有的进程type都要关联属性domain，不然脚本都没有办法运行起来</p>
<p><strong>5、neverallow规则</strong></p>
<p>再看看neverallow规则，其实和allow规则是一样格式的</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>假如：
<span class="ln">2</span>neverallow {
<span class="ln">3</span>  domain
<span class="ln">4</span>  -coredomain
<span class="ln">5</span>  -data_between_core_and_vendor_violators
<span class="ln">6</span>} {
<span class="ln">7</span>  core_data_file_type
<span class="ln">8</span>}:file { create open };
</code></pre></div><p>减号 - 代表去掉一个type或者一组type</p>
<p>还有几个：</p>
<p>*号表示所有内容</p>
<p>~号表示取反，剩下的所有内容</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>{ domain -coredomain -data_between_core_and_vendor_violators } 等于
<span class="ln">2</span>{ system_server testA testB performanced kernel testC init } - { system_server performanced } - { kernel init }
<span class="ln">3</span>也就是： { testA testB testC }
</code></pre></div><p>上面的neverallow语句等价于：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>neverallow { testA testB testC } { system_data_file vendor_data_file media_rw_data_file }:file { create open };
</code></pre></div><p>整理成这样之后，就会发现和前面提到的规则是一模一样的：</p>
<ul>
<li>rules : neverallow</li>
<li>domains : { testA testB testC }</li>
<li>types : { system_data_file vendor_data_file media_rw_data_file }</li>
<li>classes : file</li>
<li>permissions : { create open }</li>
</ul>
<p>neverallow语句的意思是：不允许testA testB testC这些type的进程，对type为system_data_file vendor_data_file media_rw_data_file的file，有create和open权限</p>
<p>如果我们添加了这样的权限，将会报错:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>allow testA system_data_file:file create；
</code></pre></div><p>之所以说neverallow和allow的书写规则是一样的，是因为如果把neverallow换成allow之后，就是允许给testA testB testC添加对类型为core_data_file_type的file的create和open权限</p>
<p>neverallow就是反过来，不允许你给它们这些权限</p>
<p><strong>6、题外话</strong></p>
<p>我们在添加脚本的时候，通常对应的te会有类似下面的三句：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>type testA, domain;
<span class="ln">2</span>type testA_exec, exec_type, vendor_file_type, file_type;
<span class="ln">3</span> 
<span class="ln">4</span>init_daemon_domain(testA)
</code></pre></div><p>第一个是testA.sh脚本运行起来之后，进程的type，它的安全上下文是 u:r:testA:s0</p>
<p>第二个是testA.sh这个文件的type，它的安全上下文是 u:object_r:testA_exec:s0</p>
<p>第三个是域转移，我们这些脚本都是init进程启动的，如果没有域转移，那么脚本运行起来它的安全上下文就是 u:r:init:s0了，显然没有细分出来</p>
<p>那这里的意思就是type为init的进程，在运行type为testA_exec的脚本时，会把域切换到testA来</p>
<p>init_daemon_domain的定义在/system/sepolicy/public/te_macros</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>#####################################
<span class="ln">2</span># init_daemon_domain(domain)
<span class="ln">3</span># Set up a transition from init to the daemon domain
<span class="ln">4</span># upon executing its binary.
<span class="ln">5</span>define(`init_daemon_domain&#39;, `
<span class="ln">6</span>domain_auto_trans(init, $1_exec, $1)
<span class="ln">7</span>tmpfs_domain($1)
<span class="ln">8</span>&#39;)
</code></pre></div><h2 id="13selinux-配置">1.3SELinux 配置</h2>
<h3 id="131开关selinux">1.3.1开关SELinux</h3>
<p>SELinux的状态有两个</p>
<ul>
<li>enforcing 权限拒绝事件会被记录下来并强制执行</li>
<li>permissive 权限拒绝事件会被记录下来，但不会被强制执行
（当然有些还会有disable作为第三个状态，就是彻底关闭的状态）</li>
</ul>
<p>进入系统后，可以使用setenforce命令来开关</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln">1</span><span class="c1">#关闭：</span>
<span class="ln">2</span>picasso:/ $ setenforce <span class="m">0</span>
<span class="ln">3</span><span class="c1">#打开：</span>
<span class="ln">4</span>picasso:/ $ setenforce <span class="m">1</span>
</code></pre></div><p>但如果要开机阶段也是关闭的状态，那就要修改到bootargs的参数了</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln">1</span><span class="c1">#打开</span>
<span class="ln">2</span>androidboot.selinux<span class="o">=</span>enforcing
<span class="ln">3</span> 
<span class="ln">4</span><span class="c1">#关闭</span>
<span class="ln">5</span>androidboot.selinux<span class="o">=</span>permissive
</code></pre></div><p>这里面还需要注意一点，一个宏： ALLOW_PERMISSIVE_SELINUX</p>
<p>/android/system/core/init/Android.mk</p>
<div class="highlight"><pre class="chroma"><code class="language-makefile" data-lang="makefile"><span class="ln"> 1</span><span class="err">ifneq</span> <span class="err">(,</span><span class="k">$(</span><span class="nv">filter</span> <span class="nv">userdebug</span> <span class="nv">eng</span>,<span class="k">$(</span><span class="nv">TARGET_BUILD_VARIANT</span><span class="k">))</span><span class="err">)</span>
<span class="ln"> 2</span><span class="nv">init_options</span> <span class="o">+=</span> <span class="se">\
</span><span class="ln"> 3</span><span class="se"></span>    -DALLOW_LOCAL_PROP_OVERRIDE<span class="o">=</span><span class="m">1</span> <span class="se">\
</span><span class="ln"> 4</span><span class="se"></span>    -DALLOW_PERMISSIVE_SELINUX<span class="o">=</span><span class="m">1</span> <span class="se">\
</span><span class="ln"> 5</span><span class="se"></span>    -DREBOOT_BOOTLOADER_ON_PANIC<span class="o">=</span><span class="m">1</span> <span class="se">\
</span><span class="ln"> 6</span><span class="se"></span>    -DWORLD_WRITABLE_KMSG<span class="o">=</span><span class="m">1</span> <span class="se">\
</span><span class="ln"> 7</span><span class="se"></span>    -DDUMP_ON_UMOUNT_FAILURE<span class="o">=</span><span class="m">1</span>
<span class="ln"> 8</span><span class="err">else</span>
<span class="ln"> 9</span><span class="nv">init_options</span> <span class="o">+=</span> <span class="se">\
</span><span class="ln">10</span><span class="se"></span>    -DALLOW_LOCAL_PROP_OVERRIDE<span class="o">=</span><span class="m">0</span> <span class="se">\
</span><span class="ln">11</span><span class="se"></span>    -DALLOW_PERMISSIVE_SELINUX<span class="o">=</span><span class="m">0</span> <span class="se">\
</span><span class="ln">12</span><span class="se"></span>    -DREBOOT_BOOTLOADER_ON_PANIC<span class="o">=</span><span class="m">0</span> <span class="se">\
</span><span class="ln">13</span><span class="se"></span>    -DWORLD_WRITABLE_KMSG<span class="o">=</span><span class="m">0</span> <span class="se">\
</span><span class="ln">14</span><span class="se"></span>    -DDUMP_ON_UMOUNT_FAILURE<span class="o">=</span><span class="m">0</span>
<span class="ln">15</span><span class="err">endif</span>
</code></pre></div><p>/android/system/core/init/selinux.cpp</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="n">EnforcingStatus</span> <span class="nf">StatusFromCmdline</span><span class="p">()</span> <span class="p">{</span>
<span class="ln"> 2</span>    <span class="n">EnforcingStatus</span> <span class="n">status</span> <span class="o">=</span> <span class="n">SELINUX_ENFORCING</span><span class="p">;</span>
<span class="ln"> 3</span> 
<span class="ln"> 4</span>    <span class="n">import_kernel_cmdline</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span>
<span class="ln"> 5</span>                          <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">in_qemu</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 6</span>                              <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="s">&#34;androidboot.selinux&#34;</span> <span class="o">&amp;&amp;</span> <span class="n">value</span> <span class="o">==</span> <span class="s">&#34;permissive&#34;</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 7</span>                                  <span class="n">status</span> <span class="o">=</span> <span class="n">SELINUX_PERMISSIVE</span><span class="p">;</span>
<span class="ln"> 8</span>                              <span class="p">}</span>
<span class="ln"> 9</span>                          <span class="p">});</span>
<span class="ln">10</span> 
<span class="ln">11</span>    <span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="ln">12</span><span class="p">}</span>
<span class="ln">13</span> 
<span class="ln">14</span><span class="kt">bool</span> <span class="nf">IsEnforcing</span><span class="p">()</span> <span class="p">{</span>
<span class="ln">15</span>    <span class="k">if</span> <span class="p">(</span><span class="n">ALLOW_PERMISSIVE_SELINUX</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">16</span>        <span class="k">return</span> <span class="n">StatusFromCmdline</span><span class="p">()</span> <span class="o">==</span> <span class="n">SELINUX_ENFORCING</span><span class="p">;</span>
<span class="ln">17</span>    <span class="p">}</span>
<span class="ln">18</span>    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="ln">19</span><span class="p">}</span>
</code></pre></div><p>对于user版本，是没有办法通过bootargs的androidboot.selinux来关闭的，一直都是enforcing状态的</p>
<p>上面的方法只适用于eng和userdebug版本，在user版本上，权限收缩管控得非常严格</p>
<p>不仅改bootargs没有作用，进入系统后，即使你是root用户，setenforce也没有权限操作</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln">1</span>picasso:/ $ setenforce <span class="m">0</span>
<span class="ln">2</span>setenforce: Couldn<span class="s1">&#39;t set enforcing status to &#39;</span>0<span class="err">&#39;</span>: Permission denied
<span class="ln">3</span><span class="o">[</span> 4427.467459@3<span class="o">]</span> <span class="nv">type</span><span class="o">=</span><span class="m">1404</span> audit<span class="o">(</span>1623583196.490:218<span class="o">)</span>: <span class="nv">enforcing</span><span class="o">=</span><span class="m">1</span> <span class="nv">old_enforcing</span><span class="o">=</span><span class="m">0</span> <span class="nv">auid</span><span class="o">=</span><span class="m">4294967295</span> <span class="nv">ses</span><span class="o">=</span><span class="m">4294967295</span>
<span class="ln">4</span><span class="o">[</span> 4427.477347@3<span class="o">]</span> <span class="nv">type</span><span class="o">=</span><span class="m">1400</span> audit<span class="o">(</span>1623583199.930:219<span class="o">)</span>: avc: denied <span class="o">{</span> setenforce <span class="o">}</span> <span class="k">for</span> <span class="nv">pid</span><span class="o">=</span><span class="m">4412</span> <span class="nv">comm</span><span class="o">=</span><span class="s2">&#34;setenforce&#34;</span> <span class="nv">scontext</span><span class="o">=</span>u:r:shell:s0 <span class="nv">tcontext</span><span class="o">=</span>u:object_r:kernel:s0 <span class="nv">tclass</span><span class="o">=</span>security <span class="nv">permissive</span><span class="o">=</span><span class="m">0</span>
</code></pre></div><p>所以user版本要想关闭SELinux，只能修改代码逻辑了</p>
<h2 id="132策略文件配置">1.3.2策略文件配置</h2>
<p>Google原生的te在/android/system/sepolicy目录下</p>
<p>设备制造商客制化部分的策略文件te可以通过变量<strong>BOARD_SEPOLICY_DIRS</strong>来指定，是对/android/system/sepolicy/vendor目录的拓展</p>
<p>这是个很关键的变量，通过这个变量就可以找到你要添加的te在哪个路径</p>
<p>比如：</p>
<div class="highlight"><pre class="chroma"><code class="language-makefile" data-lang="makefile"><span class="ln">1</span><span class="err">//对应设备目录/vendor/etc/selinux</span>
<span class="ln">2</span><span class="nv">BOARD_SEPOLICY_DIRS</span> <span class="o">+=</span> device/google/marlin/sepolicy
<span class="ln">3</span><span class="nv">BOARD_SEPOLICY_DIRS</span> <span class="o">+=</span> device/google/marlin/sepolicy/verizon
</code></pre></div><blockquote>
<p>事实上除了上述之外，芯片厂商可能还会定制其他分区，比如product分区</p>
<div class="highlight"><pre class="chroma"><code class="language-makefile" data-lang="makefile"><span class="ln">1</span><span class="err">//对应设备目录/product/etc/selinux</span>
<span class="ln">2</span><span class="nv">PRODUCT_PRIVATE_SEPOLICY_DIRS</span> <span class="o">+=</span> device/google/marlin/sepolicy/private
<span class="ln">3</span><span class="nv">PRODUCT_PUBLIC_SEPOLICY_DIRS</span> <span class="o">+=</span> device/google/marlin/sepolicy/public
</code></pre></div></blockquote>
<p>还有两个变量也是对策略文件拓展，这个大家会比较陌生</p>
<div class="highlight"><pre class="chroma"><code class="language-makefile" data-lang="makefile"><span class="ln">1</span><span class="err">BOARD_PLAT_PUBLIC_SEPOLICY_DIR</span>    <span class="c">#对PLAT_PUBLIC_POLICY的拓展  即对/android/system/sepolicy/public目录的拓展
</span><span class="ln">2</span><span class="c"></span><span class="err">BOARD_PLAT_PRIVATE_SEPOLICY_DIR</span>   <span class="c">#对PLAT_PRIVATE_POLICY的拓展 即对/android/system/sepolicy/private目录的拓展
</span></code></pre></div><blockquote>
<p><strong>private</strong>代表目录下面的文件，只对BOARD平台策略可见/system/sepolicy，通常为这个目录</p>
<p><strong>public</strong>代表目录下面所有的策略都可见，非平台的目录在/device下面，可以看到/system/sepolicy/public目录下面定义的策略</p>
</blockquote>
<h2 id="14判断是否为selinux导致的权限问题">1.4判断是否为SELinux导致的权限问题</h2>
<p>判断是否为SELinux导致的权限问题很简单</p>
<ul>
<li>打开SELinux情况下必现问题</li>
<li>关闭SELinux之后如果问题消失，那基本上就可以认定是权限问题导致的</li>
</ul>
<p>接着重要的就是抓取avc报错信息，添加权限</p>
<p><strong>kernel log</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>picasso:/ $ dmesg | grep avc
<span class="ln">2</span>[ 8839.922581@3] type=1400 audit(1623587612.374:455): avc: denied { setattr } for pid=4570 comm=&#34;chmod&#34; name=&#34;video&#34; dev=&#34;mmcblk0p21&#34; ino=384 scontext=u:r:system_app:s0 tcontext=u:object_r:system_data_file:s0 tclass=dir permissive=0
</code></pre></div><p><strong>Andriod log</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>picasso:/ $ logcat | grep avc
<span class="ln">2</span>01-01 08:00:09.652  3259  3259 I init    : type=1400 audit(0.0:17): avc: denied { entrypoint } for path=&#34;/vendor/bin/testA.sh&#34; dev=&#34;mmcblk0p16&#34; ino=705 scontext=u:r:testA:s0 tcontext=u:object_r:vendor_file:s0 tclass=file permissive=1
</code></pre></div><p>如果是SELinux权限问题，那必然是100%必现的</p>
<p>前面提到的会出现第一次开机有权限问题，后面开机就没有问题了</p>
<p>找了很久的原因，发现是其他脚本会操作SELinux的开关，没有复现的情况刚好被关掉了</p>
<h1 id="2开机初始化与策略文件编译过程">2开机初始化与策略文件编译过程</h1>
<h2 id="21selinux开机初始化">2.1SELinux开机初始化</h2>
<h3 id="211initcpp">2.1.1init.cpp</h3>
<p>代码路径：android/system/core/init/init.cpp</p>
<p>main函数：</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="k">if</span> <span class="p">(</span><span class="n">is_first_stage</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// 第一阶段初始化
</span><span class="ln"> 2</span><span class="c1"></span>    <span class="p">...</span>
<span class="ln"> 3</span> 
<span class="ln"> 4</span>    <span class="c1">// Set up SELinux, loading the SELinux policy.
</span><span class="ln"> 5</span><span class="c1"></span>    <span class="n">SelinuxSetupKernelLogging</span><span class="p">();</span>
<span class="ln"> 6</span>    <span class="n">SelinuxInitialize</span><span class="p">();</span>
<span class="ln"> 7</span> 
<span class="ln"> 8</span>    <span class="p">...</span>
<span class="ln"> 9</span><span class="p">}</span>
<span class="ln">10</span> 
<span class="ln">11</span> 
<span class="ln">12</span><span class="c1">// Now set up SELinux for second stage.
</span><span class="ln">13</span><span class="c1"></span><span class="n">SelinuxSetupKernelLogging</span><span class="p">();</span>
<span class="ln">14</span><span class="n">SelabelInitialize</span><span class="p">();</span>
<span class="ln">15</span><span class="n">SelinuxRestoreContext</span><span class="p">();</span>
</code></pre></div><h3 id="212selinuxcpp">2.1.2selinux.cpp</h3>
<p>代码路径：android/system/core/init/selinux.cpp</p>
<h4 id="2121selinuxsetupkernellogging">2.1.2.1SelinuxSetupKernelLogging</h4>
<p>设置log callback，可以调用selinux_log把log写入到kmsg里面</p>
<h4 id="2122selinuxinitialize">2.1.2.2SelinuxInitialize</h4>
<p>selinux 初始化，从二进制策略文件里面读取策略，加载到内核</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="kt">void</span> <span class="nf">SelinuxInitialize</span><span class="p">()</span> <span class="p">{</span>
<span class="ln"> 2</span>    <span class="n">Timer</span> <span class="n">t</span><span class="p">;</span>
<span class="ln"> 3</span> 
<span class="ln"> 4</span>    <span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Loading SELinux policy&#34;</span><span class="p">;</span>
<span class="ln"> 5</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">LoadPolicy</span><span class="p">())</span> <span class="p">{</span> <span class="c1">// 加载SELinux策略
</span><span class="ln"> 6</span><span class="c1"></span>        <span class="n">LOG</span><span class="p">(</span><span class="n">FATAL</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Unable to load SELinux policy&#34;</span><span class="p">;</span>
<span class="ln"> 7</span>    <span class="p">}</span>
<span class="ln"> 8</span> 
<span class="ln"> 9</span>    <span class="kt">bool</span> <span class="n">kernel_enforcing</span> <span class="o">=</span> <span class="p">(</span><span class="n">security_getenforce</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span> <span class="c1">// 从kernel获取SELinux的状态，和getenforce的实现一样
</span><span class="ln">10</span><span class="c1"></span>    <span class="kt">bool</span> <span class="n">is_enforcing</span> <span class="o">=</span> <span class="n">IsEnforcing</span><span class="p">();</span>  <span class="c1">// 从bootargs里面获取
</span><span class="ln">11</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">kernel_enforcing</span> <span class="o">!=</span> <span class="n">is_enforcing</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">12</span>        <span class="k">if</span> <span class="p">(</span><span class="n">security_setenforce</span><span class="p">(</span><span class="n">is_enforcing</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// 如果kernel里面的SELinux状态和bootargs的不一致，要设置成bootargs里面传过来的值
</span><span class="ln">13</span><span class="c1"></span>            <span class="n">PLOG</span><span class="p">(</span><span class="n">FATAL</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;security_setenforce(%s) failed&#34;</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">is_enforcing</span> <span class="o">?</span> <span class="s">&#34;true&#34;</span> <span class="o">:</span> <span class="s">&#34;false&#34;</span><span class="p">);</span>
<span class="ln">14</span>        <span class="p">}</span>
<span class="ln">15</span>    <span class="p">}</span>
<span class="ln">16</span> 
<span class="ln">17</span>    <span class="k">if</span> <span class="p">(</span><span class="k">auto</span> <span class="n">result</span> <span class="o">=</span> <span class="n">WriteFile</span><span class="p">(</span><span class="s">&#34;/sys/fs/selinux/checkreqprot&#34;</span><span class="p">,</span> <span class="s">&#34;0&#34;</span><span class="p">);</span> <span class="o">!</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// 由内核强制执行检查保护
</span><span class="ln">18</span><span class="c1"></span>        <span class="n">LOG</span><span class="p">(</span><span class="n">FATAL</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Unable to write to /sys/fs/selinux/checkreqprot: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">result</span><span class="p">.</span><span class="n">error</span><span class="p">();</span>
<span class="ln">19</span>    <span class="p">}</span>
<span class="ln">20</span> 
<span class="ln">21</span>    <span class="c1">// init&#39;s first stage can&#39;t set properties, so pass the time to the second stage.
</span><span class="ln">22</span><span class="c1"></span>    <span class="n">setenv</span><span class="p">(</span><span class="s">&#34;INIT_SELINUX_TOOK&#34;</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">duration</span><span class="p">().</span><span class="n">count</span><span class="p">()).</span><span class="n">c_str</span><span class="p">(),</span> <span class="mi">1</span><span class="p">);</span>
<span class="ln">23</span><span class="p">}</span>
<span class="ln">24</span> 
<span class="ln">25</span><span class="kt">bool</span> <span class="nf">LoadPolicy</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// 从Android8.0之后，因为Project Treble，system和vendor策略分离，所以Android P上走的是LoadSplitPolicy
</span><span class="ln">26</span><span class="c1"></span>    <span class="k">return</span> <span class="n">IsSplitPolicyDevice</span><span class="p">()</span> <span class="o">?</span> <span class="n">LoadSplitPolicy</span><span class="p">()</span> <span class="o">:</span> <span class="n">LoadMonolithicPolicy</span><span class="p">();</span>
<span class="ln">27</span><span class="p">}</span>
</code></pre></div><p>IsEnforcing 从bootargs里面的androidboot.selinux取值; security_getenforce 从kernel取值，这个值和getenforce拿到的是一样的</p>
<h4 id="2123-checkreqprot">2.1.2.3 checkreqprot</h4>
<p>设置&quot;checkreqprot&quot;标记的初始值。</p>
<p>&ldquo;0&quot;表示由内核强制执行检查保护(包括其中隐含的所有执行保护)</p>
<p>&ldquo;1&quot;表示由应用程序自己主动请求执行检查保护</p>
<p>默认值由内核在编译时确定，也可以在运行时通过/sys/fs/selinux/checkreqprot修改</p>
<h4 id="2124-loadpolicy">2.1.2.4 LoadPolicy</h4>
<p>policy的分割是从Android 8.0之后开始的，</p>
<p>Android低版本用的是LoadMonolithicPolicy，8.0之后调用的是LoadSplitPolicy</p>
<p>sepolicy分离</p>
<blockquote>
<p>#public - policy exported on which non-platform policy developers may write
#additional policy. types and attributes are versioned and included in
#delivered non-platform policy, which is to be combined with platform policy. 导出的策略，非平台策略开发人员可以在其上编写附加策略
类型和属性被版本化并包含在交付的非平台策略中，该策略将与平台策略相结合
使用BOARD_PLAT_PUBLIC_SEPOLICY_DIR来添加拓展</p>
</blockquote>
<p>types和attributes生成在vendor分区的会带上版本，比如bootanim_30_0，实现在cil_android_attributize</p>
<blockquote>
<p>#private - platform-only policy required for platform functionality but which
#is not exported to vendor policy developers and as such may not be assumed
#to exist. 平台功能所需的纯平台策略，但不会导出到供应商策略开发人员，因此可能不存在。</p>
</blockquote>
<blockquote>
<p>#vendor - vendor-only policy required for vendor functionality. This policy can
#reference the public policy but cannot reference the private policy. This
#policy is for components which are produced from the core/non-vendor tree and
#placed into a vendor partition. 供应商功能所需的供应商专用策略。此策略可以引用公共策略，但不能引用私有策略。此策略适用于从核心/非供应商树生成并放置到供应商分区中的组件。</p>
</blockquote>
<blockquote>
<p>#mapping - This contains policy statements which map the attributes
#exposed in the public policy of previous versions to the concrete types used
#in this policy to ensure that policy targeting attributes from public
#policy from an older platform version continues to work. 它包含策略语句，这些语句将以前版本的公共策略中公开的属性映射到此策略中使用的具体类型，以确保来自较旧平台版本的公共策略的策略目标属性继续工作。</p>
</blockquote>
<h4 id="2125loadsplitpolicy">2.1.2.5LoadSplitPolicy</h4>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln">  1</span><span class="kt">bool</span> <span class="nf">LoadSplitPolicy</span><span class="p">()</span> <span class="p">{</span>
<span class="ln">  2</span>    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">precompiled_sepolicy_file</span><span class="p">;</span>
<span class="ln">  3</span>    <span class="k">if</span> <span class="p">(</span><span class="n">FindPrecompiledSplitPolicy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">precompiled_sepolicy_file</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// 先找odm分区，再找vendor分区
</span><span class="ln">  4</span><span class="c1"></span>        <span class="n">unique_fd</span> <span class="n">fd</span><span class="p">(</span><span class="n">open</span><span class="p">(</span><span class="n">precompiled_sepolicy_file</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">O_RDONLY</span> <span class="o">|</span> <span class="n">O_CLOEXEC</span> <span class="o">|</span> <span class="n">O_BINARY</span><span class="p">));</span>  <span class="c1">// open file
</span><span class="ln">  5</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">  6</span>            <span class="k">if</span> <span class="p">(</span><span class="n">selinux_android_load_policy_from_fd</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">precompiled_sepolicy_file</span><span class="p">.</span><span class="n">c_str</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 加载到kernel
</span><span class="ln">  7</span><span class="c1"></span>                <span class="n">LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Failed to load SELinux policy from &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">precompiled_sepolicy_file</span><span class="p">;</span>
<span class="ln">  8</span>                <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="ln">  9</span>            <span class="p">}</span>
<span class="ln"> 10</span>            <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="ln"> 11</span>        <span class="p">}</span>
<span class="ln"> 12</span>    <span class="p">}</span>
<span class="ln"> 13</span>    <span class="c1">// No suitable precompiled policy could be loaded
</span><span class="ln"> 14</span><span class="c1"></span> 
<span class="ln"> 15</span>    <span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Compiling SELinux policy&#34;</span><span class="p">;</span>
<span class="ln"> 16</span> 
<span class="ln"> 17</span>    <span class="c1">// Determine the highest policy language version supported by the kernel
</span><span class="ln"> 18</span><span class="c1"></span>    <span class="n">set_selinuxmnt</span><span class="p">(</span><span class="s">&#34;/sys/fs/selinux&#34;</span><span class="p">);</span>
<span class="ln"> 19</span>    <span class="kt">int</span> <span class="n">max_policy_version</span> <span class="o">=</span> <span class="n">security_policyvers</span><span class="p">();</span>
<span class="ln"> 20</span>    <span class="k">if</span> <span class="p">(</span><span class="n">max_policy_version</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 21</span>        <span class="n">PLOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Failed to determine highest policy version supported by kernel&#34;</span><span class="p">;</span>
<span class="ln"> 22</span>        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="ln"> 23</span>    <span class="p">}</span>
<span class="ln"> 24</span> 
<span class="ln"> 25</span>    <span class="c1">// We store the output of the compilation on /dev because this is the most convenient tmpfs
</span><span class="ln"> 26</span><span class="c1"></span>    <span class="c1">// storage mount available this early in the boot sequence.
</span><span class="ln"> 27</span><span class="c1"></span>    <span class="kt">char</span> <span class="n">compiled_sepolicy</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&#34;/dev/sepolicy.XXXXXX&#34;</span><span class="p">;</span>
<span class="ln"> 28</span>    <span class="n">unique_fd</span> <span class="n">compiled_sepolicy_fd</span><span class="p">(</span><span class="n">mkostemp</span><span class="p">(</span><span class="n">compiled_sepolicy</span><span class="p">,</span> <span class="n">O_CLOEXEC</span><span class="p">));</span>
<span class="ln"> 29</span>    <span class="k">if</span> <span class="p">(</span><span class="n">compiled_sepolicy_fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 30</span>        <span class="n">PLOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Failed to create temporary file &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">compiled_sepolicy</span><span class="p">;</span>
<span class="ln"> 31</span>        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="ln"> 32</span>    <span class="p">}</span>
<span class="ln"> 33</span> 
<span class="ln"> 34</span>    <span class="c1">// Determine which mapping file to include
</span><span class="ln"> 35</span><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">vend_plat_vers</span><span class="p">;</span>
<span class="ln"> 36</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">GetVendorMappingVersion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vend_plat_vers</span><span class="p">))</span> <span class="p">{</span>
<span class="ln"> 37</span>        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="ln"> 38</span>    <span class="p">}</span>
<span class="ln"> 39</span>    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">mapping_file</span><span class="p">(</span><span class="s">&#34;/system/etc/selinux/mapping/&#34;</span> <span class="o">+</span> <span class="n">vend_plat_vers</span> <span class="o">+</span> <span class="s">&#34;.cil&#34;</span><span class="p">);</span>
<span class="ln"> 40</span> 
<span class="ln"> 41</span>    <span class="c1">// vendor_sepolicy.cil and plat_pub_versioned.cil are the new design to replace
</span><span class="ln"> 42</span><span class="c1"></span>    <span class="c1">// nonplat_sepolicy.cil.
</span><span class="ln"> 43</span><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">plat_pub_versioned_cil_file</span><span class="p">(</span><span class="s">&#34;/vendor/etc/selinux/plat_pub_versioned.cil&#34;</span><span class="p">);</span>
<span class="ln"> 44</span>    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">vendor_policy_cil_file</span><span class="p">(</span><span class="s">&#34;/vendor/etc/selinux/vendor_sepolicy.cil&#34;</span><span class="p">);</span>
<span class="ln"> 45</span> 
<span class="ln"> 46</span>    <span class="k">if</span> <span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">vendor_policy_cil_file</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">F_OK</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 47</span>        <span class="c1">// For backward compatibility.
</span><span class="ln"> 48</span><span class="c1"></span>        <span class="c1">// TODO: remove this after no device is using nonplat_sepolicy.cil.
</span><span class="ln"> 49</span><span class="c1"></span>        <span class="n">vendor_policy_cil_file</span> <span class="o">=</span> <span class="s">&#34;/vendor/etc/selinux/nonplat_sepolicy.cil&#34;</span><span class="p">;</span>
<span class="ln"> 50</span>        <span class="n">plat_pub_versioned_cil_file</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="ln"> 51</span>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">plat_pub_versioned_cil_file</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">F_OK</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 52</span>        <span class="n">LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Missing &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">plat_pub_versioned_cil_file</span><span class="p">;</span>
<span class="ln"> 53</span>        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="ln"> 54</span>    <span class="p">}</span>
<span class="ln"> 55</span> 
<span class="ln"> 56</span>    <span class="c1">// odm_sepolicy.cil is default but optional.
</span><span class="ln"> 57</span><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">odm_policy_cil_file</span><span class="p">(</span><span class="s">&#34;/odm/etc/selinux/odm_sepolicy.cil&#34;</span><span class="p">);</span>
<span class="ln"> 58</span>    <span class="k">if</span> <span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">odm_policy_cil_file</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">F_OK</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 59</span>        <span class="n">odm_policy_cil_file</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="ln"> 60</span>    <span class="p">}</span>
<span class="ln"> 61</span>    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">version_as_string</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">max_policy_version</span><span class="p">);</span>
<span class="ln"> 62</span> 
<span class="ln"> 63</span>    <span class="c1">// clang-format off
</span><span class="ln"> 64</span><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="k">const</span> <span class="kt">char</span><span class="o">*&gt;</span> <span class="n">compile_args</span> <span class="p">{</span>
<span class="ln"> 65</span>        <span class="s">&#34;/system/bin/secilc&#34;</span><span class="p">,</span>
<span class="ln"> 66</span>        <span class="n">plat_policy_cil_file</span><span class="p">,</span>
<span class="ln"> 67</span>        <span class="s">&#34;-m&#34;</span><span class="p">,</span> <span class="s">&#34;-M&#34;</span><span class="p">,</span> <span class="s">&#34;true&#34;</span><span class="p">,</span> <span class="s">&#34;-G&#34;</span><span class="p">,</span> <span class="s">&#34;-N&#34;</span><span class="p">,</span>
<span class="ln"> 68</span>        <span class="c1">// Target the highest policy language version supported by the kernel
</span><span class="ln"> 69</span><span class="c1"></span>        <span class="s">&#34;-c&#34;</span><span class="p">,</span> <span class="n">version_as_string</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span>
<span class="ln"> 70</span>        <span class="n">mapping_file</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span>
<span class="ln"> 71</span>        <span class="s">&#34;-o&#34;</span><span class="p">,</span> <span class="n">compiled_sepolicy</span><span class="p">,</span>
<span class="ln"> 72</span>        <span class="c1">// We don&#39;t care about file_contexts output by the compiler
</span><span class="ln"> 73</span><span class="c1"></span>        <span class="s">&#34;-f&#34;</span><span class="p">,</span> <span class="s">&#34;/sys/fs/selinux/null&#34;</span><span class="p">,</span>  <span class="c1">// /dev/null is not yet available
</span><span class="ln"> 74</span><span class="c1"></span>    <span class="p">};</span>
<span class="ln"> 75</span>    <span class="c1">// clang-format on
</span><span class="ln"> 76</span><span class="c1"></span> 
<span class="ln"> 77</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plat_pub_versioned_cil_file</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
<span class="ln"> 78</span>        <span class="n">compile_args</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">plat_pub_versioned_cil_file</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="ln"> 79</span>    <span class="p">}</span>
<span class="ln"> 80</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vendor_policy_cil_file</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
<span class="ln"> 81</span>        <span class="n">compile_args</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">vendor_policy_cil_file</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="ln"> 82</span>    <span class="p">}</span>
<span class="ln"> 83</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">odm_policy_cil_file</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
<span class="ln"> 84</span>        <span class="n">compile_args</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">odm_policy_cil_file</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="ln"> 85</span>    <span class="p">}</span>
<span class="ln"> 86</span>    <span class="n">compile_args</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="k">nullptr</span><span class="p">);</span>
<span class="ln"> 87</span> 
<span class="ln"> 88</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ForkExecveAndWaitForCompletion</span><span class="p">(</span><span class="n">compile_args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="kt">char</span><span class="o">**</span><span class="p">)</span><span class="n">compile_args</span><span class="p">.</span><span class="n">data</span><span class="p">()))</span> <span class="p">{</span>
<span class="ln"> 89</span>        <span class="n">unlink</span><span class="p">(</span><span class="n">compiled_sepolicy</span><span class="p">);</span>
<span class="ln"> 90</span>        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="ln"> 91</span>    <span class="p">}</span>
<span class="ln"> 92</span>    <span class="n">unlink</span><span class="p">(</span><span class="n">compiled_sepolicy</span><span class="p">);</span>
<span class="ln"> 93</span> 
<span class="ln"> 94</span>    <span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Loading compiled SELinux policy&#34;</span><span class="p">;</span>
<span class="ln"> 95</span>    <span class="k">if</span> <span class="p">(</span><span class="n">selinux_android_load_policy_from_fd</span><span class="p">(</span><span class="n">compiled_sepolicy_fd</span><span class="p">,</span> <span class="n">compiled_sepolicy</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 96</span>        <span class="n">LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Failed to load SELinux policy from &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">compiled_sepolicy</span><span class="p">;</span>
<span class="ln"> 97</span>        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="ln"> 98</span>    <span class="p">}</span>
<span class="ln"> 99</span> 
<span class="ln">100</span>    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="ln">101</span><span class="p">}</span>
</code></pre></div><p>LoadSplitPolicy 加载selinux 策略时，首先从预先编译好的二进制文件precompiled_sepolicy读取</p>
<p>如果没有找到的话，再用secilc命令编译所有的cil，重新得到一个二进制策略文件</p>
<h4 id="2126findprecompiledsplitpolicy">2.1.2.6FindPrecompiledSplitPolicy</h4>
<p>这个函数会查找两个地方，/odm/etc/selinux和/vendor/etc/selinux</p>
<ul>
<li>/vendor/etc/selinux/precompiled_sepolicy</li>
<li>/odm/etc/selinux/precompiled_sepolicy</li>
</ul>
<p>如果有odm分区，precompiled_sepolicy会放在odm分区，否则在vendor分区，因此读取的时候也是先找odm再找vendor</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="kt">bool</span> <span class="nf">FindPrecompiledSplitPolicy</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">*</span> <span class="n">file</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 2</span>    <span class="n">file</span><span class="o">-&gt;</span><span class="n">clear</span><span class="p">();</span>
<span class="ln"> 3</span>    <span class="c1">// If there is an odm partition, precompiled_sepolicy will be in
</span><span class="ln"> 4</span><span class="c1"></span>    <span class="c1">// odm/etc/selinux. Otherwise it will be in vendor/etc/selinux.
</span><span class="ln"> 5</span><span class="c1"></span>    <span class="k">static</span> <span class="k">constexpr</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">vendor_precompiled_sepolicy</span><span class="p">[]</span> <span class="o">=</span>
<span class="ln"> 6</span>        <span class="s">&#34;/vendor/etc/selinux/precompiled_sepolicy&#34;</span><span class="p">;</span>
<span class="ln"> 7</span>    <span class="k">static</span> <span class="k">constexpr</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">odm_precompiled_sepolicy</span><span class="p">[]</span> <span class="o">=</span>
<span class="ln"> 8</span>        <span class="s">&#34;/odm/etc/selinux/precompiled_sepolicy&#34;</span><span class="p">;</span>
<span class="ln"> 9</span>    <span class="k">if</span> <span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">odm_precompiled_sepolicy</span><span class="p">,</span> <span class="n">R_OK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">10</span>        <span class="o">*</span><span class="n">file</span> <span class="o">=</span> <span class="n">odm_precompiled_sepolicy</span><span class="p">;</span>
<span class="ln">11</span>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">vendor_precompiled_sepolicy</span><span class="p">,</span> <span class="n">R_OK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">12</span>        <span class="o">*</span><span class="n">file</span> <span class="o">=</span> <span class="n">vendor_precompiled_sepolicy</span><span class="p">;</span>
<span class="ln">13</span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="ln">14</span>        <span class="n">PLOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;No precompiled sepolicy&#34;</span><span class="p">;</span>
<span class="ln">15</span>        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="ln">16</span>    <span class="p">}</span>
<span class="ln">17</span> 
<span class="ln">18</span>        <span class="c1">// 接下来下面会对哈希值做校验，分别是：
</span><span class="ln">19</span><span class="c1"></span>    <span class="c1">// /system/etc/selinux/plat_and_mapping_sepolicy.cil.sha256
</span><span class="ln">20</span><span class="c1"></span>    <span class="c1">// /vendor/etc/selinux/precompiled_sepolicy.plat_and_mapping.sha256
</span><span class="ln">21</span><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">actual_plat_id</span><span class="p">;</span>
<span class="ln">22</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ReadFirstLine</span><span class="p">(</span><span class="s">&#34;/system/etc/selinux/plat_and_mapping_sepolicy.cil.sha256&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">actual_plat_id</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">23</span>        <span class="n">PLOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Failed to read &#34;</span>
<span class="ln">24</span>                      <span class="s">&#34;/system/etc/selinux/plat_and_mapping_sepolicy.cil.sha256&#34;</span><span class="p">;</span>
<span class="ln">25</span>        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="ln">26</span>    <span class="p">}</span>
<span class="ln">27</span> 
<span class="ln">28</span>    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">precompiled_plat_id</span><span class="p">;</span>
<span class="ln">29</span>    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">precompiled_sha256</span> <span class="o">=</span> <span class="o">*</span><span class="n">file</span> <span class="o">+</span> <span class="s">&#34;.plat_and_mapping.sha256&#34;</span><span class="p">;</span>
<span class="ln">30</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ReadFirstLine</span><span class="p">(</span><span class="n">precompiled_sha256</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">precompiled_plat_id</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">31</span>        <span class="n">PLOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Failed to read &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">precompiled_sha256</span><span class="p">;</span>
<span class="ln">32</span>        <span class="n">file</span><span class="o">-&gt;</span><span class="n">clear</span><span class="p">();</span>
<span class="ln">33</span>        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="ln">34</span>    <span class="p">}</span>
<span class="ln">35</span>    <span class="k">if</span> <span class="p">((</span><span class="n">actual_plat_id</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="o">||</span> <span class="p">(</span><span class="n">actual_plat_id</span> <span class="o">!=</span> <span class="n">precompiled_plat_id</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">36</span>        <span class="n">file</span><span class="o">-&gt;</span><span class="n">clear</span><span class="p">();</span>
<span class="ln">37</span>        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="ln">38</span>    <span class="p">}</span>
<span class="ln">39</span>    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="ln">40</span><span class="p">}</span>
</code></pre></div><p>最后面会对哈希值做一个校验，这两个文件都是编译阶段生成的</p>
<p>后面我们局部编译SELinux策略文件时，一定要注意只替换precompiled_sepolicy就行了</p>
<p>千万不要同时替换precompiled_sepolicy 和 precompiled_sepolicy.plat_and_mapping.sha256，而忘记了/system/etc/selinux/plat_and_mapping_sepolicy.cil.sha256，这个会导致你替换的策略文件不生效</p>
<h2 id="22selinux-policy编译">2.2SELinux Policy编译</h2>
<h3 id="221二进制策略文件的生成过程">2.2.1二进制策略文件的生成过程</h3>
<p>本节涉及的代码集中在：</p>
<ul>
<li>android/system/sepolicy/Android.mk</li>
<li>android/external/selinux/secilc</li>
<li>android/external/selinux/checkpolicy</li>
<li>android/external/selinux/libselinux</li>
<li>android/external/selinux/libsepol</li>
</ul>
<p>其中Android mk中的一些变量：</p>
<div class="highlight"><pre class="chroma"><code class="language-makefile" data-lang="makefile"><span class="ln">1</span><span class="nv">PLAT_PUBLIC_POLICY</span><span class="o">=</span>system/sepolicy/public
<span class="ln">2</span><span class="nv">PLAT_PRIVATE_POLICY</span><span class="o">=</span>system/sepolicy/private
<span class="ln">3</span><span class="nv">PLAT_VENDOR_POLICY</span><span class="o">=</span>system/sepolicy/vendor
<span class="ln">4</span><span class="nv">REQD_MASK_POLICY</span><span class="o">=</span>system/sepolicy/reqd_mask
<span class="ln">5</span><span class="err">BOARD_PLAT_PUBLIC_SEPOLICY_DIR</span>    <span class="c">#对PLAT_PUBLIC_POLICY的拓展
</span><span class="ln">6</span><span class="c"></span><span class="err">BOARD_PLAT_PRIVATE_SEPOLICY_DIR</span>   <span class="c">#对PLAT_PRIVATE_POLICY的拓展
</span><span class="ln">7</span><span class="c"></span> 
<span class="ln">8</span><span class="err">BOARD_SEPOLICY_DIRS</span>  <span class="c">#设备制造商客制化部分的策略文件
</span></code></pre></div><h3 id="2211-precompiled_sepolicy是如何生成的">2.2.1.1 precompiled_sepolicy是如何生成的？</h3>
<p>先看总的流程：</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/SElinux/selinux_3.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/SElinux/selinux_3.png" >
  
    </a>
  
  
</div>

<p>1）如果定义了BOARD_ODM_SEPOLICY_DIRS，那么还会有一个odm_sepolicy.cil，当然前提还要有odm分区</p>
<div class="highlight"><pre class="chroma"><code class="language-makefile" data-lang="makefile"><span class="ln">1</span><span class="err">ifdef</span> <span class="err">BOARD_ODM_SEPOLICY_DIRS</span>
<span class="ln">2</span>    <span class="nv">all_cil_files</span> <span class="o">+=</span> <span class="k">$(</span>built_odm_cil<span class="k">)</span>
<span class="ln">3</span><span class="err">endif</span>
</code></pre></div><p>在 android/system/sepolicy/Android.mk 的注释里面，提到了SELinux策略文件编译成二进制策略文件的过程</p>
<blockquote>
<p>这里面主要包含设置的几种类型文件，context和xml文件，其中xml是加了密的文件，通常会放到设备的类似/system/etc/selinux，/vendor/etc/selinux，/product/etc/selinux等。</p>
<table>
<thead>
<tr>
<th style="text-align:center">context名称</th>
<th style="text-align:center">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">file_contexts</td>
<td style="text-align:center">系统中所有file_contexts上下文</td>
</tr>
<tr>
<td style="text-align:center">genfs_contexts</td>
<td style="text-align:center">虚拟文件的安全上下文</td>
</tr>
<tr>
<td style="text-align:center">seapp_contexts</td>
<td style="text-align:center">app安全上下文</td>
</tr>
<tr>
<td style="text-align:center">property_contexts</td>
<td style="text-align:center">属性安全上下文</td>
</tr>
<tr>
<td style="text-align:center">service_contexts</td>
<td style="text-align:center">服务文件安全上下文</td>
</tr>
</tbody>
</table>
</blockquote>
<p>2）第二步，是针对30.0.cil、plat_pub_versioned.cil、vendor_sepolicy.cil，而plat_sepolicy.cil不需要</p>
<p>并且，只有在system/sepolicy/public、system/sepolicy/private下定义的types和attributes才会有加上这个版本后缀</p>
<p>调用过程 (build_sepolicy -&gt; ) version_policy -&gt; cil_android_attributize</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text"><span class="ln"> 1</span># build process for device:
<span class="ln"> 2</span># 1) convert policies to CIL:
<span class="ln"> 3</span>#    - private + public platform policy to CIL
<span class="ln"> 4</span>#    - mapping file to CIL (should already be in CIL form)
<span class="ln"> 5</span>#    - non-platform public policy to CIL
<span class="ln"> 6</span>#    - non-platform public + private policy to CIL
<span class="ln"> 7</span># 2) attributize policy
<span class="ln"> 8</span>#    - run script which takes non-platform public and non-platform combined
<span class="ln"> 9</span>#      private + public policy and produces attributized and versioned
<span class="ln">10</span>#      non-platform policy
<span class="ln">11</span># 3) combine policy files
<span class="ln">12</span>#    - combine mapping, platform and non-platform policy.
<span class="ln">13</span>#    - compile output binary policy file
</code></pre></div><blockquote>
<p>ACP描述的是一个Android专用的cp命令，在生成system.img镜像文件的过程中是需要用到的。普通的cp命令在不同的平台（Mac
OSX、MinGW/Cygwin和Linux）的实现略有差异，并且可能会导致一些问题，于是Android编译系统就重写了自己的cp命令，使得它在不同平台下执行具有统一的行为，并且解决普通cp命令可能会出现的问题。例如，在Linux平台上，当我们把一个文件从NFS文件系统拷贝到本地文件系统时，普通的cp命令总是会认为在NFS文件系统上的文件比在本地文件系统上的文件要新，因为前者的时间戳精度是微秒，而后者的时间戳精度不是微秒。Android专用的cp命令源码可以参考build/tools/acp目录。具体可以点击<a href="https://blog.csdn.net/kc58236582/article/details/49795865">这里</a>。</p>
</blockquote>
<p>3）分析Android.mk文件： android/system/sepolicy/Android.mk</p>
<p>BOARD_USES_ODMIMAGE 在 BoardConfig.mk 里面定义</p>
<p>这个是决定是否有odm分区，如果带odm分区，那么路径就在odm分区</p>
<div class="highlight"><pre class="chroma"><code class="language-makefile" data-lang="makefile"><span class="ln"> 1</span><span class="nv">LOCAL_MODULE</span> <span class="o">:=</span> precompiled_sepolicy
<span class="ln"> 2</span><span class="nv">LOCAL_MODULE_CLASS</span> <span class="o">:=</span> ETC
<span class="ln"> 3</span><span class="nv">LOCAL_MODULE_TAGS</span> <span class="o">:=</span> optional
<span class="ln"> 4</span><span class="nv">LOCAL_PROPRIETARY_MODULE</span> <span class="o">:=</span> <span class="nb">true</span>
<span class="ln"> 5</span> 
<span class="ln"> 6</span><span class="err">ifeq</span> <span class="err">(</span><span class="k">$(</span><span class="nv">BOARD_USES_ODMIMAGE</span><span class="k">)</span><span class="err">,true)</span>
<span class="ln"> 7</span><span class="nv">LOCAL_MODULE_PATH</span> <span class="o">:=</span> <span class="k">$(</span>TARGET_OUT_ODM<span class="k">)</span>/etc/selinux
<span class="ln"> 8</span><span class="err">else</span>
<span class="ln"> 9</span><span class="nv">LOCAL_MODULE_PATH</span> <span class="o">:=</span> <span class="k">$(</span>TARGET_OUT_VENDOR<span class="k">)</span>/etc/selinux
<span class="ln">10</span><span class="err">endif</span>
</code></pre></div><p>首先它依赖的是这些cil文件（CIL : Common Intermediate Language，通用中间语言）</p>
<ul>
<li>/system/etc/selinux/plat_sepolicy.cil</li>
<li>/system/etc/selinux/mapping/30.0.cil</li>
<li>/vendor/etc/selinux/plat_pub_versioned.cil</li>
<li>/vendor/etc/selinux/vendor_sepolicy.cil</li>
</ul>
<p>4）接着是通过secilc命令来生成precompiled_sepolicy</p>
<div class="highlight"><pre class="chroma"><code class="language-makefile" data-lang="makefile"><span class="ln">1</span><span class="nv">built_device</span><span class="o">=</span>xxxx
<span class="ln">2</span><span class="nv">built_plat_cil</span><span class="o">=</span>out/target/product/<span class="si">${</span><span class="nv">built_device</span><span class="si">}</span>/obj/ETC/plat_sepolicy.cil_intermediates/plat_sepolicy.cil
<span class="ln">3</span><span class="nv">built_mapping_cil</span><span class="o">=</span>out/target/product/<span class="si">${</span><span class="nv">built_device</span><span class="si">}</span>/obj/ETC/30.0.cil_intermediates/30.0.cil
<span class="ln">4</span><span class="nv">built_plat_pub_vers_cil</span><span class="o">=</span>out/target/product/<span class="si">${</span><span class="nv">built_device</span><span class="si">}</span>/obj/ETC/plat_pub_versioned.cil_intermediates/plat_pub_versioned.cil
<span class="ln">5</span><span class="nv">built_vendor_cil</span><span class="o">=</span>out/target/product/<span class="si">${</span><span class="nv">built_device</span><span class="si">}</span>/obj/ETC/vendor_sepolicy.cil_intermediates/vendor_sepolicy.cil
<span class="ln">6</span> 
<span class="ln">7</span><span class="err">secilc</span> <span class="err">-m</span> <span class="err">-M</span> <span class="err">true</span> <span class="err">-G</span> <span class="err">-c</span> <span class="err">30</span> <span class="err">${built_plat_cil}</span> <span class="err">${built_mapping_cil}</span> <span class="err">${built_plat_pub_vers_cil}</span> <span class="err">${built_vendor_cil}</span> <span class="err">-o</span> <span class="err">precompiled_sepolicy</span> <span class="err">-f</span> <span class="err">/dev/null</span>
</code></pre></div><p>secilc的源码在：android/external/selinux/secilc</p>
<p>secilc是用来编译cil中间文件的，将其生成二进制文件的</p>
<p>代码中有文档，其中有一张图片对于理解secilc非常重要</p>
<p>android/external/selinux/secilc/docs/cil_design.jpeg</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/SElinux/selinux_4.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/SElinux/selinux_4.png" >
  
    </a>
  
  
</div>

<blockquote>
<p>The parse tree consists of open parenthesis nodes and nodes for each symbol or quoted strings. An open parenthesis is the parent of the symbols or quoted strings that follow it, until a closed parenthesis is reached.Close parenthesis and comments do not make it into the parse tree.</p>
<p>解析树由开放的括号节点和每个符号或带引号的字符串的节点组成。开括号是紧随其后的符号或带引号的字符串的父代，直到达到闭括号为止。闭括号和注释不将其放入语法分析树中。</p>
<p>The cil_build_ast function walks the parse tree and creates the ast. The first node in each list is checked for keywords,and ast nodes are created containing the data structures corresponding to the keyword. Only declarations are handled in this step.Delared symbols are add to symtabs for each node flavor, and in local or global namespace symtabs.Strings for symbols that are references(not declarations) are copied into the ast, and will be resolved later.The parse tree should be destroyed following this step. cil_build_ast</p>
<p>函数遍历解析树并创建ast。检查每个列表中的第一个节点是否包含关键字，并创建包含与关键字相对应的数据结构的ast节点。
在此步骤中仅处理声明。对于每个节点类型，将符号添加到符号表中，并在本地或全局名称空间中将符号表添加。将引用（非声明）符号的字符串复制到ast中，稍后将对其进行解析。此步骤之后，应该销毁解析树。</p>
</blockquote>
<p>5）每一个cil是如何生成的
拿其中一个来看看：plat_sepolicy.cil</p>
<div class="highlight"><pre class="chroma"><code class="language-makefile" data-lang="makefile"><span class="ln"> 1</span><span class="err">include</span> <span class="k">$(</span><span class="nv">CLEAR_VARS</span><span class="k">)</span>
<span class="ln"> 2</span>
<span class="ln"> 3</span><span class="nv">LOCAL_MODULE</span> <span class="o">:=</span> plat_sepolicy.cil
<span class="ln"> 4</span><span class="nv">LOCAL_MODULE_CLASS</span> <span class="o">:=</span> ETC
<span class="ln"> 5</span><span class="nv">LOCAL_MODULE_TAGS</span> <span class="o">:=</span> optional
<span class="ln"> 6</span><span class="nv">LOCAL_MODULE_PATH</span> <span class="o">:=</span> <span class="k">$(</span>TARGET_OUT<span class="k">)</span>/etc/selinux
<span class="ln"> 7</span>
<span class="ln"> 8</span><span class="err">include</span> <span class="k">$(</span><span class="nv">BUILD_SYSTEM</span><span class="k">)</span><span class="err">/base_rules.mk</span>
<span class="ln"> 9</span>
<span class="ln">10</span><span class="nv">plat_policy.conf</span> <span class="o">:=</span> <span class="k">$(</span>intermediates<span class="k">)</span>/plat_policy.conf
<span class="ln">11</span><span class="nf">$(plat_policy.conf)</span><span class="o">:</span> <span class="n">PRIVATE_MLS_SENS</span> := <span class="k">$(</span><span class="nv">MLS_SENS</span><span class="k">)</span>
<span class="ln">12</span><span class="nf">$(plat_policy.conf)</span><span class="o">:</span> <span class="n">PRIVATE_MLS_CATS</span> := <span class="k">$(</span><span class="nv">MLS_CATS</span><span class="k">)</span>
<span class="ln">13</span><span class="nf">$(plat_policy.conf)</span><span class="o">:</span> <span class="n">PRIVATE_TARGET_BUILD_VARIANT</span> := <span class="k">$(</span><span class="nv">TARGET_BUILD_VARIANT</span><span class="k">)</span>
<span class="ln">14</span><span class="nf">$(plat_policy.conf)</span><span class="o">:</span> <span class="n">PRIVATE_TGT_ARCH</span> := <span class="k">$(</span><span class="nv">my_target_arch</span><span class="k">)</span>
<span class="ln">15</span><span class="nf">$(plat_policy.conf)</span><span class="o">:</span> <span class="n">PRIVATE_TGT_WITH_ASAN</span> := <span class="k">$(</span><span class="nv">with_asan</span><span class="k">)</span>
<span class="ln">16</span><span class="nf">$(plat_policy.conf)</span><span class="o">:</span> <span class="n">PRIVATE_ADDITIONAL_M</span>4<span class="n">DEFS</span> := <span class="k">$(</span><span class="nv">LOCAL_ADDITIONAL_M</span>4<span class="nv">DEFS</span><span class="k">)</span>
<span class="ln">17</span><span class="nf">$(plat_policy.conf)</span><span class="o">:</span> <span class="n">PRIVATE_SEPOLICY_SPLIT</span> := <span class="k">$(</span><span class="nv">PRODUCT_SEPOLICY_SPLIT</span><span class="k">)</span>
<span class="ln">18</span><span class="nf">$(plat_policy.conf)</span><span class="o">:</span> <span class="n">PRIVATE_COMPATIBLE_PROPERTY</span> := <span class="k">$(</span><span class="nv">PRODUCT_COMPATIBLE_PROPERTY</span><span class="k">)</span>
<span class="ln">19</span><span class="nf">$(plat_policy.conf)</span><span class="o">:</span> <span class="k">$(</span><span class="nv">call</span> <span class="nv">build_policy</span>, <span class="k">$(</span><span class="nv">sepolicy_build_files</span><span class="k">)</span>, \
<span class="ln">20</span><span class="k">$(</span><span class="nv">PLAT_PUBLIC_POLICY</span><span class="k">)</span> <span class="k">$(</span><span class="nv">PLAT_PRIVATE_POLICY</span><span class="k">))</span>
<span class="ln">21</span>	<span class="k">$(</span>transform-policy-to-conf<span class="k">)</span>
<span class="ln">22</span>    <span class="k">$(</span>hide<span class="k">)</span> sed <span class="s1">&#39;/dontaudit/d&#39;</span> <span class="nv">$@</span> &gt; <span class="nv">$@</span>.dontaudit
<span class="ln">23</span>
<span class="ln">24</span><span class="nf">$(LOCAL_BUILT_MODULE)</span><span class="o">:</span> <span class="n">PRIVATE_ADDITIONAL_CIL_FILES</span> := \
<span class="ln">25</span>  <span class="k">$(</span><span class="nv">call</span> <span class="nv">build_policy</span>, <span class="k">$(</span><span class="nv">sepolicy_build_cil_workaround_files</span><span class="k">)</span>, <span class="k">$(</span><span class="nv">PLAT_PRIVATE_POLICY</span><span class="k">))</span>
<span class="ln">26</span><span class="nf">$(LOCAL_BUILT_MODULE)</span><span class="o">:</span> <span class="n">PRIVATE_NEVERALLOW_ARG</span> := <span class="k">$(</span><span class="nv">NEVERALLOW_ARG</span><span class="k">)</span>
<span class="ln">27</span><span class="nf">$(LOCAL_BUILT_MODULE)</span><span class="o">:</span> <span class="k">$(</span><span class="nv">plat_policy</span>.<span class="nv">conf</span><span class="k">)</span> <span class="k">$(</span><span class="nv">HOST_OUT_EXECUTABLES</span><span class="k">)</span>/<span class="n">checkpolicy</span> \
<span class="ln">28</span>  <span class="k">$(</span><span class="nv">HOST_OUT_EXECUTABLES</span><span class="k">)</span>/<span class="n">secilc</span> \
<span class="ln">29</span>  <span class="k">$(</span><span class="nv">call</span> <span class="nv">build_policy</span>, <span class="k">$(</span><span class="nv">sepolicy_build_cil_workaround_files</span><span class="k">)</span>, <span class="k">$(</span><span class="nv">PLAT_PRIVATE_POLICY</span><span class="k">))</span> \
<span class="ln">30</span>  <span class="k">$(</span><span class="nv">built_sepolicy_neverallows</span><span class="k">)</span>
<span class="ln">31</span>	@mkdir -p <span class="k">$(</span>dir <span class="nv">$@</span><span class="k">)</span>
<span class="ln">32</span>	<span class="k">$(</span>hide<span class="k">)</span> <span class="k">$(</span>CHECKPOLICY_ASAN_OPTIONS<span class="k">)</span> <span class="k">$(</span>HOST_OUT_EXECUTABLES<span class="k">)</span>/checkpolicy -M -C -c <span class="se">\
</span><span class="ln">33</span><span class="se"></span>        <span class="k">$(</span>POLICYVERS<span class="k">)</span> -o <span class="nv">$@</span> $&lt;
<span class="ln">34</span>    <span class="k">$(</span>hide<span class="k">)</span> cat <span class="k">$(</span>PRIVATE_ADDITIONAL_CIL_FILES<span class="k">)</span> &gt;&gt; <span class="nv">$@</span>
<span class="ln">35</span>    <span class="k">$(</span>hide<span class="k">)</span> <span class="k">$(</span>HOST_OUT_EXECUTABLES<span class="k">)</span>/secilc -m -M <span class="nb">true</span> -G -c <span class="k">$(</span>POLICYVERS<span class="k">)</span> <span class="k">$(</span>PRIVATE_NEVERALLOW_ARG<span class="k">)</span> <span class="nv">$@</span> -o /dev/null -f /dev/null
<span class="ln">36</span>
<span class="ln">37</span><span class="nv">built_plat_cil</span> <span class="o">:=</span> <span class="k">$(</span>LOCAL_BUILT_MODULE<span class="k">)</span>
<span class="ln">38</span><span class="nv">plat_policy.conf</span> <span class="o">:=</span>
</code></pre></div><p>sepolicy_build_files 包含了所有的te文件，这个是我们最熟悉的部分</p>
<p>还包括其他必需的文件，如宏定义global_macros 、 te_macros等</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln"> 1</span>sepolicy_build_files := security_classes \
<span class="ln"> 2</span>                        initial_sids \
<span class="ln"> 3</span>                        access_vectors \
<span class="ln"> 4</span>                        global_macros \
<span class="ln"> 5</span>                        neverallow_macros \
<span class="ln"> 6</span>                        mls_macros \
<span class="ln"> 7</span>                        mls_decl \
<span class="ln"> 8</span>                        mls \
<span class="ln"> 9</span>                        policy_capabilities \
<span class="ln">10</span>                        te_macros \
<span class="ln">11</span>                        attributes \
<span class="ln">12</span>                        ioctl_defines \
<span class="ln">13</span>                        ioctl_macros \
<span class="ln">14</span>                        *.te \
<span class="ln">15</span>                        roles_decl \
<span class="ln">16</span>                        roles \
<span class="ln">17</span>                        users \
<span class="ln">18</span>                        initial_sid_contexts \
<span class="ln">19</span>                        fs_use \
<span class="ln">20</span>                        genfs_contexts \
<span class="ln">21</span>                        port_contexts
</code></pre></div><p>然后调用transform-policy-to-conf将策略文件转成conf文件，生成plat_policy.conf</p>
<div class="highlight"><pre class="chroma"><code class="language-makefile" data-lang="makefile"><span class="ln"> 1</span><span class="err">define</span> <span class="err">transform-policy-to-conf</span>
<span class="ln"> 2</span><span class="err">@mkdir</span> <span class="err">-p</span> <span class="k">$(</span><span class="nv">dir</span> <span class="k">$</span>@<span class="k">)</span>
<span class="ln"> 3</span><span class="k">$(</span><span class="nv">hide</span><span class="k">)</span> <span class="err">m4</span> <span class="k">$(</span><span class="nv">PRIVATE_ADDITIONAL_M</span>4<span class="nv">DEFS</span><span class="k">)</span> <span class="err">\</span>
<span class="ln"> 4</span>    <span class="err">-D</span> <span class="nv">mls_num_sens</span><span class="o">=</span><span class="k">$(</span>PRIVATE_MLS_SENS<span class="k">)</span> -D <span class="nv">mls_num_cats</span><span class="o">=</span><span class="k">$(</span>PRIVATE_MLS_CATS<span class="k">)</span> <span class="se">\
</span><span class="ln"> 5</span><span class="se"></span>    -D <span class="nv">target_build_variant</span><span class="o">=</span><span class="k">$(</span>PRIVATE_TARGET_BUILD_VARIANT<span class="k">)</span> <span class="se">\
</span><span class="ln"> 6</span><span class="se"></span>    -D <span class="nv">target_with_dexpreopt</span><span class="o">=</span><span class="k">$(</span>WITH_DEXPREOPT<span class="k">)</span> <span class="se">\
</span><span class="ln"> 7</span><span class="se"></span>    -D <span class="nv">target_arch</span><span class="o">=</span><span class="k">$(</span>PRIVATE_TGT_ARCH<span class="k">)</span> <span class="se">\
</span><span class="ln"> 8</span><span class="se"></span>    -D <span class="nv">target_with_asan</span><span class="o">=</span><span class="k">$(</span>PRIVATE_TGT_WITH_ASAN<span class="k">)</span> <span class="se">\
</span><span class="ln"> 9</span><span class="se"></span>    -D <span class="nv">target_full_treble</span><span class="o">=</span><span class="k">$(</span>PRIVATE_SEPOLICY_SPLIT<span class="k">)</span> <span class="se">\
</span><span class="ln">10</span><span class="se"></span>    -D <span class="nv">target_compatible_property</span><span class="o">=</span><span class="k">$(</span>PRIVATE_COMPATIBLE_PROPERTY<span class="k">)</span> <span class="se">\
</span><span class="ln">11</span><span class="se"></span>    <span class="k">$(</span>PRIVATE_TGT_RECOVERY<span class="k">)</span> <span class="se">\
</span><span class="ln">12</span><span class="se"></span>    -s $^ &gt; <span class="nv">$@</span>
<span class="ln">13</span><span class="err">endef</span>
<span class="ln">14</span><span class="nv">.KATI_READONLY</span> <span class="o">:=</span> transform-policy-to-conf
</code></pre></div><blockquote>
<p>关于mk相关的一些语法</p>
<div class="highlight"><pre class="chroma"><code class="language-makefile" data-lang="makefile"><span class="ln">1</span><span class="c">#目标，:前面的变量
</span><span class="ln">2</span><span class="c"></span><span class="k">$@</span> 
<span class="ln">3</span><span class="c">#所有依赖，:后面的所有变量
</span><span class="ln">4</span><span class="c"></span><span class="err">$^</span>
<span class="ln">5</span><span class="c">#第一个依赖，:的第一个变量
</span><span class="ln">6</span><span class="c"></span><span class="k">$&lt;</span>
</code></pre></div><p>Linux中的sed使用</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln"> 1</span>sed <span class="s1">&#39;/^\s*dontaudit.*;/d&#39;</span> <span class="nv">$@</span> <span class="p">|</span> sed <span class="s1">&#39;/^\s*dontaudit/,/;/d&#39;</span> &gt; <span class="nv">$@</span>.dontaudit
<span class="ln"> 2</span><span class="c1"># 分成两部分</span>
<span class="ln"> 3</span><span class="c1">#Example1: sed &#39;/^\s*dontaudit.*;/d&#39; $@</span>
<span class="ln"> 4</span><span class="c1">#Example2: sed &#39;/^\s*dontaudit/,/;/d&#39; &gt; $@.dontaudit</span>
<span class="ln"> 5</span><span class="c1">#其中sed &#39;/string/d&#39; ,表示到匹配到string的字符串的行数删除</span>
<span class="ln"> 6</span><span class="c1"># sed &#39;/string1/,/string2/d&#39;,表示匹配到string1开头，string2结尾的这一段字符串全部删除</span>
<span class="ln"> 7</span><span class="c1"># \s 在正则中表示一个空白字符（可能是空格、制表符、其他空白）</span>
<span class="ln"> 8</span><span class="c1"># \s* 在正则中表示匹配0个或多个空白字符，会尽可能多的匹配</span>
<span class="ln"> 9</span><span class="c1"># ^\s* 在正则中表示匹配0个或多个非空白字符，会尽可能多的匹配</span>
<span class="ln">10</span><span class="c1"># Example1表示在$@文件中去除包含dontaudit字符的行数，这里主要是dontaudit前后的括号且占单行</span>
<span class="ln">11</span><span class="c1"># Example2表示在$@文件中去除包含dontaudit字符的行数，这里主要是dontaudit前后的括号且占多行</span>
</code></pre></div></blockquote>
<p>把上面的变量替换之后就是</p>
<div class="highlight"><pre class="chroma"><code class="language-makefile" data-lang="makefile"><span class="ln"> 1</span><span class="nv">policy_files</span> <span class="o">:=</span> <span class="k">$(</span>call build_policy, <span class="k">$(</span>sepolicy_build_files<span class="k">)</span>, <span class="se">\
</span><span class="ln"> 2</span><span class="se"></span>  <span class="k">$(</span>PLAT_PUBLIC_POLICY<span class="k">)</span> <span class="k">$(</span>PLAT_PRIVATE_POLICY<span class="k">)</span><span class="o">)</span>
<span class="ln"> 3</span><span class="nv">plat_policy.conf</span> <span class="o">:=</span> out/target/product/xxx/obj/ETC/plat_sepolicy.cil_intermediates/plat_policy.conf
<span class="ln"> 4</span><span class="nf">$(plat_policy.conf)</span><span class="o">:</span> <span class="n">PRIVATE_MLS_SENS</span> := 1
<span class="ln"> 5</span><span class="nf">$(plat_policy.conf)</span><span class="o">:</span> <span class="n">PRIVATE_MLS_CATS</span> := 1024
<span class="ln"> 6</span><span class="nf">$(plat_policy.conf)</span><span class="o">:</span> <span class="n">PRIVATE_TARGET_BUILD_VARIANT</span> := <span class="n">userdebug</span>
<span class="ln"> 7</span><span class="nf">$(plat_policy.conf)</span><span class="o">:</span> <span class="n">PRIVATE_TGT_ARCH</span> := <span class="n">arm</span>
<span class="ln"> 8</span><span class="nf">$(plat_policy.conf)</span><span class="o">:</span> <span class="n">PRIVATE_TGT_WITH_ASAN</span> := <span class="n">false</span>
<span class="ln"> 9</span><span class="nf">$(plat_policy.conf)</span><span class="o">:</span> <span class="n">PRIVATE_TGT_WITH_NATIVE_COVERAGE</span> := <span class="n">false</span>
<span class="ln">10</span><span class="nf">$(plat_policy.conf)</span><span class="o">:</span> <span class="n">PRIVATE_ADDITIONAL_M</span>4<span class="n">DEFS</span> :=
<span class="ln">11</span><span class="nf">$(plat_policy.conf)</span><span class="o">:</span> <span class="n">PRIVATE_SEPOLICY_SPLIT</span> := <span class="n">true</span>
<span class="ln">12</span><span class="nf">$(plat_policy.conf)</span><span class="o">:</span> <span class="n">PRIVATE_COMPATIBLE_PROPERTY</span> := <span class="n">true</span>
<span class="ln">13</span><span class="nf">$(plat_policy.conf)</span><span class="o">:</span> <span class="n">PRIVATE_TREBLE_SYSPROP_NEVERALLOW</span> := <span class="n">true</span>
<span class="ln">14</span><span class="nf">$(plat_policy.conf)</span><span class="o">:</span> <span class="n">PRIVATE_POLICY_FILES</span> := <span class="k">$(</span><span class="nv">policy_files</span><span class="k">)</span>
<span class="ln">15</span><span class="nf">$(plat_policy.conf)</span><span class="o">:</span> <span class="k">$(</span><span class="nv">policy_files</span><span class="k">)</span> <span class="k">$(</span><span class="nv">M</span>4<span class="k">)</span>
<span class="ln">16</span>	<span class="k">$(</span>transform-policy-to-conf<span class="k">)</span>
<span class="ln">17</span>	<span class="k">$(</span>hide<span class="k">)</span> sed <span class="s1">&#39;/^\s*dontaudit.*;/d&#39;</span> plat_policy.conf <span class="p">|</span> sed <span class="s1">&#39;/^\s*dontaudit/,/;/d&#39;</span> &gt; plat_policy.conf.dontaudit
<span class="ln">18</span>
<span class="ln">19</span><span class="nf">$(LOCAL_BUILT_MODULE)</span><span class="o">:</span> <span class="n">PRIVATE_ADDITIONAL_CIL_FILES</span> := \
<span class="ln">20</span>  <span class="n">system</span>/<span class="n">sepolicy</span>/<span class="n">private</span>/<span class="n">technical_debt</span>.<span class="n">cil</span>
<span class="ln">21</span><span class="nf">$(LOCAL_BUILT_MODULE)</span><span class="o">:</span> <span class="n">PRIVATE_NEVERALLOW_ARG</span> :=
<span class="ln">22</span><span class="nf">$(LOCAL_BUILT_MODULE)</span><span class="o">:</span> <span class="n">out</span>/<span class="n">target</span>/<span class="n">product</span>/<span class="n">xxx</span>/<span class="n">obj</span>/<span class="n">ETC</span>/<span class="n">plat_sepolicy</span>.<span class="n">cil_intermediates</span>/<span class="n">plat_policy</span>.<span class="n">conf</span> <span class="n">out</span>/<span class="n">target</span>/<span class="n">product</span>/<span class="n">xxx</span>/<span class="n">obj</span>/<span class="n">EXECUTABLES</span>/<span class="n">secilc_intermediates</span>/<span class="n">checkpolicy</span> \
<span class="ln">23</span> <span class="n">out</span>/<span class="n">target</span>/<span class="n">product</span>/<span class="n">xxx</span>/<span class="n">obj</span>/<span class="n">EXECUTABLES</span>/<span class="n">secilc_intermediates</span>/<span class="n">secilc</span> \
<span class="ln">24</span>  <span class="n">system</span>/<span class="n">sepolicy</span>/<span class="n">private</span>/<span class="n">technical_debt</span>.<span class="n">cil</span> \
<span class="ln">25</span>  <span class="n">out</span>/<span class="n">target</span>/<span class="n">product</span>/<span class="n">xxx</span>/<span class="n">obj</span>/<span class="n">FAKE</span>/<span class="n">sepolicy_neverallows_intermediates</span>/<span class="n">sepolicy_neverallows</span>
<span class="ln">26</span>	@mkdir -p <span class="k">$(</span>dir plat_sepolicy.cil<span class="k">)</span>
<span class="ln">27</span>	<span class="k">$(</span>hide<span class="k">)</span> <span class="nv">detect_leaks</span><span class="o">=</span><span class="m">0</span> out/target/product/xxx/obj/EXECUTABLES/checkpolicy -M -C -c <span class="se">\
</span><span class="ln">28</span><span class="se"></span>		<span class="m">30</span> -o plat_sepolicy.cil.tmp out/target/product/xxx/obj/ETC/plat_sepolicy.cil_intermediates/plat_policy.conf
<span class="ln">29</span>	<span class="k">$(</span>hide<span class="k">)</span> cat system/sepolicy/private/technical_debt.cil &gt;&gt; plat_sepolicy.cil.tmp
<span class="ln">30</span>	<span class="k">$(</span>hide<span class="k">)</span> out/target/product/xxx/obj/EXECUTABLES/secilc_intermediates/secilc -m -M <span class="nb">true</span> -G -c <span class="m">30</span> plat_sepolicy.cil.tmp -o /dev/null -f /dev/null
<span class="ln">31</span>	<span class="k">$(</span>hide<span class="k">)</span> mv plat_sepolicy.cil.tmp plat_sepolicy.cil
<span class="ln">32</span>
<span class="ln">33</span><span class="nv">built_plat_cil</span> <span class="o">:=</span> out/target/product/xxx/obj/ETC/plat_sepolicy.cil_intermediates/plat_sepolicy.cil
<span class="ln">34</span><span class="nv">plat_policy.conf</span> <span class="o">:=</span>
</code></pre></div><p>其中<code>$(transform-policy-to-conf)</code>又是一个宏，展开显示</p>
<div class="highlight"><pre class="chroma"><code class="language-makefile" data-lang="makefile"><span class="ln"> 1</span><span class="err">@mkdir</span> <span class="err">-p</span> <span class="k">$(</span><span class="nv">dir</span> <span class="k">$</span>@<span class="k">)</span>
<span class="ln"> 2</span><span class="k">$(</span><span class="nv">hide</span><span class="k">)</span> <span class="k">$(</span><span class="nv">M</span>4<span class="k">)</span> <span class="err">--fatal-warnings</span>  <span class="err">\</span>
<span class="ln"> 3</span>	<span class="err">-D</span> <span class="nv">mls_num_sens</span><span class="o">=</span><span class="m">1</span> -D <span class="nv">mls_num_cats</span><span class="o">=</span><span class="m">1024</span> <span class="se">\
</span><span class="ln"> 4</span><span class="se"></span>	-D <span class="nv">target_build_variant</span><span class="o">=</span>userdebug <span class="se">\
</span><span class="ln"> 5</span><span class="se"></span>	-D <span class="nv">target_with_dexpreopt</span><span class="o">=</span><span class="nb">true</span> <span class="se">\
</span><span class="ln"> 6</span><span class="se"></span>	-D <span class="nv">target_arch</span><span class="o">=</span>arm <span class="se">\
</span><span class="ln"> 7</span><span class="se"></span>	-D <span class="nv">target_with_asan</span><span class="o">=</span><span class="nb">false</span> <span class="se">\
</span><span class="ln"> 8</span><span class="se"></span>	-D <span class="nv">target_with_native_coverage</span><span class="o">=</span><span class="nb">false</span> <span class="se">\
</span><span class="ln"> 9</span><span class="se"></span>	-D <span class="nv">target_full_treble</span><span class="o">=</span><span class="nb">true</span> <span class="se">\
</span><span class="ln">10</span><span class="se"></span>	-D <span class="nv">target_compatible_property</span><span class="o">=</span><span class="nb">true</span> <span class="se">\
</span><span class="ln">11</span><span class="se"></span>	-D <span class="nv">target_treble_sysprop_neverallow</span><span class="o">=</span><span class="nb">true</span> <span class="se">\
</span><span class="ln">12</span><span class="se"></span>	-D <span class="nv">target_exclude_build_test</span><span class="o">=</span> <span class="se">\
</span><span class="ln">13</span><span class="se"></span>	-D <span class="nv">target_requires_insecure_execmem_for_swiftshader</span><span class="o">=</span> <span class="se">\
</span><span class="ln">14</span><span class="se"></span>	-s <span class="k">$(</span>policy_files<span class="k">)</span> &gt; plat_policy.conf
</code></pre></div><p>其他的cil也是类似的过程，会有一些差异，但是跟着mk来分析就行了</p>
<h4 id="2212案例-策略文件编译生成cil">2.2.1.2案例-策略文件编译生成cil</h4>
<h5 id="22121原始的testate">2.2.1.2.1原始的testA.te</h5>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln"> 1</span>type testA, domain, binder_in_vendor_violators, vendor_executes_system_violators;
<span class="ln"> 2</span>type testA_exec, exec_type, vendor_file_type, file_type;
<span class="ln"> 3</span>
<span class="ln"> 4</span>init_daemon_domain(testA)
<span class="ln"> 5</span>
<span class="ln"> 6</span>allow testA picasso_device:chr_file rw_file_perms;
<span class="ln"> 7</span>allow testA testA_exec:file { execute_no_trans };
<span class="ln"> 8</span>allow testA vendor_toolbox_exec:file { execute_no_trans };
<span class="ln"> 9</span>allow testA vendor_data_file:dir create_dir_perms;
<span class="ln">10</span>allow testA vendor_data_file:file create_file_perms;
<span class="ln">11</span>allow testA vendor_file:file { execute_no_trans };
<span class="ln">12</span>allow testA mnt_media_rw_file:dir { search };
<span class="ln">13</span>allow testA vfat:file { getattr read open };
<span class="ln">14</span>allow testA vfat:dir { search };
<span class="ln">15</span>allow testA block_device:dir { search };
<span class="ln">16</span>allow testA activity_service:service_manager { find };
<span class="ln">17</span>allow testA system_server:binder { call transfer };
<span class="ln">18</span>binder_use(testA)
<span class="ln">19</span>allow testA shell_exec:file { read execute };
<span class="ln">20</span>allow testA system_file:file { execute_no_trans };
</code></pre></div><h5 id="22122conf文件">2.2.1.2.2conf文件</h5>
<p>经过m4宏处理器处理后，所有的宏都被替换展开了</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln"> 1</span>#line 1 &#34;device/xxxx/common/sepolicy/testA.te&#34;
<span class="ln"> 2</span>type testA, domain, binder_in_vendor_violators, vendor_executes_system_violators;
<span class="ln"> 3</span>type testA_exec, exec_type, vendor_file_type, file_type;
<span class="ln"> 4</span> 
<span class="ln"> 5</span>
<span class="ln"> 6</span>#line 4
<span class="ln"> 7</span> 
<span class="ln"> 8</span>#line 4
<span class="ln"> 9</span># Allow the necessary permissions.
<span class="ln">10</span>#line 4
<span class="ln">11</span> 
<span class="ln">12</span>#line 4
<span class="ln">13</span># Old domain may exec the file and transition to the new domain.
<span class="ln">14</span>#line 4
<span class="ln">15</span>allow init testA_exec:file { getattr open read execute map };
<span class="ln">16</span>#line 4
<span class="ln">17</span>allow init testA:process transition;
<span class="ln">18</span>#line 4
<span class="ln">19</span># New domain is entered by executing the file.
<span class="ln">20</span>#line 4
<span class="ln">21</span>allow testA testA_exec:file { entrypoint open read execute getattr map };
<span class="ln">22</span>#line 4
<span class="ln">23</span># New domain can send SIGCHLD to its caller.
<span class="ln">24</span>#line 4
<span class="ln">25</span> 
<span class="ln">26</span>#line 4
<span class="ln">27</span># Enable AT_SECURE, i.e. libc secure mode.
<span class="ln">28</span>#line 4
<span class="ln">29</span>dontaudit init testA:process noatsecure;
<span class="ln">30</span>#line 4
<span class="ln">31</span># XXX dontaudit candidate but requires further study.
<span class="ln">32</span>#line 4
<span class="ln">33</span>allow init testA:process { siginh rlimitinh };
<span class="ln">34</span>#line 4
<span class="ln">35</span> 
<span class="ln">36</span>#line 4
<span class="ln">37</span># Make the transition occur by default.
<span class="ln">38</span>#line 4
<span class="ln">39</span>type_transition init testA_exec:process testA;
<span class="ln">40</span>#line 4
<span class="ln">41</span> 
<span class="ln">42</span>#line 4
<span class="ln">43</span> 
<span class="ln">44</span>#line 4
<span class="ln">45</span>type testA_tmpfs, file_type;
<span class="ln">46</span>#line 4
<span class="ln">47</span>type_transition testA tmpfs:file testA_tmpfs;
<span class="ln">48</span>#line 4
<span class="ln">49</span>allow testA testA_tmpfs:file { read write getattr map };
<span class="ln">50</span>#line 4
<span class="ln">51</span>allow testA tmpfs:dir { getattr search };
<span class="ln">52</span>#line 4
<span class="ln">53</span> 
<span class="ln">54</span>#line 4
<span class="ln">55</span> 
<span class="ln">56</span> 
<span class="ln">57</span>allow testA picasso_device:chr_file { { getattr open read ioctl lock map } { open append write lock map } };
<span class="ln">58</span>allow testA testA_exec:file { execute_no_trans };
<span class="ln">59</span>allow testA vendor_toolbox_exec:file { execute_no_trans };
<span class="ln">60</span>allow testA vendor_data_file:dir { create reparent rename rmdir setattr { { open getattr read search ioctl lock } { open search write add_name remove_name lock } } };
<span class="ln">61</span>allow testA vendor_data_file:file { create rename setattr unlink { { getattr open read ioctl lock map } { open append write lock map } } };
<span class="ln">62</span>allow testA vendor_file:file { execute_no_trans };
<span class="ln">63</span>allow testA mnt_media_rw_file:dir { search };
<span class="ln">64</span>allow testA vfat:file { getattr read open };
<span class="ln">65</span>allow testA vfat:dir { search };
<span class="ln">66</span>allow testA block_device:dir { search };
<span class="ln">67</span> 
<span class="ln">68</span> 
<span class="ln">69</span>allow testA activity_service:service_manager { find };
<span class="ln">70</span>allow testA system_server:binder { call transfer };
<span class="ln">71</span> 
<span class="ln">72</span>#line 22
<span class="ln">73</span># Call the servicemanager and transfer references to it.
<span class="ln">74</span>#line 22
<span class="ln">75</span>allow testA servicemanager:binder { call transfer };
<span class="ln">76</span>#line 22
<span class="ln">77</span># servicemanager performs getpidcon on clients.
<span class="ln">78</span>#line 22
<span class="ln">79</span>allow servicemanager testA:dir search;
<span class="ln">80</span>#line 22
<span class="ln">81</span>allow servicemanager testA:file { read open };
<span class="ln">82</span>#line 22
<span class="ln">83</span>allow servicemanager testA:process getattr;
<span class="ln">84</span>#line 22
<span class="ln">85</span># rw access to /dev/binder and /dev/ashmem is presently granted to
<span class="ln">86</span>#line 22
<span class="ln">87</span># all domains in domain.te.
<span class="ln">88</span>#line 22
<span class="ln">89</span> 
<span class="ln">90</span>allow testA shell_exec:file { read execute };
<span class="ln">91</span>allow testA system_file:file { execute_no_trans };
</code></pre></div><h5 id="22123-cil文件">2.2.1.2.3 cil文件</h5>
<p>接着使用checkpolicy命令，将conf文件转成cil文件：</p>
<div class="highlight"><pre class="chroma"><code class="language-makefile" data-lang="makefile"><span class="ln">1</span><span class="nv">ASAN_OPTIONS</span><span class="o">=</span><span class="nv">detect_leaks</span><span class="o">=</span><span class="m">0</span> checkpolicy -M -C -c <span class="m">30</span> -o plat_sepolicy.cil plat_policy.conf
</code></pre></div><p>这个过程中，checkpolicy还会检查是否策略文件是否存在问题，比如是否违反neverallow，语法错误，方案自定义策略文件访问平台私有策略等等；check_assertions检查是否有违反neverallow的规则。</p>
<p>checkpolicy源码在：android/external/selinux/checkpolicy</p>
<p>违反neverallow：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln"> 1</span><span class="o">[</span>  6% 3/47<span class="o">]</span> build out/target/product/xxxx/obj/ETC/sepolicy_neverallows_intermediates/sepolicy_neverallows
<span class="ln"> 2</span>FAILED: out/target/product/xxxx/obj/ETC/sepolicy_neverallows_intermediates/sepolicy_neverallows
<span class="ln"> 3</span>/bin/bash -c <span class="s2">&#34;(rm -f out/target/product/xxxx/obj/ETC/sepolicy_neverallows_intermediates/sepolicy_neverallows ) &amp;&amp; (ASAN_OPTIONS=detect_leaks=0 out/host/linux-x86/bin/checkpolicy -M -c           30 -o out/target/product/xxxx/obj/ETC/sepolicy_neverallows_intermediates/sepolicy_neverallows out/target/product/xxxx/obj/ETC/sepolicy_neverallows_intermediates/policy.conf )&#34;</span>
<span class="ln"> 4</span>libsepol.report_failure: neverallow on line <span class="m">671</span> of system/sepolicy/public/domain.te <span class="o">(</span>or line <span class="m">10586</span> of policy.conf<span class="o">)</span> violated by allow testA servicemanager:binder <span class="o">{</span> call transfer <span class="o">}</span><span class="p">;</span>
<span class="ln"> 5</span>libsepol.report_failure: neverallow on line <span class="m">638</span> of system/sepolicy/public/domain.te <span class="o">(</span>or line <span class="m">10522</span> of policy.conf<span class="o">)</span> violated by allow testA activity_service:service_manager <span class="o">{</span> find <span class="o">}</span><span class="p">;</span>
<span class="ln"> 6</span>libsepol.check_assertions: <span class="m">2</span> neverallow failures occurred
<span class="ln"> 7</span>Error <span class="k">while</span> expanding policy
<span class="ln"> 8</span>out/host/linux-x86/bin/checkpolicy:  loading policy configuration from out/target/product/xxxx/obj/ETC/sepolicy_neverallows_intermediates/policy.conf
<span class="ln"> 9</span>ninja: build stopped: subcommand failed.
<span class="ln">10</span>01:32:50 ninja failed with: <span class="nb">exit</span> status <span class="m">1</span>
</code></pre></div><p>语法错误：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln"> 1</span><span class="o">[</span>  6% 3/47<span class="o">]</span> build out/target/product/xxxx/obj/ETC/sepolicy_neverallows_intermediates/sepolicy_neverallows
<span class="ln"> 2</span>FAILED: out/target/product/xxxx/obj/ETC/sepolicy_neverallows_intermediates/sepolicy_neverallows
<span class="ln"> 3</span>/bin/bash -c <span class="s2">&#34;(rm -f out/target/product/xxxx/obj/ETC/sepolicy_neverallows_intermediates/sepolicy_neverallows ) &amp;&amp; (ASAN_OPTIONS=detect_leaks=0 out/host/linux-x86/bin/checkpolicy -M -c           30 -o out/target/product/xxxx/obj/ETC/sepolicy_neverallows_intermediates/sepolicy_neverallows out/target/product/xxxx/obj/ETC/sepolicy_neverallows_intermediates/policy.conf )&#34;</span>
<span class="ln"> 4</span>device/xxxxxx/common/sepolicy/testA.te:11:ERROR <span class="s1">&#39;syntax error&#39;</span> at token <span class="s1">&#39;allow&#39;</span> on line 47452:
<span class="ln"> 5</span>allow testA system_server <span class="o">{</span> call transfer <span class="o">}</span><span class="p">;</span>
<span class="ln"> 6</span>allow testA activity_service:service_manager <span class="o">{</span> find <span class="o">}</span>
<span class="ln"> 7</span>checkpolicy:  error<span class="o">(</span>s<span class="o">)</span> encountered <span class="k">while</span> parsing configuration
<span class="ln"> 8</span>out/host/linux-x86/bin/checkpolicy:  loading policy configuration from out/target/product/xxxx/obj/ETC/sepolicy_neverallows_intermediates/policy.conf
<span class="ln"> 9</span>ninja: build stopped: subcommand failed.
<span class="ln">10</span>10:17:55 ninja failed with: <span class="nb">exit</span> status <span class="m">1</span>
</code></pre></div><p>方案自定义策略文件访问平台私有策略：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln"> 1</span>FAILED: out/target/product/xxxx/obj/ETC/vendor_sepolicy.cil_intermediates/vendor_sepolicy.cil
<span class="ln"> 2</span>/bin/bash -c <span class="s2">&#34;out/host/linux-x86/bin/build_sepolicy -a out/host/linux-x86/bin build_cil                 -i out/target/product/xxxx/obj/ETC/vendor_sepolicy.cil_intermediates/vendor_policy.conf -m out/target/product/xxxx/obj/ETC/sepolicy_neverallows_intermediates/reqd_policy_mask.cil -c ASAN_OPTIONS=detect_leaks=0          -b out/target/product/xxxx/obj/ETC/sepolicy_neverallows_intermediates/plat_pub_policy.cil -d out/target/product/xxxx/obj/ETC/plat_sepolicy.cil_intermediates/plat_sepolicy.cil out/target/product/xxxx/obj/ETC/plat_pub_versioned.cil_intermediates/plat_pub_versioned.cil out/target/product/xxxx/obj/ETC/30.0.cil_intermediates/30.0.cil -f out/target/product/xxxx/obj/ETC/plat_pub_versioned.cil_intermediates/plat_pub_versioned.cil                 -t 30.0 -p 30 -o out/target/product/xxxx/obj/ETC/vendor_sepolicy.cil_intermediates/vendor_sepolicy.cil&#34;</span>
<span class="ln"> 3</span>device/xxxxxx/common/sepolicy/testA.te:18:ERROR <span class="s1">&#39;unknown type storaged&#39;</span> at token <span class="s1">&#39;;&#39;</span> on line 34318:
<span class="ln"> 4</span>allow hal_memtrack_default storaged:dir <span class="o">{</span> search <span class="o">}</span><span class="p">;</span>
<span class="ln"> 5</span><span class="c1">#allow hal_memtrack_default rootdaemon:dir { search };</span>
<span class="ln"> 6</span>checkpolicy:  error<span class="o">(</span>s<span class="o">)</span> encountered <span class="k">while</span> parsing configuration
<span class="ln"> 7</span>out/host/linux-x86/bin/checkpolicy:  loading policy configuration from out/target/product/xxxx/obj/ETC/vendor_sepolicy.cil_intermediates/vendor_policy.conf
<span class="ln"> 8</span>build_sepolicy - failed to run command: <span class="s1">&#39;ASAN_OPTIONS=detect_leaks=0 out/host/linux-x86/bin/checkpolicy -C -M -c 30 -o out/target/product/xxxx/obj/ETC/vendor_sepolicy.cil_intermediates/vendor_policy_raw.cil out/target/product/xxxx/obj/ETC/vendor_sepolicy.cil_intermediates/vendor_policy.conf&#39;</span> <span class="o">(</span>ret:1<span class="o">)</span>
<span class="ln"> 9</span>ninja: build stopped: subcommand failed.
<span class="ln">10</span>10:24:07 ninja failed with: <span class="nb">exit</span> status <span class="m">1</span>
</code></pre></div><p><strong>转出来cil之后：</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln"> 1</span>(type testA)
<span class="ln"> 2</span>(roletype object_r testA)
<span class="ln"> 3</span>(type testA_exec)
<span class="ln"> 4</span>(roletype object_r testA_exec)
<span class="ln"> 5</span>(type testA_tmpfs)
<span class="ln"> 6</span>(roletype object_r testA_tmpfs)
<span class="ln"> 7</span> 
<span class="ln"> 8</span>(typeattributeset file_type (...... testA_exec testA_tmpfs ......))
<span class="ln"> 9</span>(typeattributeset exec_type (...... testA_exec ......))
<span class="ln">10</span>(typeattributeset vendor_file_type (...... testA_exec ......))
<span class="ln">11</span>(typeattributeset binder_in_vendor_violators (testA apkinstalldata xbug))
<span class="ln">12</span>(typeattributeset vendor_executes_system_violators (testA apkinstalldata))
<span class="ln">13</span>(typeattributeset domain (...... testA ......))
<span class="ln">14</span> 
<span class="ln">15</span>(allow init_30_0 testA_exec (file (read getattr map execute open)))
<span class="ln">16</span>(allow init_30_0 testA (process (transition)))
<span class="ln">17</span>(allow testA testA_exec (file (read getattr map execute entrypoint open)))
<span class="ln">18</span>(dontaudit init_30_0 testA (process (noatsecure)))
<span class="ln">19</span>(allow init_30_0 testA (process (siginh rlimitinh)))
<span class="ln">20</span>(typetransition init_30_0 testA_exec process testA)
<span class="ln">21</span>(typetransition testA tmpfs_30_0 file testA_tmpfs)
<span class="ln">22</span>(allow testA testA_tmpfs (file (read write getattr map)))
<span class="ln">23</span>(allow testA tmpfs_30_0 (dir (getattr search)))
<span class="ln">24</span>(allow testA picasso_device_30_0 (chr_file (ioctl read write getattr lock append map open)))
<span class="ln">25</span>(allow testA testA_exec (file (execute_no_trans)))
<span class="ln">26</span>(allow testA vendor_toolbox_exec_30_0 (file (execute_no_trans)))
<span class="ln">27</span>(allow testA vendor_data_file_30_0 (dir (ioctl read write create getattr setattr lock rename add_name remove_name reparent search rmdir open)))
<span class="ln">28</span>(allow testA vendor_data_file_30_0 (file (ioctl read write create getattr setattr lock append map unlink rename open)))
<span class="ln">29</span>(allow testA vendor_file_30_0 (file (execute_no_trans)))
<span class="ln">30</span>(allow testA mnt_media_rw_file_30_0 (dir (search)))
<span class="ln">31</span>(allow testA vfat_30_0 (file (read getattr open)))
<span class="ln">32</span>(allow testA vfat_30_0 (dir (search)))
<span class="ln">33</span>(allow testA block_device_30_0 (dir (search)))
<span class="ln">34</span>(allow testA property_socket_30_0 (sock_file (write)))
<span class="ln">35</span>(allow testA init_30_0 (unix_stream_socket (connectto)))
<span class="ln">36</span>(allow testA activity_service_30_0 (service_manager (find)))
<span class="ln">37</span>(allow testA system_server_30_0 (binder (call transfer)))
<span class="ln">38</span>(allow testA servicemanager_30_0 (binder (call transfer)))
<span class="ln">39</span>(allow servicemanager_30_0 testA (dir (search)))
<span class="ln">40</span>(allow servicemanager_30_0 testA (file (read open)))
<span class="ln">41</span>(allow servicemanager_30_0 testA (process (getattr)))
<span class="ln">42</span>(allow testA shell_exec_30_0 (file (read execute)))
<span class="ln">43</span>(allow testA system_file_30_0 (file (execute_no_trans)))
</code></pre></div><h5 id="22124检查">2.2.1.2.4检查</h5>
<p>在最后会用secilc编译一次cil文件，检查是否有问题</p>
<p>经历过上面的一个过程，编译出所有需要的cil，最后就会调用secilc命令编译所有的cil文件，生成二进制策略文件precompiled_sepolicy</p>
<p>简单的说，这个过程就是：</p>
<p>te -&gt; conf -&gt; cil -&gt; precompiled_sepolicy</p>
<p>cil这个在很早的Android版本，比如5.1的时候是还没有的，是后面的版本才添加的</p>
<h3 id="222将策略文件加载到kernel">2.2.2将策略文件加载到kernel</h3>
<p>接着回到加载selinux 策略的初始化过程</p>
<h4 id="2221selinux_android_load_policy_from_fd">2.2.2.1selinux_android_load_policy_from_fd</h4>
<p>android/external/selinux/libselinux/src/android/android_platform.c</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="kt">int</span> <span class="nf">selinux_android_load_policy_from_fd</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">description</span><span class="p">)</span>
<span class="ln"> 2</span><span class="p">{</span>
<span class="ln"> 3</span>    <span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
<span class="ln"> 4</span>    <span class="k">struct</span> <span class="nc">stat</span> <span class="n">sb</span><span class="p">;</span>
<span class="ln"> 5</span>    <span class="kt">void</span> <span class="o">*</span><span class="n">map</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="ln"> 6</span>    <span class="k">static</span> <span class="kt">int</span> <span class="n">load_successful</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="ln"> 7</span> 
<span class="ln"> 8</span>    <span class="cm">/*
</span><span class="ln"> 9</span><span class="cm">        * Since updating policy at runtime has been abolished
</span><span class="ln">10</span><span class="cm">        * we just check whether a policy has been loaded before
</span><span class="ln">11</span><span class="cm">        * and return if this is the case.
</span><span class="ln">12</span><span class="cm">        * There is no point in reloading policy.
</span><span class="ln">13</span><span class="cm">        */</span>
<span class="ln">14</span>    <span class="k">if</span> <span class="p">(</span><span class="n">load_successful</span><span class="p">){</span>
<span class="ln">15</span>        <span class="n">selinux_log</span><span class="p">(</span><span class="n">SELINUX_WARNING</span><span class="p">,</span> <span class="s">&#34;SELinux: Attempted reload of SELinux policy!/n&#34;</span><span class="p">);</span>
<span class="ln">16</span>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="ln">17</span>    <span class="p">}</span>
<span class="ln">18</span> 
<span class="ln">19</span>    <span class="n">set_selinuxmnt</span><span class="p">(</span><span class="n">SELINUXMNT</span><span class="p">);</span>  <span class="c1">//设置SELinux mount的位置  /sys/fs/selinux
</span><span class="ln">20</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">fstat</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">21</span>        <span class="n">selinux_log</span><span class="p">(</span><span class="n">SELINUX_ERROR</span><span class="p">,</span> <span class="s">&#34;SELinux:  Could not stat %s:  %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
<span class="ln">22</span>                <span class="n">description</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
<span class="ln">23</span>        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="ln">24</span>    <span class="p">}</span>
<span class="ln">25</span>    <span class="n">map</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">sb</span><span class="p">.</span><span class="n">st_size</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="p">,</span> <span class="n">MAP_PRIVATE</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="ln">26</span>    <span class="k">if</span> <span class="p">(</span><span class="n">map</span> <span class="o">==</span> <span class="n">MAP_FAILED</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">27</span>        <span class="n">selinux_log</span><span class="p">(</span><span class="n">SELINUX_ERROR</span><span class="p">,</span> <span class="s">&#34;SELinux:  Could not map %s:  %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
<span class="ln">28</span>                <span class="n">description</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
<span class="ln">29</span>        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="ln">30</span>    <span class="p">}</span>
<span class="ln">31</span> 
<span class="ln">32</span>    <span class="n">rc</span> <span class="o">=</span> <span class="n">security_load_policy</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">sb</span><span class="p">.</span><span class="n">st_size</span><span class="p">);</span> <span class="c1">//加载sepolicy
</span><span class="ln">33</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">34</span>        <span class="n">selinux_log</span><span class="p">(</span><span class="n">SELINUX_ERROR</span><span class="p">,</span> <span class="s">&#34;SELinux:  Could not load policy:  %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
<span class="ln">35</span>                <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
<span class="ln">36</span>        <span class="n">munmap</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">sb</span><span class="p">.</span><span class="n">st_size</span><span class="p">);</span>
<span class="ln">37</span>        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="ln">38</span>    <span class="p">}</span>
<span class="ln">39</span> 
<span class="ln">40</span>    <span class="n">munmap</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">sb</span><span class="p">.</span><span class="n">st_size</span><span class="p">);</span>
<span class="ln">41</span>    <span class="n">selinux_log</span><span class="p">(</span><span class="n">SELINUX_INFO</span><span class="p">,</span> <span class="s">&#34;SELinux: Loaded policy from %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">description</span><span class="p">);</span>
<span class="ln">42</span>    <span class="n">load_successful</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="ln">43</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="ln">44</span><span class="p">}</span>
</code></pre></div><h4 id="2222security_load_policylibselinux">2.2.2.2security_load_policy（libselinux）</h4>
<p>android/external/selinux/libselinux/src/load_policy.c</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="kt">int</span> <span class="nf">security_load_policy</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="ln"> 2</span><span class="p">{</span>
<span class="ln"> 3</span>    <span class="kt">char</span> <span class="n">path</span><span class="p">[</span><span class="n">PATH_MAX</span><span class="p">];</span>
<span class="ln"> 4</span>    <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
<span class="ln"> 5</span> 
<span class="ln"> 6</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">selinux_mnt</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 7</span>        <span class="n">errno</span> <span class="o">=</span> <span class="n">ENOENT</span><span class="p">;</span>
<span class="ln"> 8</span>        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="ln"> 9</span>    <span class="p">}</span>
<span class="ln">10</span> 
<span class="ln">11</span>    <span class="n">snprintf</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">path</span><span class="p">,</span> <span class="s">&#34;%s/load&#34;</span><span class="p">,</span> <span class="n">selinux_mnt</span><span class="p">);</span>
<span class="ln">12</span>    <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">O_RDWR</span> <span class="o">|</span> <span class="n">O_CLOEXEC</span><span class="p">);</span>
<span class="ln">13</span>    <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="ln">14</span>        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="ln">15</span> 
<span class="ln">16</span>    <span class="n">ret</span> <span class="o">=</span> <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="ln">17</span>    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
<span class="ln">18</span>    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="ln">19</span>        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="ln">20</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="ln">21</span><span class="p">}</span>
</code></pre></div><p>这里是把文件内容读取出来后，直接写入节点：/sys/fs/selinux/load</p>
<h4 id="2223sysfsselinuxload">2.2.2.3/sys/fs/selinux/load</h4>
<p>接着往下就要看kernel的代码了</p>
<p>android/common/security/selinux/selinuxfs.c</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="k">static</span> <span class="k">struct</span> <span class="nc">tree_descr</span> <span class="n">selinux_files</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="ln"> 2</span>        <span class="p">[</span><span class="n">SEL_LOAD</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#34;load&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sel_load_ops</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">},</span>
<span class="ln"> 3</span>        <span class="p">[</span><span class="n">SEL_ENFORCE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#34;enforce&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sel_enforce_ops</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">},</span>
<span class="ln"> 4</span>        <span class="p">[</span><span class="n">SEL_CONTEXT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#34;context&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">transaction_ops</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUGO</span><span class="p">},</span>
<span class="ln"> 5</span>        <span class="p">[</span><span class="n">SEL_ACCESS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#34;access&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">transaction_ops</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUGO</span><span class="p">},</span>
<span class="ln"> 6</span>        <span class="p">[</span><span class="n">SEL_CREATE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#34;create&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">transaction_ops</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUGO</span><span class="p">},</span>
<span class="ln"> 7</span>        <span class="p">[</span><span class="n">SEL_RELABEL</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#34;relabel&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">transaction_ops</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUGO</span><span class="p">},</span>
<span class="ln"> 8</span>        <span class="p">[</span><span class="n">SEL_USER</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#34;user&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">transaction_ops</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUGO</span><span class="p">},</span>
<span class="ln"> 9</span>        <span class="p">[</span><span class="n">SEL_POLICYVERS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#34;policyvers&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sel_policyvers_ops</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">},</span>
<span class="ln">10</span>        <span class="p">[</span><span class="n">SEL_COMMIT_BOOLS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#34;commit_pending_bools&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sel_commit_bools_ops</span><span class="p">,</span> <span class="n">S_IWUSR</span><span class="p">},</span>
<span class="ln">11</span>        <span class="p">[</span><span class="n">SEL_MLS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#34;mls&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sel_mls_ops</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">},</span>
<span class="ln">12</span>        <span class="p">[</span><span class="n">SEL_DISABLE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#34;disable&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sel_disable_ops</span><span class="p">,</span> <span class="n">S_IWUSR</span><span class="p">},</span>
<span class="ln">13</span>        <span class="p">[</span><span class="n">SEL_MEMBER</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#34;member&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">transaction_ops</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUGO</span><span class="p">},</span>
<span class="ln">14</span>        <span class="p">[</span><span class="n">SEL_CHECKREQPROT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#34;checkreqprot&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sel_checkreqprot_ops</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">},</span>
<span class="ln">15</span>        <span class="p">[</span><span class="n">SEL_REJECT_UNKNOWN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#34;reject_unknown&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sel_handle_unknown_ops</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">},</span>
<span class="ln">16</span>        <span class="p">[</span><span class="n">SEL_DENY_UNKNOWN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#34;deny_unknown&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sel_handle_unknown_ops</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">},</span>
<span class="ln">17</span>        <span class="p">[</span><span class="n">SEL_STATUS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#34;status&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sel_handle_status_ops</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">},</span>
<span class="ln">18</span>        <span class="p">[</span><span class="n">SEL_POLICY</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#34;policy&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sel_policy_ops</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">},</span>
<span class="ln">19</span>        <span class="p">[</span><span class="n">SEL_VALIDATE_TRANS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#34;validatetrans&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sel_transition_ops</span><span class="p">,</span>
<span class="ln">20</span>                    <span class="n">S_IWUGO</span><span class="p">},</span>
<span class="ln">21</span>        <span class="cm">/* last one */</span> <span class="p">{</span><span class="s">&#34;&#34;</span><span class="p">}</span>
<span class="ln">22</span>    <span class="p">};</span>
<span class="ln">23</span> 
<span class="ln">24</span><span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="nc">file_operations</span> <span class="n">sel_load_ops</span> <span class="o">=</span> <span class="p">{</span>
<span class="ln">25</span>    <span class="p">.</span><span class="n">write</span>  <span class="o">=</span> <span class="n">sel_write_load</span><span class="p">,</span>
<span class="ln">26</span>    <span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">generic_file_llseek</span><span class="p">,</span>
<span class="ln">27</span><span class="p">};</span>
</code></pre></div><p>接着是 sel_write_load</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="k">static</span> <span class="n">ssize_t</span> <span class="nf">sel_write_load</span><span class="p">(</span><span class="k">struct</span> <span class="nc">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
<span class="ln"> 2</span>                <span class="n">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="ln"> 3</span> 
<span class="ln"> 4</span><span class="p">{</span>
<span class="ln"> 5</span>    <span class="p">......</span>
<span class="ln"> 6</span> 
<span class="ln"> 7</span>    <span class="n">length</span> <span class="o">=</span> <span class="n">security_load_policy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="ln"> 8</span>    <span class="k">if</span> <span class="p">(</span><span class="n">length</span><span class="p">)</span>
<span class="ln"> 9</span>        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="ln">10</span> 
<span class="ln">11</span>    <span class="p">......</span>
<span class="ln">12</span><span class="p">}</span>
</code></pre></div><h4 id="2224security_load_policykernel">2.2.2.4security_load_policy（kernel）</h4>
<p>android/common/security/selinux/ss/services.c</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ss_initialized</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 2</span>        <span class="n">avtab_cache_init</span><span class="p">();</span>
<span class="ln"> 3</span>        <span class="n">rc</span> <span class="o">=</span> <span class="n">policydb_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">policydb</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
<span class="ln"> 4</span>        <span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 5</span>            <span class="n">avtab_cache_destroy</span><span class="p">();</span>
<span class="ln"> 6</span>            <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="ln"> 7</span>        <span class="p">}</span>
<span class="ln"> 8</span> 
<span class="ln"> 9</span>        <span class="n">policydb</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
<span class="ln">10</span>        <span class="n">rc</span> <span class="o">=</span> <span class="n">selinux_set_mapping</span><span class="p">(</span><span class="o">&amp;</span><span class="n">policydb</span><span class="p">,</span> <span class="n">secclass_map</span><span class="p">,</span>
<span class="ln">11</span>                     <span class="err">¤</span><span class="n">t_mapping</span><span class="p">,</span>
<span class="ln">12</span>                     <span class="err">¤</span><span class="n">t_mapping_size</span><span class="p">);</span>
<span class="ln">13</span>        <span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">14</span>            <span class="n">policydb_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">policydb</span><span class="p">);</span>
<span class="ln">15</span>            <span class="n">avtab_cache_destroy</span><span class="p">();</span>
<span class="ln">16</span>            <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="ln">17</span>        <span class="p">}</span>
<span class="ln">18</span> 
<span class="ln">19</span>        <span class="n">rc</span> <span class="o">=</span> <span class="n">policydb_load_isids</span><span class="p">(</span><span class="o">&amp;</span><span class="n">policydb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sidtab</span><span class="p">);</span>
<span class="ln">20</span>        <span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">21</span>            <span class="n">policydb_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">policydb</span><span class="p">);</span>
<span class="ln">22</span>            <span class="n">avtab_cache_destroy</span><span class="p">();</span>
<span class="ln">23</span>            <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="ln">24</span>        <span class="p">}</span>
<span class="ln">25</span> 
<span class="ln">26</span>        <span class="n">security_load_policycaps</span><span class="p">();</span>
<span class="ln">27</span>        <span class="n">ss_initialized</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="ln">28</span>        <span class="n">seqno</span> <span class="o">=</span> <span class="o">++</span><span class="n">latest_granting</span><span class="p">;</span>
<span class="ln">29</span>        <span class="n">selinux_complete_init</span><span class="p">();</span>
<span class="ln">30</span>        <span class="n">avc_ss_reset</span><span class="p">(</span><span class="n">seqno</span><span class="p">);</span>
<span class="ln">31</span>        <span class="n">selnl_notify_policyload</span><span class="p">(</span><span class="n">seqno</span><span class="p">);</span>
<span class="ln">32</span>        <span class="n">selinux_status_update_policyload</span><span class="p">(</span><span class="n">seqno</span><span class="p">);</span>
<span class="ln">33</span>        <span class="n">selinux_netlbl_cache_invalidate</span><span class="p">();</span>
<span class="ln">34</span>        <span class="n">selinux_xfrm_notify_policyload</span><span class="p">();</span>
<span class="ln">35</span>        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="ln">36</span>    <span class="p">}</span>
</code></pre></div><p>通过policydb_read把数据读取保存到policydb这个数据结构里面</p>
<p>policydb是一个结构体</p>
<p>定义在：android/common/security/selinux/ss/policydb.h</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="k">struct</span> <span class="nc">policydb</span> <span class="p">{</span>
<span class="ln"> 2</span>    <span class="kt">int</span> <span class="n">mls_enabled</span><span class="p">;</span>
<span class="ln"> 3</span> 
<span class="ln"> 4</span>    <span class="cm">/* symbol tables */</span>
<span class="ln"> 5</span>    <span class="k">struct</span> <span class="nc">symtab</span> <span class="n">symtab</span><span class="p">[</span><span class="n">SYM_NUM</span><span class="p">];</span>
<span class="ln"> 6</span><span class="cp">#define p_commons symtab[SYM_COMMONS]
</span><span class="ln"> 7</span><span class="cp">#define p_classes symtab[SYM_CLASSES]
</span><span class="ln"> 8</span><span class="cp">#define p_roles symtab[SYM_ROLES]
</span><span class="ln"> 9</span><span class="cp">#define p_types symtab[SYM_TYPES]
</span><span class="ln">10</span><span class="cp">#define p_users symtab[SYM_USERS]
</span><span class="ln">11</span><span class="cp">#define p_bools symtab[SYM_BOOLS]
</span><span class="ln">12</span><span class="cp">#define p_levels symtab[SYM_LEVELS]
</span><span class="ln">13</span><span class="cp">#define p_cats symtab[SYM_CATS]
</span><span class="ln">14</span><span class="cp"></span> 
<span class="ln">15</span>    <span class="cm">/* symbol names indexed by (value - 1) */</span>
<span class="ln">16</span>    <span class="k">struct</span> <span class="nc">flex_array</span> <span class="o">*</span><span class="n">sym_val_to_name</span><span class="p">[</span><span class="n">SYM_NUM</span><span class="p">];</span>
<span class="ln">17</span> 
<span class="ln">18</span>    <span class="cm">/* class, role, and user attributes indexed by (value - 1) */</span>
<span class="ln">19</span>    <span class="k">struct</span> <span class="nc">class_datum</span> <span class="o">**</span><span class="n">class_val_to_struct</span><span class="p">;</span>
<span class="ln">20</span>    <span class="k">struct</span> <span class="nc">role_datum</span> <span class="o">**</span><span class="n">role_val_to_struct</span><span class="p">;</span>
<span class="ln">21</span>    <span class="k">struct</span> <span class="nc">user_datum</span> <span class="o">**</span><span class="n">user_val_to_struct</span><span class="p">;</span>
<span class="ln">22</span>    <span class="k">struct</span> <span class="nc">flex_array</span> <span class="o">*</span><span class="n">type_val_to_struct_array</span><span class="p">;</span>
<span class="ln">23</span> 
<span class="ln">24</span>    <span class="cm">/* type enforcement access vectors and transitions */</span>
<span class="ln">25</span>    <span class="k">struct</span> <span class="nc">avtab</span> <span class="n">te_avtab</span><span class="p">;</span>
<span class="ln">26</span> 
<span class="ln">27</span>    <span class="cm">/* role transitions */</span>
<span class="ln">28</span>    <span class="k">struct</span> <span class="nc">role_trans</span> <span class="o">*</span><span class="n">role_tr</span><span class="p">;</span>
<span class="ln">29</span> 
<span class="ln">30</span>    <span class="cm">/* file transitions with the last path component */</span>
<span class="ln">31</span>    <span class="cm">/* quickly exclude lookups when parent ttype has no rules */</span>
<span class="ln">32</span>    <span class="k">struct</span> <span class="nc">ebitmap</span> <span class="n">filename_trans_ttypes</span><span class="p">;</span>
<span class="ln">33</span>    <span class="cm">/* actual set of filename_trans rules */</span>
<span class="ln">34</span>    <span class="k">struct</span> <span class="nc">hashtab</span> <span class="o">*</span><span class="n">filename_trans</span><span class="p">;</span>
<span class="ln">35</span> 
<span class="ln">36</span>    <span class="cm">/* bools indexed by (value - 1) */</span>
<span class="ln">37</span>    <span class="k">struct</span> <span class="nc">cond_bool_datum</span> <span class="o">**</span><span class="n">bool_val_to_struct</span><span class="p">;</span>
<span class="ln">38</span>    <span class="cm">/* type enforcement conditional access vectors and transitions */</span>
<span class="ln">39</span>    <span class="k">struct</span> <span class="nc">avtab</span> <span class="n">te_cond_avtab</span><span class="p">;</span>
<span class="ln">40</span>    <span class="cm">/* linked list indexing te_cond_avtab by conditional */</span>
<span class="ln">41</span>    <span class="k">struct</span> <span class="nc">cond_node</span> <span class="o">*</span><span class="n">cond_list</span><span class="p">;</span>
<span class="ln">42</span> 
<span class="ln">43</span>    <span class="cm">/* role allows */</span>
<span class="ln">44</span>    <span class="k">struct</span> <span class="nc">role_allow</span> <span class="o">*</span><span class="n">role_allow</span><span class="p">;</span>
<span class="ln">45</span> 
<span class="ln">46</span>    <span class="cm">/* security contexts of initial SIDs, unlabeled file systems,
</span><span class="ln">47</span><span class="cm">       TCP or UDP port numbers, network interfaces and nodes */</span>
<span class="ln">48</span>    <span class="k">struct</span> <span class="nc">ocontext</span> <span class="o">*</span><span class="n">ocontexts</span><span class="p">[</span><span class="n">OCON_NUM</span><span class="p">];</span>
<span class="ln">49</span> 
<span class="ln">50</span>    <span class="cm">/* security contexts for files in filesystems that cannot support
</span><span class="ln">51</span><span class="cm">       a persistent label mapping or use another
</span><span class="ln">52</span><span class="cm">       fixed labeling behavior. */</span>
<span class="ln">53</span>    <span class="k">struct</span> <span class="nc">genfs</span> <span class="o">*</span><span class="n">genfs</span><span class="p">;</span>
<span class="ln">54</span> 
<span class="ln">55</span>    <span class="cm">/* range transitions table (range_trans_key -&gt; mls_range) */</span>
<span class="ln">56</span>    <span class="k">struct</span> <span class="nc">hashtab</span> <span class="o">*</span><span class="n">range_tr</span><span class="p">;</span>
<span class="ln">57</span> 
<span class="ln">58</span>    <span class="cm">/* type -&gt; attribute reverse mapping */</span>
<span class="ln">59</span>    <span class="k">struct</span> <span class="nc">flex_array</span> <span class="o">*</span><span class="n">type_attr_map_array</span><span class="p">;</span>
<span class="ln">60</span> 
<span class="ln">61</span>    <span class="k">struct</span> <span class="nc">ebitmap</span> <span class="n">policycaps</span><span class="p">;</span>
<span class="ln">62</span> 
<span class="ln">63</span>    <span class="k">struct</span> <span class="nc">ebitmap</span> <span class="n">permissive_map</span><span class="p">;</span>
<span class="ln">64</span> 
<span class="ln">65</span>    <span class="cm">/* length of this policy when it was loaded */</span>
<span class="ln">66</span>    <span class="n">size_t</span> <span class="n">len</span><span class="p">;</span>
<span class="ln">67</span> 
<span class="ln">68</span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">policyvers</span><span class="p">;</span>
<span class="ln">69</span> 
<span class="ln">70</span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nl">reject_unknown</span> <span class="p">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="ln">71</span>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nl">allow_unknown</span> <span class="p">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="ln">72</span> 
<span class="ln">73</span>    <span class="n">u16</span> <span class="n">process_class</span><span class="p">;</span>
<span class="ln">74</span>    <span class="n">u32</span> <span class="n">process_trans_perms</span><span class="p">;</span>
<span class="ln">75</span><span class="p">};</span>
</code></pre></div><p>将安全策略从用户空间加载到 SELinux LSM 模块中去了，这个数据结构很复杂</p>
<p>te规则最后会保存在</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln">1</span><span class="cm">/* type enforcement access vectors and transitions */</span>
<span class="ln">2</span><span class="k">struct</span> <span class="nc">avtab</span> <span class="n">te_avtab</span><span class="p">;</span>
</code></pre></div><blockquote>
<p>另外还有服务、属性等初始化，有兴趣可以结合大佬的博客一起看看：</p>
<ul>
<li><a href="https://blog.csdn.net/Luoshengyang/article/details/37749383">SEAndroid安全机制中的文件安全上下文关联分析</a></li>
<li><a href="https://blog.csdn.net/luoshengyang/article/details/38054645">SEAndroid安全机制中的进程安全上下文关联分析</a></li>
<li><a href="https://blog.csdn.net/Luoshengyang/article/details/38102011">SEAndroid安全机制对Android属性访问的保护分析</a></li>
<li><a href="https://blog.csdn.net/Luoshengyang/article/details/38326729">SEAndroid安全机制对Binder IPC的保护分析</a></li>
</ul>
</blockquote>
<p>还记得最开头有提到，在android/device/xxxxxx/common/sepolicy和android/system/sepolicy都要添加 xxx.te，而有些方案却不用？</p>
<p>分析mk之后，不难发现，是因为去掉了这个：</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/SElinux/selinux_5.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/SElinux/selinux_5.png" >
  
    </a>
  
  
</div>

<p>然后检查对比的动作没有做了</p>
<h2 id="23总结">2.3总结</h2>
<p>到这里，总结一下：</p>
<p>1、从Android8.0之后，加载的是 /(vendor|odm)/etc/selinux/precompiled_sepolicy ，以前的版本用的是 /sepolicy，如下图</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/SElinux/selinux_6.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/SElinux/selinux_6.png" >
  
    </a>
  
  
</div>

<p>2、有些平台上有odm分区，因此用的是 /odm/etc/selinux/precompiled_sepolicy，这也就是为什么前面提到的编译替换/vendor/etc/selinux/和/system/etc/selinux/没有效果的原因</p>
<h1 id="3权限检查原理与调试">3权限检查原理与调试</h1>
<p>我们在处理SELinux权限问题的时候，avc denied信息是最关键的，那么avc denied 的打印信息要怎么看、里面的内容每一个字段是什么意思？kernel log的avc denied信息是哪里打印出来的？</p>
<p>以前有个想法，我们系统的操作、命令都是有限的，那其实脚本写完之后需要什么权限都是确定的，那可不可能更快的加好te规则呢？</p>
<p>假设有如下脚本以及te规则</p>
<ul>
<li>/vendor/bin/testA.sh</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span><span class="cp">#!/vendor/bin/sh
</span><span class="ln">2</span><span class="cp"></span>
<span class="ln">3</span><span class="nb">echo</span> <span class="s2">&#34;hello world&#34;</span> &gt; /data/vendor/test.txt
</code></pre></div><ul>
<li>/android/device/xxxx/common/sepolicy/file_contexts</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>/vendor/bin/testA.sh     u:object_r:testA_exec:s0
</code></pre></div><ul>
<li>/android/device/xxxx/common/sepolicy/testA.te</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>type testA, domain;
<span class="ln">2</span>type testA_exec, exec_type, vendor_file_type, file_type;
<span class="ln">3</span> 
<span class="ln">4</span>init_daemon_domain(testA)
<span class="ln">5</span> 
<span class="ln">6</span>allow testA picasso_device:chr_file { write open getattr ioctl };
<span class="ln">7</span>allow testA vendor_toolbox_exec:file { execute_no_trans };
<span class="ln">8</span>allow testA vendor_data_file:dir { add_name };
</code></pre></div><p>执行脚本后，会有如下报错信息：</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span><span class="o">[</span> 5424.996583@0<span class="o">]</span>- <span class="nv">type</span><span class="o">=</span><span class="m">1400</span> audit<span class="o">(</span>1577887433.668:59<span class="o">)</span>: avc: denied <span class="o">{</span> write <span class="o">}</span> <span class="k">for</span> <span class="nv">pid</span><span class="o">=</span><span class="m">4021</span> <span class="nv">comm</span><span class="o">=</span><span class="s2">&#34;testA.sh&#34;</span>
<span class="ln">2</span><span class="nv">name</span><span class="o">=</span><span class="s2">&#34;vendor&#34;</span> <span class="nv">dev</span><span class="o">=</span><span class="s2">&#34;mmcblk0p20&#34;</span> <span class="nv">ino</span><span class="o">=</span><span class="m">7395</span> <span class="nv">scontext</span><span class="o">=</span>u:r:testA:s0 <span class="nv">tcontext</span><span class="o">=</span>u:object_r:vendor_data_file:s0 <span class="nv">tclass</span><span class="o">=</span>dir <span class="nv">permissive</span><span class="o">=</span><span class="m">0</span>
</code></pre></div><h2 id="31权限检测原理">3.1权限检测原理</h2>
<p>这部分的代码集中在两个部分</p>
<ul>
<li>kernel的代码，里面的security/selinux</li>
<li>/android/external/selinux</li>
</ul>
<p>一开始，/data/vendor/test.txt是不存在的；testA.sh脚本运行起来之后，它的安全上下文是u:r:testA:s0，type为testA的进程，要拥有对type为vendor_data_file的目录(dir)的写(write)权限，才能创建一个不存在的文件</p>
<p>权限检测其实就是针对进程访问对象的两个权限：拥有的权限和需要的权限，将两者进行计算得出结果，即允许还是拒绝</p>
<h3 id="311拥有的权限">3.1.1拥有的权限</h3>
<p>te规则定义的权限保存在哪里？</p>
<p>testA.te里面它拥有add_name权限，前面的文章有提到te策略文件的编译过程，这个规则最终会生成在二进制策略文件precompiled_sepolicy里面，而policydb这个数据结构是用来组织起所有数据的</p>
<p>其中te规则保存在这个成员里面</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln">1</span><span class="cm">/* type enforcement access vectors and transitions */</span>
<span class="ln">2</span><span class="n">avtab_t</span> <span class="n">te_avtab</span><span class="p">;</span>
</code></pre></div><p>这里面的数据结构比较复杂，里面主要需要理解几个数据结构：</p>
<ul>
<li>位图ebitmap</li>
<li>链表</li>
<li>哈希表hashtab</li>
<li>符号表symtab</li>
</ul>
<p>这里面的内容太多了，我只是简单分析了其中te规则一部分代码，有兴趣可以结合参考文章《Linux多安全策略和动态安全策 略框架模块代码分析报告》（见参考文章）来阅读源码深入了解</p>
<p>下面分析的一些结论，如有问题请指出：</p>
<p>testA这个type的进程，对type为vendor_data_file的dir(目录)所拥有的权限是用一个整数u32来表示的：</p>
<p>它的值是：</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln">1</span><span class="mh">0x00120010</span>
</code></pre></div><p>下面简单看看这个值是怎么生成的？</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>(allow testA_30_0 vendor_data_file_30_0 (dir (add_name)))
</code></pre></div><p>接着看看 <strong>/android/external/selinux/libsepol/cil/src/cil_binary.c</strong> 里面的__cil_perms_to_datum函数</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="kt">int</span> <span class="nf">__cil_perms_to_datum</span><span class="p">(</span><span class="k">struct</span> <span class="nc">cil_list</span> <span class="o">*</span><span class="n">perms</span><span class="p">,</span> <span class="n">class_datum_t</span> <span class="o">*</span><span class="n">sepol_class</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">datum</span><span class="p">)</span>
<span class="ln"> 2</span><span class="p">{</span>
<span class="ln"> 3</span>    <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">SEPOL_ERR</span><span class="p">;</span>
<span class="ln"> 4</span>    <span class="kt">char</span> <span class="o">*</span><span class="n">key</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="ln"> 5</span>    <span class="k">struct</span> <span class="nc">cil_list_item</span> <span class="o">*</span><span class="n">curr_perm</span><span class="p">;</span>
<span class="ln"> 6</span>    <span class="k">struct</span> <span class="nc">cil_perm</span> <span class="o">*</span><span class="n">cil_perm</span><span class="p">;</span>
<span class="ln"> 7</span>    <span class="kt">uint32_t</span> <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="ln"> 8</span> 
<span class="ln"> 9</span>    <span class="n">cil_list_for_each</span><span class="p">(</span><span class="n">curr_perm</span><span class="p">,</span> <span class="n">perms</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">10</span>        <span class="n">cil_perm</span> <span class="o">=</span> <span class="n">curr_perm</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
<span class="ln">11</span>        <span class="n">key</span> <span class="o">=</span> <span class="n">cil_perm</span><span class="o">-&gt;</span><span class="n">datum</span><span class="p">.</span><span class="n">fqn</span><span class="p">;</span>
<span class="ln">12</span> 
<span class="ln">13</span>        <span class="n">rc</span> <span class="o">=</span> <span class="n">__perm_str_to_datum</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">sepol_class</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
<span class="ln">14</span>        <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">SEPOL_OK</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">15</span>            <span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
<span class="ln">16</span>        <span class="p">}</span>
<span class="ln">17</span>    <span class="p">}</span>
<span class="ln">18</span> 
<span class="ln">19</span>    <span class="o">*</span><span class="n">datum</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
<span class="ln">20</span> 
<span class="ln">21</span>    <span class="k">return</span> <span class="n">SEPOL_OK</span><span class="p">;</span>
<span class="ln">22</span> 
<span class="ln">23</span><span class="nl">exit</span><span class="p">:</span>
<span class="ln">24</span>    <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="ln">25</span><span class="p">}</span>
<span class="ln">26</span> 
<span class="ln">27</span> 
<span class="ln">28</span><span class="kt">int</span> <span class="nf">__perm_str_to_datum</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">perm_str</span><span class="p">,</span> <span class="n">class_datum_t</span> <span class="o">*</span><span class="n">sepol_class</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">datum</span><span class="p">)</span>
<span class="ln">29</span><span class="p">{</span>
<span class="ln">30</span>    <span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
<span class="ln">31</span>    <span class="n">perm_datum_t</span> <span class="o">*</span><span class="n">sepol_perm</span><span class="p">;</span>
<span class="ln">32</span>    <span class="n">common_datum_t</span> <span class="o">*</span><span class="n">sepol_common</span><span class="p">;</span>
<span class="ln">33</span> 
<span class="ln">34</span>    <span class="n">sepol_perm</span> <span class="o">=</span> <span class="n">hashtab_search</span><span class="p">(</span><span class="n">sepol_class</span><span class="o">-&gt;</span><span class="n">permissions</span><span class="p">.</span><span class="n">table</span><span class="p">,</span> <span class="n">perm_str</span><span class="p">);</span>
<span class="ln">35</span>    <span class="k">if</span> <span class="p">(</span><span class="n">sepol_perm</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">36</span>        <span class="n">sepol_common</span> <span class="o">=</span> <span class="n">sepol_class</span><span class="o">-&gt;</span><span class="n">comdatum</span><span class="p">;</span>
<span class="ln">37</span>        <span class="n">sepol_perm</span> <span class="o">=</span> <span class="n">hashtab_search</span><span class="p">(</span><span class="n">sepol_common</span><span class="o">-&gt;</span><span class="n">permissions</span><span class="p">.</span><span class="n">table</span><span class="p">,</span> <span class="n">perm_str</span><span class="p">);</span>
<span class="ln">38</span>        <span class="k">if</span> <span class="p">(</span><span class="n">sepol_perm</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">39</span>            <span class="n">cil_log</span><span class="p">(</span><span class="n">CIL_ERR</span><span class="p">,</span> <span class="s">&#34;Failed to find datum for perm %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">perm_str</span><span class="p">);</span>
<span class="ln">40</span>            <span class="n">rc</span> <span class="o">=</span> <span class="n">SEPOL_ERR</span><span class="p">;</span>
<span class="ln">41</span>            <span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
<span class="ln">42</span>        <span class="p">}</span>
<span class="ln">43</span>    <span class="p">}</span>
<span class="ln">44</span>    <span class="o">*</span><span class="n">datum</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">sepol_perm</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">value</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="ln">45</span> 
<span class="ln">46</span>    <span class="k">return</span> <span class="n">SEPOL_OK</span><span class="p">;</span>
<span class="ln">47</span> 
<span class="ln">48</span><span class="nl">exit</span><span class="p">:</span>
<span class="ln">49</span>    <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="ln">50</span><span class="p">}</span>
</code></pre></div><p>datum 里面保存的值就是0x00120010</p>
<p>看最关键的一句话：</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln">1</span><span class="o">*</span><span class="n">datum</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">sepol_perm</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">value</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</code></pre></div><p>上面的操作其实就是将对应的位置1，代表它拥有的权限，那每一个位对应的权限是什么呢？
这个要看：</p>
<p><strong>/android/system/sepolicy/private/access_vectors</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln"> 1</span>common file
<span class="ln"> 2</span>{
<span class="ln"> 3</span>    ioctl
<span class="ln"> 4</span>    read
<span class="ln"> 5</span>    write
<span class="ln"> 6</span>    create
<span class="ln"> 7</span>    getattr
<span class="ln"> 8</span>    setattr
<span class="ln"> 9</span>    lock
<span class="ln">10</span>    relabelfrom
<span class="ln">11</span>    relabelto
<span class="ln">12</span>    append
<span class="ln">13</span>    map
<span class="ln">14</span>    unlink
<span class="ln">15</span>    link
<span class="ln">16</span>    rename
<span class="ln">17</span>    execute
<span class="ln">18</span>    quotaon
<span class="ln">19</span>    mounton
<span class="ln">20</span>}
<span class="ln">21</span> 
<span class="ln">22</span>class dir
<span class="ln">23</span>inherits file
<span class="ln">24</span>{
<span class="ln">25</span>    add_name
<span class="ln">26</span>    remove_name
<span class="ln">27</span>    reparent
<span class="ln">28</span>    search
<span class="ln">29</span>    rmdir
<span class="ln">30</span>    open
<span class="ln">31</span>    audit_access
<span class="ln">32</span>    execmod
<span class="ln">33</span>}
</code></pre></div><p>sepol_perm-&gt;s.value可以理解成是解析过程中某个权限在access_vectors定义的class里面的index值，它会用符号表和对应的字符串关联起来，比如add_name在集合里面的是第18个，对应的值是0x00020000</p>
<p>我们这里的是dir，将其合并下：</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln">1</span><span class="p">{</span>
<span class="ln">2</span>    <span class="n">ioctl</span><span class="p">,</span><span class="n">read</span><span class="p">,</span><span class="n">write</span><span class="p">,</span><span class="n">create</span><span class="p">,</span><span class="n">getattr</span><span class="p">,</span><span class="n">setattr</span><span class="p">,</span><span class="n">lock</span><span class="p">,</span><span class="n">relabelfrom</span><span class="p">,</span><span class="n">relabelto</span><span class="p">,</span><span class="n">append</span><span class="p">,</span><span class="n">map</span><span class="p">,</span><span class="n">unlink</span><span class="p">,</span>
<span class="ln">3</span>    <span class="n">link</span><span class="p">,</span><span class="n">rename</span><span class="p">,</span><span class="n">execute</span><span class="p">,</span><span class="n">quotaon</span><span class="p">,</span><span class="n">mounton</span><span class="p">,</span><span class="n">add_name</span><span class="p">,</span><span class="n">remove_name</span><span class="p">,</span><span class="n">reparent</span><span class="p">,</span><span class="n">search</span><span class="p">,</span><span class="n">rmdir</span><span class="p">,</span><span class="n">open</span><span class="p">,</span>
<span class="ln">4</span>    <span class="n">audit_access</span><span class="p">,</span><span class="n">execmod</span>
<span class="ln">5</span><span class="p">}</span>
</code></pre></div><p>上面那句话的操作就是将datum的第18位置成1</p>
<p>那么最后计算出来的0x00120010就是：</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/SElinux/selinux_7.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/SElinux/selinux_7.png" >
  
    </a>
  
  
</div>

<p>翻译过来，是这个规则</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>allow testA vendor_data_file:dir { search add_name getattr };
</code></pre></div><p>奇怪的是，这里怎么会多出来两个权限呢，我都没有加上去</p>
<p>原因是来自这条规则：</p>
<p>这个在domain.te里面</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>allow domain vendor_data_file:dir { getattr search };
</code></pre></div><h3 id="312需要的权限">3.1.2需要的权限</h3>
<p>要分析操作vendor_data_file:dir所需要的权限，借助打印堆栈信息来分析：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln"> 1</span><span class="o">[</span> 5424.899991@1<span class="o">]</span>d CPU: <span class="m">1</span> PID: <span class="m">4119</span> Comm: testA.sh Tainted: P           O    4.9.113 <span class="c1">#14</span>
<span class="ln"> 2</span><span class="o">[</span> 5424.907561@1<span class="o">]</span>d Hardware name: Generic DT based system
<span class="ln"> 3</span><span class="o">[</span> 5424.912595@1<span class="o">]</span>d <span class="o">[</span>bc3c7a84+  16<span class="o">][</span>&lt;c020dc10&gt;<span class="o">]</span> show_stack+0x20/0x24
<span class="ln"> 4</span><span class="o">[</span> 5424.918447@1<span class="o">]</span>d <span class="o">[</span>bc3c7aa4+  32<span class="o">][</span>&lt;c05443ec&gt;<span class="o">]</span> dump_stack+0x90/0xac
<span class="ln"> 5</span><span class="o">[</span> 5424.924311@1<span class="o">]</span>d <span class="o">[</span>bc3c7aec+  72<span class="o">][</span>&lt;c04d5954&gt;<span class="o">]</span> slow_avc_audit+0x88/0xa8
<span class="ln"> 6</span><span class="o">[</span> 5424.930515@1<span class="o">]</span>d <span class="o">[</span>bc3c7b34+  72<span class="o">][</span>&lt;c04da498&gt;<span class="o">]</span> audit_inode_permission+0x80/0x88
<span class="ln"> 7</span><span class="o">[</span> 5424.937417@1<span class="o">]</span>d <span class="o">[</span>bc3c7bac+ 120<span class="o">][</span>&lt;c04daf20&gt;<span class="o">]</span> selinux_inode_permission+0x2d0/0x314
<span class="ln"> 8</span><span class="o">[</span> 5424.944664@1<span class="o">]</span>d <span class="o">[</span>bc3c7bcc+  32<span class="o">][</span>&lt;c04d1f44&gt;<span class="o">]</span> security_inode_permission+0x4c/0x68
<span class="ln"> 9</span><span class="o">[</span> 5424.951824@1<span class="o">]</span>d <span class="o">[</span>bc3c7bec+  32<span class="o">][</span>&lt;c03a5bc8&gt;<span class="o">]</span> __inode_permission2+0x50/0xf0
<span class="ln">10</span><span class="o">[</span> 5424.958455@1<span class="o">]</span>d <span class="o">[</span>bc3c7bfc+  16<span class="o">][</span>&lt;c03a5cb0&gt;<span class="o">]</span> inode_permission2+0x20/0x54
<span class="ln">11</span><span class="o">[</span> 5424.964930@1<span class="o">]</span>d <span class="o">[</span>bc3c7c84+ 136<span class="o">][</span>&lt;c03a9048&gt;<span class="o">]</span> path_openat+0xb30/0x118c
<span class="ln">12</span><span class="o">[</span> 5424.971137@1<span class="o">]</span>d <span class="o">[</span>bc3c7d2c+ 168<span class="o">][</span>&lt;c03aabe4&gt;<span class="o">]</span> do_filp_open+0x7c/0xe0
<span class="ln">13</span><span class="o">[</span> 5424.977179@1<span class="o">]</span>d <span class="o">[</span>bc3c7d7c+  80<span class="o">][</span>&lt;c0397b34&gt;<span class="o">]</span> do_sys_open+0x124/0x238
<span class="ln">14</span><span class="o">[</span> 5424.983303@1<span class="o">]</span>d <span class="o">[</span>bc3c7d8c+  16<span class="o">][</span>&lt;c0397c90&gt;<span class="o">]</span> SyS_openat+0x1c/0x20
<span class="ln">15</span><span class="o">[</span> 5424.989165@1<span class="o">]</span>d <span class="o">[</span>00000000+   0<span class="o">][</span>&lt;c02085c0&gt;<span class="o">]</span> ret_fast_syscall+0x0/0x48
<span class="ln">16</span> 
<span class="ln">17</span>用addr2line看看对应的代码调用逻辑
<span class="ln">18</span><span class="m">1</span>  show_stack c020dc10
<span class="ln">19</span>show_stack
<span class="ln">20</span>kernelcode/arch/arm/kernel/traps.c:263
<span class="ln">21</span> 
<span class="ln">22</span><span class="m">2</span>  dump_stack c05443ec
<span class="ln">23</span>dump_stack
<span class="ln">24</span>kernelcode/lib/dump_stack.c:53
<span class="ln">25</span> 
<span class="ln">26</span><span class="m">3</span>  slow_avc_audit c04d5954
<span class="ln">27</span>slow_avc_audit
<span class="ln">28</span>kernelcode/security/selinux/avc.c:775
<span class="ln">29</span> 
<span class="ln">30</span><span class="m">4</span>  audit_inode_permission c04da498
<span class="ln">31</span>audit_inode_permission
<span class="ln">32</span>kernelcode/security/selinux/hooks.c:3005
<span class="ln">33</span> 
<span class="ln">34</span><span class="m">5</span>  selinux_inode_permission c04daf20
<span class="ln">35</span>selinux_inode_permission
<span class="ln">36</span>kernelcode/security/selinux/hooks.c:3058
<span class="ln">37</span> 
<span class="ln">38</span><span class="m">6</span>  security_inode_permission c04d1f44
<span class="ln">39</span>security_inode_permission
<span class="ln">40</span>kernelcode/security/security.c:611 <span class="o">(</span>discriminator 5<span class="o">)</span>
<span class="ln">41</span> 
<span class="ln">42</span><span class="m">7</span>  __inode_permission2 c03a5bc8
<span class="ln">43</span>__inode_permission2
<span class="ln">44</span>kernelcode/fs/namei.c:436
<span class="ln">45</span> 
<span class="ln">46</span><span class="m">8</span>  inode_permission2 c03a5cb0
<span class="ln">47</span>inode_permission2
<span class="ln">48</span>kernelcode/fs/namei.c:486
<span class="ln">49</span> 
<span class="ln">50</span><span class="m">9</span>  path_openat c03a9048
<span class="ln">51</span>may_o_create
<span class="ln">52</span>kernelcode/fs/namei.c:3018
<span class="ln">53</span> 
<span class="ln">54</span><span class="m">10</span>  do_filp_open c03aabe4
<span class="ln">55</span>do_filp_open
<span class="ln">56</span>kernelcode/fs/namei.c:3569
<span class="ln">57</span> 
<span class="ln">58</span><span class="m">11</span>  do_sys_open c0397b34
<span class="ln">59</span>do_sys_open
<span class="ln">60</span>kernelcode/fs/open.c:1073
<span class="ln">61</span> 
<span class="ln">62</span><span class="m">12</span>  SyS_openat c0397c90
<span class="ln">63</span>SyS_openat
<span class="ln">64</span>kernelcode/fs/open.c:1093
<span class="ln">65</span> 
<span class="ln">66</span><span class="m">13</span>  ret_fast_syscall c02085c0
<span class="ln">67</span>ret_fast_syscall
<span class="ln">68</span>kernelcode/arch/arm/kernel/entry-common.S:37
</code></pre></div><p>堆栈打印添加在kernel代码里面：</p>
<p>kernelcode$ git diff security/selinux/avc.c</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln"> 1</span>diff --git a/security/selinux/avc.c b/security/selinux/avc.c
<span class="ln"> 2</span>index e60c79d..79cea20 <span class="m">100644</span>
<span class="ln"> 3</span>--- a/security/selinux/avc.c
<span class="ln"> 4</span>+++ b/security/selinux/avc.c
<span class="ln"> 5</span>@@ -771,7 +771,7 @@ noinline int slow_avc_audit<span class="o">(</span>u32 ssid, u32 tsid, u16 tclass,
<span class="ln"> 6</span>        sad.result <span class="o">=</span> result<span class="p">;</span>
<span class="ln"> 7</span>  
<span class="ln"> 8</span>        a-&gt;selinux_audit_data <span class="o">=</span> <span class="p">&amp;</span>sad<span class="p">;</span>
<span class="ln"> 9</span>-
<span class="ln">10</span>+       dump_stack<span class="o">()</span><span class="p">;</span>
<span class="ln">11</span>        common_lsm_audit<span class="o">(</span>a, avc_audit_pre_callback, avc_audit_post_callback<span class="o">)</span><span class="p">;</span>
<span class="ln">12</span>        <span class="k">return</span> 0<span class="p">;</span>
<span class="ln">13</span> <span class="o">}</span>
</code></pre></div><p>跟着堆栈简单看一遍代码，不难发现，需要的权限是从这里来的</p>
<p>may_o_create</p>
<p>kernelcode/fs/namei.c:3018</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="k">static</span> <span class="kt">int</span> <span class="nf">may_o_create</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="nc">path</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="n">umode_t</span> <span class="n">mode</span><span class="p">)</span>
<span class="ln"> 2</span><span class="p">{</span>
<span class="ln"> 3</span>    <span class="k">struct</span> <span class="nc">user_namespace</span> <span class="o">*</span><span class="n">s_user_ns</span><span class="p">;</span>
<span class="ln"> 4</span>    <span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="n">security_path_mknod</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">dentry</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="ln"> 5</span>    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
<span class="ln"> 6</span>        <span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="ln"> 7</span> 
<span class="ln"> 8</span>    <span class="n">s_user_ns</span> <span class="o">=</span> <span class="n">dir</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_sb</span><span class="o">-&gt;</span><span class="n">s_user_ns</span><span class="p">;</span>
<span class="ln"> 9</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kuid_has_mapping</span><span class="p">(</span><span class="n">s_user_ns</span><span class="p">,</span> <span class="n">current_fsuid</span><span class="p">())</span> <span class="o">||</span>
<span class="ln">10</span>        <span class="o">!</span><span class="n">kgid_has_mapping</span><span class="p">(</span><span class="n">s_user_ns</span><span class="p">,</span> <span class="n">current_fsgid</span><span class="p">()))</span>
<span class="ln">11</span>        <span class="k">return</span> <span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">;</span>
<span class="ln">12</span> 
<span class="ln">13</span>    <span class="n">error</span> <span class="o">=</span> <span class="n">inode_permission2</span><span class="p">(</span><span class="n">dir</span><span class="o">-&gt;</span><span class="n">mnt</span><span class="p">,</span> <span class="n">dir</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">,</span> <span class="n">MAY_WRITE</span> <span class="o">|</span> <span class="n">MAY_EXEC</span><span class="p">);</span>
<span class="ln">14</span>    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
<span class="ln">15</span>        <span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="ln">16</span> 
<span class="ln">17</span>    <span class="k">return</span> <span class="n">security_inode_create</span><span class="p">(</span><span class="n">dir</span><span class="o">-&gt;</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">,</span> <span class="n">dentry</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
<span class="ln">18</span><span class="p">}</span>
</code></pre></div><p>inode_permission2的第三个参数 MAY_WRITE | MAY_EXEC</p>
<p>会一直传递到 kernelcode/security/selinux/hooks.c</p>
<p>selinux_inode_permission这个函数的第二参数mask</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="k">static</span> <span class="kt">int</span> <span class="nf">selinux_inode_permission</span><span class="p">(</span><span class="k">struct</span> <span class="nc">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">)</span>
<span class="ln"> 2</span><span class="p">{</span>
<span class="ln"> 3</span>    <span class="k">const</span> <span class="k">struct</span> <span class="nc">cred</span> <span class="o">*</span><span class="n">cred</span> <span class="o">=</span> <span class="n">current_cred</span><span class="p">();</span>
<span class="ln"> 4</span>    <span class="n">u32</span> <span class="n">perms</span><span class="p">;</span>
<span class="ln"> 5</span>    <span class="kt">bool</span> <span class="n">from_access</span><span class="p">;</span>
<span class="ln"> 6</span>    <span class="kt">unsigned</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">MAY_NOT_BLOCK</span><span class="p">;</span>
<span class="ln"> 7</span>    <span class="k">struct</span> <span class="nc">inode_security_struct</span> <span class="o">*</span><span class="n">isec</span><span class="p">;</span>
<span class="ln"> 8</span>    <span class="n">u32</span> <span class="n">sid</span><span class="p">;</span>
<span class="ln"> 9</span>    <span class="k">struct</span> <span class="nc">av_decision</span> <span class="n">avd</span><span class="p">;</span>
<span class="ln">10</span>    <span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">rc2</span><span class="p">;</span>
<span class="ln">11</span>    <span class="n">u32</span> <span class="n">audited</span><span class="p">,</span> <span class="n">denied</span><span class="p">;</span>
<span class="ln">12</span> 
<span class="ln">13</span>    <span class="n">from_access</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">MAY_ACCESS</span><span class="p">;</span>
<span class="ln">14</span>  <span class="c1">//mask = MAY_WRITE | MAY_EXEC;
</span><span class="ln">15</span><span class="c1"></span>    <span class="n">mask</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">MAY_READ</span><span class="o">|</span><span class="n">MAY_WRITE</span><span class="o">|</span><span class="n">MAY_EXEC</span><span class="o">|</span><span class="n">MAY_APPEND</span><span class="p">);</span>
<span class="ln">16</span> 
<span class="ln">17</span>    <span class="cm">/* No permission to check.  Existence test. */</span>
<span class="ln">18</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mask</span><span class="p">)</span>
<span class="ln">19</span>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="ln">20</span> 
<span class="ln">21</span>    <span class="n">validate_creds</span><span class="p">(</span><span class="n">cred</span><span class="p">);</span>
<span class="ln">22</span> 
<span class="ln">23</span>    <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">IS_PRIVATE</span><span class="p">(</span><span class="n">inode</span><span class="p">)))</span>
<span class="ln">24</span>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="ln">25</span> 
<span class="ln">26</span>  <span class="c1">//mask = MAY_WRITE | MAY_EXEC;
</span><span class="ln">27</span><span class="c1"></span>  <span class="c1">//perms = DIR__WRITE | DIR__SEARCH
</span><span class="ln">28</span><span class="c1"></span>  <span class="c1">//perms = 0x00400004
</span><span class="ln">29</span><span class="c1"></span>    <span class="n">perms</span> <span class="o">=</span> <span class="n">file_mask_to_av</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
<span class="ln">30</span> 
<span class="ln">31</span>    <span class="n">sid</span> <span class="o">=</span> <span class="n">cred_sid</span><span class="p">(</span><span class="n">cred</span><span class="p">);</span>
<span class="ln">32</span>    <span class="n">isec</span> <span class="o">=</span> <span class="n">inode_security_rcu</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MAY_NOT_BLOCK</span><span class="p">);</span>
<span class="ln">33</span>    <span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">isec</span><span class="p">))</span>
<span class="ln">34</span>        <span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">isec</span><span class="p">);</span>
<span class="ln">35</span> 
<span class="ln">36</span>  <span class="c1">//主要是获取av_decision信息，里面包含了权限信息，先从avc cache里面获取，如果没有就从policydb里面计算得出
</span><span class="ln">37</span><span class="c1"></span>    <span class="n">rc</span> <span class="o">=</span> <span class="n">avc_has_perm_noaudit</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="n">isec</span><span class="o">-&gt;</span><span class="n">sid</span><span class="p">,</span> <span class="n">isec</span><span class="o">-&gt;</span><span class="n">sclass</span><span class="p">,</span> <span class="n">perms</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">avd</span><span class="p">);</span>
<span class="ln">38</span>  <span class="c1">//这个就是审计、裁决的动作了，计算拥有的权限avd和需要的权限perms，得出缺失的权限
</span><span class="ln">39</span><span class="c1"></span>    <span class="n">audited</span> <span class="o">=</span> <span class="n">avc_audit_required</span><span class="p">(</span><span class="n">perms</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">avd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span>
<span class="ln">40</span>                     <span class="n">from_access</span> <span class="o">?</span> <span class="nl">FILE__AUDIT_ACCESS</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<span class="ln">41</span>                     <span class="o">&amp;</span><span class="n">denied</span><span class="p">);</span>
<span class="ln">42</span>  <span class="c1">//大部分情况下，如果没有权限问题，到这儿就结束了
</span><span class="ln">43</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">audited</span><span class="p">))</span>
<span class="ln">44</span>        <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="ln">45</span>  <span class="c1">//再往下就要开始收集信息，打印avc denied信息了
</span><span class="ln">46</span><span class="c1"></span>    <span class="n">rc2</span> <span class="o">=</span> <span class="n">audit_inode_permission</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">perms</span><span class="p">,</span> <span class="n">audited</span><span class="p">,</span> <span class="n">denied</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="ln">47</span>    <span class="k">if</span> <span class="p">(</span><span class="n">rc2</span><span class="p">)</span>
<span class="ln">48</span>        <span class="k">return</span> <span class="n">rc2</span><span class="p">;</span>
<span class="ln">49</span>    <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="ln">50</span><span class="p">}</span>
</code></pre></div><p>这里面file_mask_to_av计算出来的perms就是我们现在操作dir所需要的权限</p>
<p>DIR__WRITE 、 DIR__SEARCH的定义是av_permissions.h头文件里面</p>
<p>不过不是这个 /android/external/selinux/libselinux/include/selinux/av_permissions.h</p>
<p>而是编译生成，路径在：/android/out/target/product/xxxxx/obj/KERNEL_OBJ/security/selinux/av_permissions.h</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln">1</span><span class="cp">#define DIR__WRITE                                0x00000004UL
</span><span class="ln">2</span><span class="cp">#define DIR__SEARCH                               0x00400000UL
</span></code></pre></div><p>也就是perms = 0x00400004</p>
<p>实际上，这里面这个权限也是每一位代表了一个权限，和上面的不同的是，这个是根据classmap.h里面定义的值来计算的</p>
<p><strong>kernelcode/security/selinux/include/classmap.h</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln">  1</span><span class="cp">#define COMMON_FILE_SOCK_PERMS &#34;ioctl&#34;, &#34;read&#34;, &#34;write&#34;, &#34;create&#34;, \
</span><span class="ln">  2</span><span class="cp">    &#34;getattr&#34;, &#34;setattr&#34;, &#34;lock&#34;, &#34;relabelfrom&#34;, &#34;relabelto&#34;, &#34;append&#34;
</span><span class="ln">  3</span><span class="cp"></span> 
<span class="ln">  4</span><span class="cp">#define COMMON_FILE_PERMS COMMON_FILE_SOCK_PERMS, &#34;unlink&#34;, &#34;link&#34;, \
</span><span class="ln">  5</span><span class="cp">    &#34;rename&#34;, &#34;execute&#34;, &#34;quotaon&#34;, &#34;mounton&#34;, &#34;audit_access&#34;, \
</span><span class="ln">  6</span><span class="cp">    &#34;open&#34;, &#34;execmod&#34;
</span><span class="ln">  7</span><span class="cp"></span> 
<span class="ln">  8</span><span class="cp">#define COMMON_SOCK_PERMS COMMON_FILE_SOCK_PERMS, &#34;bind&#34;, &#34;connect&#34;, \
</span><span class="ln">  9</span><span class="cp">    &#34;listen&#34;, &#34;accept&#34;, &#34;getopt&#34;, &#34;setopt&#34;, &#34;shutdown&#34;, &#34;recvfrom&#34;,  \
</span><span class="ln"> 10</span><span class="cp">    &#34;sendto&#34;, &#34;name_bind&#34;
</span><span class="ln"> 11</span><span class="cp"></span> 
<span class="ln"> 12</span><span class="cp">#define COMMON_IPC_PERMS &#34;create&#34;, &#34;destroy&#34;, &#34;getattr&#34;, &#34;setattr&#34;, &#34;read&#34;, \
</span><span class="ln"> 13</span><span class="cp">        &#34;write&#34;, &#34;associate&#34;, &#34;unix_read&#34;, &#34;unix_write&#34;
</span><span class="ln"> 14</span><span class="cp"></span> 
<span class="ln"> 15</span><span class="cp">#define COMMON_CAP_PERMS  &#34;chown&#34;, &#34;dac_override&#34;, &#34;dac_read_search&#34;, \
</span><span class="ln"> 16</span><span class="cp">        &#34;fowner&#34;, &#34;fsetid&#34;, &#34;kill&#34;, &#34;setgid&#34;, &#34;setuid&#34;, &#34;setpcap&#34;, \
</span><span class="ln"> 17</span><span class="cp">        &#34;linux_immutable&#34;, &#34;net_bind_service&#34;, &#34;net_broadcast&#34;, \
</span><span class="ln"> 18</span><span class="cp">        &#34;net_admin&#34;, &#34;net_raw&#34;, &#34;ipc_lock&#34;, &#34;ipc_owner&#34;, &#34;sys_module&#34;, \
</span><span class="ln"> 19</span><span class="cp">        &#34;sys_rawio&#34;, &#34;sys_chroot&#34;, &#34;sys_ptrace&#34;, &#34;sys_pacct&#34;, &#34;sys_admin&#34;, \
</span><span class="ln"> 20</span><span class="cp">        &#34;sys_boot&#34;, &#34;sys_nice&#34;, &#34;sys_resource&#34;, &#34;sys_time&#34;, \
</span><span class="ln"> 21</span><span class="cp">        &#34;sys_tty_config&#34;, &#34;mknod&#34;, &#34;lease&#34;, &#34;audit_write&#34;, \
</span><span class="ln"> 22</span><span class="cp">        &#34;audit_control&#34;, &#34;setfcap&#34;
</span><span class="ln"> 23</span><span class="cp"></span> 
<span class="ln"> 24</span><span class="cp">#define COMMON_CAP2_PERMS  &#34;mac_override&#34;, &#34;mac_admin&#34;, &#34;syslog&#34;, \
</span><span class="ln"> 25</span><span class="cp">        &#34;wake_alarm&#34;, &#34;block_suspend&#34;, &#34;audit_read&#34;
</span><span class="ln"> 26</span><span class="cp"></span> 
<span class="ln"> 27</span><span class="cm">/*
</span><span class="ln"> 28</span><span class="cm"> * Note: The name for any socket class should be suffixed by &#34;socket&#34;,
</span><span class="ln"> 29</span><span class="cm"> *   and doesn&#39;t contain more than one substr of &#34;socket&#34;.
</span><span class="ln"> 30</span><span class="cm"> */</span>
<span class="ln"> 31</span><span class="k">struct</span> <span class="nc">security_class_mapping</span> <span class="n">secclass_map</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="ln"> 32</span>    <span class="p">{</span> <span class="s">&#34;security&#34;</span><span class="p">,</span>
<span class="ln"> 33</span>      <span class="p">{</span> <span class="s">&#34;compute_av&#34;</span><span class="p">,</span> <span class="s">&#34;compute_create&#34;</span><span class="p">,</span> <span class="s">&#34;compute_member&#34;</span><span class="p">,</span>
<span class="ln"> 34</span>        <span class="s">&#34;check_context&#34;</span><span class="p">,</span> <span class="s">&#34;load_policy&#34;</span><span class="p">,</span> <span class="s">&#34;compute_relabel&#34;</span><span class="p">,</span>
<span class="ln"> 35</span>        <span class="s">&#34;compute_user&#34;</span><span class="p">,</span> <span class="s">&#34;setenforce&#34;</span><span class="p">,</span> <span class="s">&#34;setbool&#34;</span><span class="p">,</span> <span class="s">&#34;setsecparam&#34;</span><span class="p">,</span>
<span class="ln"> 36</span>        <span class="s">&#34;setcheckreqprot&#34;</span><span class="p">,</span> <span class="s">&#34;read_policy&#34;</span><span class="p">,</span> <span class="s">&#34;validate_trans&#34;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln"> 37</span>    <span class="p">{</span> <span class="s">&#34;process&#34;</span><span class="p">,</span>
<span class="ln"> 38</span>      <span class="p">{</span> <span class="s">&#34;fork&#34;</span><span class="p">,</span> <span class="s">&#34;transition&#34;</span><span class="p">,</span> <span class="s">&#34;sigchld&#34;</span><span class="p">,</span> <span class="s">&#34;sigkill&#34;</span><span class="p">,</span>
<span class="ln"> 39</span>        <span class="s">&#34;sigstop&#34;</span><span class="p">,</span> <span class="s">&#34;signull&#34;</span><span class="p">,</span> <span class="s">&#34;signal&#34;</span><span class="p">,</span> <span class="s">&#34;ptrace&#34;</span><span class="p">,</span> <span class="s">&#34;getsched&#34;</span><span class="p">,</span> <span class="s">&#34;setsched&#34;</span><span class="p">,</span>
<span class="ln"> 40</span>        <span class="s">&#34;getsession&#34;</span><span class="p">,</span> <span class="s">&#34;getpgid&#34;</span><span class="p">,</span> <span class="s">&#34;setpgid&#34;</span><span class="p">,</span> <span class="s">&#34;getcap&#34;</span><span class="p">,</span> <span class="s">&#34;setcap&#34;</span><span class="p">,</span> <span class="s">&#34;share&#34;</span><span class="p">,</span>
<span class="ln"> 41</span>        <span class="s">&#34;getattr&#34;</span><span class="p">,</span> <span class="s">&#34;setexec&#34;</span><span class="p">,</span> <span class="s">&#34;setfscreate&#34;</span><span class="p">,</span> <span class="s">&#34;noatsecure&#34;</span><span class="p">,</span> <span class="s">&#34;siginh&#34;</span><span class="p">,</span>
<span class="ln"> 42</span>        <span class="s">&#34;setrlimit&#34;</span><span class="p">,</span> <span class="s">&#34;rlimitinh&#34;</span><span class="p">,</span> <span class="s">&#34;dyntransition&#34;</span><span class="p">,</span> <span class="s">&#34;setcurrent&#34;</span><span class="p">,</span>
<span class="ln"> 43</span>        <span class="s">&#34;execmem&#34;</span><span class="p">,</span> <span class="s">&#34;execstack&#34;</span><span class="p">,</span> <span class="s">&#34;execheap&#34;</span><span class="p">,</span> <span class="s">&#34;setkeycreate&#34;</span><span class="p">,</span>
<span class="ln"> 44</span>        <span class="s">&#34;setsockcreate&#34;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln"> 45</span>    <span class="p">{</span> <span class="s">&#34;system&#34;</span><span class="p">,</span>
<span class="ln"> 46</span>      <span class="p">{</span> <span class="s">&#34;ipc_info&#34;</span><span class="p">,</span> <span class="s">&#34;syslog_read&#34;</span><span class="p">,</span> <span class="s">&#34;syslog_mod&#34;</span><span class="p">,</span>
<span class="ln"> 47</span>        <span class="s">&#34;syslog_picasso&#34;</span><span class="p">,</span> <span class="s">&#34;module_request&#34;</span><span class="p">,</span> <span class="s">&#34;module_load&#34;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln"> 48</span>    <span class="p">{</span> <span class="s">&#34;capability&#34;</span><span class="p">,</span>
<span class="ln"> 49</span>      <span class="p">{</span> <span class="n">COMMON_CAP_PERMS</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln"> 50</span>    <span class="p">{</span> <span class="s">&#34;filesystem&#34;</span><span class="p">,</span>
<span class="ln"> 51</span>      <span class="p">{</span> <span class="s">&#34;mount&#34;</span><span class="p">,</span> <span class="s">&#34;remount&#34;</span><span class="p">,</span> <span class="s">&#34;unmount&#34;</span><span class="p">,</span> <span class="s">&#34;getattr&#34;</span><span class="p">,</span>
<span class="ln"> 52</span>        <span class="s">&#34;relabelfrom&#34;</span><span class="p">,</span> <span class="s">&#34;relabelto&#34;</span><span class="p">,</span> <span class="s">&#34;associate&#34;</span><span class="p">,</span> <span class="s">&#34;quotamod&#34;</span><span class="p">,</span>
<span class="ln"> 53</span>        <span class="s">&#34;quotaget&#34;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln"> 54</span>    <span class="p">{</span> <span class="s">&#34;file&#34;</span><span class="p">,</span>
<span class="ln"> 55</span>      <span class="p">{</span> <span class="n">COMMON_FILE_PERMS</span><span class="p">,</span>
<span class="ln"> 56</span>        <span class="s">&#34;execute_no_trans&#34;</span><span class="p">,</span> <span class="s">&#34;entrypoint&#34;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln"> 57</span>    <span class="p">{</span> <span class="s">&#34;dir&#34;</span><span class="p">,</span>
<span class="ln"> 58</span>      <span class="p">{</span> <span class="n">COMMON_FILE_PERMS</span><span class="p">,</span> <span class="s">&#34;add_name&#34;</span><span class="p">,</span> <span class="s">&#34;remove_name&#34;</span><span class="p">,</span>
<span class="ln"> 59</span>        <span class="s">&#34;reparent&#34;</span><span class="p">,</span> <span class="s">&#34;search&#34;</span><span class="p">,</span> <span class="s">&#34;rmdir&#34;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln"> 60</span>    <span class="p">{</span> <span class="s">&#34;fd&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="s">&#34;use&#34;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln"> 61</span>    <span class="p">{</span> <span class="s">&#34;lnk_file&#34;</span><span class="p">,</span>
<span class="ln"> 62</span>      <span class="p">{</span> <span class="n">COMMON_FILE_PERMS</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln"> 63</span>    <span class="p">{</span> <span class="s">&#34;chr_file&#34;</span><span class="p">,</span>
<span class="ln"> 64</span>      <span class="p">{</span> <span class="n">COMMON_FILE_PERMS</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln"> 65</span>    <span class="p">{</span> <span class="s">&#34;blk_file&#34;</span><span class="p">,</span>
<span class="ln"> 66</span>      <span class="p">{</span> <span class="n">COMMON_FILE_PERMS</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln"> 67</span>    <span class="p">{</span> <span class="s">&#34;sock_file&#34;</span><span class="p">,</span>
<span class="ln"> 68</span>      <span class="p">{</span> <span class="n">COMMON_FILE_PERMS</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln"> 69</span>    <span class="p">{</span> <span class="s">&#34;fifo_file&#34;</span><span class="p">,</span>
<span class="ln"> 70</span>      <span class="p">{</span> <span class="n">COMMON_FILE_PERMS</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln"> 71</span>    <span class="p">{</span> <span class="s">&#34;socket&#34;</span><span class="p">,</span>
<span class="ln"> 72</span>      <span class="p">{</span> <span class="n">COMMON_SOCK_PERMS</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln"> 73</span>    <span class="p">{</span> <span class="s">&#34;tcp_socket&#34;</span><span class="p">,</span>
<span class="ln"> 74</span>      <span class="p">{</span> <span class="n">COMMON_SOCK_PERMS</span><span class="p">,</span>
<span class="ln"> 75</span>        <span class="s">&#34;node_bind&#34;</span><span class="p">,</span> <span class="s">&#34;name_connect&#34;</span><span class="p">,</span>
<span class="ln"> 76</span>        <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln"> 77</span>    <span class="p">{</span> <span class="s">&#34;udp_socket&#34;</span><span class="p">,</span>
<span class="ln"> 78</span>      <span class="p">{</span> <span class="n">COMMON_SOCK_PERMS</span><span class="p">,</span>
<span class="ln"> 79</span>        <span class="s">&#34;node_bind&#34;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln"> 80</span>    <span class="p">{</span> <span class="s">&#34;rawip_socket&#34;</span><span class="p">,</span>
<span class="ln"> 81</span>      <span class="p">{</span> <span class="n">COMMON_SOCK_PERMS</span><span class="p">,</span>
<span class="ln"> 82</span>        <span class="s">&#34;node_bind&#34;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln"> 83</span>    <span class="p">{</span> <span class="s">&#34;node&#34;</span><span class="p">,</span>
<span class="ln"> 84</span>      <span class="p">{</span> <span class="s">&#34;recvfrom&#34;</span><span class="p">,</span> <span class="s">&#34;sendto&#34;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln"> 85</span>    <span class="p">{</span> <span class="s">&#34;netif&#34;</span><span class="p">,</span>
<span class="ln"> 86</span>      <span class="p">{</span> <span class="s">&#34;ingress&#34;</span><span class="p">,</span> <span class="s">&#34;egress&#34;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln"> 87</span>    <span class="p">{</span> <span class="s">&#34;netlink_socket&#34;</span><span class="p">,</span>
<span class="ln"> 88</span>      <span class="p">{</span> <span class="n">COMMON_SOCK_PERMS</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln"> 89</span>    <span class="p">{</span> <span class="s">&#34;packet_socket&#34;</span><span class="p">,</span>
<span class="ln"> 90</span>      <span class="p">{</span> <span class="n">COMMON_SOCK_PERMS</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln"> 91</span>    <span class="p">{</span> <span class="s">&#34;key_socket&#34;</span><span class="p">,</span>
<span class="ln"> 92</span>      <span class="p">{</span> <span class="n">COMMON_SOCK_PERMS</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln"> 93</span>    <span class="p">{</span> <span class="s">&#34;unix_stream_socket&#34;</span><span class="p">,</span>
<span class="ln"> 94</span>      <span class="p">{</span> <span class="n">COMMON_SOCK_PERMS</span><span class="p">,</span> <span class="s">&#34;connectto&#34;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln"> 95</span>    <span class="p">{</span> <span class="s">&#34;unix_dgram_socket&#34;</span><span class="p">,</span>
<span class="ln"> 96</span>      <span class="p">{</span> <span class="n">COMMON_SOCK_PERMS</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln"> 97</span>    <span class="p">{</span> <span class="s">&#34;sem&#34;</span><span class="p">,</span>
<span class="ln"> 98</span>      <span class="p">{</span> <span class="n">COMMON_IPC_PERMS</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln"> 99</span>    <span class="p">{</span> <span class="s">&#34;msg&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="s">&#34;send&#34;</span><span class="p">,</span> <span class="s">&#34;receive&#34;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln">100</span>    <span class="p">{</span> <span class="s">&#34;msgq&#34;</span><span class="p">,</span>
<span class="ln">101</span>      <span class="p">{</span> <span class="n">COMMON_IPC_PERMS</span><span class="p">,</span> <span class="s">&#34;enqueue&#34;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln">102</span>    <span class="p">{</span> <span class="s">&#34;shm&#34;</span><span class="p">,</span>
<span class="ln">103</span>      <span class="p">{</span> <span class="n">COMMON_IPC_PERMS</span><span class="p">,</span> <span class="s">&#34;lock&#34;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln">104</span>    <span class="p">{</span> <span class="s">&#34;ipc&#34;</span><span class="p">,</span>
<span class="ln">105</span>      <span class="p">{</span> <span class="n">COMMON_IPC_PERMS</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln">106</span>    <span class="p">{</span> <span class="s">&#34;netlink_route_socket&#34;</span><span class="p">,</span>
<span class="ln">107</span>      <span class="p">{</span> <span class="n">COMMON_SOCK_PERMS</span><span class="p">,</span>
<span class="ln">108</span>        <span class="s">&#34;nlmsg_read&#34;</span><span class="p">,</span> <span class="s">&#34;nlmsg_write&#34;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln">109</span>    <span class="p">{</span> <span class="s">&#34;netlink_tcpdiag_socket&#34;</span><span class="p">,</span>
<span class="ln">110</span>      <span class="p">{</span> <span class="n">COMMON_SOCK_PERMS</span><span class="p">,</span>
<span class="ln">111</span>        <span class="s">&#34;nlmsg_read&#34;</span><span class="p">,</span> <span class="s">&#34;nlmsg_write&#34;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln">112</span>    <span class="p">{</span> <span class="s">&#34;netlink_nflog_socket&#34;</span><span class="p">,</span>
<span class="ln">113</span>      <span class="p">{</span> <span class="n">COMMON_SOCK_PERMS</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln">114</span>    <span class="p">{</span> <span class="s">&#34;netlink_xfrm_socket&#34;</span><span class="p">,</span>
<span class="ln">115</span>      <span class="p">{</span> <span class="n">COMMON_SOCK_PERMS</span><span class="p">,</span>
<span class="ln">116</span>        <span class="s">&#34;nlmsg_read&#34;</span><span class="p">,</span> <span class="s">&#34;nlmsg_write&#34;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln">117</span>    <span class="p">{</span> <span class="s">&#34;netlink_selinux_socket&#34;</span><span class="p">,</span>
<span class="ln">118</span>      <span class="p">{</span> <span class="n">COMMON_SOCK_PERMS</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln">119</span>    <span class="p">{</span> <span class="s">&#34;netlink_iscsi_socket&#34;</span><span class="p">,</span>
<span class="ln">120</span>      <span class="p">{</span> <span class="n">COMMON_SOCK_PERMS</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln">121</span>    <span class="p">{</span> <span class="s">&#34;netlink_audit_socket&#34;</span><span class="p">,</span>
<span class="ln">122</span>      <span class="p">{</span> <span class="n">COMMON_SOCK_PERMS</span><span class="p">,</span>
<span class="ln">123</span>        <span class="s">&#34;nlmsg_read&#34;</span><span class="p">,</span> <span class="s">&#34;nlmsg_write&#34;</span><span class="p">,</span> <span class="s">&#34;nlmsg_relay&#34;</span><span class="p">,</span> <span class="s">&#34;nlmsg_readpriv&#34;</span><span class="p">,</span>
<span class="ln">124</span>        <span class="s">&#34;nlmsg_tty_audit&#34;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln">125</span>    <span class="p">{</span> <span class="s">&#34;netlink_fib_lookup_socket&#34;</span><span class="p">,</span>
<span class="ln">126</span>      <span class="p">{</span> <span class="n">COMMON_SOCK_PERMS</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln">127</span>    <span class="p">{</span> <span class="s">&#34;netlink_connector_socket&#34;</span><span class="p">,</span>
<span class="ln">128</span>      <span class="p">{</span> <span class="n">COMMON_SOCK_PERMS</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln">129</span>    <span class="p">{</span> <span class="s">&#34;netlink_netfilter_socket&#34;</span><span class="p">,</span>
<span class="ln">130</span>      <span class="p">{</span> <span class="n">COMMON_SOCK_PERMS</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln">131</span>    <span class="p">{</span> <span class="s">&#34;netlink_dnrt_socket&#34;</span><span class="p">,</span>
<span class="ln">132</span>      <span class="p">{</span> <span class="n">COMMON_SOCK_PERMS</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln">133</span>    <span class="p">{</span> <span class="s">&#34;association&#34;</span><span class="p">,</span>
<span class="ln">134</span>      <span class="p">{</span> <span class="s">&#34;sendto&#34;</span><span class="p">,</span> <span class="s">&#34;recvfrom&#34;</span><span class="p">,</span> <span class="s">&#34;setcontext&#34;</span><span class="p">,</span> <span class="s">&#34;polmatch&#34;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln">135</span>    <span class="p">{</span> <span class="s">&#34;netlink_kobject_uevent_socket&#34;</span><span class="p">,</span>
<span class="ln">136</span>      <span class="p">{</span> <span class="n">COMMON_SOCK_PERMS</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln">137</span>    <span class="p">{</span> <span class="s">&#34;netlink_generic_socket&#34;</span><span class="p">,</span>
<span class="ln">138</span>      <span class="p">{</span> <span class="n">COMMON_SOCK_PERMS</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln">139</span>    <span class="p">{</span> <span class="s">&#34;netlink_scsitransport_socket&#34;</span><span class="p">,</span>
<span class="ln">140</span>      <span class="p">{</span> <span class="n">COMMON_SOCK_PERMS</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln">141</span>    <span class="p">{</span> <span class="s">&#34;netlink_rdma_socket&#34;</span><span class="p">,</span>
<span class="ln">142</span>      <span class="p">{</span> <span class="n">COMMON_SOCK_PERMS</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln">143</span>    <span class="p">{</span> <span class="s">&#34;netlink_crypto_socket&#34;</span><span class="p">,</span>
<span class="ln">144</span>      <span class="p">{</span> <span class="n">COMMON_SOCK_PERMS</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln">145</span>    <span class="p">{</span> <span class="s">&#34;appletalk_socket&#34;</span><span class="p">,</span>
<span class="ln">146</span>      <span class="p">{</span> <span class="n">COMMON_SOCK_PERMS</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln">147</span>    <span class="p">{</span> <span class="s">&#34;packet&#34;</span><span class="p">,</span>
<span class="ln">148</span>      <span class="p">{</span> <span class="s">&#34;send&#34;</span><span class="p">,</span> <span class="s">&#34;recv&#34;</span><span class="p">,</span> <span class="s">&#34;relabelto&#34;</span><span class="p">,</span> <span class="s">&#34;forward_in&#34;</span><span class="p">,</span> <span class="s">&#34;forward_out&#34;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln">149</span>    <span class="p">{</span> <span class="s">&#34;key&#34;</span><span class="p">,</span>
<span class="ln">150</span>      <span class="p">{</span> <span class="s">&#34;view&#34;</span><span class="p">,</span> <span class="s">&#34;read&#34;</span><span class="p">,</span> <span class="s">&#34;write&#34;</span><span class="p">,</span> <span class="s">&#34;search&#34;</span><span class="p">,</span> <span class="s">&#34;link&#34;</span><span class="p">,</span> <span class="s">&#34;setattr&#34;</span><span class="p">,</span> <span class="s">&#34;create&#34;</span><span class="p">,</span>
<span class="ln">151</span>        <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln">152</span>    <span class="p">{</span> <span class="s">&#34;dccp_socket&#34;</span><span class="p">,</span>
<span class="ln">153</span>      <span class="p">{</span> <span class="n">COMMON_SOCK_PERMS</span><span class="p">,</span>
<span class="ln">154</span>        <span class="s">&#34;node_bind&#34;</span><span class="p">,</span> <span class="s">&#34;name_connect&#34;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln">155</span>    <span class="p">{</span> <span class="s">&#34;memprotect&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="s">&#34;mmap_zero&#34;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln">156</span>    <span class="p">{</span> <span class="s">&#34;peer&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="s">&#34;recv&#34;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln">157</span>    <span class="p">{</span> <span class="s">&#34;capability2&#34;</span><span class="p">,</span>
<span class="ln">158</span>      <span class="p">{</span> <span class="n">COMMON_CAP2_PERMS</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln">159</span>    <span class="p">{</span> <span class="s">&#34;kernel_service&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="s">&#34;use_as_override&#34;</span><span class="p">,</span> <span class="s">&#34;create_files_as&#34;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln">160</span>    <span class="p">{</span> <span class="s">&#34;tun_socket&#34;</span><span class="p">,</span>
<span class="ln">161</span>      <span class="p">{</span> <span class="n">COMMON_SOCK_PERMS</span><span class="p">,</span> <span class="s">&#34;attach_queue&#34;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln">162</span>    <span class="p">{</span> <span class="s">&#34;binder&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="s">&#34;impersonate&#34;</span><span class="p">,</span> <span class="s">&#34;call&#34;</span><span class="p">,</span> <span class="s">&#34;set_context_mgr&#34;</span><span class="p">,</span> <span class="s">&#34;transfer&#34;</span><span class="p">,</span>
<span class="ln">163</span>              <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln">164</span>    <span class="p">{</span> <span class="s">&#34;cap_userns&#34;</span><span class="p">,</span>
<span class="ln">165</span>      <span class="p">{</span> <span class="n">COMMON_CAP_PERMS</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln">166</span>    <span class="p">{</span> <span class="s">&#34;cap2_userns&#34;</span><span class="p">,</span>
<span class="ln">167</span>      <span class="p">{</span> <span class="n">COMMON_CAP2_PERMS</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="p">},</span>
<span class="ln">168</span>    <span class="p">{</span> <span class="s">&#34;bpf&#34;</span><span class="p">,</span>
<span class="ln">169</span>      <span class="p">{</span><span class="s">&#34;map_create&#34;</span><span class="p">,</span> <span class="s">&#34;map_read&#34;</span><span class="p">,</span> <span class="s">&#34;map_write&#34;</span><span class="p">,</span> <span class="s">&#34;prog_load&#34;</span><span class="p">,</span> <span class="s">&#34;prog_run&#34;</span><span class="p">}</span> <span class="p">},</span>
<span class="ln">170</span>    <span class="p">{</span> <span class="nb">NULL</span> <span class="p">}</span>
<span class="ln">171</span>  <span class="p">};</span>
</code></pre></div><p>把dir所对应的展开一下：</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln">1</span><span class="p">{</span> <span class="s">&#34;dir&#34;</span><span class="p">,</span>
<span class="ln">2</span>  <span class="p">{</span> <span class="s">&#34;ioctl&#34;</span><span class="p">,</span> <span class="s">&#34;read&#34;</span><span class="p">,</span> <span class="s">&#34;write&#34;</span><span class="p">,</span> <span class="s">&#34;create&#34;</span><span class="p">,</span> <span class="s">&#34;getattr&#34;</span><span class="p">,</span> <span class="s">&#34;setattr&#34;</span><span class="p">,</span>
<span class="ln">3</span>        <span class="s">&#34;lock&#34;</span><span class="p">,</span> <span class="s">&#34;relabelfrom&#34;</span><span class="p">,</span> <span class="s">&#34;relabelto&#34;</span><span class="p">,</span> <span class="s">&#34;append&#34;</span><span class="p">,</span> <span class="s">&#34;unlink&#34;</span><span class="p">,</span> <span class="s">&#34;link&#34;</span><span class="p">,</span>
<span class="ln">4</span>    <span class="s">&#34;rename&#34;</span><span class="p">,</span> <span class="s">&#34;execute&#34;</span><span class="p">,</span> <span class="s">&#34;quotaon&#34;</span><span class="p">,</span> <span class="s">&#34;mounton&#34;</span><span class="p">,</span> <span class="s">&#34;audit_access&#34;</span><span class="p">,</span>
<span class="ln">5</span>    <span class="s">&#34;open&#34;</span><span class="p">,</span> <span class="s">&#34;execmod&#34;</span><span class="p">,</span><span class="s">&#34;add_name&#34;</span><span class="p">,</span> <span class="s">&#34;remove_name&#34;</span><span class="p">,</span>
<span class="ln">6</span>    <span class="s">&#34;reparent&#34;</span><span class="p">,</span> <span class="s">&#34;search&#34;</span><span class="p">,</span> <span class="s">&#34;rmdir&#34;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span>
<span class="ln">7</span><span class="p">},</span>
</code></pre></div><p>其实这里对应的就是权限：“write&quot;和&quot;search”</p>
<p>也就是说，这一次权限检查，要检查的权限是对type为vendor_data_file的目录(dir)的&quot;write&quot;和&quot;search&quot;权限</p>
<p>其他的其实也是一样的道理，kernel里面的代码规定了进程在访问某些对象的时候所需要的权限</p>
<p>再比如：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln"> 1</span>mkdir /data/testdir
<span class="ln"> 2</span> 
<span class="ln"> 3</span><span class="o">[</span> 2336.839823@1<span class="o">]</span> <span class="nv">type</span><span class="o">=</span><span class="m">1400</span> audit<span class="o">(</span>1230741525.976:909<span class="o">)</span>: avc: denied <span class="o">{</span> getattr <span class="o">}</span> <span class="k">for</span> <span class="nv">pid</span><span class="o">=</span><span class="m">18561</span> <span class="nv">comm</span><span class="o">=</span><span class="s2">&#34;mkdir&#34;</span>
<span class="ln"> 4</span><span class="nv">path</span><span class="o">=</span><span class="s2">&#34;/data/testdir&#34;</span> <span class="nv">dev</span><span class="o">=</span><span class="s2">&#34;mmcblk0p21&#34;</span> <span class="nv">ino</span><span class="o">=</span><span class="m">1149</span> <span class="nv">scontext</span><span class="o">=</span>u:r:testA:s0 <span class="nv">tcontext</span><span class="o">=</span>u:object_r:system_data_file:s0 <span class="nv">tclass</span><span class="o">=</span>dir <span class="nv">permissive</span><span class="o">=</span><span class="m">0</span>
<span class="ln"> 5</span> 
<span class="ln"> 6</span><span class="o">[</span> 2336.754088@3<span class="o">]</span> <span class="o">[</span>bc6e5b7c+  16<span class="o">][</span>&lt;c020e3c0&gt;<span class="o">]</span> show_stack+0x20/0x24
<span class="ln"> 7</span><span class="o">[</span> 2336.759889@3<span class="o">]</span> <span class="o">[</span>bc6e5b9c+  32<span class="o">][</span>&lt;c05daf0c&gt;<span class="o">]</span> dump_stack+0x90/0xac
<span class="ln"> 8</span><span class="o">[</span> 2336.765696@3<span class="o">]</span> <span class="o">[</span>bc6e5bf4+  88<span class="o">][</span>&lt;c055e978&gt;<span class="o">]</span> slow_avc_audit+0x108/0x128
<span class="ln"> 9</span><span class="o">[</span> 2336.772019@3<span class="o">]</span> <span class="o">[</span>bc6e5c74+ 128<span class="o">][</span>&lt;c055f040&gt;<span class="o">]</span> avc_has_perm+0x13c/0x170
<span class="ln">10</span><span class="o">[</span> 2336.778172@3<span class="o">]</span> <span class="o">[</span>bc6e5c8c+  24<span class="o">][</span>&lt;c0560334&gt;<span class="o">]</span> inode_has_perm+0x48/0x5c
<span class="ln">11</span><span class="o">[</span> 2336.784326@3<span class="o">]</span> <span class="o">[</span>bc6e5cb4+  40<span class="o">][</span>&lt;c0562b00&gt;<span class="o">]</span> selinux_inode_getattr+0x6c/0x74
<span class="ln">12</span><span class="o">[</span> 2336.791085@3<span class="o">]</span> <span class="o">[</span>bc6e5cd4+  32<span class="o">][</span>&lt;c055ab40&gt;<span class="o">]</span> security_inode_getattr+0x4c/0x68
<span class="ln">13</span><span class="o">[</span> 2336.797934@3<span class="o">]</span> <span class="o">[</span>bc6e5cec+  24<span class="o">][</span>&lt;c03a1ff4&gt;<span class="o">]</span> vfs_getattr+0x20/0x38
<span class="ln">14</span><span class="o">[</span> 2336.803826@3<span class="o">]</span> <span class="o">[</span>bc6e5d24+  56<span class="o">][</span>&lt;c03a20d4&gt;<span class="o">]</span> vfs_fstatat+0x70/0xb0
<span class="ln">15</span><span class="o">[</span> 2336.809718@3<span class="o">]</span> <span class="o">[</span>bc6e5d8c+ 104<span class="o">][</span>&lt;c03a2804&gt;<span class="o">]</span> SyS_fstatat64+0x24/0x40
<span class="ln">16</span><span class="o">[</span> 2336.815787@3<span class="o">]</span> <span class="o">[</span>00000000+   0<span class="o">][</span>&lt;c0208680&gt;<span class="o">]</span> ret_fast_syscall+0x0/0x48
<span class="ln">17</span> 
<span class="ln">18</span>inode_has_perm
<span class="ln">19</span>kernelcode/security/selinux/hooks.c:1705
<span class="ln">20</span> 
<span class="ln">21</span>selinux_inode_getattr
<span class="ln">22</span>kernelcode/security/selinux/hooks.c:3089
<span class="ln">23</span> 
<span class="ln">24</span>security_inode_getattr
<span class="ln">25</span>kernelcode/security/security.c:631 <span class="o">(</span>discriminator 5<span class="o">)</span>
<span class="ln">26</span> 
<span class="ln">27</span>vfs_getattr
<span class="ln">28</span>kernelcode/fs/stat.c:70
<span class="ln">29</span> 
<span class="ln">30</span>vfs_fstatat
<span class="ln">31</span>kernelcode/fs/stat.c:110
<span class="ln">32</span> 
<span class="ln">33</span>SYSC_fstatat64
<span class="ln">34</span>kernelcode/fs/stat.c:440
</code></pre></div><p>首先检查的需要的权限是：getattr</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln">1</span><span class="k">static</span> <span class="kt">int</span> <span class="nf">selinux_inode_getattr</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="nc">path</span> <span class="o">*</span><span class="n">path</span><span class="p">)</span>
<span class="ln">2</span><span class="p">{</span>
<span class="ln">3</span>    <span class="k">return</span> <span class="n">path_has_perm</span><span class="p">(</span><span class="n">current_cred</span><span class="p">(),</span> <span class="n">path</span><span class="p">,</span> <span class="n">FILE__GETATTR</span><span class="p">);</span>
<span class="ln">4</span><span class="p">}</span>
<span class="ln">5</span> 
<span class="ln">6</span><span class="cp">#define FILE__GETATTR                             0x00000010UL
</span></code></pre></div><h3 id="313裁决">3.1.3裁决</h3>
<p>前面的分析，我们知道了需要的权限是0x00400004，拥有的权限是0x00120010</p>
<p>那代码是怎么来判断权限是否都ok呢？</p>
<p>先看看权限是怎么从policydb里面读取，然后转换的</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="kr">inline</span> <span class="kt">int</span> <span class="nf">avc_has_perm_noaudit</span><span class="p">(</span><span class="n">u32</span> <span class="n">ssid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">tsid</span><span class="p">,</span>
<span class="ln"> 2</span>             <span class="n">u16</span> <span class="n">tclass</span><span class="p">,</span> <span class="n">u32</span> <span class="n">requested</span><span class="p">,</span>
<span class="ln"> 3</span>             <span class="kt">unsigned</span> <span class="n">flags</span><span class="p">,</span>
<span class="ln"> 4</span>             <span class="k">struct</span> <span class="nc">av_decision</span> <span class="o">*</span><span class="n">avd</span><span class="p">)</span>
<span class="ln"> 5</span><span class="p">{</span>
<span class="ln"> 6</span>    <span class="p">......</span>
<span class="ln"> 7</span>    <span class="n">node</span> <span class="o">=</span> <span class="n">avc_lookup</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">tsid</span><span class="p">,</span> <span class="n">tclass</span><span class="p">);</span>
<span class="ln"> 8</span>    <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">node</span><span class="p">))</span>
<span class="ln"> 9</span>        <span class="n">node</span> <span class="o">=</span> <span class="n">avc_compute_av</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">tsid</span><span class="p">,</span> <span class="n">tclass</span><span class="p">,</span> <span class="n">avd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xp_node</span><span class="p">);</span>
<span class="ln">10</span>    <span class="k">else</span>
<span class="ln">11</span>        <span class="n">memcpy</span><span class="p">(</span><span class="n">avd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">ae</span><span class="p">.</span><span class="n">avd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">avd</span><span class="p">));</span>
<span class="ln">12</span>    <span class="p">......</span>
<span class="ln">13</span><span class="p">}</span>
</code></pre></div><p>首先从avc cache里面找看看有没有缓存值，这个是为了提高运行效率的，系统里面成千上万条规则，如果每一次判断权限都要从文件里面读取然后计算结果，这将会是一个巨大的工作量</p>
<p>所以采用了内存里面缓存之前计算的结果，如果没有的话那就调用avc_compute_av函数计算一次</p>
<p>接着调用security_compute_av</p>
<p>kernelcode/security/selinux/ss/services.c</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="kt">void</span> <span class="nf">security_compute_av</span><span class="p">(</span><span class="n">u32</span> <span class="n">ssid</span><span class="p">,</span>
<span class="ln"> 2</span>             <span class="n">u32</span> <span class="n">tsid</span><span class="p">,</span>
<span class="ln"> 3</span>             <span class="n">u16</span> <span class="n">orig_tclass</span><span class="p">,</span>
<span class="ln"> 4</span>             <span class="k">struct</span> <span class="nc">av_decision</span> <span class="o">*</span><span class="n">avd</span><span class="p">,</span>
<span class="ln"> 5</span>             <span class="k">struct</span> <span class="nc">extended_perms</span> <span class="o">*</span><span class="n">xperms</span><span class="p">)</span>
<span class="ln"> 6</span><span class="p">{</span>
<span class="ln"> 7</span>    <span class="p">......</span>
<span class="ln"> 8</span>    <span class="n">context_struct_compute_av</span><span class="p">(</span><span class="n">scontext</span><span class="p">,</span> <span class="n">tcontext</span><span class="p">,</span> <span class="n">tclass</span><span class="p">,</span> <span class="n">avd</span><span class="p">,</span> <span class="n">xperms</span><span class="p">);</span>
<span class="ln"> 9</span>    <span class="n">map_decision</span><span class="p">(</span><span class="n">orig_tclass</span><span class="p">,</span> <span class="n">avd</span><span class="p">,</span> <span class="n">policydb</span><span class="p">.</span><span class="n">allow_unknown</span><span class="p">);</span>
<span class="ln">10</span>  <span class="p">......</span>
<span class="ln">11</span><span class="p">}</span>
</code></pre></div><p>函数比较长，这里只看最重要的两句</p>
<p>context_struct_compute_av是从policydb里面读取出来的权限值，在这里就是0x00120010</p>
<p>map_decision会将权限值做一个映射关系，如果认真对比classmap.h和access_vectors里面dir权限的顺序，会发现其实不是完全一样的</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="k">static</span> <span class="kt">void</span> <span class="nf">map_decision</span><span class="p">(</span><span class="n">u16</span> <span class="n">tclass</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">av_decision</span> <span class="o">*</span><span class="n">avd</span><span class="p">,</span>
<span class="ln"> 2</span>             <span class="kt">int</span> <span class="n">allow_unknown</span><span class="p">)</span>
<span class="ln"> 3</span><span class="p">{</span>
<span class="ln"> 4</span>    <span class="k">if</span> <span class="p">(</span><span class="n">tclass</span> <span class="o">&lt;</span> <span class="n">current_mapping_size</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 5</span>        <span class="kt">unsigned</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">current_mapping</span><span class="p">[</span><span class="n">tclass</span><span class="p">].</span><span class="n">num_perms</span><span class="p">;</span>
<span class="ln"> 6</span>        <span class="n">u32</span> <span class="n">result</span><span class="p">;</span>
<span class="ln"> 7</span> 
<span class="ln"> 8</span>        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 9</span>            <span class="k">if</span> <span class="p">(</span><span class="n">avd</span><span class="o">-&gt;</span><span class="n">allowed</span> <span class="o">&amp;</span> <span class="n">current_mapping</span><span class="p">[</span><span class="n">tclass</span><span class="p">].</span><span class="n">perms</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="ln">10</span>                <span class="n">result</span> <span class="o">|=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">i</span><span class="p">;</span>
<span class="ln">11</span>            <span class="k">if</span> <span class="p">(</span><span class="n">allow_unknown</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">current_mapping</span><span class="p">[</span><span class="n">tclass</span><span class="p">].</span><span class="n">perms</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="ln">12</span>                <span class="n">result</span> <span class="o">|=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">i</span><span class="p">;</span>
<span class="ln">13</span>        <span class="p">}</span>
<span class="ln">14</span>        <span class="n">avd</span><span class="o">-&gt;</span><span class="n">allowed</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
<span class="ln">15</span> 
<span class="ln">16</span>        <span class="p">......</span>
<span class="ln">17</span>    <span class="p">}</span>
<span class="ln">18</span><span class="p">}</span>
<span class="ln">19</span> 
<span class="ln">20</span><span class="c1">//current_mapping 初始化的时候，是从classmap.h的secclass_map读取的
</span><span class="ln">21</span><span class="c1"></span><span class="n">rc</span> <span class="o">=</span> <span class="n">selinux_set_mapping</span><span class="p">(</span><span class="o">&amp;</span><span class="n">policydb</span><span class="p">,</span> <span class="n">secclass_map</span><span class="p">,</span>
<span class="ln">22</span>                     <span class="err">¤</span><span class="n">t_mapping</span><span class="p">,</span>
<span class="ln">23</span>                     <span class="err">¤</span><span class="n">t_mapping_size</span><span class="p">);</span>
</code></pre></div><p>这里会将0x00120010转成0x00480010</p>
<p>和上面一样的道理：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln">1</span>0x00480010
<span class="ln">2</span> 
<span class="ln">3</span>二进制表示：
<span class="ln">4</span><span class="m">0000</span> <span class="m">0000</span> <span class="m">0100</span> <span class="m">1000</span> <span class="m">0000</span> <span class="m">0000</span> <span class="m">0001</span> <span class="m">0000</span>
<span class="ln">5</span> 
<span class="ln">6</span>这里的每一个位代表着不同的权限，1是有权限，0是没有权限
</code></pre></div><p>那么0x00480010对应的权限：</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/SElinux/selinux_8.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/SElinux/selinux_8.png" >
  
    </a>
  
  
</div>

<p>和前面的权限是一致的，这里没有搞清楚为什么要有一个映射关系，感觉直接搞成一样的顺序不是更方便吗？</p>
<p>那接下来要比较的权限就是0x00480010（拥有的权限）和0x00400004（需要的权限）</p>
<p>找到0x00400004（需要的权限）为1 但是 0x00480010（拥有的权限）不为 1的那一位，就是缺少权限的</p>
<p>计算方法可以看看函数：</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">avc_audit_required</span><span class="p">(</span><span class="n">u32</span> <span class="n">requested</span><span class="p">,</span>
<span class="ln"> 2</span>                  <span class="k">struct</span> <span class="nc">av_decision</span> <span class="o">*</span><span class="n">avd</span><span class="p">,</span>
<span class="ln"> 3</span>                  <span class="kt">int</span> <span class="n">result</span><span class="p">,</span>
<span class="ln"> 4</span>                  <span class="n">u32</span> <span class="n">auditdeny</span><span class="p">,</span>
<span class="ln"> 5</span>                  <span class="n">u32</span> <span class="o">*</span><span class="n">deniedp</span><span class="p">)</span>
<span class="ln"> 6</span><span class="p">{</span>
<span class="ln"> 7</span>    <span class="n">u32</span> <span class="n">denied</span><span class="p">,</span> <span class="n">audited</span><span class="p">;</span>
<span class="ln"> 8</span>  <span class="c1">//最重要的就是这个计算
</span><span class="ln"> 9</span><span class="c1"></span>    <span class="n">denied</span> <span class="o">=</span> <span class="n">requested</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">avd</span><span class="o">-&gt;</span><span class="n">allowed</span><span class="p">;</span>
<span class="ln">10</span>    <span class="p">......</span>
<span class="ln">11</span><span class="p">}</span>
</code></pre></div><p>那么最后计算的结果就是</p>
<p>0x00400004 &amp; ~0x00480010 = 0x00000004</p>
<p>根据前面的描述，这个权限就是 “write”</p>
<p>所以会看到avc denied信息里面会提示你缺少write权限</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln">1</span><span class="o">[</span> 5424.996583@0<span class="o">]</span>- <span class="nv">type</span><span class="o">=</span><span class="m">1400</span> audit<span class="o">(</span>1577887433.668:59<span class="o">)</span>: avc: denied <span class="o">{</span> write <span class="o">}</span> <span class="k">for</span> <span class="nv">pid</span><span class="o">=</span><span class="m">4021</span> <span class="nv">comm</span><span class="o">=</span><span class="s2">&#34;testA.sh&#34;</span>
<span class="ln">2</span><span class="nv">name</span><span class="o">=</span><span class="s2">&#34;vendor&#34;</span> <span class="nv">dev</span><span class="o">=</span><span class="s2">&#34;mmcblk0p20&#34;</span> <span class="nv">ino</span><span class="o">=</span><span class="m">7395</span> <span class="nv">scontext</span><span class="o">=</span>u:r:testA:s0 <span class="nv">tcontext</span><span class="o">=</span>u:object_r:vendor_data_file:s0 <span class="nv">tclass</span><span class="o">=</span>dir <span class="nv">permissive</span><span class="o">=</span><span class="m">0</span>
</code></pre></div><p>上面提到的只是一个简单的例子，其他的权限也可以用类似的方式分析</p>
<p>我们用一张图来总结下：</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/SElinux/selinux_9.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/SElinux/selinux_9.png" >
  
    </a>
  
  
</div>

<h3 id="314其他">3.1.4其他</h3>
<p>下面聊聊servicemanager里面一些权限的检查，这个是Android才有的，具体流程可以点击<a href="http://gityuan.com/2015/11/07/binder-start-sm/">这里</a></p>
<p>我们在这直接看到svcmgr_handler</p>
<p>比较常看见的两个权限问题，find和add</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="k">case</span> <span class="nl">SVC_MGR_CHECK_SERVICE</span><span class="p">:</span>
<span class="ln"> 2</span>    <span class="n">s</span> <span class="o">=</span> <span class="n">bio_get_string16</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
<span class="ln"> 3</span>    <span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
<span class="ln"> 4</span>        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="ln"> 5</span>    <span class="p">}</span>
<span class="ln"> 6</span>    <span class="n">handle</span> <span class="o">=</span> <span class="n">do_find_service</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">txn</span><span class="o">-&gt;</span><span class="n">sender_euid</span><span class="p">,</span> <span class="n">txn</span><span class="o">-&gt;</span><span class="n">sender_pid</span><span class="p">);</span>
<span class="ln"> 7</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">handle</span><span class="p">)</span>
<span class="ln"> 8</span>        <span class="k">break</span><span class="p">;</span>
<span class="ln"> 9</span>    <span class="n">bio_put_ref</span><span class="p">(</span><span class="n">reply</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
<span class="ln">10</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="ln">11</span> 
<span class="ln">12</span><span class="k">case</span> <span class="nl">SVC_MGR_ADD_SERVICE</span><span class="p">:</span>
<span class="ln">13</span>    <span class="n">s</span> <span class="o">=</span> <span class="n">bio_get_string16</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
<span class="ln">14</span>    <span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">15</span>        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="ln">16</span>    <span class="p">}</span>
<span class="ln">17</span>    <span class="n">handle</span> <span class="o">=</span> <span class="n">bio_get_ref</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
<span class="ln">18</span>    <span class="n">allow_isolated</span> <span class="o">=</span> <span class="n">bio_get_uint32</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="ln">19</span>    <span class="n">dumpsys_priority</span> <span class="o">=</span> <span class="n">bio_get_uint32</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
<span class="ln">20</span>    <span class="k">if</span> <span class="p">(</span><span class="n">do_add_service</span><span class="p">(</span><span class="n">bs</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="n">txn</span><span class="o">-&gt;</span><span class="n">sender_euid</span><span class="p">,</span> <span class="n">allow_isolated</span><span class="p">,</span> <span class="n">dumpsys_priority</span><span class="p">,</span>
<span class="ln">21</span>                       <span class="n">txn</span><span class="o">-&gt;</span><span class="n">sender_pid</span><span class="p">))</span>
<span class="ln">22</span>        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="ln">23</span>    <span class="k">break</span><span class="p">;</span>
</code></pre></div><p>这里面的调用栈都会跑到kernel里面，和前面的分析都差不多的</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln">1</span><span class="n">do_add_service</span> <span class="o">-&gt;</span> <span class="n">svc_can_register</span> <span class="o">-&gt;</span> <span class="n">check_mac_perms_from_lookup</span> <span class="o">-&gt;</span> <span class="n">check_mac_perms</span> <span class="o">-&gt;</span>
<span class="ln">2</span><span class="n">selinux_check_access</span> <span class="o">-&gt;</span> <span class="n">avc_has_perm</span> <span class="o">-&gt;</span> <span class="n">avc_has_perm_noaudit</span>
</code></pre></div><p>重点的这里的权限需要哪些，这个是在service_manager.c里面指定的</p>
<p>比如add 和 find ：</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="k">static</span> <span class="kt">int</span> <span class="nf">svc_can_find</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">name_len</span><span class="p">,</span> <span class="n">pid_t</span> <span class="n">spid</span><span class="p">,</span> <span class="n">uid_t</span> <span class="n">uid</span><span class="p">)</span>
<span class="ln"> 2</span><span class="p">{</span>
<span class="ln"> 3</span>    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">perm</span> <span class="o">=</span> <span class="s">&#34;find&#34;</span><span class="p">;</span>
<span class="ln"> 4</span>    <span class="k">return</span> <span class="n">check_mac_perms_from_lookup</span><span class="p">(</span><span class="n">spid</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">perm</span><span class="p">,</span> <span class="n">str8</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">name_len</span><span class="p">))</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="ln"> 5</span><span class="p">}</span>
<span class="ln"> 6</span> 
<span class="ln"> 7</span><span class="k">static</span> <span class="kt">int</span> <span class="nf">svc_can_register</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint16_t</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">name_len</span><span class="p">,</span> <span class="n">pid_t</span> <span class="n">spid</span><span class="p">,</span> <span class="n">uid_t</span> <span class="n">uid</span><span class="p">)</span>
<span class="ln"> 8</span><span class="p">{</span>
<span class="ln"> 9</span>    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">perm</span> <span class="o">=</span> <span class="s">&#34;add&#34;</span><span class="p">;</span>
<span class="ln">10</span> 
<span class="ln">11</span>    <span class="k">if</span> <span class="p">(</span><span class="n">multiuser_get_app_id</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">AID_APP</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">12</span>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Don&#39;t allow apps to register services */</span>
<span class="ln">13</span>    <span class="p">}</span>
<span class="ln">14</span> 
<span class="ln">15</span>    <span class="k">return</span> <span class="n">check_mac_perms_from_lookup</span><span class="p">(</span><span class="n">spid</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">perm</span><span class="p">,</span> <span class="n">str8</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">name_len</span><span class="p">))</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="ln">16</span><span class="p">}</span>
</code></pre></div><p>不过这里的打印不再是kernel log里面的了，而是logcat信息里面，那它的打印是怎么来的？</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln">1</span>06-21 13:12:58.631  <span class="m">2832</span>  <span class="m">2832</span> E SELinux : avc:  denied  <span class="o">{</span> find <span class="o">}</span> <span class="k">for</span> <span class="nv">service</span><span class="o">=</span>activity <span class="nv">pid</span><span class="o">=</span><span class="m">4138</span> <span class="nv">uid</span><span class="o">=</span><span class="m">0</span> <span class="nv">scontext</span><span class="o">=</span>u:r:testA:s0 <span class="nv">tcontext</span><span class="o">=</span>u:object_r:activity_service:s0 <span class="nv">tclass</span><span class="o">=</span>service_manager <span class="nv">permissive</span><span class="o">=</span><span class="m">1</span>
</code></pre></div><p>在前面提到的avc_has_perm函数里面，还有一句</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln">1</span><span class="n">rc2</span> <span class="o">=</span> <span class="n">avc_audit</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">tsid</span><span class="p">,</span> <span class="n">tclass</span><span class="p">,</span> <span class="n">requested</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">avd</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">auditdata</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</code></pre></div><p>/android/external/selinux/libselinux/src/avc.c</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="kt">void</span> <span class="nf">avc_audit</span><span class="p">(</span><span class="n">security_id_t</span> <span class="n">ssid</span><span class="p">,</span> <span class="n">security_id_t</span> <span class="n">tsid</span><span class="p">,</span>
<span class="ln"> 2</span>           <span class="n">security_class_t</span> <span class="n">tclass</span><span class="p">,</span> <span class="n">access_vector_t</span> <span class="n">requested</span><span class="p">,</span>
<span class="ln"> 3</span>           <span class="k">struct</span> <span class="nc">av_decision</span> <span class="o">*</span><span class="n">avd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">result</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="ln"> 4</span><span class="p">{</span>
<span class="ln"> 5</span>    <span class="n">access_vector_t</span> <span class="n">denied</span><span class="p">,</span> <span class="n">audited</span><span class="p">;</span>
<span class="ln"> 6</span> 
<span class="ln"> 7</span>    <span class="n">denied</span> <span class="o">=</span> <span class="n">requested</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">avd</span><span class="o">-&gt;</span><span class="n">allowed</span><span class="p">;</span>
<span class="ln"> 8</span>    <span class="k">if</span> <span class="p">(</span><span class="n">denied</span><span class="p">)</span>
<span class="ln"> 9</span>        <span class="n">audited</span> <span class="o">=</span> <span class="n">denied</span> <span class="o">&amp;</span> <span class="n">avd</span><span class="o">-&gt;</span><span class="n">auditdeny</span><span class="p">;</span>
<span class="ln">10</span>    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">requested</span> <span class="o">||</span> <span class="n">result</span><span class="p">)</span>
<span class="ln">11</span>        <span class="n">audited</span> <span class="o">=</span> <span class="n">denied</span> <span class="o">=</span> <span class="n">requested</span><span class="p">;</span>
<span class="ln">12</span>    <span class="k">else</span>
<span class="ln">13</span>        <span class="n">audited</span> <span class="o">=</span> <span class="n">requested</span> <span class="o">&amp;</span> <span class="n">avd</span><span class="o">-&gt;</span><span class="n">auditallow</span><span class="p">;</span>
<span class="ln">14</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">audited</span><span class="p">)</span>
<span class="ln">15</span>        <span class="k">return</span><span class="p">;</span>
<span class="ln">16</span><span class="cp">#if 0</span><span class="c">
</span><span class="ln">17</span><span class="c">    if (!check_avc_ratelimit())
</span><span class="ln">18</span><span class="c">        return;
</span><span class="ln">19</span><span class="c"></span><span class="cp">#endif
</span><span class="ln">20</span><span class="cp"></span>    <span class="cm">/* prevent overlapping buffer writes */</span>
<span class="ln">21</span>    <span class="n">avc_get_lock</span><span class="p">(</span><span class="n">avc_log_lock</span><span class="p">);</span>
<span class="ln">22</span>    <span class="n">snprintf</span><span class="p">(</span><span class="n">avc_audit_buf</span><span class="p">,</span> <span class="n">AVC_AUDIT_BUFSIZE</span><span class="p">,</span>
<span class="ln">23</span>         <span class="s">&#34;%s:  %s &#34;</span><span class="p">,</span> <span class="n">avc_prefix</span><span class="p">,</span> <span class="p">(</span><span class="n">denied</span> <span class="o">||</span> <span class="o">!</span><span class="n">requested</span><span class="p">)</span> <span class="o">?</span> <span class="s">&#34;denied&#34;</span> <span class="o">:</span> <span class="s">&#34;granted&#34;</span><span class="p">);</span>
<span class="ln">24</span>    <span class="n">avc_dump_av</span><span class="p">(</span><span class="n">tclass</span><span class="p">,</span> <span class="n">audited</span><span class="p">);</span>
<span class="ln">25</span>    <span class="n">log_append</span><span class="p">(</span><span class="n">avc_audit_buf</span><span class="p">,</span> <span class="s">&#34; for &#34;</span><span class="p">);</span>
<span class="ln">26</span> 
<span class="ln">27</span>    <span class="cm">/* get any extra information printed by the callback */</span>
<span class="ln">28</span>    <span class="n">avc_suppl_audit</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">tclass</span><span class="p">,</span> <span class="n">avc_audit_buf</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">avc_audit_buf</span><span class="p">),</span>
<span class="ln">29</span>            <span class="n">AVC_AUDIT_BUFSIZE</span> <span class="o">-</span> <span class="n">strlen</span><span class="p">(</span><span class="n">avc_audit_buf</span><span class="p">));</span>
<span class="ln">30</span> 
<span class="ln">31</span>    <span class="n">log_append</span><span class="p">(</span><span class="n">avc_audit_buf</span><span class="p">,</span> <span class="s">&#34; &#34;</span><span class="p">);</span>
<span class="ln">32</span>    <span class="n">avc_dump_query</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">tsid</span><span class="p">,</span> <span class="n">tclass</span><span class="p">);</span>
<span class="ln">33</span> 
<span class="ln">34</span>    <span class="k">if</span> <span class="p">(</span><span class="n">denied</span><span class="p">)</span>
<span class="ln">35</span>        <span class="n">log_append</span><span class="p">(</span><span class="n">avc_audit_buf</span><span class="p">,</span> <span class="s">&#34; permissive=%u&#34;</span><span class="p">,</span> <span class="n">result</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>
<span class="ln">36</span> 
<span class="ln">37</span>    <span class="n">log_append</span><span class="p">(</span><span class="n">avc_audit_buf</span><span class="p">,</span> <span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
<span class="ln">38</span>    <span class="n">avc_log</span><span class="p">(</span><span class="n">SELINUX_AVC</span><span class="p">,</span> <span class="s">&#34;%s&#34;</span><span class="p">,</span> <span class="n">avc_audit_buf</span><span class="p">);</span>
<span class="ln">39</span> 
<span class="ln">40</span>    <span class="n">avc_release_lock</span><span class="p">(</span><span class="n">avc_log_lock</span><span class="p">);</span>
<span class="ln">41</span><span class="p">}</span>
</code></pre></div><p>最后调用的是avc_log打印的，而这个其实这里是回调service_manager.c设置的callback函数</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="n">cb</span><span class="p">.</span><span class="n">func_audit</span> <span class="o">=</span> <span class="n">audit_callback</span><span class="p">;</span>
<span class="ln"> 2</span><span class="n">selinux_set_callback</span><span class="p">(</span><span class="n">SELINUX_CB_AUDIT</span><span class="p">,</span> <span class="n">cb</span><span class="p">);</span>
<span class="ln"> 3</span><span class="n">cb</span><span class="p">.</span><span class="n">func_log</span> <span class="o">=</span> <span class="n">selinux_log_callback</span><span class="p">;</span>
<span class="ln"> 4</span><span class="n">selinux_set_callback</span><span class="p">(</span><span class="n">SELINUX_CB_LOG</span><span class="p">,</span> <span class="n">cb</span><span class="p">);</span>
<span class="ln"> 5</span> 
<span class="ln"> 6</span> 
<span class="ln"> 7</span><span class="kt">int</span> <span class="nf">selinux_log_callback</span><span class="p">(</span><span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="ln"> 8</span><span class="p">{</span>
<span class="ln"> 9</span>    <span class="n">va_list</span> <span class="n">ap</span><span class="p">;</span>
<span class="ln">10</span>    <span class="kt">int</span> <span class="n">priority</span><span class="p">;</span>
<span class="ln">11</span>    <span class="kt">char</span> <span class="o">*</span><span class="n">strp</span><span class="p">;</span>
<span class="ln">12</span> 
<span class="ln">13</span>    <span class="k">switch</span><span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">14</span>    <span class="k">case</span> <span class="nl">SELINUX_WARNING</span><span class="p">:</span>
<span class="ln">15</span>        <span class="n">priority</span> <span class="o">=</span> <span class="n">ANDROID_LOG_WARN</span><span class="p">;</span>
<span class="ln">16</span>        <span class="k">break</span><span class="p">;</span>
<span class="ln">17</span>    <span class="k">case</span> <span class="nl">SELINUX_INFO</span><span class="p">:</span>
<span class="ln">18</span>        <span class="n">priority</span> <span class="o">=</span> <span class="n">ANDROID_LOG_INFO</span><span class="p">;</span>
<span class="ln">19</span>        <span class="k">break</span><span class="p">;</span>
<span class="ln">20</span>    <span class="k">default</span><span class="o">:</span>
<span class="ln">21</span>        <span class="n">priority</span> <span class="o">=</span> <span class="n">ANDROID_LOG_ERROR</span><span class="p">;</span>
<span class="ln">22</span>        <span class="k">break</span><span class="p">;</span>
<span class="ln">23</span>    <span class="p">}</span>
<span class="ln">24</span> 
<span class="ln">25</span>    <span class="n">va_start</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
<span class="ln">26</span>    <span class="k">if</span> <span class="p">(</span><span class="n">vasprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">strp</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">ap</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">27</span>        <span class="n">LOG_PRI</span><span class="p">(</span><span class="n">priority</span><span class="p">,</span> <span class="s">&#34;SELinux&#34;</span><span class="p">,</span> <span class="s">&#34;%s&#34;</span><span class="p">,</span> <span class="n">strp</span><span class="p">);</span>
<span class="ln">28</span>        <span class="n">LOG_EVENT_STRING</span><span class="p">(</span><span class="n">AUDITD_LOG_TAG</span><span class="p">,</span> <span class="n">strp</span><span class="p">);</span>
<span class="ln">29</span>        <span class="n">free</span><span class="p">(</span><span class="n">strp</span><span class="p">);</span>
<span class="ln">30</span>    <span class="p">}</span>
<span class="ln">31</span>    <span class="n">va_end</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
<span class="ln">32</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="ln">33</span><span class="p">}</span>
</code></pre></div><p>关于Android里面的属性，也有相应的权限检查机制，有兴趣的可以看看相关代码~</p>
<h2 id="32avc-denied信息分析">3.2avc denied信息分析</h2>
<p>kernel log中的avc denied来自于common_lsm_audit，还有函数avc_audit_pre_callback、avc_audit_post_callback，把avc denied的每一段信息拼接起来</p>
<p>最后是用printk打印到kernel log里面</p>
<p>kernelcode/security/selinux/avc.c</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="cm">/* This is the slow part of avc audit with big stack footprint */</span>
<span class="ln"> 2</span><span class="n">noinline</span> <span class="kt">int</span> <span class="nf">slow_avc_audit</span><span class="p">(</span><span class="n">u32</span> <span class="n">ssid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">tsid</span><span class="p">,</span> <span class="n">u16</span> <span class="n">tclass</span><span class="p">,</span>
<span class="ln"> 3</span>        <span class="n">u32</span> <span class="n">requested</span><span class="p">,</span> <span class="n">u32</span> <span class="n">audited</span><span class="p">,</span> <span class="n">u32</span> <span class="n">denied</span><span class="p">,</span> <span class="kt">int</span> <span class="n">result</span><span class="p">,</span>
<span class="ln"> 4</span>        <span class="k">struct</span> <span class="nc">common_audit_data</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
<span class="ln"> 5</span>        <span class="kt">unsigned</span> <span class="n">flags</span><span class="p">)</span>
<span class="ln"> 6</span><span class="p">{</span>
<span class="ln"> 7</span>    <span class="p">......</span>
<span class="ln"> 8</span>    <span class="n">common_lsm_audit</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">avc_audit_pre_callback</span><span class="p">,</span> <span class="n">avc_audit_post_callback</span><span class="p">);</span>
<span class="ln"> 9</span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="ln">10</span><span class="p">}</span>
</code></pre></div><p>下面针对几个关键的信息分析下</p>
<ul>
<li>{ write }
缺失的权限，这个是本文讨论的核心部分</li>
</ul>
<p>打印来自于函数 avc_dump_av (kernelcode/security/selinux/avc.c)</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="cm">/**
</span><span class="ln"> 2</span><span class="cm"> * avc_dump_av - Display an access vector in human-readable form.
</span><span class="ln"> 3</span><span class="cm"> * @tclass: target security class
</span><span class="ln"> 4</span><span class="cm"> * @av: access vector
</span><span class="ln"> 5</span><span class="cm"> */</span>
<span class="ln"> 6</span><span class="k">static</span> <span class="kt">void</span> <span class="nf">avc_dump_av</span><span class="p">(</span><span class="k">struct</span> <span class="nc">audit_buffer</span> <span class="o">*</span><span class="n">ab</span><span class="p">,</span> <span class="n">u16</span> <span class="n">tclass</span><span class="p">,</span> <span class="n">u32</span> <span class="n">av</span><span class="p">)</span>
<span class="ln"> 7</span><span class="p">{</span>
<span class="ln"> 8</span>    <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">perms</span><span class="p">;</span>
<span class="ln"> 9</span>    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">perm</span><span class="p">;</span>
<span class="ln">10</span> 
<span class="ln">11</span>    <span class="k">if</span> <span class="p">(</span><span class="n">av</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">12</span>        <span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&#34; null&#34;</span><span class="p">);</span>
<span class="ln">13</span>        <span class="k">return</span><span class="p">;</span>
<span class="ln">14</span>    <span class="p">}</span>
<span class="ln">15</span> 
<span class="ln">16</span>    <span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">tclass</span> <span class="o">||</span> <span class="n">tclass</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">secclass_map</span><span class="p">));</span>
<span class="ln">17</span>    <span class="n">perms</span> <span class="o">=</span> <span class="n">secclass_map</span><span class="p">[</span><span class="n">tclass</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">perms</span><span class="p">;</span>
<span class="ln">18</span> 
<span class="ln">19</span>    <span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&#34; {&#34;</span><span class="p">);</span>
<span class="ln">20</span>    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="ln">21</span>    <span class="n">perm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="ln">22</span>    <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">av</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
<span class="ln">23</span>        <span class="k">if</span> <span class="p">((</span><span class="n">perm</span> <span class="o">&amp;</span> <span class="n">av</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">perms</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
<span class="ln">24</span>            <span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&#34; %s&#34;</span><span class="p">,</span> <span class="n">perms</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="ln">25</span>            <span class="n">av</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">perm</span><span class="p">;</span>
<span class="ln">26</span>        <span class="p">}</span>
<span class="ln">27</span>        <span class="n">i</span><span class="o">++</span><span class="p">;</span>
<span class="ln">28</span>        <span class="n">perm</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
<span class="ln">29</span>    <span class="p">}</span>
<span class="ln">30</span> 
<span class="ln">31</span>    <span class="k">if</span> <span class="p">(</span><span class="n">av</span><span class="p">)</span>
<span class="ln">32</span>        <span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&#34; 0x%x&#34;</span><span class="p">,</span> <span class="n">av</span><span class="p">);</span>
<span class="ln">33</span> 
<span class="ln">34</span>    <span class="n">audit_log_format</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">&#34; }&#34;</span><span class="p">);</span>
<span class="ln">35</span><span class="p">}</span>
</code></pre></div><p>分析avc_dump_av代码逻辑，其实就是在secclass_map数组里面找到权限对应的字符串，打印出来方便分析</p>
<p>和前面部分提到的内容是相关的</p>
<p>for pid=4021</p>
<p>进程ID</p>
<p>comm=“testA.sh”</p>
<p>进程的名称，但是这个字符串设计的是有长度限制的，所以经常看见一些apk的包名这里会打印不完整</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln">1</span><span class="o">[</span> 5786.420602@3<span class="o">]</span> <span class="nv">type</span><span class="o">=</span><span class="m">1400</span> audit<span class="o">(</span>1624264582.595:426<span class="o">)</span>: avc: denied <span class="o">{</span> open <span class="o">}</span> <span class="k">for</span> <span class="nv">pid</span><span class="o">=</span><span class="m">4686</span> <span class="nv">comm</span><span class="o">=</span><span class="s2">&#34;testA.launcher3&#34;</span> <span class="nv">path</span><span class="o">=</span><span class="s2">&#34;/proc/vmstat&#34;</span> <span class="nv">dev</span><span class="o">=</span><span class="s2">&#34;proc&#34;</span> <span class="nv">ino</span><span class="o">=</span><span class="m">4026532002</span> <span class="nv">scontext</span><span class="o">=</span>u:r:untrusted_app:s0:c46,c256,c512,c768 <span class="nv">tcontext</span><span class="o">=</span>u:object_r:proc_vmstat:s0 <span class="nv">tclass</span><span class="o">=</span>file <span class="nv">permissive</span><span class="o">=</span><span class="m">1</span>
<span class="ln">2</span> 
<span class="ln">3</span>实际上进程名是com.testA.launcher3
</code></pre></div><ul>
<li>
<p>scontext=u:r:testA:s0
主体的安全上下文，这里就是脚本所在的进程testA.sh</p>
</li>
<li>
<p>tcontext=u:object_r:vendor_data_file:s0</p>
<p>被操作对象的安全上下文，这里是/data/vendor/目录的安全上下文，默认在这个目录下面创建的文件的安全上下文，都会继承这个父目录的安全上下文</p>
</li>
<li>
<p>tclass=dir
种类，dir是目录，file文件，这个也比较好理解</p>
</li>
</ul>
<p>所以后面写te规则的时候，其实就是</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln">1</span><span class="n">allow</span> <span class="n">scontext</span> <span class="nl">tcontext</span><span class="p">:</span><span class="n">tclass</span> <span class="n">perms</span><span class="p">;</span>
<span class="ln">2</span> 
<span class="ln">3</span><span class="err">也就是：</span>
<span class="ln">4</span> 
<span class="ln">5</span><span class="n">allow</span> <span class="n">testA</span> <span class="nl">vendor_data_file</span><span class="p">:</span><span class="n">dir</span> <span class="p">{</span> <span class="n">write</span> <span class="p">};</span>
</code></pre></div><p>有个工具叫audit2allow，可以将报错信息自动生成te规则，其实讲实话我并不建议使用</p>
<p>首先，格式有要求，动不动转失败，还有转漏的；</p>
<p>其次，你都不清楚需要的权限是什么，就一顿操作，把所有报错信息都加上去了，可能加的一些权限和问题没有关联，结果还违反neverallow规则，改完以后根本追溯不了</p>
<p>我建议直接看log信息添加权限信息，结合SELinux的知识，添加的权限有理有据，也可以提升自己的能力</p>
<h2 id="33调试">3.3调试</h2>
<h3 id="331快速编译和替换">3.3.1快速编译和替换</h3>
<h4 id="3311编译和替换">3.3.1.1编译和替换</h4>
<table>
<thead>
<tr>
<th>修改的内容</th>
<th>编译命令</th>
<th>替换方式</th>
</tr>
</thead>
<tbody>
<tr>
<td>*.te</td>
<td>make precompiled_sepolicy 或者 make selinux_policy</td>
<td>/vendor/etc/selinux/precompiled_sepolicy 或者 /odm/etc/selinux/precompiled_sepolicy</td>
</tr>
<tr>
<td>property_contexts</td>
<td>可以直接板子上验证</td>
<td>直接到板子上改 /vendor/etc/selinux/vendor_property_contexts、 /system/etc/selinux/plat_property_contexts</td>
</tr>
<tr>
<td>file_contexts</td>
<td>可以直接板子上验证</td>
<td>直接到板子上改 /vendor/etc/selinux/vendor_file_contexts、 /system/etc/selinux/plat_file_contexts</td>
</tr>
<tr>
<td>service_contexts</td>
<td>可以直接板子上验证</td>
<td>直接到板子上改<!-- raw HTML omitted -->/vendor/etc/selinux/vendor_hwservice_contexts、<!-- raw HTML omitted -->/system/etc/selinux/plat_hwservice_contexts、<!-- raw HTML omitted -->/system/etc/selinux/plat_service_contexts</td>
</tr>
</tbody>
</table>
<p>有很多文章提到在Android 9.0上，编译策略文件要用make sepolicy然后替换/vendor/etc/selinux /system/etc/selinux 两个目录，其实这里是有问题的</p>
<p>1、make sepolicy之后，/vendor/etc/selinux /system/etc/selinux 目录下的产物是不会发生变化，因此替换整个目录是没有作用的（如果lunch的时候target发生变化，那也只是第一次会重新生成，后面再修改te也不会变）</p>
<p>2、system/sepolicy目录下, mma -j编译后，替换是可以的，因为这个相当于把android/system/sepolicy/Android.mk 的所有module都编译了一遍</p>
<p>讲讲由来：</p>
<p>从Android 8.0之后，因为Google project treble的影响，二进制策略文件不再是根目录的 /sepolicy （也就是make sepolicy 编译生成的产物 root/sepolicy）</p>
<p>而是 vendor/etc/selinux/precompiled_sepolicy （或者是odm/etc/selinux/precompiled_sepolicy）</p>
<p>相应的，编译的命令也有变化，修改了*.te，更正确的应该是使用make precompiled_sepolicy</p>
<p>生成 vendor/etc/selinux/precompiled_sepolicy 替换到板子即可 (如果存在odm分区，生成在 odm/etc/selinux/precompiled_sepolicy，替换到板子的路径也是对应的)</p>
<p>那make sepolicy和make precompiled_sepolicy 有什么区别？</p>
<p>编译出来的产物其实内容是一样的，但是生成路径不一样</p>
<p>之所以说有误解，是因为我们没有搞清楚真正要替换的是什么</p>
<p>make selinux_policy 我比较常使用，因为这个编译范围把需要的都编译了，在对应目录下的文件都会更新</p>
<p>这里还需要注意一下，修改/vendor 、 /system下面文件的安全上下文（在/vendor/etc/selinux/vendor_file_contexts、/system/etc/selinux/plat_file_contexts）时，</p>
<p>可能出现修改了没有生效的问题，要注意用restorecon命令恢复一下安全上下文，这些只读分区的文件是一开始编译的时候确定下来的，</p>
<p>所以会发现有些时候没有改成功，最关键的就是出现这些问题的时候，多用ls -Z、getprop -Z看看安全上下文</p>
<p>比如：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln"> 1</span>picasso:/ <span class="c1"># ls -lZ /system/xbin/testB</span>
<span class="ln"> 2</span>-rwxr-xr-x <span class="m">1</span> root shell u:object_r:system_file:s0 <span class="m">20380</span> 2009-01-01 00:00 /system/xbin/testB
<span class="ln"> 3</span> 
<span class="ln"> 4</span>修改了file_context
<span class="ln"> 5</span> 
<span class="ln"> 6</span>picasso:/ <span class="c1"># restorecon -R /system/xbin/testB</span>
<span class="ln"> 7</span>SELinux: Loaded file_contexts
<span class="ln"> 8</span>picasso:/ <span class="c1">#</span>
<span class="ln"> 9</span>picasso:/ <span class="c1"># ls -lZ /system/xbin/testB</span>
<span class="ln">10</span>-rwxr-xr-x <span class="m">1</span> root shell u:object_r:testB_exec:s0 <span class="m">20380</span> 2009-01-01 00:00 /system/xbin/testB
</code></pre></div><h4 id="3312load_policy">3.3.1.2load_policy</h4>
<p>上面的方式在替换之后需要重启，开机会重新load新的二进制策略文件</p>
<p>还有一个命令也很方便：</p>
<p>load_policy</p>
<p>我们可以直接加载二进制策略文件</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln">1</span><span class="n">load_policy</span>  <span class="o">/</span><span class="n">storage</span><span class="o">/</span><span class="n">xxxx</span><span class="o">/</span><span class="n">precompiled_sepolicy</span>
</code></pre></div><p>不过只在本次开机才有效，重启就没有效果了，所以如果是开机过程的SELinux权限问题，还是得乖乖的替换文件</p>
<h3 id="332尽量使用宏">3.3.2尽量使用宏</h3>
<p>对于一些文件和目录的操作，我们可以尽量使用宏</p>
<p>比如：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>allow testC vendor_data_file:dir { write add_name create getattr read setattr open remove_name rmdir };
<span class="ln">2</span>allow testC vendor_data_file:file { create read write open ioctl getattr lock append unlink setattr };
</code></pre></div><p>这里脚本的目的是要创建目录和文件</p>
<p>如果按我们现在的方式，等着系统一条一条的报权限问题，那这个过程会发现你得反复添加编译再替换到板子，很浪费时间</p>
<p>但其实可以直接添加下面的权限：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>allow testC vendor_data_file:dir create_dir_perms;
<span class="ln">2</span>allow testC vendor_data_file:file create_file_perms;
</code></pre></div><p>create_dir_perms和create_file_perms的定义在/android/system/sepolicy/public/global_macros</p>
<p>如果只是读取，那就直接用r_file_perms、r_dir_perms</p>
<p>使用宏会比较快的解决文件和目录相关的操作，这个也是遇到比较多的一种</p>
<p>还有一个宏定义的地方：</p>
<p>/android/system/sepolicy/public/te_macros</p>
<p>对于属性，通常用的是这两个</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln">1</span><span class="n">get_prop</span><span class="p">(</span><span class="n">testC</span><span class="p">,</span> <span class="n">system_prop</span><span class="p">)</span>
<span class="ln">2</span><span class="n">set_prop</span><span class="p">(</span><span class="n">testC</span><span class="p">,</span> <span class="n">system_prop</span><span class="p">)</span>
</code></pre></div><p>这里是有包含关系的，set_prop宏里面是包含了get_prop的，所以其实写了set_prop就不用写get_prop了</p>
<p>对于binder，这两个用的比较多</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln">1</span><span class="n">binder_use</span>
<span class="ln">2</span><span class="n">binder_call</span>
</code></pre></div><p>遇到一些权限问题的时候，可以先看看te_macros里面的，搜一搜，看看注释，会有很大帮助的</p>
<p>当然，还可以自定义宏，可以少写很多重复的规则，比如下面这个：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln"> 1</span>define(`testD_common_file_dir_r_perms&#39;, `
<span class="ln"> 2</span>allow testD $1:file r_file_perms;
<span class="ln"> 3</span>allow testD $1:dir r_dir_perms;
<span class="ln"> 4</span>&#39;)
<span class="ln"> 5</span> 
<span class="ln"> 6</span>然后使用：
<span class="ln"> 7</span>testD_common_file_dir_r_perms(init)
<span class="ln"> 8</span>testD_common_file_dir_r_perms(kernel)
<span class="ln"> 9</span>testD_common_file_dir_r_perms(logd)
<span class="ln">10</span>testD_common_file_dir_r_perms(vold)
<span class="ln">11</span>testD_common_file_dir_r_perms(audioserver)
<span class="ln">12</span>testD_common_file_dir_r_perms(lmkd)
<span class="ln">13</span>testD_common_file_dir_r_perms(tee)
<span class="ln">14</span>testD_common_file_dir_r_perms(surfaceflinger)
<span class="ln">15</span>testD_common_file_dir_r_perms(hdmicecd)
<span class="ln">16</span>testD_common_file_dir_r_perms(hwservicemanager)
<span class="ln">17</span>testD_common_file_dir_r_perms(netd)
<span class="ln">18</span>testD_common_file_dir_r_perms(sdcardfs)
<span class="ln">19</span>testD_common_file_dir_r_perms(servicemanager)
</code></pre></div><h3 id="333使用属性">3.3.3使用属性</h3>
<p>如果出现下面这种一直报的同一类型和权限的
比如service_manager { find }</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln"> 1</span>allow testD activity_service:service_manager { find };
<span class="ln"> 2</span>allow testD package_service:service_manager { find };
<span class="ln"> 3</span>allow testD window_service:service_manager { find };
<span class="ln"> 4</span>allow testD meminfo_service:service_manager { find };
<span class="ln"> 5</span>allow testD cpuinfo_service:service_manager { find };
<span class="ln"> 6</span>allow testD mount_service:service_manager { find };
<span class="ln"> 7</span>allow testD surfaceflinger_service:service_manager { find };
<span class="ln"> 8</span>allow testD audioserver_service:service_manager { find };
<span class="ln"> 9</span>allow testD secure_element_service:service_manager { find };
<span class="ln">10</span>allow testD contexthub_service:service_manager { find };
<span class="ln">11</span>allow testD netd_listener_service:service_manager { find };
<span class="ln">12</span>allow testD connmetrics_service:service_manager { find };
<span class="ln">13</span>allow testD bluetooth_manager_service:service_manager { find };
<span class="ln">14</span>allow testD imms_service:service_manager { find };
<span class="ln">15</span>allow testD cameraproxy_service:service_manager { find };
<span class="ln">16</span>allow testD slice_service:service_manager { find };
<span class="ln">17</span>allow testD media_projection_service:service_manager { find };
<span class="ln">18</span>allow testD crossprofileapps_service:service_manager { find };
<span class="ln">19</span>allow testD launcherapps_service:service_manager { find };
<span class="ln">20</span>allow testD shortcut_service:service_manager { find };
<span class="ln">21</span>allow testD media_router_service:service_manager { find };
<span class="ln">22</span>allow testD hdmi_control_service:service_manager { find };
<span class="ln">23</span>allow testD media_session_service:service_manager { find };
<span class="ln">24</span>allow testD restrictions_service:service_manager { find };
<span class="ln">25</span>allow testD graphicsstats_service:service_manager { find };
<span class="ln">26</span>allow testD dreams_service:service_manager { find };
<span class="ln">27</span>allow testD commontime_management_service:service_manager { find };
<span class="ln">28</span>allow testD network_time_update_service:service_manager { find };
<span class="ln">29</span>allow testD diskstats_service:service_manager { find };
<span class="ln">30</span>allow testD voiceinteraction_service:service_manager { find };
<span class="ln">31</span>allow testD appwidget_service:service_manager { find };
<span class="ln">32</span>allow testD backup_service:service_manager { find };
<span class="ln">33</span>allow testD trust_service:service_manager { find };
<span class="ln">34</span>allow testD voiceinteraction_service:service_manager { find };
<span class="ln">35</span>allow testD jobscheduler_service:service_manager { find };
<span class="ln">36</span>allow testD hardware_properties_service:service_manager { find };
<span class="ln">37</span>allow testD serial_service:service_manager { find };
<span class="ln">38</span>allow testD usb_service:service_manager { find };
<span class="ln">39</span>allow testD DockObserver_service:service_manager { find };
<span class="ln">40</span>allow testD audio_service:service_manager { find };
<span class="ln">41</span>allow testD wallpaper_service:service_manager { find };
<span class="ln">42</span>allow testD search_service:service_manager { find };
<span class="ln">43</span>allow testD country_detector_service:service_manager { find };
<span class="ln">44</span>allow testD location_service:service_manager { find };
<span class="ln">45</span>allow testD devicestoragemonitor_service:service_manager { find };
<span class="ln">46</span>allow testD notification_service:service_manager { find };
<span class="ln">47</span>allow testD updatelock_service:service_manager { find };
<span class="ln">48</span>allow testD system_update_service:service_manager { find };
<span class="ln">49</span>allow testD servicediscovery_service:service_manager { find };
<span class="ln">50</span>allow testD connectivity_service:service_manager { find };
<span class="ln">51</span>allow testD ethernet_service:service_manager { find };
<span class="ln">52</span>allow testD wifip2p_service:service_manager { find };
<span class="ln">53</span>allow testD wifiscanner_service:service_manager { find };
<span class="ln">54</span>allow testD wifi_service:service_manager { find };
<span class="ln">55</span>allow testD netpolicy_service:service_manager { find };
<span class="ln">56</span>allow testD netstats_service:service_manager { find };
<span class="ln">57</span>allow testD network_score_service:service_manager { find };
<span class="ln">58</span>allow testD textclassification_service:service_manager { find };
<span class="ln">59</span>allow testD textservices_service:service_manager { find };
<span class="ln">60</span>allow testD ipsec_service:service_manager { find };
<span class="ln">61</span>allow testD network_management_service:service_manager { find };
<span class="ln">62</span>allow testD clipboard_service:service_manager { find };
<span class="ln">63</span>allow testD statusbar_service:service_manager { find };
<span class="ln">64</span>allow testD device_policy_service:service_manager { find };
<span class="ln">65</span>allow testD deviceidle_service:service_manager { find };
<span class="ln">66</span>allow testD uimode_service:service_manager { find };
<span class="ln">67</span>allow testD lock_settings_service:service_manager { find };
<span class="ln">68</span>allow testD storagestats_service:service_manager { find };
<span class="ln">69</span>allow testD accessibility_service:service_manager { find };
<span class="ln">70</span>allow testD input_method_service:service_manager { find };
<span class="ln">71</span>allow testD pinner_service:service_manager { find };
<span class="ln">72</span>allow testD network_watchlist_service:service_manager { find };
<span class="ln">73</span>allow testD vr_manager_service:service_manager { find };
<span class="ln">74</span>allow testD input_service:service_manager { find };
</code></pre></div><p>可以找到这些type的共同点，也就是attribute</p>
<p>上面的可以简化为下面的，减去的哪些type是因为违反了neverallow规则的</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>allow testD { service_manager_type -stats_service -incident_service -vold_service -netd_service -installd_service -dumpstate_service }:service_manager { find };
</code></pre></div><h3 id="334setools工具">3.3.4setools工具</h3>
<p>这个工具挺好用的，可以分析二进制策略文件，比如用于某些情况下判断权限是否加上了，可以点击<a href="https://github.com/TresysTechnology/setools3">下载setools3 工具</a></p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln"> 1</span>$ sesearch -A precompiled_sepolicy <span class="p">|</span> grep kernel
<span class="ln"> 2</span>allow kernel app_data_file:file read<span class="p">;</span>
<span class="ln"> 3</span>allow kernel asec_image_file:file read<span class="p">;</span>
<span class="ln"> 4</span>allow kernel binder_device:chr_file <span class="o">{</span> append getattr ioctl lock map open <span class="nb">read</span> write <span class="o">}</span><span class="p">;</span>
<span class="ln"> 5</span>allow kernel debugfs_mali:dir search<span class="p">;</span>
<span class="ln"> 6</span>allow kernel device:blk_file <span class="o">{</span> create getattr setattr unlink <span class="o">}</span><span class="p">;</span>
<span class="ln"> 7</span>allow kernel device:chr_file <span class="o">{</span> create getattr setattr unlink <span class="o">}</span><span class="p">;</span>
<span class="ln"> 8</span>allow kernel device:dir <span class="o">{</span> add_name append create getattr ioctl lock map open <span class="nb">read</span> remove_name rmdir search write <span class="o">}</span><span class="p">;</span>
<span class="ln"> 9</span>allow kernel file_contexts_file:file <span class="o">{</span> getattr ioctl lock map open <span class="nb">read</span> <span class="o">}</span><span class="p">;</span>
<span class="ln">10</span>allow kernel hwbinder_device:chr_file <span class="o">{</span> append getattr ioctl lock map open <span class="nb">read</span> write <span class="o">}</span><span class="p">;</span>
<span class="ln">11</span>allow kernel init:process <span class="o">{</span> rlimitinh share siginh transition <span class="o">}</span><span class="p">;</span>
<span class="ln">12</span>allow kernel init_exec:file <span class="o">{</span> execute getattr map open <span class="nb">read</span> relabelto <span class="o">}</span><span class="p">;</span>
<span class="ln">13</span>allow kernel kernel:cap_userns <span class="o">{</span> sys_boot sys_nice sys_resource <span class="o">}</span><span class="p">;</span>
<span class="ln">14</span>allow kernel kernel:capability <span class="o">{</span> mknod sys_boot sys_nice sys_resource <span class="o">}</span><span class="p">;</span>
<span class="ln">15</span>allow kernel kernel:dir <span class="o">{</span> getattr ioctl lock open <span class="nb">read</span> search <span class="o">}</span><span class="p">;</span>
<span class="ln">16</span>allow kernel kernel:fd use<span class="p">;</span>
<span class="ln">17</span>allow kernel kernel:fifo_file <span class="o">{</span> append getattr ioctl lock map open <span class="nb">read</span> write <span class="o">}</span><span class="p">;</span>
<span class="ln">18</span>allow kernel kernel:file <span class="o">{</span> append getattr ioctl lock map open <span class="nb">read</span> write <span class="o">}</span><span class="p">;</span>
<span class="ln">19</span>allow kernel kernel:lnk_file <span class="o">{</span> getattr ioctl lock map open <span class="nb">read</span> <span class="o">}</span><span class="p">;</span>
<span class="ln">20</span>allow kernel kernel:process <span class="o">{</span> fork getattr getcap getpgid getsched getsession setcap setpgid setrlimit setsched sigchld sigkill signal signull sigstop <span class="o">}</span><span class="p">;</span>
<span class="ln">21</span>allow kernel kernel:security setcheckreqprot<span class="p">;</span>
<span class="ln">22</span>......
</code></pre></div><h1 id="4cts-neverallow处理">4CTS neverallow处理</h1>
<h2 id="41一些权限的解决方案">4.1一些权限的解决方案</h2>
<h3 id="411区分vendor域和system域">4.1.1区分vendor域和system域</h3>
<p>按照以往的经验，我们在Android P上添加客制化的脚本，还是喜欢用 #!/system/bin/sh</p>
<p>但是自从Android 8.0的Treble Project之后，vendor和system已经开始分离了，vendor下面的脚本要使用 #!/vendor/bin/sh，这样能减少很多权限问题</p>
<p>举个例子：</p>
<p><code>/vendor/bin/testA.sh</code></p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span><span class="cp">#!/system/bin/sh
</span><span class="ln">2</span><span class="cp"></span> 
<span class="ln">3</span>...
</code></pre></div><p>然后运行的时候会报下面的权限问题</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln">1</span><span class="o">[</span>  973.048826@1<span class="o">]</span>- <span class="nv">type</span><span class="o">=</span><span class="m">1400</span> audit<span class="o">(</span>1619667483.432:167<span class="o">)</span>: avc: denied <span class="o">{</span> <span class="nb">read</span> execute <span class="o">}</span> <span class="k">for</span> <span class="nv">pid</span><span class="o">=</span><span class="m">4368</span> <span class="nv">comm</span><span class="o">=</span><span class="s2">&#34;testA.sh&#34;</span>
<span class="ln">2</span><span class="nv">path</span><span class="o">=</span><span class="s2">&#34;/system/bin/sh&#34;</span> <span class="nv">dev</span><span class="o">=</span><span class="s2">&#34;mmcblk0p17&#34;</span> <span class="nv">ino</span><span class="o">=</span><span class="m">1073</span> <span class="nv">scontext</span><span class="o">=</span>u:r:testA:s0 <span class="nv">tcontext</span><span class="o">=</span>u:object_r:shell_exec:s0 <span class="nv">tclass</span><span class="o">=</span>file <span class="nv">permissive</span><span class="o">=</span><span class="m">0</span>
</code></pre></div><p>这个时候如果直接在te里面添加权限：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>allow testA shell_exec:file { read execute };
</code></pre></div><p>添加完之后就会发现违反了neverallow规则</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln">1</span>FAILED: out/target/product/xxxxx/obj/ETC/sepolicy_neverallows_intermediates/sepolicy_neverallows
<span class="ln">2</span>/bin/bash -c <span class="s2">&#34;(rm -f out/target/product/xxxxx/obj/ETC/sepolicy_neverallows_intermediates/sepolicy_neverallows ) &amp;&amp; (ASAN_OPTIONS=detect_leaks=0 out/host/linux-x86/bin/checkpolicy -M -c               30 -o out/target/product/xxxxx/obj/ETC/sepolicy_neverallows_intermediates/sepolicy_neverallows out/target/product/xxxxx/obj/ETC/sepolicy_neverallows_intermediates/policy.conf )&#34;</span>
<span class="ln">3</span>libsepol.report_failure: neverallow on line <span class="m">1047</span> of system/sepolicy/public/domain.te <span class="o">(</span>or line <span class="m">11499</span> of policy.conf<span class="o">)</span> violated by allow testA shell_exec:file <span class="o">{</span> execute <span class="o">}</span><span class="p">;</span>
<span class="ln">4</span>libsepol.check_assertions: <span class="m">1</span> neverallow failures occurred
<span class="ln">5</span>Error <span class="k">while</span> expanding policy
<span class="ln">6</span>out/host/linux-x86/bin/checkpolicy:  loading policy configuration from out/target/product/xxxxx/obj/ETC/sepolicy_neverallows_intermediates/policy.conf
<span class="ln">7</span>ninja: build stopped: subcommand failed.
<span class="ln">8</span>11:42:19 ninja failed with: <span class="nb">exit</span> status <span class="m">1</span>
</code></pre></div><p>原因在domain.te的注释里面说的很清楚了，vendor的组件不允许直接运行system的file</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>full_treble_only<span class="o">(</span><span class="sb">`</span>
<span class="ln">2</span>    <span class="c1"># Do not allow vendor components to execute files from system</span>
<span class="ln">3</span>    <span class="c1"># except for the ones whitelist here.</span>
<span class="ln">4</span>    neverallow <span class="o">{</span>
</code></pre></div><p>修改脚本为：</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span><span class="cp">#!/vendor/bin/sh
</span><span class="ln">2</span><span class="cp"></span> 
<span class="ln">3</span>...
</code></pre></div><p>可以解决上述问题</p>
<p>但是改完之后，有些在/system/bin/ 下的命令就用不了，比如pm、am、logcat这些Android才有的命令，而不是在toybox里面的</p>
<p>如果实在要用，可以这样操作：</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span><span class="cp">#!/vendor/bin/sh
</span><span class="ln">2</span><span class="cp"></span> 
<span class="ln">3</span>am broadcast -a com.test.broadcast.toast -e Message <span class="s2">&#34;hello world&#34;</span> &gt; /dev/picasso
<span class="ln">4</span>
<span class="ln">5</span>直接运行也会报错
<span class="ln">6</span>picasso:/ <span class="c1"># /vendor/bin/testA.sh[3]: am: not found</span>
</code></pre></div><p>可以修改成：</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>/system/bin/cmd activity broadcast -a com.test.broadcast.toast -e Message <span class="s2">&#34;hello world&#34;</span> &gt; /dev/picasso
</code></pre></div><p>te里面要补充关联上属性： vendor_executes_system_violators</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span><span class="nb">type</span> testA, domain, vendor_executes_system_violators<span class="p">;</span>
</code></pre></div><h3 id="412setenforce的可行性">4.1.2setenforce的可行性</h3>
<p>这个肯定是没有办法解决的，如果随便一个脚本都可以拥有关闭SELinux的权限，那还得了</p>
<p>在userdebug和eng版本上，可以先这样debug搞：</p>
<p>添加permissive testA;</p>
<p>对testA type以permissive状态运行</p>
<p>不过只能在eng和userdebug版本下才能用</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span><span class="nb">type</span> testA, coredomain, domain, mlstrustedsubject<span class="p">;</span>
<span class="ln">2</span><span class="nb">type</span> testA_exec, exec_type, file_type<span class="p">;</span>
<span class="ln">3</span> 
<span class="ln">4</span>permissive testA<span class="p">;</span>
<span class="ln">5</span>
<span class="ln">6</span>init_daemon_domain<span class="o">(</span>testA<span class="o">)</span>
</code></pre></div><p>要过CTS，这个权限可是天敌啊，主要就是有些功能想做的事情太多，权限太大，搞得非得要临时关闭SELinux来处理</p>
<p>跟着代码实现，不难发现setenforce命令的操作其实就是写节点/sys/fs/selinux/enforce</p>
<p>结合前面提到的权限检查原理，很快可以发现，这个权限就是我们无法绕过的根本原因了</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="k">static</span> <span class="n">ssize_t</span> <span class="nf">sel_write_enforce</span><span class="p">(</span><span class="k">struct</span> <span class="nc">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
<span class="ln"> 2</span>                 <span class="n">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="ln"> 3</span> 
<span class="ln"> 4</span><span class="p">{</span>
<span class="ln"> 5</span>    <span class="p">......</span>
<span class="ln"> 6</span>        <span class="n">length</span> <span class="o">=</span> <span class="n">task_has_security</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">SECURITY__SETENFORCE</span><span class="p">);</span>
<span class="ln"> 7</span>        <span class="k">if</span> <span class="p">(</span><span class="n">length</span><span class="p">)</span>
<span class="ln"> 8</span>            <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="ln"> 9</span>    <span class="p">......</span>
<span class="ln">10</span><span class="p">}</span>
</code></pre></div><p>这个权限检查就是后面报avc denied的地方了</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>allow testA kernel:security { setenforce };
</code></pre></div><p>对应的neverallow规则如下：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span># Only init prior to switching context should be able to set enforcing mode.
<span class="ln">2</span># init starts in kernel domain and switches to init domain via setcon in
<span class="ln">3</span># the init.rc, so the setenforce occurs while still in kernel. After
<span class="ln">4</span># switching domains, there is never any need to setenforce again by init.
<span class="ln">5</span>neverallow * kernel:security setenforce;
<span class="ln">6</span>neverallow { domain -kernel } kernel:security setcheckreqprot;
</code></pre></div><p>这儿有个不是办法的办法：就是不影响现有命令的基础上，新增了一个节点，然后直接不做权限检查</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln"> 1</span>diff --git a/security/selinux/selinuxfs.c b/security/selinux/selinuxfs.c
<span class="ln"> 2</span>index 72c145dd799f..b2332f55415c <span class="m">100644</span>
<span class="ln"> 3</span>--- a/security/selinux/selinuxfs.c
<span class="ln"> 4</span>+++ b/security/selinux/selinuxfs.c
<span class="ln"> 5</span>@@ -100,6 +100,7 @@ enum sel_inos <span class="o">{</span>
<span class="ln"> 6</span>        <span class="nv">SEL_ROOT_INO</span> <span class="o">=</span> 2,
<span class="ln"> 7</span>        SEL_LOAD,       /* load policy */
<span class="ln"> 8</span>        SEL_ENFORCE,    /* get or <span class="nb">set</span> enforcing status */
<span class="ln"> 9</span>+       SEL_ENABLE,     /* get or <span class="nb">set</span> enforcing status */
<span class="ln">10</span>        SEL_CONTEXT,    /* validate context */
<span class="ln">11</span>        SEL_ACCESS,     /* compute access decision */
<span class="ln">12</span>        SEL_CREATE,     /* compute create labeling decision */
<span class="ln">13</span>@@ -193,6 +194,57 @@ static const struct file_operations <span class="nv">sel_enforce_ops</span> <span class="o">=</span> <span class="o">{</span>
<span class="ln">14</span>        .llseek         <span class="o">=</span> generic_file_llseek,
<span class="ln">15</span> <span class="o">}</span><span class="p">;</span>
<span class="ln">16</span>  
<span class="ln">17</span>+#ifdef CONFIG_SECURITY_SELINUX_DEVELOP
<span class="ln">18</span>+static ssize_t sel_write_enable<span class="o">(</span>struct file *file, const char __user *buf,
<span class="ln">19</span>+                size_t count, loff_t *ppos<span class="o">)</span>
<span class="ln">20</span>+
<span class="ln">21</span>+<span class="o">{</span>
<span class="ln">22</span>+    char *page <span class="o">=</span> NULL<span class="p">;</span>
<span class="ln">23</span>+    ssize_t length<span class="p">;</span>
<span class="ln">24</span>+    int new_value<span class="p">;</span>
<span class="ln">25</span>+
<span class="ln">26</span>+    <span class="k">if</span> <span class="o">(</span>count &gt;<span class="o">=</span> PAGE_SIZE<span class="o">)</span>
<span class="ln">27</span>+        <span class="k">return</span> -ENOMEM<span class="p">;</span>
<span class="ln">28</span>+
<span class="ln">29</span>+    /* No partial writes. */
<span class="ln">30</span>+    <span class="k">if</span> <span class="o">(</span>*ppos !<span class="o">=</span> 0<span class="o">)</span>
<span class="ln">31</span>+        <span class="k">return</span> -EINVAL<span class="p">;</span>
<span class="ln">32</span>+
<span class="ln">33</span>+    <span class="nv">page</span> <span class="o">=</span> memdup_user_nul<span class="o">(</span>buf, count<span class="o">)</span><span class="p">;</span>
<span class="ln">34</span>+    <span class="k">if</span> <span class="o">(</span>IS_ERR<span class="o">(</span>page<span class="o">))</span>
<span class="ln">35</span>+        <span class="k">return</span> PTR_ERR<span class="o">(</span>page<span class="o">)</span><span class="p">;</span>
<span class="ln">36</span>+
<span class="ln">37</span>+    <span class="nv">length</span> <span class="o">=</span> -EINVAL<span class="p">;</span>
<span class="ln">38</span>+    <span class="k">if</span> <span class="o">(</span>sscanf<span class="o">(</span>page, <span class="s2">&#34;%d&#34;</span>, <span class="p">&amp;</span>new_value<span class="o">)</span> !<span class="o">=</span> 1<span class="o">)</span>
<span class="ln">39</span>+        goto out<span class="p">;</span>
<span class="ln">40</span>+
<span class="ln">41</span>+    <span class="k">if</span> <span class="o">(</span>new_value !<span class="o">=</span> selinux_enforcing<span class="o">)</span> <span class="o">{</span>
<span class="ln">42</span>+        audit_log<span class="o">(</span>current-&gt;audit_context, GFP_KERNEL, AUDIT_MAC_STATUS,
<span class="ln">43</span>+            <span class="s2">&#34;enforcing=%d old_enforcing=%d auid=%u ses=%u&#34;</span>,
<span class="ln">44</span>+            new_value, selinux_enforcing,
<span class="ln">45</span>+            from_kuid<span class="o">(</span><span class="p">&amp;</span>init_user_ns, audit_get_loginuid<span class="o">(</span>current<span class="o">))</span>,
<span class="ln">46</span>+            audit_get_sessionid<span class="o">(</span>current<span class="o">))</span><span class="p">;</span>
<span class="ln">47</span>+        <span class="nv">selinux_enforcing</span> <span class="o">=</span> new_value<span class="p">;</span>
<span class="ln">48</span>+        <span class="k">if</span> <span class="o">(</span>selinux_enforcing<span class="o">)</span>
<span class="ln">49</span>+            avc_ss_reset<span class="o">(</span>0<span class="o">)</span><span class="p">;</span>
<span class="ln">50</span>+        selnl_notify_setenforce<span class="o">(</span>selinux_enforcing<span class="o">)</span><span class="p">;</span>
<span class="ln">51</span>+        selinux_status_update_setenforce<span class="o">(</span>selinux_enforcing<span class="o">)</span><span class="p">;</span>
<span class="ln">52</span>+    <span class="o">}</span>
<span class="ln">53</span>+    <span class="nv">length</span> <span class="o">=</span> count<span class="p">;</span>
<span class="ln">54</span>+out:
<span class="ln">55</span>+    kfree<span class="o">(</span>page<span class="o">)</span><span class="p">;</span>
<span class="ln">56</span>+    <span class="k">return</span> length<span class="p">;</span>
<span class="ln">57</span>+<span class="o">}</span>
<span class="ln">58</span>+#else
<span class="ln">59</span>+#define sel_write_enable NULL
<span class="ln">60</span>+#endif
<span class="ln">61</span>+
<span class="ln">62</span>+static const struct file_operations <span class="nv">sel_enable_ops</span> <span class="o">=</span> <span class="o">{</span>
<span class="ln">63</span>+    .read       <span class="o">=</span> sel_read_enforce,
<span class="ln">64</span>+    .write      <span class="o">=</span> sel_write_enable,
<span class="ln">65</span>+    .llseek     <span class="o">=</span> generic_file_llseek,
<span class="ln">66</span>+<span class="o">}</span><span class="p">;</span>
<span class="ln">67</span>+
<span class="ln">68</span> static ssize_t sel_read_handle_unknown<span class="o">(</span>struct file *filp, char __user *buf,
<span class="ln">69</span>                                        size_t count, loff_t *ppos<span class="o">)</span>
<span class="ln">70</span> <span class="o">{</span>
<span class="ln">71</span>@@ -1790,6 +1842,7 @@ static int sel_fill_super<span class="o">(</span>struct super_block *sb, void *data, int silent<span class="o">)</span>
<span class="ln">72</span>        static struct tree_descr selinux_files<span class="o">[]</span> <span class="o">=</span> <span class="o">{</span>
<span class="ln">73</span>                <span class="o">[</span>SEL_LOAD<span class="o">]</span> <span class="o">=</span> <span class="o">{</span><span class="s2">&#34;load&#34;</span>, <span class="p">&amp;</span>sel_load_ops, S_IRUSR<span class="p">|</span>S_IWUSR<span class="o">}</span>,
<span class="ln">74</span>                <span class="o">[</span>SEL_ENFORCE<span class="o">]</span> <span class="o">=</span> <span class="o">{</span><span class="s2">&#34;enforce&#34;</span>, <span class="p">&amp;</span>sel_enforce_ops, S_IRUGO<span class="p">|</span>S_IWUSR<span class="o">}</span>,
<span class="ln">75</span>+               <span class="o">[</span>SEL_ENABLE<span class="o">]</span> <span class="o">=</span> <span class="o">{</span><span class="s2">&#34;enable&#34;</span>, <span class="p">&amp;</span>sel_enable_ops, S_IRUGO<span class="p">|</span>S_IWUSR<span class="o">}</span>,
<span class="ln">76</span>                <span class="o">[</span>SEL_CONTEXT<span class="o">]</span> <span class="o">=</span> <span class="o">{</span><span class="s2">&#34;context&#34;</span>, <span class="p">&amp;</span>transaction_ops, S_IRUGO<span class="p">|</span>S_IWUGO<span class="o">}</span>,
<span class="ln">77</span>                <span class="o">[</span>SEL_ACCESS<span class="o">]</span> <span class="o">=</span> <span class="o">{</span><span class="s2">&#34;access&#34;</span>, <span class="p">&amp;</span>transaction_ops, S_IRUGO<span class="p">|</span>S_IWUGO<span class="o">}</span>,
<span class="ln">78</span>                <span class="o">[</span>SEL_CREATE<span class="o">]</span> <span class="o">=</span> <span class="o">{</span><span class="s2">&#34;create&#34;</span>, <span class="p">&amp;</span>transaction_ops, S_IRUGO<span class="p">|</span>S_IWUGO<span class="o">}</span>,
</code></pre></div><p>然后开关就用：</p>
<p>关SELinux</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span><span class="nb">echo</span> <span class="m">0</span> &gt; /sys/fs/selinux/enable
</code></pre></div><p>开SELinux</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span><span class="nb">echo</span> <span class="m">1</span> &gt; /sys/fs/selinux/enable
</code></pre></div><p>权限还得补一下：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>allow testA selinuxfs:file rw_file_perms;
<span class="ln">2</span>selinux_check_access(testA)
</code></pre></div><p>相比setenforce，差异就是去掉了权限检查，开了一个后门，比较bug的存在</p>
<h3 id="413dac_override-解决办法">4.1.3dac_override 解决办法</h3>
<p>谷歌官方文档的一段话总结的很精辟</p>
<blockquote>
<p><strong>授予dac_override权能</strong></p>
<p><code>dac-override</code>拒绝事件意味着违规进程正在尝试使用错误的unix user/group/world权限访问某个文件。正确的解决方案几乎从不授予<code>dac-override</code>权限，而是更改相应文件或进程的unix权限。有些网域（例如<code>init</code>、<code>vold</code>和<code>installd</code>)确实需要能够蓄换unix文件权限才能访问其他进程的文件。如需查看更深入的讲解，请访问Dan Walsh的博客。</p>
</blockquote>
<p>关于解决selinux dac_override/dac_read_search问题，有一个固定思路，可以点击<a href="https://blog.csdn.net/Donald_Zhuang/article/details/108786482">这里</a></p>
<p>比如修改group的：</p>
<p>未修改前：</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>service testA /system/bin/testA.sh -start
<span class="ln">2</span>    user root
<span class="ln">3</span>    group root
<span class="ln">4</span>    disabled
<span class="ln">5</span>    oneshot
<span class="ln">6</span>    seclabel u:r:testA:s0
</code></pre></div><p>修改后：</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>service testA /system/bin/testA.sh -start
<span class="ln">2</span>    user root
<span class="ln">3</span>    group root system
<span class="ln">4</span>    disabled
<span class="ln">5</span>    oneshot
<span class="ln">6</span>    seclabel u:r:testA:s0
</code></pre></div><p>大部分情况下，我们可以直接ls -l 查看要访问的文件或者目录的user 和 group</p>
<p>但是有些情况下，我们很难搞清楚访问的文件或者目录所在的group是哪个，这些信息在avc denied里面是不会有的</p>
<p>可以在kernel中补充这些代码，打印出来</p>
<p>patch:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln"> 1</span>kernelcode$ git diff .
<span class="ln"> 2</span>diff --git a/fs/namei.c b/fs/namei.c
<span class="ln"> 3</span>index a5a05d3..9b8f0da <span class="m">100644</span>
<span class="ln"> 4</span>--- a/fs/namei.c
<span class="ln"> 5</span>+++ b/fs/namei.c
<span class="ln"> 6</span>@@ -39,6 +39,8 @@
<span class="ln"> 7</span> <span class="c1">#include &lt;linux/init_task.h&gt;</span>
<span class="ln"> 8</span> <span class="c1">#include &lt;asm/uaccess.h&gt;</span>
<span class="ln"> 9</span>  
<span class="ln">10</span>+#include &lt;linux/printk.h&gt;
<span class="ln">11</span>+
<span class="ln">12</span> <span class="c1">#include &#34;internal.h&#34;</span>
<span class="ln">13</span> <span class="c1">#include &#34;mount.h&#34;</span>
<span class="ln">14</span>  
<span class="ln">15</span>@@ -341,8 +343,12 @@ int generic_permission<span class="o">(</span>struct inode *inode, int mask<span class="o">)</span>
<span class="ln">16</span>  
<span class="ln">17</span>        <span class="k">if</span> <span class="o">(</span>S_ISDIR<span class="o">(</span>inode-&gt;i_mode<span class="o">))</span> <span class="o">{</span>
<span class="ln">18</span>                /* DACs are overridable <span class="k">for</span> directories */
<span class="ln">19</span>-               <span class="k">if</span> <span class="o">(</span>capable_wrt_inode_uidgid<span class="o">(</span>inode, CAP_DAC_OVERRIDE<span class="o">))</span>
<span class="ln">20</span>-                       <span class="k">return</span> 0<span class="p">;</span>
<span class="ln">21</span>+        <span class="k">if</span> <span class="o">(</span>capable_wrt_inode_uidgid<span class="o">(</span>inode, CAP_DAC_OVERRIDE<span class="o">))</span> <span class="o">{</span>
<span class="ln">22</span>+            <span class="k">return</span> 0<span class="p">;</span>
<span class="ln">23</span>+        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="ln">24</span>+            pr_err<span class="o">(</span><span class="s2">&#34;dac_override(dir) denied for cap=%3o inode=%lu with uid=%u gid=%u\n&#34;</span>,
<span class="ln">25</span>+                mask<span class="p">&amp;</span>0777, inode-&gt;i_ino, inode-&gt;i_uid.val, inode-&gt;i_gid.val<span class="o">)</span><span class="p">;</span>
<span class="ln">26</span>+        <span class="o">}</span>
<span class="ln">27</span>                <span class="k">if</span> <span class="o">(</span>!<span class="o">(</span>mask <span class="p">&amp;</span> MAY_WRITE<span class="o">))</span>
<span class="ln">28</span>                        <span class="k">if</span> <span class="o">(</span>capable_wrt_inode_uidgid<span class="o">(</span>inode,
<span class="ln">29</span>                                                     CAP_DAC_READ_SEARCH<span class="o">))</span>
<span class="ln">30</span>@@ -354,9 +360,17 @@ int generic_permission<span class="o">(</span>struct inode *inode, int mask<span class="o">)</span>
<span class="ln">31</span>         * Executable DACs are overridable when there is
<span class="ln">32</span>         * at least one <span class="nb">exec</span> bit set.
<span class="ln">33</span>         */
<span class="ln">34</span>-       <span class="k">if</span> <span class="o">(</span>!<span class="o">(</span>mask <span class="p">&amp;</span> MAY_EXEC<span class="o">)</span> <span class="o">||</span> <span class="o">(</span>inode-&gt;i_mode <span class="p">&amp;</span> S_IXUGO<span class="o">))</span>
<span class="ln">35</span>-               <span class="k">if</span> <span class="o">(</span>capable_wrt_inode_uidgid<span class="o">(</span>inode, CAP_DAC_OVERRIDE<span class="o">))</span>
<span class="ln">36</span>-                       <span class="k">return</span> 0<span class="p">;</span>
<span class="ln">37</span>+       // <span class="k">if</span> <span class="o">(</span>!<span class="o">(</span>mask <span class="p">&amp;</span> MAY_EXEC<span class="o">)</span> <span class="o">||</span> <span class="o">(</span>inode-&gt;i_mode <span class="p">&amp;</span> S_IXUGO<span class="o">))</span>
<span class="ln">38</span>+       //      <span class="k">if</span> <span class="o">(</span>capable_wrt_inode_uidgid<span class="o">(</span>inode, CAP_DAC_OVERRIDE<span class="o">))</span>
<span class="ln">39</span>+    /* <span class="nv">IXUGO</span> <span class="o">=</span> <span class="o">(</span>S_IXUSR<span class="p">|</span>S_IXGRP<span class="p">|</span>S_IXOTH<span class="o">)</span> */
<span class="ln">40</span>+    <span class="k">if</span> <span class="o">(</span>!<span class="o">(</span>mask <span class="p">&amp;</span> MAY_EXEC<span class="o">)</span> <span class="o">||</span> <span class="o">(</span>inode-&gt;i_mode <span class="p">&amp;</span> S_IXUGO<span class="o">))</span> <span class="o">{</span>
<span class="ln">41</span>+        <span class="k">if</span> <span class="o">(</span>capable_wrt_inode_uidgid<span class="o">(</span>inode, CAP_DAC_OVERRIDE<span class="o">))</span> <span class="o">{</span>
<span class="ln">42</span>+            <span class="k">return</span> 0<span class="p">;</span>
<span class="ln">43</span>+        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="ln">44</span>+            pr_err<span class="o">(</span><span class="s2">&#34;dac_override(file) denied for cap=%3o inode=%lu with uid=%u gid=%u\n&#34;</span>,
<span class="ln">45</span>+                mask<span class="p">&amp;</span>0777, inode-&gt;i_ino, inode-&gt;i_uid.val, inode-&gt;i_gid.val<span class="o">)</span><span class="p">;</span>
<span class="ln">46</span>+        <span class="o">}</span>
<span class="ln">47</span>+    <span class="o">}</span>
<span class="ln">48</span>  
<span class="ln">49</span>
<span class="ln">50</span>diff --git a/security/selinux/avc.c b/security/selinux/avc.c
<span class="ln">51</span>index e60c79d..9b1dfad <span class="m">100644</span>
<span class="ln">52</span>--- a/security/selinux/avc.c
<span class="ln">53</span>+++ b/security/selinux/avc.c
<span class="ln">54</span>@@ -734,7 +734,11 @@ static void avc_audit_post_callback<span class="o">(</span>struct audit_buffer *ab, void *a<span class="o">)</span>
<span class="ln">55</span>        <span class="k">if</span> <span class="o">(</span>ad-&gt;selinux_audit_data-&gt;denied<span class="o">)</span> <span class="o">{</span>
<span class="ln">56</span>                audit_log_format<span class="o">(</span>ab, <span class="s2">&#34; permissive=%u&#34;</span>,
<span class="ln">57</span>                                 ad-&gt;selinux_audit_data-&gt;result ? <span class="m">0</span> : 1<span class="o">)</span><span class="p">;</span>
<span class="ln">58</span>-       <span class="o">}</span>
<span class="ln">59</span>+        <span class="k">if</span> <span class="o">(</span>ad-&gt;u.cap <span class="o">==</span> 1<span class="o">)</span> <span class="o">{</span>
<span class="ln">60</span>+            audit_log_format<span class="o">(</span>ab, <span class="s2">&#34; cap=dac_override, dumping stack&#34;</span><span class="o">)</span><span class="p">;</span>
<span class="ln">61</span>+            WARN_ON<span class="o">(</span>ad-&gt;u.cap <span class="o">==</span> 1<span class="o">)</span><span class="p">;</span>
<span class="ln">62</span>+        <span class="o">}</span>
<span class="ln">63</span>+    <span class="o">}</span>
<span class="ln">64</span> <span class="o">}</span>
<span class="ln">65</span>  
<span class="ln">66</span> /* This is the slow part of avc audit with big stack footprint */
</code></pre></div><p>打印信息如下：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln"> 1</span><span class="o">[</span>   44.952920@0<span class="o">]</span>- ------------<span class="o">[</span> cut here <span class="o">]</span>------------
<span class="ln"> 2</span><span class="o">[</span>   44.952983@0<span class="o">]</span>- WARNING: CPU: <span class="m">0</span> PID: <span class="m">3901</span> at :739 avc_audit_post_callback+0x180/0x184
<span class="ln"> 3</span><span class="o">[</span>   44.961323@0<span class="o">]</span>- Modules linked in: hardware_dmx<span class="o">(</span>O<span class="o">)</span> jpegenc<span class="o">(</span>O<span class="o">)</span> amvdec_av1<span class="o">(</span>O<span class="o">)</span> amvdec_mavs<span class="o">(</span>O<span class="o">)</span> encoder<span class="o">(</span>O<span class="o">)</span> amvdec_avs2<span class="o">(</span>O<span class="o">)</span> amvdec_vp9<span class="o">(</span>O<span class="o">)</span> amvdec_vc1<span class="o">(</span>O<span class="o">)</span> amvdec_real<span class="o">(</span>O<span class="o">)</span> amvdec_mmpeg4<span class="o">(</span>O<span class="o">)</span> amvdec_mpeg4<span class="o">(</span>O<span class="o">)</span> amvdec_mmpeg12<span class="o">(</span>O<span class="o">)</span> amvdec_mpeg12<span class="o">(</span>O<span class="o">)</span> amvdec_mmjpeg<span class="o">(</span>O<span class="o">)</span> amvdec_mjpeg<span class="o">(</span>O<span class="o">)</span> amvdec_h265<span class="o">(</span>O<span class="o">)</span> amvdec_h264mvc<span class="o">(</span>O<span class="o">)</span> amvdec_mh264<span class="o">(</span>O<span class="o">)</span> amvdec_h264<span class="o">(</span>O<span class="o">)</span> amvdec_avs<span class="o">(</span>O<span class="o">)</span> stream_input<span class="o">(</span>O<span class="o">)</span> decoder_common<span class="o">(</span>O<span class="o">)</span> video_framerate_adapter<span class="o">(</span>O<span class="o">)</span> firmware<span class="o">(</span>O<span class="o">)</span> media_clock<span class="o">(</span>O<span class="o">)</span> tb_detect<span class="o">(</span>PO<span class="o">)</span> mali<span class="o">(</span>O<span class="o">)</span> dnlp_alg<span class="o">(</span>P<span class="o">)</span>
<span class="ln"> 4</span><span class="o">[</span>   45.000226@0<span class="o">]</span>d CPU: <span class="m">0</span> PID: <span class="m">3901</span> Comm: cmd Tainted: P        W  O    4.9.113 <span class="c1">#20</span>
<span class="ln"> 5</span><span class="o">[</span>   45.007459@0<span class="o">]</span>d Hardware name: Generic DT based system
<span class="ln"> 6</span><span class="o">[</span>   45.012491@0<span class="o">]</span>d <span class="o">[</span>bc4afac4+  16<span class="o">][</span>&lt;c020dc10&gt;<span class="o">]</span> show_stack+0x20/0x24
<span class="ln"> 7</span><span class="o">[</span>   45.018343@0<span class="o">]</span>d <span class="o">[</span>bc4afae4+  32<span class="o">][</span>&lt;c054394c&gt;<span class="o">]</span> dump_stack+0x90/0xac
<span class="ln"> 8</span><span class="o">[</span>   45.024201@0<span class="o">]</span>d <span class="o">[</span>bc4afb14+  48<span class="o">][</span>&lt;c0228724&gt;<span class="o">]</span> __warn+0x104/0x11c
<span class="ln"> 9</span><span class="o">[</span>   45.029897@0<span class="o">]</span>d <span class="o">[</span>bc4afb2c+  24<span class="o">][</span>&lt;c022880c&gt;<span class="o">]</span> warn_slowpath_null+0x30/0x38
<span class="ln">10</span><span class="o">[</span>   45.036456@0<span class="o">]</span>d <span class="o">[</span>bc4afb5c+  48<span class="o">][</span>&lt;c04d4fec&gt;<span class="o">]</span> avc_audit_post_callback+0x180/0x184
<span class="ln">11</span><span class="o">[</span>   45.043606@0<span class="o">]</span>d <span class="o">[</span>bc4afbb4+  88<span class="o">][</span>&lt;c04f20e0&gt;<span class="o">]</span> common_lsm_audit+0x260/0x7c0
<span class="ln">12</span><span class="o">[</span>   45.050165@0<span class="o">]</span>d <span class="o">[</span>bc4afbfc+  72<span class="o">][</span>&lt;c04d5994&gt;<span class="o">]</span> slow_avc_audit+0x9c/0xb0
<span class="ln">13</span><span class="o">[</span>   45.056376@0<span class="o">]</span>d <span class="o">[</span>bc4afc64+ 104<span class="o">][</span>&lt;c04da364&gt;<span class="o">]</span> cred_has_capability+0x118/0x124
<span class="ln">14</span><span class="o">[</span>   45.063184@0<span class="o">]</span>d <span class="o">[</span>bc4afc74+  16<span class="o">][</span>&lt;c04da3f0&gt;<span class="o">]</span> selinux_capable+0x38/0x3c
<span class="ln">15</span><span class="o">[</span>   45.069483@0<span class="o">]</span>d <span class="o">[</span>bc4afc9c+  40<span class="o">][</span>&lt;c04d1370&gt;<span class="o">]</span> security_capable+0x4c/0x68
<span class="ln">16</span><span class="o">[</span>   45.075870@0<span class="o">]</span>d <span class="o">[</span>bc4afcac+  16<span class="o">][</span>&lt;c0233d58&gt;<span class="o">]</span> ns_capable_common+0x7c/0x90
<span class="ln">17</span><span class="o">[</span>   45.082336@0<span class="o">]</span>d <span class="o">[</span>bc4afcc4+  24<span class="o">][</span>&lt;c0233e00&gt;<span class="o">]</span> capable_wrt_inode_uidgid+0x28/0x54
<span class="ln">18</span><span class="o">[</span>   45.089409@0<span class="o">]</span>d <span class="o">[</span>bc4afcf4+  48<span class="o">][</span>&lt;c03a5abc&gt;<span class="o">]</span> generic_permission+0x100/0x208
<span class="ln">19</span><span class="o">[</span>   45.096138@0<span class="o">]</span>d <span class="o">[</span>bc4afd14+  32<span class="o">][</span>&lt;c0414df0&gt;<span class="o">]</span> kernfs_iop_permission+0x58/0x64
<span class="ln">20</span><span class="o">[</span>   45.102951@0<span class="o">]</span>d <span class="o">[</span>bc4afd34+  32<span class="o">][</span>&lt;c03a5c84&gt;<span class="o">]</span> __inode_permission2+0xc0/0xf0
<span class="ln">21</span><span class="o">[</span>   45.109589@0<span class="o">]</span>d <span class="o">[</span>bc4afd44+  16<span class="o">][</span>&lt;c03a5cfc&gt;<span class="o">]</span> inode_permission2+0x20/0x54
<span class="ln">22</span><span class="o">[</span>   45.116057@0<span class="o">]</span>d <span class="o">[</span>bc4afd8c+  72<span class="o">][</span>&lt;c0396fb4&gt;<span class="o">]</span> SyS_faccessat+0xec/0x220
<span class="ln">23</span><span class="o">[</span>   45.122273@0<span class="o">]</span>d <span class="o">[</span>00000000+   0<span class="o">][</span>&lt;c02085c0&gt;<span class="o">]</span> ret_fast_syscall+0x0/0x48
<span class="ln">24</span><span class="o">[</span>   45.128879@0<span class="o">]</span>s DI: DI: tasklet schedule cost 128ms.
<span class="ln">25</span><span class="o">[</span>   45.133835@0<span class="o">]</span>- ---<span class="o">[</span> end trace 40474d395a0d6c86 <span class="o">]</span>---
<span class="ln">26</span><span class="o">[</span>   45.138462@0<span class="o">]</span>- dac_override<span class="o">(</span>file<span class="o">)</span> denied <span class="k">for</span> <span class="nv">cap</span><span class="o">=</span> <span class="m">22</span> <span class="nv">inode</span><span class="o">=</span><span class="m">5</span> with <span class="nv">uid</span><span class="o">=</span><span class="m">1000</span> <span class="nv">gid</span><span class="o">=</span><span class="m">1000</span>
<span class="ln">27</span><span class="o">[</span>   45.138640@1<span class="o">]</span>- <span class="nv">type</span><span class="o">=</span><span class="m">1400</span> audit<span class="o">(</span>1620051338.180:75<span class="o">)</span>: avc: denied <span class="o">{</span> dac_override <span class="o">}</span> <span class="k">for</span> <span class="nv">pid</span><span class="o">=</span><span class="m">3900</span> <span class="nv">comm</span><span class="o">=</span><span class="s2">&#34;cmd&#34;</span> <span class="nv">capability</span><span class="o">=</span><span class="m">1</span> <span class="nv">scontext</span><span class="o">=</span>u:r:testA:s0 <span class="nv">tcontext</span><span class="o">=</span>u:r:testA:s0 <span class="nv">tclass</span><span class="o">=</span>capability <span class="nv">permissive</span><span class="o">=</span><span class="m">0</span> <span class="nv">cap</span><span class="o">=</span>dac_override, dumping stack
</code></pre></div><p>打印的gid在 system/core/include/private/android_filesystem_config.h 里面查找，就知道init.rc里面要加什么了</p>
<h3 id="414echo打印到终端">4.1.4echo打印到终端</h3>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln">1</span><span class="c1">#echo &#34;test&#34; &gt; /dev/picasso</span>
<span class="ln">2</span>allow testA picasso_device:chr_file rw_file_perms<span class="p">;</span>
</code></pre></div><h3 id="415读写u盘内容">4.1.5读写U盘内容</h3>
<p>读U盘：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>allow testA mnt_media_rw_file:dir { search read open };
<span class="ln">2</span>allow testA vfat:file r_file_perms;
<span class="ln">3</span>allow testA vfat:dir r_dir_perms;
</code></pre></div><p>要写和创建的话，权限给大一点就行了：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>allow testA mnt_media_rw_file:dir { search read open };
<span class="ln">2</span>allow testA vfat:dir create_dir_perms;
<span class="ln">3</span>allow testA vfat:file create_file_perms;
</code></pre></div><h3 id="416am-命令">4.1.6am 命令</h3>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>allow testA activity_service:service_manager { find };
<span class="ln">2</span>allow testA system_server:binder { call transfer };
<span class="ln">3</span>binder_use(testA)
<span class="ln">4</span>binder_call(system_server, testA)
</code></pre></div><p>pm命令同理</p>
<h3 id="417ioctl">4.1.7ioctl</h3>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln">1</span><span class="p">[</span>   <span class="mf">57.670632</span><span class="p">]</span> <span class="n">type</span><span class="o">=</span><span class="mi">1400</span> <span class="n">audit</span><span class="p">(</span><span class="mf">1623998437.166</span><span class="o">:</span><span class="mi">9</span><span class="p">)</span><span class="o">:</span> <span class="nl">avc</span><span class="p">:</span> <span class="n">denied</span> <span class="p">{</span> <span class="n">ioctl</span> <span class="p">}</span> <span class="k">for</span> <span class="n">pid</span><span class="o">=</span><span class="mi">4285</span> <span class="n">comm</span><span class="o">=</span><span class="s">&#34;Thread-43&#34;</span> <span class="n">path</span><span class="o">=</span><span class="s">&#34;socket:[30690]&#34;</span> <span class="n">dev</span><span class="o">=</span><span class="s">&#34;sockfs&#34;</span> <span class="n">ino</span><span class="o">=</span><span class="mi">30690</span> <span class="n">ioctlcmd</span><span class="o">=</span><span class="mh">0x8927</span> <span class="n">scontext</span><span class="o">=</span><span class="nl">u</span><span class="p">:</span><span class="nl">r</span><span class="p">:</span><span class="nl">untrusted_app_25</span><span class="p">:</span><span class="nl">s0</span><span class="p">:</span><span class="n">c512</span><span class="p">,</span><span class="n">c768</span> <span class="n">tcontext</span><span class="o">=</span><span class="nl">u</span><span class="p">:</span><span class="nl">r</span><span class="p">:</span><span class="nl">untrusted_app_25</span><span class="p">:</span><span class="nl">s0</span><span class="p">:</span><span class="n">c512</span><span class="p">,</span><span class="n">c768</span> <span class="n">tclass</span><span class="o">=</span><span class="n">tcp_socket</span> <span class="n">permissive</span><span class="o">=</span><span class="mi">0</span>
</code></pre></div><p>ioctl有少许不一样，Andrid o之后有所变化</p>
<blockquote>
<p><code>ioctl</code></p>
<p>Google在Android Q上增强了对ioctl的审查，除保持对ioctl的审查/授权之外，对具体的ioctlcmd也需要进一步地审查/授权。具体可以点击<a href="https://www.cnblogs.com/fanglongxiang/p/13306088.html">这里</a>解决方案。</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln">1</span><span class="c1">//kernel/security/selinux/hooks.c
</span><span class="ln">2</span><span class="c1"></span><span class="p">...</span>
<span class="ln">3</span><span class="n">error</span> <span class="o">=</span> <span class="n">ioctl_has_perm</span><span class="p">(</span><span class="n">cred</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">FILE__IOCTL</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">cmd</span><span class="p">);</span>
</code></pre></div><p>对于这样的一条avc log：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln">1</span>avc: denied <span class="o">{</span> ioctl <span class="o">}</span> <span class="k">for</span> <span class="nv">comm</span><span class="o">=</span><span class="s2">&#34;BootAnimation&#34;</span> <span class="nv">path</span><span class="o">=</span><span class="s2">&#34;/proc/ged&#34;</span> <span class="nv">dev</span><span class="o">=</span><span class="s2">&#34;proc&#34;</span> <span class="nv">ino</span><span class="o">=</span><span class="m">4026532249</span> <span class="nv">ioctlcmd</span><span class="o">=</span>0x6700 <span class="nv">scontext</span><span class="o">=</span>u:r:bootanim:s0 <span class="nv">tcontext</span><span class="o">=</span>u:object_r:proc_ged:s0 <span class="nv">tclass</span><span class="o">=</span>file <span class="nv">permissive</span><span class="o">=</span><span class="m">0</span>
</code></pre></div><p><strong>在Android Q上，则需要：</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>allow bootanim proc_ged:file ioctl;            
<span class="ln">2</span>allowxperm bootanim proc_ged:file ioctl 0x6700;
</code></pre></div><p>0x6700 即log中的ioctlcmd。</p>
<p><strong>0x6700这个值一般在sepolicy目录下的ioctl_defines文件中配置。所以在Q上，上述log最终</strong>：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>ioctl_defines#
<span class="ln">2</span>define(`GED_BRIDGE_IO_LOG_BUF_GET&#39;, `0x6700&#39;)
<span class="ln">3</span> 
<span class="ln">4</span>bootanim.te#
<span class="ln">5</span>allow bootanim proc_ged:file ioctl;
<span class="ln">6</span>allowxperm bootanim proc_ged:file ioctl GED_BRIDGE_IO_LOG_BUF_GET;
</code></pre></div></blockquote>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>allow untrusted_app_25 self:udp_socket ioctl;
<span class="ln">2</span>allowxperm untrusted_app_25 self:udp_socket ioctl SIOCGIFHWADDR;
<span class="ln">3</span>
<span class="ln">4</span>两句都要添加上，缺一不可
</code></pre></div><h2 id="42常见违反neverallow规则的解决方案">4.2常见违反neverallow规则的解决方案</h2>
<h3 id="421指定文件属性服务的安全上下文避免权限放大">4.2.1指定文件、属性、服务的安全上下文，避免权限放大</h3>
<p>这一类neverallow规则，其实搞明白为什么要这么做，是很容易解决的</p>
<p>有一个系统属性<code>persist.sys.test</code></p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln">1</span>picasso:/data <span class="c1"># getprop -Z persist.sys.test</span>
<span class="ln">2</span>u:object_r:system_prop:s0
</code></pre></div><p>假如你想要设置这个属性，加了一个权限</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>set_prop(testA, system_prop)
</code></pre></div><p>结果一编译就违反neverallow规则了，这是为什么？</p>
<p>因为没有特别指定，<code>persist.sys.</code>开头的属性，它的安全上下问题都是<code>u:object_r:system_prop:s0</code></p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>//android/system/sepolicy/private/property_contexts
<span class="ln">2</span> 
<span class="ln">3</span>persist.sys.            u:object_r:system_prop:s0
</code></pre></div><p>一旦你给了这个权限，意味着你可以设置的属性不仅仅是persist.sys.test了，还可以是persist.sys.A、persist.sys.B 等等</p>
<p>这就是权限放大，neverallow规则的限定，就是为了不给你这么玩</p>
<p>我们要做的就是，指定文件、属性、服务的安全上下文，收缩权限</p>
<p>下面有一些例子：</p>
<h4 id="4211testneverallowrules131-解决方案">4.2.1.1testNeverallowRules131 解决方案</h4>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln"> 1</span>&lt;Test <span class="nv">result</span><span class="o">=</span><span class="s2">&#34;fail&#34;</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;testNeverallowRules131&#34;</span>&gt;
<span class="ln"> 2</span>        &lt;Failure <span class="nv">message</span><span class="o">=</span><span class="s2">&#34;junit.framework.AssertionFailedError: The following errors were encountered when validating the SELinuxneverallow rule:&#34;</span>&gt;
<span class="ln"> 3</span>          &lt;StackTrace&gt;junit.framework.AssertionFailedError: The following errors were encountered when validating the SELinuxneverallow rule:
<span class="ln"> 4</span>neverallow <span class="o">{</span> domain -kernel -init -recovery <span class="o">}</span> block_device:blk_file <span class="o">{</span> open <span class="nb">read</span> write <span class="o">}</span><span class="p">;</span>
<span class="ln"> 5</span>libsepol.report_failure: neverallow violated by allow testA block_device:blk_file <span class="o">{</span> <span class="nb">read</span> write open <span class="o">}</span><span class="p">;</span>
<span class="ln"> 6</span>libsepol.check_assertions: <span class="m">1</span> neverallow failures occurred
<span class="ln"> 7</span> 
<span class="ln"> 8</span>&lt;/StackTrace&gt;
<span class="ln"> 9</span>        &lt;/Failure&gt;
<span class="ln">10</span>      &lt;/Test&gt;
</code></pre></div><p>testA是因为要操作 <code>/dev/block/testblock</code></p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln">1</span>picasso:/ <span class="c1"># ls -lZ /dev/block/testblock</span>
<span class="ln">2</span>brw------- <span class="m">1</span> root root u:object_r:block_device:s0 179,   <span class="m">5</span> 1970-01-01 08:00 /dev/block/testblock
</code></pre></div><p>给这个testblock block指定type，不然就会有权限放大的问题</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>//sepolicy/device.te
<span class="ln">2</span>type testblock_device, dev_type;
<span class="ln">3</span> 
<span class="ln">4</span>sepolicy/file_contexts
<span class="ln">5</span>/dev/block/testblock                 u:object_r:testblock_device:s0
</code></pre></div><p>接着allow语句修改为：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>allow testA testblock_device:blk_file { read write open };
</code></pre></div><h4 id="4212testneverallowrules198-解决方案">4.2.1.2testNeverallowRules198 解决方案</h4>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln"> 1</span>&lt;Test <span class="nv">result</span><span class="o">=</span><span class="s2">&#34;fail&#34;</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;testNeverallowRules198&#34;</span>&gt;
<span class="ln"> 2</span>        &lt;Failure <span class="nv">message</span><span class="o">=</span><span class="s2">&#34;junit.framework.AssertionFailedError: The following errors were encountered when validating the SELinuxneverallow rule:&#34;</span>&gt;
<span class="ln"> 3</span>          &lt;StackTrace&gt;junit.framework.AssertionFailedError: The following errors were encountered when validating the SELinuxneverallow rule:
<span class="ln"> 4</span>neverallow <span class="o">{</span>      domain      -coredomain      -appdomain       -data_between_core_and_vendor_violators       -socket_between_core_and_vendor_violators      -vendor_init    <span class="o">}</span> <span class="o">{</span>      coredomain_socket      core_data_file_type      unlabeled     <span class="o">}</span>:sock_file ~<span class="o">{</span> append getattr ioctl <span class="nb">read</span> write <span class="o">}</span><span class="p">;</span>
<span class="ln"> 5</span>libsepol.report_failure: neverallow violated by allow testA property_socket:sock_file <span class="o">{</span> open <span class="o">}</span><span class="p">;</span>
<span class="ln"> 6</span>libsepol.check_assertions: <span class="m">1</span> neverallow failures occurred
<span class="ln"> 7</span> 
<span class="ln"> 8</span>&lt;/StackTrace&gt;
<span class="ln"> 9</span>        &lt;/Failure&gt;
<span class="ln">10</span>      &lt;/Test&gt;
</code></pre></div><p>查脚本，看设置的是哪个属性，然后把这个属性的安全上下文指定到我们自定义的上面去</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>//sepolicy/property_contexts
<span class="ln">2</span>sys.testA.finish            u:object_r:test_prop:s0
<span class="ln">3</span> 
<span class="ln">4</span>sepolicy/testA.te
<span class="ln">5</span>set_prop(testA, test_prop)
</code></pre></div><h4 id="4213testneverallowrules154-解决方案">4.2.1.3testNeverallowRules154 解决方案</h4>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln"> 1</span>&lt;Test <span class="nv">result</span><span class="o">=</span><span class="s2">&#34;fail&#34;</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;testNeverallowRules154&#34;</span>&gt;
<span class="ln"> 2</span>        &lt;Failure <span class="nv">message</span><span class="o">=</span><span class="s2">&#34;junit.framework.AssertionFailedError: The following errors were encountered when validating the SELinuxneverallow rule:&#34;</span>&gt;
<span class="ln"> 3</span>          &lt;StackTrace&gt;junit.framework.AssertionFailedError: The following errors were encountered when validating the SELinuxneverallow rule:
<span class="ln"> 4</span>neverallow * default_android_service:service_manager add<span class="p">;</span>
<span class="ln"> 5</span>libsepol.report_failure: neverallow violated by allow testA default_android_service:service_manager <span class="o">{</span> add <span class="o">}</span><span class="p">;</span>
<span class="ln"> 6</span>libsepol.check_assertions: <span class="m">1</span> neverallow failures occurred
<span class="ln"> 7</span> 
<span class="ln"> 8</span>&lt;/StackTrace&gt;
<span class="ln"> 9</span>        &lt;/Failure&gt;
<span class="ln">10</span>      &lt;/Test&gt;
</code></pre></div><p>首先这个违反的neverallow规则如下，禁止所有的进程添加default_android_service类型的service_manager</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>neverallow * default_android_service:service_manager add;
</code></pre></div><p>先看看之前的解决方案：</p>
<p>sepolicy/service_contexts</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>添加
<span class="ln">2</span>test.service                               u:object_r:test_service:s0
</code></pre></div><p>service.te：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>添加
<span class="ln">2</span>type test_service,    app_api_service, system_server_service, service_manager_type;
</code></pre></div><p>testA.te 里面如下：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>allow testA default_android_service:service_manager { add  };
</code></pre></div><p>然后再把neverallow规则干掉，神挡杀神，佛挡杀佛</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>neverallow { domain -testA } default_android_service:service_manager add;
</code></pre></div><p>看到这里，比较疑惑的点是service_contexts和service.te，和普通文件一样，service也是可以给它定义一个新的type</p>
<p>但是定义了这个test_service type之后，没有生效？</p>
<p>从报错的信息来看，test.service的type依然还是default_android_service，这是为何？</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln">1</span>06-10 08:50:30.172  <span class="m">3062</span>  <span class="m">3062</span> E SELinux : avc:  denied  <span class="o">{</span> add <span class="o">}</span> <span class="k">for</span> <span class="nv">service</span><span class="o">=</span>test.service <span class="nv">pid</span><span class="o">=</span><span class="m">4707</span> <span class="nv">uid</span><span class="o">=</span><span class="m">0</span> <span class="nv">scontext</span><span class="o">=</span>u:r:testA:s0 <span class="nv">tcontext</span><span class="o">=</span>u:object_r:default_android_service:s0 <span class="nv">tclass</span><span class="o">=</span>service_manager <span class="nv">permissive</span><span class="o">=</span><span class="m">0</span>
</code></pre></div><p>这时，我们查看 /system/etc/selinux/plat_service_contexts 里面的内容，发现我们添加的test.service 压根就不在里面，难怪不会生效</p>
<p>在板卡上直接修改添加，重启之后，就会发现报错已经变成了这样了：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln">1</span>06-10 08:55:15.748  <span class="m">3062</span>  <span class="m">3062</span> E SELinux : avc:  denied  <span class="o">{</span> add <span class="o">}</span> <span class="k">for</span> <span class="nv">service</span><span class="o">=</span>test.service <span class="nv">pid</span><span class="o">=</span><span class="m">4732</span> <span class="nv">uid</span><span class="o">=</span><span class="m">0</span> <span class="nv">scontext</span><span class="o">=</span>u:r:testA:s0 <span class="nv">tcontext</span><span class="o">=</span>u:object_r:test_service:s0 <span class="nv">tclass</span><span class="o">=</span>service_manager <span class="nv">permissive</span><span class="o">=</span><span class="m">0</span>
</code></pre></div><p>接下来再添加权限就行了，这个时候就不会违反neverallow规则</p>
<p>透过现象看本质，为什么会导致这个问题呢？</p>
<p>原因要从编译出plat_service_contexts那里说起，回到<code>/android/system/sepolicy/Android.mk</code></p>
<div class="highlight"><pre class="chroma"><code class="language-makefile" data-lang="makefile"><span class="ln"> 1</span><span class="err">include</span> <span class="k">$(</span><span class="nv">CLEAR_VARS</span><span class="k">)</span>
<span class="ln"> 2</span> 
<span class="ln"> 3</span><span class="nv">LOCAL_MODULE</span> <span class="o">:=</span> plat_service_contexts
<span class="ln"> 4</span><span class="nv">LOCAL_MODULE_CLASS</span> <span class="o">:=</span> ETC
<span class="ln"> 5</span><span class="nv">LOCAL_MODULE_TAGS</span> <span class="o">:=</span> optional
<span class="ln"> 6</span><span class="err">ifeq</span> <span class="err">(</span><span class="k">$(</span><span class="nv">PRODUCT_SEPOLICY_SPLIT</span><span class="k">)</span><span class="err">,true)</span>
<span class="ln"> 7</span><span class="nv">LOCAL_MODULE_PATH</span> <span class="o">:=</span> <span class="k">$(</span>TARGET_OUT<span class="k">)</span>/etc/selinux
<span class="ln"> 8</span><span class="err">else</span>
<span class="ln"> 9</span><span class="nv">LOCAL_MODULE_PATH</span> <span class="o">:=</span> <span class="k">$(</span>TARGET_ROOT_OUT<span class="k">)</span>
<span class="ln">10</span><span class="err">endif</span>
<span class="ln">11</span> 
<span class="ln">12</span><span class="err">include</span> <span class="k">$(</span><span class="nv">BUILD_SYSTEM</span><span class="k">)</span><span class="err">/base_rules.mk</span>
<span class="ln">13</span> 
<span class="ln">14</span><span class="nv">plat_svcfiles</span> <span class="o">:=</span> <span class="k">$(</span>call build_policy, service_contexts, <span class="k">$(</span>PLAT_PRIVATE_POLICY<span class="k">))</span>
<span class="ln">15</span> 
<span class="ln">16</span><span class="nv">plat_service_contexts.tmp</span> <span class="o">:=</span> <span class="k">$(</span>intermediates<span class="k">)</span>/plat_service_contexts.tmp
<span class="ln">17</span><span class="nf">$(plat_service_contexts.tmp)</span><span class="o">:</span> <span class="n">PRIVATE_SVC_FILES</span> := <span class="k">$(</span><span class="nv">plat_svcfiles</span><span class="k">)</span>
<span class="ln">18</span><span class="nf">$(plat_service_contexts.tmp)</span><span class="o">:</span> <span class="n">PRIVATE_ADDITIONAL_M</span>4<span class="n">DEFS</span> := <span class="k">$(</span><span class="nv">LOCAL_ADDITIONAL_M</span>4<span class="nv">DEFS</span><span class="k">)</span>
<span class="ln">19</span><span class="nf">$(plat_service_contexts.tmp)</span><span class="o">:</span> <span class="k">$(</span><span class="nv">plat_svcfiles</span><span class="k">)</span>
<span class="ln">20</span>    @mkdir -p <span class="k">$(</span>dir <span class="nv">$@</span><span class="k">)</span>
<span class="ln">21</span>    <span class="k">$(</span>hide<span class="k">)</span> m4 -s <span class="k">$(</span>PRIVATE_ADDITIONAL_M4DEFS<span class="k">)</span> <span class="k">$(</span>PRIVATE_SVC_FILES<span class="k">)</span> &gt; <span class="nv">$@</span>
<span class="ln">22</span> 
<span class="ln">23</span><span class="nf">$(LOCAL_BUILT_MODULE)</span><span class="o">:</span> <span class="n">PRIVATE_SEPOLICY</span> := <span class="k">$(</span><span class="nv">built_sepolicy</span><span class="k">)</span>
<span class="ln">24</span><span class="nf">$(LOCAL_BUILT_MODULE)</span><span class="o">:</span> <span class="k">$(</span><span class="nv">plat_service_contexts</span>.<span class="nv">tmp</span><span class="k">)</span> <span class="k">$(</span><span class="nv">built_sepolicy</span><span class="k">)</span> <span class="k">$(</span><span class="nv">HOST_OUT_EXECUTABLES</span><span class="k">)</span>/<span class="n">checkfc</span> <span class="k">$(</span><span class="nv">ACP</span><span class="k">)</span>
<span class="ln">25</span>    @mkdir -p <span class="k">$(</span>dir <span class="nv">$@</span><span class="k">)</span>
<span class="ln">26</span>    sed -e <span class="s1">&#39;s/#.*$$//&#39;</span> -e <span class="s1">&#39;/^$$/d&#39;</span> $&lt; &gt; <span class="nv">$@</span>
<span class="ln">27</span>    <span class="k">$(</span>HOST_OUT_EXECUTABLES<span class="k">)</span>/checkfc -s <span class="k">$(</span>PRIVATE_SEPOLICY<span class="k">)</span> <span class="nv">$@</span>
<span class="ln">28</span> 
<span class="ln">29</span><span class="nv">built_plat_svc</span> <span class="o">:=</span> <span class="k">$(</span>LOCAL_BUILT_MODULE<span class="k">)</span>
<span class="ln">30</span><span class="nv">plat_svcfiles</span> <span class="o">:=</span>
<span class="ln">31</span><span class="nv">plat_service_contexts.tmp</span> <span class="o">:=</span>
</code></pre></div><p>mk里面搜索的目录是PLAT_PRIVATE_POLICY，前面有提过，这个目录是/android/system/sepolicy/private 以及 BOARD_PLAT_PRIVATE_SEPOLICY_DIR 所组成的,所以device厂商下面的sepolicy/service_contexts 没有用到</p>
<p>解决办法很简单：</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln">1</span><span class="err">首先指定拓展的私有目录</span> <span class="n">BOARD_PLAT_PRIVATE_SEPOLICY_DIR</span>
<span class="ln">2</span><span class="n">BOARD_PLAT_PRIVATE_SEPOLICY_DIR</span> <span class="o">+=</span> \
<span class="ln">3</span>    <span class="n">xxxx</span><span class="o">/</span><span class="n">sepolicy</span><span class="o">/</span><span class="k">private</span>
<span class="ln">4</span> 
<span class="ln">5</span><span class="err">然后添加：</span>
<span class="ln">6</span><span class="n">xxxx</span><span class="o">/</span><span class="n">sepolicy</span><span class="o">/</span><span class="k">private</span><span class="o">/</span><span class="n">service_contexts</span>
<span class="ln">7</span> 
<span class="ln">8</span><span class="err">内容为：</span>
<span class="ln">9</span><span class="n">test</span><span class="p">.</span><span class="n">service</span>                               <span class="nl">u</span><span class="p">:</span><span class="nl">object_r</span><span class="p">:</span><span class="nl">test_service</span><span class="p">:</span><span class="n">s0</span>
</code></pre></div><p>编译selinux_policy，就可以看到这个context被追加到plat_service_contexts了</p>
<p>还有，在这个地方添加的service_contexts，并不是所有情况都没有作用</p>
<p>看看这两段mk：</p>
<div class="highlight"><pre class="chroma"><code class="language-makefile" data-lang="makefile"><span class="ln"> 1</span><span class="c"># Include precompiled policy, unless told otherwise
</span><span class="ln"> 2</span><span class="c"></span><span class="err">ifneq</span> <span class="err">(</span><span class="k">$(</span><span class="nv">PRODUCT_PRECOMPILED_SEPOLICY</span><span class="k">)</span><span class="err">,false)</span>
<span class="ln"> 3</span><span class="nv">LOCAL_REQUIRED_MODULES</span> <span class="o">+=</span> precompiled_sepolicy precompiled_sepolicy.plat_and_mapping.sha256
<span class="ln"> 4</span><span class="err">endif</span>
<span class="ln"> 5</span><span class="err">else</span>
<span class="ln"> 6</span><span class="c"># The following files are only allowed for non-Treble devices.
</span><span class="ln"> 7</span><span class="c"></span><span class="nv">LOCAL_REQUIRED_MODULES</span> <span class="o">+=</span> <span class="se">\
</span><span class="ln"> 8</span><span class="se"></span>    sepolicy <span class="se">\
</span><span class="ln"> 9</span><span class="se"></span>    vendor_service_contexts
<span class="ln">10</span><span class="err">endif</span>
</code></pre></div><p>vendor_service_contexts</p>
<div class="highlight"><pre class="chroma"><code class="language-makefile" data-lang="makefile"><span class="ln"> 1</span><span class="err">include</span> <span class="k">$(</span><span class="nv">CLEAR_VARS</span><span class="k">)</span>
<span class="ln"> 2</span> 
<span class="ln"> 3</span><span class="nv">LOCAL_MODULE</span> <span class="o">:=</span> vendor_service_contexts
<span class="ln"> 4</span><span class="nv">LOCAL_MODULE_CLASS</span> <span class="o">:=</span> ETC
<span class="ln"> 5</span><span class="nv">LOCAL_MODULE_TAGS</span> <span class="o">:=</span> optional
<span class="ln"> 6</span><span class="nv">LOCAL_MODULE_PATH</span> <span class="o">:=</span> <span class="k">$(</span>TARGET_ROOT_OUT<span class="k">)</span>
<span class="ln"> 7</span> 
<span class="ln"> 8</span><span class="err">include</span> <span class="k">$(</span><span class="nv">BUILD_SYSTEM</span><span class="k">)</span><span class="err">/base_rules.mk</span>
<span class="ln"> 9</span> 
<span class="ln">10</span><span class="nv">vendor_svcfiles</span> <span class="o">:=</span> <span class="k">$(</span>call build_policy, service_contexts, <span class="k">$(</span>PLAT_VENDOR_POLICY<span class="k">)</span> <span class="k">$(</span>BOARD_VENDOR_SEPOLICY_DIRS<span class="k">)</span> <span class="k">$(</span>REQD_MASK_POLICY<span class="k">))</span>
<span class="ln">11</span> 
<span class="ln">12</span><span class="nv">vendor_service_contexts.tmp</span> <span class="o">:=</span> <span class="k">$(</span>intermediates<span class="k">)</span>/vendor_service_contexts.tmp
<span class="ln">13</span><span class="nf">$(vendor_service_contexts.tmp)</span><span class="o">:</span> <span class="n">PRIVATE_SVC_FILES</span> := <span class="k">$(</span><span class="nv">vendor_svcfiles</span><span class="k">)</span>
<span class="ln">14</span><span class="nf">$(vendor_service_contexts.tmp)</span><span class="o">:</span> <span class="n">PRIVATE_ADDITIONAL_M</span>4<span class="n">DEFS</span> := <span class="k">$(</span><span class="nv">LOCAL_ADDITIONAL_M</span>4<span class="nv">DEFS</span><span class="k">)</span>
<span class="ln">15</span><span class="nf">$(vendor_service_contexts.tmp)</span><span class="o">:</span> <span class="k">$(</span><span class="nv">vendor_svcfiles</span><span class="k">)</span>
<span class="ln">16</span>    @mkdir -p <span class="k">$(</span>dir <span class="nv">$@</span><span class="k">)</span>
<span class="ln">17</span>    <span class="k">$(</span>hide<span class="k">)</span> m4 -s <span class="k">$(</span>PRIVATE_ADDITIONAL_M4DEFS<span class="k">)</span> <span class="k">$(</span>PRIVATE_SVC_FILES<span class="k">)</span> &gt; <span class="nv">$@</span>
<span class="ln">18</span> 
<span class="ln">19</span><span class="nf">$(LOCAL_BUILT_MODULE)</span><span class="o">:</span> <span class="n">PRIVATE_SEPOLICY</span> := <span class="k">$(</span><span class="nv">built_sepolicy</span><span class="k">)</span>
<span class="ln">20</span><span class="nf">$(LOCAL_BUILT_MODULE)</span><span class="o">:</span> <span class="k">$(</span><span class="nv">vendor_service_contexts</span>.<span class="nv">tmp</span><span class="k">)</span> <span class="k">$(</span><span class="nv">built_sepolicy</span><span class="k">)</span> <span class="k">$(</span><span class="nv">HOST_OUT_EXECUTABLES</span><span class="k">)</span>/<span class="n">checkfc</span> <span class="k">$(</span><span class="nv">ACP</span><span class="k">)</span>
<span class="ln">21</span>    @mkdir -p <span class="k">$(</span>dir <span class="nv">$@</span><span class="k">)</span>
<span class="ln">22</span>    sed -e <span class="s1">&#39;s/#.*$$//&#39;</span> -e <span class="s1">&#39;/^$$/d&#39;</span> $&lt; &gt; <span class="nv">$@</span>
<span class="ln">23</span>    <span class="k">$(</span>hide<span class="k">)</span> <span class="k">$(</span>HOST_OUT_EXECUTABLES<span class="k">)</span>/checkfc -s <span class="k">$(</span>PRIVATE_SEPOLICY<span class="k">)</span> <span class="nv">$@</span>
<span class="ln">24</span> 
<span class="ln">25</span><span class="nv">built_vendor_svc</span> <span class="o">:=</span> <span class="k">$(</span>LOCAL_BUILT_MODULE<span class="k">)</span>
<span class="ln">26</span><span class="nv">vendor_svcfiles</span> <span class="o">:=</span>
<span class="ln">27</span><span class="nv">vendor_service_contexts.tmp</span> <span class="o">:=</span>
<span class="ln">28</span> 
<span class="ln">29</span><span class="err">endif</span>
</code></pre></div><p>注释很清楚，也就是说在非treble的设备上，上面路径的service_contexts会编译到vendor_service_contexts里面；如果要生效，就得把它加到private的拓展目录</p>
<h4 id="4214testneverallowrules252-解决方案">4.2.1.4testNeverallowRules252 解决方案</h4>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln">1</span>&lt;Test <span class="nv">result</span><span class="o">=</span><span class="s2">&#34;fail&#34;</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;testNeverallowRules252&#34;</span>&gt;
<span class="ln">2</span>        &lt;Failure <span class="nv">message</span><span class="o">=</span><span class="s2">&#34;junit.framework.AssertionFailedError: The following errors were encountered when validating the SELinuxneverallow rule:&#34;</span>&gt;
<span class="ln">3</span>          &lt;StackTrace&gt;junit.framework.AssertionFailedError: The following errors were encountered when validating the SELinuxneverallow rule:
<span class="ln">4</span>neverallow <span class="o">{</span> domain -init -vendor_init -system_server -dumpstate <span class="o">}</span> debugfs:file <span class="o">{</span> <span class="o">{</span> append create link unlink relabelfrom rename setattr write <span class="o">}</span> open <span class="nb">read</span> ioctl lock <span class="o">}</span><span class="p">;</span>
<span class="ln">5</span>libsepol.report_failure: neverallow violated by allow mediaserver debugfs:file <span class="o">{</span> <span class="nb">read</span> open <span class="o">}</span><span class="p">;</span>
<span class="ln">6</span>libsepol.report_failure: neverallow violated by allow hal_memtrack_default debugfs:file <span class="o">{</span> <span class="nb">read</span> open <span class="o">}</span><span class="p">;</span>
<span class="ln">7</span>libsepol.check_assertions: <span class="m">2</span> neverallow failures occurred
</code></pre></div><p>报错信息如下：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln">1</span><span class="o">[</span>  818.411706@1<span class="o">]</span> <span class="nv">type</span><span class="o">=</span><span class="m">1400</span> audit<span class="o">(</span>1623295203.581:48<span class="o">)</span>: avc: denied <span class="o">{</span> <span class="nb">read</span> <span class="o">}</span> <span class="k">for</span> <span class="nv">pid</span><span class="o">=</span><span class="m">3147</span> <span class="nv">comm</span><span class="o">=</span><span class="s2">&#34;HwBinder:3147_3&#34;</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;test_en&#34;</span> <span class="nv">dev</span><span class="o">=</span><span class="s2">&#34;debugfs&#34;</span> <span class="nv">ino</span><span class="o">=</span><span class="m">377</span> <span class="nv">scontext</span><span class="o">=</span>u:r:mediaserver:s0 <span class="nv">tcontext</span><span class="o">=</span>u:object_r:debugfs:s0 <span class="nv">tclass</span><span class="o">=</span>file <span class="nv">permissive</span><span class="o">=</span><span class="m">0</span>
</code></pre></div><p>拿其中mediaserver的来分析，查找修改记录，很快就可以得知，这个是在读写节点 /sys/kernel/debug/test/test_en 的时候出现的权限问题</p>
<p>和上面的处理思路一样，我们要给这个节点指定一个安全上下文，不然就是权限放大的问题</p>
<p>但是和普通的文件不同，这个不是添加在file_contexts里面了，而是要添加在 genfs_contexts</p>
<p>file_contexts 里面的指定的文件，都是编译之后就有了的，而像 /sys/kernel/debug 、 /proc 这些是系统起来之后动态生成的，这些的节点文件的安全上下文就要在genfs_contexts里面指定的</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>genfscon debugfs /sys/kernel/debug/test/test_en u:object_r:debugfs_test:s0
</code></pre></div><p>这里很容易犯一个错误，就是直接把完整路径写到第三个字段里面去了</p>
<p>实际上，debugfs 指代的就是/sys/kernel/debug这个路径，后面要写的是相对于debugfs 的路径</p>
<p>因此，正确的写法是这样的：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>genfscon debugfs /test/test_en u:object_r:debugfs_test:s0
</code></pre></div><blockquote>
<p><code>特别注意</code></p>
<p>这里根据笔者经验，特别是/proc或者是/sys/fs目录下面，存在很多软连接，上面的例如/test/test_en这类必须为<strong>真实路径</strong>，否则设置te文件的权限可能无效</p>
</blockquote>
<p>当然，file.te里面还得定义debugfs_test这个type</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>type debugfs_test, fs_type, sysfs_type, debugfs_type;
</code></pre></div><p>修改之后是要编译precompiled_sepolicy的，而不是像file_contexts可以直接在板子上修改，重启之后报错如下：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln">1</span><span class="o">[</span>  818.411706@1<span class="o">]</span> <span class="nv">type</span><span class="o">=</span><span class="m">1400</span> audit<span class="o">(</span>1623295203.581:48<span class="o">)</span>: avc: denied <span class="o">{</span> <span class="nb">read</span> <span class="o">}</span> <span class="k">for</span> <span class="nv">pid</span><span class="o">=</span><span class="m">3147</span> <span class="nv">comm</span><span class="o">=</span><span class="s2">&#34;HwBinder:3147_3&#34;</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;test_en&#34;</span> <span class="nv">dev</span><span class="o">=</span><span class="s2">&#34;debugfs&#34;</span> <span class="nv">ino</span><span class="o">=</span><span class="m">377</span> <span class="nv">scontext</span><span class="o">=</span>u:r:mediaserver:s0 <span class="nv">tcontext</span><span class="o">=</span>u:object_r:debugfs_afc:s0 <span class="nv">tclass</span><span class="o">=</span>file <span class="nv">permissive</span><span class="o">=</span><span class="m">0</span>
</code></pre></div><p>再往下只要添加对应的权限就行了</p>
<h4 id="4215exec_type">4.2.1.5exec_type</h4>
<p>还有一个例子也是很重要的</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln">1</span><span class="o">[</span>   10.583284<span class="o">]</span> <span class="nv">type</span><span class="o">=</span><span class="m">1400</span> audit<span class="o">(</span>10.256:8<span class="o">)</span>: avc: denied <span class="o">{</span> entrypoint <span class="o">}</span> <span class="k">for</span> <span class="nv">pid</span><span class="o">=</span><span class="m">3233</span> <span class="nv">comm</span><span class="o">=</span><span class="s2">&#34;init&#34;</span> <span class="nv">path</span><span class="o">=</span><span class="s2">&#34;/vendor/bin/testA.sh&#34;</span> <span class="nv">dev</span><span class="o">=</span><span class="s2">&#34;mmcblk0p16&#34;</span> <span class="nv">ino</span><span class="o">=</span><span class="m">712</span> <span class="nv">scontext</span><span class="o">=</span>u:r:testA:s0 <span class="nv">tcontext</span><span class="o">=</span>u:object_r:vendor_file:s0 <span class="nv">tclass</span><span class="o">=</span>file <span class="nv">permissive</span><span class="o">=</span><span class="m">0</span>
</code></pre></div><p>添加权限</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>allow testA vendor_file:file entrypoint;
</code></pre></div><p>结果违反了neverallow规则，然后继续干掉规则呗，这还不简单</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln">1</span>FAILED: out/target/product/xxxx/obj/ETC/sepolicy_neverallows_intermediates/sepolicy_neverallows
<span class="ln">2</span>/bin/bash -c <span class="s2">&#34;(rm -f out/target/product/xxxx/obj/ETC/sepolicy_neverallows_intermediates/sepolicy_neverallows ) &amp;&amp; (ASAN_OPTIONS=detect_leaks=0 out/host/linux-x86/bin/checkpolicy -M -c           30 -o out/target/product/xxxx/obj/ETC/sepolicy_neverallows_intermediates/sepolicy_neverallows out/target/product/xxxx/obj/ETC/sepolicy_neverallows_intermediates/policy.conf )&#34;</span>
<span class="ln">3</span>libsepol.report_failure: neverallow on line <span class="m">376</span> of system/sepolicy/public/domain.te <span class="o">(</span>or line <span class="m">10221</span> of policy.conf<span class="o">)</span> violated by allow testA vendor_file:file <span class="o">{</span> entrypoint <span class="o">}</span><span class="p">;</span>
<span class="ln">4</span>libsepol.check_assertions: <span class="m">1</span> neverallow failures occurred
</code></pre></div><p>domain.te里面的neverallow规则：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span># Ensure that all entrypoint executables are in exec_type or postinstall_file.
<span class="ln">2</span>neverallow * { file_type -exec_type -postinstall_file }:file entrypoint;
</code></pre></div><p>正确的处理方式和前面提到的是一样的，也是同个道理</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>//sepolicy/file_contexts
<span class="ln">2</span> 
<span class="ln">3</span>/vendor/bin/testA.sh        u:object_r:testA_exec:s0
</code></pre></div><p>这就是为什么我们之前添加脚本的时候，每次都要加这样一句话的原因</p>
<h3 id="422利用attributes绕开neverallow规则">4.2.2利用attributes绕开neverallow规则</h3>
<p>这一类处理方式并不是从根源上解决，而是利用了规则的定义绕开了而已</p>
<p>8.0以前的不会有这样的一些规则，归根到底还是treble工程</p>
<h4 id="4221testneverallowrules184-解决方案">4.2.2.1testNeverallowRules184 解决方案</h4>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln"> 1</span>&lt;Test <span class="nv">result</span><span class="o">=</span><span class="s2">&#34;fail&#34;</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;testNeverallowRules184&#34;</span>&gt;
<span class="ln"> 2</span>        &lt;Failure <span class="nv">message</span><span class="o">=</span><span class="s2">&#34;junit.framework.AssertionFailedError: The following errors were encountered when validating the SELinuxneverallow rule:&#34;</span>&gt;
<span class="ln"> 3</span>          &lt;StackTrace&gt;junit.framework.AssertionFailedError: The following errors were encountered when validating the SELinuxneverallow rule:
<span class="ln"> 4</span>neverallow <span class="o">{</span>      domain      -coredomain      -appdomain      -binder_in_vendor_violators     <span class="o">}</span> binder_device:chr_file <span class="o">{</span> <span class="o">{</span> getattr open <span class="nb">read</span> ioctl lock map <span class="o">}</span> <span class="o">{</span> open append write lock map <span class="o">}</span> <span class="o">}</span><span class="p">;</span>
<span class="ln"> 5</span>libsepol.report_failure: neverallow violated by allow testA binder_device:chr_file <span class="o">{</span> ioctl <span class="nb">read</span> write open <span class="o">}</span><span class="p">;</span>
<span class="ln"> 6</span>libsepol.check_assertions: <span class="m">1</span> neverallow failures occurred
<span class="ln"> 7</span> 
<span class="ln"> 8</span>&lt;/StackTrace&gt;
<span class="ln"> 9</span>        &lt;/Failure&gt;
<span class="ln">10</span>      &lt;/Test&gt;
</code></pre></div><p>利用属性 <code>binder_in_vendor_violators</code> 规避这个问题</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>type testA, domain;
<span class="ln">2</span>修改为
<span class="ln">3</span>type testA, domain, binder_in_vendor_violators;
</code></pre></div><p>原因很简单，<code>binder_in_vendor_violators</code>是一个属性，查看上面的neverallow规则就可以明白</p>
<h4 id="4223testneverallowrules185-解决方案">4.2.2.3testNeverallowRules185 解决方案</h4>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln">1</span>&lt;Test <span class="nv">result</span><span class="o">=</span><span class="s2">&#34;fail&#34;</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;testNeverallowRules185&#34;</span>&gt;
<span class="ln">2</span>        &lt;Failure <span class="nv">message</span><span class="o">=</span><span class="s2">&#34;junit.framework.AssertionFailedError: The following errors were encountered when validating the SELinuxneverallow rule:&#34;</span>&gt;
<span class="ln">3</span>          &lt;StackTrace&gt;junit.framework.AssertionFailedError: The following errors were encountered when validating the SELinuxneverallow rule:
<span class="ln">4</span>neverallow <span class="o">{</span>      domain      -coredomain      -appdomain       -binder_in_vendor_violators     <span class="o">}</span> service_manager_type:service_manager find<span class="p">;</span>
<span class="ln">5</span>libsepol.report_failure: neverallow violated by allow testA activity_service:service_manager <span class="o">{</span> find <span class="o">}</span><span class="p">;</span>
<span class="ln">6</span>libsepol.check_assertions: <span class="m">1</span> neverallow failures occurred
</code></pre></div><p>和上面的一样，利用属性 <code>binder_in_vendor_violators</code> 规避这个问题</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>type testA, domain;
<span class="ln">2</span>修改为
<span class="ln">3</span>type testA, domain, binder_in_vendor_violators;
</code></pre></div><p>这些属性之所以会存在，说明了Google并没有做到最完美的system和vendor分离，所有有这么一个像是后门的东西</p>
<p>还有一些：</p>
<ul>
<li>vendor_executes_system_violators</li>
<li>data_between_core_and_vendor_violators</li>
<li>system_writes_vendor_properties_violators</li>
</ul>
<h3 id="423vendor的脚本在有权限的目录读写不要操作system的">4.2.3vendor的脚本，在有权限的目录读写，不要操作system的</h3>
<p>这类问题很明显，system和vendor分离之后才有的，没有啥好讲的，多看看报错信息和domain.te里面的注释，就能搞明白了</p>
<h4 id="4231testneverallowrules217-解决方案">4.2.3.1testNeverallowRules217 解决方案</h4>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln"> 1</span>&lt;Test <span class="nv">result</span><span class="o">=</span><span class="s2">&#34;fail&#34;</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;testNeverallowRules217&#34;</span>&gt;
<span class="ln"> 2</span>        &lt;Failure <span class="nv">message</span><span class="o">=</span><span class="s2">&#34;junit.framework.AssertionFailedError: The following errors were encountered when validating the SELinuxneverallow rule:&#34;</span>&gt;
<span class="ln"> 3</span>          &lt;StackTrace&gt;junit.framework.AssertionFailedError: The following errors were encountered when validating the SELinuxneverallow rule:
<span class="ln"> 4</span>neverallow <span class="o">{</span>          domain          -coredomain          -appdomain          -vendor_executes_system_violators          -vendor_init      <span class="o">}</span> <span class="o">{</span>          exec_type          -vendor_file_type          -crash_dump_exec          -netutils_wrapper_exec      <span class="o">}</span>:file <span class="o">{</span> entrypoint execute execute_no_trans <span class="o">}</span><span class="p">;</span>
<span class="ln"> 5</span>libsepol.report_failure: neverallow violated by allow testA shell_exec:file <span class="o">{</span> execute <span class="o">}</span><span class="p">;</span>
<span class="ln"> 6</span>libsepol.check_assertions: <span class="m">1</span> neverallow failures occurred
<span class="ln"> 7</span> 
<span class="ln"> 8</span>&lt;/StackTrace&gt;
<span class="ln"> 9</span>        &lt;/Failure&gt;
<span class="ln">10</span>      &lt;/Test&gt;
</code></pre></div><p>首先，如果脚本在/vendor/bin下面，先将sh改过来</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span><span class="cp">#!/system/bin/sh
</span><span class="ln">2</span><span class="cp"></span> 
<span class="ln">3</span>修改为：
<span class="ln">4</span> 
<span class="ln">5</span><span class="c1">#!/vendor/bin/sh</span>
</code></pre></div><p>以上能解决大部分问题，但是如果有些命令只有在/system/bin下面才有的，那这个时候就没有办法了，这个shell_exec:file 一定要加</p>
<p>此时，只能通过vendor_executes_system_violators 来规避问题了</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span><span class="nb">type</span> testA, domain, binder_in_vendor_violators<span class="p">;</span>
<span class="ln">2</span> 
<span class="ln">3</span>修改为：
<span class="ln">4</span> 
<span class="ln">5</span><span class="nb">type</span> testA, domain, binder_in_vendor_violators, vendor_executes_system_violators<span class="p">;</span>
</code></pre></div><h4 id="4232testneverallowrules203-解决方案">4.2.3.2testNeverallowRules203 解决方案</h4>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln"> 1</span>&lt;Test <span class="nv">result</span><span class="o">=</span><span class="s2">&#34;fail&#34;</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;testNeverallowRules203&#34;</span>&gt;
<span class="ln"> 2</span>        &lt;Failure <span class="nv">message</span><span class="o">=</span><span class="s2">&#34;junit.framework.AssertionFailedError: The following errors were encountered when validating the SELinuxneverallow rule:&#34;</span>&gt;
<span class="ln"> 3</span>          &lt;StackTrace&gt;junit.framework.AssertionFailedError: The following errors were encountered when validating the SELinuxneverallow rule:
<span class="ln"> 4</span>neverallow <span class="o">{</span>      domain      -appdomain       -coredomain      -data_between_core_and_vendor_violators       -vendor_init    <span class="o">}</span> <span class="o">{</span>      core_data_file_type                        -zoneinfo_data_file    <span class="o">}</span>:<span class="o">{</span> <span class="o">{</span> chr_file blk_file <span class="o">}</span> <span class="o">{</span> file lnk_file sock_file fifo_file <span class="o">}</span> <span class="o">}</span> ~<span class="o">{</span> append getattr ioctl <span class="nb">read</span> write map <span class="o">}</span><span class="p">;</span>
<span class="ln"> 5</span>libsepol.report_failure: neverallow violated by allow testA system_data_file:file <span class="o">{</span> open <span class="o">}</span><span class="p">;</span>
<span class="ln"> 6</span>libsepol.check_assertions: <span class="m">1</span> neverallow failures occurred
<span class="ln"> 7</span> 
<span class="ln"> 8</span>&lt;/StackTrace&gt;
<span class="ln"> 9</span>        &lt;/Failure&gt;
<span class="ln">10</span>      &lt;/Test&gt;
</code></pre></div><p>仔细看domain.te里面的注释，就能明白了</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span># vendor domains may only access files in /data/vendor, never core_data_file_types
</code></pre></div><p>把脚本里面的路径修改一下</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span><span class="nv">TEMP_PATH</span><span class="o">=</span><span class="s2">&#34;/data/test&#34;</span>
<span class="ln">2</span> 
<span class="ln">3</span>修改为：
<span class="ln">4</span> 
<span class="ln">5</span><span class="nv">TEMP_PATH</span><span class="o">=</span><span class="s2">&#34;/data/vendor/test&#34;</span>
</code></pre></div><p>当然，有些neverallow规则还是可以利用属性绕过的（像data_between_core_and_vendor_violators），不过能正面解决就直接解决了</p>
<h3 id="424dac_override-问题">4.2.4dac_override 问题</h3>
<p>这个在前面以及提到过了，阅读一下参考文章就能明白了</p>
<p>解决这个问题从来不是添加SELinux处理的，必须要去解决unix user/group/others权限问题</p>
<h3 id="425读写data数据">4.2.5读写/data数据</h3>
<p>这里讨论下另一个解决方案：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln">1</span>&lt;Test <span class="nv">result</span><span class="o">=</span><span class="s2">&#34;fail&#34;</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;testNeverallowRules237&#34;</span>&gt;
<span class="ln">2</span>        &lt;Failure <span class="nv">message</span><span class="o">=</span><span class="s2">&#34;junit.framework.AssertionFailedError: The following errors were encountered when validating the SELinuxneverallow rule:&#34;</span>&gt;
<span class="ln">3</span>          &lt;StackTrace&gt;junit.framework.AssertionFailedError: The following errors were encountered when validating the SELinuxneverallow rule:
<span class="ln">4</span>neverallow <span class="o">{</span>   domain   -system_server   -system_app   -init   -installd    -vold_prepare_subdirs     <span class="o">}</span> system_data_file:file <span class="o">{</span> append create link unlink relabelfrom rename setattr write <span class="o">}</span><span class="p">;</span>
<span class="ln">5</span>libsepol.report_failure: neverallow violated by allow testA system_data_file:file <span class="o">{</span> write create setattr unlink <span class="o">}</span><span class="p">;</span>
<span class="ln">6</span>libsepol.check_assertions: <span class="m">1</span> neverallow failures occurred
</code></pre></div><p>再次看到这个很好奇，不是已经在上面的处理方法中解决了吗，修改读写的路径，改成有权限的地方就行了</p>
<p>这里再提供另一种解决思路，对于那些我们不方便修改代码的，这是一个福音</p>
<p>以下面的这个权限为例：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>allow testA system_data_file:file { write create unlink };
</code></pre></div><p>这个权限添加的目的是为了读写、删除这个文件： /data/test.txt</p>
<p>问题就在于进程testA他没有直接权限读写啊</p>
<p>按照以前的思路：干掉规则 -testA</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln"> 1</span>neverallow {
<span class="ln"> 2</span>  domain
<span class="ln"> 3</span>  -system_server
<span class="ln"> 4</span>  -system_app
<span class="ln"> 5</span>  -init
<span class="ln"> 6</span>  -installd # for relabelfrom and unlink, check for this in explicit neverallow
<span class="ln"> 7</span>  -vold_prepare_subdirs # For unlink
<span class="ln"> 8</span>  -testA
<span class="ln"> 9</span>  with_asan(`-asan_extract&#39;)
<span class="ln">10</span>} system_data_file:file no_w_file_perms;
</code></pre></div><p>经过上面的处理经验，一个简单的方案出来了，把/data/test.txt 修改成/data/vendor/test.txt</p>
<p>然后权限拉满，就可以正常创建和删除了</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>allow testA vendor_data_file:dir create_dir_perms;
<span class="ln">2</span>allow testA vendor_data_file:file create_file_perms;
</code></pre></div><p><strong>下面讨论的是另一种解决方案：</strong></p>
<p>data根目录，它所对应的安全上下文为：u:object_r:system_data_file:s0</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>drwxrwx--x  <span class="m">40</span> system system u:object_r:system_data_file:s0            <span class="m">4096</span> 2021-06-10 16:09 data
</code></pre></div><p>如果创建一个文件 /data/test.txt， 它的安全上下文是继承于父目录的，也就是u:object_r:system_data_file:s0</p>
<p>所以在上面的报错会看到是对system_data_file类型的目录缺少写的权限</p>
<p>但是，<strong>如果有一种方式可以实现创建文件或者子目录的时候，不要继承父目录的scontext，改成一个拥有权限的type，那不就可以了嘛？</strong></p>
<p>没错，还真的有这种操作，这个叫做type transition ， <strong>类型转移</strong></p>
<p>在前面的基础文档里面已经有介绍了，我们直切主题，用宏 file_type_auto_trans</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>file_type_auto_trans(testA, system_data_file, vendor_data_file)
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln"> 1</span>#####################################
<span class="ln"> 2</span># file_type_auto_trans(domain, dir_type, file_type)
<span class="ln"> 3</span># Automatically label new files with file_type when
<span class="ln"> 4</span># they are created by domain in directories labeled dir_type.
<span class="ln"> 5</span>#
<span class="ln"> 6</span>define(`file_type_auto_trans&#39;, `
<span class="ln"> 7</span># Allow the necessary permissions.
<span class="ln"> 8</span>file_type_trans($1, $2, $3)
<span class="ln"> 9</span># Make the transition occur by default.
<span class="ln">10</span>type_transition $1 $2:dir $3;
<span class="ln">11</span>type_transition $1 $2:notdevfile_class_set $3;
<span class="ln">12</span>&#39;)
<span class="ln">13</span> 
<span class="ln">14</span>意思就是，testA（第一个参数domain）这个type的进程，在system_data_file（第二个参数dir_type）类型的目录下面，创建文件时，指定它的type为vendor_data_file（第三个参数file_type）
</code></pre></div><p>同样的，这里同样要给vendor_data_file加权限</p>
<p>这一句将会发生如下变化：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln">1</span>picasso:/ <span class="c1"># ls -lZ /data/test.txt</span>
<span class="ln">2</span>-rw------- <span class="m">1</span> root system u:object_r:system_data_file:s0 <span class="m">5320</span> 2021-06-10 17:06 /data/test.txt
<span class="ln">3</span> 
<span class="ln">4</span>变成
<span class="ln">5</span> 
<span class="ln">6</span>picasso:/ <span class="c1"># ls -lZ /data/test.txt</span>
<span class="ln">7</span>-rw------- <span class="m">1</span> root system u:object_r:vendor_data_file:s0 <span class="m">5320</span> 2021-06-10 17:06 /data/test.txt
</code></pre></div><p>接着还有删除文件时需要下面的权限，这个正常添加就行了，下面的权限不会违反neverallow规则</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln">1</span><span class="o">[</span>   67.886702@2<span class="o">]</span> <span class="nv">type</span><span class="o">=</span><span class="m">1400</span> audit<span class="o">(</span>1623315964.145:18<span class="o">)</span>: avc: denied <span class="o">{</span> remove_name <span class="o">}</span> <span class="k">for</span> <span class="nv">pid</span><span class="o">=</span><span class="m">3142</span> <span class="nv">comm</span><span class="o">=</span><span class="s2">&#34;HwBinder:3142_2&#34;</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;test.txt&#34;</span> <span class="nv">dev</span><span class="o">=</span><span class="s2">&#34;mmcblk0p21&#34;</span> <span class="nv">ino</span><span class="o">=</span><span class="m">1263</span> <span class="nv">scontext</span><span class="o">=</span>u:r:testA:s0 <span class="nv">tcontext</span><span class="o">=</span>u:object_r:system_data_file:s0 <span class="nv">tclass</span><span class="o">=</span>dir <span class="nv">permissive</span><span class="o">=</span><span class="m">0</span>
</code></pre></div><p>这种方式不一定适用于app，因为app里面还有其他neverallow规则会限制</p>
<p>它不是针对某个进程，而是针对的是一个域，这样会导致所有在这个域里面的进程都会创建出新的type的文件</p>
<h2 id="43一些思考">4.3一些思考</h2>
<h3 id="431修改属性的neverallow规则还能测试通过">4.3.1修改属性的neverallow规则，还能测试通过</h3>
<p>在/android/system/sepolicy/public/property.te 这一段，本来以为会有报错的，因为违反了neverallow规则</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln"> 1</span>compatible_property_only(`
<span class="ln"> 2</span>  # Neverallow coredomain to set vendor properties
<span class="ln"> 3</span>  neverallow {
<span class="ln"> 4</span>    coredomain
<span class="ln"> 5</span>    -init
<span class="ln"> 6</span>    -system_writes_vendor_properties_violators
<span class="ln"> 7</span>    -system_server
<span class="ln"> 8</span>    -platform_app
<span class="ln"> 9</span>    -testA
<span class="ln">10</span>  } {
<span class="ln">11</span>    property_type
<span class="ln">12</span>    -audio_prop
<span class="ln">13</span>    -bluetooth_a2dp_offload_prop
<span class="ln">14</span>    -bluetooth_prop
<span class="ln">15</span>    -bootloader_boot_reason_prop
<span class="ln">16</span>......
<span class="ln">17</span>    -test_prop
<span class="ln">18</span>  }:property_service set;
<span class="ln">19</span>&#39;)
</code></pre></div><p>但实际上并没有报错，找到CTS测试的源码：</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="err">@</span><span class="n">RestrictedBuildTest</span>
<span class="ln"> 2</span>  <span class="k">public</span> <span class="kt">void</span> <span class="n">testNeverallowRules436</span><span class="p">()</span> <span class="k">throws</span> <span class="n">Exception</span> <span class="p">{</span>
<span class="ln"> 3</span>    <span class="n">String</span> <span class="n">neverallowRule</span> <span class="o">=</span> <span class="s">&#34;neverallow {      coredomain      -init      -system_writes_vendor_properties_violators    } {      property_type      -audio_prop      -bluetooth_a2dp_offload_prop      -bluetooth_prop      -bootloader_boot_reason_prop      -boottime_prop      -config_prop      -cppreopt_prop      -ctl_bootanim_prop      -ctl_bugreport_prop      -ctl_picasso_prop      -ctl_default_prop      -ctl_dumpstate_prop      -ctl_fuse_prop      -ctl_interface_restart_prop      -ctl_interface_start_prop      -ctl_interface_stop_prop      -ctl_mdnsd_prop      -ctl_restart_prop      -ctl_rildaemon_prop      -ctl_sigstop_prop      -ctl_start_prop      -ctl_stop_prop      -dalvik_prop      -debug_prop      -debuggerd_prop      -default_prop      -device_logging_prop      -dhcp_prop      -dumpstate_options_prop      -dumpstate_prop      -exported2_config_prop      -exported2_default_prop      -exported2_radio_prop      -exported2_system_prop      -exported2_vold_prop      -exported3_default_prop      -exported3_radio_prop      -exported3_system_prop      -exported_bluetooth_prop      -exported_config_prop      -exported_dalvik_prop      -exported_default_prop      -exported_dumpstate_prop      -exported_ffs_prop      -exported_fingerprint_prop      -exported_overlay_prop      -exported_pm_prop      -exported_radio_prop      -exported_secure_prop      -exported_system_prop      -exported_system_radio_prop      -exported_vold_prop      -exported_wifi_prop      -extended_core_property_type      -ffs_prop      -fingerprint_prop      -firstboot_prop      -hwservicemanager_prop      -last_boot_reason_prop      -log_prop      -log_tag_prop      -logd_prop      -logpersistd_logging_prop      -lowpan_prop      -mmc_prop      -net_dns_prop      -net_radio_prop      -netd_stable_secret_prop      -nfc_prop      -overlay_prop      -pan_result_prop      -persist_debug_prop      -persistent_properties_ready_prop      -pm_prop      -powerctl_prop      -radio_prop      -restorecon_prop      -safemode_prop      -serialno_prop      -shell_prop      -system_boot_reason_prop      -system_prop      -system_radio_prop      -test_boot_reason_prop      -traced_enabled_prop      -vendor_default_prop      -vendor_security_patch_level_prop      -vold_prop      -wifi_log_prop      -wifi_prop    }:property_service set;&#34;</span><span class="p">;</span>
<span class="ln"> 4</span>    <span class="n">boolean</span> <span class="n">fullTrebleOnly</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="ln"> 5</span>    <span class="n">boolean</span> <span class="n">compatiblePropertyOnly</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="ln"> 6</span> 
<span class="ln"> 7</span>    <span class="k">if</span> <span class="p">((</span><span class="n">fullTrebleOnly</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">isFullTrebleDevice</span><span class="p">()))</span>
<span class="ln"> 8</span>    <span class="p">{</span>
<span class="ln"> 9</span>      <span class="k">return</span><span class="p">;</span>
<span class="ln">10</span>    <span class="p">}</span>
<span class="ln">11</span>    <span class="k">if</span> <span class="p">((</span><span class="n">compatiblePropertyOnly</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">isCompatiblePropertyEnforcedDevice</span><span class="p">()))</span>
<span class="ln">12</span>    <span class="p">{</span>
<span class="ln">13</span>      <span class="k">return</span><span class="p">;</span>
<span class="ln">14</span>    <span class="p">}</span>
<span class="ln">15</span> 
<span class="ln">16</span>    <span class="n">File</span> <span class="n">policyFile</span> <span class="o">=</span> <span class="p">(</span><span class="n">isSepolicySplit</span><span class="p">())</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">mVendorSepolicyVersion</span> <span class="o">&lt;</span> <span class="mi">28</span><span class="p">)</span> <span class="o">?</span>
<span class="ln">17</span>      <span class="k">this</span><span class="p">.</span><span class="nl">deviceSystemPolicyFile</span> <span class="p">:</span>
<span class="ln">18</span>      <span class="k">this</span><span class="p">.</span><span class="n">devicePolicyFile</span><span class="p">;</span>
<span class="ln">19</span> 
<span class="ln">20</span>    <span class="n">ProcessBuilder</span> <span class="n">pb</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ProcessBuilder</span><span class="p">(</span><span class="k">new</span> <span class="n">String</span><span class="p">[]</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="n">sepolicyAnalyze</span><span class="p">.</span><span class="n">getAbsolutePath</span><span class="p">(),</span> <span class="n">policyFile</span>
<span class="ln">21</span>      <span class="p">.</span><span class="n">getAbsolutePath</span><span class="p">(),</span> <span class="s">&#34;neverallow&#34;</span><span class="p">,</span> <span class="s">&#34;-w&#34;</span><span class="p">,</span> <span class="s">&#34;-n&#34;</span><span class="p">,</span> <span class="n">neverallowRule</span> <span class="p">});</span>
<span class="ln">22</span> 
<span class="ln">23</span>    <span class="n">pb</span><span class="p">.</span><span class="n">redirectOutput</span><span class="p">(</span><span class="n">ProcessBuilder</span><span class="p">.</span><span class="n">Redirect</span><span class="p">.</span><span class="n">PIPE</span><span class="p">);</span>
<span class="ln">24</span>    <span class="n">pb</span><span class="p">.</span><span class="n">redirectErrorStream</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<span class="ln">25</span>    <span class="n">Process</span> <span class="n">p</span> <span class="o">=</span> <span class="n">pb</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
<span class="ln">26</span>    <span class="n">p</span><span class="p">.</span><span class="n">waitFor</span><span class="p">();</span>
<span class="ln">27</span>    <span class="n">BufferedReader</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedReader</span><span class="p">(</span><span class="k">new</span> <span class="n">InputStreamReader</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">getInputStream</span><span class="p">()));</span>
<span class="ln">28</span> 
<span class="ln">29</span>    <span class="n">StringBuilder</span> <span class="n">errorString</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="p">();</span>
<span class="ln">30</span>    <span class="n">String</span> <span class="n">line</span><span class="p">;</span>
<span class="ln">31</span>    <span class="k">while</span> <span class="p">((</span><span class="n">line</span> <span class="o">=</span> <span class="n">result</span><span class="p">.</span><span class="n">readLine</span><span class="p">())</span> <span class="o">!=</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
<span class="ln">32</span>      <span class="n">errorString</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">);</span>
<span class="ln">33</span>      <span class="n">errorString</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
<span class="ln">34</span>    <span class="p">}</span>
<span class="ln">35</span>    <span class="n">assertTrue</span><span class="p">(</span><span class="s">&#34;The following errors were encountered when validating the SELinuxneverallow rule:</span><span class="se">\n</span><span class="s">&#34;</span> <span class="o">+</span> <span class="n">neverallowRule</span> <span class="o">+</span> <span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span> <span class="o">+</span> <span class="n">errorString</span><span class="p">,</span> <span class="n">errorString</span>
<span class="ln">36</span>      <span class="p">.</span><span class="n">length</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
<span class="ln">37</span>  <span class="p">}</span>
</code></pre></div><p>代码是在这里被return了，也就是没有做检查，所以测试结果是pass的</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln"> 1</span><span class="k">if</span> <span class="p">((</span><span class="n">compatiblePropertyOnly</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">isCompatiblePropertyEnforcedDevice</span><span class="p">()))</span>
<span class="ln"> 2</span><span class="p">{</span>
<span class="ln"> 3</span>  <span class="k">return</span><span class="p">;</span>
<span class="ln"> 4</span><span class="p">}</span>
<span class="ln"> 5</span> 
<span class="ln"> 6</span> 
<span class="ln"> 7</span><span class="c1">//isCompatiblePropertyEnforcedDevice拿的是系统属性，从板子里面看了看，这个值是false
</span><span class="ln"> 8</span><span class="c1"></span><span class="k">public</span> <span class="k">static</span> <span class="n">boolean</span> <span class="nf">isCompatiblePropertyEnforcedDevice</span><span class="p">(</span><span class="n">ITestDevice</span> <span class="n">device</span><span class="p">)</span>
<span class="ln"> 9</span>    <span class="k">throws</span> <span class="n">DeviceNotAvailableException</span>
<span class="ln">10</span><span class="p">{</span>
<span class="ln">11</span>  <span class="k">return</span> <span class="n">PropertyUtil</span><span class="p">.</span><span class="n">propertyEquals</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="s">&#34;ro.actionable_compatible_property.enabled&#34;</span><span class="p">,</span> <span class="s">&#34;true&#34;</span><span class="p">);</span>
<span class="ln">12</span><span class="p">}</span>
</code></pre></div><p>简单追了一下这里面的流程，首先compatible_property_only是一个宏，定义如下</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span># Compatible property only
<span class="ln">2</span># SELinux rules which apply only to devices with compatible property
<span class="ln">3</span>#
<span class="ln">4</span>define(`compatible_property_only&#39;, ifelse(target_compatible_property, `true&#39;, $1,
<span class="ln">5</span>ifelse(target_compatible_property, `cts&#39;,
<span class="ln">6</span># BEGIN_COMPATIBLE_PROPERTY_ONLY -- this marker is used by CTS -- do not modify
<span class="ln">7</span>$1
<span class="ln">8</span># END_COMPATIBLE_PROPERTY_ONLY -- this marker is used by CTS -- do not modify
<span class="ln">9</span>, )))
</code></pre></div><p>值来源于target_compatible_property，这个值是前面提到的transform-policy-to-conf里面的变量传递进来的</p>
<div class="highlight"><pre class="chroma"><code class="language-makefile" data-lang="makefile"><span class="ln">1</span><span class="err">-D</span> <span class="nv">target_compatible_property</span><span class="o">=</span><span class="k">$(</span>PRIVATE_COMPATIBLE_PROPERTY<span class="k">)</span>
</code></pre></div><p>继续，值是从PRODUCT_COMPATIBLE_PROPERTY来的</p>
<div class="highlight"><pre class="chroma"><code class="language-makefile" data-lang="makefile"><span class="ln">1</span><span class="nv">PRIVATE_COMPATIBLE_PROPERTY</span> <span class="o">:=</span> <span class="k">$(</span>PRODUCT_COMPATIBLE_PROPERTY<span class="k">)</span>
</code></pre></div><p>往下</p>
<div class="highlight"><pre class="chroma"><code class="language-makefile" data-lang="makefile"><span class="ln"> 1</span><span class="c">#android/build/make/core/config.mk
</span><span class="ln"> 2</span><span class="c"></span> 
<span class="ln"> 3</span><span class="c"># Boolean variable determining if the whitelist for compatible properties is enabled
</span><span class="ln"> 4</span><span class="c"></span><span class="nv">PRODUCT_COMPATIBLE_PROPERTY</span> <span class="o">:=</span> <span class="nb">false</span>
<span class="ln"> 5</span><span class="err">ifneq</span> <span class="err">(</span><span class="k">$(</span><span class="nv">PRODUCT_COMPATIBLE_PROPERTY_OVERRIDE</span><span class="k">)</span><span class="err">,)</span>
<span class="ln"> 6</span>  <span class="nv">PRODUCT_COMPATIBLE_PROPERTY</span> <span class="o">:=</span> <span class="k">$(</span>PRODUCT_COMPATIBLE_PROPERTY_OVERRIDE<span class="k">)</span>
<span class="ln"> 7</span><span class="err">else</span> <span class="err">ifeq</span> <span class="err">(</span><span class="k">$(</span><span class="nv">PRODUCT_SHIPPING_API_LEVEL</span><span class="k">)</span><span class="err">,)</span>
<span class="ln"> 8</span>  <span class="c">#$(warning no product shipping level defined)
</span><span class="ln"> 9</span><span class="c"></span><span class="err">else</span> <span class="err">ifneq</span> <span class="err">(</span><span class="k">$(</span><span class="nv">call</span> <span class="nv">math_lt</span>,27,<span class="k">$(</span><span class="nv">PRODUCT_SHIPPING_API_LEVEL</span><span class="k">))</span><span class="err">,)</span>
<span class="ln">10</span>  <span class="nv">PRODUCT_COMPATIBLE_PROPERTY</span> <span class="o">:=</span> <span class="nb">true</span>
<span class="ln">11</span><span class="err">endif</span>
</code></pre></div><p>PRODUCT_COMPATIBLE_PROPERTY 的值默认为false，如果有PRODUCT_COMPATIBLE_PROPERTY_OVERRIDE，则用这个</p>
<p>然后是PRODUCT_SHIPPING_API_LEVEL</p>
<p>也就是说，PRODUCT_COMPATIBLE_PROPERTY 最后的值为false</p>
<p>所以前面的neverallow规则不会生效</p>
<p>再看看属性<code>ro.actionable_compatible_property.enabled</code>是怎么来的？</p>
<div class="highlight"><pre class="chroma"><code class="language-makefile" data-lang="makefile"><span class="ln">1</span><span class="c"># Sets ro.actionable_compatible_property.enabled to know on runtime whether the whitelist
</span><span class="ln">2</span><span class="c"># of actionable compatible properties is enabled or not.
</span><span class="ln">3</span><span class="c"></span><span class="err">ifeq</span> <span class="err">(</span><span class="k">$(</span><span class="nv">PRODUCT_ACTIONABLE_COMPATIBLE_PROPERTY_DISABLE</span><span class="k">)</span><span class="err">,true)</span>
<span class="ln">4</span><span class="nv">ADDITIONAL_DEFAULT_PROPERTIES</span> <span class="o">+=</span> ro.actionable_compatible_property.enabled<span class="o">=</span><span class="nb">false</span>
<span class="ln">5</span><span class="err">else</span>
<span class="ln">6</span><span class="nv">ADDITIONAL_DEFAULT_PROPERTIES</span> <span class="o">+=</span> ro.actionable_compatible_property.enabled<span class="o">=</span><span class="si">${</span><span class="nv">PRODUCT_COMPATIBLE_PROPERTY</span><span class="si">}</span>
<span class="ln">7</span><span class="err">endif</span>
</code></pre></div><p><code>PRODUCT_ACTIONABLE_COMPATIBLE_PROPERTY_DISABLE</code> 是空的没有定义，也是最后生成的值是false</p>
<p>追查了代码，发现原来以前BoardConfig.mk里面是有定义的</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="ln">1</span><span class="nl">PRODUCT_SHIPPING_API_LEVEL</span> <span class="p">:</span><span class="o">=</span> <span class="mi">28</span>
</code></pre></div><p>但是后面居然把这个去掉了？</p>
<p>PRODUCT_SHIPPING_API_LEVEL 这个会影响到一些neverallow规则</p>
<p>还会影响到这个属性<code>ro.product.first_api_level</code>的生成</p>
<h3 id="432抽离业务场景需求的公共权限">4.3.2抽离业务场景需求的公共权限</h3>
<p>或许我们会有一个疑问，就是为什么不把所有自己的脚本都用同一个安全上下文呢？</p>
<p>这的确是可行的方案，可以更加便捷的完成功能需求，但是从权限管控的初衷来看，分开了之后能够达到权限最小化；</p>
<p>在上面的思路基础上，引发了另一个想法：</p>
<p>定义一个自定义的属性，然后添加脚本的时候，关联上这个属性，就拥有了对应的权限了</p>
<p>比如：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>attribute testdomain;
</code></pre></div><p>testdomain.te里面定义一些公共的权限，比如：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>allow testdomain picasso_device:chr_file rw_file_perms;
<span class="ln">2</span>allow testdomain vendor_toolbox_exec:file { execute_no_trans };
<span class="ln">3</span>allow testdomain vendor_data_file:dir create_dir_perms;
<span class="ln">4</span>allow testdomain vendor_data_file:file create_file_perms;
</code></pre></div><p>然后在对应的type中关联属性</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback"><span class="ln">1</span>type testA, domain, testdomain;
</code></pre></div><p><strong>当然目前属于想法阶段，还没有具体实施，理论上可行</strong></p>
<h3 id="433三方apk的权限">4.3.3三方apk的权限</h3>
<p>对于第三方apk的权限问题，比如：</p>
<p>目前这个在系统端没有找到解决方案，只能从apk实现上入手了</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln">1</span><span class="o">[</span>   97.450511@1<span class="o">]</span> <span class="nv">type</span><span class="o">=</span><span class="m">1400</span> audit<span class="o">(</span>1623116538.872:18<span class="o">)</span>: avc: denied <span class="o">{</span> create <span class="o">}</span> <span class="k">for</span> <span class="nv">pid</span><span class="o">=</span><span class="m">3953</span> <span class="nv">comm</span><span class="o">=</span><span class="s2">&#34;testB&#34;</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;shpex98m.tmp&#34;</span> <span class="nv">scontext</span><span class="o">=</span>u:r:testB:s0 <span class="nv">tcontext</span><span class="o">=</span>u:object_r:system_data_file:s0 <span class="nv">tclass</span><span class="o">=</span>file <span class="nv">permissive</span><span class="o">=</span><span class="m">0</span>
</code></pre></div><p>这个是绕不过neverallow规则的</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="ln">1</span><span class="o">[</span>   45.533219@3<span class="o">]</span> <span class="nv">type</span><span class="o">=</span><span class="m">1400</span> audit<span class="o">(</span>1623985073.895:7<span class="o">)</span>: avc: denied <span class="o">{</span> execute <span class="o">}</span> <span class="k">for</span> <span class="nv">pid</span><span class="o">=</span><span class="m">4052</span> <span class="nv">comm</span><span class="o">=</span><span class="s2">&#34;bootloader&#34;</span> <span class="nv">path</span><span class="o">=</span><span class="s2">&#34;/data/data/com.xxxx.xxx/files/test/test.so&#34;</span> <span class="nv">dev</span><span class="o">=</span><span class="s2">&#34;mmcblk0p21&#34;</span> <span class="nv">ino</span><span class="o">=</span><span class="m">1085</span> <span class="nv">scontext</span><span class="o">=</span>u:r:system_app:s0 <span class="nv">tcontext</span><span class="o">=</span>u:object_r:system_app_data_file:s0 <span class="nv">tclass</span><span class="o">=</span>file <span class="nv">permissive</span><span class="o">=</span><span class="m">0</span>
</code></pre></div><p>到这里，基本上就介绍完了，总结来说，多看看代码，报错信息以及te文件里面的注释，能学到很多东西</p>
<p>能不动到原生的部分，就不要修改</p>
<h1 id="5名词解释">5名词解释</h1>
<table>
<thead>
<tr>
<th style="text-align:center">英文名次</th>
<th style="text-align:center">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>AVC</code></td>
<td style="text-align:center">Access Vector Cache访问向量缓存<!-- raw HTML omitted -->用于当一个subject要访问object时，selinux执行检查AVC中，subject和object的权限被缓存</td>
</tr>
<tr>
<td style="text-align:center"><code>CTS</code></td>
<td style="text-align:center">Compatibility Test Suite（兼容性测试）<!-- raw HTML omitted -->Android设备只有满足规定并且通过CTS，才能获得Android的商标和享受Android Market的权限</td>
</tr>
<tr>
<td style="text-align:center"><code>DAC</code></td>
<td style="text-align:center">DAC：Discretionary Access Control 自主访问控制</td>
</tr>
<tr>
<td style="text-align:center"><code>LSM</code></td>
<td style="text-align:center">Linux Security Modules (LSM) 是一种 Linux 内核子系统<!-- raw HTML omitted -->旨在将内核以模块形式集成到各种安全模块中</td>
</tr>
<tr>
<td style="text-align:center"><code>MAC</code></td>
<td style="text-align:center">MAC：Mandatory Access Control 强制访问控制</td>
</tr>
<tr>
<td style="text-align:center"><code>MLS</code></td>
<td style="text-align:center">Multi-Level Security,多层次的安全<!-- raw HTML omitted -->系统的进程和文件进行了分级，不同级别的资源需要对应级别的进程才能访问</td>
</tr>
<tr>
<td style="text-align:center"><code>SElinux</code></td>
<td style="text-align:center">SELinux(Security-Enhanced Linux) 安全增强型linux子系统<!-- raw HTML omitted -->在这种访问控制体系的限制下，进程只能访问那些在他的任务中所需要文件</td>
</tr>
<tr>
<td style="text-align:center"><code>TE</code></td>
<td style="text-align:center">TE （Type Enforcement）强制类型<!-- raw HTML omitted -->基本管理单位是TEAC（Type Enforcement Accesc Control），源码中存在TE文件，这些文件是用于制定策略规则的</td>
</tr>
</tbody>
</table>
<h1 id="转载说明">转载说明</h1>
<p>本文非原创，主要是转载<strong>headwind</strong>的文章内容，在加上稍微的修改。</p>
<h1 id="参考">参考</h1>
<p><a href="https://juejin.cn/post/7126884870999474184">[1] nianxing123, 【安卓】SELinux走过的坑, 2022.</a></p>
<p><a href="https://blog.csdn.net/u014135607/article/details/78697587">[2] 沉默的过客, SELinux策略语言–客体类别和许可, 2017.</a></p>
<p><a href="https://blog.csdn.net/Luoshengyang/article/details/37613135">[3] 罗升阳, SEAndroid安全机制框架分析, 2014.</a></p>
<p><a href="https://headwind.blog.csdn.net/article/details/119704755">[4] headwind_, Android P SELinux (一) 基础概念, 2021.</a></p>
<p><a href="https://headwind.blog.csdn.net/article/details/119707417">[5] headwind_, Android P SELinux (二) 开机初始化与策略文件编译过程, 2021.</a></p>
<p><a href="https://headwind.blog.csdn.net/article/details/119709982">[6] headwind_, Android P SELinux (三) 权限检查原理与调试, 2022.</a></p>
<p><a href="https://headwind.blog.csdn.net/article/details/119711869">[7] headwind_, Android P SELinux (四) CTS neverallow处理总结, 2022.</a></p>
<p><a href="https://blog.csdn.net/tkwxty/article/details/104538447">[8] IT先森, Android SELinux开发入门指南之SELinux基础知识, 2020.</a></p>
<p><a href="https://blog.csdn.net/tkwxty/article/details/103938287">[9] IT先森, 正确姿势临时和永久开启关闭Android的SELinux, 2020.</a></p>
<p><a href="https://blog.csdn.net/fhaitao900310/article/details/108868103">[10] 冯疯子, 谈谈Android 安全策略SElinux, 2020.</a></p>
<p><a href="https://juejin.cn/post/7051154021200953357">[11] 五菱宏光8PLUS, Android 添加 SELinux权限, 2022.</a></p>
<p><a href="https://juejin.cn/post/6844903813195759624">[12] Android开发实践, Android安全策略Selinux小结, 2019.</a></p>
<p><a href="https://cloud.tencent.com/developer/article/1730613">[13] 砸漏, 详解Android Selinux 权限及问题, 2020.</a></p>
<p><a href="https://www.cnblogs.com/blogs-of-lxl/p/7515023.html">[14] sheldon_blogs, Android : SELinux 简析&amp;修改 , 2017.</a></p>
<p><a href="https://www.pianshen.com/article/1843146239/">[15] 程序员大本营, SELinux简介, 2018.</a></p>
<p><a href="https://blog.csdn.net/weixin_42082222/article/details/85239018">[16] markvz, SELinux简介, 2018.</a></p>
<p><a href="https://blog.csdn.net/ch853199769/article/details/82498725">[17] 安德路, android sepolicy 最新小结, 2018.</a></p>
<p><a href="%5Bmiroku_it%5D(https://blog.csdn.net/miroku_it)">[18] miroku_it, SELinux策略配置语言, 2009.</a></p>
<p><a href="https://blog.csdn.net/qq_19923217/article/details/81240027">[19] 岁月斑驳7, android 8.1 安全机制 — SEAndroid &amp; SELinux, 2018.</a></p>
<p><a href="https://blog.csdn.net/q1183345443/article/details/90438283">[20] _dowork, SELinux audit2allow命令使用, 2019.</a></p>
<p><a href="https://blog.csdn.net/Donald_Zhuang/article/details/108786482">[21] Donald_Zhuang, selinux dac_override/dac_read_search问题处理思路, 2020.</a></p>
<p><a href="https://m.sohu.com/a/141709117_467784/?pvid=000115_3w_a">[22] linux内核之旅, Linux多安全策略和动态安全策略框架模块代码分析报告(14), 2017.</a></p>
<p><a href="https://blog.csdn.net/l173864930/article/details/17194899">[23] Boyliang1987, SEAndroid策略, 2013.</a></p>
<p><a href="https://mp.weixin.qq.com/s/mdDLw6AIp9ws9LTaHg64pg">[24] KINGYT, 精致全景图 | linux内核输出的日志去哪里了, 2021.</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/406631271?utm_id=0">[25] 小武, kmsg日志的存储与读取, 2021.</a></p>
<p><a href="https://blog.csdn.net/jimbo_lee/article/details/51593513">[26] jimbo_lee, 常用正则表达式大全 &ndash; 正则表达式基本语法, 2011.</a></p>
<p><a href="https://blog.csdn.net/qq_41663117/article/details/117411597">[27] Sherry Baron, Android.mk(持续补充中哦！！！), 2021.</a></p>
<p><a href="https://weibo01.blog.csdn.net/article/details/115582646">[28] 魏波., Makefile_03：Makefile介绍（作用、例子、原理）, 2022.</a></p>
<p><a href="https://blog.csdn.net/kc58236582/article/details/49795865">[29] kc专栏, Android.mk 小细节（LOCAL_CFLAGS 、BUILD_PREBUILT）, 2015.</a></p>
<p><a href="https://blog.csdn.net/hjxu2016/article/details/101699484">[30] hjxu2016, Makefile入门二、理解$@、$^和$&lt;, 2019.</a></p>
<p><a href="https://blog.csdn.net/liwugang43210/article/details/103754878">[31] 「已注销」, Android CTS中neverallow规则生成过程, 2019.</a></p>
<p><a href="https://blog.csdn.net/ch853199769/article/details/82501078">[32] 安德路, Android sepolicy简要记, 2018.</a></p>
<p><a href="https://blog.csdn.net/ch853199769/article/details/82498725">[33] 安德路, android sepolicy 最新小结, 2018.</a></p>
<p><a href="https://blog.csdn.net/keheinash/article/details/99692988">[34] 铁桶小分队, SEAndroid的MLS相关知识以及配置方法, 2019.</a></p>
<p><a href="https://blog.csdn.net/WSRspirit/article/details/26398883">[35] wsrspirit, 从【SELINUX】策略中学习【LSM】编写规则, 2014.</a></p>
<p><a href="https://www.cnblogs.com/cslunatic/p/3709356.html">[36] CSlunatic, Linux Security模块, 2014.</a></p>
<p><a href="https://blog.csdn.net/mrhare/article/details/71215391">[37] MrHare, SEAndroid kernel层源码解析1——从hook点到策略点, 2017.</a></p>
<p><a href="https://blog.csdn.net/MrHare/article/details/71405139">[38] MrHare, SEAndroid kernel 源码解析2&ndash;策略执行, 2017.</a></p>
<p><a href="https://blog.csdn.net/k663514387/article/details/107983037">[39] InsightAndroid, selinux常见neverallow项解决方法与常用命令, 2020.</a></p>
<h1 id="其他参考">其他参考</h1>
<h2 id="1学习本文内容最好先阅读下面selinux文章">1<strong>学习本文内容最好先阅读下面SElinux文章</strong></h2>
<p><a href="https://blog.csdn.net/innost/article/details/19299937">[1] 阿拉神农, 深入理解SELinux SEAndroid（第一部分）, 2014.</a></p>
<p><a href="https://blog.csdn.net/innost/article/details/19641487">[2] 阿拉神农, 深入理解SELinux SEAndroid之二, 2014.</a></p>
<p><a href="https://blog.csdn.net/innost/article/details/19767621">[3] 阿拉神农, 深入理解SELinux SEAndroid（最后部分）, 2014.</a></p>
<p><a href="http://lishiwen4.github.io/android/selinux-security-context">[4] sven, SELinux 安全上下文, 2015.</a></p>
<p><a href="https://blog.csdn.net/bruk_spp/article/details/107283935">[5] bruk_spp, selinux源码分析, 2020.</a></p>
<p><a href="https://blog.csdn.net/qq_19923217/article/details/81240027">[6] 岁月斑驳7, android 8.1 安全机制 — SEAndroid &amp; SELinux, 2018.</a></p>
<p><a href="https://blog.csdn.net/Luoshengyang/article/details/38326729">[7] 罗升阳, SEAndroid安全机制对Binder IPC的保护分析, 2014.</a></p>
<p><a href="https://blog.csdn.net/Luoshengyang/article/details/38102011">[8] 罗升阳, SEAndroid安全机制对Android属性访问的保护分析, 2014.</a></p>
<p><a href="https://blog.csdn.net/luoshengyang/article/details/38054645">[9] 罗升阳, SEAndroid安全机制中的进程安全上下文关联分析, 2014.</a></p>
<p><a href="https://blog.csdn.net/Luoshengyang/article/details/37749383">[10] 罗升阳, SEAndroid安全机制中的文件安全上下文关联分析, 2014.</a></p>
<p><a href="https://blog.csdn.net/Luoshengyang/article/details/37613135">[11] 罗升阳, SEAndroid安全机制框架分析, 2014.</a></p>
<p><a href="https://blog.csdn.net/Luoshengyang/article/details/35392905">[12] 罗升阳, SEAndroid安全机制简要介绍和学习计划, 2014.</a></p>
<h2 id="2文章通用参考汇总">2<strong>文章通用参考汇总</strong></h2>
<p><a href="https://blog.csdn.net/huangyabin001/article/details/79290382">[1] 高桐@BILL, Android8.0 SELinux详解, 2018.</a></p>
<p><a href="https://segmentfault.com/a/1190000021550665">[2] 戈壁老王, Android Treble 简介, 2020.</a></p>
<p><a href="https://blog.csdn.net/u013357557/article/details/113893751">[3] Gunder, SeLinux权限配置心得总结, 2021.</a></p>
<p><a href="https://www.cnblogs.com/fanglongxiang/p/13306088.html">[4] 流浪_归家, SELinux avc 权限问题修改, 2020.</a></p>
<p><a href="https://blog.csdn.net/tung214/article/details/72734086">[5] 缥缈孤鸿影_love, Android SELinux avc dennied权限问题解决方法, 2017.</a></p>
<p><a href="https://blog.csdn.net/qq_19923217/article/details/83820902">[6] 岁月斑驳7, Android 8.1 非系统进程设置系统域属性问题, 2018.</a></p>
<p><a href="https://lixiaogang03.github.io/2019/03/28/Android-Selinux/">[7] 李晓刚, Android Selinux, 2019.</a></p>
<p><a href="https://www.jb51.net/article/128214.htm">[8] Andy.Lee , 详解Android Selinux 权限及问题, 2017.</a></p>
<p><a href="https://peter.blog.csdn.net/article/details/111570144">[9] 布道师Peter, Selinux 权限问题解决方案, 2020.</a></p>
<p><a href="https://blog.csdn.net/qq_34211365/article/details/106056873">[10] DJLZPP, 访问文件的SELINUX权限添加, 2020.</a></p>
<p><a href="https://blog.csdn.net/qq_33242956/article/details/101421189">[11] 花一样的阿衰, SElinux权限配置, 2020.</a></p>
<p><a href="https://www.wpgdadatong.com/cn/blog/detail?BID=B2206">[12] 飞车侠, i.MX8 系列 | Android APP 访问硬件驱动可以这样做！, 2020.</a></p>
<p><a href="http://qiushao.net/2019/12/20/Android%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%91%E5%85%A5%E9%97%A8/7-%E6%B7%BB%E5%8A%A0java%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1/">[13] 秋少, Android系统开发入门-7.添加java层系统服务, 2019.</a></p>
<p><a href="http://www.mamicode.com/info-detail-2532042.html">[14] gaon5, Android : 为系统服务添加 SELinux 权限 (Android 9.0), 2018.</a></p>
<p><a href="https://lixiaogang03.github.io/2020/11/12/Android-R-Selinux/">[15] 李晓刚, Android R Selinux, 2020.</a></p>
<p><a href="https://blog.csdn.net/zmnqazqaz/article/details/76130202">[16] 守望尼罗河畔的初心, Android7.1 Selinux使用, 2017.</a></p>
<p><a href="https://blog.csdn.net/diaoxuesong/article/details/104572033">[17] CedarDiao, Android9 Sepolicy规则基础 - MTK平台, 2020.</a></p>
<p><a href="https://www.jianshu.com/p/e95cd0c17adc">[18] 锄禾豆, Android 9 SELinux, 2018.</a></p>
<p><a href="http://sniffer.site/2019/12/07/Selinux%E5%9C%A8Android%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8/">[19] JasonWan, SELinux在Android中的应用, 2019.</a></p>
<p><a href="http://www.gandalf.site/2019/02/androidseandroid.html">[20] gandalf, Android（十）SEAndroid初探, 2019.</a></p>
<p><a href="https://www.cnblogs.com/blogs-of-lxl/p/7515023.html">[21] sheldon, Android : SELinux 简析&amp;修改, 2017.</a></p>
<p><a href="https://wertherzhang.com/seandroid%E8%A7%84%E5%88%99%E4%BB%8B%E7%BB%8D/">[22] werther zhang, SEAndroid规则介绍, 2017.</a></p>
<p><a href="android%E5%90%AF%E5%8A%A8%E8%84%9A%E6%9C%AC-selinux(%E5%AE%9E%E8%B7%B5)">[23] xuefeng_apple, android启动脚本-selinux(实践), 2020.</a></p>
<p><a href="https://www.jianshu.com/p/a3572eee341c">[24] 恶魔殿下_HIM, Android的安全机制（SEANDROID）, 2016.</a></p>
<p><a href="https://blog.csdn.net/kc58236582/article/details/46723333">[25] kc专栏, SeLinux语法规则, 2015.</a></p>
<p><a href="https://blog.csdn.net/u014135607/article/details/78697587">[26] 沉默的过客, SELinux策略语言–客体类别和许可, 2017.</a></p>
<p><a href="https://blog.csdn.net/zxc024000/article/details/88389657">[27] 林多, SELinux MAC安全机制简介, 2019.</a></p>
<p>[[28] SinoTech, Android R Selinux, 2018.](为 Android 8.0 添加开机启动脚本)</p>
<p><a href="https://www.jianshu.com/p/5fe2e6d730b8?utm_campaign=maleskine&amp;utm_content=note&amp;utm_medium=seo_notes&amp;utm_source=recommendation">[29] MickCaptain, Android 8.1添加系统服务,sepolicy相关配置, 2019.</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/30406415">[30] SinoTech, 在 Android 8.0 中绕过 hwbinder 实现跨模块对 audio HAL 调用, 2017.</a></p>
<p><a href="https://blog.csdn.net/xbalien29/article/details/19505575">[31] xbalien, SEAndroid策略, 2014.</a></p>
<p><a href="https://blog.csdn.net/tww85/article/details/52451606">[32] tww85, 对Android 平台下SElinux的理解及遇到过的相关问题解决方法总结, 2016.</a></p>
<p><a href="https://segmentfault.com/a/1190000012780150">[33] wydong, SELinux与SEAndroid, 2018.</a></p>
<p><a href="https://blog.csdn.net/duan_xiaosu/article/details/103251903">[34] 段小苏学习之路, Android有关selinux详解, 2019.</a></p>
<p><a href="https://www.cnblogs.com/startkey/articles/9931669.html">[35] 不上班行不行, SEAndroid系统架构总体分析, 2018.</a></p>
<p><a href="https://blog.csdn.net/QWE123ZXCZ/article/details/84955034">[36] 亚洲第一蓝胖子, android中SELINUX规则分析和语法简介, 2018.</a></p>
<p><a href="https://blog.csdn.net/qq_28351465/article/details/107431232">[37] Zpeg, selinux - Android编写sepolicy, 2020.</a></p>
<p><a href="https://blog.csdn.net/doubleghost2010/article/details/70238037">[39] 光明之门, SELinux&amp;SEAndroid简介, 2017.</a></p>
<p><a href="https://blog.csdn.net/tkwxty/article/details/104039681">[39] IT先森,  Android SELinux开发入门指南之正确姿势解决访问data目录权限问题, 2020.</a></p>
<p><a href="https://blog.csdn.net/yxw0609131056/article/details/79784490">[40] 渴望成长的菜鸟, Android O selinux违反Neverallow解决办法, 2018.</a></p>
<p><a href="https://blog.csdn.net/kc58236582/article/details/50537782">[41] kc专栏, Android6.0 selinux没有对某个文件的权限（又neverAllow）处理方法, 2016.</a></p>
<p><a href="https://wiki.gentoo.org/wiki/SELinux/Quick_introduction">[42] 维基百科, SELinux/Quick introduction, 2021.</a></p>
<p><a href="https://juejin.cn/post/6844903568747544584">[43] foxleezh, (连载)Android 8.0 : 系统启动流程之init进程(一), 2018.</a></p>
<p><a href="https://blog.51cto.com/u_2559640/2410131">[44] xiaozhuangzi, selinux label的初始化过程, 2019.</a></p>
<p><a href="http://huzhengyu.com/2018/06/08/APP-Category-In-Selinux/">[45] Ryan, Selinux中的APP分类, 2018.</a></p>
<p><a href="https://blog.csdn.net/zhudaozhuan/article/details/50964832">[46] zhudaozhuan, SELinux app权限配置, 2016.</a></p>
<p><a href="https://cloud.tencent.com/developer/article/1742749">[47] 砸漏, Android 7.0 SEAndroid app权限配置方法, 2020.</a></p>
<p><a href="https://blog.csdn.net/wxh0000mm/article/details/94456071">[48] 子曰小玖, Selinux梳理总结, 2019.</a></p>
<p><a href="https://blog.csdn.net/u014470361/article/details/81193023">[49] 夜风~, linux内核中likely与unlikely, 2018.</a></p>
<p><a href="https://blog.csdn.net/Decisiveness/article/details/45049875">[50] Decisiveness, Linux内核中的IS_ERR()、PTR_ERR()和ERR_PTR(), 2015.</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/120812270">[51] 扬眉, Flex(scanner)/Bison(parser)词法语法分析工作原理, 2022.</a></p>
<p><a href="http://blog.chinaunix.net/uid-28362602-id-3424404.html">[52] up哥小号, Linux 编程中的API函数和系统调用的关系, 2012.</a></p>
<p><a href="http://blog.chinaunix.net/uid-25968088-id-3426026.html">[53] wenyubo_2008, Linux 中open系统调用实现原理, 2012.</a></p>
<p><a href="https://blog.csdn.net/feixin620/article/details/78416560">[54] feixin620, linux syscall 详解, 2017.</a></p>
<p><a href="http://onestraw.github.io/linux/linux-struct-cred/">[55] Xiaowei He, Linux 进程安全上下文 struct cred, 2022.</a></p>
<p><a href="https://blog.csdn.net/Morphad/article/details/9089601">[56] Morphad, linux cred管理, 2013.</a></p>
<p><a href="https://blog.csdn.net/YuZhiHui_No1/article/details/39939241">[57] 庾志辉, openVswitch（OVS）源代码分析之工作流程（哈希桶结构体的解释）, 2014.</a></p>
<p><a href="https://blog.csdn.net/yuzhihui_no1/article/details/39558815">[58] 庾志辉, openVswitch（OVS）源代码的分析技巧（哈希桶结构体为例）, 2014.</a></p>
<p><a href="https://happybevis.github.io/2018/05/02/The-Magic-Selinux-Restore-Rule/">[59] Happybevis, 神奇的Selinux Restore Rule, 2018.</a></p>
<h2 id="3linux强制访问控制机制模块代码分析报告">3《Linux强制访问控制机制模块代码分析报告》</h2>
<p><a href="https://www.sohu.com/a/135967369_467784">[1] linux内核之旅, Linux强制访问控制机制模块代码分析报告（一）, 2017.</a></p>
<p><a href="https://www.sohu.com/a/136011893_467784">[2] linux内核之旅, Linux强制访问控制机制模块代码分析报告（二）, 2017.</a></p>
<p><a href="https://www.sohu.com/a/136288365_467784">[3] linux内核之旅, Linux强制访问控制机制模块代码分析报告（三）, 2017.</a></p>
<p><a href="https://www.sohu.com/a/136482060_467784">[4] linux内核之旅, Linux强制访问控制机制模块代码分析报告（四）, 2017.</a></p>
<p><a href="https://www.sohu.com/a/136639046_467784">[5] linux内核之旅, Linux强制访问控制机制模块代码分析报告（五）, 2017.</a></p>
<p><a href="http://www.safebase.cn/article-231024-1.html">[6] linux内核之旅, Linux强制访问控制机制模块代码分析报告（六）, 2017.</a></p>
<p><a href="https://www.sohu.com/a/137347468_467784">[7] linux内核之旅, Linux强制访问控制机制模块代码分析报告（七）, 2017.</a></p>
<p><a href="https://www.sohu.com/a/137512129_467784">[8] linux内核之旅, Linux强制访问控制机制模块代码分析报告（八）, 2017.</a></p>
<p><a href="https://www.sohu.com/a/137888523_467784">[9] linux内核之旅, Linux强制访问控制机制模块代码分析报告（九）, 2017.</a></p>
<p><a href="https://www.sohu.com/a/137888531_467784">[10] linux内核之旅, Linux强制访问控制机制模块代码分析报告（十）, 2017.</a></p>
<p><a href="https://www.sohu.com/a/138185447_467784">[11] linux内核之旅, Linux强制访问控制机制模块代码分析报告（十一）, 2017.</a></p>
<h2 id="4linux多安全策略和动态安全策-略框架模块代码分析报告">4《Linux多安全策略和动态安全策 略框架模块代码分析报告》</h2>
<p><a href="https://www.sohu.com/a/138580970_467784">[1] linux内核之旅, Linux多安全策略和动态安全策 略框架模块代码分析报告(1) , 2017.</a></p>
<p><a href="http://www.safebase.cn/article-231245-1.html">[2] linux内核之旅, Linux多安全策略和动态安全策 略框架模块代码分析报告(2) , 2017.</a></p>
<p><a href="https://www.sohu.com/a/138804853_467784">[3] linux内核之旅, Linux多安全策略和动态安全策 略框架模块代码分析报告(3) , 2017.</a></p>
<p><a href="https://www.sohu.com/a/138976820_467784">[4] linux内核之旅, Linux多安全策略和动态安全策 略框架模块代码分析报告(4) , 2017.</a></p>
<p><a href="http://www.voidcn.com/article/p-sfquuwtm-wk.html">[5] linux内核之旅, Linux多安全策略和动态安全策 略框架模块代码分析报告(5) , 2017.</a></p>
<p><a href="https://www.sohu.com/a/139413489_467784">[6] linux内核之旅, Linux多安全策略和动态安全策 略框架模块代码分析报告(6) , 2017.</a></p>
<p><a href="https://www.sohu.com/a/139709740_467784">[7] linux内核之旅, Linux多安全策略和动态安全策 略框架模块代码分析报告(7) , 2017.</a></p>
<p><a href="https://www.sohu.com/a/139973785_467784">[8] linux内核之旅, Linux多安全策略和动态安全策 略框架模块代码分析报告(8) , 2017.</a></p>
<p><a href="http://www.voidcn.com/article/p-xhablags-wk.html">[9] linux内核之旅, Linux多安全策略和动态安全策 略框架模块代码分析报告(9) , 2017.</a></p>
<p><a href="http://www.voidcn.com/article/p-uwdtubpm-wk.html">[10] linux内核之旅, Linux多安全策略和动态安全策 略框架模块代码分析报告(10) , 2017.</a></p>
<p><a href="https://www.sohu.com/a/140884205_467784">[11] linux内核之旅, Linux多安全策略和动态安全策 略框架模块代码分析报告(11) , 2017.</a></p>
<p><a href="http://www.voidcn.com/article/p-tkroeamc-wk.html">[12] linux内核之旅, Linux多安全策略和动态安全策 略框架模块代码分析报告(12) , 2017.</a></p>
<p><a href="https://www.sohu.com/a/141414625_467784">[13] linux内核之旅, Linux多安全策略和动态安全策 略框架模块代码分析报告(13) , 2017.</a></p>
<p><a href="https://www.sohu.com/a/141709117_467784">[14] linux内核之旅, Linux多安全策略和动态安全策 略框架模块代码分析报告(14) , 2017.</a></p>
<p><a href="https://m.sohu.com/a/142034082_467784/">[15] linux内核之旅, Linux多安全策略和动态安全策 略框架模块代码分析报告(15) , 2017.</a></p>
<p><a href="http://www.voidcn.com/article/p-ksphumbr-wk.html">[16] linux内核之旅, Linux多安全策略和动态安全策 略框架模块代码分析报告(16) , 2017.</a></p>
<p><a href="https://www.sohu.com/a/142438688_467784">[17] linux内核之旅, Linux多安全策略和动态安全策 略框架模块代码分析报告(17) , 2017.</a></p>
<p><a href="http://www.voidcn.com/article/p-blaxfzwg-wk.html">[18] linux内核之旅, Linux多安全策略和动态安全策 略框架模块代码分析报告(18) , 2017.</a></p>
<p><a href="http://www.voidcn.com/article/p-gfifderx-wk.html">[19] linux内核之旅, Linux多安全策略和动态安全策 略框架模块代码分析报告(19) , 2017.</a></p>
<p><a href="https://m.sohu.com/a/143323077_467784/">[20] linux内核之旅, Linux多安全策略和动态安全策 略框架模块代码分析报告(20) , 2017.</a></p>
<p><a href="http://www.voidcn.com/article/p-eoijaouz-wk.html">[21] linux内核之旅, Linux多安全策略和动态安全策 略框架模块代码分析报告(21) , 2017.</a></p>
<p><a href="https://www.sohu.com/a/143971000_467784">[22] linux内核之旅, Linux多安全策略和动态安全策 略框架模块代码分析报告(22) , 2017.</a></p>
<p><a href="http://www.voidcn.com/article/p-zfzucopl-wk.html">[23] linux内核之旅, Linux多安全策略和动态安全策 略框架模块代码分析报告(23) , 2017.</a></p>
<h2 id="5fs_use_xattr">5fs_use_xattr</h2>
<p><a href="https://blog.csdn.net/l173864930/article/details/17194899">[1] Boyliang1987, SEAndroid策略, 2013.</a></p>
<p><a href="https://blog.csdn.net/keheinash/article/details/78507063">[2] 铁桶小分队, 预设置只读文件系统squashfs上的文件的扩展属性的方法, 2017.</a></p>
<h2 id="6dac_override">6dac_override</h2>
<p><a href="https://blog.csdn.net/pwl999/article/details/110878563">[1] pwl999, Linux DAC 权限管理详解, 2020.</a></p>
<p><a href="https://sx.ix5.org/info/post/debugging-dac_override/">[2] Open Devices Corner, Debugging DAC_OVERRIDE, 2019.</a></p>
<p><a href="https://gohalo.me/post/linux-capabilities-introduce.html">[3] 悟空小饭, Linux Capabilites 机制详细介绍, 2018.</a></p>
<p><a href="https://blog.csdn.net/Donald_Zhuang/article/details/108786482">[4] Donald_Zhuang, selinux dac_override/dac_read_search问题处理思路, 2020.</a></p>
<p><a href="https://blog.csdn.net/shichaog/article/details/53728893">[5] shichaog, Selinux 权限策略定制, 2016.</a></p>
<p><a href="https://blog.csdn.net/bhghost/article/details/47312861">[6] 大江之舞, SELinux: capabilites{dac_override} 权限, 2015.</a></p>
<h2 id="7android-用户组">7android 用户组</h2>
<p><a href="https://blog.csdn.net/yangxuehui1990/article/details/41891263">[1] CarolineVampire, Android用户和用户组的定义, 2014.</a></p>
<p><a href="https://blog.csdn.net/u013686019/article/details/52753727/">[2] <code>__2017__</code>, Android添加用户组及自定义App权限, 2016.</a></p>
<p><a href="https://blog.csdn.net/pen_cil/article/details/89434349">[3] Kian_G, Android P SElinux权限调试, 2019.</a></p>
              
            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">标签</span><br/>
                    
  <a class="tag tag--primary tag--small" href="https://yangyang48.github.io/tags/dac/">DAC</a>

  <a class="tag tag--primary tag--small" href="https://yangyang48.github.io/tags/mac/">MAC</a>

  <a class="tag tag--primary tag--small" href="https://yangyang48.github.io/tags/te/">TE</a>

  <a class="tag tag--primary tag--small" href="https://yangyang48.github.io/tags/avc/">avc</a>

  <a class="tag tag--primary tag--small" href="https://yangyang48.github.io/tags/cts/">cts</a>

  <a class="tag tag--primary tag--small" href="https://yangyang48.github.io/tags/%E6%BA%90%E7%A0%81/">源码</a>

  <a class="tag tag--primary tag--small" href="https://yangyang48.github.io/tags/makefile/">makefile</a>

  <a class="tag tag--primary tag--small" href="https://yangyang48.github.io/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/">正则表达式</a>

                  </div>
                
              
            
            <div class="post-actions-wrap">
  
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://yangyang48.github.io/2023/02/linux%E7%9A%84tcp/ip%E5%8D%8F%E8%AE%AE%E6%A0%88%E5%8F%91%E9%80%81%E8%BF%87%E7%A8%8B/" data-tooltip="Linux的TCP/IP协议栈发送过程">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">下一篇</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://yangyang48.github.io/2023/01/android-nenative-exception/" data-tooltip="Android NE（Native Exception）">
              
                  <span class="hide-xs hide-sm text-small icon-mr">上一篇</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#disqus_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#">
        
          <i class="fa fa-list"></i>
        </a>
      </li>
    </ul>
  
</div>

            
              
                <div id="disqus_thread">
  <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
              
            
          </div>
        </article>
		
		<div class="post-comment main-content-wrap">
		
  
  <div id="vcomments"></div>
  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src='//unpkg.com/valine/dist/Valine.min.js'></script>
  <script type="text/javascript">
    new Valine({
        el: '#vcomments' ,
        appId: 'mwl8M1aQzLnRE6JIpIY3sgE5-9Nh9j0Va',
        appKey: 'mPGr6GMC0BuzAKkxinnd0IAr',
        notify:  true , 
        verify:  false , 
        avatar:'retro', 
        placeholder: '欢迎各位宝宝留言~',
        visitor:  true 
    });
  </script>

		</div>
        <footer id="footer" class="main-content-wrap">
  
  
  
  <span class="copyrights">
    &copy; 2023 Yang Ju. All Rights Reserved
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
        <div class="post-actions-wrap">
  
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://yangyang48.github.io/2023/02/linux%E7%9A%84tcp/ip%E5%8D%8F%E8%AE%AE%E6%A0%88%E5%8F%91%E9%80%81%E8%BF%87%E7%A8%8B/" data-tooltip="Linux的TCP/IP协议栈发送过程">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">下一篇</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://yangyang48.github.io/2023/01/android-nenative-exception/" data-tooltip="Android NE（Native Exception）">
              
                  <span class="hide-xs hide-sm text-small icon-mr">上一篇</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#disqus_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#">
        
          <i class="fa fa-list"></i>
        </a>
      </li>
    </ul>
  
</div>

      </div>
      <div id="share-options-bar" class="share-options-bar" data-behavior="4">
  <i id="btn-close-shareoptions" class="fa fa-close"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fyangyang48.github.io%2F2023%2F01%2F%25E4%25B8%2580%25E6%2596%2587%25E5%25B8%25A6%25E4%25BD%25A0%25E4%25BA%2586%25E8%25A7%25A3selinux%25E9%2582%25A3%25E7%2582%25B9%25E4%25BA%258B%2F">
          <i class="fa fa-facebook-official"></i><span>分享到 Facebook</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=https%3A%2F%2Fyangyang48.github.io%2F2023%2F01%2F%25E4%25B8%2580%25E6%2596%2587%25E5%25B8%25A6%25E4%25BD%25A0%25E4%25BA%2586%25E8%25A7%25A3selinux%25E9%2582%25A3%25E7%2582%25B9%25E4%25BA%258B%2F">
          <i class="fa fa-twitter"></i><span>分享到 Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=https%3A%2F%2Fyangyang48.github.io%2F2023%2F01%2F%25E4%25B8%2580%25E6%2596%2587%25E5%25B8%25A6%25E4%25BD%25A0%25E4%25BA%2586%25E8%25A7%25A3selinux%25E9%2582%25A3%25E7%2582%25B9%25E4%25BA%258B%2F">
          <i class="fa fa-google-plus"></i><span>分享到 Google&#43;</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>
    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="https://img-blog.csdnimg.cn/20210711204627625.jpg" alt="作者的图片" />
    
    <h4 id="about-card-name">Yang Ju</h4>
    
      <div id="about-card-bio">Nanjing University of Science and Technology</div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Software Development Engineer
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        NanJing,China
      </div>
    
  </div>
</div>

    

    
  
    
      <div id="cover" style="background-image:url('https://yangyang48.github.io/images/cover.jpg');"></div>
    
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.7/js/jquery.fancybox.min.js" integrity="sha256-GEAnjcTqVP+vBp3SSc8bEDQqvWAZMiHyUSIorrWwH50=" crossorigin="anonymous"></script>


<script src="https://yangyang48.github.io/js/script-pcw6v3xilnxydl1vddzazdverrnn9ctynvnxgwho987mfyqkuylcb1nlt.min.js"></script>


  
    <script src="https://yangyang48.github.io/js/copy-to-clipboard.js"></script>
  

<script lang="javascript">
window.onload = updateMinWidth;
window.onresize = updateMinWidth;
document.getElementById("sidebar").addEventListener("transitionend", updateMinWidth);
function updateMinWidth() {
  var sidebar = document.getElementById("sidebar");
  var main = document.getElementById("main");
  main.style.minWidth = "";
  var w1 = getComputedStyle(main).getPropertyValue("min-width");
  var w2 = getComputedStyle(sidebar).getPropertyValue("width");
  var w3 = getComputedStyle(sidebar).getPropertyValue("left");
  main.style.minWidth = `calc(${w1} - ${w2} - ${w3})`;
}
</script>

<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>


  
    
      <script>
        var disqus_config = function () {
          this.page.url = 'https:\/\/yangyang48.github.io\/2023\/01\/%E4%B8%80%E6%96%87%E5%B8%A6%E4%BD%A0%E4%BA%86%E8%A7%A3selinux%E9%82%A3%E7%82%B9%E4%BA%8B\/';
          
            this.page.identifier = '\/2023\/01\/%E4%B8%80%E6%96%87%E5%B8%A6%E4%BD%A0%E4%BA%86%E8%A7%A3selinux%E9%82%A3%E7%82%B9%E4%BA%8B\/'
          
        };
        (function() {
          
          
          if (window.location.hostname == "localhost") {
            return;
          }
          var d = document, s = d.createElement('script');
          var disqus_shortname = 'hugo-tranquilpeak-theme';
          s.src = '//' + disqus_shortname + '.disqus.com/embed.js';

          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();
      </script>
    
  




    
  </body>
</html>

