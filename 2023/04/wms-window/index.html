<!DOCTYPE html>
<html lang="en-us">
  <head>
    
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Hugo 0.85.0 with theme Tranquilpeak 0.4.8-BETA">
<meta name="author" content="Yang Ju">
<meta name="keywords" content="">
<meta name="description" content="Android framework层离不开AMS、WMS、PMS等，其中WMS中Window这个概念比较抽象，且很多博客作者写了很多关于Window的文章，我个人感觉还缺点什么，本文尽可能通过通俗易懂的方式来描述（android11和13源码）。">


<meta property="og:description" content="Android framework层离不开AMS、WMS、PMS等，其中WMS中Window这个概念比较抽象，且很多博客作者写了很多关于Window的文章，我个人感觉还缺点什么，本文尽可能通过通俗易懂的方式来描述（android11和13源码）。">
<meta property="og:type" content="article">
<meta property="og:title" content="WMS-Window">
<meta name="twitter:title" content="WMS-Window">
<meta property="og:url" content="https://yangyang48.github.io/2023/04/wms-window/">
<meta property="twitter:url" content="https://yangyang48.github.io/2023/04/wms-window/">
<meta property="og:site_name" content="欢迎来到我的博客~">
<meta property="og:description" content="Android framework层离不开AMS、WMS、PMS等，其中WMS中Window这个概念比较抽象，且很多博客作者写了很多关于Window的文章，我个人感觉还缺点什么，本文尽可能通过通俗易懂的方式来描述（android11和13源码）。">
<meta name="twitter:description" content="Android framework层离不开AMS、WMS、PMS等，其中WMS中Window这个概念比较抽象，且很多博客作者写了很多关于Window的文章，我个人感觉还缺点什么，本文尽可能通过通俗易懂的方式来描述（android11和13源码）。">
<meta property="og:locale" content="zh-cn">

  
    <meta property="article:published_time" content="2023-04-02T00:00:00">
  
  
    <meta property="article:modified_time" content="2023-04-02T00:00:00">
  
  
  
    
      <meta property="article:section" content="service call">
    
      <meta property="article:section" content="2023">
    
      <meta property="article:section" content="April">
    
  
  
    
      <meta property="article:tag" content="Android">
    
      <meta property="article:tag" content="源码">
    
      <meta property="article:tag" content="Binder">
    
      <meta property="article:tag" content="WMS">
    
      <meta property="article:tag" content="Window">
    
      <meta property="article:tag" content="WindowManager">
    
      <meta property="article:tag" content="ViewRootImpl">
    
      <meta property="article:tag" content="DecorView">
    
      <meta property="article:tag" content="WindowToken">
    
      <meta property="article:tag" content="WindowState">
    
      <meta property="article:tag" content="Window层级">
    
      <meta property="article:tag" content="Window容器">
    
  


<meta name="twitter:card" content="summary">







  <meta property="og:image" content="https://yangyang48.github.io/WMS/window/window_thumb.jpg">
  <meta property="twitter:image" content="https://yangyang48.github.io/WMS/window/window_thumb.jpg">


  <meta property="og:image" content="https://yangyang48.github.io/WMS/window/window_cover.jpg">
  <meta property="twitter:image" content="https://yangyang48.github.io/WMS/window/window_cover.jpg">




  <meta property="og:image" content="https://img-blog.csdnimg.cn/20210711204627625.jpg">
  <meta property="twitter:image" content="https://img-blog.csdnimg.cn/20210711204627625.jpg">


    <title>WMS-Window</title>

    <link rel="icon" href="https://yangyang48.github.io/favicon.png">
    

    

    <link rel="canonical" href="https://yangyang48.github.io/2023/04/wms-window/">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.min.css" integrity="sha256-vuXZ9LGmmwtjqFX1F+EKin1ThZMub58gKULUyf0qECk=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/helpers/jquery.fancybox-thumbs.min.css" integrity="sha256-SEa4XYAHihTcEP1f5gARTB2K26Uk8PsndQYHQC1f4jU=" crossorigin="anonymous" />
    
    
    <link rel="stylesheet" href="https://yangyang48.github.io/css/style-twzjdbqhmnnacqs0pwwdzcdbt8yhv8giawvjqjmyfoqnvazl0dalmnhdkvp7.min.css" />
    
    
      
        <link rel="stylesheet"  href="https://yangyang48.github.io/css/copy-to-clipboard.css">
      
    

    
      
    
    

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="4">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="https://yangyang48.github.io/">欢迎来到我的博客~</a>
  </div>
  
    
      <a class="header-right-picture "
         href="https://yangyang48.github.io/#about">
    
    
    
      
        <img class="header-picture" src="https://img-blog.csdnimg.cn/20210711204627625.jpg" alt="作者的图片" />
      
    
    </a>
  
</header>

      <nav id="sidebar" data-behavior="4">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="https://yangyang48.github.io/#about">
          <img class="sidebar-profile-picture" src="https://img-blog.csdnimg.cn/20210711204627625.jpg" alt="作者的图片" />
        </a>
        <h4 class="sidebar-profile-name">Yang Ju</h4>
        
          <h5 class="sidebar-profile-bio">Nanjing University of Science and Technology</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://yangyang48.github.io/">
    
      <i class="sidebar-button-icon fa fa-lg fa-home"></i>
      
      <span class="sidebar-button-desc">首页</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://yangyang48.github.io/categories">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">分类</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://yangyang48.github.io/tags">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">标签</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://yangyang48.github.io/archives">
    
      <i class="sidebar-button-icon fa fa-lg fa-archive"></i>
      
      <span class="sidebar-button-desc">归档</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://yangyang48.github.io/#about">
    
      <i class="sidebar-button-icon fa fa-lg fa-question"></i>
      
      <span class="sidebar-button-desc">关于</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/YangYang48" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-github"></i>
      
      <span class="sidebar-button-desc">GitHub</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://blog.csdn.net/yangju147532896" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-chain"></i>
      
      <span class="sidebar-button-desc">CSDN</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
  </div>
</nav>

      
  <div class="post-header-cover
              text-center
              "
       style="background-image:url('/WMS/window/window_cover.jpg')"
       data-behavior="4">
    
  </div>


      <div id="main" data-behavior="4"
        class="hasCover
               hasCoverMetaOut
               ">
        <article class="post" itemscope itemType="http://schema.org/BlogPosting">
          
          
            <div class="post-header main-content-wrap text-center">
  
    <h1 class="post-title" itemprop="headline">
      WMS-Window
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time itemprop="datePublished" datetime="2023-04-02T00:00:00Z">
        
  四月 2, 2023

      </time>
    
    
  
  
    <span>发布在</span>
    
      <a class="category-link" href="https://yangyang48.github.io/categories/service-call">service call</a>, 
    
      <a class="category-link" href="https://yangyang48.github.io/categories/2023">2023</a>, 
    
      <a class="category-link" href="https://yangyang48.github.io/categories/april">April</a>
    
  

  </div>

</div>
          
		  
		  <h5 id="wc" style="font-size: 1rem;text-align: center;">11800 Words|Read in about 55 Min|本文总阅读量<span id="busuanzi_value_page_pv"></span>次</h5>
		  
          <div class="post-content markdown" itemprop="articleBody">
            <div class="main-content-wrap">
              <p>Android framework层离不开AMS、WMS、PMS等，其中WMS中Window这个概念比较抽象，且很多博客作者写了很多关于Window的文章，我个人感觉还缺点什么，本文尽可能通过通俗易懂的方式来描述（android11和13源码）。</p>
<h1 id="0快问快答">0快问快答</h1>
<p>1）Window，WMS，Activity之间的联系（什么时候Window和Activity和WMS产生联系）</p>
<p>2）Window和View区别和联系（什么时候Window和View产生联系）</p>
<p>3）Window的类别和层次关系（为什么PopWindow会遮住App的显示，锁屏为什么看不到Launcher）</p>
<p>4）activity与 PhoneWindow与DecorView关系 （如果我添加一个View，会添加到系统层面去吗）</p>
<h1 id="1介绍">1介绍</h1>
<p>Window 是一个窗口的概念，是所有视图的载体，不管是 Activity，Dialog，还是 Toast，他们的视图都是附加在 Window 上面的。例如在桌面显示一个悬浮窗，就需要用到 Window 来实现。</p>
<h1 id="2源码跟踪分析问题">2源码跟踪分析问题</h1>
<h2 id="21windowwmsactivity之间的联系">2.1Window，WMS，Activity之间的联系</h2>
<ul>
<li><strong>Window</strong>： 在Android视图体系中Window就是一个窗口的概念。 Android中所有的视图都是依赖于Window显示的。</li>
<li><strong>WindowManager</strong>： 对Window的管理， 包括新增、更新和删除等。</li>
<li><strong>WMS(WindowManagerService)</strong>： 窗口的最终管理者， 它负责窗口的启动、添加和删除， 另外窗口的大小和层级也是由WMS进行管理</li>
</ul>
<p>具体关于三者之间的联系，请翻看2.5.1</p>
<h2 id="22window和view区别和联系">2.2Window和View区别和联系</h2>
<p>WindowManagerImpl实际控制对应的PhoneWindow</p>
<p>ViewRootImpl与View树进行关联，这样ViewRootImpl就可以指挥View树的具体工作</p>
<p>Activity#onCreate()中调用setContentView()方法，这个方法内部创建一个DecorView实例作为PhoneWindow的内容。WindowManagerImpl决定管理DecorView， 并创建一个ViewRootImpl实例</p>
<p>具体关于Window和View的联系，请翻看2.5.2和2.5.3</p>
<h2 id="23window的类别和层次关系">2.3Window的类别和层次关系</h2>
<p>通常我们开发应用的时候会用到各种View、布局，但是这和Window并不是一回事。打开一个应用，出现界面，我们可以理解出现了一个窗口。实际上View和Window是光年和年的关系。</p>
<blockquote>
<p>一个 Activity 可以理解 对应一个 Window，ViewRootImpl 是对应一个 Window。</p>
</blockquote>
<p>查看window方式，笔者这里使用手机打开浏览器的设置操作</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln"> 1</span>$ dumpsys window windows
<span class="ln"> 2</span><span class="c1"># 输入法</span>
<span class="ln"> 3</span>Window <span class="c1">#0 Window{6c306bc u0 InputMethod}:</span>
<span class="ln"> 4</span><span class="nv">mBaseLayer</span><span class="o">=</span><span class="m">141000</span> <span class="nv">mSubLayer</span><span class="o">=</span><span class="m">0</span>    <span class="nv">mToken</span><span class="o">=</span>WindowToken<span class="o">{</span>25f6be3 android.os.Binder@5319812<span class="o">}</span>
<span class="ln"> 5</span><span class="nv">isVisible</span><span class="o">=</span><span class="nb">false</span>
<span class="ln"> 6</span><span class="c1"># 圆角</span>
<span class="ln"> 7</span>Window <span class="c1">#1 Window{6474d57 u0 RoundCorner}:</span>
<span class="ln"> 8</span><span class="nv">mBaseLayer</span><span class="o">=</span><span class="m">311000</span> <span class="nv">mSubLayer</span><span class="o">=</span><span class="m">0</span>    <span class="nv">mToken</span><span class="o">=</span>WindowToken<span class="o">{</span>7706d6 android.os.BinderProxy@359caf1<span class="o">}</span>
<span class="ln"> 9</span><span class="nv">isVisible</span><span class="o">=</span><span class="nb">true</span>
<span class="ln">10</span><span class="c1"># 圆角</span>
<span class="ln">11</span>Window <span class="c1">#2 Window{98435fe u0 RoundCorner}:</span>
<span class="ln">12</span><span class="nv">mBaseLayer</span><span class="o">=</span><span class="m">311000</span> <span class="nv">mSubLayer</span><span class="o">=</span><span class="m">0</span>    <span class="nv">mToken</span><span class="o">=</span>WindowToken<span class="o">{</span>a6ec0b2 android.os.BinderProxy@1af12bd<span class="o">}</span>
<span class="ln">13</span><span class="nv">isVisible</span><span class="o">=</span><span class="nb">true</span>
<span class="ln">14</span><span class="c1"># 导航栏</span>
<span class="ln">15</span>Window <span class="c1">#3 Window{987738d u0 NavigationBar}:</span>
<span class="ln">16</span><span class="nv">mBaseLayer</span><span class="o">=</span><span class="m">231000</span> <span class="nv">mSubLayer</span><span class="o">=</span><span class="m">0</span>    <span class="nv">mToken</span><span class="o">=</span>WindowToken<span class="o">{</span>cdfac24 android.os.BinderProxy@1bf9cb7<span class="o">}</span>
<span class="ln">17</span><span class="nv">isVisible</span><span class="o">=</span><span class="nb">true</span>
<span class="ln">18</span><span class="c1"># 状态栏</span>
<span class="ln">19</span>Window <span class="c1">#4 Window{85d4239 u0 StatusBar}:</span>
<span class="ln">20</span><span class="nv">mBaseLayer</span><span class="o">=</span><span class="m">181000</span> <span class="nv">mSubLayer</span><span class="o">=</span><span class="m">0</span>    <span class="nv">mToken</span><span class="o">=</span>WindowToken<span class="o">{</span>e3e1a00 android.os.BinderProxy@bf7a332<span class="o">}</span>
<span class="ln">21</span><span class="nv">isVisible</span><span class="o">=</span><span class="nb">true</span>
<span class="ln">22</span><span class="c1"># 圆角</span>
<span class="ln">23</span>Window <span class="c1">#5 Window{5c8904f u0 RoundCorner}:</span>
<span class="ln">24</span><span class="nv">mBaseLayer</span><span class="o">=</span><span class="m">171000</span> <span class="nv">mSubLayer</span><span class="o">=</span><span class="m">0</span>    <span class="nv">mToken</span><span class="o">=</span>WindowToken<span class="o">{</span>c281aae android.os.BinderProxy@485e729<span class="o">}</span>
<span class="ln">25</span><span class="nv">isVisible</span><span class="o">=</span><span class="nb">false</span>
<span class="ln">26</span><span class="c1"># SYSTEM_ALERT_WINDOW</span>
<span class="ln">27</span>Window <span class="c1">#6 Window{e12503c u0 Aspect}:</span>
<span class="ln">28</span><span class="nv">mBaseLayer</span><span class="o">=</span><span class="m">111000</span> <span class="nv">mSubLayer</span><span class="o">=</span><span class="m">0</span>    <span class="nv">mToken</span><span class="o">=</span>WindowToken<span class="o">{</span>cb4622f android.os.BinderProxy@bba880e<span class="o">}</span>
<span class="ln">29</span><span class="nv">isVisible</span><span class="o">=</span><span class="nb">false</span>
<span class="ln">30</span><span class="c1"># 协助预览盘</span>
<span class="ln">31</span>Window <span class="c1">#7 Window{31fbd71 u0 AssistPreviewPanel}:</span>
<span class="ln">32</span><span class="nv">mBaseLayer</span><span class="o">=</span><span class="m">41000</span> <span class="nv">mSubLayer</span><span class="o">=</span><span class="m">0</span>    <span class="nv">mToken</span><span class="o">=</span>WindowToken<span class="o">{</span>f8d1f18 android.os.BinderProxy@c09ec8a<span class="o">}</span>
<span class="ln">33</span><span class="nv">isVisible</span><span class="o">=</span><span class="nb">false</span>
<span class="ln">34</span><span class="c1"># 分屏窗口</span>
<span class="ln">35</span>Window <span class="c1">#8 Window{67faf21 u0 DockedStackDivider}:</span>
<span class="ln">36</span><span class="nv">mBaseLayer</span><span class="o">=</span><span class="m">21000</span> <span class="nv">mSubLayer</span><span class="o">=</span><span class="m">0</span>    <span class="nv">mToken</span><span class="o">=</span>WindowToken<span class="o">{</span>f740988 android.os.BinderProxy@d47412b<span class="o">}</span>
<span class="ln">37</span><span class="nv">isVisible</span><span class="o">=</span><span class="nb">false</span>
<span class="ln">38</span><span class="c1"># 浏览器设置</span>
<span class="ln">39</span>Window <span class="c1">#9 Window{297fd5f u0 PopupWindow:9fecaec}:</span>
<span class="ln">40</span><span class="nv">mBaseLayer</span><span class="o">=</span><span class="m">21000</span> <span class="nv">mSubLayer</span><span class="o">=</span><span class="m">2</span>    <span class="nv">mToken</span><span class="o">=</span>AppWindowToken<span class="o">{</span>380207c <span class="nv">token</span><span class="o">=</span>Token<span class="o">{</span>d724b6f ActivityRecord<span class="o">{</span>b054e4e u0 com.android.chrome/org.chromium.chrome.browser.ChromeTabbedActivity t220<span class="o">}}}</span>
<span class="ln">41</span><span class="nv">isVisible</span><span class="o">=</span><span class="nb">true</span>
<span class="ln">42</span><span class="c1"># 浏览器</span>
<span class="ln">43</span>Window <span class="c1">#10 Window{7a87747 u0 com.android.chrome/org.chromium.chrome.browser.ChromeTabbedActivity}:</span>
<span class="ln">44</span><span class="nv">mBaseLayer</span><span class="o">=</span><span class="m">21000</span> <span class="nv">mSubLayer</span><span class="o">=</span><span class="m">0</span>    <span class="nv">mToken</span><span class="o">=</span>AppWindowToken<span class="o">{</span>380207c <span class="nv">token</span><span class="o">=</span>Token<span class="o">{</span>d724b6f ActivityRecord<span class="o">{</span>b054e4e u0 com.android.chrome/org.chromium.chrome.browser.ChromeTabbedActivity t220<span class="o">}}}</span>
<span class="ln">45</span><span class="nv">isVisible</span><span class="o">=</span><span class="nb">true</span>
<span class="ln">46</span><span class="c1"># Launcher悬浮窗口</span>
<span class="ln">47</span>Window <span class="c1">#11 Window{8c10cde u0 LauncherOverlayWindow:com.miui.personalassistant}:</span>
<span class="ln">48</span><span class="nv">mBaseLayer</span><span class="o">=</span><span class="m">21000</span> <span class="nv">mSubLayer</span><span class="o">=</span><span class="m">0</span>    <span class="nv">mToken</span><span class="o">=</span>AppWindowToken<span class="o">{</span>e921607 <span class="nv">token</span><span class="o">=</span>Token<span class="o">{</span>361c446 ActivityRecord<span class="o">{</span>6d5b688 u0 com.miui.home/.launcher.Launcher t1<span class="o">}}}</span>
<span class="ln">49</span><span class="nv">isVisible</span><span class="o">=</span><span class="nb">false</span>
<span class="ln">50</span><span class="c1"># Launcher</span>
<span class="ln">51</span>Window <span class="c1">#12 Window{6163c5a u0 com.miui.home/com.miui.home.launcher.Launcher}:</span>
<span class="ln">52</span><span class="nv">mBaseLayer</span><span class="o">=</span><span class="m">21000</span> <span class="nv">mSubLayer</span><span class="o">=</span><span class="m">0</span>    <span class="nv">mToken</span><span class="o">=</span>AppWindowToken<span class="o">{</span>e921607 <span class="nv">token</span><span class="o">=</span>Token<span class="o">{</span>361c446 ActivityRecord<span class="o">{</span>6d5b688 u0 com.miui.home/.launcher.Launcher t1<span class="o">}}}</span>
<span class="ln">53</span><span class="nv">isVisible</span><span class="o">=</span><span class="nb">false</span>
<span class="ln">54</span><span class="c1"># 壁纸，类似透明板（动态壁纸）</span>
<span class="ln">55</span>Window <span class="c1">#13 Window{f63516 u0 com.android.keyguard.wallpaper.service.MiuiKeyguardLiveWallpaper}:</span>
<span class="ln">56</span><span class="nv">mBaseLayer</span><span class="o">=</span><span class="m">11000</span> <span class="nv">mSubLayer</span><span class="o">=</span><span class="m">0</span>    <span class="nv">mToken</span><span class="o">=</span>WallpaperWindowToken<span class="o">{</span>f661030 <span class="nv">token</span><span class="o">=</span>android.os.BinderProxy@3481973<span class="o">}</span>
<span class="ln">57</span><span class="nv">isVisible</span><span class="o">=</span><span class="nb">false</span>
<span class="ln">58</span><span class="c1"># 壁纸</span>
<span class="ln">59</span>Window <span class="c1">#14 Window{cf10cf2 u0 com.android.systemui.ImageWallpaper}:</span>
<span class="ln">60</span><span class="nv">mBaseLayer</span><span class="o">=</span><span class="m">11000</span> <span class="nv">mSubLayer</span><span class="o">=</span><span class="m">0</span>    <span class="nv">mToken</span><span class="o">=</span>WallpaperWindowToken<span class="o">{</span>5182c91 <span class="nv">token</span><span class="o">=</span>android.os.Binder@2b356b8<span class="o">}</span>
<span class="ln">61</span><span class="nv">isVisible</span><span class="o">=</span><span class="nb">false</span>
</code></pre></div><p>这里的Window数字越小，那么显示距离屏幕越近。</p>
<h3 id="231window类别">2.3.1Window类别</h3>
<ol>
<li>
<p>Application Window： Activity就是一个典型的应用程序窗口</p>
</li>
<li>
<p>Sub Window： 子窗口， 顾名思义， 它不能独立存在， 需要附着在其他窗口才可以， PopupWindow就属于子窗口</p>
</li>
<li>
<p>System Window： 输入法窗口、 系统音量条窗口、系统错误窗口都属于系统窗口</p>
</li>
</ol>
<p>Application Window【type 取值范围 [0,999]】</p>
<p>应用程序窗口，主要是应用中的出现的Window，也就是对应我们说的Activity。</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln">1</span><span class="c1">//frameworks/base/core/java/android/view/WindowManager.java
</span><span class="ln">2</span><span class="c1"></span><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">FIRST_APPLICATION_WINDOW</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
<span class="ln">3</span><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">TYPE_BASE_APPLICATION</span>   <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
<span class="ln">4</span><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">TYPE_APPLICATION</span>        <span class="o">=</span> <span class="n">2</span><span class="o">;</span>
<span class="ln">5</span><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">TYPE_APPLICATION_STARTING</span> <span class="o">=</span> <span class="n">3</span><span class="o">;</span>
<span class="ln">6</span><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">TYPE_DRAWN_APPLICATION</span> <span class="o">=</span> <span class="n">4</span><span class="o">;</span>
<span class="ln">7</span><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">LAST_APPLICATION_WINDOW</span> <span class="o">=</span> <span class="n">99</span><span class="o">;</span>
</code></pre></div><p>Sub window【type 取值范围 [1000,1999]】</p>
<p>不能独立存在，需依附其他窗口的Window，也就是Subwindow可以依赖于Application Window或System Window，也可以依赖于Subwindow，可以存在嵌套的子窗口。实际上学习完Window类别和层次关系，可以知道其实是两个Window属于同一个WindowToken容器，距离谷歌浏览器中打开右上角「设置」，「设置」属于子窗口。</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln">1</span><span class="c1">//frameworks/base/core/java/android/view/WindowManager.java
</span><span class="ln">2</span><span class="c1"></span><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">FIRST_SUB_WINDOW</span> <span class="o">=</span> <span class="n">1000</span><span class="o">;</span>
<span class="ln">3</span><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">TYPE_APPLICATION_PANEL</span> <span class="o">=</span> <span class="n">FIRST_SUB_WINDOW</span><span class="o">;</span>
<span class="ln">4</span><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">TYPE_APPLICATION_MEDIA</span> <span class="o">=</span> <span class="n">FIRST_SUB_WINDOW</span> <span class="o">+</span> <span class="n">1</span><span class="o">;</span>
<span class="ln">5</span><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">TYPE_APPLICATION_SUB_PANEL</span> <span class="o">=</span> <span class="n">FIRST_SUB_WINDOW</span> <span class="o">+</span> <span class="n">2</span><span class="o">;</span>
<span class="ln">6</span><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">TYPE_APPLICATION_ATTACHED_DIALOG</span> <span class="o">=</span> <span class="n">FIRST_SUB_WINDOW</span> <span class="o">+</span> <span class="n">3</span><span class="o">;</span>
<span class="ln">7</span><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">TYPE_APPLICATION_MEDIA_OVERLAY</span>  <span class="o">=</span> <span class="n">FIRST_SUB_WINDOW</span> <span class="o">+</span> <span class="n">4</span><span class="o">;</span>
<span class="ln">8</span><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">TYPE_APPLICATION_ABOVE_SUB_PANEL</span> <span class="o">=</span> <span class="n">FIRST_SUB_WINDOW</span> <span class="o">+</span> <span class="n">5</span><span class="o">;</span>
<span class="ln">9</span><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">LAST_SUB_WINDOW</span> <span class="o">=</span> <span class="n">1999</span><span class="o">;</span>
</code></pre></div><p>System Window【type 取值范围 [2000,2999]】</p>
<p>如 Toast，ANR 窗口，输入法，StatusBar，NavigationBar 等。</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln">1</span><span class="c1">//frameworks/base/core/java/android/view/WindowManager.java
</span><span class="ln">2</span><span class="c1"></span><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">TYPE_STATUS_BAR</span>         <span class="o">=</span> <span class="n">FIRST_SYSTEM_WINDOW</span><span class="o">;</span>
<span class="ln">3</span><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">TYPE_SEARCH_BAR</span>         <span class="o">=</span> <span class="n">FIRST_SYSTEM_WINDOW</span><span class="o">+</span><span class="n">1</span><span class="o">;</span>
<span class="ln">4</span><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">TYPE_PHONE</span>              <span class="o">=</span> <span class="n">FIRST_SYSTEM_WINDOW</span><span class="o">+</span><span class="n">2</span><span class="o">;</span>
<span class="ln">5</span><span class="o">...</span>
<span class="ln">6</span><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">TYPE_STATUS_BAR_ADDITIONAL</span> <span class="o">=</span> <span class="n">FIRST_SYSTEM_WINDOW</span> <span class="o">+</span> <span class="n">41</span><span class="o">;</span>
<span class="ln">7</span><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">LAST_SYSTEM_WINDOW</span>      <span class="o">=</span> <span class="n">2999</span><span class="o">;</span>
</code></pre></div><blockquote>
<p>type 值越大，层级越高， <strong>这个观点是不完全正确的</strong>。</p>
<p>相对而言，确实type值越大会越接近屏幕，但是相同type或者是存在SubWindow情况，用Type是无法满足的。</p>
<p>因此，引入Window层级，<strong>层级越高，最终在屏幕上显示时就越靠近用户</strong>。</p>
</blockquote>
<h3 id="232window层次关系">2.3.2Window层次关系</h3>
<p>首先，先介绍一下Window容器中的WindowToken和WindowState</p>
<blockquote>
<p><strong>WindowToken</strong></p>
<p>WindowToken理解成是一个<strong>显示令牌</strong>，无论是系统窗口还是应用窗口，添加新的窗口的时候必须使用这个令牌向WMS表明自己的身份，添加窗口的时候会创建WindowToken，销毁窗口的时候移除WindowToken(removeWindowToken方法)。</p>
<p>ＷMS使用WindowToken将同一个应用组件(Activity,InputMethod,Wallpaper,Dream)的窗口组织在一起，换句话说，每一个窗口都会对应一个WindowToken，并且这个窗口中的所有子窗口将会对应同一个WindowToken，这些窗口的WindowToken都是一样的。</p>
<p><strong>WindowState</strong></p>
<p>WindowState用于窗口管理，这个是<strong>WMS中事实的窗口</strong>，包含了一个窗口的所有的属性，WindowState对象都存放在mWindowMap里面，mWindowMap是所有窗口的一个全集，如果梳理WindowState的一些增加、移动和删除等操作，会更加理解这个类。举一个例子，对于Activity而言，我们看到的App的中的Activity就是一个个Window；对于系统WMS服务而言，这些Activity一个个对应的Window实际上是WindowState。</p>
</blockquote>
<p>为了更好地说清楚层次关系，需要引入两个变量</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln">1</span><span class="c1">//frameworks/base/services/core/java/com/android/server/wm/WindowState.java
</span><span class="ln">2</span><span class="c1"></span><span class="kd">class</span> <span class="nc">WindowState</span> <span class="kd">extends</span> <span class="n">WindowContainer</span><span class="o">&lt;</span><span class="n">WindowState</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="n">WindowManagerPolicy</span><span class="o">.</span><span class="na">WindowState</span><span class="o">,</span>
<span class="ln">3</span><span class="n">InsetsControlTarget</span><span class="o">,</span> <span class="n">InputTarget</span> <span class="o">{</span>
<span class="ln">4</span>    <span class="kd">final</span> <span class="kt">int</span> <span class="n">mBaseLayer</span><span class="o">;</span><span class="c1">//主要层级
</span><span class="ln">5</span><span class="c1"></span>    <span class="kd">final</span> <span class="kt">int</span> <span class="n">mSubLayer</span><span class="o">;</span><span class="c1">//子层级
</span><span class="ln">6</span><span class="c1"></span><span class="o">}</span>
</code></pre></div><h4 id="2321层级顺序">2.3.2.1层级顺序</h4>
<p>先看主要层级的顺序，范围是[1, 36]</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln">  1</span><span class="c1">//frameworks/base/services/core/java/com/android/server/policy/WindowManagerPolicy.java
</span><span class="ln">  2</span><span class="c1"></span><span class="k">default</span> <span class="kt">int</span> <span class="nf">getWindowLayerFromTypeLw</span><span class="o">(</span><span class="kt">int</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">  3</span>    <span class="k">if</span> <span class="o">(</span><span class="n">isSystemAlertWindowType</span><span class="o">(</span><span class="n">type</span><span class="o">))</span> <span class="o">{</span>
<span class="ln">  4</span>        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;Use getWindowLayerFromTypeLw() or&#34;</span>
<span class="ln">  5</span>                                           <span class="o">+</span> <span class="s">&#34; getWindowLayerLw() for alert window types&#34;</span><span class="o">);</span>
<span class="ln">  6</span>    <span class="o">}</span>
<span class="ln">  7</span>    <span class="k">return</span> <span class="n">getWindowLayerFromTypeLw</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="kc">false</span> <span class="cm">/* canAddInternalSystemWindow */</span><span class="o">);</span>
<span class="ln">  8</span><span class="o">}</span>
<span class="ln">  9</span><span class="c1">//这里数字越大，层级越大，最小的是1，最大是36
</span><span class="ln"> 10</span><span class="c1"></span><span class="k">default</span> <span class="kt">int</span> <span class="nf">getWindowLayerFromTypeLw</span><span class="o">(</span><span class="kt">int</span> <span class="n">type</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">canAddInternalSystemWindow</span><span class="o">,</span>
<span class="ln"> 11</span>                                     <span class="kt">boolean</span> <span class="n">roundedCornerOverlay</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 12</span>    <span class="c1">// Always put the rounded corner layer to the top most.
</span><span class="ln"> 13</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">roundedCornerOverlay</span> <span class="o">&amp;&amp;</span> <span class="n">canAddInternalSystemWindow</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 14</span>        <span class="k">return</span> <span class="n">getMaxWindowLayer</span><span class="o">();</span><span class="c1">//这里是36，android版本不一样大小不一样，层级顺序也不一样
</span><span class="ln"> 15</span><span class="c1"></span>    <span class="o">}</span>
<span class="ln"> 16</span>    <span class="c1">//这里先判断type是否是APPLICATION Window中的，如果是返回2
</span><span class="ln"> 17</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">type</span> <span class="o">&gt;=</span> <span class="n">FIRST_APPLICATION_WINDOW</span> <span class="o">&amp;&amp;</span> <span class="n">type</span> <span class="o">&lt;=</span> <span class="n">LAST_APPLICATION_WINDOW</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 18</span>        <span class="k">return</span> <span class="n">APPLICATION_LAYER</span><span class="o">;</span>
<span class="ln"> 19</span>    <span class="o">}</span>
<span class="ln"> 20</span>
<span class="ln"> 21</span>    <span class="k">switch</span> <span class="o">(</span><span class="n">type</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 22</span>        <span class="c1">//壁纸层级最低
</span><span class="ln"> 23</span><span class="c1"></span>        <span class="k">case</span> <span class="n">TYPE_WALLPAPER</span><span class="o">:</span>
<span class="ln"> 24</span>            <span class="k">return</span>  <span class="n">1</span><span class="o">;</span>
<span class="ln"> 25</span>        <span class="k">case</span> <span class="n">TYPE_PRESENTATION</span><span class="o">:</span>
<span class="ln"> 26</span>        <span class="k">case</span> <span class="n">TYPE_PRIVATE_PRESENTATION</span><span class="o">:</span>
<span class="ln"> 27</span>        <span class="k">case</span> <span class="n">TYPE_DOCK_DIVIDER</span><span class="o">:</span>
<span class="ln"> 28</span>        <span class="k">case</span> <span class="n">TYPE_QS_DIALOG</span><span class="o">:</span>
<span class="ln"> 29</span>        <span class="k">case</span> <span class="n">TYPE_PHONE</span><span class="o">:</span>
<span class="ln"> 30</span>            <span class="k">return</span>  <span class="n">3</span><span class="o">;</span>
<span class="ln"> 31</span>        <span class="k">case</span> <span class="n">TYPE_SEARCH_BAR</span><span class="o">:</span>
<span class="ln"> 32</span>            <span class="k">return</span>  <span class="n">4</span><span class="o">;</span>
<span class="ln"> 33</span>        <span class="k">case</span> <span class="n">TYPE_INPUT_CONSUMER</span><span class="o">:</span>
<span class="ln"> 34</span>            <span class="k">return</span>  <span class="n">5</span><span class="o">;</span>
<span class="ln"> 35</span>        <span class="k">case</span> <span class="n">TYPE_SYSTEM_DIALOG</span><span class="o">:</span>
<span class="ln"> 36</span>            <span class="k">return</span>  <span class="n">6</span><span class="o">;</span>
<span class="ln"> 37</span>        <span class="k">case</span> <span class="n">TYPE_TOAST</span><span class="o">:</span>
<span class="ln"> 38</span>            <span class="c1">// toasts and the plugged-in battery thing
</span><span class="ln"> 39</span><span class="c1"></span>            <span class="k">return</span>  <span class="n">7</span><span class="o">;</span>
<span class="ln"> 40</span>        <span class="k">case</span> <span class="n">TYPE_PRIORITY_PHONE</span><span class="o">:</span>
<span class="ln"> 41</span>            <span class="c1">// SIM errors and unlock.  Not sure if this really should be in a high layer.
</span><span class="ln"> 42</span><span class="c1"></span>            <span class="k">return</span>  <span class="n">8</span><span class="o">;</span>
<span class="ln"> 43</span>        <span class="k">case</span> <span class="n">TYPE_SYSTEM_ALERT</span><span class="o">:</span>
<span class="ln"> 44</span>            <span class="c1">// like the ANR / app crashed dialogs
</span><span class="ln"> 45</span><span class="c1"></span>            <span class="c1">// Type is deprecated for non-system apps. For system apps, this type should be
</span><span class="ln"> 46</span><span class="c1"></span>            <span class="c1">// in a higher layer than TYPE_APPLICATION_OVERLAY.
</span><span class="ln"> 47</span><span class="c1"></span>            <span class="k">return</span>  <span class="n">canAddInternalSystemWindow</span> <span class="o">?</span> <span class="n">12</span> <span class="o">:</span> <span class="n">9</span><span class="o">;</span>
<span class="ln"> 48</span>        <span class="k">case</span> <span class="n">TYPE_APPLICATION_OVERLAY</span><span class="o">:</span>
<span class="ln"> 49</span>            <span class="k">return</span>  <span class="n">11</span><span class="o">;</span>
<span class="ln"> 50</span>        <span class="k">case</span> <span class="n">TYPE_INPUT_METHOD</span><span class="o">:</span>
<span class="ln"> 51</span>            <span class="c1">// on-screen keyboards and other such input method user interfaces go here.
</span><span class="ln"> 52</span><span class="c1"></span>            <span class="k">return</span>  <span class="n">13</span><span class="o">;</span>
<span class="ln"> 53</span>        <span class="k">case</span> <span class="n">TYPE_INPUT_METHOD_DIALOG</span><span class="o">:</span>
<span class="ln"> 54</span>            <span class="c1">// on-screen keyboards and other such input method user interfaces go here.
</span><span class="ln"> 55</span><span class="c1"></span>            <span class="k">return</span>  <span class="n">14</span><span class="o">;</span>
<span class="ln"> 56</span>        <span class="k">case</span> <span class="n">TYPE_STATUS_BAR</span><span class="o">:</span>
<span class="ln"> 57</span>            <span class="k">return</span>  <span class="n">15</span><span class="o">;</span>
<span class="ln"> 58</span>        <span class="k">case</span> <span class="n">TYPE_STATUS_BAR_ADDITIONAL</span><span class="o">:</span>
<span class="ln"> 59</span>            <span class="k">return</span>  <span class="n">16</span><span class="o">;</span>
<span class="ln"> 60</span>        <span class="k">case</span> <span class="n">TYPE_NOTIFICATION_SHADE</span><span class="o">:</span>
<span class="ln"> 61</span>            <span class="k">return</span>  <span class="n">17</span><span class="o">;</span>
<span class="ln"> 62</span>        <span class="k">case</span> <span class="n">TYPE_STATUS_BAR_SUB_PANEL</span><span class="o">:</span>
<span class="ln"> 63</span>            <span class="k">return</span>  <span class="n">18</span><span class="o">;</span>
<span class="ln"> 64</span>        <span class="k">case</span> <span class="n">TYPE_KEYGUARD_DIALOG</span><span class="o">:</span>
<span class="ln"> 65</span>            <span class="k">return</span>  <span class="n">19</span><span class="o">;</span>
<span class="ln"> 66</span>        <span class="k">case</span> <span class="n">TYPE_VOICE_INTERACTION_STARTING</span><span class="o">:</span>
<span class="ln"> 67</span>            <span class="k">return</span>  <span class="n">20</span><span class="o">;</span>
<span class="ln"> 68</span>        <span class="k">case</span> <span class="n">TYPE_VOICE_INTERACTION</span><span class="o">:</span>
<span class="ln"> 69</span>            <span class="c1">// voice interaction layer should show above the lock screen.
</span><span class="ln"> 70</span><span class="c1"></span>            <span class="k">return</span>  <span class="n">21</span><span class="o">;</span>
<span class="ln"> 71</span>        <span class="k">case</span> <span class="n">TYPE_VOLUME_OVERLAY</span><span class="o">:</span>
<span class="ln"> 72</span>            <span class="c1">// the on-screen volume indicator and controller shown when the user
</span><span class="ln"> 73</span><span class="c1"></span>            <span class="c1">// changes the device volume
</span><span class="ln"> 74</span><span class="c1"></span>            <span class="k">return</span>  <span class="n">22</span><span class="o">;</span>
<span class="ln"> 75</span>        <span class="k">case</span> <span class="n">TYPE_SYSTEM_OVERLAY</span><span class="o">:</span>
<span class="ln"> 76</span>            <span class="c1">// the on-screen volume indicator and controller shown when the user
</span><span class="ln"> 77</span><span class="c1"></span>            <span class="c1">// changes the device volume
</span><span class="ln"> 78</span><span class="c1"></span>            <span class="k">return</span>  <span class="n">canAddInternalSystemWindow</span> <span class="o">?</span> <span class="n">23</span> <span class="o">:</span> <span class="n">10</span><span class="o">;</span>
<span class="ln"> 79</span>        <span class="k">case</span> <span class="n">TYPE_NAVIGATION_BAR</span><span class="o">:</span>
<span class="ln"> 80</span>            <span class="c1">// the navigation bar, if available, shows atop most things
</span><span class="ln"> 81</span><span class="c1"></span>            <span class="k">return</span>  <span class="n">24</span><span class="o">;</span>
<span class="ln"> 82</span>        <span class="k">case</span> <span class="n">TYPE_NAVIGATION_BAR_PANEL</span><span class="o">:</span>
<span class="ln"> 83</span>            <span class="c1">// some panels (e.g. search) need to show on top of the navigation bar
</span><span class="ln"> 84</span><span class="c1"></span>            <span class="k">return</span>  <span class="n">25</span><span class="o">;</span>
<span class="ln"> 85</span>        <span class="k">case</span> <span class="n">TYPE_SCREENSHOT</span><span class="o">:</span>
<span class="ln"> 86</span>            <span class="c1">// screenshot selection layer shouldn&#39;t go above system error, but it should cover
</span><span class="ln"> 87</span><span class="c1"></span>            <span class="c1">// navigation bars at the very least.
</span><span class="ln"> 88</span><span class="c1"></span>            <span class="k">return</span>  <span class="n">26</span><span class="o">;</span>
<span class="ln"> 89</span>        <span class="k">case</span> <span class="n">TYPE_SYSTEM_ERROR</span><span class="o">:</span>
<span class="ln"> 90</span>            <span class="c1">// system-level error dialogs
</span><span class="ln"> 91</span><span class="c1"></span>            <span class="k">return</span>  <span class="n">canAddInternalSystemWindow</span> <span class="o">?</span> <span class="n">27</span> <span class="o">:</span> <span class="n">9</span><span class="o">;</span>
<span class="ln"> 92</span>        <span class="k">case</span> <span class="n">TYPE_MAGNIFICATION_OVERLAY</span><span class="o">:</span>
<span class="ln"> 93</span>            <span class="c1">// used to highlight the magnified portion of a display
</span><span class="ln"> 94</span><span class="c1"></span>            <span class="k">return</span>  <span class="n">28</span><span class="o">;</span>
<span class="ln"> 95</span>        <span class="k">case</span> <span class="n">TYPE_DISPLAY_OVERLAY</span><span class="o">:</span>
<span class="ln"> 96</span>            <span class="c1">// used to simulate secondary display devices
</span><span class="ln"> 97</span><span class="c1"></span>            <span class="k">return</span>  <span class="n">29</span><span class="o">;</span>
<span class="ln"> 98</span>        <span class="k">case</span> <span class="n">TYPE_DRAG</span><span class="o">:</span>
<span class="ln"> 99</span>            <span class="c1">// the drag layer: input for drag-and-drop is associated with this window,
</span><span class="ln">100</span><span class="c1"></span>            <span class="c1">// which sits above all other focusable windows
</span><span class="ln">101</span><span class="c1"></span>            <span class="k">return</span>  <span class="n">30</span><span class="o">;</span>
<span class="ln">102</span>        <span class="k">case</span> <span class="n">TYPE_ACCESSIBILITY_OVERLAY</span><span class="o">:</span>
<span class="ln">103</span>            <span class="c1">// overlay put by accessibility services to intercept user interaction
</span><span class="ln">104</span><span class="c1"></span>            <span class="k">return</span>  <span class="n">31</span><span class="o">;</span>
<span class="ln">105</span>        <span class="k">case</span> <span class="n">TYPE_ACCESSIBILITY_MAGNIFICATION_OVERLAY</span><span class="o">:</span>
<span class="ln">106</span>            <span class="k">return</span> <span class="n">32</span><span class="o">;</span>
<span class="ln">107</span>        <span class="k">case</span> <span class="n">TYPE_SECURE_SYSTEM_OVERLAY</span><span class="o">:</span>
<span class="ln">108</span>            <span class="k">return</span>  <span class="n">33</span><span class="o">;</span>
<span class="ln">109</span>        <span class="k">case</span> <span class="n">TYPE_BOOT_PROGRESS</span><span class="o">:</span>
<span class="ln">110</span>            <span class="k">return</span>  <span class="n">34</span><span class="o">;</span>
<span class="ln">111</span>        <span class="k">case</span> <span class="n">TYPE_POINTER</span><span class="o">:</span>
<span class="ln">112</span>            <span class="c1">// the (mouse) pointer layer
</span><span class="ln">113</span><span class="c1"></span>            <span class="k">return</span>  <span class="n">35</span><span class="o">;</span>
<span class="ln">114</span>        <span class="k">default</span><span class="o">:</span>
<span class="ln">115</span>            <span class="n">Slog</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">&#34;WindowManager&#34;</span><span class="o">,</span> <span class="s">&#34;Unknown window type: &#34;</span> <span class="o">+</span> <span class="n">type</span><span class="o">);</span>
<span class="ln">116</span>            <span class="k">return</span> <span class="n">3</span><span class="o">;</span>
<span class="ln">117</span>    <span class="o">}</span>
<span class="ln">118</span><span class="o">}</span>
</code></pre></div><p>接着看先看次层级的顺序，范围是[-2, 3]</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/services/core/java/com/android/server/policy/WindowManagerPolicy.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="k">default</span> <span class="kt">int</span> <span class="nf">getSubWindowLayerFromTypeLw</span><span class="o">(</span><span class="kt">int</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 3</span>    <span class="k">switch</span> <span class="o">(</span><span class="n">type</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 4</span>        <span class="k">case</span> <span class="n">TYPE_APPLICATION_PANEL</span><span class="o">:</span>
<span class="ln"> 5</span>        <span class="k">case</span> <span class="n">TYPE_APPLICATION_ATTACHED_DIALOG</span><span class="o">:</span>
<span class="ln"> 6</span>            <span class="k">return</span> <span class="n">APPLICATION_PANEL_SUBLAYER</span><span class="o">;</span><span class="c1">// 1
</span><span class="ln"> 7</span><span class="c1"></span>        <span class="k">case</span> <span class="n">TYPE_APPLICATION_MEDIA</span><span class="o">:</span>
<span class="ln"> 8</span>            <span class="k">return</span> <span class="n">APPLICATION_MEDIA_SUBLAYER</span><span class="o">;</span><span class="c1">// -2
</span><span class="ln"> 9</span><span class="c1"></span>        <span class="k">case</span> <span class="n">TYPE_APPLICATION_MEDIA_OVERLAY</span><span class="o">:</span>
<span class="ln">10</span>            <span class="k">return</span> <span class="n">APPLICATION_MEDIA_OVERLAY_SUBLAYER</span><span class="o">;</span><span class="c1">// -1
</span><span class="ln">11</span><span class="c1"></span>        <span class="k">case</span> <span class="n">TYPE_APPLICATION_SUB_PANEL</span><span class="o">:</span>
<span class="ln">12</span>            <span class="k">return</span> <span class="n">APPLICATION_SUB_PANEL_SUBLAYER</span><span class="o">;</span><span class="c1">// 2
</span><span class="ln">13</span><span class="c1"></span>        <span class="k">case</span> <span class="n">TYPE_APPLICATION_ABOVE_SUB_PANEL</span><span class="o">:</span>
<span class="ln">14</span>            <span class="k">return</span> <span class="n">APPLICATION_ABOVE_SUB_PANEL_SUBLAYER</span><span class="o">;</span><span class="c1">// 3
</span><span class="ln">15</span><span class="c1"></span>    <span class="o">}</span>
<span class="ln">16</span>    <span class="n">Slog</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">&#34;WindowManager&#34;</span><span class="o">,</span> <span class="s">&#34;Unknown sub-window type: &#34;</span> <span class="o">+</span> <span class="n">type</span><span class="o">);</span>
<span class="ln">17</span>    <span class="k">return</span> <span class="n">0</span><span class="o">;</span>
<span class="ln">18</span><span class="o">}</span>
</code></pre></div><h4 id="2322window层级计算">2.3.2.2Window层级计算</h4>
<p>在WindowState的构造函数中会对Window层级计算</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/services/core/java/com/android/server/wm/WindowState.java
</span><span class="ln"> 2</span><span class="c1">//将阈值扩大 10000 倍，系统中可能存在相同类型的窗口有很多
</span><span class="ln"> 3</span><span class="c1"></span><span class="kt">int</span> <span class="n">TYPE_LAYER_MULTIPLIER</span> <span class="o">=</span> <span class="n">10000</span><span class="o">;</span>
<span class="ln"> 4</span><span class="kt">int</span> <span class="n">TYPE_LAYER_OFFSET</span> <span class="o">=</span> <span class="n">1000</span><span class="o">;</span>
<span class="ln"> 5</span>
<span class="ln"> 6</span><span class="n">WindowState</span><span class="o">(</span><span class="n">WindowManagerService</span> <span class="n">service</span><span class="o">,</span> <span class="n">Session</span> <span class="n">s</span><span class="o">,</span> <span class="n">IWindow</span> <span class="n">c</span><span class="o">,</span> <span class="n">WindowToken</span> <span class="n">token</span><span class="o">,</span>
<span class="ln"> 7</span>            <span class="n">WindowState</span> <span class="n">parentWindow</span><span class="o">,</span> <span class="kt">int</span> <span class="n">appOp</span><span class="o">,</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span> <span class="n">a</span><span class="o">,</span> <span class="kt">int</span> <span class="n">viewVisibility</span><span class="o">,</span>
<span class="ln"> 8</span>            <span class="kt">int</span> <span class="n">ownerId</span><span class="o">,</span> <span class="kt">int</span> <span class="n">showUserId</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">ownerCanAddInternalSystemWindow</span><span class="o">,</span>
<span class="ln"> 9</span>            <span class="n">PowerManagerWrapper</span> <span class="n">powerManagerWrapper</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">10</span>    <span class="o">...</span>
<span class="ln">11</span>    <span class="c1">//如果是子窗口走这里
</span><span class="ln">12</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">mAttrs</span><span class="o">.</span><span class="na">type</span> <span class="o">&gt;=</span> <span class="n">FIRST_SUB_WINDOW</span> <span class="o">&amp;&amp;</span> <span class="n">mAttrs</span><span class="o">.</span><span class="na">type</span> <span class="o">&lt;=</span> <span class="n">LAST_SUB_WINDOW</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">13</span>        <span class="n">mBaseLayer</span> <span class="o">=</span> <span class="n">mPolicy</span><span class="o">.</span><span class="na">getWindowLayerLw</span><span class="o">(</span><span class="n">parentWindow</span><span class="o">)</span>
<span class="ln">14</span>            <span class="o">*</span> <span class="n">TYPE_LAYER_MULTIPLIER</span> <span class="o">+</span> <span class="n">TYPE_LAYER_OFFSET</span><span class="o">;</span>
<span class="ln">15</span>        <span class="n">mSubLayer</span> <span class="o">=</span> <span class="n">mPolicy</span><span class="o">.</span><span class="na">getSubWindowLayerFromTypeLw</span><span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">type</span><span class="o">);</span>
<span class="ln">16</span>        <span class="n">mIsChildWindow</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
<span class="ln">17</span>
<span class="ln">18</span>        <span class="n">mLayoutAttached</span> <span class="o">=</span> <span class="n">mAttrs</span><span class="o">.</span><span class="na">type</span> <span class="o">!=</span>
<span class="ln">19</span>            <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">.</span><span class="na">TYPE_APPLICATION_ATTACHED_DIALOG</span><span class="o">;</span>
<span class="ln">20</span>        <span class="n">mIsImWindow</span> <span class="o">=</span> <span class="n">parentWindow</span><span class="o">.</span><span class="na">mAttrs</span><span class="o">.</span><span class="na">type</span> <span class="o">==</span> <span class="n">TYPE_INPUT_METHOD</span>
<span class="ln">21</span>            <span class="o">||</span> <span class="n">parentWindow</span><span class="o">.</span><span class="na">mAttrs</span><span class="o">.</span><span class="na">type</span> <span class="o">==</span> <span class="n">TYPE_INPUT_METHOD_DIALOG</span><span class="o">;</span>
<span class="ln">22</span>        <span class="n">mIsWallpaper</span> <span class="o">=</span> <span class="n">parentWindow</span><span class="o">.</span><span class="na">mAttrs</span><span class="o">.</span><span class="na">type</span> <span class="o">==</span> <span class="n">TYPE_WALLPAPER</span><span class="o">;</span>
<span class="ln">23</span>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="ln">24</span>        <span class="c1">//如果是非子窗口走这里
</span><span class="ln">25</span><span class="c1"></span>        <span class="n">mBaseLayer</span> <span class="o">=</span> <span class="n">mPolicy</span><span class="o">.</span><span class="na">getWindowLayerLw</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
<span class="ln">26</span>            <span class="o">*</span> <span class="n">TYPE_LAYER_MULTIPLIER</span> <span class="o">+</span> <span class="n">TYPE_LAYER_OFFSET</span><span class="o">;</span>
<span class="ln">27</span>        <span class="n">mSubLayer</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
<span class="ln">28</span>        <span class="n">mIsChildWindow</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
<span class="ln">29</span>        <span class="n">mLayoutAttached</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
<span class="ln">30</span>        <span class="n">mIsImWindow</span> <span class="o">=</span> <span class="n">mAttrs</span><span class="o">.</span><span class="na">type</span> <span class="o">==</span> <span class="n">TYPE_INPUT_METHOD</span>
<span class="ln">31</span>            <span class="o">||</span> <span class="n">mAttrs</span><span class="o">.</span><span class="na">type</span> <span class="o">==</span> <span class="n">TYPE_INPUT_METHOD_DIALOG</span><span class="o">;</span>
<span class="ln">32</span>        <span class="n">mIsWallpaper</span> <span class="o">=</span> <span class="n">mAttrs</span><span class="o">.</span><span class="na">type</span> <span class="o">==</span> <span class="n">TYPE_WALLPAPER</span><span class="o">;</span>
<span class="ln">33</span>    <span class="o">}</span>
<span class="ln">34</span>    <span class="o">...</span>
<span class="ln">35</span><span class="o">}</span>
</code></pre></div><p>如 Activity，type 是 TYPE_BASE_APPLICATION ，getWindowLayerLw 计算返回 APPLICATION_LAYER（2），mBaseLayer = 2 * 10000 + 1000 = 21000</p>
<h4 id="2323window-排序">2.3.2.3Window 排序</h4>
<p>主Window排序</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/services/core/java/com/android/server/wm/WindowToken.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">private</span> <span class="kd">final</span> <span class="n">Comparator</span><span class="o">&lt;</span><span class="n">WindowState</span><span class="o">&gt;</span> <span class="n">mWindowComparator</span> <span class="o">=</span>
<span class="ln"> 3</span>    <span class="o">(</span><span class="n">WindowState</span> <span class="n">newWindow</span><span class="o">,</span> <span class="n">WindowState</span> <span class="n">existingWindow</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
<span class="ln"> 4</span>    <span class="kd">final</span> <span class="n">WindowToken</span> <span class="n">token</span> <span class="o">=</span> <span class="n">WindowToken</span><span class="o">.</span><span class="na">this</span><span class="o">;</span>
<span class="ln"> 5</span>    <span class="k">if</span> <span class="o">(</span><span class="n">newWindow</span><span class="o">.</span><span class="na">mToken</span> <span class="o">!=</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 6</span>        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;newWindow=&#34;</span> <span class="o">+</span> <span class="n">newWindow</span>
<span class="ln"> 7</span>                                           <span class="o">+</span> <span class="s">&#34; is not a child of token=&#34;</span> <span class="o">+</span> <span class="n">token</span><span class="o">);</span>
<span class="ln"> 8</span>    <span class="o">}</span>
<span class="ln"> 9</span>
<span class="ln">10</span>    <span class="k">if</span> <span class="o">(</span><span class="n">existingWindow</span><span class="o">.</span><span class="na">mToken</span> <span class="o">!=</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">11</span>        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;existingWindow=&#34;</span> <span class="o">+</span> <span class="n">existingWindow</span>
<span class="ln">12</span>                                           <span class="o">+</span> <span class="s">&#34; is not a child of token=&#34;</span> <span class="o">+</span> <span class="n">token</span><span class="o">);</span>
<span class="ln">13</span>    <span class="o">}</span>
<span class="ln">14</span>    <span class="c1">//判断新的Window和原来的Window关系，符合要求新Window会放在原来Window上面
</span><span class="ln">15</span><span class="c1"></span>    <span class="k">return</span> <span class="n">isFirstChildWindowGreaterThanSecond</span><span class="o">(</span><span class="n">newWindow</span><span class="o">,</span> <span class="n">existingWindow</span><span class="o">)</span> <span class="o">?</span> <span class="n">1</span> <span class="o">:</span> <span class="o">-</span><span class="n">1</span><span class="o">;</span>
<span class="ln">16</span><span class="o">};</span>
<span class="ln">17</span>
<span class="ln">18</span><span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">isFirstChildWindowGreaterThanSecond</span><span class="o">(</span><span class="n">WindowState</span> <span class="n">newWindow</span><span class="o">,</span>
<span class="ln">19</span>            <span class="n">WindowState</span> <span class="n">existingWindow</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">20</span>        <span class="c1">// New window is considered greater if it has a higher or equal base layer.
</span><span class="ln">21</span><span class="c1"></span>        <span class="k">return</span> <span class="n">newWindow</span><span class="o">.</span><span class="na">mBaseLayer</span> <span class="o">&gt;=</span> <span class="n">existingWindow</span><span class="o">.</span><span class="na">mBaseLayer</span><span class="o">;</span>
<span class="ln">22</span><span class="o">}</span>
</code></pre></div><p>按照 mBaseLayer 大小排序，如果是新插入的，且相等，放在上方</p>
<p>子Window排序</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/services/core/java/com/android/server/wm/WindowState.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Comparator</span><span class="o">&lt;</span><span class="n">WindowState</span><span class="o">&gt;</span> <span class="n">sWindowSubLayerComparator</span> <span class="o">=</span>
<span class="ln"> 3</span>    <span class="k">new</span> <span class="n">Comparator</span><span class="o">&lt;</span><span class="n">WindowState</span><span class="o">&gt;()</span> <span class="o">{</span>
<span class="ln"> 4</span>    <span class="nd">@Override</span>
<span class="ln"> 5</span>    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">compare</span><span class="o">(</span><span class="n">WindowState</span> <span class="n">w1</span><span class="o">,</span> <span class="n">WindowState</span> <span class="n">w2</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 6</span>        <span class="kd">final</span> <span class="kt">int</span> <span class="n">layer1</span> <span class="o">=</span> <span class="n">w1</span><span class="o">.</span><span class="na">mSubLayer</span><span class="o">;</span>
<span class="ln"> 7</span>        <span class="kd">final</span> <span class="kt">int</span> <span class="n">layer2</span> <span class="o">=</span> <span class="n">w2</span><span class="o">.</span><span class="na">mSubLayer</span><span class="o">;</span>
<span class="ln"> 8</span>        <span class="k">if</span> <span class="o">(</span><span class="n">layer1</span> <span class="o">&lt;</span> <span class="n">layer2</span> <span class="o">||</span> <span class="o">(</span><span class="n">layer1</span> <span class="o">==</span> <span class="n">layer2</span> <span class="o">&amp;&amp;</span> <span class="n">layer2</span> <span class="o">&lt;</span> <span class="n">0</span> <span class="o">))</span> <span class="o">{</span>
<span class="ln"> 9</span>            <span class="c1">//w1是原来的sublayer，w2是新的子Window
</span><span class="ln">10</span><span class="c1"></span>            <span class="c1">//如果新的sublayer大，那么放在原来子Window上面
</span><span class="ln">11</span><span class="c1"></span>            <span class="c1">//如果新的sublayer相等，且sublayer小于0，放到原来子Window下面
</span><span class="ln">12</span><span class="c1"></span>            <span class="c1">//如果新的sublayer相等且为正值，放在原来子Window上面
</span><span class="ln">13</span><span class="c1"></span>            <span class="k">return</span> <span class="o">-</span><span class="n">1</span><span class="o">;</span>
<span class="ln">14</span>        <span class="o">}</span>
<span class="ln">15</span>        <span class="k">return</span> <span class="n">1</span><span class="o">;</span>
<span class="ln">16</span>    <span class="o">};</span>
<span class="ln">17</span><span class="o">};</span>
</code></pre></div><p>以上面的例子来具体说明</p>
<p>下图<strong>红色部分</strong>才是展示出来的Window叠加起来真正出现的手机画面</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window18.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window18.png" >
  
    </a>
  
  
</div>



 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window19.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window19.png" >
  
    </a>
  
  
</div>

<blockquote>
<p>用demo来进一步理解运算逻辑</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window20.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window20.png" >
  
    </a>
  
  
</div>



 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window21.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window21.png" >
  
    </a>
  
  
</div>



 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window22.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window22.png" >
  
    </a>
  
  
</div>



 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window23.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window23.png" >
  
    </a>
  
  
</div>



 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window24.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window24.png" >
  
    </a>
  
  
</div>

</blockquote>
<h1 id="24windowcontainer">2.4WindowContainer</h1>
<p>Android窗口是根据显示屏幕来管理，每个显示屏幕的窗口层级分为36层，1-36层。每层可以放置多个窗口，上层窗口覆盖下面的。要理解窗口的结构，需要学习下WindowContainer、RootWindowContainer、DisplayContent、TaskDisplayArea、Task、ActivityRecord、WindowToken、WindowState、WindowContainer等类。</p>
<h3 id="241window容器架构和继承关系图">2.4.1Window容器架构和继承关系图</h3>
<h4 id="2411window容器架构">2.4.1.1Window容器架构</h4>
<p>android11和android13两个版本架构差异比较大，所以为了更好地理解，将分别展示出两个版本的架构</p>
<p>android11 Window容器架构图</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window3.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window3.png" >
  
    </a>
  
  
</div>

<p>android13 Window容器架构图</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window3_1.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window3_1.png" >
  
    </a>
  
  
</div>

<h4 id="2412window容器继承关系">2.4.1.2Window容器继承关系</h4>
<p>android11 Window容器继承关系图</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window6.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window6.png" >
  
    </a>
  
  
</div>

<p>android13 Window容器继承关系图</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window6_1.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window6_1.png" >
  
    </a>
  
  
</div>

<h3 id="242源码解析window容器">2.4.2源码解析Window容器</h3>
<h4 id="2421windowcontainer">2.4.2.1WindowContainer</h4>
<p>Window容器的源头，为直接包含窗口或者通过孩子层级形式包含窗口的类，定义了普遍功能。它作为基类被继承，像RootWindowContainer、DisplayContent、TaskDisplayArea、Task、ActivityRecord、WindowToken、WindowState都是直接或间接的继承该类。</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln">1</span><span class="c1">//frameworks/base/services/core/java/com/android/server/wm/WindowContainer.java
</span><span class="ln">2</span><span class="c1"></span><span class="kd">class</span> <span class="nc">WindowContainer</span><span class="o">&lt;</span><span class="n">E</span> <span class="kd">extends</span> <span class="n">WindowContainer</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">ConfigurationContainer</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span>
<span class="ln">3</span>    <span class="kd">implements</span> <span class="n">Comparable</span><span class="o">&lt;</span><span class="n">WindowContainer</span><span class="o">&gt;,</span> <span class="n">Animatable</span><span class="o">,</span> <span class="n">SurfaceFreezer</span><span class="o">.</span><span class="na">Freezable</span><span class="o">,</span>
<span class="ln">4</span><span class="n">InsetsControlTarget</span> <span class="o">{</span>
<span class="ln">5</span>    <span class="c1">//mParent是当前WindowContainer容器的父容器
</span><span class="ln">6</span><span class="c1"></span>    <span class="kd">private</span> <span class="n">WindowContainer</span> <span class="n">mParent</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="ln">7</span>    <span class="c1">//mChildren是一个继承WindowContainer的集合对象，说明当前WindowContainer可能会有好几个子容器
</span><span class="ln">8</span><span class="c1"></span>    <span class="kd">protected</span> <span class="kd">final</span> <span class="n">WindowList</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span> <span class="n">mChildren</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WindowList</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;();</span>
<span class="ln">9</span><span class="o">};</span>
</code></pre></div><p>对于WindowContainer需要了解两个成员变量，mParent和mChildren，一个是容器本身的父容器，另一个是容器的子容器（类似上有老下有小的概念，老人只能有一个，小孩可以是多个）</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window26.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window26.png" >
  
    </a>
  
  
</div>

<h4 id="2422窗口结构层级相关类">2.4.2.2窗口结构层级相关类</h4>
<p>从Android12开始引入Window的<strong>特色模式</strong>，更好地管理Window的各个层级相关类</p>
<ul>
<li>
<p>RootWindowContainer：根窗口容器，树的根是它。通过它遍历寻找，可以找到窗口树上的窗口。它的孩子是DisplayContent。</p>
</li>
<li>
<p>DisplayContent：该类是对应着显示屏幕的，Android是支持多屏幕的，所以可能存在多个DisplayContent对象。上图只画了一个对象的结构，其他对象的结构也是和画的对象的结构是相似的。</p>
</li>
<li>
<p>DisplayArea：该类是对应着显示屏幕下面的，代表一组窗口合集,具有多个子类，如Tokens，TaskDisplayArea等</p>
</li>
<li>
<p>TaskDisplayArea：它为DisplayContent的孩子，对应着窗口层次的第2层。第2层作为应用层，看它的定义：int APPLICATION_LAYER = 2，应用层的窗口是处于第2层。TaskDisplayArea的孩子是Task类，其实它的孩子类型也可以是TaskDisplayArea。而Task的孩子则可以是ActivityRecord，也可以是Task。</p>
</li>
<li>
<p>Tokens：代表专门包含WindowTokens的容器，它的孩子是WindowToken，而WindowToken的孩子则为WindowState对象。</p>
</li>
<li>
<p>ImeContainer：它是输入法窗口的容器，它的孩子是WindowToken类型。WindowToken的孩子为WindowState类型，而WindowState类型则对应着输入法窗口。</p>
</li>
<li>
<p>Task：任务，它的孩子可以是Task，也可以是ActivityRecord类型。</p>
</li>
<li>
<p>ActivityRecord：是对应着应用进程中的Activity的。ActivityRecord是继承WindowToken的，它的孩子类型为WindowState。</p>
</li>
<li>
<p>WindowState：WindowState是对应着一个窗口的。</p>
</li>
</ul>
<p>上面的文字介绍可能会懵，没关系，先了解一下大概，下面会一一介绍内容。</p>
<h4 id="2423rootwindowcontainer">2.4.2.3RootWindowContainer</h4>
<p>1）<strong>RootWindowContainer构造</strong></p>
<p>RootWindowContainer的构造是在WindowManagerService中，其中RootWindowContainer对象作为WindowManagerService的成员变量mRoot 存在。</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/services/core/java/com/android/server/wm/WindowManagerService.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">WindowManagerService</span> <span class="kd">extends</span> <span class="n">IWindowManager</span><span class="o">.</span><span class="na">Stub</span>
<span class="ln"> 3</span>    <span class="kd">implements</span> <span class="n">Watchdog</span><span class="o">.</span><span class="na">Monitor</span><span class="o">,</span> <span class="n">WindowManagerPolicy</span><span class="o">.</span><span class="na">WindowManagerFuncs</span> <span class="o">{</span>
<span class="ln"> 4</span>    <span class="n">RootWindowContainer</span> <span class="n">mRoot</span><span class="o">;</span>
<span class="ln"> 5</span>    <span class="kd">private</span> <span class="nf">WindowManagerService</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">InputManagerService</span> <span class="n">inputManager</span><span class="o">,</span>
<span class="ln"> 6</span>                                 <span class="kt">boolean</span> <span class="n">showBootMsgs</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">onlyCore</span><span class="o">,</span> <span class="n">WindowManagerPolicy</span> <span class="n">policy</span><span class="o">,</span>
<span class="ln"> 7</span>                                 <span class="n">ActivityTaskManagerService</span> <span class="n">atm</span><span class="o">,</span> <span class="n">DisplayWindowSettingsProvider</span>
<span class="ln"> 8</span>                                 <span class="n">displayWindowSettingsProvider</span><span class="o">,</span> <span class="n">Supplier</span><span class="o">&lt;</span><span class="n">SurfaceControl</span><span class="o">.</span><span class="na">Transaction</span><span class="o">&gt;</span>                                          <span class="n">transactionFactory</span><span class="o">,</span><span class="n">Supplier</span><span class="o">&lt;</span><span class="n">Surface</span><span class="o">&gt;</span> <span class="n">surfaceFactory</span><span class="o">,</span>
<span class="ln"> 9</span>                                 <span class="n">Function</span><span class="o">&lt;</span><span class="n">SurfaceSession</span><span class="o">,</span> <span class="n">SurfaceControl</span><span class="o">.</span><span class="na">Builder</span><span class="o">&gt;</span> <span class="n">surfaceControlFactory</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">10</span>        <span class="o">...</span>
<span class="ln">11</span>        <span class="n">mRoot</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RootWindowContainer</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
<span class="ln">12</span>        <span class="n">mDisplayAreaPolicyProvider</span> <span class="o">=</span> <span class="n">DisplayAreaPolicy</span><span class="o">.</span><span class="na">Provider</span><span class="o">.</span><span class="na">fromResources</span><span class="o">(</span>
<span class="ln">13</span>                <span class="n">mContext</span><span class="o">.</span><span class="na">getResources</span><span class="o">());</span>
<span class="ln">14</span>        <span class="o">...</span>
<span class="ln">15</span>    <span class="o">}</span>
<span class="ln">16</span><span class="o">}</span>
</code></pre></div><p>2）<strong>setWindowManager</strong></p>
<p>在ActivityTaskManagerService类中，会调用setWindowManager(WindowManagerService wm)方法</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/services/core/java/com/android/server/wm/ActivityTaskManagerService.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ActivityTaskManagerService</span> <span class="kd">extends</span> <span class="n">IActivityTaskManager</span><span class="o">.</span><span class="na">Stub</span> <span class="o">{</span>
<span class="ln"> 3</span>    <span class="n">RootWindowContainer</span> <span class="n">mRootWindowContainer</span><span class="o">;</span>
<span class="ln"> 4</span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setWindowManager</span><span class="o">(</span><span class="n">WindowManagerService</span> <span class="n">wm</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 5</span>        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mGlobalLock</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 6</span>            <span class="n">mWindowManager</span> <span class="o">=</span> <span class="n">wm</span><span class="o">;</span>
<span class="ln"> 7</span>            <span class="n">mRootWindowContainer</span> <span class="o">=</span> <span class="n">wm</span><span class="o">.</span><span class="na">mRoot</span><span class="o">;</span>
<span class="ln"> 8</span>            <span class="n">mRootWindowContainer</span><span class="o">.</span><span class="na">setWindowManager</span><span class="o">(</span><span class="n">wm</span><span class="o">);</span>
<span class="ln"> 9</span>            <span class="o">...</span>
<span class="ln">10</span>        <span class="o">}</span>
<span class="ln">11</span>    <span class="o">}</span>
<span class="ln">12</span><span class="o">}</span>
</code></pre></div><p>ActivityTaskManagerService的成员变量mRootWindowContainer 也赋值为RootWindowContainer根对象。最后会调用RootWindowContainer的setWindowManager(wm)方法</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/services/core/java/com/android/server/wm/RootWindowContainer.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">class</span> <span class="nc">RootWindowContainer</span> <span class="kd">extends</span> <span class="n">WindowContainer</span><span class="o">&lt;</span><span class="n">DisplayContent</span><span class="o">&gt;</span>
<span class="ln"> 3</span>    <span class="kd">implements</span> <span class="n">DisplayManager</span><span class="o">.</span><span class="na">DisplayListener</span> <span class="o">{</span>
<span class="ln"> 4</span>    <span class="kt">void</span> <span class="nf">setWindowManager</span><span class="o">(</span><span class="n">WindowManagerService</span> <span class="n">wm</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 5</span>        <span class="c1">//这里的mWindowManager指的是WindowManagerservice的实例
</span><span class="ln"> 6</span><span class="c1"></span>        <span class="n">mWindowManager</span> <span class="o">=</span> <span class="n">wm</span><span class="o">;</span>
<span class="ln"> 7</span>        <span class="c1">//这里的mDisplayManager对应DisplayManagerService服务
</span><span class="ln"> 8</span><span class="c1"></span>        <span class="n">mDisplayManager</span> <span class="o">=</span> <span class="n">mService</span><span class="o">.</span><span class="na">mContext</span><span class="o">.</span><span class="na">getSystemService</span><span class="o">(</span><span class="n">DisplayManager</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="ln"> 9</span>        <span class="n">mDisplayManager</span><span class="o">.</span><span class="na">registerDisplayListener</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">mService</span><span class="o">.</span><span class="na">mUiHandler</span><span class="o">);</span>
<span class="ln">10</span>        <span class="n">mDisplayManagerInternal</span> <span class="o">=</span> <span class="n">LocalServices</span><span class="o">.</span><span class="na">getService</span><span class="o">(</span><span class="n">DisplayManagerInternal</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="ln">11</span>        <span class="c1">//这里的Display是屏幕，包括虚拟屏幕，默认只有一个屏幕
</span><span class="ln">12</span><span class="c1"></span>        <span class="kd">final</span> <span class="n">Display</span><span class="o">[]</span> <span class="n">displays</span> <span class="o">=</span> <span class="n">mDisplayManager</span><span class="o">.</span><span class="na">getDisplays</span><span class="o">();</span><span class="c1">//1
</span><span class="ln">13</span><span class="c1"></span>        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">displayNdx</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">displayNdx</span> <span class="o">&lt;</span> <span class="n">displays</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="o">++</span><span class="n">displayNdx</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">14</span>            <span class="kd">final</span> <span class="n">Display</span> <span class="n">display</span> <span class="o">=</span> <span class="n">displays</span><span class="o">[</span><span class="n">displayNdx</span><span class="o">];</span>
<span class="ln">15</span>            <span class="kd">final</span> <span class="n">DisplayContent</span> <span class="n">displayContent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DisplayContent</span><span class="o">(</span><span class="n">display</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
<span class="ln">16</span>            <span class="n">addChild</span><span class="o">(</span><span class="n">displayContent</span><span class="o">,</span> <span class="n">POSITION_BOTTOM</span><span class="o">);</span><span class="c1">//2
</span><span class="ln">17</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">displayContent</span><span class="o">.</span><span class="na">mDisplayId</span> <span class="o">==</span> <span class="n">DEFAULT_DISPLAY</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">18</span>                <span class="n">mDefaultDisplay</span> <span class="o">=</span> <span class="n">displayContent</span><span class="o">;</span><span class="c1">//3
</span><span class="ln">19</span><span class="c1"></span>            <span class="o">}</span>
<span class="ln">20</span>        <span class="o">}</span>
<span class="ln">21</span>        <span class="c1">//添加Home Task,本文不作讨论
</span><span class="ln">22</span><span class="c1"></span>        <span class="kd">final</span> <span class="n">TaskDisplayArea</span> <span class="n">defaultTaskDisplayArea</span> <span class="o">=</span> <span class="n">getDefaultTaskDisplayArea</span><span class="o">();</span>
<span class="ln">23</span>        <span class="n">defaultTaskDisplayArea</span><span class="o">.</span><span class="na">getOrCreateRootHomeTask</span><span class="o">(</span><span class="n">ON_TOP</span><span class="o">);</span><span class="c1">//4
</span><span class="ln">24</span><span class="c1"></span>        <span class="n">positionChildAt</span><span class="o">(</span><span class="n">POSITION_TOP</span><span class="o">,</span> <span class="n">defaultTaskDisplayArea</span><span class="o">.</span><span class="na">mDisplayContent</span><span class="o">,</span>
<span class="ln">25</span>                        <span class="kc">false</span> <span class="cm">/* includingParents */</span><span class="o">);</span><span class="c1">//5
</span><span class="ln">26</span><span class="c1"></span>    <span class="o">}</span>
<span class="ln">27</span><span class="o">}</span>
</code></pre></div><p>这里只介绍Window层级关系，setWindowManager后边的添加Home Task不在本文讨论，详情可以看<a href="https://blog.csdn.net/q1165328963/article/details/127841486?spm=1001.2014.3001.5502">这里</a>。</p>
<ol>
<li>通过屏幕管理对象mDisplayManager得到所有的显示屏幕，然后构造DisplayContent对象</li>
<li>通过addChild方法将DisplayContent对象添加到RootWindowContainer根对象的树状结构中</li>
<li>默认显示屏幕的mDisplayId 是DEFAULT_DISPLAY，mDisplayId 为0作为基本显示屏幕</li>
<li>获取默认屏幕的TaskDisplayArea，创建一个根Home任务</li>
<li>最后把默认屏幕放在RootWindowContainer根对象的孩子的最上面</li>
</ol>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window27.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window27.png" >
  
    </a>
  
  
</div>

<h4 id="2424displaycontent">2.4.2.4DisplayContent</h4>
<p>源码的内容比较多，这里只挑选部分Window容器源码部分</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/services/core/java/com/android/server/wm/DisplayContent.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">class</span> <span class="nc">DisplayContent</span> <span class="kd">extends</span> <span class="n">RootDisplayArea</span> <span class="kd">implements</span> <span class="n">WindowManagerPolicy</span><span class="o">.</span><span class="na">DisplayContentInfo</span> <span class="o">{</span>
<span class="ln"> 3</span>    <span class="kd">final</span> <span class="n">ActivityTaskManagerService</span> <span class="n">mAtmService</span><span class="o">;</span>
<span class="ln"> 4</span>    <span class="n">DisplayContent</span><span class="o">(</span><span class="n">Display</span> <span class="n">display</span><span class="o">,</span> <span class="n">RootWindowContainer</span> <span class="n">root</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 5</span>        <span class="c1">//DisplayContent继承于RootDisplayArea
</span><span class="ln"> 6</span><span class="c1"></span>        <span class="kd">super</span><span class="o">(</span><span class="n">root</span><span class="o">.</span><span class="na">mWindowManager</span><span class="o">,</span> <span class="s">&#34;DisplayContent&#34;</span><span class="o">,</span> <span class="n">FEATURE_ROOT</span><span class="o">);</span>
<span class="ln"> 7</span>        <span class="o">...</span>
<span class="ln"> 8</span>        <span class="n">mRootWindowContainer</span> <span class="o">=</span> <span class="n">root</span><span class="o">;</span>
<span class="ln"> 9</span>        <span class="c1">//mAtmService是ActivityTaskManagerService实例
</span><span class="ln">10</span><span class="c1"></span>        <span class="n">mAtmService</span> <span class="o">=</span> <span class="n">mWmService</span><span class="o">.</span><span class="na">mAtmService</span><span class="o">;</span>
<span class="ln">11</span>        <span class="n">mDisplay</span> <span class="o">=</span> <span class="n">display</span><span class="o">;</span>
<span class="ln">12</span>        <span class="n">mDisplayPolicy</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DisplayPolicy</span><span class="o">(</span><span class="n">mWmService</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
<span class="ln">13</span>        <span class="kd">final</span> <span class="n">Transaction</span> <span class="n">pendingTransaction</span> <span class="o">=</span> <span class="n">getPendingTransaction</span><span class="o">();</span>
<span class="ln">14</span>        <span class="n">configureSurfaces</span><span class="o">(</span><span class="n">pendingTransaction</span><span class="o">);</span>
<span class="ln">15</span>        <span class="n">pendingTransaction</span><span class="o">.</span><span class="na">apply</span><span class="o">();</span>
<span class="ln">16</span>        <span class="c1">// Sets the display content for the children.
</span><span class="ln">17</span><span class="c1"></span>        <span class="n">setWindowingMode</span><span class="o">(</span><span class="n">WINDOWING_MODE_FULLSCREEN</span><span class="o">);</span>
<span class="ln">18</span>        <span class="n">mWmService</span><span class="o">.</span><span class="na">mDisplayWindowSettings</span><span class="o">.</span><span class="na">applySettingsToDisplayLocked</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
<span class="ln">19</span>        <span class="o">...</span>
<span class="ln">20</span>    <span class="o">}</span>
<span class="ln">21</span><span class="o">}</span>
</code></pre></div><p>其中configureSurfaces是窗口构建的部分</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/services/core/java/com/android/server/wm/DisplayContent.java
</span><span class="ln"> 2</span><span class="c1">//这个是输入法Window容器
</span><span class="ln"> 3</span><span class="c1"></span><span class="kd">private</span> <span class="kd">final</span> <span class="n">ImeContainer</span> <span class="n">mImeWindowsContainer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ImeContainer</span><span class="o">(</span><span class="n">mWmService</span><span class="o">);</span>
<span class="ln"> 4</span><span class="kd">private</span> <span class="kt">void</span> <span class="nf">configureSurfaces</span><span class="o">(</span><span class="n">Transaction</span> <span class="n">transaction</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 5</span>    <span class="k">if</span> <span class="o">(</span><span class="n">mDisplayAreaPolicy</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 6</span>        <span class="c1">//设置策略并构建显示区域层次结构,只有在创建Surface之后才能构建层次结构，这样才能正确地重新生成
</span><span class="ln"> 7</span><span class="c1"></span>        <span class="c1">//这里的mWmService是wms
</span><span class="ln"> 8</span><span class="c1"></span>        <span class="n">mDisplayAreaPolicy</span> <span class="o">=</span> <span class="n">mWmService</span><span class="o">.</span><span class="na">getDisplayAreaPolicyProvider</span><span class="o">().</span><span class="na">instantiate</span><span class="o">(</span>
<span class="ln"> 9</span>            <span class="n">mWmService</span><span class="o">,</span> <span class="k">this</span> <span class="cm">/* content */</span><span class="o">,</span> <span class="k">this</span> <span class="cm">/* root */</span><span class="o">,</span>
<span class="ln">10</span>            <span class="n">mImeWindowsContainer</span><span class="o">);</span>
<span class="ln">11</span>    <span class="o">}</span>
<span class="ln">12</span>    <span class="o">...</span>
<span class="ln">13</span><span class="o">}</span>
</code></pre></div><h4 id="2425displayareapolicy">2.4.2.5DisplayAreaPolicy</h4>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln">1</span><span class="c1">//frameworks/base/services/core/java/com/android/server/wm/WindowManagerService.java
</span><span class="ln">2</span><span class="c1"></span><span class="n">DisplayAreaPolicy</span><span class="o">.</span><span class="na">Provider</span> <span class="nf">getDisplayAreaPolicyProvider</span><span class="o">()</span> <span class="o">{</span>
<span class="ln">3</span>    <span class="k">return</span> <span class="n">mDisplayAreaPolicyProvider</span><span class="o">;</span>
<span class="ln">4</span><span class="o">}</span>
</code></pre></div><p>这里的mDisplayAreaPolicyProvider实际上是上面2.4.2.3RootWindowContainer构造的时候生成的，DisplayAreaPolicy.Provider.fromResources</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/services/core/java/com/android/server/wm/DisplayAreaPolicy.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">DisplayAreaPolicy</span> <span class="o">{</span>
<span class="ln"> 3</span>    <span class="kd">protected</span> <span class="kd">final</span> <span class="n">WindowManagerService</span> <span class="n">mWmService</span><span class="o">;</span>
<span class="ln"> 4</span>    <span class="c1">//这个mRoot会在后续的内容中用到
</span><span class="ln"> 5</span><span class="c1"></span>    <span class="kd">protected</span> <span class="kd">final</span> <span class="n">RootDisplayArea</span> <span class="n">mRoot</span><span class="o">;</span>
<span class="ln"> 6</span>    <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Provider</span> <span class="o">{</span>
<span class="ln"> 7</span>        <span class="n">DisplayAreaPolicy</span> <span class="nf">instantiate</span><span class="o">(</span><span class="n">WindowManagerService</span> <span class="n">wmService</span><span class="o">,</span> <span class="n">DisplayContent</span> <span class="n">content</span><span class="o">,</span>
<span class="ln"> 8</span>                                      <span class="n">RootDisplayArea</span> <span class="n">root</span><span class="o">,</span> <span class="n">DisplayArea</span><span class="o">.</span><span class="na">Tokens</span> <span class="n">imeContainer</span><span class="o">);</span>
<span class="ln"> 9</span>        <span class="kd">static</span> <span class="n">Provider</span> <span class="nf">fromResources</span><span class="o">(</span><span class="n">Resources</span> <span class="n">res</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">10</span>            <span class="c1">//这个name在/frameworks/base/core/res/res/values/config.xml中定义，里面为空
</span><span class="ln">11</span><span class="c1"></span>            <span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span>
<span class="ln">12</span>                <span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">config_deviceSpecificDisplayAreaPolicyProvider</span><span class="o">);</span>
<span class="ln">13</span>            <span class="k">if</span> <span class="o">(</span><span class="n">TextUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">name</span><span class="o">))</span> <span class="o">{</span>
<span class="ln">14</span>                <span class="k">return</span> <span class="k">new</span> <span class="n">DisplayAreaPolicy</span><span class="o">.</span><span class="na">DefaultProvider</span><span class="o">();</span>
<span class="ln">15</span>            <span class="o">}</span>
<span class="ln">16</span>            <span class="c1">//上面的name定义了的话用反射方式来实例化一个Provider
</span><span class="ln">17</span><span class="c1"></span>            <span class="k">try</span> <span class="o">{</span>
<span class="ln">18</span>                <span class="k">return</span> <span class="o">(</span><span class="n">Provider</span><span class="o">)</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="n">name</span><span class="o">).</span><span class="na">newInstance</span><span class="o">();</span>
<span class="ln">19</span>            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ReflectiveOperationException</span> <span class="o">|</span> <span class="n">ClassCastException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">20</span>                <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span><span class="s">&#34;Couldn&#39;t instantiate class &#34;</span> <span class="o">+</span> <span class="n">name</span>
<span class="ln">21</span>                                                <span class="o">+</span> <span class="s">&#34; for config_deviceSpecificDisplayAreaPolicyProvider:&#34;</span>
<span class="ln">22</span>                                                <span class="o">+</span> <span class="s">&#34; make sure it has a public zero-argument constructor&#34;</span>
<span class="ln">23</span>                                                <span class="o">+</span> <span class="s">&#34; and implements DisplayAreaPolicy.Provider&#34;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
<span class="ln">24</span>            <span class="o">}</span>
<span class="ln">25</span>        <span class="o">}</span>
<span class="ln">26</span>    <span class="o">}</span>
<span class="ln">27</span><span class="o">}</span>
</code></pre></div><p>可以看到mDisplayAreaPolicyProvider 的具体类型是可以在系统资源文件中配置的，资源字符串属性为config_deviceSpecificDisplayAreaPolicyProvider，如果为空，类型则为DefaultProvider类型。目前查看，资源文件里没有配置字符值。所以mDisplayAreaPolicyProvider类型则为DefaultProvider类型。</p>
<div class="highlight"><pre class="chroma"><code class="language-xml" data-lang="xml"><span class="ln">1</span><span class="c">&lt;!-- /frameworks/base/core/res/res/values/config.xml --&gt;</span>
<span class="ln">2</span><span class="nt">&lt;resources</span> <span class="na">xmlns:xliff=</span><span class="s">&#34;urn:oasis:names:tc:xliff:document:1.2&#34;</span><span class="nt">&gt;</span>
<span class="ln">3</span>    ...
<span class="ln">4</span>    <span class="nt">&lt;string</span> <span class="na">translatable=</span><span class="s">&#34;false&#34;</span> <span class="na">name=</span><span class="s">&#34;config_deviceSpecificDisplayAreaPolicyProvider&#34;</span><span class="nt">&gt;&lt;/string&gt;</span>
<span class="ln">5</span>    ...
<span class="ln">6</span><span class="nt">&lt;/resources&gt;</span>
</code></pre></div><p>上面的mDisplayAreaPolicy实际上就是new DisplayAreaPolicy.DefaultProvider().instantiate</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/services/core/java/com/android/server/wm/DisplayAreaPolicy.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">DisplayAreaPolicy</span> <span class="o">{</span>
<span class="ln"> 3</span>    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">DefaultProvider</span> <span class="kd">implements</span> <span class="n">DisplayAreaPolicy</span><span class="o">.</span><span class="na">Provider</span> <span class="o">{</span>
<span class="ln"> 4</span>        <span class="nd">@Override</span>
<span class="ln"> 5</span>        <span class="kd">public</span> <span class="n">DisplayAreaPolicy</span> <span class="nf">instantiate</span><span class="o">(</span><span class="n">WindowManagerService</span> <span class="n">wmService</span><span class="o">,</span>
<span class="ln"> 6</span>                                             <span class="n">DisplayContent</span> <span class="n">content</span><span class="o">,</span> <span class="n">RootDisplayArea</span> <span class="n">root</span><span class="o">,</span>
<span class="ln"> 7</span>                                             <span class="n">DisplayArea</span><span class="o">.</span><span class="na">Tokens</span> <span class="n">imeContainer</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 8</span>            <span class="kd">final</span> <span class="n">TaskDisplayArea</span> <span class="n">defaultTaskDisplayArea</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TaskDisplayArea</span><span class="o">(</span><span class="n">content</span><span class="o">,</span> <span class="n">wmService</span><span class="o">,</span>
<span class="ln"> 9</span>                                                                               <span class="s">&#34;DefaultTaskDisplayArea&#34;</span><span class="o">,</span> <span class="n">FEATURE_DEFAULT_TASK_CONTAINER</span><span class="o">);</span><span class="c1">//1
</span><span class="ln">10</span><span class="c1"></span>            <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">TaskDisplayArea</span><span class="o">&gt;</span> <span class="n">tdaList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
<span class="ln">11</span>            <span class="n">tdaList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">defaultTaskDisplayArea</span><span class="o">);</span>
<span class="ln">12</span>            <span class="c1">//在整个逻辑显示的根下定义将被支持的特性。该策略将基于此构建DisplayArea层次结构
</span><span class="ln">13</span><span class="c1"></span>            <span class="c1">//这个特性就是Android12引入的特性，这里的root是上面传入的当前的DisplayContent的this指针
</span><span class="ln">14</span><span class="c1"></span>            <span class="kd">final</span> <span class="n">HierarchyBuilder</span> <span class="n">rootHierarchy</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HierarchyBuilder</span><span class="o">(</span><span class="n">root</span><span class="o">);</span><span class="c1">//2
</span><span class="ln">15</span><span class="c1"></span>            <span class="c1">// 设置基本容器(即使显示器不支持输入法)。
</span><span class="ln">16</span><span class="c1"></span>            <span class="n">rootHierarchy</span><span class="o">.</span><span class="na">setImeContainer</span><span class="o">(</span><span class="n">imeContainer</span><span class="o">).</span><span class="na">setTaskDisplayAreas</span><span class="o">(</span><span class="n">tdaList</span><span class="o">);</span><span class="c1">//2
</span><span class="ln">17</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">content</span><span class="o">.</span><span class="na">isTrusted</span><span class="o">())</span> <span class="o">{</span>
<span class="ln">18</span>                <span class="c1">//只有信任的显示可以有特色模式建造
</span><span class="ln">19</span><span class="c1"></span>                <span class="n">configureTrustedHierarchyBuilder</span><span class="o">(</span><span class="n">rootHierarchy</span><span class="o">,</span> <span class="n">wmService</span><span class="o">,</span> <span class="n">content</span><span class="o">);</span><span class="c1">//3
</span><span class="ln">20</span><span class="c1"></span>            <span class="o">}</span>
<span class="ln">21</span>            <span class="c1">// 使用上面定义的层次结构实例化策略，这将创建并附加所有必要的显示区域到根目录
</span><span class="ln">22</span><span class="c1"></span>            <span class="k">return</span> <span class="k">new</span> <span class="n">DisplayAreaPolicyBuilder</span><span class="o">().</span><span class="na">setRootHierarchy</span><span class="o">(</span><span class="n">rootHierarchy</span><span class="o">).</span><span class="na">build</span><span class="o">(</span><span class="n">wmService</span><span class="o">);</span><span class="c1">//4
</span><span class="ln">23</span><span class="c1"></span>        <span class="o">}</span>
<span class="ln">24</span>    <span class="o">}</span>
<span class="ln">25</span><span class="o">}</span>
</code></pre></div><ol>
<li>新建一个TaskDisplayArea 实例defaultTaskDisplayArea</li>
<li>接着创建HierarchyBuilder 实例， 将输入法窗口容器和defaultTaskDisplayArea 都设置到它的成员变量里面</li>
<li>接着判断显示屏是否是可信任的，主要是添加一些特色模式</li>
<li>采用建造者模式新建DisplayAreaPolicyBuilder对象，返回的是一个DisplayAreaPolicy实例，即Result对象</li>
</ol>
<p>1）构造TaskDisplayArea</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/services/core/java/com/android/server/wm/TaskDisplayArea.java
</span><span class="ln"> 2</span><span class="c1">//这里传入的name为DefaultTaskDisplayArea
</span><span class="ln"> 3</span><span class="c1"></span><span class="kd">final</span> <span class="kd">class</span> <span class="nc">TaskDisplayArea</span> <span class="kd">extends</span> <span class="n">DisplayArea</span><span class="o">&lt;</span><span class="n">WindowContainer</span><span class="o">&gt;</span> <span class="o">{</span>
<span class="ln"> 4</span>    <span class="n">TaskDisplayArea</span><span class="o">(</span><span class="n">DisplayContent</span> <span class="n">displayContent</span><span class="o">,</span> <span class="n">WindowManagerService</span> <span class="n">service</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">,</span>
<span class="ln"> 5</span>                    <span class="kt">int</span> <span class="n">displayAreaFeature</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 6</span>        <span class="k">this</span><span class="o">(</span><span class="n">displayContent</span><span class="o">,</span> <span class="n">service</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="n">displayAreaFeature</span><span class="o">,</span> <span class="kc">false</span> <span class="cm">/* createdByOrganizer */</span><span class="o">,</span>
<span class="ln"> 7</span>             <span class="kc">true</span> <span class="cm">/* canHostHomeTask */</span><span class="o">);</span>
<span class="ln"> 8</span>    <span class="o">}</span>
<span class="ln"> 9</span>
<span class="ln">10</span>    <span class="n">TaskDisplayArea</span><span class="o">(</span><span class="n">DisplayContent</span> <span class="n">displayContent</span><span class="o">,</span> <span class="n">WindowManagerService</span> <span class="n">service</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">,</span>
<span class="ln">11</span>                    <span class="kt">int</span> <span class="n">displayAreaFeature</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">createdByOrganizer</span><span class="o">,</span>
<span class="ln">12</span>                    <span class="kt">boolean</span> <span class="n">canHostHomeTask</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">13</span>        <span class="kd">super</span><span class="o">(</span><span class="n">service</span><span class="o">,</span> <span class="n">Type</span><span class="o">.</span><span class="na">ANY</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="n">displayAreaFeature</span><span class="o">);</span>
<span class="ln">14</span>        <span class="n">mDisplayContent</span> <span class="o">=</span> <span class="n">displayContent</span><span class="o">;</span>
<span class="ln">15</span>        <span class="n">mRootWindowContainer</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="na">mRoot</span><span class="o">;</span>
<span class="ln">16</span>        <span class="n">mAtmService</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="na">mAtmService</span><span class="o">;</span>
<span class="ln">17</span>        <span class="n">mCreatedByOrganizer</span> <span class="o">=</span> <span class="n">createdByOrganizer</span><span class="o">;</span>
<span class="ln">18</span>        <span class="n">mCanHostHomeTask</span> <span class="o">=</span> <span class="n">canHostHomeTask</span><span class="o">;</span>
<span class="ln">19</span>    <span class="o">}</span>
<span class="ln">20</span><span class="o">}</span>
</code></pre></div><p>2）构造HierarchyBuilder</p>
<p>Android12引入的特色模式</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/services/core/java/com/android/server/wm/DisplayAreaPolicyBuilder.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">class</span> <span class="nc">DisplayAreaPolicyBuilder</span> <span class="o">{</span>
<span class="ln"> 3</span>    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">HierarchyBuilder</span> <span class="o">{</span>
<span class="ln"> 4</span>        <span class="c1">//这里只有三种Token类型，TASK，IME和TOKENS
</span><span class="ln"> 5</span><span class="c1"></span>        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">LEAF_TYPE_TASK_CONTAINERS</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
<span class="ln"> 6</span>        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">LEAF_TYPE_IME_CONTAINERS</span> <span class="o">=</span> <span class="n">2</span><span class="o">;</span>
<span class="ln"> 7</span>        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">LEAF_TYPE_TOKENS</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
<span class="ln"> 8</span>        <span class="c1">//这个是根Root容器
</span><span class="ln"> 9</span><span class="c1"></span>        <span class="kd">private</span> <span class="kd">final</span> <span class="n">RootDisplayArea</span> <span class="n">mRoot</span><span class="o">;</span>
<span class="ln">10</span>        <span class="kd">private</span> <span class="kd">final</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">DisplayAreaPolicyBuilder</span><span class="o">.</span><span class="na">Feature</span><span class="o">&gt;</span> <span class="n">mFeatures</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
<span class="ln">11</span>        <span class="kd">private</span> <span class="kd">final</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">TaskDisplayArea</span><span class="o">&gt;</span> <span class="n">mTaskDisplayAreas</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
<span class="ln">12</span>        <span class="nd">@Nullable</span>
<span class="ln">13</span>        <span class="kd">private</span> <span class="n">DisplayArea</span><span class="o">.</span><span class="na">Tokens</span> <span class="n">mImeContainer</span><span class="o">;</span>
<span class="ln">14</span>        <span class="c1">//这里构造传入的root实际上是DisplayContent的实例对象
</span><span class="ln">15</span><span class="c1"></span>        <span class="n">HierarchyBuilder</span><span class="o">(</span><span class="n">RootDisplayArea</span> <span class="n">root</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">16</span>            <span class="n">mRoot</span> <span class="o">=</span> <span class="n">root</span><span class="o">;</span>
<span class="ln">17</span>        <span class="o">}</span>
<span class="ln">18</span>
<span class="ln">19</span>        <span class="n">HierarchyBuilder</span> <span class="nf">addFeature</span><span class="o">(</span><span class="n">DisplayAreaPolicyBuilder</span><span class="o">.</span><span class="na">Feature</span> <span class="n">feature</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">20</span>            <span class="n">mFeatures</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">feature</span><span class="o">);</span>
<span class="ln">21</span>            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
<span class="ln">22</span>        <span class="o">}</span>
<span class="ln">23</span>
<span class="ln">24</span>        <span class="n">HierarchyBuilder</span> <span class="nf">setTaskDisplayAreas</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">TaskDisplayArea</span><span class="o">&gt;</span> <span class="n">taskDisplayAreas</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">25</span>            <span class="n">mTaskDisplayAreas</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
<span class="ln">26</span>            <span class="n">mTaskDisplayAreas</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">taskDisplayAreas</span><span class="o">);</span>
<span class="ln">27</span>            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
<span class="ln">28</span>        <span class="o">}</span>
<span class="ln">29</span>
<span class="ln">30</span>        <span class="n">HierarchyBuilder</span> <span class="nf">setImeContainer</span><span class="o">(</span><span class="n">DisplayArea</span><span class="o">.</span><span class="na">Tokens</span> <span class="n">imeContainer</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">31</span>            <span class="n">mImeContainer</span> <span class="o">=</span> <span class="n">imeContainer</span><span class="o">;</span>
<span class="ln">32</span>            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
<span class="ln">33</span>        <span class="o">}</span>
<span class="ln">34</span>
<span class="ln">35</span>        <span class="kd">private</span> <span class="kt">void</span> <span class="nf">build</span><span class="o">()</span> <span class="o">{</span>
<span class="ln">36</span>            <span class="n">build</span><span class="o">(</span><span class="kc">null</span> <span class="cm">/* displayAreaGroupHierarchyBuilders */</span><span class="o">);</span>
<span class="ln">37</span>        <span class="o">}</span>
<span class="ln">38</span>        <span class="o">...</span>
<span class="ln">39</span>    <span class="o">}</span>
<span class="ln">40</span><span class="o">}</span>
</code></pre></div><p>3）特色模式建造</p>
<p>可以看到这里实际上还是特色模式的构建，其中里面传入的参数是Feature.Builder，显然又用到了建造者的设计模式</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/services/core/java/com/android/server/wm/DisplayAreaPolicy.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">private</span> <span class="kt">void</span> <span class="nf">configureTrustedHierarchyBuilder</span><span class="o">(</span><span class="n">HierarchyBuilder</span> <span class="n">rootHierarchy</span><span class="o">,</span>
<span class="ln"> 3</span>                                              <span class="n">WindowManagerService</span> <span class="n">wmService</span><span class="o">,</span> <span class="n">DisplayContent</span> <span class="n">content</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 4</span>    <span class="n">rootHierarchy</span><span class="o">.</span><span class="na">addFeature</span><span class="o">(</span><span class="k">new</span> <span class="n">Feature</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="n">wmService</span><span class="o">.</span><span class="na">mPolicy</span><span class="o">,</span> <span class="s">&#34;WindowedMagnification&#34;</span><span class="o">,</span>
<span class="ln"> 5</span>                                                 <span class="n">FEATURE_WINDOWED_MAGNIFICATION</span><span class="o">)</span>
<span class="ln"> 6</span>                             <span class="o">.</span><span class="na">upTo</span><span class="o">(</span><span class="n">TYPE_ACCESSIBILITY_MAGNIFICATION_OVERLAY</span><span class="o">)</span>
<span class="ln"> 7</span>                             <span class="o">.</span><span class="na">except</span><span class="o">(</span><span class="n">TYPE_ACCESSIBILITY_MAGNIFICATION_OVERLAY</span><span class="o">)</span>
<span class="ln"> 8</span>                             <span class="c1">// Make the DA dimmable so that the magnify window also mirrors the dim layer.
</span><span class="ln"> 9</span><span class="c1"></span>                             <span class="o">.</span><span class="na">setNewDisplayAreaSupplier</span><span class="o">(</span><span class="n">DisplayArea</span><span class="o">.</span><span class="na">Dimmable</span><span class="o">::</span><span class="k">new</span><span class="o">)</span>
<span class="ln">10</span>                             <span class="o">.</span><span class="na">build</span><span class="o">());</span>
<span class="ln">11</span>    <span class="k">if</span> <span class="o">(</span><span class="n">content</span><span class="o">.</span><span class="na">isDefaultDisplay</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">12</span>        <span class="n">rootHierarchy</span><span class="o">.</span><span class="na">addFeature</span><span class="o">(</span><span class="k">new</span> <span class="n">Feature</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="n">wmService</span><span class="o">.</span><span class="na">mPolicy</span><span class="o">,</span> <span class="s">&#34;HideDisplayCutout&#34;</span><span class="o">,</span>
<span class="ln">13</span>                                                     <span class="n">FEATURE_HIDE_DISPLAY_CUTOUT</span><span class="o">)</span>
<span class="ln">14</span>                                 <span class="o">.</span><span class="na">all</span><span class="o">()</span>
<span class="ln">15</span>                                 <span class="o">.</span><span class="na">except</span><span class="o">(</span><span class="n">TYPE_NAVIGATION_BAR</span><span class="o">,</span> <span class="n">TYPE_NAVIGATION_BAR_PANEL</span><span class="o">,</span> <span class="n">TYPE_STATUS_BAR</span><span class="o">,</span>
<span class="ln">16</span>                                         <span class="n">TYPE_NOTIFICATION_SHADE</span><span class="o">)</span>
<span class="ln">17</span>                                 <span class="o">.</span><span class="na">build</span><span class="o">())</span>
<span class="ln">18</span>            <span class="o">.</span><span class="na">addFeature</span><span class="o">(</span><span class="k">new</span> <span class="n">Feature</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="n">wmService</span><span class="o">.</span><span class="na">mPolicy</span><span class="o">,</span> <span class="s">&#34;OneHanded&#34;</span><span class="o">,</span>
<span class="ln">19</span>                                            <span class="n">FEATURE_ONE_HANDED</span><span class="o">)</span>
<span class="ln">20</span>                        <span class="o">.</span><span class="na">all</span><span class="o">()</span>
<span class="ln">21</span>                        <span class="o">.</span><span class="na">except</span><span class="o">(</span><span class="n">TYPE_NAVIGATION_BAR</span><span class="o">,</span> <span class="n">TYPE_NAVIGATION_BAR_PANEL</span><span class="o">,</span>
<span class="ln">22</span>                                <span class="n">TYPE_SECURE_SYSTEM_OVERLAY</span><span class="o">)</span>
<span class="ln">23</span>                        <span class="o">.</span><span class="na">build</span><span class="o">());</span>
<span class="ln">24</span>    <span class="o">}</span>
<span class="ln">25</span>    <span class="n">rootHierarchy</span>
<span class="ln">26</span>        <span class="o">.</span><span class="na">addFeature</span><span class="o">(</span><span class="k">new</span> <span class="n">Feature</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="n">wmService</span><span class="o">.</span><span class="na">mPolicy</span><span class="o">,</span> <span class="s">&#34;FullscreenMagnification&#34;</span><span class="o">,</span>
<span class="ln">27</span>                                        <span class="n">FEATURE_FULLSCREEN_MAGNIFICATION</span><span class="o">)</span>
<span class="ln">28</span>                    <span class="o">.</span><span class="na">all</span><span class="o">()</span>
<span class="ln">29</span>                    <span class="o">.</span><span class="na">except</span><span class="o">(</span><span class="n">TYPE_ACCESSIBILITY_MAGNIFICATION_OVERLAY</span><span class="o">,</span> <span class="n">TYPE_INPUT_METHOD</span><span class="o">,</span>
<span class="ln">30</span>                            <span class="n">TYPE_INPUT_METHOD_DIALOG</span><span class="o">,</span> <span class="n">TYPE_MAGNIFICATION_OVERLAY</span><span class="o">,</span>
<span class="ln">31</span>                            <span class="n">TYPE_NAVIGATION_BAR</span><span class="o">,</span> <span class="n">TYPE_NAVIGATION_BAR_PANEL</span><span class="o">)</span>
<span class="ln">32</span>                    <span class="o">.</span><span class="na">build</span><span class="o">())</span>
<span class="ln">33</span>        <span class="o">.</span><span class="na">addFeature</span><span class="o">(</span><span class="k">new</span> <span class="n">Feature</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="n">wmService</span><span class="o">.</span><span class="na">mPolicy</span><span class="o">,</span> <span class="s">&#34;ImePlaceholder&#34;</span><span class="o">,</span>
<span class="ln">34</span>                                        <span class="n">FEATURE_IME_PLACEHOLDER</span><span class="o">)</span>
<span class="ln">35</span>                    <span class="o">.</span><span class="na">and</span><span class="o">(</span><span class="n">TYPE_INPUT_METHOD</span><span class="o">,</span> <span class="n">TYPE_INPUT_METHOD_DIALOG</span><span class="o">)</span>
<span class="ln">36</span>                    <span class="o">.</span><span class="na">build</span><span class="o">());</span>
<span class="ln">37</span><span class="o">}</span>
</code></pre></div><p>关于Feature.Builder，内部持有Builder，用于建造Feature类</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window28.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window28.png" >
  
    </a>
  
  
</div>

<p>Feature分类有5种，分别为&quot;<strong>WindowedMagnification</strong>&quot;、&quot;<strong>HideDisplayCutout</strong>&quot;、&quot;<strong>OneHanded</strong>&quot;、&quot;<strong>FullscreenMagnification</strong>&quot;、&quot;<strong>ImePlaceholder</strong>&quot;</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window29.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window29.png" >
  
    </a>
  
  
</div>

<p>4）根据上面5种Feature，具体显示区域到根目录</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/services/core/java/com/android/server/wm/DisplayAreaPolicyBuilder.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="n">Result</span> <span class="nf">build</span><span class="o">(</span><span class="n">WindowManagerService</span> <span class="n">wmService</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 3</span>    <span class="c1">//让Window容器的特色模式生效
</span><span class="ln"> 4</span><span class="c1"></span>    <span class="n">validate</span><span class="o">();</span>
<span class="ln"> 5</span>    <span class="c1">//在向组层次结构添加窗口之前，将DA组根附加到屏幕层次结构。
</span><span class="ln"> 6</span><span class="c1"></span>    <span class="n">mRootHierarchyBuilder</span><span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="n">mDisplayAreaGroupHierarchyBuilders</span><span class="o">);</span><span class="c1">//1
</span><span class="ln"> 7</span><span class="c1"></span>    <span class="n">List</span><span class="o">&lt;</span><span class="n">RootDisplayArea</span><span class="o">&gt;</span> <span class="n">displayAreaGroupRoots</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;(</span>
<span class="ln"> 8</span>        <span class="n">mDisplayAreaGroupHierarchyBuilders</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
<span class="ln"> 9</span>    <span class="c1">//这个size大小根据上文所知是5，然后构建
</span><span class="ln">10</span><span class="c1"></span>    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mDisplayAreaGroupHierarchyBuilders</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
<span class="ln">11</span>        <span class="n">HierarchyBuilder</span> <span class="n">hierarchyBuilder</span> <span class="o">=</span> <span class="n">mDisplayAreaGroupHierarchyBuilders</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
<span class="ln">12</span>        <span class="n">hierarchyBuilder</span><span class="o">.</span><span class="na">build</span><span class="o">();</span><span class="c1">//2
</span><span class="ln">13</span><span class="c1"></span>        <span class="n">displayAreaGroupRoots</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">hierarchyBuilder</span><span class="o">.</span><span class="na">mRoot</span><span class="o">);</span><span class="c1">//2
</span><span class="ln">14</span><span class="c1"></span>    <span class="o">}</span>
<span class="ln">15</span>    <span class="c1">// Use the default function if it is not specified otherwise.
</span><span class="ln">16</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">mSelectRootForWindowFunc</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">17</span>        <span class="n">mSelectRootForWindowFunc</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultSelectRootForWindowFunction</span><span class="o">(</span>
<span class="ln">18</span>            <span class="n">mRootHierarchyBuilder</span><span class="o">.</span><span class="na">mRoot</span><span class="o">,</span> <span class="n">displayAreaGroupRoots</span><span class="o">);</span><span class="c1">//3
</span><span class="ln">19</span><span class="c1"></span>    <span class="o">}</span>
<span class="ln">20</span>    <span class="k">return</span> <span class="k">new</span> <span class="n">Result</span><span class="o">(</span><span class="n">wmService</span><span class="o">,</span> <span class="n">mRootHierarchyBuilder</span><span class="o">.</span><span class="na">mRoot</span><span class="o">,</span> <span class="n">displayAreaGroupRoots</span><span class="o">,</span>
<span class="ln">21</span>                      <span class="n">mSelectRootForWindowFunc</span><span class="o">,</span> <span class="n">mSelectTaskDisplayAreaFunc</span><span class="o">);</span><span class="c1">//4
</span><span class="ln">22</span><span class="c1"></span><span class="o">}</span>
</code></pre></div><ol>
<li>调用mRootHierarchyBuilder.build构造层级</li>
<li>这里没有使用到displayAreaGroupRoots，所以跳过2</li>
<li>如果mSelectRootForWindowFunc 没有设置值的话，设置一个默认的对象</li>
<li>新生成一个Result对象返回，即Result为DisplayAreaPolicy的实例类</li>
</ol>
<h4 id="2426hierarchybuilderbuild">2.4.2.6HierarchyBuilder.build</h4>
<p>这个内容比较多，分成上下两段来说明</p>
<p>1）上半段</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/services/core/java/com/android/server/wm/DisplayAreaPolicyBuilder.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">private</span> <span class="kt">void</span> <span class="nf">build</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">HierarchyBuilder</span><span class="o">&gt;</span> <span class="n">displayAreaGroupHierarchyBuilders</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 3</span>    <span class="kd">final</span> <span class="n">WindowManagerPolicy</span> <span class="n">policy</span> <span class="o">=</span> <span class="n">mRoot</span><span class="o">.</span><span class="na">mWmService</span><span class="o">.</span><span class="na">mPolicy</span><span class="o">;</span>
<span class="ln"> 4</span>    <span class="kd">final</span> <span class="kt">int</span> <span class="n">maxWindowLayerCount</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="na">getMaxWindowLayer</span><span class="o">()</span> <span class="o">+</span> <span class="n">1</span><span class="o">;</span>
<span class="ln"> 5</span>    <span class="kd">final</span> <span class="n">DisplayArea</span><span class="o">.</span><span class="na">Tokens</span><span class="o">[]</span> <span class="n">displayAreaForLayer</span> <span class="o">=</span>
<span class="ln"> 6</span>        <span class="k">new</span> <span class="n">DisplayArea</span><span class="o">.</span><span class="na">Tokens</span><span class="o">[</span><span class="n">maxWindowLayerCount</span><span class="o">];</span>
<span class="ln"> 7</span>    <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Feature</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">DisplayArea</span><span class="o">&lt;</span><span class="n">WindowContainer</span><span class="o">&gt;&gt;&gt;</span> <span class="n">featureAreas</span> <span class="o">=</span>
<span class="ln"> 8</span>        <span class="k">new</span> <span class="n">ArrayMap</span><span class="o">&lt;&gt;(</span><span class="n">mFeatures</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
<span class="ln"> 9</span>    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mFeatures</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
<span class="ln">10</span>        <span class="n">featureAreas</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">mFeatures</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">),</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;());</span>
<span class="ln">11</span>    <span class="o">}</span>
<span class="ln">12</span>
<span class="ln">13</span>    <span class="n">PendingArea</span><span class="o">[]</span> <span class="n">areaForLayer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PendingArea</span><span class="o">[</span><span class="n">maxWindowLayerCount</span><span class="o">];</span>
<span class="ln">14</span>    <span class="kd">final</span> <span class="n">PendingArea</span> <span class="n">root</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PendingArea</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
<span class="ln">15</span>    <span class="n">Arrays</span><span class="o">.</span><span class="na">fill</span><span class="o">(</span><span class="n">areaForLayer</span><span class="o">,</span> <span class="n">root</span><span class="o">);</span>
<span class="ln">16</span>
<span class="ln">17</span>    <span class="c1">// 创建显示区域以覆盖所有已定义的功能
</span><span class="ln">18</span><span class="c1"></span>    <span class="kd">final</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">mFeatures</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
<span class="ln">19</span>    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
<span class="ln">20</span>        <span class="kd">final</span> <span class="n">Feature</span> <span class="n">feature</span> <span class="o">=</span> <span class="n">mFeatures</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
<span class="ln">21</span>        <span class="n">PendingArea</span> <span class="n">featureArea</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="ln">22</span>        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">layer</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">layer</span> <span class="o">&lt;</span> <span class="n">maxWindowLayerCount</span><span class="o">;</span> <span class="n">layer</span><span class="o">++)</span> <span class="o">{</span>
<span class="ln">23</span>            <span class="k">if</span> <span class="o">(</span><span class="n">feature</span><span class="o">.</span><span class="na">mWindowLayers</span><span class="o">[</span><span class="n">layer</span><span class="o">])</span> <span class="o">{</span>
<span class="ln">24</span>                <span class="c1">// 该特性将应用于该窗口层。
</span><span class="ln">25</span><span class="c1"></span>                <span class="c1">//我们需要为它找到一个显示区域:
</span><span class="ln">26</span><span class="c1"></span>                <span class="c1">//我们可以重用现有的一个，如果它是为前一层的这个特性创建的
</span><span class="ln">27</span><span class="c1"></span>                <span class="c1">//并且应用到前一层的最后一个特性与应用到当前层的特性相同(所以它们可以共享相同的父DisplayArea)
</span><span class="ln">28</span><span class="c1"></span>                <span class="k">if</span> <span class="o">(</span><span class="n">featureArea</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">featureArea</span><span class="o">.</span><span class="na">mParent</span> <span class="o">!=</span> <span class="n">areaForLayer</span><span class="o">[</span><span class="n">layer</span><span class="o">])</span> <span class="o">{</span>
<span class="ln">29</span>                    <span class="c1">// 没有合适的显示区域:
</span><span class="ln">30</span><span class="c1"></span>                    <span class="c1">//在之前的区域下创建一个新的图层(作为父层)。
</span><span class="ln">31</span><span class="c1"></span>                    <span class="n">featureArea</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PendingArea</span><span class="o">(</span><span class="n">feature</span><span class="o">,</span> <span class="n">layer</span><span class="o">,</span> <span class="n">areaForLayer</span><span class="o">[</span><span class="n">layer</span><span class="o">]);</span>
<span class="ln">32</span>                    <span class="n">areaForLayer</span><span class="o">[</span><span class="n">layer</span><span class="o">].</span><span class="na">mChildren</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">featureArea</span><span class="o">);</span>
<span class="ln">33</span>                <span class="o">}</span>
<span class="ln">34</span>                <span class="n">areaForLayer</span><span class="o">[</span><span class="n">layer</span><span class="o">]</span> <span class="o">=</span> <span class="n">featureArea</span><span class="o">;</span>
<span class="ln">35</span>            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="ln">36</span>                <span class="n">featureArea</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="ln">37</span>            <span class="o">}</span>
<span class="ln">38</span>        <span class="o">}</span>
<span class="ln">39</span>    <span class="o">}</span>
<span class="ln">40</span>    <span class="o">...</span>
<span class="ln">41</span><span class="o">}</span>
</code></pre></div><p>根据上面的Feature类，创建对应的联系</p>
<p>对应的PendingArea结构</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window30.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window30.png" >
  
    </a>
  
  
</div>

<p>第一个循环</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window31.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window31.png" >
  
    </a>
  
  
</div>

<p>第二个循环</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window32.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window32.png" >
  
    </a>
  
  
</div>

<p>为了更加方便的理解，简化上述过程，用PA代表PendingArea的实例对象，最终上半段的结构如下所示</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window33.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window33.png" >
  
    </a>
  
  
</div>

<p>2）下半段</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/services/core/java/com/android/server/wm/DisplayAreaPolicyBuilder.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">private</span> <span class="kt">void</span> <span class="nf">build</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">HierarchyBuilder</span><span class="o">&gt;</span> <span class="n">displayAreaGroupHierarchyBuilders</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 3</span>    <span class="o">...</span>
<span class="ln"> 4</span>    <span class="c1">// Create Tokens as leaf for every layer.
</span><span class="ln"> 5</span><span class="c1"></span>    <span class="n">PendingArea</span> <span class="n">leafArea</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="ln"> 6</span>    <span class="kt">int</span> <span class="n">leafType</span> <span class="o">=</span> <span class="n">LEAF_TYPE_TOKENS</span><span class="o">;</span>
<span class="ln"> 7</span>    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">layer</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">layer</span> <span class="o">&lt;</span> <span class="n">maxWindowLayerCount</span><span class="o">;</span> <span class="n">layer</span><span class="o">++)</span> <span class="o">{</span>
<span class="ln"> 8</span>        <span class="kt">int</span> <span class="n">type</span> <span class="o">=</span> <span class="n">typeOfLayer</span><span class="o">(</span><span class="n">policy</span><span class="o">,</span> <span class="n">layer</span><span class="o">);</span>
<span class="ln"> 9</span>        <span class="c1">// Check whether we can reuse the same Tokens with the previous layer. This happens
</span><span class="ln">10</span><span class="c1"></span>        <span class="c1">// if the previous layer is the same type as the current layer AND there is no
</span><span class="ln">11</span><span class="c1"></span>        <span class="c1">// feature that applies to only one of them.
</span><span class="ln">12</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">leafArea</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">leafArea</span><span class="o">.</span><span class="na">mParent</span> <span class="o">!=</span> <span class="n">areaForLayer</span><span class="o">[</span><span class="n">layer</span><span class="o">]</span>
<span class="ln">13</span>            <span class="o">||</span> <span class="n">type</span> <span class="o">!=</span> <span class="n">leafType</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">14</span>            <span class="c1">// Create a new Tokens for this layer.
</span><span class="ln">15</span><span class="c1"></span>            <span class="n">leafArea</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PendingArea</span><span class="o">(</span><span class="kc">null</span> <span class="cm">/* feature */</span><span class="o">,</span> <span class="n">layer</span><span class="o">,</span> <span class="n">areaForLayer</span><span class="o">[</span><span class="n">layer</span><span class="o">]);</span>
<span class="ln">16</span>            <span class="n">areaForLayer</span><span class="o">[</span><span class="n">layer</span><span class="o">].</span><span class="na">mChildren</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">leafArea</span><span class="o">);</span>
<span class="ln">17</span>            <span class="n">leafType</span> <span class="o">=</span> <span class="n">type</span><span class="o">;</span>
<span class="ln">18</span>            <span class="k">if</span> <span class="o">(</span><span class="n">leafType</span> <span class="o">==</span> <span class="n">LEAF_TYPE_TASK_CONTAINERS</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">19</span>                <span class="c1">// We use the passed in TaskDisplayAreas for task container type of layer.
</span><span class="ln">20</span><span class="c1"></span>                <span class="c1">// Skip creating Tokens even if there is no TDA.
</span><span class="ln">21</span><span class="c1"></span>                <span class="n">addTaskDisplayAreasToApplicationLayer</span><span class="o">(</span><span class="n">areaForLayer</span><span class="o">[</span><span class="n">layer</span><span class="o">]);</span>
<span class="ln">22</span>                <span class="n">addDisplayAreaGroupsToApplicationLayer</span><span class="o">(</span><span class="n">areaForLayer</span><span class="o">[</span><span class="n">layer</span><span class="o">],</span>
<span class="ln">23</span>                                                       <span class="n">displayAreaGroupHierarchyBuilders</span><span class="o">);</span>
<span class="ln">24</span>                <span class="n">leafArea</span><span class="o">.</span><span class="na">mSkipTokens</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
<span class="ln">25</span>            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">leafType</span> <span class="o">==</span> <span class="n">LEAF_TYPE_IME_CONTAINERS</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">26</span>                <span class="c1">// We use the passed in ImeContainer for ime container type of layer.
</span><span class="ln">27</span><span class="c1"></span>                <span class="c1">// Skip creating Tokens even if there is no ime container.
</span><span class="ln">28</span><span class="c1"></span>                <span class="n">leafArea</span><span class="o">.</span><span class="na">mExisting</span> <span class="o">=</span> <span class="n">mImeContainer</span><span class="o">;</span>
<span class="ln">29</span>                <span class="n">leafArea</span><span class="o">.</span><span class="na">mSkipTokens</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
<span class="ln">30</span>            <span class="o">}</span>
<span class="ln">31</span>        <span class="o">}</span>
<span class="ln">32</span>        <span class="n">leafArea</span><span class="o">.</span><span class="na">mMaxLayer</span> <span class="o">=</span> <span class="n">layer</span><span class="o">;</span>
<span class="ln">33</span>    <span class="o">}</span>
<span class="ln">34</span>    <span class="n">root</span><span class="o">.</span><span class="na">computeMaxLayer</span><span class="o">();</span>
<span class="ln">35</span>
<span class="ln">36</span>    <span class="c1">// 构建了一个PendingAreas树来表示层次结构，现在创建并将真正的DisplayAreas附加到根节点上
</span><span class="ln">37</span><span class="c1"></span>    <span class="c1">//这个root是PendingArea的实例，
</span><span class="ln">38</span><span class="c1"></span>    <span class="n">root</span><span class="o">.</span><span class="na">instantiateChildren</span><span class="o">(</span><span class="n">mRoot</span><span class="o">,</span> <span class="n">displayAreaForLayer</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="n">featureAreas</span><span class="o">);</span>
<span class="ln">39</span>
<span class="ln">40</span>    <span class="c1">// 通知根节点我们已经完成了所有displayarea的附加。缓存所有与特性相关的集合，以便快速访问
</span><span class="ln">41</span><span class="c1"></span>    <span class="c1">// 这个mRoot是RootDisplayArea类型，传入的mRoot是上文传入的DisplayContent的this指针
</span><span class="ln">42</span><span class="c1"></span>    <span class="n">mRoot</span><span class="o">.</span><span class="na">onHierarchyBuilt</span><span class="o">(</span><span class="n">mFeatures</span><span class="o">,</span> <span class="n">displayAreaForLayer</span><span class="o">,</span> <span class="n">featureAreas</span><span class="o">);</span>
<span class="ln">43</span><span class="o">}</span>
</code></pre></div><p>下半段添加了一些叶子结点</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window34.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window34.png" >
  
    </a>
  
  
</div>

<p>再次简化如下</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window35.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window35.png" >
  
    </a>
  
  
</div>

<p>子节点的PendingArea对象树形结构构建完成，接着root.instantiateChildren构建窗口层级图</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/services/core/java/com/android/server/wm/DisplayAreaPolicyBuilder.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">class</span> <span class="nc">DisplayAreaPolicyBuilder</span> <span class="o">{</span> 
<span class="ln"> 3</span>    <span class="o">...</span>
<span class="ln"> 4</span>    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">PendingArea</span> <span class="o">{</span>
<span class="ln"> 5</span>        <span class="o">...</span>
<span class="ln"> 6</span>        <span class="kt">void</span> <span class="nf">instantiateChildren</span><span class="o">(</span><span class="n">DisplayArea</span><span class="o">&lt;</span><span class="n">DisplayArea</span><span class="o">&gt;</span> <span class="n">parent</span><span class="o">,</span> <span class="n">DisplayArea</span><span class="o">.</span><span class="na">Tokens</span><span class="o">[]</span> <span class="n">areaForLayer</span><span class="o">,</span>
<span class="ln"> 7</span>                                 <span class="kt">int</span> <span class="n">level</span><span class="o">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Feature</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">DisplayArea</span><span class="o">&lt;</span><span class="n">WindowContainer</span><span class="o">&gt;&gt;&gt;</span> <span class="n">areas</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 8</span>            <span class="n">mChildren</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="n">Comparator</span><span class="o">.</span><span class="na">comparingInt</span><span class="o">(</span><span class="n">pendingArea</span> <span class="o">-&gt;</span> <span class="n">pendingArea</span><span class="o">.</span><span class="na">mMinLayer</span><span class="o">));</span>
<span class="ln"> 9</span>            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mChildren</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
<span class="ln">10</span>                <span class="kd">final</span> <span class="n">PendingArea</span> <span class="n">child</span> <span class="o">=</span> <span class="n">mChildren</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
<span class="ln">11</span>                <span class="kd">final</span> <span class="n">DisplayArea</span> <span class="n">area</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="na">createArea</span><span class="o">(</span><span class="n">parent</span><span class="o">,</span> <span class="n">areaForLayer</span><span class="o">);</span>
<span class="ln">12</span>                <span class="k">if</span> <span class="o">(</span><span class="n">area</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">13</span>                    <span class="c1">// TaskDisplayArea and ImeContainer can be set at different hierarchy, so it can
</span><span class="ln">14</span><span class="c1"></span>                    <span class="c1">// be null.
</span><span class="ln">15</span><span class="c1"></span>                    <span class="k">continue</span><span class="o">;</span>
<span class="ln">16</span>                <span class="o">}</span>
<span class="ln">17</span>                <span class="n">parent</span><span class="o">.</span><span class="na">addChild</span><span class="o">(</span><span class="n">area</span><span class="o">,</span> <span class="n">WindowContainer</span><span class="o">.</span><span class="na">POSITION_TOP</span><span class="o">);</span>
<span class="ln">18</span>                <span class="k">if</span> <span class="o">(</span><span class="n">child</span><span class="o">.</span><span class="na">mFeature</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">19</span>                    <span class="n">areas</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">child</span><span class="o">.</span><span class="na">mFeature</span><span class="o">).</span><span class="na">add</span><span class="o">(</span><span class="n">area</span><span class="o">);</span>
<span class="ln">20</span>                <span class="o">}</span>
<span class="ln">21</span>                <span class="n">child</span><span class="o">.</span><span class="na">instantiateChildren</span><span class="o">(</span><span class="n">area</span><span class="o">,</span> <span class="n">areaForLayer</span><span class="o">,</span> <span class="n">level</span> <span class="o">+</span> <span class="n">1</span><span class="o">,</span> <span class="n">areas</span><span class="o">);</span>
<span class="ln">22</span>            <span class="o">}</span>
<span class="ln">23</span>        <span class="o">}</span>
<span class="ln">24</span>        
<span class="ln">25</span>        <span class="nd">@Nullable</span>
<span class="ln">26</span>        <span class="kd">private</span> <span class="n">DisplayArea</span> <span class="nf">createArea</span><span class="o">(</span><span class="n">DisplayArea</span><span class="o">&lt;</span><span class="n">DisplayArea</span><span class="o">&gt;</span> <span class="n">parent</span><span class="o">,</span>
<span class="ln">27</span>                <span class="n">DisplayArea</span><span class="o">.</span><span class="na">Tokens</span><span class="o">[]</span> <span class="n">areaForLayer</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">28</span>            <span class="k">if</span> <span class="o">(</span><span class="n">mExisting</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">29</span>                <span class="k">if</span> <span class="o">(</span><span class="n">mExisting</span><span class="o">.</span><span class="na">asTokens</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">30</span>                    <span class="c1">// Store the WindowToken container for layers
</span><span class="ln">31</span><span class="c1"></span>                    <span class="n">fillAreaForLayers</span><span class="o">(</span><span class="n">mExisting</span><span class="o">.</span><span class="na">asTokens</span><span class="o">(),</span> <span class="n">areaForLayer</span><span class="o">);</span>
<span class="ln">32</span>                <span class="o">}</span>
<span class="ln">33</span>                <span class="k">return</span> <span class="n">mExisting</span><span class="o">;</span>
<span class="ln">34</span>            <span class="o">}</span>
<span class="ln">35</span>            <span class="k">if</span> <span class="o">(</span><span class="n">mSkipTokens</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">36</span>                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
<span class="ln">37</span>            <span class="o">}</span>
<span class="ln">38</span>            <span class="n">DisplayArea</span><span class="o">.</span><span class="na">Type</span> <span class="n">type</span><span class="o">;</span>
<span class="ln">39</span>            <span class="k">if</span> <span class="o">(</span><span class="n">mMinLayer</span> <span class="o">&gt;</span> <span class="n">APPLICATION_LAYER</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">40</span>                <span class="n">type</span> <span class="o">=</span> <span class="n">DisplayArea</span><span class="o">.</span><span class="na">Type</span><span class="o">.</span><span class="na">ABOVE_TASKS</span><span class="o">;</span>
<span class="ln">41</span>            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">mMaxLayer</span> <span class="o">&lt;</span> <span class="n">APPLICATION_LAYER</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">42</span>                <span class="n">type</span> <span class="o">=</span> <span class="n">DisplayArea</span><span class="o">.</span><span class="na">Type</span><span class="o">.</span><span class="na">BELOW_TASKS</span><span class="o">;</span>
<span class="ln">43</span>            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="ln">44</span>                <span class="n">type</span> <span class="o">=</span> <span class="n">DisplayArea</span><span class="o">.</span><span class="na">Type</span><span class="o">.</span><span class="na">ANY</span><span class="o">;</span>
<span class="ln">45</span>            <span class="o">}</span>
<span class="ln">46</span>            <span class="k">if</span> <span class="o">(</span><span class="n">mFeature</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">47</span>                <span class="kd">final</span> <span class="n">DisplayArea</span><span class="o">.</span><span class="na">Tokens</span> <span class="n">leaf</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DisplayArea</span><span class="o">.</span><span class="na">Tokens</span><span class="o">(</span><span class="n">parent</span><span class="o">.</span><span class="na">mWmService</span><span class="o">,</span> <span class="n">type</span><span class="o">,</span>
<span class="ln">48</span>                        <span class="s">&#34;Leaf:&#34;</span> <span class="o">+</span> <span class="n">mMinLayer</span> <span class="o">+</span> <span class="s">&#34;:&#34;</span> <span class="o">+</span> <span class="n">mMaxLayer</span><span class="o">);</span>
<span class="ln">49</span>                <span class="n">fillAreaForLayers</span><span class="o">(</span><span class="n">leaf</span><span class="o">,</span> <span class="n">areaForLayer</span><span class="o">);</span>
<span class="ln">50</span>                <span class="k">return</span> <span class="n">leaf</span><span class="o">;</span>
<span class="ln">51</span>            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="ln">52</span>                <span class="k">return</span> <span class="n">mFeature</span><span class="o">.</span><span class="na">mNewDisplayAreaSupplier</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">parent</span><span class="o">.</span><span class="na">mWmService</span><span class="o">,</span> <span class="n">type</span><span class="o">,</span>
<span class="ln">53</span>                        <span class="n">mFeature</span><span class="o">.</span><span class="na">mName</span> <span class="o">+</span> <span class="s">&#34;:&#34;</span> <span class="o">+</span> <span class="n">mMinLayer</span> <span class="o">+</span> <span class="s">&#34;:&#34;</span> <span class="o">+</span> <span class="n">mMaxLayer</span><span class="o">,</span> <span class="n">mFeature</span><span class="o">.</span><span class="na">mId</span><span class="o">);</span>
<span class="ln">54</span>            <span class="o">}</span>
<span class="ln">55</span>        <span class="o">}</span>
<span class="ln">56</span>
<span class="ln">57</span>        <span class="kd">private</span> <span class="kt">void</span> <span class="nf">fillAreaForLayers</span><span class="o">(</span><span class="n">DisplayArea</span><span class="o">.</span><span class="na">Tokens</span> <span class="n">leaf</span><span class="o">,</span> <span class="n">DisplayArea</span><span class="o">.</span><span class="na">Tokens</span><span class="o">[]</span> <span class="n">areaForLayer</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">58</span>            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">mMinLayer</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">mMaxLayer</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
<span class="ln">59</span>                <span class="n">areaForLayer</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">leaf</span><span class="o">;</span>
<span class="ln">60</span>            <span class="o">}</span>
<span class="ln">61</span>        <span class="o">}</span>
<span class="ln">62</span>    <span class="o">}</span>
<span class="ln">63</span><span class="o">}</span>
</code></pre></div><p>这里能看到PendingArea类的mExisting 和mSkipTokens属性的使用。</p>
<ul>
<li>
<p>mExisting 存在直接就返回它，不会重新生成新的</p>
<p>如果mExisting 不存在，并且mSkipTokens= true，这个时候，会返回null</p>
<p>如果mExisting 不存在，并且mSkipTokens= false，则会新生成DisplayArea对象</p>
</li>
<li>
<p>新生成的DisplayArea对象，如果mFeature 为null，则为DisplayArea.Tokens对象</p>
<p>不然，则会调用生成具体的对象</p>
</li>
<li>
<p>前面添加特色模式时，mNewDisplayAreaSupplier设置为DisplayArea.Dimmable::new</p>
<p>如果不设置，它默认为DisplayArea::new</p>
</li>
<li>
<p>我们还看到，新生成的DisplayArea对象的type，是根据PendingArea类的mMinLayer 和mMaxLayer 来决定</p>
<p>如果新生成的DisplayArea对象是Tokens 类型，会填充参数areaForLayer数组，将对应层级的Tokens对象放入其中</p>
</li>
</ul>
<h4 id="2427窗口层级分析windowcontainer相关子类关联">2.4.2.7窗口层级分析WindowContainer相关子类关联</h4>
<p>这里补充上面提到但没有讲述的Window容器，WindowState的容器，直接持有WindowState容器，WindowToken的容器，ActivityRecord的容器，Task的容器，DisplayArea相关容器，RootWindowContainer容器。</p>
<h5 id="24271windowstate的容器">2.4.2.7.1WindowState的容器</h5>
<p>直接持有WindowState的类，根据上面的android13 Window容器架构图可以初步得知，WindowToken、ActivityRecord和WallpaperWindowToken</p>
<h5 id="24272-windowtoken">2.4.2.7.2 WindowToken</h5>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln">1</span><span class="c1">//frameworks/base/services/core/java/com/android/server/wm/WindowToken.java
</span><span class="ln">2</span><span class="c1"></span><span class="kd">class</span> <span class="nc">WindowToken</span> <span class="kd">extends</span> <span class="n">WindowContainer</span><span class="o">&lt;</span><span class="n">WindowState</span><span class="o">&gt;</span> <span class="o">{}</span>
</code></pre></div><p>WMS中存放一组相关联的窗口的容器。通常是ActivityRecord，它是Activity在WMS的表示，就如WindowState是Window在WMS的表示，用来显示窗口。</p>
<p>比如StatusBar：</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>$ dumpsys activity containers
<span class="ln">2</span><span class="c1">#0 WindowToken{ef15750 android.os.BinderProxy@4562c02} type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1440,2960]</span>
<span class="ln">3</span><span class="c1">#0 d3cbd49 StatusBar type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1440,2960]</span>
</code></pre></div>

 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window37.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window37.png" >
  
    </a>
  
  
</div>

<h5 id="24273-activityrecord">2.4.2.7.3 ActivityRecord</h5>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln">1</span><span class="c1">//frameworks/base/services/core/java/com/android/server/wm/ActivityRecord.java
</span><span class="ln">2</span><span class="c1"></span><span class="kd">final</span> <span class="kd">class</span> <span class="nc">ActivityRecord</span> <span class="kd">extends</span> <span class="n">WindowToken</span> <span class="kd">implements</span> <span class="n">WindowManagerService</span><span class="o">.</span><span class="na">AppFreezeListener</span> <span class="o">{}</span>
</code></pre></div><p>ActivityRecord是WindowToken的子类，如上面所说，在WMS中一个<strong>ActivityRecord对象就代表一个Activity对象</strong>。</p>
<p>这里有几点需要说明：</p>
<ol>
<li>
<p>可以根据窗口的添加方式将窗口分为App窗口和非App窗口，或者换个说法，Activity窗口和非Activity窗口，我个人习惯叫App窗口和非App窗口。</p>
<p><strong>App窗口</strong>(Activity或者Dialog)父容器为<strong>ActivityRecord</strong></p>
<p>这类窗口由系统自动创建，不需要App主动去调用ViewManager.addView去添加一个窗口，比如我写一个Activity或者Dialog，系统就会在合适的时机为Activity或者Dialog调用ViewManager.addView去向WindowManager添加一个窗口。这类窗口在创建的时候，其父容器为ActivityRecord。</p>
<p><strong>非App窗口</strong>(NavigationBar)父容器为<strong>WindowToken</strong></p>
<p>这类窗口需要App主动去调用ViewManager.addView来添加一个窗口，比如NavigationBar窗口的添加，需要SystemUI主动去调用ViewManager.addView来为NavigationBar创建一个新的窗口。这类窗口在创建的时候，其父容器为WindowToken。</p>
</li>
<li>
<p>WindowToken既然是WindowState的直接父容器，那么每次添加窗口的时候，就需要创建一个WindowToken，或者一个ActivityRecord。</p>
</li>
<li>
<p>上述情况也有例外，即存在WindowToken的复用，因为一个WindowToken中可能不只一个WindowState对象，说明第二个WindowState创建的时候，复用了第一个WindowState创建的时候生成的WindowToken。如果两个WindowState能被放进一个WindowToken中，那么这两个WindowState之间就必须有联系。</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window5.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window5.png" >
  
    </a>
  
  
</div>

<p>在WMS.addWindow方法的部分片段：</p>
</li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/services/core/java/com/android/server/wm/WindowManagerService.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">public</span> <span class="kt">int</span> <span class="nf">addWindow</span><span class="o">(</span><span class="n">Session</span> <span class="n">session</span><span class="o">,</span> <span class="n">IWindow</span> <span class="n">client</span><span class="o">,</span> <span class="n">LayoutParams</span> <span class="n">attrs</span><span class="o">,</span> <span class="kt">int</span> <span class="n">viewVisibility</span><span class="o">,</span>
<span class="ln"> 3</span>                     <span class="kt">int</span> <span class="n">displayId</span><span class="o">,</span> <span class="kt">int</span> <span class="n">requestUserId</span><span class="o">,</span> <span class="n">InsetsVisibilities</span> <span class="n">requestedVisibilities</span><span class="o">,</span>
<span class="ln"> 4</span>                     <span class="n">InputChannel</span> <span class="n">outInputChannel</span><span class="o">,</span> <span class="n">InsetsState</span> <span class="n">outInsetsState</span><span class="o">,</span>
<span class="ln"> 5</span>                     <span class="n">InsetsSourceControl</span><span class="o">[]</span> <span class="n">outActiveControls</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 6</span>    <span class="o">...</span>
<span class="ln"> 7</span>    <span class="n">WindowToken</span> <span class="n">token</span> <span class="o">=</span> <span class="n">displayContent</span><span class="o">.</span><span class="na">getWindowToken</span><span class="o">(</span>
<span class="ln"> 8</span>        <span class="n">hasParent</span> <span class="o">?</span> <span class="n">parentWindow</span><span class="o">.</span><span class="na">mAttrs</span><span class="o">.</span><span class="na">token</span> <span class="o">:</span> <span class="n">attrs</span><span class="o">.</span><span class="na">token</span><span class="o">);</span>
<span class="ln"> 9</span>    <span class="o">...</span>
<span class="ln">10</span><span class="o">}</span>
</code></pre></div><p>可知，如果两个窗口的WindowManager.LayoutParams.token指向同一个对象，那么这两个WindowState就会被放入同一个WindowToken中。但是通常来说，只有由<strong>同一个Activity的两个窗口</strong>才有可能被放入到一个WindowToken中，<strong>比如典型的Launcher</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>$ dumpsys activity containers
<span class="ln">2</span><span class="c1">#0 ActivityRecord{31ce9e6 u0 com.google.android.apps.nexuslauncher/.NexusLauncherActivity t191}</span>
<span class="ln">3</span><span class="c1">#1 220afda com.google.android.apps.nexuslauncher/com.google.android.apps.nexuslauncher.NexusLauncherActivity</span>
<span class="ln">4</span><span class="c1">#0 4cf47c3 com.google.android.apps.nexuslauncher/com.google.android.apps.nexuslauncher.NexusLauncherActivity</span>
</code></pre></div>

 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window38.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window38.png" >
  
    </a>
  
  
</div>

<p>此外分别来自<strong>两个不同的Activity的两个窗口是不会被放入同一个WindowToken中</strong>的，因此更一般的情况是，一个WindowToken或ActivityRecord只包含一个WindowState。</p>
<h5 id="24274-wallpaperwindowtoken">2.4.2.7.4 WallpaperWindowToken</h5>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln">1</span><span class="c1">//frameworks/base/services/core/java/com/android/server/wm/WallpaperWindowToken.java
</span><span class="ln">2</span><span class="c1"></span><span class="kd">class</span> <span class="nc">WallpaperWindowToken</span> <span class="kd">extends</span> <span class="n">WindowToken</span> <span class="o">{}</span>
</code></pre></div><p>其实WindowToken还有一个子类，WallpaperWindowToken，这类的WindowToken用来存放和Wallpaper相关的窗口。</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>$ dumpsys activity containers
<span class="ln">2</span><span class="c1">#0 WallpaperWindowToken{dc5772f token=android.os.Binder@985f410} type=undefined mode=fullscreen override-mode=fullscreen requested-bounds=[0,0][0,0] bounds=[0,0][720,1612]</span>
<span class="ln">3</span><span class="c1">#0 1ea91d com.android.systemui.ImageWallpaper type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1612]</span>
</code></pre></div>

 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window39.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window39.png" >
  
    </a>
  
  
</div>

<p>上面讨论ActivityRecord的时候，我们将窗口划分为App窗口和非App窗口。在引入了WallpaperWindowToken后，我们继续将非App窗口划分为两类，Wallpaper窗口和非Wallpaper窗口。</p>
<p>Wallpaper窗口的层级是比App窗口的层级低的，因此这里我们可以按照层级这一角度将窗口划分为：</p>
<ul>
<li><strong>App之上的窗口</strong>，父容器为WindowToken，如StatusBar和NavigationBar（这个层级大于2）</li>
<li><strong>App窗口</strong>，父容器为ActivityRecord，如Launcher（这个层级为2）</li>
<li><strong>App之下的窗口</strong>，父容器为WallpaperWindowToken，如ImageWallpaper窗口（这个层级为1）</li>
</ul>
<h5 id="24275-windowtoken的容器-displayareatokens">2.4.2.7.5 WindowToken的容器 （DisplayArea.Tokens）</h5>
<p>可以容纳WindowToken的容器，搜索之后，发现为定义在DisplayArea中的内部类Tokens。关于DisplayArea的内容放在2.4.2.7.10中</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln">1</span><span class="c1">//frameworks/base/services/core/java/com/android/server/wm/DisplayArea.java
</span><span class="ln">2</span><span class="c1"></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DisplayArea</span><span class="o">&lt;</span><span class="n">T</span> <span class="kd">extends</span> <span class="n">WindowContainer</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">WindowContainer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
<span class="ln">3</span>    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Tokens</span> <span class="kd">extends</span> <span class="n">DisplayArea</span><span class="o">&lt;</span><span class="n">WindowToken</span><span class="o">&gt;</span> <span class="o">{}</span>
<span class="ln">4</span><span class="o">}</span>
</code></pre></div><h5 id="24276-activityrecord的容器-task">2.4.2.7.6 ActivityRecord的容器 （Task）</h5>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln">1</span><span class="c1">//frameworks/base/services/core/java/com/android/server/wm/Task.java
</span><span class="ln">2</span><span class="c1"></span><span class="kd">class</span> <span class="nc">Task</span> <span class="kd">extends</span> <span class="n">TaskFragment</span> <span class="o">{}</span>
<span class="ln">3</span><span class="c1">//frameworks/base/services/core/java/com/android/server/wm/TaskFragment.java
</span><span class="ln">4</span><span class="c1"></span><span class="kd">class</span> <span class="nc">TaskFragment</span> <span class="kd">extends</span> <span class="n">WindowContainer</span><span class="o">&lt;</span><span class="n">WindowContainer</span><span class="o">&gt;</span> <span class="o">{}</span>
</code></pre></div><blockquote>
<p>关于Task相关</p>
<p>如果该应用没有Task存在（应用最近没有使用过），则会创建一个新的Task，并且该应用的“主”Activity 将会作为堆栈的根 Activity 打开。在当前 Activity 启动另一个 Activity 时，新的 Activity 将被推送到堆栈顶部并获得焦点。上一个 Activity 仍保留在堆栈中，但会停止。当 Activity 停止时，系统会保留其界面的当前状态。当用户按返回按 钮时，当前 Activity 会从堆栈顶部退出（该 Activity 销毁），上一个 Activity 会恢复（界面会恢复到上一个状态）。堆栈中的 Activity 永远不会重新排列，只会被送入和退出，在当前 Activity 启动时被送入堆栈，在用户使用返回按钮离开时从堆栈中退出。因此，返回堆栈按照“后进先出”的对象结构运作。图 1 借助一个时间轴直观地显示了这种行为。该时间轴显示了 Activity 之间的进展以及每个时间点的当前返回堆栈。


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window41.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window41.png" >
  
    </a>
  
  
</div>
</p>
</blockquote>
<p>WMS中的Task类的作用和以上说明基本一致，用来管理ActivityRecord。</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>$ dumpsys activity containers
<span class="ln">2</span><span class="c1">#6 Task=67 type=standard mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1612]</span>
<span class="ln">3</span><span class="c1">#0 ActivityRecord{cb9b141 u0 com.google.android.apps.messaging/.ui.ConversationListActivity t67} type=standard mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1612]</span>
<span class="ln">4</span><span class="c1">#0 d01e570 com.google.android.apps.messaging/com.google.android.apps.messaging.ui.ConversationListActivity type=standard mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1612]</span>
</code></pre></div>

 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window40.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window40.png" >
  
    </a>
  
  
</div>

<p>接着再启动Message的另外一个界面</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>$ dumpsys activity containers
<span class="ln">2</span><span class="c1">#6 Task=67 type=standard mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1612]</span>
<span class="ln">3</span><span class="c1">#1 ActivityRecord{77ab155 u0 com.google.android.apps.messaging/.conversation.screen.ConversationActivity t67} type=standard mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1612]</span>
<span class="ln">4</span><span class="c1">#0 e50283c com.google.android.apps.messaging/com.google.android.apps.messaging.conversation.screen.ConversationActivity type=standard mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1612]</span>
<span class="ln">5</span><span class="c1">#0 ActivityRecord{cb9b141 u0 com.google.android.apps.messaging/.ui.ConversationListActivity t67} type=standard mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1612]</span>
<span class="ln">6</span><span class="c1">#0 d01e570 com.google.android.apps.messaging/com.google.android.apps.messaging.ui.ConversationListActivity type=standard mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1612]</span>
</code></pre></div>

 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window42.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window42.png" >
  
    </a>
  
  
</div>

<p>Task也支持嵌套的，从Task类的定义也可以看出来，Task的嵌套多用于多窗口模式，如<strong>分屏</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>$ dumpsys activity containers
<span class="ln">2</span><span class="c1">#2 Task=5 type=standard mode=split-screen-primary override-mode=split-screen-primary requested-bounds=[0,0][720,770] bounds=[0,0][720,770]</span>
<span class="ln">3</span><span class="c1">#0 Task=67 type=standard mode=split-screen-primary override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,770]</span>
<span class="ln">4</span><span class="c1">#0 ActivityRecord{cb9b141 u0 com.google.android.apps.messaging/.ui.ConversationListActivity t67} type=standard mode=split-screen-primary override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,770]</span>
<span class="ln">5</span><span class="c1">#0 d01e570 com.google.android.apps.messaging/com.google.android.apps.messaging.ui.ConversationListActivity type=standard mode=split-screen-primary override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,770]</span>
</code></pre></div>

 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window43.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window43.png" >
  
    </a>
  
  
</div>

<h5 id="24277-task的容器-taskdisplayarea">2.4.2.7.7 Task的容器 （TaskDisplayArea）</h5>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln">1</span><span class="c1">//frameworks/base/services/core/java/com/android/server/wm/TaskDisplayArea.java
</span><span class="ln">2</span><span class="c1"></span><span class="kd">final</span> <span class="kd">class</span> <span class="nc">TaskDisplayArea</span> <span class="kd">extends</span> <span class="n">DisplayArea</span><span class="o">&lt;</span><span class="n">WindowContainer</span><span class="o">&gt;</span> <span class="o">{}</span>
</code></pre></div><p>TaskDisplayArea，代表了屏幕上一块专门用来存放App窗口的区域。它的子容器可能是<strong>Task</strong>或者是<strong>TaskDisplayArea</strong>。</p>
<h5 id="24278-displayarea容器">2.4.2.7.8 DisplayArea容器</h5>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln">1</span><span class="c1">//frameworks/base/services/core/java/com/android/server/wm/DisplayArea.java
</span><span class="ln">2</span><span class="c1"></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DisplayArea</span><span class="o">&lt;</span><span class="n">T</span> <span class="kd">extends</span> <span class="n">WindowContainer</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">WindowContainer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{}</span>    
</code></pre></div><p>DisplayArea，是DisplayContent之下的对WindowContainer进行分组的容器。</p>
<p>DisplayArea<strong>受DisplayAreaPolicy管理</strong>，DisplayArea可以<strong>包含嵌套DisplayArea</strong>。</p>
<p>DisplayArea有三种风格，用来保证窗口能够拥有正确的Z轴顺序：</p>
<ul>
<li><strong>BELOW_TASKS</strong>，只能包含Task之下的的DisplayArea和WindowToken</li>
<li><strong>ABOVE_TASKS</strong>，只能包含Task之上的DisplayArea和WindowToken</li>
<li><strong>ANY</strong>，能包含任何种类的DisplayArea、WindowToken或是Task容器</li>
</ul>
<p>这里和我们之前分析WindowToken的时候逻辑是一样的，DisplayArea的子类有一个专门用来存放Task的容器类，TaskDisplayArea。层级高于TaskDisplayArea的DisplayArea，会被归类为ABOVE_TASKS，层级低于TaskDisplayArea则属于ABOVE_TASKS。</p>
<p>DisplayArea有三个直接子类，<strong>TaskDisplayArea</strong>，<strong>DisplayArea.Tokens</strong>和<strong>DisplayArea.Dimmable</strong>。</p>
<h5 id="24279-taskdisplayarea">2.4.2.7.9 TaskDisplayArea</h5>
<p>2.4.2.7.7中已经列出了具体的类，TaskDisplayArea代表了屏幕上的一个包含App类型的WindowContainer的区域。它的子节点可以是Task，或者是TaskDisplayArea。目前在代码中，创建TaskDisplayArea的地方只有一处，即<strong>TaskDisplayArea存放Task的容器</strong>。</p>
<p>在手机的近期任务列表界面将所有App都清掉后，查看一下此时的TaskDisplayArea情况</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln"> 1</span>$ dumpsys activity containers
<span class="ln"> 2</span><span class="c1">#0 DefaultTaskDisplayArea type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1440,2960]</span>
<span class="ln"> 3</span><span class="c1">#5 Task=1 type=home mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1440,2960]</span>
<span class="ln"> 4</span><span class="c1">#0 Task=191 type=home mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1440,2960]</span>
<span class="ln"> 5</span><span class="c1">#0 ActivityRecord{31ce9e6 u0 com.google.android.apps.nexuslauncher/.NexusLauncherActivity t191} type=home mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1440,2960]</span>
<span class="ln"> 6</span><span class="c1">#1 220afda com.google.android.apps.nexuslauncher/com.google.android.apps.nexuslauncher.NexusLauncherActivity type=home mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1440,2960]</span>
<span class="ln"> 7</span><span class="c1">#0 4cf47c3 com.google.android.apps.nexuslauncher/com.google.android.apps.nexuslauncher.NexusLauncherActivity type=home mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1440,2960]</span>
<span class="ln"> 8</span><span class="c1">#4 Task=4 type=undefined mode=fullscreen override-mode=fullscreen requested-bounds=[0,0][0,0] bounds=[0,0][1440,2960]</span>
<span class="ln"> 9</span><span class="c1">#3 Task=3 type=undefined mode=split-screen-secondary override-mode=split-screen-secondary requested-bounds=[0,1498][1440,2960] bounds=[0,1498][1440,2960]</span>
<span class="ln">10</span><span class="c1">#2 Task=2 type=undefined mode=split-screen-primary override-mode=split-screen-primary requested-bounds=[0,0][1440,1464] bounds=[0,0][1440,1464]</span>
<span class="ln">11</span><span class="c1">#1 Task=5 type=undefined mode=multi-window override-mode=multi-window requested-bounds=[0,0][0,0] bounds=[0,0][1440,2960]</span>
<span class="ln">12</span><span class="c1">#0 Task=6 type=undefined mode=multi-window override-mode=multi-window requested-bounds=[0,0][0,0] bounds=[0,0][1440,2960]</span>
</code></pre></div><p>正常来说，App端调用startActivity后，WMS会为新创建的ActivityRecord对象创建Task，用来存放这个ActivityRecord。当Task中的所有ActivityRecord都被移除后，这个Task就会被移除，就如Task#1，或者Task#191。但是对于Task#4之类的Task来说并不是这样。这些Task是WMS启动后就由TaskOrganizerController创建的，这些Task并没有和某一具体的App联系起来，因此当它里面的子WindowContainer被移除后，这个Task也不会被销毁，比如分屏Task#3和Task#2


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window44.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window44.png" >
  
    </a>
  
  
</div>
</p>
<h5 id="242710-displayareatokens">2.4.2.7.10 DisplayArea.Tokens</h5>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln">1</span><span class="c1">//frameworks/base/services/core/java/com/android/server/wm/DisplayArea.java
</span><span class="ln">2</span><span class="c1"></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DisplayArea</span><span class="o">&lt;</span><span class="n">T</span> <span class="kd">extends</span> <span class="n">WindowContainer</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">WindowContainer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
<span class="ln">3</span>    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Tokens</span> <span class="kd">extends</span> <span class="n">DisplayArea</span><span class="o">&lt;</span><span class="n">WindowToken</span><span class="o">&gt;</span> <span class="o">{}</span>
<span class="ln">4</span><span class="o">}</span>
</code></pre></div><p>Tokens是DisplayArea的内部类，从其定义即可看出，它是一个只能包含WindowToken对象的DisplayArea类型的容器，那么其内部层级结构就相对简单，比如StatusBar</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>$ dumpsys activity containers
<span class="ln">2</span><span class="c1">#0 Leaf:17:17 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1440,2960]</span>
<span class="ln">3</span><span class="c1">#0 WindowToken{ef15750 android.os.BinderProxy@4562c02} type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1440,2960]</span>
<span class="ln">4</span><span class="c1">#0 d3cbd49 StatusBar type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1440,2960]</span>
</code></pre></div>

 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window45.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window45.png" >
  
    </a>
  
  
</div>

<h5 id="242711displayareadimmable">2.4.2.7.11DisplayArea.Dimmable</h5>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln">1</span><span class="c1">//frameworks/base/services/core/java/com/android/server/wm/DisplayArea.java
</span><span class="ln">2</span><span class="c1"></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DisplayArea</span><span class="o">&lt;</span><span class="n">T</span> <span class="kd">extends</span> <span class="n">WindowContainer</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">WindowContainer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
<span class="ln">3</span>    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Dimmable</span> <span class="kd">extends</span> <span class="n">DisplayArea</span><span class="o">&lt;</span><span class="n">DisplayArea</span><span class="o">&gt;</span> <span class="o">{}</span>
<span class="ln">4</span><span class="o">}</span>
</code></pre></div><p>Dimmable也是DisplayArea的内部类，从名字可以看出，这类的DisplayArea可以<strong>添加模糊效果</strong>，并且Dimmable也是一个DisplayArea类型的DisplayArea容器。</p>
<p>它内部有一个Dimmer对象</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln">1</span><span class="c1">//frameworks/base/services/core/java/com/android/server/wm/DisplayArea.java
</span><span class="ln">2</span><span class="c1"></span><span class="kd">private</span> <span class="kd">final</span> <span class="n">Dimmer</span> <span class="n">mDimmer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Dimmer</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</code></pre></div><p>可以通过Dimmer对象施加模糊效果，模糊图层可以插入到以该Dimmable对象为根节点的层级结构之下的任意两个图层之间。</p>
<p>它有一个直接子类，RootDisplayArea。</p>
<h5 id="242712-displaycontentimecontainer">2.4.2.7.12 DisplayContent.ImeContainer</h5>
<p>DisplayArea.Tokens有一个子类DisplayContent.ImeContainer</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln">1</span><span class="c1">//frameworks/base/services/core/java/com/android/server/wm/DisplayContent.java
</span><span class="ln">2</span><span class="c1"></span><span class="kd">class</span> <span class="nc">DisplayContent</span> <span class="kd">extends</span> <span class="n">RootDisplayArea</span> <span class="kd">implements</span> <span class="n">WindowManagerPolicy</span><span class="o">.</span><span class="na">DisplayContentInfo</span> <span class="o">{</span>
<span class="ln">3</span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ImeContainer</span> <span class="kd">extends</span> <span class="n">DisplayArea</span><span class="o">.</span><span class="na">Tokens</span> <span class="o">{}</span>
<span class="ln">4</span><span class="o">}</span>
</code></pre></div><p>DisplayContent的内部类，ImeContainer，是存放输入法窗口的容器。它继承的是DisplayArea.Tokens，说明它是一个只能存放WindowToken容器。</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>$ dumpsys activity containers
<span class="ln">2</span><span class="c1">#0 ImeContainer type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1612]</span>
<span class="ln">3</span><span class="c1">#0 WindowToken{5e01794 android.os.Binder@579cfe7} type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1612]</span>
<span class="ln">4</span><span class="c1">#0 4435738 InputMethod type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1612]</span>
</code></pre></div>

 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window46.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window46.png" >
  
    </a>
  
  
</div>

<h5 id="242713-rootdisplayarea">2.4.2.7.13 RootDisplayArea</h5>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln">1</span><span class="c1">//frameworks/base/services/core/java/com/android/server/wm/RootDisplayArea.java
</span><span class="ln">2</span><span class="c1"></span><span class="kd">class</span> <span class="nc">RootDisplayArea</span> <span class="kd">extends</span> <span class="n">DisplayArea</span><span class="o">.</span><span class="na">Dimmable</span> <span class="o">{}</span>
</code></pre></div><p>RootDisplayArea，是一个DisplayArea层级结构的根节点。</p>
<p>它可以是：</p>
<ul>
<li><strong>DisplayContent</strong>，作为整个屏幕的DisplayArea层级结构根节点。</li>
<li><strong>DisplayAreaGroup</strong>，作为屏幕上部分区域对应的DisplayArea层级结构的根节点。</li>
</ul>
<p>这又引申出了RootDisplayArea的两个子类，<strong>DisplayContent</strong>和<strong>DisplayAreaGroup</strong>(这个是车载用到的，暂时不考虑)。</p>
<h5 id="242714-displaycontent">2.4.2.7.14 DisplayContent</h5>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln">1</span><span class="c1">//frameworks/base/services/core/java/com/android/server/wm/DisplayContent.java
</span><span class="ln">2</span><span class="c1"></span><span class="kd">class</span> <span class="nc">DisplayContent</span> <span class="kd">extends</span> <span class="n">RootDisplayArea</span> <span class="kd">implements</span> <span class="n">WindowManagerPolicy</span><span class="o">.</span><span class="na">DisplayContentInfo</span> <span class="o">{}</span>
</code></pre></div><p>DisplayContent，代表了一个实际的屏幕，那么它作为一个屏幕上的DisplayArea层级结构的根节点也没有毛病。</p>
<p>隶属于同一个DisplayContent的窗口将会被显示在同一个屏幕中。每一个DisplayContent都对应着唯一ID，比如<strong>默认屏幕是0</strong></p>
<p>那么以DisplayContent为根节点的DisplayArea层级结构可能是</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window48.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window48.png" >
  
    </a>
  
  
</div>

<h5 id="242715-rootwindowcontainer">2.4.2.7.15 RootWindowContainer</h5>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln">1</span><span class="c1">//frameworks/base/services/core/java/com/android/server/wm/RootWindowContainer.java
</span><span class="ln">2</span><span class="c1"></span><span class="kd">class</span> <span class="nc">RootWindowContainer</span> <span class="kd">extends</span> <span class="n">WindowContainer</span><span class="o">&lt;</span><span class="n">DisplayContent</span><span class="o">&gt;</span>
<span class="ln">3</span>        <span class="kd">implements</span> <span class="n">DisplayManager</span><span class="o">.</span><span class="na">DisplayListener</span> <span class="o">{}</span>
</code></pre></div><p>从名字也可以看出，这个类代表当前设备的根WindowContainer，就像View层级结构中的DecorView一样，它是DisplayContent的容器。由于DisplayContent代表了一个屏幕，且RootWindowContainer能够作为DisplayContent的父容器，这也说明了Android是支持多屏幕的，展开来说就是包括一个内部屏幕（内置于手机或平板电脑中的屏幕）、一个外部屏幕（如通过 HDMI 连接的电视）以及一个或多个虚拟屏幕。</p>
<p>如果我们在开发者选项里通过“Simulate secondary displays”开启另一个虚拟屏幕(或者是辅助模拟显示设备)，此时的情况是：</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln">1</span>$ dumpsys activity containers
<span class="ln">2</span>ROOT <span class="nv">type</span><span class="o">=</span>undefined <span class="nv">mode</span><span class="o">=</span>fullscreen override-mode<span class="o">=</span>undefined requested-bounds<span class="o">=[</span>0,0<span class="o">][</span>0,0<span class="o">]</span> <span class="nv">bounds</span><span class="o">=[</span>0,0<span class="o">][</span>720,1612<span class="o">]</span>
<span class="ln">3</span>  <span class="c1">#1 Display 0 name=&#34;Built-in screen&#34; type=undefined mode=fullscreen override-mode=fullscreen requested-bounds=[0,0][720,1612] bounds=[0,0][720,1612]</span>
<span class="ln">4</span>  <span class="c1">#0 Display 2 name=&#34;Overlay #1&#34; type=undefined mode=fullscreen override-mode=fullscreen requested-bounds=[0,0][720,480] bounds=[0,0][720,480]</span>
</code></pre></div><p>“Root”即RootWindowContainer，“Display 0”代表默认屏幕，“Display 2”是我们开启的虚拟屏幕。</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window47.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window47.png" >
  
    </a>
  
  
</div>

<h4 id="2428最终构建窗口层级图">2.4.2.8最终构建窗口层级图</h4>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window36.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window36.png" >
  
    </a>
  
  
</div>

<h4 id="2429-总结">2.4.2.9 总结</h4>
<p>除了WindowState可以显示图像以外，大部分的WindowContainer，如WindowToken、TaskDisplayArea是不会有内容显示的，都只是一个<strong>抽象的容器概念</strong>。WMS如果只为了管理窗口，WMS也可以不创建这些个WindowContainer类，直接用一个类似列表的东西，将屏幕上显示的窗口全部添加到这个列表中，通过这一个列表来对所有的窗口进行管理。但是为了更有逻辑地管理屏幕上显示的窗口，还是需要创建各种各样的窗口容器类，即WindowContainer及其子类，来对WindowState进行分类，从而对窗口进行系统化的管理。</p>
<table>
<thead>
<tr>
<th style="text-align:center">设计复杂的Window容器意义</th>
<th style="text-align:center">详细描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>WindowContainer</code>类都有着鲜明的上下级关系，一般不能越级处理</td>
<td style="text-align:center">比如<code>DefaultTaskDisplayArea</code>只用来管理调度<code>Task</code>，<code>Task</code>用来管理调度<code>ActivityRecord</code>，而<code>DefaultTaskDisplayArea</code>不能直接越过<code>Task</code>去调度<code>Task</code>中的<code>ActivityRecord</code>。这样<code>TaskDisplayArea</code>只需要关注它的子容器们，即Task的管理，<code>ActivityRecord</code>相关的事务让<code>Task</code>去操心就好，每一级与每一级之间的边界都很清晰，不会在管理逻辑上出现混乱，比如<code>DefaultTaskDisplayArea</code>强行去调整一个<code>ActivityRecord</code>的位置，导致这个<code>ActivityRecord</code>跳出它所在的<code>Task</code>，变成和<code>Task</code>一个层级</td>
</tr>
<tr>
<td style="text-align:center">保证了每一个<code>WiindowContainer</code>不会越界</td>
<td style="text-align:center">比如我点击<code>HOME</code>键回到<code>Launcher</code>，此时<code>DefaultTaskDisplayArea</code>就会把<code>Launcher</code>对应的<code>Task#1</code>，移动到它内部栈的栈顶，而这仅限于<code>DefaultTaskDisplayArea</code>内部的调整，这一点保证了<code>Launcher</code>的窗口将永远不可能高于<code>StatusBar</code>窗口，也不会低于<code>Wallpaper</code>窗口</td>
</tr>
</tbody>
</table>
<h3 id="243实例分析window容器">2.4.3实例分析Window容器</h3>
<p>这里举一个实例，以android13设备手机为例</p>
<table>
<thead>
<tr>
<th>手机型号</th>
<th>三星Galaxy F52 5G</th>
</tr>
</thead>
<tbody>
<tr>
<td>Android版本</td>
<td>Android13</td>
</tr>
<tr>
<td>测试场景</td>
<td>屏幕点亮的Launcher界面</td>
</tr>
<tr>
<td>后台应用</td>
<td>无</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln"> 1</span>dumpf52x:/ $ dumpsys activity containers
<span class="ln"> 2</span>ACTIVITY MANAGER CONTAINERS <span class="o">(</span>dumpsys activity containers<span class="o">)</span>
<span class="ln"> 3</span>ROOT <span class="nv">type</span><span class="o">=</span>undefined <span class="nv">mode</span><span class="o">=</span>fullscreen override-mode<span class="o">=</span>undefined requested-bounds<span class="o">=[</span>0,0<span class="o">][</span>0,0<span class="o">]</span> <span class="nv">bounds</span><span class="o">=[</span>0,0<span class="o">][</span>1080,2408<span class="o">]</span>
<span class="ln"> 4</span>  <span class="c1">#0 Display 0 name=&#34;内置屏幕&#34; type=undefined mode=fullscreen override-mode=fullscreen</span>
<span class="ln"> 5</span> requested-bounds<span class="o">=[</span>0,0<span class="o">][</span>1080,2408<span class="o">]</span> <span class="nv">bounds</span><span class="o">=[</span>0,0<span class="o">][</span>1080,2408<span class="o">]</span>
<span class="ln"> 6</span>   <span class="c1">#2 Leaf:36:36 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln"> 7</span>   <span class="c1">#1 HideDisplayCutout:32:35 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln"> 8</span>    <span class="c1">#2 OneHanded:34:35 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln"> 9</span>     <span class="c1">#0 FullscreenMagnification:34:35 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">10</span>      <span class="c1">#0 Leaf:34:35 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">11</span>    <span class="c1">#1 FullscreenMagnification:33:33 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">12</span>     <span class="c1">#0 Leaf:33:33 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">13</span>      <span class="c1">#0 WindowToken{258c658 type=2015 android.os.BinderProxy@d28af3b} type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">14</span>       <span class="c1">#0 c4b73b1 LockscreenShortcutBlur type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">15</span>    <span class="c1">#0 OneHanded:32:32 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">16</span>     <span class="c1">#0 Leaf:32:32 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">17</span>   <span class="c1">#0 WindowedMagnification:0:31 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">18</span>    <span class="c1">#6 HideDisplayCutout:26:31 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">19</span>     <span class="c1">#0 OneHanded:26:31 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">20</span>      <span class="c1">#2 FullscreenMagnification:29:31 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">21</span>       <span class="c1">#0 Leaf:29:31 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">22</span>        <span class="c1">#0 WindowToken{b23fa21 type=2016 android.os.BinderProxy@b432f6e} type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">23</span>         <span class="c1">#0 31d42b ShellDropTarget type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">24</span>      <span class="c1">#1 Leaf:28:28 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">25</span>      <span class="c1">#0 FullscreenMagnification:26:27 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">26</span>       <span class="c1">#0 Leaf:26:27 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">27</span>    <span class="c1">#5 Leaf:24:25 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">28</span>     <span class="c1">#2 WindowToken{d14c3be type=2024 android.os.BinderProxy@da64a79} type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">29</span>      <span class="c1">#0 a381535 SecondaryHomeHandle0 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">30</span>     <span class="c1">#1 WindowToken{23be81 type=2024 android.os.BinderProxy@3ab3a68} type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">31</span>      <span class="c1">#0 c099b26 EdgeBackGestureHandler0 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">32</span>     <span class="c1">#0 WindowToken{62fdc7 type=2019 android.os.BinderProxy@1c389e1} type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">33</span>      <span class="c1">#0 2aa9419 NavigationBar0 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">34</span>    <span class="c1">#4 HideDisplayCutout:18:23 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">35</span>     <span class="c1">#0 OneHanded:18:23 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">36</span>      <span class="c1">#0 FullscreenMagnification:18:23 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">37</span>       <span class="c1">#0 Leaf:18:23 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">38</span>        <span class="c1">#0 WindowToken{ece377f type=2226 android.os.BinderProxy@d8c209e} type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">39</span>         <span class="c1">#0 895a8aa com.samsung.android.app.cocktailbarservice/com.samsung.android.app.cocktailbarservice.CocktailBarService type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">40</span>    <span class="c1">#3 OneHanded:17:17 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">41</span>     <span class="c1">#0 FullscreenMagnification:17:17 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">42</span>      <span class="c1">#0 Leaf:17:17 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">43</span>       <span class="c1">#0 WindowToken{11fdd2b type=2040 android.os.BinderProxy@e1219a5} type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">44</span>        <span class="c1">#0 6f61b46 NotificationShade type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">45</span>    <span class="c1">#2 HideDisplayCutout:16:16 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">46</span>     <span class="c1">#0 OneHanded:16:16 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">47</span>      <span class="c1">#0 FullscreenMagnification:16:16 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">48</span>       <span class="c1">#0 Leaf:16:16 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">49</span>    <span class="c1">#1 OneHanded:15:15 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">50</span>     <span class="c1">#0 FullscreenMagnification:15:15 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">51</span>      <span class="c1">#0 Leaf:15:15 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">52</span>       <span class="c1">#0 WindowToken{b620a94 type=2000 android.os.BinderProxy@7d4e01} type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">53</span>        <span class="c1">#0 d5e5283 StatusBar type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">54</span>    <span class="c1">#0 HideDisplayCutout:0:14 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">55</span>     <span class="c1">#0 OneHanded:0:14 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">56</span>      <span class="c1">#1 ImePlaceholder:13:14 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">57</span>       <span class="c1">#0 ImeContainer type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">58</span>        <span class="c1">#1 WindowToken{33d4588 type=2011 android.os.Binder@1bfed2b} type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">59</span>         <span class="c1">#0 dd5ca43 InputMethod type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">60</span>        <span class="c1">#0 WindowToken{d802601 type=2011 android.os.Binder@7a28fe8} type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">61</span>      <span class="c1">#0 FullscreenMagnification:0:12 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">62</span>       <span class="c1">#2 Leaf:3:12 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">63</span>        <span class="c1">#0 WindowToken{6102e33 type=2038 android.os.BinderProxy@81db1a2} type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">64</span>       <span class="c1">#1 DefaultTaskDisplayArea type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">65</span>        <span class="c1">#2 Task=22 type=home mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">66</span>         <span class="c1">#0 Task=23 type=home mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">67</span>          <span class="c1">#0 ActivityRecord{ba66eb5 u0 com.sec.android.app.launcher/.activities.LauncherActivity} t23} type=home mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">68</span>           <span class="c1">#0 6e2f047 com.sec.android.app.launcher/com.sec.android.app.launcher.activities.LauncherActivity type=home mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">69</span>            <span class="c1">#0 bec7e6c com.samsung.android.app.spage type=home mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">70</span>        <span class="c1">#1 Task=2 type=undefined mode=fullscreen override-mode=fullscreen requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">71</span>        <span class="c1">#0 Task=3 type=undefined mode=fullscreen override-mode=fullscreen requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">72</span>         <span class="c1">#1 Task=5 type=undefined mode=multi-window override-mode=multi-window requested-bounds=[0,0][1080,1222] bounds=[0,0][1080,1222]</span>
<span class="ln">73</span>         <span class="c1">#0 Task=4 type=undefined mode=multi-window override-mode=multi-window requested-bounds=[0,1245][1080,2408] bounds=[0,1245][1080,2408]</span>
<span class="ln">74</span>       <span class="c1">#0 Leaf:0:1 type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">75</span>        <span class="c1">#0 WallpaperWindowToken{c835f1c token=android.os.Binder@7d6e08f} type=undefined mode=fullscreen override-mode=fullscreen requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
<span class="ln">76</span>         <span class="c1">#0 3d43d44 com.android.systemui.ImageWallpaper type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2408]</span>
</code></pre></div><p>window层次逻辑图如下所示，标红的为叶子结点，同色的为同一层级</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window8.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window8.png" >
  
    </a>
  
  
</div>

<h2 id="25addviewupdateviewlayoutremoveview">2.5addView/updateViewLayout/removeView</h2>
<p>在 Android 系统中，<strong>屏幕的抽象是 DisplayContent</strong> ，在屏幕的抽象上，通过不同的窗口，展示不同的应用程序页面和一些其他UI 组件（例如 Dialog、状态栏等）。Window 通过在 Z 轴叠放，从而实现了复杂的交互逻辑。</p>
<p>Window 实际是 View 的<strong>直接管理者</strong>，例如笔者点击屏幕，对应 Activity 里面收到点击事件后，会首先通过Activity对应的 window 将事件传递到 DecorView，最后再分发到我们的 View 上。而Window 是一个处理顶级窗口外观和行为策略的抽象基类，它的具体实现是 PhoneWindow 类，<strong>PhoneWindow 对 View 进行管理</strong>。</p>
<h3 id="251window和activity以及windowmanager建立联系">2.5.1Window和Activity以及WindowManager建立联系</h3>
<p>这里以Activity为例，其他Dialog、DreamOverlay、FloatWindow等可以自行查找源码阅读。</p>
<p>Activity在启动的过程中，会调用它的attach方法进行Window的创建</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/core/java/android/app/Activity.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">final</span> <span class="kt">void</span> <span class="nf">attach</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">ActivityThread</span> <span class="n">aThread</span><span class="o">,</span>
<span class="ln"> 3</span>                  <span class="n">Instrumentation</span> <span class="n">instr</span><span class="o">,</span> <span class="n">IBinder</span> <span class="n">token</span><span class="o">,</span> <span class="kt">int</span> <span class="n">ident</span><span class="o">,</span>
<span class="ln"> 4</span>                  <span class="n">Application</span> <span class="n">application</span><span class="o">,</span> <span class="n">Intent</span> <span class="n">intent</span><span class="o">,</span> <span class="n">ActivityInfo</span> <span class="n">info</span><span class="o">,</span>
<span class="ln"> 5</span>                  <span class="n">CharSequence</span> <span class="n">title</span><span class="o">,</span> <span class="n">Activity</span> <span class="n">parent</span><span class="o">,</span> <span class="n">String</span> <span class="n">id</span><span class="o">,</span>
<span class="ln"> 6</span>                  <span class="n">NonConfigurationInstances</span> <span class="n">lastNonConfigurationInstances</span><span class="o">,</span>
<span class="ln"> 7</span>                  <span class="n">Configuration</span> <span class="n">config</span><span class="o">,</span> <span class="n">String</span> <span class="n">referrer</span><span class="o">,</span> <span class="n">IVoiceInteractor</span> <span class="n">voiceInteractor</span><span class="o">,</span>
<span class="ln"> 8</span>                  <span class="n">Window</span> <span class="n">window</span><span class="o">,</span> <span class="n">ActivityConfigCallback</span> <span class="n">activityConfigCallback</span><span class="o">,</span> <span class="n">IBinder</span> <span class="n">assistToken</span><span class="o">,</span>
<span class="ln"> 9</span>                  <span class="n">IBinder</span> <span class="n">shareableActivityToken</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">10</span>    <span class="o">...</span>
<span class="ln">11</span>    <span class="c1">//[2.5.1.1]
</span><span class="ln">12</span><span class="c1"></span>    <span class="n">mWindow</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PhoneWindow</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">window</span><span class="o">,</span> <span class="n">activityConfigCallback</span><span class="o">);</span>
<span class="ln">13</span>    <span class="o">...</span>
<span class="ln">14</span>    <span class="c1">//[2.5.1.2]    
</span><span class="ln">15</span><span class="c1"></span>    <span class="n">mWindow</span><span class="o">.</span><span class="na">setWindowManager</span><span class="o">(</span>
<span class="ln">16</span>        <span class="o">(</span><span class="n">WindowManager</span><span class="o">)</span><span class="n">context</span><span class="o">.</span><span class="na">getSystemService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">WINDOW_SERVICE</span><span class="o">),</span>
<span class="ln">17</span>        <span class="n">mToken</span><span class="o">,</span> <span class="n">mComponent</span><span class="o">.</span><span class="na">flattenToString</span><span class="o">(),</span>
<span class="ln">18</span>        <span class="o">(</span><span class="n">info</span><span class="o">.</span><span class="na">flags</span> <span class="o">&amp;</span> <span class="n">ActivityInfo</span><span class="o">.</span><span class="na">FLAG_HARDWARE_ACCELERATED</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">);</span>
<span class="ln">19</span><span class="o">}</span>
</code></pre></div><h4 id="2511phonewindow">2.5.1.1PhoneWindow</h4>
<p><strong>创建了一个PhoneWindow，并传入当前Activity的this对象</strong>， PhoneWindow类，继承了Window</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/core/java/com/android/internal/policy/PhoneWindow.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PhoneWindow</span> <span class="kd">extends</span> <span class="n">Window</span> <span class="o">{</span>
<span class="ln"> 3</span>    <span class="kd">public</span> <span class="nf">PhoneWindow</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">Window</span> <span class="n">preservedWindow</span><span class="o">,</span>
<span class="ln"> 4</span>            <span class="n">ActivityConfigCallback</span> <span class="n">activityConfigCallback</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 5</span>        <span class="c1">//这里最终会调父类Window的构造方法，并传入Activity的实例context
</span><span class="ln"> 6</span><span class="c1"></span>        <span class="k">this</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
<span class="ln"> 7</span>        <span class="c1">//只有Activity的Window才会使用Decor context,其他依赖使用的Context
</span><span class="ln"> 8</span><span class="c1"></span>        <span class="n">mUseDecorContext</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
<span class="ln"> 9</span>        <span class="o">...</span>
<span class="ln">10</span>   <span class="o">}</span>
<span class="ln">11</span>
<span class="ln">12</span><span class="o">}</span>
</code></pre></div><p>调用父类方法，让抽象父类内部持有Activity的实例化对象context</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln">1</span><span class="c1">//frameworks_base/core/java/android/view/Window.java
</span><span class="ln">2</span><span class="c1"></span><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Window</span> <span class="o">{</span>
<span class="ln">3</span>     <span class="kd">public</span> <span class="nf">Window</span><span class="o">(</span><span class="nd">@UiContext</span> <span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">4</span>        <span class="n">mContext</span> <span class="o">=</span> <span class="n">context</span><span class="o">;</span>
<span class="ln">5</span>        <span class="n">mFeatures</span> <span class="o">=</span> <span class="n">mLocalFeatures</span> <span class="o">=</span> <span class="n">getDefaultFeatures</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
<span class="ln">6</span>    <span class="o">}</span>   
<span class="ln">7</span><span class="o">}</span>
</code></pre></div><p>PhoneWindow的构造方法中传入当前Activity对象， 并最终在父类Window构造方法中给mContext赋值，<strong>Window得到Activity的引用，由此就建立了Window和Activity的联系。</strong></p>
<h4 id="2512setwindowmanager">2.5.1.2setWindowManager</h4>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks_base/core/java/android/view/Window.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="cm">/**
</span><span class="ln"> 3</span><span class="cm">     *用Window来设置窗口管理器，例如，显示面板。Window本身不能用于显示，必须通过客户端设置
</span><span class="ln"> 4</span><span class="cm">     *window manager 用来添加新的Windows
</span><span class="ln"> 5</span><span class="cm">     */</span>
<span class="ln"> 6</span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">setWindowManager</span><span class="o">(</span><span class="n">WindowManager</span> <span class="n">wm</span><span class="o">,</span> <span class="n">IBinder</span> <span class="n">appToken</span><span class="o">,</span> <span class="n">String</span> <span class="n">appName</span><span class="o">,</span>
<span class="ln"> 7</span>                             <span class="kt">boolean</span> <span class="n">hardwareAccelerated</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 8</span>    <span class="c1">//前三个参数是基本配置，包括AppToken，AppName和是否硬件加速
</span><span class="ln"> 9</span><span class="c1"></span>    <span class="n">mAppToken</span> <span class="o">=</span> <span class="n">appToken</span><span class="o">;</span>
<span class="ln">10</span>    <span class="n">mAppName</span> <span class="o">=</span> <span class="n">appName</span><span class="o">;</span>
<span class="ln">11</span>    <span class="n">mHardwareAccelerated</span> <span class="o">=</span> <span class="n">hardwareAccelerated</span><span class="o">;</span>
<span class="ln">12</span>    <span class="k">if</span> <span class="o">(</span><span class="n">wm</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">13</span>        <span class="c1">//[2.5.1.3]
</span><span class="ln">14</span><span class="c1"></span>        <span class="n">wm</span> <span class="o">=</span> <span class="o">(</span><span class="n">WindowManager</span><span class="o">)</span><span class="n">mContext</span><span class="o">.</span><span class="na">getSystemService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">WINDOW_SERVICE</span><span class="o">);</span>
<span class="ln">15</span>    <span class="o">}</span>
<span class="ln">16</span>    <span class="c1">//[2.5.1.4]
</span><span class="ln">17</span><span class="c1"></span>    <span class="n">mWindowManager</span> <span class="o">=</span> <span class="o">((</span><span class="n">WindowManagerImpl</span><span class="o">)</span><span class="n">wm</span><span class="o">).</span><span class="na">createLocalWindowManager</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
<span class="ln">18</span><span class="o">}</span>
</code></pre></div><h4 id="2513-getsystemservicecontextwindow_service">2.5.1.3 getSystemService(Context.WINDOW_SERVICE)</h4>
<p>这里就是获取系统注册的服务，主要是SystemServer，属于服务应用层的服务，其他包括AMS，PMS等</p>
<p>注意到SystemServiceRegistry的<strong>static 方法</strong>，这个方法内部注册了很多服务，我们可以在方法里面找到name = Context.WINDOW_SERVICE的服务</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/core/java/android/app/SystemServiceRegistry.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">static</span> <span class="o">{</span>
<span class="ln"> 3</span>    <span class="n">registerService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">WINDOW_SERVICE</span><span class="o">,</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
<span class="ln"> 4</span>                    <span class="k">new</span> <span class="n">CachedServiceFetcher</span><span class="o">&lt;</span><span class="n">WindowManager</span><span class="o">&gt;()</span> <span class="o">{</span>
<span class="ln"> 5</span>                        <span class="nd">@Override</span>
<span class="ln"> 6</span>                        <span class="kd">public</span> <span class="n">WindowManager</span> <span class="nf">createService</span><span class="o">(</span><span class="n">ContextImpl</span> <span class="n">ctx</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 7</span>                            <span class="c1">//最终会回调到这
</span><span class="ln"> 8</span><span class="c1"></span>                            <span class="k">return</span> <span class="k">new</span> <span class="n">WindowManagerImpl</span><span class="o">(</span><span class="n">ctx</span><span class="o">);</span>
<span class="ln"> 9</span>                        <span class="o">}});</span>
<span class="ln">10</span><span class="o">}</span>
</code></pre></div><p>registerService</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/core/java/android/app/SystemServiceRegistry.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">SYSTEM_SERVICE_NAMES</span> <span class="o">=</span>
<span class="ln"> 3</span>    <span class="k">new</span> <span class="n">ArrayMap</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;,</span> <span class="n">String</span><span class="o">&gt;();</span>
<span class="ln"> 4</span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">ServiceFetcher</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">SYSTEM_SERVICE_FETCHERS</span> <span class="o">=</span>
<span class="ln"> 5</span>    <span class="k">new</span> <span class="n">ArrayMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">ServiceFetcher</span><span class="o">&lt;?&gt;&gt;();</span>
<span class="ln"> 6</span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">SYSTEM_SERVICE_CLASS_NAMES</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayMap</span><span class="o">&lt;&gt;();</span>
<span class="ln"> 7</span>
<span class="ln"> 8</span><span class="kd">private</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="kt">void</span> <span class="nf">registerService</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">String</span> <span class="n">serviceName</span><span class="o">,</span>
<span class="ln"> 9</span>                                        <span class="nd">@NonNull</span> <span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">serviceClass</span><span class="o">,</span> <span class="nd">@NonNull</span> <span class="n">ServiceFetcher</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">serviceFetcher</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">10</span>    <span class="c1">//WindowManager.class和Context.WINDOW_SERVICE，组成kv的ArrayMap
</span><span class="ln">11</span><span class="c1"></span>    <span class="n">SYSTEM_SERVICE_NAMES</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">serviceClass</span><span class="o">,</span> <span class="n">serviceName</span><span class="o">);</span>
<span class="ln">12</span>    <span class="c1">//Context.WINDOW_SERVICE和Fetcher(CachedServiceFetcher)组成kv的ArrayMap
</span><span class="ln">13</span><span class="c1"></span>    <span class="n">SYSTEM_SERVICE_FETCHERS</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">serviceName</span><span class="o">,</span> <span class="n">serviceFetcher</span><span class="o">);</span>
<span class="ln">14</span>    <span class="c1">//Context.WINDOW_SERVICE和WindowManager，组成kv的ArrayMap
</span><span class="ln">15</span><span class="c1"></span>    <span class="n">SYSTEM_SERVICE_CLASS_NAMES</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">serviceName</span><span class="o">,</span> <span class="n">serviceClass</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">());</span>
<span class="ln">16</span><span class="o">}</span>
</code></pre></div><p>这里的<strong>mContext是ContextImpl类</strong>的对象</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln">1</span><span class="c1">//frameworks/base/core/java/android/app/ContextImpl.java
</span><span class="ln">2</span><span class="c1"></span><span class="nd">@Override</span>
<span class="ln">3</span><span class="kd">public</span> <span class="n">Object</span> <span class="nf">getSystemService</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">4</span>    <span class="o">...</span>
<span class="ln">5</span>    <span class="k">return</span> <span class="n">SystemServiceRegistry</span><span class="o">.</span><span class="na">getSystemService</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">name</span><span class="o">);</span>
<span class="ln">6</span><span class="o">}</span>
</code></pre></div><p>进入SystemServiceRegistry的getSystemService方法，<strong>name = Context.WINDOW_SERVICE</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln">1</span><span class="c1">//frameworks/base/core/java/android/app/SystemServiceRegistry.java
</span><span class="ln">2</span><span class="c1"></span><span class="kd">public</span> <span class="kd">static</span> <span class="n">Object</span> <span class="nf">getSystemService</span><span class="o">(</span><span class="n">ContextImpl</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">3</span>    <span class="o">...</span>
<span class="ln">4</span>    <span class="c1">//SYSTEM_SERVICE_FETCHERS是一个ArrayMap的集合
</span><span class="ln">5</span><span class="c1"></span>    <span class="kd">final</span> <span class="n">ServiceFetcher</span><span class="o">&lt;?&gt;</span> <span class="n">fetcher</span> <span class="o">=</span> <span class="n">SYSTEM_SERVICE_FETCHERS</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
<span class="ln">6</span>    <span class="o">...</span>
<span class="ln">7</span>    <span class="kd">final</span> <span class="n">Object</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">fetcher</span><span class="o">.</span><span class="na">getService</span><span class="o">(</span><span class="n">ctx</span><span class="o">);</span>
<span class="ln">8</span>    <span class="k">return</span> <span class="n">ret</span><span class="o">;</span>
<span class="ln">9</span><span class="o">}</span>
</code></pre></div><p>先通过<strong>Context.WINDOW_SERVICE</strong>找到对应的fetcher(上述的CachedServiceFetcher)，然后从fetcher中找出其对应的服务</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="kd">static</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">CachedServiceFetcher</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="n">ServiceFetcher</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
<span class="ln"> 2</span>    <span class="nd">@Override</span>
<span class="ln"> 3</span>    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;unchecked&#34;</span><span class="o">)</span>
<span class="ln"> 4</span>    <span class="kd">public</span> <span class="kd">final</span> <span class="n">T</span> <span class="nf">getService</span><span class="o">(</span><span class="n">ContextImpl</span> <span class="n">ctx</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 5</span>        <span class="o">...</span>
<span class="ln"> 6</span>        <span class="k">if</span> <span class="o">(</span><span class="n">doInitialize</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 7</span>            <span class="n">T</span> <span class="n">service</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="ln"> 8</span>            <span class="nd">@ServiceInitializationState</span> <span class="kt">int</span> <span class="n">newState</span> <span class="o">=</span> <span class="n">ContextImpl</span><span class="o">.</span><span class="na">STATE_NOT_FOUND</span><span class="o">;</span>
<span class="ln"> 9</span>            <span class="k">try</span> <span class="o">{</span>
<span class="ln">10</span>                <span class="n">service</span> <span class="o">=</span> <span class="n">createService</span><span class="o">(</span><span class="n">ctx</span><span class="o">);</span>
<span class="ln">11</span>                <span class="n">newState</span> <span class="o">=</span> <span class="n">ContextImpl</span><span class="o">.</span><span class="na">STATE_READY</span><span class="o">;</span>
<span class="ln">12</span>            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ServiceNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">13</span>                <span class="o">...</span>
<span class="ln">14</span>            <span class="o">}</span>
<span class="ln">15</span>            <span class="k">return</span> <span class="n">ret</span><span class="o">;</span>
<span class="ln">16</span>        <span class="o">}</span>
<span class="ln">17</span>    <span class="o">}</span>
<span class="ln">18</span>
<span class="ln">19</span>    <span class="kd">public</span> <span class="kd">abstract</span> <span class="n">T</span> <span class="nf">createService</span><span class="o">(</span><span class="n">ContextImpl</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ServiceNotFoundException</span><span class="o">;</span>
<span class="ln">20</span><span class="o">}</span>
</code></pre></div><p>最终回到上述的回调，即对应服务为<strong>WindowManagerImpl的实例</strong></p>
<h4 id="2514-createlocalwindowmanager">2.5.1.4 createLocalWindowManager</h4>
<p>这里也是创建了一个WindowManagerImpl，和前面getSystemService创建的WindowManagerImpl区别：这里传入了parentWindow，让WindowManagerImpl持有了Window的引用，<strong>这里持有的引用实际上是PhoneWindow</strong>，可以对此Window进行操作了。</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln">1</span><span class="c1">//frameworks/base/core/java/android/view/WindowManagerImpl.java
</span><span class="ln">2</span><span class="c1"></span><span class="kd">public</span> <span class="n">WindowManagerImpl</span> <span class="nf">createLocalWindowManager</span><span class="o">(</span><span class="n">Window</span> <span class="n">parentWindow</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">3</span>    <span class="k">return</span> <span class="k">new</span> <span class="n">WindowManagerImpl</span><span class="o">(</span><span class="n">mContext</span><span class="o">,</span> <span class="n">parentWindow</span><span class="o">,</span> <span class="n">mWindowContextToken</span><span class="o">);</span>
<span class="ln">4</span><span class="o">}</span>
</code></pre></div><h4 id="2515总结">2.5.1.5总结</h4>
<ol>
<li>new一个PhoneWindow对象并传入当前Activity引用，建立Window和Activity的一一对应关系。此Window是Window类的子类PhoneWindow的实例。Activity在Window中是以mContext属性存在。</li>
<li>调用PhoneWindow的setWindowManager方法，在这个方法中让Window和WindowManager建立了一一关系。此WindowManager是WindowManagerImpl的实例</li>
</ol>
<p><strong>UML类图</strong></p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window49.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window49.png" >
  
    </a>
  
  
</div>

<p><strong>流程图</strong></p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window50.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window50.png" >
  
    </a>
  
  
</div>

<h3 id="252window和view关联">2.5.2Window和View关联</h3>
<p>关于Window和View关联，详细可以阅读2.6.1关于activity的xml怎么跟屏幕关联起来的</p>
<p>这里主要梳理一下类图关系，App直接继承<strong>Activity</strong>和App继承<strong>AppCompatActivity</strong>流程类似，都是在DecorView内部操作的。</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window51.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window51.png" >
  
    </a>
  
  
</div>

<blockquote>
<p>简单概述：( <strong>Window和View进行关联</strong>)</p>
<ol>
<li>我们就给当前Activity的Window<strong>创建了一个DecorView</strong></li>
<li>这个DecorView就是当前Window的<strong>rootView</strong></li>
<li>并对rootView的ContentView设置了mContentParent 实现了将<strong>Window和DecorView</strong>绑定</li>
</ol>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/core/java/android/app/Activity.java
</span><span class="ln"> 2</span><span class="c1">//1.设置主题
</span><span class="ln"> 3</span><span class="c1"></span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTheme</span><span class="o">(</span><span class="kt">int</span> <span class="n">resid</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 4</span>    <span class="kd">super</span><span class="o">.</span><span class="na">setTheme</span><span class="o">(</span><span class="n">resid</span><span class="o">);</span>
<span class="ln"> 5</span>    <span class="n">mWindow</span><span class="o">.</span><span class="na">setTheme</span><span class="o">(</span><span class="n">resid</span><span class="o">);</span>
<span class="ln"> 6</span><span class="o">}</span>
<span class="ln"> 7</span><span class="c1">//2.设置Window属性等
</span><span class="ln"> 8</span><span class="c1"></span><span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">requestWindowFeature</span><span class="o">(</span><span class="kt">int</span> <span class="n">featureId</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 9</span>    <span class="k">return</span> <span class="n">getWindow</span><span class="o">().</span><span class="na">requestFeature</span><span class="o">(</span><span class="n">featureId</span><span class="o">);</span>
<span class="ln">10</span><span class="o">}</span>
<span class="ln">11</span>
<span class="ln">12</span><span class="c1">//3.获取Layout解析器
</span><span class="ln">13</span><span class="c1"></span><span class="kd">public</span> <span class="n">LayoutInflater</span> <span class="nf">getLayoutInflater</span><span class="o">()</span> <span class="o">{</span>
<span class="ln">14</span>    <span class="k">return</span> <span class="n">getWindow</span><span class="o">().</span><span class="na">getLayoutInflater</span><span class="o">();</span>
<span class="ln">15</span><span class="o">}</span>
</code></pre></div>

 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window52.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window52.png" >
  
    </a>
  
  
</div>

<p>可以发现Activity所有的对<strong>View进行的操作</strong>几乎都是通过<strong>Window</strong>进行的。而我们的Activity又是通过AMS来控制生命周期，所以AMS和View的通讯其实就是通过WindowManager这个介子进行的。</p>
<h3 id="253view上屏更新删除">2.5.3View上屏、更新、删除</h3>
<p>这里的代码比较多，比较还是以精简的方式来叙述，详细具体可以阅读参考文章</p>
<p>屏幕中所有的View首先需要经过<strong>WindowManager</strong>的处理，最后提交给<strong>WMS</strong>来处理。</p>
<p>WindowManager的父类为<strong>ViewManager</strong>（当然ViewManager也是GroupView的接口）</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln">1</span><span class="c1">//frameworks/base/core/java/android/view/ViewManager.java
</span><span class="ln">2</span><span class="c1"></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ViewManager</span><span class="o">{</span>
<span class="ln">3</span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addView</span><span class="o">(</span><span class="n">View</span> <span class="n">view</span><span class="o">,</span> <span class="n">ViewGroup</span><span class="o">.</span><span class="na">LayoutParams</span> <span class="n">params</span><span class="o">);</span>
<span class="ln">4</span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">updateViewLayout</span><span class="o">(</span><span class="n">View</span> <span class="n">view</span><span class="o">,</span> <span class="n">ViewGroup</span><span class="o">.</span><span class="na">LayoutParams</span> <span class="n">params</span><span class="o">);</span>
<span class="ln">5</span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">removeView</span><span class="o">(</span><span class="n">View</span> <span class="n">view</span><span class="o">);</span>
<span class="ln">6</span><span class="o">}</span>
</code></pre></div><p>而这几个方法具体实现是在WindowManagerImpl类中</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/core/java/android/view/WindowManagerImpl.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">WindowManagerImpl</span> <span class="kd">implements</span> <span class="n">WindowManager</span><span class="o">{</span>
<span class="ln"> 3</span>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">WindowManagerGlobal</span> <span class="n">mGlobal</span> <span class="o">=</span> <span class="n">WindowManagerGlobal</span><span class="o">.</span><span class="na">getInstance</span><span class="o">();</span>
<span class="ln"> 4</span>    <span class="nd">@Override</span>
<span class="ln"> 5</span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addView</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">View</span> <span class="n">view</span><span class="o">,</span> <span class="nd">@NonNull</span> <span class="n">ViewGroup</span><span class="o">.</span><span class="na">LayoutParams</span> <span class="n">params</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 6</span>        <span class="n">applyTokens</span><span class="o">(</span><span class="n">params</span><span class="o">);</span>
<span class="ln"> 7</span>        <span class="n">mGlobal</span><span class="o">.</span><span class="na">addView</span><span class="o">(</span><span class="n">view</span><span class="o">,</span> <span class="n">params</span><span class="o">,</span> <span class="n">mContext</span><span class="o">.</span><span class="na">getDisplayNoVerify</span><span class="o">(),</span> <span class="n">mParentWindow</span><span class="o">,</span>
<span class="ln"> 8</span>                <span class="n">mContext</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
<span class="ln"> 9</span>    <span class="o">}</span>
<span class="ln">10</span>
<span class="ln">11</span>    <span class="nd">@Override</span>
<span class="ln">12</span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">updateViewLayout</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">View</span> <span class="n">view</span><span class="o">,</span> <span class="nd">@NonNull</span> <span class="n">ViewGroup</span><span class="o">.</span><span class="na">LayoutParams</span> <span class="n">params</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">13</span>        <span class="n">applyTokens</span><span class="o">(</span><span class="n">params</span><span class="o">);</span>
<span class="ln">14</span>        <span class="n">mGlobal</span><span class="o">.</span><span class="na">updateViewLayout</span><span class="o">(</span><span class="n">view</span><span class="o">,</span> <span class="n">params</span><span class="o">);</span>
<span class="ln">15</span>    <span class="o">}</span>
<span class="ln">16</span>    <span class="nd">@Override</span>
<span class="ln">17</span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">removeView</span><span class="o">(</span><span class="n">View</span> <span class="n">view</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">18</span>        <span class="n">mGlobal</span><span class="o">.</span><span class="na">removeView</span><span class="o">(</span><span class="n">view</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
<span class="ln">19</span>    <span class="o">}</span>
<span class="ln">20</span>    <span class="o">...</span>
<span class="ln">21</span><span class="o">}</span>
</code></pre></div><h4 id="2531addview">2.5.3.1addView</h4>
<p>根据上面的流程，这里是以WindowManager实现的函数调用为例</p>
<h5 id="25311windowmanagerglobaladdview">2.5.3.1.1WindowManagerGlobal.addView</h5>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/core/java/android/view/WindowManagerGlobal.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">WindowManagerGlobal</span> <span class="o">{</span>
<span class="ln"> 3</span>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">View</span><span class="o">&gt;</span> <span class="n">mViews</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">View</span><span class="o">&gt;();</span>
<span class="ln"> 4</span>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">ViewRootImpl</span><span class="o">&gt;</span> <span class="n">mRoots</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">ViewRootImpl</span><span class="o">&gt;();</span>
<span class="ln"> 5</span>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">&gt;</span> <span class="n">mParams</span> <span class="o">=</span>
<span class="ln"> 6</span>            <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">&gt;();</span>
<span class="ln"> 7</span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addView</span><span class="o">(</span><span class="n">View</span> <span class="n">view</span><span class="o">,</span> <span class="n">ViewGroup</span><span class="o">.</span><span class="na">LayoutParams</span> <span class="n">params</span><span class="o">,</span>
<span class="ln"> 8</span>                        <span class="n">Display</span> <span class="n">display</span><span class="o">,</span> <span class="n">Window</span> <span class="n">parentWindow</span><span class="o">,</span> <span class="kt">int</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 9</span>        <span class="o">...</span>
<span class="ln">10</span>        <span class="c1">//将params强转为WindowManager.LayoutParams类型
</span><span class="ln">11</span><span class="c1"></span>        <span class="kd">final</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span> <span class="n">wparams</span> <span class="o">=</span> <span class="o">(</span><span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">)</span> <span class="n">params</span><span class="o">;</span>
<span class="ln">12</span>        <span class="o">...</span>
<span class="ln">13</span>        <span class="n">ViewRootImpl</span> <span class="n">root</span><span class="o">;</span>
<span class="ln">14</span>        <span class="n">View</span> <span class="n">panelParentView</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="ln">15</span>
<span class="ln">16</span>        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mLock</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">17</span>            <span class="o">...</span>
<span class="ln">18</span>            <span class="n">IWindowSession</span> <span class="n">windowlessSession</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="ln">19</span>            <span class="c1">// 如果有一个父集，但是我们找不到它，它可能来自一个SurfaceControlViewHost层次结构
</span><span class="ln">20</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">wparams</span><span class="o">.</span><span class="na">token</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">panelParentView</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">21</span>                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mWindowlessRoots</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
<span class="ln">22</span>                    <span class="n">ViewRootImpl</span> <span class="n">maybeParent</span> <span class="o">=</span> <span class="n">mWindowlessRoots</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
<span class="ln">23</span>                    <span class="k">if</span> <span class="o">(</span><span class="n">maybeParent</span><span class="o">.</span><span class="na">getWindowToken</span><span class="o">()</span> <span class="o">==</span> <span class="n">wparams</span><span class="o">.</span><span class="na">token</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">24</span>                        <span class="n">windowlessSession</span> <span class="o">=</span> <span class="n">maybeParent</span><span class="o">.</span><span class="na">getWindowSession</span><span class="o">();</span>
<span class="ln">25</span>                        <span class="k">break</span><span class="o">;</span>
<span class="ln">26</span>                    <span class="o">}</span>
<span class="ln">27</span>                <span class="o">}</span>
<span class="ln">28</span>            <span class="o">}</span>
<span class="ln">29</span>
<span class="ln">30</span>            <span class="k">if</span> <span class="o">(</span><span class="n">windowlessSession</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">31</span>                <span class="c1">//创建一个ViewRootImpl对象
</span><span class="ln">32</span><span class="c1"></span>                <span class="n">root</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ViewRootImpl</span><span class="o">(</span><span class="n">view</span><span class="o">.</span><span class="na">getContext</span><span class="o">(),</span> <span class="n">display</span><span class="o">);</span>
<span class="ln">33</span>            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="ln">34</span>                <span class="n">root</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ViewRootImpl</span><span class="o">(</span><span class="n">view</span><span class="o">.</span><span class="na">getContext</span><span class="o">(),</span> <span class="n">display</span><span class="o">,</span>
<span class="ln">35</span>                                        <span class="n">windowlessSession</span><span class="o">,</span> <span class="k">new</span> <span class="n">WindowlessWindowLayout</span><span class="o">());</span>
<span class="ln">36</span>            <span class="o">}</span>
<span class="ln">37</span>
<span class="ln">38</span>            <span class="n">view</span><span class="o">.</span><span class="na">setLayoutParams</span><span class="o">(</span><span class="n">wparams</span><span class="o">);</span>
<span class="ln">39</span>			<span class="c1">//存储view到mViews列表,存储root到mRoots列表,存储wparams到mParams列表
</span><span class="ln">40</span><span class="c1"></span>            <span class="n">mViews</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">view</span><span class="o">);</span>
<span class="ln">41</span>            <span class="n">mRoots</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">root</span><span class="o">);</span>
<span class="ln">42</span>            <span class="n">mParams</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">wparams</span><span class="o">);</span>
<span class="ln">43</span>
<span class="ln">44</span>            <span class="c1">// do this last because it fires off messages to start doing things
</span><span class="ln">45</span><span class="c1"></span>            <span class="k">try</span> <span class="o">{</span>
<span class="ln">46</span>                <span class="c1">//这里的root是ViewRootImpl
</span><span class="ln">47</span><span class="c1"></span>                <span class="n">root</span><span class="o">.</span><span class="na">setView</span><span class="o">(</span><span class="n">view</span><span class="o">,</span> <span class="n">wparams</span><span class="o">,</span> <span class="n">panelParentView</span><span class="o">,</span> <span class="n">userId</span><span class="o">);</span>
<span class="ln">48</span>            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RuntimeException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">49</span>                <span class="kd">final</span> <span class="kt">int</span> <span class="n">viewIndex</span> <span class="o">=</span> <span class="o">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">)</span> <span class="o">?</span> <span class="n">index</span> <span class="o">:</span> <span class="o">(</span><span class="n">mViews</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="n">1</span><span class="o">);</span>
<span class="ln">50</span>                <span class="c1">// BadTokenException or InvalidDisplayException, clean up.
</span><span class="ln">51</span><span class="c1"></span>                <span class="k">if</span> <span class="o">(</span><span class="n">viewIndex</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">52</span>                    <span class="n">removeViewLocked</span><span class="o">(</span><span class="n">viewIndex</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
<span class="ln">53</span>                <span class="o">}</span>
<span class="ln">54</span>                <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
<span class="ln">55</span>            <span class="o">}</span>
<span class="ln">56</span>        <span class="o">}</span>
<span class="ln">57</span>    <span class="o">}</span>   
<span class="ln">58</span><span class="o">}</span>
</code></pre></div><ul>
<li>将params强转为WindowManager.LayoutParams类型</li>
<li>创建一个ViewRootImpl对象root。</li>
<li>然后将当前view，当前params以及1中创建的ViewRootImpl对象root分别存储到对应的List列表中</li>
<li>调用root的setView方法</li>
</ul>
<h5 id="25312viewrootimplsetview">2.5.3.1.2ViewRootImpl.setView</h5>
<p>ViewRootImpl有很多作用</p>
<ol>
<li><strong>管理View树，且其是View的根</strong></li>
<li><strong>触发三大绘制流程：测量，布局，绘制</strong></li>
<li><strong>输入事件中转站</strong></li>
<li><strong>管理Surface</strong></li>
<li><strong>负责与WMS通讯</strong></li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/core/java/android/view/ViewRootImpl.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">final</span> <span class="n">IWindowSession</span> <span class="n">mWindowSession</span><span class="o">;</span>
<span class="ln"> 3</span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">setView</span><span class="o">(</span><span class="n">View</span> <span class="n">view</span><span class="o">,</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span> <span class="n">attrs</span><span class="o">,</span> <span class="n">View</span> <span class="n">panelParentView</span><span class="o">,</span>
<span class="ln"> 4</span>                    <span class="kt">int</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 5</span>    <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 6</span>        <span class="k">if</span> <span class="o">(</span><span class="n">mView</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 7</span>            <span class="n">mView</span> <span class="o">=</span> <span class="n">view</span><span class="o">;</span>
<span class="ln"> 8</span>            <span class="c1">// 在添加到窗口管理器之前安排第一个布局，以确保我们在从系统接收任何其他事件之前执行布局。
</span><span class="ln"> 9</span><span class="c1"></span>            <span class="n">requestLayout</span><span class="o">();</span>
<span class="ln">10</span>            <span class="o">...</span>
<span class="ln">11</span>            <span class="k">try</span> <span class="o">{</span>
<span class="ln">12</span>                <span class="n">res</span> <span class="o">=</span> <span class="n">mWindowSession</span><span class="o">.</span><span class="na">addToDisplayAsUser</span><span class="o">(</span><span class="n">mWindow</span><span class="o">,</span> <span class="n">mWindowAttributes</span><span class="o">,</span>
<span class="ln">13</span>                                                        <span class="n">getHostVisibility</span><span class="o">(),</span> <span class="n">mDisplay</span><span class="o">.</span><span class="na">getDisplayId</span><span class="o">(),</span>
<span class="ln">14</span>                                                        <span class="n">userId</span><span class="o">,</span><span class="n">mInsetsController</span><span class="o">.</span><span class="na">getRequestedVisibilities</span><span class="o">(),</span> 
<span class="ln">15</span>                                                        <span class="n">inputChannel</span><span class="o">,</span> <span class="n">mTempInsets</span><span class="o">,</span><span class="n">mTempControls</span><span class="o">,</span>
<span class="ln">16</span>                                                        <span class="n">attachedFrame</span><span class="o">,</span> <span class="n">compatScale</span><span class="o">);</span>
<span class="ln">17</span>
<span class="ln">18</span>        <span class="o">}</span>
<span class="ln">19</span>    <span class="o">}</span>
<span class="ln">20</span><span class="o">}</span>
</code></pre></div><p>这里主要是requestLayout方法和addToDisplayAsUser方法。</p>
<p>前者方法是屏幕绘制部分，这里不展开说明，主要为requestLayout内部主要使用垂直同步信号VSync的方式，在收到GPU提供的VSync信号后，会触发View的三大绘制<strong>layout</strong>，<strong>mesure</strong>，<strong>draw</strong>流程。</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window54.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window54.png" >
  
    </a>
  
  
</div>

<h5 id="25313mwindowsessionaddtodisplayasuser">2.5.3.1.3mWindowSession.addToDisplayAsUser</h5>
<p>后面是addToDisplayAsUser方法。mWindowSession是IWindowSession类型的</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/core/java/android/view/ViewRootImpl.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">final</span> <span class="n">IWindowSession</span> <span class="n">mWindowSession</span><span class="o">;</span>
<span class="ln"> 3</span><span class="kd">public</span> <span class="nf">ViewRootImpl</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">Display</span> <span class="n">display</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 4</span>    <span class="k">this</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">display</span><span class="o">,</span> <span class="n">WindowManagerGlobal</span><span class="o">.</span><span class="na">getWindowSession</span><span class="o">(),</span> <span class="k">new</span> <span class="n">WindowLayout</span><span class="o">());</span>
<span class="ln"> 5</span><span class="o">}</span>
<span class="ln"> 6</span>
<span class="ln"> 7</span><span class="kd">public</span> <span class="nf">ViewRootImpl</span><span class="o">(</span><span class="nd">@UiContext</span> <span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">Display</span> <span class="n">display</span><span class="o">,</span> <span class="n">IWindowSession</span> <span class="n">session</span><span class="o">,</span>
<span class="ln"> 8</span>                    <span class="n">WindowLayout</span> <span class="n">windowLayout</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 9</span>    <span class="n">mContext</span> <span class="o">=</span> <span class="n">context</span><span class="o">;</span>
<span class="ln">10</span>    <span class="n">mWindowSession</span> <span class="o">=</span> <span class="n">session</span><span class="o">;</span>
<span class="ln">11</span>    <span class="o">...</span>
<span class="ln">12</span><span class="o">}</span>
</code></pre></div><p>可以看到mWindowSession实际上是是一个binder对象，用于进程间通讯，IWindowSession是C端代理，在S端使用的是Session类实现</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/core/java/android/view/WindowManagerGlobal.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">public</span> <span class="kd">static</span> <span class="n">IWindowSession</span> <span class="nf">getWindowSession</span><span class="o">()</span> <span class="o">{</span>
<span class="ln"> 3</span>    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">WindowManagerGlobal</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 4</span>        <span class="k">if</span> <span class="o">(</span><span class="n">sWindowSession</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 5</span>            <span class="k">try</span> <span class="o">{</span>
<span class="ln"> 6</span>                <span class="n">InputMethodManager</span><span class="o">.</span><span class="na">ensureDefaultInstanceForDefaultDisplayIfNecessary</span><span class="o">();</span>
<span class="ln"> 7</span>                <span class="c1">//这里获取的是WindowManagerService的服务的代理类
</span><span class="ln"> 8</span><span class="c1"></span>                <span class="n">IWindowManager</span> <span class="n">windowManager</span> <span class="o">=</span> <span class="n">getWindowManagerService</span><span class="o">();</span>
<span class="ln"> 9</span>                <span class="c1">//真正获取到sWindowSession的对象代理类
</span><span class="ln">10</span><span class="c1"></span>                <span class="n">sWindowSession</span> <span class="o">=</span> <span class="n">windowManager</span><span class="o">.</span><span class="na">openSession</span><span class="o">(</span>
<span class="ln">11</span>                    <span class="k">new</span> <span class="n">IWindowSessionCallback</span><span class="o">.</span><span class="na">Stub</span><span class="o">()</span> <span class="o">{</span>
<span class="ln">12</span>                        <span class="nd">@Override</span>
<span class="ln">13</span>                        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onAnimatorScaleChanged</span><span class="o">(</span><span class="kt">float</span> <span class="n">scale</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">14</span>                            <span class="n">ValueAnimator</span><span class="o">.</span><span class="na">setDurationScale</span><span class="o">(</span><span class="n">scale</span><span class="o">);</span>
<span class="ln">15</span>                        <span class="o">}</span>
<span class="ln">16</span>                    <span class="o">});</span>
<span class="ln">17</span>            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">18</span>                <span class="k">throw</span> <span class="n">e</span><span class="o">.</span><span class="na">rethrowFromSystemServer</span><span class="o">();</span>
<span class="ln">19</span>            <span class="o">}</span>
<span class="ln">20</span>        <span class="o">}</span>
<span class="ln">21</span>        <span class="k">return</span> <span class="n">sWindowSession</span><span class="o">;</span>
<span class="ln">22</span>    <span class="o">}</span>
<span class="ln">23</span><span class="o">}</span>
<span class="ln">24</span>
<span class="ln">25</span><span class="kd">public</span> <span class="kd">static</span> <span class="n">IWindowManager</span> <span class="nf">getWindowManagerService</span><span class="o">()</span> <span class="o">{</span>
<span class="ln">26</span>    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">WindowManagerGlobal</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">27</span>        <span class="k">if</span> <span class="o">(</span><span class="n">sWindowManagerService</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">28</span>            <span class="n">sWindowManagerService</span> <span class="o">=</span> <span class="n">IWindowManager</span><span class="o">.</span><span class="na">Stub</span><span class="o">.</span><span class="na">asInterface</span><span class="o">(</span>
<span class="ln">29</span>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">getService</span><span class="o">(</span><span class="s">&#34;window&#34;</span><span class="o">));</span>
<span class="ln">30</span>                <span class="o">...</span>
<span class="ln">31</span>        <span class="o">}</span>
<span class="ln">32</span>        <span class="k">return</span> <span class="n">sWindowManagerService</span><span class="o">;</span>
<span class="ln">33</span>    <span class="o">}</span>
<span class="ln">34</span><span class="o">}</span>
</code></pre></div><p>openSession</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln">1</span><span class="c1">//frameworks/base/services/core/java/com/android/server/wm/WindowManagerService.java
</span><span class="ln">2</span><span class="c1"></span><span class="kd">public</span> <span class="n">IWindowSession</span> <span class="nf">openSession</span><span class="o">(</span><span class="n">IWindowSessionCallback</span> <span class="n">callback</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">3</span>    <span class="k">return</span> <span class="k">new</span> <span class="n">Session</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">callback</span><span class="o">);</span>
<span class="ln">4</span><span class="o">}</span>
</code></pre></div><p>调用的Session的构造，并将回调监听也加入</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/services/core/java/com/android/server/wm/Session.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">class</span> <span class="nc">Session</span> <span class="kd">extends</span> <span class="n">IWindowSession</span><span class="o">.</span><span class="na">Stub</span> <span class="kd">implements</span> <span class="n">IBinder</span><span class="o">.</span><span class="na">DeathRecipient</span> <span class="o">{</span>
<span class="ln"> 3</span>    <span class="kd">final</span> <span class="n">WindowManagerService</span> <span class="n">mService</span><span class="o">;</span>
<span class="ln"> 4</span>
<span class="ln"> 5</span>    <span class="kd">public</span> <span class="nf">Session</span><span class="o">(</span><span class="n">WindowManagerService</span> <span class="n">service</span><span class="o">,</span> <span class="n">IWindowSessionCallback</span> <span class="n">callback</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 6</span>        <span class="n">mService</span> <span class="o">=</span> <span class="n">service</span><span class="o">;</span>
<span class="ln"> 7</span>        <span class="n">mCallback</span> <span class="o">=</span> <span class="n">callback</span><span class="o">;</span>
<span class="ln"> 8</span>        <span class="o">...</span>
<span class="ln"> 9</span>    <span class="o">}</span>
<span class="ln">10</span>
<span class="ln">11</span>    <span class="nd">@Override</span>
<span class="ln">12</span>    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">addToDisplayAsUser</span><span class="o">(</span><span class="n">IWindow</span> <span class="n">window</span><span class="o">,</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span> <span class="n">attrs</span><span class="o">,</span>
<span class="ln">13</span>            <span class="kt">int</span> <span class="n">viewVisibility</span><span class="o">,</span> <span class="kt">int</span> <span class="n">displayId</span><span class="o">,</span> <span class="kt">int</span> <span class="n">userId</span><span class="o">,</span> <span class="n">InsetsVisibilities</span> <span class="n">requestedVisibilities</span><span class="o">,</span>
<span class="ln">14</span>            <span class="n">InputChannel</span> <span class="n">outInputChannel</span><span class="o">,</span> <span class="n">InsetsState</span> <span class="n">outInsetsState</span><span class="o">,</span>
<span class="ln">15</span>            <span class="n">InsetsSourceControl</span><span class="o">[]</span> <span class="n">outActiveControls</span><span class="o">,</span> <span class="n">Rect</span> <span class="n">outAttachedFrame</span><span class="o">,</span>
<span class="ln">16</span>            <span class="kt">float</span><span class="o">[]</span> <span class="n">outSizeCompatScale</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">17</span>        <span class="c1">//这里的mService就是构造注入的wms的this指针
</span><span class="ln">18</span><span class="c1"></span>        <span class="k">return</span> <span class="n">mService</span><span class="o">.</span><span class="na">addWindow</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">window</span><span class="o">,</span> <span class="n">attrs</span><span class="o">,</span> <span class="n">viewVisibility</span><span class="o">,</span> <span class="n">displayId</span><span class="o">,</span> <span class="n">userId</span><span class="o">,</span>
<span class="ln">19</span>                <span class="n">requestedVisibilities</span><span class="o">,</span> <span class="n">outInputChannel</span><span class="o">,</span> <span class="n">outInsetsState</span><span class="o">,</span> <span class="n">outActiveControls</span><span class="o">,</span>
<span class="ln">20</span>                <span class="n">outAttachedFrame</span><span class="o">,</span> <span class="n">outSizeCompatScale</span><span class="o">);</span>
<span class="ln">21</span>    <span class="o">}</span>
<span class="ln">22</span><span class="o">}</span>
</code></pre></div><h5 id="25314mserviceaddwindow">2.5.3.1.4mService.addWindow</h5>
<p>所以之前的Session类的addToDisplayAsUser方法，会调用addWindow方法，根据前面学习的Window容器，可以知道这里实际上Window容器添加到添加上去。（需要明白一点，先前的View绘制三部曲，<strong>测量，布局，绘制</strong>完成后，需要后续的图像的合成和显示）</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window55.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window55.png" >
  
    </a>
  
  
</div>

<p>在WMS眼里，<strong>一切View都是以Window形式</strong>存在的， 剩下的工作就交由WMS进行处理了：在WMS中会为这个Window分配Surface，并确定显示层级， 可见负责显示界面的是画布Surface，而不是窗口本身，WMS将他管理的Surface交由SurfaceFlinger处理，SurfaceFlinger将这些Surface合并后放入到buffer中，屏幕会定时从buffer中获取显示数据，显示到屏幕上。</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window56.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window56.png" >
  
    </a>
  
  
</div>

<p>查看源码addWindow，这里正好和上面的Window层级联系上了</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/services/core/java/com/android/server/wm/WindowManagerService.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">final</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">IBinder</span><span class="o">,</span> <span class="n">WindowState</span><span class="o">&gt;</span> <span class="n">mWindowMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
<span class="ln"> 3</span>
<span class="ln"> 4</span><span class="kd">public</span> <span class="kt">int</span> <span class="nf">addWindow</span><span class="o">(</span><span class="n">Session</span> <span class="n">session</span><span class="o">,</span> <span class="n">IWindow</span> <span class="n">client</span><span class="o">,</span> <span class="n">LayoutParams</span> <span class="n">attrs</span><span class="o">,</span> <span class="kt">int</span> <span class="n">viewVisibility</span><span class="o">,</span>
<span class="ln"> 5</span>                     <span class="kt">int</span> <span class="n">displayId</span><span class="o">,</span> <span class="kt">int</span> <span class="n">requestUserId</span><span class="o">,</span> <span class="n">InsetsVisibilities</span> <span class="n">requestedVisibilities</span><span class="o">,</span>
<span class="ln"> 6</span>                     <span class="n">InputChannel</span> <span class="n">outInputChannel</span><span class="o">,</span> <span class="n">InsetsState</span> <span class="n">outInsetsState</span><span class="o">,</span>
<span class="ln"> 7</span>                     <span class="n">InsetsSourceControl</span><span class="o">[]</span> <span class="n">outActiveControls</span><span class="o">,</span> <span class="n">Rect</span> <span class="n">outAttachedFrame</span><span class="o">,</span>
<span class="ln"> 8</span>                     <span class="kt">float</span><span class="o">[]</span> <span class="n">outSizeCompatScale</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 9</span>   
<span class="ln">10</span>
<span class="ln">11</span>    <span class="n">WindowState</span> <span class="n">parentWindow</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="ln">12</span>    <span class="o">...</span>
<span class="ln">13</span>    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mGlobalLock</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">14</span>        <span class="kd">final</span> <span class="n">DisplayContent</span> <span class="n">displayContent</span> <span class="o">=</span> <span class="n">getDisplayContentOrCreate</span><span class="o">(</span><span class="n">displayId</span><span class="o">,</span> <span class="n">attrs</span><span class="o">.</span><span class="na">token</span><span class="o">);</span>
<span class="ln">15</span>
<span class="ln">16</span>		<span class="c1">//type类型获取
</span><span class="ln">17</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">type</span> <span class="o">&gt;=</span> <span class="n">FIRST_SUB_WINDOW</span> <span class="o">&amp;&amp;</span> <span class="n">type</span> <span class="o">&lt;=</span> <span class="n">LAST_SUB_WINDOW</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">18</span>            <span class="n">parentWindow</span> <span class="o">=</span> <span class="n">windowForClientLocked</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">attrs</span><span class="o">.</span><span class="na">token</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
<span class="ln">19</span>            <span class="k">if</span> <span class="o">(</span><span class="n">parentWindow</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">20</span>                <span class="k">return</span> <span class="n">WindowManagerGlobal</span><span class="o">.</span><span class="na">ADD_BAD_SUBWINDOW_TOKEN</span><span class="o">;</span>
<span class="ln">21</span>            <span class="o">}</span>
<span class="ln">22</span>            <span class="k">if</span> <span class="o">(</span><span class="n">parentWindow</span><span class="o">.</span><span class="na">mAttrs</span><span class="o">.</span><span class="na">type</span> <span class="o">&gt;=</span> <span class="n">FIRST_SUB_WINDOW</span>
<span class="ln">23</span>                <span class="o">&amp;&amp;</span> <span class="n">parentWindow</span><span class="o">.</span><span class="na">mAttrs</span><span class="o">.</span><span class="na">type</span> <span class="o">&lt;=</span> <span class="n">LAST_SUB_WINDOW</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">24</span>                <span class="k">return</span> <span class="n">WindowManagerGlobal</span><span class="o">.</span><span class="na">ADD_BAD_SUBWINDOW_TOKEN</span><span class="o">;</span>
<span class="ln">25</span>            <span class="o">}</span>
<span class="ln">26</span>        <span class="o">}</span>
<span class="ln">27</span>
<span class="ln">28</span>        <span class="k">if</span> <span class="o">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">TYPE_PRIVATE_PRESENTATION</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">displayContent</span><span class="o">.</span><span class="na">isPrivate</span><span class="o">())</span> <span class="o">{</span>
<span class="ln">29</span>            <span class="k">return</span> <span class="n">WindowManagerGlobal</span><span class="o">.</span><span class="na">ADD_PERMISSION_DENIED</span><span class="o">;</span>
<span class="ln">30</span>        <span class="o">}</span>
<span class="ln">31</span>
<span class="ln">32</span>        <span class="k">if</span> <span class="o">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">TYPE_PRESENTATION</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">displayContent</span><span class="o">.</span><span class="na">getDisplay</span><span class="o">().</span><span class="na">isPublicPresentation</span><span class="o">())</span> <span class="o">{</span>
<span class="ln">33</span>            <span class="k">return</span> <span class="n">WindowManagerGlobal</span><span class="o">.</span><span class="na">ADD_INVALID_DISPLAY</span><span class="o">;</span>
<span class="ln">34</span>        <span class="o">}</span>
<span class="ln">35</span>		<span class="c1">//token获取
</span><span class="ln">36</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">token</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">37</span>            <span class="k">if</span> <span class="o">(</span><span class="n">hasParent</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">38</span>                <span class="c1">// Use existing parent window token for child windows.
</span><span class="ln">39</span><span class="c1"></span>                <span class="n">token</span> <span class="o">=</span> <span class="n">parentWindow</span><span class="o">.</span><span class="na">mToken</span><span class="o">;</span>
<span class="ln">40</span>            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">mWindowContextListenerController</span><span class="o">.</span><span class="na">hasListener</span><span class="o">(</span><span class="n">windowContextToken</span><span class="o">))</span> <span class="o">{</span>
<span class="ln">41</span>                <span class="c1">// Respect the window context token if the user provided it.
</span><span class="ln">42</span><span class="c1"></span>                <span class="kd">final</span> <span class="n">IBinder</span> <span class="n">binder</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="na">token</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">attrs</span><span class="o">.</span><span class="na">token</span> <span class="o">:</span> <span class="n">windowContextToken</span><span class="o">;</span>
<span class="ln">43</span>                <span class="kd">final</span> <span class="n">Bundle</span> <span class="n">options</span> <span class="o">=</span> <span class="n">mWindowContextListenerController</span>
<span class="ln">44</span>                    <span class="o">.</span><span class="na">getOptions</span><span class="o">(</span><span class="n">windowContextToken</span><span class="o">);</span>
<span class="ln">45</span>                <span class="n">token</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WindowToken</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">binder</span><span class="o">,</span> <span class="n">type</span><span class="o">)</span>
<span class="ln">46</span>                    <span class="o">.</span><span class="na">setDisplayContent</span><span class="o">(</span><span class="n">displayContent</span><span class="o">)</span>
<span class="ln">47</span>                    <span class="o">.</span><span class="na">setOwnerCanManageAppTokens</span><span class="o">(</span><span class="n">session</span><span class="o">.</span><span class="na">mCanAddInternalSystemWindow</span><span class="o">)</span>
<span class="ln">48</span>                    <span class="o">.</span><span class="na">setRoundedCornerOverlay</span><span class="o">(</span><span class="n">isRoundedCornerOverlay</span><span class="o">)</span>
<span class="ln">49</span>                    <span class="o">.</span><span class="na">setFromClientToken</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
<span class="ln">50</span>                    <span class="o">.</span><span class="na">setOptions</span><span class="o">(</span><span class="n">options</span><span class="o">)</span>
<span class="ln">51</span>                    <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="ln">52</span>            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="ln">53</span>                <span class="kd">final</span> <span class="n">IBinder</span> <span class="n">binder</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="na">token</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">attrs</span><span class="o">.</span><span class="na">token</span> <span class="o">:</span> <span class="n">client</span><span class="o">.</span><span class="na">asBinder</span><span class="o">();</span>
<span class="ln">54</span>                <span class="n">token</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WindowToken</span><span class="o">.</span><span class="na">Builder</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">binder</span><span class="o">,</span> <span class="n">type</span><span class="o">)</span>
<span class="ln">55</span>                    <span class="o">.</span><span class="na">setDisplayContent</span><span class="o">(</span><span class="n">displayContent</span><span class="o">)</span>
<span class="ln">56</span>                    <span class="o">.</span><span class="na">setOwnerCanManageAppTokens</span><span class="o">(</span><span class="n">session</span><span class="o">.</span><span class="na">mCanAddInternalSystemWindow</span><span class="o">)</span>
<span class="ln">57</span>                    <span class="o">.</span><span class="na">setRoundedCornerOverlay</span><span class="o">(</span><span class="n">isRoundedCornerOverlay</span><span class="o">)</span>
<span class="ln">58</span>                    <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="ln">59</span>            <span class="o">}</span>
<span class="ln">60</span>        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">rootType</span> <span class="o">&gt;=</span> <span class="n">FIRST_APPLICATION_WINDOW</span>
<span class="ln">61</span>                   <span class="o">&amp;&amp;</span> <span class="n">rootType</span> <span class="o">&lt;=</span> <span class="n">LAST_APPLICATION_WINDOW</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">62</span>            <span class="c1">//token获取
</span><span class="ln">63</span><span class="c1"></span>        <span class="o">}</span>
<span class="ln">64</span>		<span class="c1">//[2.5.3.1.5]
</span><span class="ln">65</span><span class="c1"></span>        <span class="kd">final</span> <span class="n">WindowState</span> <span class="n">win</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WindowState</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">session</span><span class="o">,</span> <span class="n">client</span><span class="o">,</span> <span class="n">token</span><span class="o">,</span> <span class="n">parentWindow</span><span class="o">,</span>
<span class="ln">66</span>                                                <span class="n">appOp</span><span class="o">[</span><span class="n">0</span><span class="o">],</span> <span class="n">attrs</span><span class="o">,</span> <span class="n">viewVisibility</span><span class="o">,</span> <span class="n">session</span><span class="o">.</span><span class="na">mUid</span><span class="o">,</span> <span class="n">userId</span><span class="o">,</span>
<span class="ln">67</span>                                                <span class="n">session</span><span class="o">.</span><span class="na">mCanAddInternalSystemWindow</span><span class="o">);</span>
<span class="ln">68</span>        <span class="c1">// 这里筛选子窗口类型，因为子窗口必须附加到父窗口，子窗口的Token和父窗口一致
</span><span class="ln">69</span><span class="c1"></span>        <span class="c1">//[2.5.3.1.6]
</span><span class="ln">70</span><span class="c1"></span>        <span class="n">win</span><span class="o">.</span><span class="na">mToken</span><span class="o">.</span><span class="na">addWindow</span><span class="o">(</span><span class="n">win</span><span class="o">);</span>
<span class="ln">71</span>        <span class="o">...</span>
<span class="ln">72</span>    <span class="o">}</span>
<span class="ln">73</span>
<span class="ln">74</span>    <span class="n">Binder</span><span class="o">.</span><span class="na">restoreCallingIdentity</span><span class="o">(</span><span class="n">origId</span><span class="o">);</span>
<span class="ln">75</span>
<span class="ln">76</span>    <span class="k">return</span> <span class="n">res</span><span class="o">;</span>
<span class="ln">77</span><span class="o">}</span>
</code></pre></div><p>流程比较复杂</p>
<ol>
<li>
<p>通过 WindowManagerPolicy 的 checkAddPermission 检查添加权限</p>
</li>
<li>
<p>通过 displayId 获取所添加到的屏幕抽象 DisplayContent 对象</p>
</li>
<li>
<p>根据 Window 是否是子窗口，创建 WindowToken</p>
</li>
<li>
<p>如果上一步创建 token 失败，重新根据是否存在父窗口创建 WindowToken</p>
</li>
<li>
<ol>
<li>子窗口直接取父窗口的 WindowToken</li>
<li>新的窗口直接构造一个新的 WindowToken</li>
</ol>
</li>
<li>
<p>根据根窗口的 type 来处理不同的情况（Toast、键盘、无障碍浮层等不同类型返回不同的结果）</p>
</li>
<li>
<p><strong>创建 WindowState</strong></p>
</li>
<li>
<p>检查客户端状态，判断是否可以将 <strong>Window 添加到系统中</strong></p>
</li>
<li>
<p>以 session 为 key ，windowState 为 value ，存入到 mWindowMap 中</p>
</li>
<li>
<p>将 WindowState 添加到相应的 WindowToken 中</p>
<ol>
<li>若 WindowState 代表一个子窗口，直接 return</li>
<li>若仍没有 SurfaceControl ，为该 token 创建 Surface</li>
<li>更新 Layer</li>
<li>根据 Z 轴排序顺序将 WindowState 所代表的 Window 添加到合适的位置，此数据结构保存在 WindowToken 的父类 WindowContainer 的 mChildren 中：</li>
</ol>
</li>
<li>
<p>检查是否需要转换动画</p>
</li>
<li>
<p>更新窗口焦点</p>
</li>
<li>
<p>最后返回执行结果</p>
</li>
</ol>
<p>最重要的就是[2.5.3.1.5]和[2.5.3.1.6]的操作，也是添加Window过程中Window容器之间的添加。</p>
<p>笔者这里之阐述跟Window容器相关的流程，关于<strong>WMS中的Surface，还有Input流程</strong>等需要到具体WMS章节阅读，可以点击<a href="https://juejin.cn/post/7172598258064162830">这里</a>。</p>
<h5 id="25315windowstate">2.5.3.1.5WindowState</h5>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/services/core/java/com/android/server/wm/WindowState.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">class</span> <span class="nc">WindowState</span> <span class="kd">extends</span> <span class="n">WindowContainer</span><span class="o">&lt;</span><span class="n">WindowState</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="n">WindowManagerPolicy</span><span class="o">.</span><span class="na">WindowState</span><span class="o">,</span>
<span class="ln"> 3</span><span class="n">InsetsControlTarget</span><span class="o">,</span> <span class="n">InputTarget</span> <span class="o">{</span>
<span class="ln"> 4</span>    <span class="n">WindowState</span><span class="o">(</span><span class="n">WindowManagerService</span> <span class="n">service</span><span class="o">,</span> <span class="n">Session</span> <span class="n">s</span><span class="o">,</span> <span class="n">IWindow</span> <span class="n">c</span><span class="o">,</span> <span class="n">WindowToken</span> <span class="n">token</span><span class="o">,</span>
<span class="ln"> 5</span>                <span class="n">WindowState</span> <span class="n">parentWindow</span><span class="o">,</span> <span class="kt">int</span> <span class="n">appOp</span><span class="o">,</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span> <span class="n">a</span><span class="o">,</span> <span class="kt">int</span> <span class="n">viewVisibility</span><span class="o">,</span>
<span class="ln"> 6</span>                <span class="kt">int</span> <span class="n">ownerId</span><span class="o">,</span> <span class="kt">int</span> <span class="n">showUserId</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">ownerCanAddInternalSystemWindow</span><span class="o">,</span>
<span class="ln"> 7</span>                <span class="n">PowerManagerWrapper</span> <span class="n">powerManagerWrapper</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 8</span>        <span class="c1">//下面这些信息都会通过dumpsys window windows出现
</span><span class="ln"> 9</span><span class="c1"></span>        <span class="kd">super</span><span class="o">(</span><span class="n">service</span><span class="o">);</span>
<span class="ln">10</span>        <span class="n">mSession</span> <span class="o">=</span> <span class="n">s</span><span class="o">;</span>
<span class="ln">11</span>        <span class="n">mClient</span> <span class="o">=</span> <span class="n">c</span><span class="o">;</span>
<span class="ln">12</span>        <span class="n">mAppOp</span> <span class="o">=</span> <span class="n">appOp</span><span class="o">;</span>
<span class="ln">13</span>        <span class="n">mToken</span> <span class="o">=</span> <span class="n">token</span><span class="o">;</span>
<span class="ln">14</span>        <span class="n">mActivityRecord</span> <span class="o">=</span> <span class="n">mToken</span><span class="o">.</span><span class="na">asActivityRecord</span><span class="o">();</span>
<span class="ln">15</span>        <span class="n">mWindowId</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WindowId</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
<span class="ln">16</span>        <span class="n">mViewVisibility</span> <span class="o">=</span> <span class="n">viewVisibility</span><span class="o">;</span>
<span class="ln">17</span>        <span class="n">mPolicy</span> <span class="o">=</span> <span class="n">mWmService</span><span class="o">.</span><span class="na">mPolicy</span><span class="o">;</span>
<span class="ln">18</span>        <span class="n">mContext</span> <span class="o">=</span> <span class="n">mWmService</span><span class="o">.</span><span class="na">mContext</span><span class="o">;</span>
<span class="ln">19</span>        <span class="o">...</span>
<span class="ln">20</span>        <span class="c1">//这一段在上述Window层级中出现，现在回过头再看就眼熟很多
</span><span class="ln">21</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">mAttrs</span><span class="o">.</span><span class="na">type</span> <span class="o">&gt;=</span> <span class="n">FIRST_SUB_WINDOW</span> <span class="o">&amp;&amp;</span> <span class="n">mAttrs</span><span class="o">.</span><span class="na">type</span> <span class="o">&lt;=</span> <span class="n">LAST_SUB_WINDOW</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">22</span>            <span class="c1">// The multiplier here is to reserve space for multiple
</span><span class="ln">23</span><span class="c1"></span>            <span class="c1">// windows in the same type layer.
</span><span class="ln">24</span><span class="c1"></span>            <span class="n">mBaseLayer</span> <span class="o">=</span> <span class="n">mPolicy</span><span class="o">.</span><span class="na">getWindowLayerLw</span><span class="o">(</span><span class="n">parentWindow</span><span class="o">)</span>
<span class="ln">25</span>                <span class="o">*</span> <span class="n">TYPE_LAYER_MULTIPLIER</span> <span class="o">+</span> <span class="n">TYPE_LAYER_OFFSET</span><span class="o">;</span>
<span class="ln">26</span>            <span class="n">mSubLayer</span> <span class="o">=</span> <span class="n">mPolicy</span><span class="o">.</span><span class="na">getSubWindowLayerFromTypeLw</span><span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">type</span><span class="o">);</span>
<span class="ln">27</span>            <span class="n">mIsChildWindow</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
<span class="ln">28</span>
<span class="ln">29</span>            <span class="n">mLayoutAttached</span> <span class="o">=</span> <span class="n">mAttrs</span><span class="o">.</span><span class="na">type</span> <span class="o">!=</span>
<span class="ln">30</span>                <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">.</span><span class="na">TYPE_APPLICATION_ATTACHED_DIALOG</span><span class="o">;</span>
<span class="ln">31</span>            <span class="n">mIsImWindow</span> <span class="o">=</span> <span class="n">parentWindow</span><span class="o">.</span><span class="na">mAttrs</span><span class="o">.</span><span class="na">type</span> <span class="o">==</span> <span class="n">TYPE_INPUT_METHOD</span>
<span class="ln">32</span>                <span class="o">||</span> <span class="n">parentWindow</span><span class="o">.</span><span class="na">mAttrs</span><span class="o">.</span><span class="na">type</span> <span class="o">==</span> <span class="n">TYPE_INPUT_METHOD_DIALOG</span><span class="o">;</span>
<span class="ln">33</span>            <span class="n">mIsWallpaper</span> <span class="o">=</span> <span class="n">parentWindow</span><span class="o">.</span><span class="na">mAttrs</span><span class="o">.</span><span class="na">type</span> <span class="o">==</span> <span class="n">TYPE_WALLPAPER</span><span class="o">;</span>
<span class="ln">34</span>        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="ln">35</span>            <span class="c1">// The multiplier here is to reserve space for multiple
</span><span class="ln">36</span><span class="c1"></span>            <span class="c1">// windows in the same type layer.
</span><span class="ln">37</span><span class="c1"></span>            <span class="n">mBaseLayer</span> <span class="o">=</span> <span class="n">mPolicy</span><span class="o">.</span><span class="na">getWindowLayerLw</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
<span class="ln">38</span>                <span class="o">*</span> <span class="n">TYPE_LAYER_MULTIPLIER</span> <span class="o">+</span> <span class="n">TYPE_LAYER_OFFSET</span><span class="o">;</span>
<span class="ln">39</span>            <span class="n">mSubLayer</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
<span class="ln">40</span>            <span class="n">mIsChildWindow</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
<span class="ln">41</span>            <span class="n">mLayoutAttached</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
<span class="ln">42</span>            <span class="n">mIsImWindow</span> <span class="o">=</span> <span class="n">mAttrs</span><span class="o">.</span><span class="na">type</span> <span class="o">==</span> <span class="n">TYPE_INPUT_METHOD</span>
<span class="ln">43</span>                <span class="o">||</span> <span class="n">mAttrs</span><span class="o">.</span><span class="na">type</span> <span class="o">==</span> <span class="n">TYPE_INPUT_METHOD_DIALOG</span><span class="o">;</span>
<span class="ln">44</span>            <span class="n">mIsWallpaper</span> <span class="o">=</span> <span class="n">mAttrs</span><span class="o">.</span><span class="na">type</span> <span class="o">==</span> <span class="n">TYPE_WALLPAPER</span><span class="o">;</span>
<span class="ln">45</span>        <span class="o">}</span>
<span class="ln">46</span>        <span class="o">...</span>
<span class="ln">47</span>        <span class="c1">// 确保在添加到parentwwindow之前初始化所有字段，以防止onDisplayChanged期间出现异常
</span><span class="ln">48</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">mIsChildWindow</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">49</span>            <span class="n">ProtoLog</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="n">WM_DEBUG_ADD_REMOVE</span><span class="o">,</span> <span class="s">&#34;Adding %s to %s&#34;</span><span class="o">,</span> <span class="k">this</span><span class="o">,</span> <span class="n">parentWindow</span><span class="o">);</span>
<span class="ln">50</span>            <span class="n">parentWindow</span><span class="o">.</span><span class="na">addChild</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">sWindowSubLayerComparator</span><span class="o">);</span>
<span class="ln">51</span>        <span class="o">}</span>
<span class="ln">52</span>    <span class="o">}</span>
<span class="ln">53</span><span class="o">}</span>
</code></pre></div><p>这里构造只会让WindowState和父WindowState联系起来，<strong>并不会将WindowToken和WindowState关联起来</strong></p>
<h5 id="25316winmtokenaddwindow">2.5.3.1.6win.mToken.addWindow</h5>
<p>会将WindowToken和WindowState关联起来</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/services/core/java/com/android/server/wm/WindowToken.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kt">void</span> <span class="nf">addWindow</span><span class="o">(</span><span class="kd">final</span> <span class="n">WindowState</span> <span class="n">win</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 3</span>    <span class="k">if</span> <span class="o">(</span><span class="n">win</span><span class="o">.</span><span class="na">isChildWindow</span><span class="o">())</span> <span class="o">{</span>
<span class="ln"> 4</span>        <span class="c1">// 子窗口被添加到它们的父窗口
</span><span class="ln"> 5</span><span class="c1"></span>        <span class="k">return</span><span class="o">;</span>
<span class="ln"> 6</span>    <span class="o">}</span>
<span class="ln"> 7</span>    <span class="o">...</span>
<span class="ln"> 8</span>    <span class="k">if</span> <span class="o">(!</span><span class="n">mChildren</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">win</span><span class="o">))</span> <span class="o">{</span>
<span class="ln"> 9</span>        <span class="n">addChild</span><span class="o">(</span><span class="n">win</span><span class="o">,</span> <span class="n">mWindowComparator</span><span class="o">);</span>
<span class="ln">10</span>        <span class="n">mWmService</span><span class="o">.</span><span class="na">mWindowsChanged</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
<span class="ln">11</span>    <span class="o">}</span>
<span class="ln">12</span><span class="o">}</span>
</code></pre></div><p>最终会调用到父类WindowContainer的addChild方法</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/services/core/java/com/android/server/wm/WindowContainer.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">protected</span> <span class="kd">final</span> <span class="n">WindowList</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span> <span class="n">mChildren</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WindowList</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;();</span>
<span class="ln"> 3</span><span class="kd">private</span> <span class="n">WindowContainer</span><span class="o">&lt;</span><span class="n">WindowContainer</span><span class="o">&gt;</span> <span class="n">mParent</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="ln"> 4</span><span class="nd">@CallSuper</span>
<span class="ln"> 5</span><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">addChild</span><span class="o">(</span><span class="n">E</span> <span class="n">child</span><span class="o">,</span> <span class="n">Comparator</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span> <span class="n">comparator</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 6</span>    <span class="kt">int</span> <span class="n">positionToAdd</span> <span class="o">=</span> <span class="o">-</span><span class="n">1</span><span class="o">;</span>
<span class="ln"> 7</span>    <span class="k">if</span> <span class="o">(</span><span class="n">comparator</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 8</span>        <span class="kd">final</span> <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">mChildren</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
<span class="ln"> 9</span>        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
<span class="ln">10</span>            <span class="k">if</span> <span class="o">(</span><span class="n">comparator</span><span class="o">.</span><span class="na">compare</span><span class="o">(</span><span class="n">child</span><span class="o">,</span> <span class="n">mChildren</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">))</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">11</span>                <span class="n">positionToAdd</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
<span class="ln">12</span>                <span class="k">break</span><span class="o">;</span>
<span class="ln">13</span>            <span class="o">}</span>
<span class="ln">14</span>        <span class="o">}</span>
<span class="ln">15</span>    <span class="o">}</span>
<span class="ln">16</span>
<span class="ln">17</span>    <span class="k">if</span> <span class="o">(</span><span class="n">positionToAdd</span> <span class="o">==</span> <span class="o">-</span><span class="n">1</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">18</span>        <span class="n">mChildren</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">child</span><span class="o">);</span>
<span class="ln">19</span>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="ln">20</span>        <span class="n">mChildren</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">positionToAdd</span><span class="o">,</span> <span class="n">child</span><span class="o">);</span>
<span class="ln">21</span>    <span class="o">}</span>
<span class="ln">22</span>
<span class="ln">23</span>    <span class="c1">// Set the parent after we&#39;ve actually added a child in case a subclass depends on this.
</span><span class="ln">24</span><span class="c1"></span>    <span class="n">child</span><span class="o">.</span><span class="na">setParent</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
<span class="ln">25</span><span class="o">}</span>
<span class="ln">26</span>
<span class="ln">27</span><span class="kd">final</span> <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">setParent</span><span class="o">(</span><span class="n">WindowContainer</span><span class="o">&lt;</span><span class="n">WindowContainer</span><span class="o">&gt;</span> <span class="n">parent</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">28</span>    <span class="kd">final</span> <span class="n">WindowContainer</span> <span class="n">oldParent</span> <span class="o">=</span> <span class="n">mParent</span><span class="o">;</span>
<span class="ln">29</span>    <span class="n">mParent</span> <span class="o">=</span> <span class="n">parent</span><span class="o">;</span>
<span class="ln">30</span>
<span class="ln">31</span>    <span class="k">if</span> <span class="o">(</span><span class="n">mParent</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">32</span>        <span class="n">mParent</span><span class="o">.</span><span class="na">onChildAdded</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
<span class="ln">33</span>    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">mSurfaceAnimator</span><span class="o">.</span><span class="na">hasLeash</span><span class="o">())</span> <span class="o">{</span>
<span class="ln">34</span>        <span class="n">mSurfaceAnimator</span><span class="o">.</span><span class="na">cancelAnimation</span><span class="o">();</span>
<span class="ln">35</span>    <span class="o">}</span>
<span class="ln">36</span>    <span class="k">if</span> <span class="o">(!</span><span class="n">mReparenting</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">37</span>        <span class="n">onSyncReparent</span><span class="o">(</span><span class="n">oldParent</span><span class="o">,</span> <span class="n">mParent</span><span class="o">);</span>
<span class="ln">38</span>        <span class="k">if</span> <span class="o">(</span><span class="n">mParent</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">mParent</span><span class="o">.</span><span class="na">mDisplayContent</span> <span class="o">!=</span> <span class="kc">null</span>
<span class="ln">39</span>            <span class="o">&amp;&amp;</span> <span class="n">mDisplayContent</span> <span class="o">!=</span> <span class="n">mParent</span><span class="o">.</span><span class="na">mDisplayContent</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">40</span>            <span class="n">onDisplayChanged</span><span class="o">(</span><span class="n">mParent</span><span class="o">.</span><span class="na">mDisplayContent</span><span class="o">);</span>
<span class="ln">41</span>        <span class="o">}</span>
<span class="ln">42</span>        <span class="n">onParentChanged</span><span class="o">(</span><span class="n">mParent</span><span class="o">,</span> <span class="n">oldParent</span><span class="o">);</span>
<span class="ln">43</span>    <span class="o">}</span>
<span class="ln">44</span><span class="o">}</span>
</code></pre></div><p>上述添加规则mWindowComparator，实际上就是上面层级关系2.3.2.3的WindowState添加规则</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window57.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window57.png" >
  
    </a>
  
  
</div>

<h5 id="25317流程图">2.5.3.1.7流程图</h5>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window72.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window72.png" >
  
    </a>
  
  
</div>

<p>补充UML图</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window73.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window73.png" >
  
    </a>
  
  
</div>

<h4 id="2532updateviewlayout">2.5.3.2updateViewLayout</h4>
<p>和Window 添加类似，主要简单介绍为主，感兴趣的读者可以自行查看源码。它的实现也是在 WindowManagerImpl 中，同样的，实际调用的是 WindowManagerGlobal 对应的方法 updateViewLayout</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/core/java/android/view/WindowManagerGlobal.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">updateViewLayout</span><span class="o">(</span><span class="n">View</span> <span class="n">view</span><span class="o">,</span> <span class="n">ViewGroup</span><span class="o">.</span><span class="na">LayoutParams</span> <span class="n">params</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 3</span>    <span class="k">if</span> <span class="o">(</span><span class="n">view</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 4</span>        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;view must not be null&#34;</span><span class="o">);</span>
<span class="ln"> 5</span>    <span class="o">}</span>
<span class="ln"> 6</span>    <span class="k">if</span> <span class="o">(!(</span><span class="n">params</span> <span class="k">instanceof</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">))</span> <span class="o">{</span>
<span class="ln"> 7</span>        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;Params must be WindowManager.LayoutParams&#34;</span><span class="o">);</span>
<span class="ln"> 8</span>    <span class="o">}</span>
<span class="ln"> 9</span>
<span class="ln">10</span>    <span class="kd">final</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span> <span class="n">wparams</span> <span class="o">=</span> <span class="o">(</span><span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">)</span><span class="n">params</span><span class="o">;</span>
<span class="ln">11</span>
<span class="ln">12</span>    <span class="n">view</span><span class="o">.</span><span class="na">setLayoutParams</span><span class="o">(</span><span class="n">wparams</span><span class="o">);</span>
<span class="ln">13</span>
<span class="ln">14</span>    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mLock</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">15</span>        <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">findViewLocked</span><span class="o">(</span><span class="n">view</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
<span class="ln">16</span>        <span class="n">ViewRootImpl</span> <span class="n">root</span> <span class="o">=</span> <span class="n">mRoots</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
<span class="ln">17</span>        <span class="n">mParams</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
<span class="ln">18</span>        <span class="n">mParams</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">index</span><span class="o">,</span> <span class="n">wparams</span><span class="o">);</span>
<span class="ln">19</span>        <span class="n">root</span><span class="o">.</span><span class="na">setLayoutParams</span><span class="o">(</span><span class="n">wparams</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
<span class="ln">20</span>    <span class="o">}</span>
<span class="ln">21</span><span class="o">}</span>
</code></pre></div><p>这里的root直接调用对应的setLayoutParams方法，其中后一个参数为false，表示无需重绘</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/core/java/android/view/ViewRootImpl.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">setLayoutParams</span><span class="o">(</span><span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span> <span class="n">attrs</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">newView</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 3</span>    <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 4</span>        <span class="kd">final</span> <span class="kt">int</span> <span class="n">oldInsetLeft</span> <span class="o">=</span> <span class="n">mWindowAttributes</span><span class="o">.</span><span class="na">surfaceInsets</span><span class="o">.</span><span class="na">left</span><span class="o">;</span>
<span class="ln"> 5</span>        <span class="kd">final</span> <span class="kt">int</span> <span class="n">oldInsetTop</span> <span class="o">=</span> <span class="n">mWindowAttributes</span><span class="o">.</span><span class="na">surfaceInsets</span><span class="o">.</span><span class="na">top</span><span class="o">;</span>
<span class="ln"> 6</span>        <span class="kd">final</span> <span class="kt">int</span> <span class="n">oldInsetRight</span> <span class="o">=</span> <span class="n">mWindowAttributes</span><span class="o">.</span><span class="na">surfaceInsets</span><span class="o">.</span><span class="na">right</span><span class="o">;</span>
<span class="ln"> 7</span>        <span class="kd">final</span> <span class="kt">int</span> <span class="n">oldInsetBottom</span> <span class="o">=</span> <span class="n">mWindowAttributes</span><span class="o">.</span><span class="na">surfaceInsets</span><span class="o">.</span><span class="na">bottom</span><span class="o">;</span>
<span class="ln"> 8</span>        <span class="kd">final</span> <span class="kt">int</span> <span class="n">oldSoftInputMode</span> <span class="o">=</span> <span class="n">mWindowAttributes</span><span class="o">.</span><span class="na">softInputMode</span><span class="o">;</span>
<span class="ln"> 9</span>        <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">oldHasManualSurfaceInsets</span> <span class="o">=</span> <span class="n">mWindowAttributes</span><span class="o">.</span><span class="na">hasManualSurfaceInsets</span><span class="o">;</span>
<span class="ln">10</span>        <span class="c1">// Keep track of the actual window flags supplied by the client.
</span><span class="ln">11</span><span class="c1"></span>        <span class="n">mClientWindowLayoutFlags</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="na">flags</span><span class="o">;</span>
<span class="ln">12</span>
<span class="ln">13</span>        <span class="c1">// Preserve compatible window flag if exists.
</span><span class="ln">14</span><span class="c1"></span>        <span class="kd">final</span> <span class="kt">int</span> <span class="n">compatibleWindowFlag</span> <span class="o">=</span> <span class="n">mWindowAttributes</span><span class="o">.</span><span class="na">privateFlags</span>
<span class="ln">15</span>            <span class="o">&amp;</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">.</span><span class="na">PRIVATE_FLAG_COMPATIBLE_WINDOW</span><span class="o">;</span>
<span class="ln">16</span>
<span class="ln">17</span>        <span class="c1">// Preserve system UI visibility.
</span><span class="ln">18</span><span class="c1"></span>        <span class="kd">final</span> <span class="kt">int</span> <span class="n">systemUiVisibility</span> <span class="o">=</span> <span class="n">mWindowAttributes</span><span class="o">.</span><span class="na">systemUiVisibility</span><span class="o">;</span>
<span class="ln">19</span>        <span class="kd">final</span> <span class="kt">int</span> <span class="n">subtreeSystemUiVisibility</span> <span class="o">=</span> <span class="n">mWindowAttributes</span><span class="o">.</span><span class="na">subtreeSystemUiVisibility</span><span class="o">;</span>
<span class="ln">20</span>
<span class="ln">21</span>        <span class="c1">// Preserve appearance and behavior.
</span><span class="ln">22</span><span class="c1"></span>        <span class="kd">final</span> <span class="kt">int</span> <span class="n">appearance</span> <span class="o">=</span> <span class="n">mWindowAttributes</span><span class="o">.</span><span class="na">insetsFlags</span><span class="o">.</span><span class="na">appearance</span><span class="o">;</span>
<span class="ln">23</span>        <span class="kd">final</span> <span class="kt">int</span> <span class="n">behavior</span> <span class="o">=</span> <span class="n">mWindowAttributes</span><span class="o">.</span><span class="na">insetsFlags</span><span class="o">.</span><span class="na">behavior</span><span class="o">;</span>
<span class="ln">24</span>        <span class="kd">final</span> <span class="kt">int</span> <span class="n">appearanceAndBehaviorPrivateFlags</span> <span class="o">=</span> <span class="n">mWindowAttributes</span><span class="o">.</span><span class="na">privateFlags</span>
<span class="ln">25</span>            <span class="o">&amp;</span> <span class="o">(</span><span class="n">PRIVATE_FLAG_APPEARANCE_CONTROLLED</span> <span class="o">|</span> <span class="n">PRIVATE_FLAG_BEHAVIOR_CONTROLLED</span><span class="o">);</span>
<span class="ln">26</span>
<span class="ln">27</span>        <span class="kd">final</span> <span class="kt">int</span> <span class="n">changes</span> <span class="o">=</span> <span class="n">mWindowAttributes</span><span class="o">.</span><span class="na">copyFrom</span><span class="o">(</span><span class="n">attrs</span><span class="o">);</span>
<span class="ln">28</span>        <span class="k">if</span> <span class="o">((</span><span class="n">changes</span> <span class="o">&amp;</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">.</span><span class="na">TRANSLUCENT_FLAGS_CHANGED</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">29</span>            <span class="c1">// Recompute system ui visibility.
</span><span class="ln">30</span><span class="c1"></span>            <span class="n">mAttachInfo</span><span class="o">.</span><span class="na">mRecomputeGlobalAttributes</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
<span class="ln">31</span>        <span class="o">}</span>
<span class="ln">32</span>        <span class="k">if</span> <span class="o">((</span><span class="n">changes</span> <span class="o">&amp;</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">.</span><span class="na">LAYOUT_CHANGED</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">33</span>            <span class="c1">// Request to update light center.
</span><span class="ln">34</span><span class="c1"></span>            <span class="n">mAttachInfo</span><span class="o">.</span><span class="na">mNeedsUpdateLightCenter</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
<span class="ln">35</span>        <span class="o">}</span>
<span class="ln">36</span>        <span class="k">if</span> <span class="o">(</span><span class="n">mWindowAttributes</span><span class="o">.</span><span class="na">packageName</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">37</span>            <span class="n">mWindowAttributes</span><span class="o">.</span><span class="na">packageName</span> <span class="o">=</span> <span class="n">mBasePackageName</span><span class="o">;</span>
<span class="ln">38</span>        <span class="o">}</span>
<span class="ln">39</span>
<span class="ln">40</span>        <span class="c1">// Restore preserved flags.
</span><span class="ln">41</span><span class="c1"></span>        <span class="n">mWindowAttributes</span><span class="o">.</span><span class="na">systemUiVisibility</span> <span class="o">=</span> <span class="n">systemUiVisibility</span><span class="o">;</span>
<span class="ln">42</span>        <span class="n">mWindowAttributes</span><span class="o">.</span><span class="na">subtreeSystemUiVisibility</span> <span class="o">=</span> <span class="n">subtreeSystemUiVisibility</span><span class="o">;</span>
<span class="ln">43</span>        <span class="n">mWindowAttributes</span><span class="o">.</span><span class="na">insetsFlags</span><span class="o">.</span><span class="na">appearance</span> <span class="o">=</span> <span class="n">appearance</span><span class="o">;</span>
<span class="ln">44</span>        <span class="n">mWindowAttributes</span><span class="o">.</span><span class="na">insetsFlags</span><span class="o">.</span><span class="na">behavior</span> <span class="o">=</span> <span class="n">behavior</span><span class="o">;</span>
<span class="ln">45</span>        <span class="n">mWindowAttributes</span><span class="o">.</span><span class="na">privateFlags</span> <span class="o">|=</span> <span class="n">compatibleWindowFlag</span>
<span class="ln">46</span>            <span class="o">|</span> <span class="n">appearanceAndBehaviorPrivateFlags</span>
<span class="ln">47</span>            <span class="o">|</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">.</span><span class="na">PRIVATE_FLAG_USE_BLAST</span><span class="o">;</span>
<span class="ln">48</span>
<span class="ln">49</span>        <span class="k">if</span> <span class="o">(</span><span class="n">mWindowAttributes</span><span class="o">.</span><span class="na">preservePreviousSurfaceInsets</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">50</span>            <span class="c1">// Restore old surface insets.
</span><span class="ln">51</span><span class="c1"></span>            <span class="n">mWindowAttributes</span><span class="o">.</span><span class="na">surfaceInsets</span><span class="o">.</span><span class="na">set</span><span class="o">(</span>
<span class="ln">52</span>                <span class="n">oldInsetLeft</span><span class="o">,</span> <span class="n">oldInsetTop</span><span class="o">,</span> <span class="n">oldInsetRight</span><span class="o">,</span> <span class="n">oldInsetBottom</span><span class="o">);</span>
<span class="ln">53</span>            <span class="n">mWindowAttributes</span><span class="o">.</span><span class="na">hasManualSurfaceInsets</span> <span class="o">=</span> <span class="n">oldHasManualSurfaceInsets</span><span class="o">;</span>
<span class="ln">54</span>        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">mWindowAttributes</span><span class="o">.</span><span class="na">surfaceInsets</span><span class="o">.</span><span class="na">left</span> <span class="o">!=</span> <span class="n">oldInsetLeft</span>
<span class="ln">55</span>                   <span class="o">||</span> <span class="n">mWindowAttributes</span><span class="o">.</span><span class="na">surfaceInsets</span><span class="o">.</span><span class="na">top</span> <span class="o">!=</span> <span class="n">oldInsetTop</span>
<span class="ln">56</span>                   <span class="o">||</span> <span class="n">mWindowAttributes</span><span class="o">.</span><span class="na">surfaceInsets</span><span class="o">.</span><span class="na">right</span> <span class="o">!=</span> <span class="n">oldInsetRight</span>
<span class="ln">57</span>                   <span class="o">||</span> <span class="n">mWindowAttributes</span><span class="o">.</span><span class="na">surfaceInsets</span><span class="o">.</span><span class="na">bottom</span> <span class="o">!=</span> <span class="n">oldInsetBottom</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">58</span>            <span class="n">mNeedsRendererSetup</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
<span class="ln">59</span>        <span class="o">}</span>
<span class="ln">60</span>
<span class="ln">61</span>        <span class="n">applyKeepScreenOnFlag</span><span class="o">(</span><span class="n">mWindowAttributes</span><span class="o">);</span>
<span class="ln">62</span>		<span class="c1">//这里无需重绘
</span><span class="ln">63</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">newView</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">64</span>            <span class="n">mSoftInputMode</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="na">softInputMode</span><span class="o">;</span>
<span class="ln">65</span>            <span class="n">requestLayout</span><span class="o">();</span>
<span class="ln">66</span>        <span class="o">}</span>
<span class="ln">67</span>
<span class="ln">68</span>        <span class="c1">// Don&#39;t lose the mode we last auto-computed.
</span><span class="ln">69</span><span class="c1"></span>        <span class="k">if</span> <span class="o">((</span><span class="n">attrs</span><span class="o">.</span><span class="na">softInputMode</span> <span class="o">&amp;</span> <span class="n">SOFT_INPUT_MASK_ADJUST</span><span class="o">)</span>
<span class="ln">70</span>            <span class="o">==</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">.</span><span class="na">SOFT_INPUT_ADJUST_UNSPECIFIED</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">71</span>            <span class="n">mWindowAttributes</span><span class="o">.</span><span class="na">softInputMode</span> <span class="o">=</span> <span class="o">(</span><span class="n">mWindowAttributes</span><span class="o">.</span><span class="na">softInputMode</span>
<span class="ln">72</span>                                               <span class="o">&amp;</span> <span class="o">~</span><span class="n">SOFT_INPUT_MASK_ADJUST</span><span class="o">)</span> <span class="o">|</span> <span class="o">(</span><span class="n">oldSoftInputMode</span> <span class="o">&amp;</span> <span class="n">SOFT_INPUT_MASK_ADJUST</span><span class="o">);</span>
<span class="ln">73</span>        <span class="o">}</span>
<span class="ln">74</span>		<span class="c1">//如果softInputMode有调整，会触发这里的scheduleTraversals
</span><span class="ln">75</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">mWindowAttributes</span><span class="o">.</span><span class="na">softInputMode</span> <span class="o">!=</span> <span class="n">oldSoftInputMode</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">76</span>            <span class="n">requestFitSystemWindows</span><span class="o">();</span>
<span class="ln">77</span>        <span class="o">}</span>
<span class="ln">78</span>
<span class="ln">79</span>        <span class="n">mWindowAttributesChanged</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
<span class="ln">80</span>        <span class="n">scheduleTraversals</span><span class="o">();</span>
<span class="ln">81</span>    <span class="o">}</span>
<span class="ln">82</span><span class="o">}</span>
</code></pre></div><p>这里的scheduleTraversals在上述addView也有，这里不做展开，申请下一帧进行绘制。</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window60.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window60.png" >
  
    </a>
  
  
</div>

<h4 id="2533removeview">2.5.3.3removeView</h4>
<p>Window 的删除过程通过 WindowManager 的 removeView 方法进行的</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/core/java/android/view/WindowManagerImpl.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="nd">@Override</span>
<span class="ln"> 3</span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">removeView</span><span class="o">(</span><span class="n">View</span> <span class="n">view</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 4</span>    <span class="n">mGlobal</span><span class="o">.</span><span class="na">removeView</span><span class="o">(</span><span class="n">view</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
<span class="ln"> 5</span><span class="o">}</span>
<span class="ln"> 6</span>
<span class="ln"> 7</span><span class="nd">@Override</span>
<span class="ln"> 8</span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">removeViewImmediate</span><span class="o">(</span><span class="n">View</span> <span class="n">view</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 9</span>    <span class="n">mGlobal</span><span class="o">.</span><span class="na">removeView</span><span class="o">(</span><span class="n">view</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
<span class="ln">10</span><span class="o">}</span>
</code></pre></div><p>上面在WindowManagerImpl将remove操作划分，通过是否立刻来判断是否是同步，false为异步，true为同步。通常Activity走的是异步，Dialog会走同步。</p>
<p>实际逻辑在 WindowManagerGlobal 的实现中。和Window 添加类似，主要简单介绍为主，感兴趣的读者可以自行查看源码。</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/core/java/android/view/WindowManagerGlobal.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">removeView</span><span class="o">(</span><span class="n">View</span> <span class="n">view</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">immediate</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 3</span>    <span class="k">if</span> <span class="o">(</span><span class="n">view</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 4</span>        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;view must not be null&#34;</span><span class="o">);</span>
<span class="ln"> 5</span>    <span class="o">}</span>
<span class="ln"> 6</span>
<span class="ln"> 7</span>    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mLock</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 8</span>        <span class="c1">//[2.5.3.3.1]
</span><span class="ln"> 9</span><span class="c1"></span>        <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">findViewLocked</span><span class="o">(</span><span class="n">view</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
<span class="ln">10</span>        <span class="c1">//[2.5.3.3.2]
</span><span class="ln">11</span><span class="c1"></span>        <span class="n">View</span> <span class="n">curView</span> <span class="o">=</span> <span class="n">mRoots</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">index</span><span class="o">).</span><span class="na">getView</span><span class="o">();</span>
<span class="ln">12</span>        <span class="c1">//[2.5.3.3.3]
</span><span class="ln">13</span><span class="c1"></span>        <span class="n">removeViewLocked</span><span class="o">(</span><span class="n">index</span><span class="o">,</span> <span class="n">immediate</span><span class="o">);</span>
<span class="ln">14</span>        <span class="k">if</span> <span class="o">(</span><span class="n">curView</span> <span class="o">==</span> <span class="n">view</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">15</span>            <span class="k">return</span><span class="o">;</span>
<span class="ln">16</span>        <span class="o">}</span>
<span class="ln">17</span>
<span class="ln">18</span>        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span><span class="s">&#34;Calling with view &#34;</span> <span class="o">+</span> <span class="n">view</span>
<span class="ln">19</span>                                        <span class="o">+</span> <span class="s">&#34; but the ViewAncestor is attached to &#34;</span> <span class="o">+</span> <span class="n">curView</span><span class="o">);</span>
<span class="ln">20</span>    <span class="o">}</span>
<span class="ln">21</span><span class="o">}</span>
</code></pre></div><h5 id="25331findviewlocked">2.5.3.3.1findViewLocked</h5>
<p>获取view在mViews中的索引</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln">1</span><span class="c1">//frameworks/base/core/java/android/view/WindowManagerGlobal.java
</span><span class="ln">2</span><span class="c1"></span><span class="kd">private</span> <span class="kt">int</span> <span class="nf">findViewLocked</span><span class="o">(</span><span class="n">View</span> <span class="n">view</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">required</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">3</span>    <span class="kd">final</span> <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">mViews</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="n">view</span><span class="o">);</span>
<span class="ln">4</span>    <span class="k">if</span> <span class="o">(</span><span class="n">required</span> <span class="o">&amp;&amp;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">5</span>        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;View=&#34;</span> <span class="o">+</span> <span class="n">view</span> <span class="o">+</span> <span class="s">&#34; not attached to window manager&#34;</span><span class="o">);</span>
<span class="ln">6</span>    <span class="o">}</span>
<span class="ln">7</span>    <span class="k">return</span> <span class="n">index</span><span class="o">;</span>
<span class="ln">8</span><span class="o">}</span>
</code></pre></div><h5 id="25332mrootsgetindexgetview">2.5.3.3.2mRoots.get(index).getView()</h5>
<p>从 mRoots 中根据索引找出 ViewRootImpl ，通过 ViewRootImpl 找到它的 View。通常我们访问的View可能是一个子View，然后直接添加的View可能是一个View树，这个时候如果删除那么就是删除这个子View对应的之前setView添加的View树。当然可能这个现在的View就是之前的setView进来的View</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/core/java/android/view/ViewRootImpl.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="n">View</span> <span class="n">mView</span><span class="o">;</span>
<span class="ln"> 3</span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">setView</span><span class="o">(</span><span class="n">View</span> <span class="n">view</span><span class="o">,</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span> <span class="n">attrs</span><span class="o">,</span> <span class="n">View</span> <span class="n">panelParentView</span><span class="o">,</span>
<span class="ln"> 4</span>                    <span class="kt">int</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 5</span>    <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 6</span>        <span class="k">if</span> <span class="o">(</span><span class="n">mView</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 7</span>            <span class="n">mView</span> <span class="o">=</span> <span class="n">view</span><span class="o">;</span>
<span class="ln"> 8</span>        <span class="o">}</span>
<span class="ln"> 9</span>    <span class="o">}</span>
<span class="ln">10</span>    <span class="o">...</span>
<span class="ln">11</span><span class="o">}</span>
<span class="ln">12</span>
<span class="ln">13</span><span class="kd">public</span> <span class="n">View</span> <span class="nf">getView</span><span class="o">()</span> <span class="o">{</span>
<span class="ln">14</span>    <span class="k">return</span> <span class="n">mView</span><span class="o">;</span>
<span class="ln">15</span><span class="o">}</span>
</code></pre></div><blockquote>
<p>说明一下addView传入的View和removeView传入的View</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window59.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window59.png" >
  
    </a>
  
  
</div>

</blockquote>
<h5 id="25333removeviewlocked">2.5.3.3.3removeViewLocked</h5>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/core/java/android/view/WindowManagerGlobal.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">private</span> <span class="kt">void</span> <span class="nf">removeViewLocked</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">immediate</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 3</span>    <span class="n">ViewRootImpl</span> <span class="n">root</span> <span class="o">=</span> <span class="n">mRoots</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
<span class="ln"> 4</span>    <span class="n">View</span> <span class="n">view</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="na">getView</span><span class="o">();</span>
<span class="ln"> 5</span>
<span class="ln"> 6</span>    <span class="k">if</span> <span class="o">(</span><span class="n">root</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 7</span>        <span class="c1">//调用去清除输入焦点，结束处理输入法相关的逻辑
</span><span class="ln"> 8</span><span class="c1"></span>        <span class="n">root</span><span class="o">.</span><span class="na">getImeFocusController</span><span class="o">().</span><span class="na">onWindowDismissed</span><span class="o">();</span>
<span class="ln"> 9</span>    <span class="o">}</span>
<span class="ln">10</span>    <span class="kt">boolean</span> <span class="n">deferred</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="na">die</span><span class="o">(</span><span class="n">immediate</span><span class="o">);</span>
<span class="ln">11</span>    <span class="k">if</span> <span class="o">(</span><span class="n">view</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">12</span>        <span class="n">view</span><span class="o">.</span><span class="na">assignParent</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
<span class="ln">13</span>        <span class="k">if</span> <span class="o">(</span><span class="n">deferred</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">14</span>            <span class="n">mDyingViews</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">view</span><span class="o">);</span>
<span class="ln">15</span>        <span class="o">}</span>
<span class="ln">16</span>    <span class="o">}</span>
<span class="ln">17</span><span class="o">}</span>
</code></pre></div><p>在这个方法中，首先也是获取 ViewRootImpl 和 View 对象，然后调用 ViewRootImpl 对象的 die 方法，其中传入的immediate是根据外部传入的值来判断，如果为true同步移除才执行后续的dodie方法。</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/core/java/android/view/ViewRootImpl.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kt">boolean</span> <span class="nf">die</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">immediate</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 3</span>    <span class="c1">// 如果是同步移除，则立即调用doDie方法
</span><span class="ln"> 4</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">immediate</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mIsInTraversal</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 5</span>        <span class="n">doDie</span><span class="o">();</span>
<span class="ln"> 6</span>        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="ln"> 7</span>    <span class="o">}</span>
<span class="ln"> 8</span>
<span class="ln"> 9</span>    <span class="k">if</span> <span class="o">(!</span><span class="n">mIsDrawing</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">10</span>        <span class="n">destroyHardwareRenderer</span><span class="o">();</span>
<span class="ln">11</span>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="ln">12</span>        <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="n">mTag</span><span class="o">,</span> <span class="s">&#34;Attempting to destroy the window while drawing!\n&#34;</span> <span class="o">+</span>
<span class="ln">13</span>              <span class="s">&#34;  window=&#34;</span> <span class="o">+</span> <span class="k">this</span> <span class="o">+</span> <span class="s">&#34;, title=&#34;</span> <span class="o">+</span> <span class="n">mWindowAttributes</span><span class="o">.</span><span class="na">getTitle</span><span class="o">());</span>
<span class="ln">14</span>    <span class="o">}</span>
<span class="ln">15</span>    <span class="c1">//异步移除，发出一个msg进行移除，在主线程移除
</span><span class="ln">16</span><span class="c1"></span>    <span class="n">mHandler</span><span class="o">.</span><span class="na">sendEmptyMessage</span><span class="o">(</span><span class="n">MSG_DIE</span><span class="o">);</span>
<span class="ln">17</span>    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="ln">18</span><span class="o">}</span>
</code></pre></div><h5 id="25334dodie">2.5.3.3.4doDie</h5>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/core/java/android/view/ViewRootImpl.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kt">void</span> <span class="nf">doDie</span><span class="o">()</span> <span class="o">{</span>
<span class="ln"> 3</span>    <span class="o">...</span>
<span class="ln"> 4</span>    <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 5</span>        <span class="c1">//mAdded必须在setView之后，且还没有doDie之前，不然再次调用doDie，mAdded也为false
</span><span class="ln"> 6</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">mAdded</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 7</span>            <span class="c1">//[2.5.3.3.5]	
</span><span class="ln"> 8</span><span class="c1"></span>            <span class="n">dispatchDetachedFromWindow</span><span class="o">();</span>
<span class="ln"> 9</span>        <span class="o">}</span>
<span class="ln">10</span>        <span class="o">..</span>
<span class="ln">11</span>    <span class="o">}</span>
<span class="ln">12</span>    <span class="c1">//[2.5.3.3.6]
</span><span class="ln">13</span><span class="c1"></span>    <span class="n">WindowManagerGlobal</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">doRemoveView</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
<span class="ln">14</span><span class="o">}</span>
</code></pre></div><h5 id="25335dispatchdetachedfromwindow">2.5.3.3.5dispatchDetachedFromWindow</h5>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/core/java/android/view/ViewRootImpl.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kt">void</span> <span class="nf">dispatchDetachedFromWindow</span><span class="o">()</span> <span class="o">{</span>
<span class="ln"> 3</span>    <span class="c1">//这里可以看出我们可以在View销毁前，在View视图树分发的dispatchDetachedFromWindow做一些资源释放操作
</span><span class="ln"> 4</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">mView</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">mView</span><span class="o">.</span><span class="na">mAttachInfo</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 5</span>        <span class="n">mAttachInfo</span><span class="o">.</span><span class="na">mTreeObserver</span><span class="o">.</span><span class="na">dispatchOnWindowAttachedChange</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
<span class="ln"> 6</span>        <span class="n">mView</span><span class="o">.</span><span class="na">dispatchDetachedFromWindow</span><span class="o">();</span>
<span class="ln"> 7</span>    <span class="o">}</span>
<span class="ln"> 8</span>	<span class="c1">//硬件渲染的销毁释放
</span><span class="ln"> 9</span><span class="c1"></span>    <span class="n">destroyHardwareRenderer</span><span class="o">();</span>
<span class="ln">10</span>	<span class="c1">//将mView的root置为null
</span><span class="ln">11</span><span class="c1"></span>    <span class="n">mView</span><span class="o">.</span><span class="na">assignParent</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
<span class="ln">12</span>    <span class="n">mView</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="ln">13</span>    <span class="n">mAttachInfo</span><span class="o">.</span><span class="na">mRootView</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="ln">14</span>	<span class="c1">//释放当前Surface
</span><span class="ln">15</span><span class="c1"></span>    <span class="n">destroySurface</span><span class="o">();</span>
<span class="ln">16</span>
<span class="ln">17</span>    <span class="k">try</span> <span class="o">{</span>
<span class="ln">18</span>        <span class="c1">//[2.5.3.3.7]通过Session IPC调用了WMS移除Window,这里移除的实际上是Window容器
</span><span class="ln">19</span><span class="c1"></span>        <span class="n">mWindowSession</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">mWindow</span><span class="o">);</span>
<span class="ln">20</span>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">21</span>    <span class="o">}</span>
<span class="ln">22</span>    <span class="c1">// 销毁对应的input接受者
</span><span class="ln">23</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">mInputEventReceiver</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">24</span>        <span class="n">mInputEventReceiver</span><span class="o">.</span><span class="na">dispose</span><span class="o">();</span>
<span class="ln">25</span>        <span class="n">mInputEventReceiver</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="ln">26</span>    <span class="o">}</span>
<span class="ln">27</span>	<span class="c1">//删除待执行的 Traversals
</span><span class="ln">28</span><span class="c1"></span>    <span class="n">unregisterListeners</span><span class="o">();</span>
<span class="ln">29</span>    <span class="n">unscheduleTraversals</span><span class="o">();</span>
<span class="ln">30</span><span class="o">}</span>
</code></pre></div><p>dispatchDetachedFromWindow 方法中</p>
<ol>
<li>开始向视图树中的 View 分发 DetachedFromWindow ，</li>
<li>然后释放一些资源，释放 Surface</li>
<li>通过 Session IPC 调用了 WMS 移除 Window</li>
<li>删除待执行的 Traversals</li>
</ol>
<p>这里的unscheduleTraversals和上面的scheduleTraversals恰好相反，这里是移除同步屏障，使得上述scheduleTraversals<strong>还未执行的消息队列失效</strong>。</p>
<h5 id="25336doremoveview">2.5.3.3.6doRemoveView</h5>
<p>这里主要是对WindowManagerGlobal保存的数据（mRoots、mParams、mViews）进行移除</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/core/java/android/view/WindowManagerGlobal.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kt">void</span> <span class="nf">doRemoveView</span><span class="o">(</span><span class="n">ViewRootImpl</span> <span class="n">root</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 3</span>    <span class="kt">boolean</span> <span class="n">allViewsRemoved</span><span class="o">;</span>
<span class="ln"> 4</span>    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mLock</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 5</span>        <span class="kd">final</span> <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">mRoots</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="n">root</span><span class="o">);</span>
<span class="ln"> 6</span>        <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 7</span>            <span class="n">mRoots</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
<span class="ln"> 8</span>            <span class="n">mParams</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
<span class="ln"> 9</span>            <span class="kd">final</span> <span class="n">View</span> <span class="n">view</span> <span class="o">=</span> <span class="n">mViews</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
<span class="ln">10</span>            <span class="n">mDyingViews</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">view</span><span class="o">);</span>
<span class="ln">11</span>        <span class="o">}</span>
<span class="ln">12</span>        <span class="n">allViewsRemoved</span> <span class="o">=</span> <span class="n">mRoots</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">();</span>
<span class="ln">13</span>    <span class="o">}</span>
<span class="ln">14</span>    <span class="k">if</span> <span class="o">(</span><span class="n">ThreadedRenderer</span><span class="o">.</span><span class="na">sTrimForeground</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">15</span>        <span class="n">doTrimForeground</span><span class="o">();</span>
<span class="ln">16</span>    <span class="o">}</span>
<span class="ln">17</span>
<span class="ln">18</span>    <span class="k">if</span> <span class="o">(</span><span class="n">allViewsRemoved</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">19</span>        <span class="n">InsetsAnimationThread</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
<span class="ln">20</span>    <span class="o">}</span>
<span class="ln">21</span><span class="o">}</span>
</code></pre></div><h5 id="25337remove">2.5.3.3.7remove</h5>
<p>根据addView分析，mWindowSession是WMS进程中的Session类</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln">1</span><span class="c1">//frameworks/base/services/core/java/com/android/server/wm/Session.java
</span><span class="ln">2</span><span class="c1"></span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">remove</span><span class="o">(</span><span class="n">IWindow</span> <span class="n">window</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">3</span>    <span class="n">mService</span><span class="o">.</span><span class="na">removeWindow</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">window</span><span class="o">);</span>
<span class="ln">4</span><span class="o">}</span>
</code></pre></div><h5 id="25338removewindow">2.5.3.3.8removeWindow</h5>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/services/core/java/com/android/server/wm/WindowManagerService.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kt">void</span> <span class="nf">removeWindow</span><span class="o">(</span><span class="n">Session</span> <span class="n">session</span><span class="o">,</span> <span class="n">IWindow</span> <span class="n">client</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 3</span>    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mGlobalLock</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 4</span>        <span class="c1">//[2.5.3.3.9]通过windowid找到对应的WindowState容器
</span><span class="ln"> 5</span><span class="c1"></span>        <span class="n">WindowState</span> <span class="n">win</span> <span class="o">=</span> <span class="n">windowForClientLocked</span><span class="o">(</span><span class="n">session</span><span class="o">,</span> <span class="n">client</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
<span class="ln"> 6</span>        <span class="k">if</span> <span class="o">(</span><span class="n">win</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 7</span>            <span class="c1">//[2.5.3.3.10]移除相关的WindowState容器
</span><span class="ln"> 8</span><span class="c1"></span>            <span class="n">win</span><span class="o">.</span><span class="na">removeIfPossible</span><span class="o">();</span>
<span class="ln"> 9</span>            <span class="k">return</span><span class="o">;</span>
<span class="ln">10</span>        <span class="o">}</span>
<span class="ln">11</span>
<span class="ln">12</span>        <span class="c1">//如果令牌属于EmbeddedWindow，则删除EmbeddedWindow映射
</span><span class="ln">13</span><span class="c1"></span>        <span class="n">mEmbeddedWindowController</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">client</span><span class="o">);</span>
<span class="ln">14</span>    <span class="o">}</span>
<span class="ln">15</span><span class="o">}</span>
</code></pre></div><h5 id="25339windowforclientlocked">2.5.3.3.9windowForClientLocked</h5>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/services/core/java/com/android/server/wm/WindowManagerService.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">final</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">IBinder</span><span class="o">,</span> <span class="n">WindowState</span><span class="o">&gt;</span> <span class="n">mWindowMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
<span class="ln"> 3</span><span class="kd">public</span> <span class="kt">int</span> <span class="nf">addWindow</span><span class="o">(</span><span class="n">Session</span> <span class="n">session</span><span class="o">,</span> <span class="n">IWindow</span> <span class="n">client</span><span class="o">,</span> <span class="n">LayoutParams</span> <span class="n">attrs</span><span class="o">,</span> <span class="kt">int</span> <span class="n">viewVisibility</span><span class="o">,</span>
<span class="ln"> 4</span>                     <span class="kt">int</span> <span class="n">displayId</span><span class="o">,</span> <span class="kt">int</span> <span class="n">requestUserId</span><span class="o">,</span> <span class="n">InsetsVisibilities</span> <span class="n">requestedVisibilities</span><span class="o">,</span>
<span class="ln"> 5</span>                     <span class="n">InputChannel</span> <span class="n">outInputChannel</span><span class="o">,</span> <span class="n">InsetsState</span> <span class="n">outInsetsState</span><span class="o">,</span>
<span class="ln"> 6</span>                     <span class="n">InsetsSourceControl</span><span class="o">[]</span> <span class="n">outActiveControls</span><span class="o">,</span> <span class="n">Rect</span> <span class="n">outAttachedFrame</span><span class="o">,</span>
<span class="ln"> 7</span>                     <span class="kt">float</span><span class="o">[]</span> <span class="n">outSizeCompatScale</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 8</span>    <span class="kd">final</span> <span class="n">WindowState</span> <span class="n">win</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WindowState</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">session</span><span class="o">,</span> <span class="n">client</span><span class="o">,</span> <span class="n">token</span><span class="o">,</span> <span class="n">parentWindow</span><span class="o">,</span>
<span class="ln"> 9</span>                    <span class="n">appOp</span><span class="o">[</span><span class="n">0</span><span class="o">],</span> <span class="n">attrs</span><span class="o">,</span> <span class="n">viewVisibility</span><span class="o">,</span> <span class="n">session</span><span class="o">.</span><span class="na">mUid</span><span class="o">,</span> <span class="n">userId</span><span class="o">,</span>
<span class="ln">10</span>                    <span class="n">session</span><span class="o">.</span><span class="na">mCanAddInternalSystemWindow</span><span class="o">);</span>
<span class="ln">11</span>    <span class="c1">//addWindow中传入windowstate
</span><span class="ln">12</span><span class="c1"></span>    <span class="n">mWindowMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">client</span><span class="o">.</span><span class="na">asBinder</span><span class="o">(),</span> <span class="n">win</span><span class="o">);</span>
<span class="ln">13</span>    <span class="n">win</span><span class="o">.</span><span class="na">mToken</span><span class="o">.</span><span class="na">addWindow</span><span class="o">(</span><span class="n">win</span><span class="o">);</span>
<span class="ln">14</span><span class="o">}</span>
<span class="ln">15</span>
<span class="ln">16</span><span class="kd">final</span> <span class="n">WindowState</span> <span class="nf">windowForClientLocked</span><span class="o">(</span><span class="n">Session</span> <span class="n">session</span><span class="o">,</span> <span class="n">IBinder</span> <span class="n">client</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">throwOnError</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">17</span>    <span class="c1">//从hashmap中去除WindowState
</span><span class="ln">18</span><span class="c1"></span>    <span class="n">WindowState</span> <span class="n">win</span> <span class="o">=</span> <span class="n">mWindowMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">client</span><span class="o">);</span>
<span class="ln">19</span>    <span class="c1">//校验WindowState的合法性
</span><span class="ln">20</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">win</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">21</span>        <span class="k">if</span> <span class="o">(</span><span class="n">throwOnError</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">22</span>            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span>
<span class="ln">23</span>                <span class="s">&#34;Requested window &#34;</span> <span class="o">+</span> <span class="n">client</span> <span class="o">+</span> <span class="s">&#34; does not exist&#34;</span><span class="o">);</span>
<span class="ln">24</span>        <span class="o">}</span>
<span class="ln">25</span>        <span class="n">ProtoLog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="n">WM_ERROR</span><span class="o">,</span> <span class="s">&#34;Failed looking up window session=%s callers=%s&#34;</span><span class="o">,</span> <span class="n">session</span><span class="o">,</span>
<span class="ln">26</span>                   <span class="n">Debug</span><span class="o">.</span><span class="na">getCallers</span><span class="o">(</span><span class="n">3</span><span class="o">));</span>
<span class="ln">27</span>        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
<span class="ln">28</span>    <span class="o">}</span>
<span class="ln">29</span>    <span class="k">if</span> <span class="o">(</span><span class="n">session</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">win</span><span class="o">.</span><span class="na">mSession</span> <span class="o">!=</span> <span class="n">session</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">30</span>        <span class="k">if</span> <span class="o">(</span><span class="n">throwOnError</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">31</span>            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;Requested window &#34;</span> <span class="o">+</span> <span class="n">client</span> <span class="o">+</span> <span class="s">&#34; is in session &#34;</span>
<span class="ln">32</span>                                               <span class="o">+</span> <span class="n">win</span><span class="o">.</span><span class="na">mSession</span> <span class="o">+</span> <span class="s">&#34;, not &#34;</span> <span class="o">+</span> <span class="n">session</span><span class="o">);</span>
<span class="ln">33</span>        <span class="o">}</span>
<span class="ln">34</span>        <span class="n">ProtoLog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="n">WM_ERROR</span><span class="o">,</span> <span class="s">&#34;Failed looking up window session=%s callers=%s&#34;</span><span class="o">,</span> <span class="n">session</span><span class="o">,</span>
<span class="ln">35</span>                   <span class="n">Debug</span><span class="o">.</span><span class="na">getCallers</span><span class="o">(</span><span class="n">3</span><span class="o">));</span>
<span class="ln">36</span>        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
<span class="ln">37</span>    <span class="o">}</span>
<span class="ln">38</span>
<span class="ln">39</span>    <span class="k">return</span> <span class="n">win</span><span class="o">;</span>
<span class="ln">40</span><span class="o">}</span>
</code></pre></div><h5 id="253310removeifpossible">2.5.3.3.10removeIfPossible</h5>
<p>获取到WindowState容器，开始移除</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/services/core/java/com/android/server/wm/WindowState.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="nd">@Override</span>
<span class="ln"> 3</span><span class="kt">void</span> <span class="nf">removeIfPossible</span><span class="o">()</span> <span class="o">{</span>
<span class="ln"> 4</span>    <span class="c1">//如果当前的WindowState存在mChildren，那么也需要对mChildren中的Window容器移除
</span><span class="ln"> 5</span><span class="c1"></span>    <span class="kd">super</span><span class="o">.</span><span class="na">removeIfPossible</span><span class="o">();</span>
<span class="ln"> 6</span>    <span class="n">removeIfPossible</span><span class="o">(</span><span class="kc">false</span> <span class="cm">/*keepVisibleDeadWindow*/</span><span class="o">);</span>
<span class="ln"> 7</span><span class="o">}</span>
<span class="ln"> 8</span>
<span class="ln"> 9</span><span class="kd">private</span> <span class="kt">void</span> <span class="nf">removeIfPossible</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">keepVisibleDeadWindow</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">10</span>    <span class="kd">final</span> <span class="n">DisplayContent</span> <span class="n">displayContent</span> <span class="o">=</span> <span class="n">getDisplayContent</span><span class="o">();</span>
<span class="ln">11</span>    <span class="kd">final</span> <span class="kt">long</span> <span class="n">origId</span> <span class="o">=</span> <span class="n">Binder</span><span class="o">.</span><span class="na">clearCallingIdentity</span><span class="o">();</span>
<span class="ln">12</span>    <span class="k">try</span> <span class="o">{</span>
<span class="ln">13</span>        <span class="c1">//[2.5.3.3.11]条件判断过滤，满足条件会直接 return 延迟删除操作
</span><span class="ln">14</span><span class="c1"></span>        <span class="n">removeImmediately</span><span class="o">();</span>
<span class="ln">15</span>        <span class="o">...</span>
<span class="ln">16</span>        <span class="c1">//删除一个可见窗口将影响计算方向，如果需要，更新方向
</span><span class="ln">17</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">needToSendNewConfiguration</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">18</span>            <span class="n">displayContent</span><span class="o">.</span><span class="na">sendNewConfiguration</span><span class="o">();</span>
<span class="ln">19</span>        <span class="o">}</span>
<span class="ln">20</span>        <span class="c1">//更新 WMS 的 Window 焦点
</span><span class="ln">21</span><span class="c1"></span>        <span class="n">mWmService</span><span class="o">.</span><span class="na">updateFocusedWindowLocked</span><span class="o">(</span><span class="n">isFocused</span><span class="o">()</span>
<span class="ln">22</span>                                             <span class="o">?</span> <span class="n">UPDATE_FOCUS_REMOVING_FOCUS</span>
<span class="ln">23</span>                                             <span class="o">:</span> <span class="n">UPDATE_FOCUS_NORMAL</span><span class="o">,</span>
<span class="ln">24</span>                                             <span class="kc">true</span> <span class="cm">/*updateInputWindows*/</span><span class="o">);</span>
<span class="ln">25</span>        <span class="o">...</span>
<span class="ln">26</span>    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
<span class="ln">27</span>        <span class="n">Binder</span><span class="o">.</span><span class="na">restoreCallingIdentity</span><span class="o">(</span><span class="n">origId</span><span class="o">);</span>
<span class="ln">28</span>    <span class="o">}</span>
<span class="ln">29</span><span class="o">}</span>
</code></pre></div><h5 id="253311removeimmediately">2.5.3.3.11removeImmediately</h5>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/services/core/java/com/android/server/wm/WindowState.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="nd">@Override</span>
<span class="ln"> 3</span><span class="kt">void</span> <span class="nf">removeImmediately</span><span class="o">()</span> <span class="o">{</span>
<span class="ln"> 4</span>    <span class="c1">//确保同时只能处理一个
</span><span class="ln"> 5</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">mRemoved</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 6</span>        <span class="c1">// Nothing to do.
</span><span class="ln"> 7</span><span class="c1"></span>        <span class="n">ProtoLog</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="n">WM_DEBUG_ADD_REMOVE</span><span class="o">,</span>
<span class="ln"> 8</span>                   <span class="s">&#34;WS.removeImmediately: %s Already removed...&#34;</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
<span class="ln"> 9</span>        <span class="k">return</span><span class="o">;</span>
<span class="ln">10</span>    <span class="o">}</span>
<span class="ln">11</span>
<span class="ln">12</span>    <span class="n">mRemoved</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
<span class="ln">13</span>    <span class="kd">super</span><span class="o">.</span><span class="na">removeImmediately</span><span class="o">();</span>
<span class="ln">14</span>    <span class="kd">final</span> <span class="n">DisplayContent</span> <span class="n">dc</span> <span class="o">=</span> <span class="n">getDisplayContent</span><span class="o">();</span>
<span class="ln">15</span>    <span class="kd">final</span> <span class="kt">int</span> <span class="n">type</span> <span class="o">=</span> <span class="n">mAttrs</span><span class="o">.</span><span class="na">type</span><span class="o">;</span>
<span class="ln">16</span>    <span class="c1">//判断windowstate类型，只支持五种
</span><span class="ln">17</span><span class="c1"></span>    <span class="c1">//STATUS_BAR
</span><span class="ln">18</span><span class="c1"></span>    <span class="c1">//NOTIFICATION_SHADE
</span><span class="ln">19</span><span class="c1"></span>    <span class="c1">//NAVIGATION_BAR
</span><span class="ln">20</span><span class="c1"></span>    <span class="c1">//INPUT_METHOD_DIALOG
</span><span class="ln">21</span><span class="c1"></span>    <span class="c1">//VOLUME_OVERLAY
</span><span class="ln">22</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">WindowManagerService</span><span class="o">.</span><span class="na">excludeWindowTypeFromTapOutTask</span><span class="o">(</span><span class="n">type</span><span class="o">))</span> <span class="o">{</span>
<span class="ln">23</span>        <span class="n">dc</span><span class="o">.</span><span class="na">mTapExcludedWindows</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
<span class="ln">24</span>    <span class="o">}</span>
<span class="ln">25</span>
<span class="ln">26</span>    <span class="c1">// Remove this window from mTapExcludeProvidingWindows. If it was not registered, this will
</span><span class="ln">27</span><span class="c1"></span>    <span class="c1">// not do anything.
</span><span class="ln">28</span><span class="c1"></span>    <span class="n">dc</span><span class="o">.</span><span class="na">mTapExcludeProvidingWindows</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
<span class="ln">29</span>    <span class="c1">//这里移除对应的STATUS_BAR、NAVIGATION_BAR、CLIMATE_BAR、EXTRA_NAVIGATION_BAR之类的Window
</span><span class="ln">30</span><span class="c1"></span>    <span class="n">dc</span><span class="o">.</span><span class="na">getDisplayPolicy</span><span class="o">().</span><span class="na">removeWindowLw</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
<span class="ln">31</span>	<span class="c1">//处理 Session 相关的逻辑，从 mSessions 中删除了当前 mSession ，并清除 mSession 对应的 SurfaceSession 资源
</span><span class="ln">32</span><span class="c1"></span>    <span class="c1">//SurfaceSession 是 SurfaceFlinger 的一个连接，通过这个连接可以创建多个 Surface 并渲染到屏幕上
</span><span class="ln">33</span><span class="c1"></span>    <span class="n">mSession</span><span class="o">.</span><span class="na">windowRemovedLocked</span><span class="o">();</span>
<span class="ln">34</span>    <span class="k">try</span> <span class="o">{</span>
<span class="ln">35</span>        <span class="c1">//解除与客户端的连接
</span><span class="ln">36</span><span class="c1"></span>        <span class="n">mClient</span><span class="o">.</span><span class="na">asBinder</span><span class="o">().</span><span class="na">unlinkToDeath</span><span class="o">(</span><span class="n">mDeathRecipient</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>
<span class="ln">37</span>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RuntimeException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">38</span>
<span class="ln">39</span>    <span class="o">}</span>
<span class="ln">40</span>	<span class="c1">//执行一些集中清理的工作
</span><span class="ln">41</span><span class="c1"></span>    <span class="n">mWmService</span><span class="o">.</span><span class="na">postWindowRemoveCleanupLocked</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
<span class="ln">42</span><span class="o">}</span>
</code></pre></div>

 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window61.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window61.png" >
  
    </a>
  
  
</div>

<h3 id="254与view相关总结">2.5.4与View相关总结</h3>
<h4 id="2541activity与-phonewindow与decorview关系">2.5.4.1activity与 PhoneWindow与DecorView关系</h4>
<p>DecorView是FrameLayout的子类， 它可以被认为是Android视图树的<strong>根节点视图</strong></p>
<h4 id="2542windowmanagerglobal--作用">2.5.4.2WindowManagerGlobal  作用</h4>
<p>设计模式中的<strong>桥接模式</strong>，在WindowManagerImpl和WMS之间起到了桥梁作用</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window62.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window62.png" >
  
    </a>
  
  
</div>

<h4 id="2543viewrootimpl--作用">2.5.4.3ViewRootImpl  作用</h4>
<ol>
<li>View树的树根并管理View树</li>
<li>触发View的测量、 布局和绘制</li>
<li>输入响应的中转站</li>
<li>负责与WMS进行进程间通信</li>
</ol>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window63.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window63.png" >
  
    </a>
  
  
</div>

<h4 id="2544viewviewgroup结构">2.5.4.4View/ViewGroup结构</h4>
<p>View/ViewGroup主要是树型结构</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window64.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window64.png" >
  
    </a>
  
  
</div>

<h4 id="2545绘制流程">2.5.4.5绘制流程</h4>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window65.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window65.png" >
  
    </a>
  
  
</div>

<h4 id="2546输入事件流程">2.5.4.6输入事件流程</h4>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window66.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window66.png" >
  
    </a>
  
  
</div>

<h4 id="2547wms通信">2.5.4.7WMS通信</h4>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window67.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window67.png" >
  
    </a>
  
  
</div>

<h4 id="2548屏幕刷新流程">2.5.4.8屏幕刷新流程</h4>
<p>ViewRootImpl会调用scheduleTraversals准备重绘， 但是，重绘一般不会立即执行， 而是往Choreographer的Choreographer.CALLBACK_TRAVERSAL队列中添加了一个mTraversalRunnable，同时申请VSYNC， 这个mTraversalRunnable要一直等到申请的VSYNC到来后才会被执行</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window25.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window25.png" >
  
    </a>
  
  
</div>



 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window53.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window53.png" >
  
    </a>
  
  
</div>

<h2 id="26补充window相关问题">2.6补充Window相关问题</h2>
<h3 id="261关于activity的xml怎么跟屏幕关联起来的">2.6.1关于activity的xml怎么跟屏幕关联起来的</h3>
<h4 id="2611performlaunchactivity">2.6.1.1performLaunchActivity</h4>
<p>这里从应用启动开始，加载ActivityThread调用<strong>performLaunchActivity</strong>方法中的onCreate，直接调用的应用的onCreate方法</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/core/java/android/app/ActivityThread.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">private</span> <span class="n">Activity</span> <span class="nf">performLaunchActivity</span><span class="o">(</span><span class="n">ActivityClientRecord</span> <span class="n">r</span><span class="o">,</span> <span class="n">Intent</span> <span class="n">customIntent</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 3</span>    <span class="o">...</span>
<span class="ln"> 4</span>    <span class="k">if</span> <span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">isPersistable</span><span class="o">())</span> <span class="o">{</span>
<span class="ln"> 5</span>        <span class="n">mInstrumentation</span><span class="o">.</span><span class="na">callActivityOnCreate</span><span class="o">(</span><span class="n">activity</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">state</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">persistentState</span><span class="o">);</span>
<span class="ln"> 6</span>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="ln"> 7</span>        <span class="n">mInstrumentation</span><span class="o">.</span><span class="na">callActivityOnCreate</span><span class="o">(</span><span class="n">activity</span><span class="o">,</span> <span class="n">r</span><span class="o">.</span><span class="na">state</span><span class="o">);</span>
<span class="ln"> 8</span>    <span class="o">}</span>
<span class="ln"> 9</span>    <span class="o">...</span>
<span class="ln">10</span><span class="o">}</span>
</code></pre></div><h4 id="2612apponcreate">2.6.1.2App#onCreate</h4>
<p>应用的代码如下</p>
<div class="highlight"><pre class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="ln"> 1</span><span class="c1">//App,这里用到的setContentView是AppCompatActivity中的
</span><span class="ln"> 2</span><span class="c1"></span><span class="k">class</span> <span class="nc">MainActivity</span> <span class="p">:</span> <span class="n">AppCompatActivity</span><span class="p">()</span> <span class="p">{</span>
<span class="ln"> 3</span>    <span class="k">private</span> <span class="k">lateinit</span> <span class="k">var</span> <span class="py">binding</span><span class="p">:</span> <span class="n">ActivityMainBinding</span>
<span class="ln"> 4</span>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">:</span> <span class="n">Bundle</span><span class="p">?)</span> <span class="p">{</span>
<span class="ln"> 5</span>        <span class="k">super</span><span class="p">.</span><span class="n">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">)</span>
<span class="ln"> 6</span>                <span class="c1">// 使用了 ViewBinding
</span><span class="ln"> 7</span><span class="c1"></span>        <span class="n">binding</span> <span class="p">=</span> <span class="n">ActivityMainBinding</span><span class="p">.</span><span class="n">inflate</span><span class="p">(</span><span class="n">layoutInflater</span><span class="p">)</span>
<span class="ln"> 8</span>                <span class="c1">// ① 加载 activity 的布局
</span><span class="ln"> 9</span><span class="c1"></span>        <span class="n">setContentView</span><span class="p">(</span><span class="n">binding</span><span class="p">.</span><span class="n">root</span><span class="p">)</span>
<span class="ln">10</span>    <span class="p">}</span>
<span class="ln">11</span><span class="p">}</span>
</code></pre></div><h4 id="2613appcompatactivitysetcontentview">2.6.1.3AppCompatActivity#setContentView</h4>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln">1</span><span class="c1">//androidx.appcompat:appcompat:1.3.12aar
</span><span class="ln">2</span><span class="c1">//androidx/appcompat/app/AppComPatActivity.java
</span><span class="ln">3</span><span class="c1"></span><span class="nd">@Override</span>
<span class="ln">4</span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">setContentView</span><span class="o">(</span><span class="n">View</span> <span class="n">view</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">5</span>    <span class="c1">//initViewTreeOwners方法作用
</span><span class="ln">6</span><span class="c1"></span>    <span class="c1">//在设置内容视图之前设置视图树所有者，以便膨胀过程和附加侦听器将看到它们已经存在
</span><span class="ln">7</span><span class="c1"></span>    <span class="n">initViewTreeOwners</span><span class="o">();</span>
<span class="ln">8</span>    <span class="n">getDelegate</span><span class="o">().</span><span class="na">setContentView</span><span class="o">(</span><span class="n">view</span><span class="o">);</span>
<span class="ln">9</span><span class="o">}</span>
</code></pre></div><p>getDelegate</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln">1</span><span class="c1">//androidx.appcompat:appcompat:1.3.12aar
</span><span class="ln">2</span><span class="c1">//androidx/appcompat/app/AppComPatActivity.java
</span><span class="ln">3</span><span class="c1"></span><span class="kd">public</span> <span class="n">AppCompatDelegate</span> <span class="nf">getDelegate</span><span class="o">()</span> <span class="o">{</span>
<span class="ln">4</span>    <span class="k">if</span> <span class="o">(</span><span class="n">mDelegate</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">5</span>        <span class="c1">//传入的两个参数都是AppComPatActivity
</span><span class="ln">6</span><span class="c1"></span>        <span class="n">mDelegate</span> <span class="o">=</span> <span class="n">AppCompatDelegate</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
<span class="ln">7</span>    <span class="o">}</span>
<span class="ln">8</span>    <span class="k">return</span> <span class="n">mDelegate</span><span class="o">;</span>
<span class="ln">9</span><span class="o">}</span>
</code></pre></div><p>AppCompatActivity 将很多事都委托给了别人，就是 AppCompatDelegateImpl</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln">1</span><span class="c1">//androidx.appcompat:appcompat:1.3.12aar
</span><span class="ln">2</span><span class="c1">//androidx/appcompat/app/AppCompatDelegate.java
</span><span class="ln">3</span><span class="c1"></span><span class="kd">public</span> <span class="kd">static</span> <span class="n">AppCompatDelegate</span> <span class="nf">create</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">Activity</span> <span class="n">activity</span><span class="o">,</span>
<span class="ln">4</span>                                       <span class="nd">@Nullable</span> <span class="n">AppCompatCallback</span> <span class="n">callback</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">5</span>    <span class="k">return</span> <span class="k">new</span> <span class="n">AppCompatDelegateImpl</span><span class="o">(</span><span class="n">activity</span><span class="o">,</span> <span class="n">callback</span><span class="o">);</span>
<span class="ln">6</span><span class="o">}</span>
</code></pre></div><h4 id="2614appcompatdelegateimplsetcontentview">2.6.1.4AppCompatDelegateImpl#setContentView</h4>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//androidx.appcompat:appcompat:1.3.12aar
</span><span class="ln"> 2</span><span class="c1">//androidx/appcompat/app/AppCompatDelegateImpl.java
</span><span class="ln"> 3</span><span class="c1"></span><span class="nd">@Override</span>
<span class="ln"> 4</span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">setContentView</span><span class="o">(</span><span class="n">View</span> <span class="n">v</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 5</span>    <span class="n">ensureSubDecor</span><span class="o">();</span>
<span class="ln"> 6</span>    <span class="n">ViewGroup</span> <span class="n">contentParent</span> <span class="o">=</span> <span class="n">mSubDecor</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">content</span><span class="o">);</span>
<span class="ln"> 7</span>    <span class="n">contentParent</span><span class="o">.</span><span class="na">removeAllViews</span><span class="o">();</span>
<span class="ln"> 8</span>    <span class="c1">//这里的addView跟动态添加View类似，都是父布局中添加布局，这的父布局是contentParent，子布局是v
</span><span class="ln"> 9</span><span class="c1"></span>    <span class="n">contentParent</span><span class="o">.</span><span class="na">addView</span><span class="o">(</span><span class="n">v</span><span class="o">);</span>
<span class="ln">10</span>    <span class="o">...</span>
<span class="ln">11</span><span class="o">}</span>
</code></pre></div><h4 id="2615appcompatdelegateimplensuresubdecor">2.6.1.5AppCompatDelegateImpl#ensureSubDecor</h4>
<p>创建一个 SubDecor，然后找到里面 id 为 content 的控件，将从 xml 创建出来的 View 添加到 content 里面去。</p>
<p>我们看看这个 SubDecor 是啥，创建 SubDecor 的逻辑也不多：</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//androidx.appcompat:appcompat:1.3.12aar
</span><span class="ln"> 2</span><span class="c1">//androidx/appcompat/app/AppCompatDelegateImpl.java
</span><span class="ln"> 3</span><span class="c1"></span><span class="kd">private</span> <span class="kt">void</span> <span class="nf">ensureSubDecor</span><span class="o">()</span> <span class="o">{</span>
<span class="ln"> 4</span>    <span class="k">if</span> <span class="o">(!</span><span class="n">mSubDecorInstalled</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 5</span>        <span class="n">mSubDecor</span> <span class="o">=</span> <span class="n">createSubDecor</span><span class="o">();</span>
<span class="ln"> 6</span>        <span class="o">...</span>
<span class="ln"> 7</span>    <span class="o">}</span>
<span class="ln"> 8</span><span class="o">}</span>
<span class="ln"> 9</span>
<span class="ln">10</span><span class="kd">private</span> <span class="n">ViewGroup</span> <span class="nf">createSubDecor</span><span class="o">()</span> <span class="o">{</span>
<span class="ln">11</span>    <span class="o">...</span>
<span class="ln">12</span>    <span class="c1">//下面会根据不同的情况去加载不同的布局，即应用布局并不是固定不变的   
</span><span class="ln">13</span><span class="c1"></span>    <span class="kd">final</span> <span class="n">LayoutInflater</span> <span class="n">inflater</span> <span class="o">=</span> <span class="n">LayoutInflater</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">mContext</span><span class="o">);</span>
<span class="ln">14</span>    <span class="n">ViewGroup</span> <span class="n">subDecor</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="ln">15</span>    <span class="k">if</span> <span class="o">(!</span><span class="n">mWindowNoTitle</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">16</span>        <span class="k">if</span> <span class="o">(</span><span class="n">mIsFloating</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">17</span>            <span class="c1">// If we&#39;re floating, inflate the dialog title decor
</span><span class="ln">18</span><span class="c1"></span>            <span class="n">subDecor</span> <span class="o">=</span> <span class="o">(</span><span class="n">ViewGroup</span><span class="o">)</span> <span class="n">inflater</span><span class="o">.</span><span class="na">inflate</span><span class="o">(</span>
<span class="ln">19</span>                <span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">abc_dialog_title_material</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
<span class="ln">20</span>        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">mHasActionBar</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">21</span>            <span class="n">subDecor</span> <span class="o">=</span> <span class="o">(</span><span class="n">ViewGroup</span><span class="o">)</span> <span class="n">LayoutInflater</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">themedContext</span><span class="o">)</span>
<span class="ln">22</span>                <span class="o">.</span><span class="na">inflate</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">abc_screen_toolbar</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
<span class="ln">23</span>
<span class="ln">24</span>            <span class="n">mDecorContentParent</span> <span class="o">=</span> <span class="o">(</span><span class="n">DecorContentParent</span><span class="o">)</span> <span class="n">subDecor</span>
<span class="ln">25</span>                <span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">decor_content_parent</span><span class="o">);</span>
<span class="ln">26</span>            <span class="n">mDecorContentParent</span><span class="o">.</span><span class="na">setWindowCallback</span><span class="o">(</span><span class="n">getWindowCallback</span><span class="o">());</span>
<span class="ln">27</span>            <span class="o">...</span>
<span class="ln">28</span>        <span class="o">}</span>
<span class="ln">29</span>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="ln">30</span>        <span class="k">if</span> <span class="o">(</span><span class="n">mOverlayActionMode</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">31</span>            <span class="n">subDecor</span> <span class="o">=</span> <span class="o">(</span><span class="n">ViewGroup</span><span class="o">)</span> <span class="n">inflater</span><span class="o">.</span><span class="na">inflate</span><span class="o">(</span>
<span class="ln">32</span>                <span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">abc_screen_simple_overlay_action_mode</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
<span class="ln">33</span>        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="ln">34</span>            <span class="c1">//本文是这里
</span><span class="ln">35</span><span class="c1"></span>            <span class="n">subDecor</span> <span class="o">=</span> <span class="o">(</span><span class="n">ViewGroup</span><span class="o">)</span> <span class="n">inflater</span><span class="o">.</span><span class="na">inflate</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">abc_screen_simple</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
<span class="ln">36</span>        <span class="o">}</span>
<span class="ln">37</span>    <span class="o">}</span>
<span class="ln">38</span>
<span class="ln">39</span>    <span class="k">return</span> <span class="n">subDecor</span><span class="o">;</span>
<span class="ln">40</span><span class="o">}</span>
</code></pre></div><p>首先它会根据设置的 theme 来加载不同的 layout，比如这里调试的发现它使用的是 R.layout.abc_screen_simple，搜索一下，发现它的内容如下：</p>
<div class="highlight"><pre class="chroma"><code class="language-xml" data-lang="xml"><span class="ln"> 1</span><span class="c">&lt;!--androidx.appcompat:appcompat:1.3.12aar --&gt;</span>
<span class="ln"> 2</span><span class="c">&lt;!--/res/layout/abc_screen_simple.xml --&gt;</span>
<span class="ln"> 3</span><span class="nt">&lt;androidx.appcompat.widget.FitWindowsLinearLayout</span>
<span class="ln"> 4</span>    <span class="na">xmlns:android=</span><span class="s">&#34;http://schemas.android.com/apk/res/android&#34;</span>
<span class="ln"> 5</span>    <span class="na">android:id=</span><span class="s">&#34;@+id/action_bar_root&#34;</span>
<span class="ln"> 6</span>    <span class="na">android:layout_width=</span><span class="s">&#34;match_parent&#34;</span>
<span class="ln"> 7</span>    <span class="na">android:layout_height=</span><span class="s">&#34;match_parent&#34;</span>
<span class="ln"> 8</span>    <span class="na">android:orientation=</span><span class="s">&#34;vertical&#34;</span>
<span class="ln"> 9</span>    <span class="na">android:fitsSystemWindows=</span><span class="s">&#34;true&#34;</span><span class="nt">&gt;</span>
<span class="ln">10</span>
<span class="ln">11</span>    <span class="nt">&lt;androidx.appcompat.widget.ViewStubCompat</span>
<span class="ln">12</span>        <span class="na">android:id=</span><span class="s">&#34;@+id/action_mode_bar_stub&#34;</span>
<span class="ln">13</span>        <span class="na">android:inflatedId=</span><span class="s">&#34;@+id/action_mode_bar&#34;</span>
<span class="ln">14</span>        <span class="na">android:layout=</span><span class="s">&#34;@layout/abc_action_mode_bar&#34;</span>
<span class="ln">15</span>        <span class="na">android:layout_width=</span><span class="s">&#34;match_parent&#34;</span>
<span class="ln">16</span>        <span class="na">android:layout_height=</span><span class="s">&#34;wrap_content&#34;</span> <span class="nt">/&gt;</span>
<span class="ln">17</span>
<span class="ln">18</span>    <span class="nt">&lt;include</span> <span class="na">layout=</span><span class="s">&#34;@layout/abc_screen_content_include&#34;</span> <span class="nt">/&gt;</span>
<span class="ln">19</span>
<span class="ln">20</span><span class="nt">&lt;/androidx.appcompat.widget.FitWindowsLinearLayout&gt;</span>
</code></pre></div><p>include 里面就是一个 androidx.appcompat.widget.ContentFrameLayout 没有其他布局。SubDecor 的整个布局如下</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window9.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window9.png" >
  
    </a>
  
  
</div>

<h4 id="2616appcompatdelegateimplcreatesubdecor">2.6.1.6AppCompatDelegateImpl#createSubDecor</h4>
<p>上面已经提到了subDecor的初步创建</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//androidx.appcompat:appcompat:1.3.12aar
</span><span class="ln"> 2</span><span class="c1">//androidx/appcompat/app/AppCompatDelegateImpl.java
</span><span class="ln"> 3</span><span class="c1"></span><span class="kd">private</span> <span class="n">ViewGroup</span> <span class="nf">createSubDecor</span><span class="o">()</span> <span class="o">{</span>
<span class="ln"> 4</span>    <span class="n">subDecor</span> <span class="o">=</span> <span class="o">(</span><span class="n">ViewGroup</span><span class="o">)</span> <span class="n">inflater</span><span class="o">.</span><span class="na">inflate</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">abc_screen_simple</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
<span class="ln"> 5</span>    <span class="o">...</span>
<span class="ln"> 6</span>    <span class="c1">//1.找到xml中的名称为action_bar_activity_content，类型为ContentFrameLayout的布局
</span><span class="ln"> 7</span><span class="c1"></span>    <span class="kd">final</span> <span class="n">ContentFrameLayout</span> <span class="n">contentView</span> <span class="o">=</span> <span class="o">(</span><span class="n">ContentFrameLayout</span><span class="o">)</span> <span class="n">subDecor</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span>
<span class="ln"> 8</span>        <span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">action_bar_activity_content</span><span class="o">);</span>
<span class="ln"> 9</span>    <span class="c1">//2.这个mWindow布局来自框架screen_simple.xml，找到对应的布局android.R.id.content
</span><span class="ln">10</span><span class="c1"></span>    <span class="kd">final</span> <span class="n">ViewGroup</span> <span class="n">windowContentView</span> <span class="o">=</span> <span class="o">(</span><span class="n">ViewGroup</span><span class="o">)</span> <span class="n">mWindow</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">content</span><span class="o">);</span>
<span class="ln">11</span>    <span class="k">if</span> <span class="o">(</span><span class="n">windowContentView</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">12</span>        <span class="c1">//3.这里是Window窗口的添加，具体见上文2.4
</span><span class="ln">13</span><span class="c1"></span>        <span class="k">while</span> <span class="o">(</span><span class="n">windowContentView</span><span class="o">.</span><span class="na">getChildCount</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">14</span>            <span class="kd">final</span> <span class="n">View</span> <span class="n">child</span> <span class="o">=</span> <span class="n">windowContentView</span><span class="o">.</span><span class="na">getChildAt</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
<span class="ln">15</span>            <span class="n">windowContentView</span><span class="o">.</span><span class="na">removeViewAt</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
<span class="ln">16</span>            <span class="n">contentView</span><span class="o">.</span><span class="na">addView</span><span class="o">(</span><span class="n">child</span><span class="o">);</span>
<span class="ln">17</span>        <span class="o">}</span>
<span class="ln">18</span>        <span class="c1">//4.将布局windowContentView对应的的id从android.R.id.content变成View.NO_ID
</span><span class="ln">19</span><span class="c1"></span>        <span class="n">windowContentView</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="n">View</span><span class="o">.</span><span class="na">NO_ID</span><span class="o">);</span>
<span class="ln">20</span>        <span class="c1">//5.将对应布局contentView中的id从R.id.action_bar_activity_content变成android.R.id.content
</span><span class="ln">21</span><span class="c1"></span>        <span class="n">contentView</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">content</span><span class="o">);</span>
<span class="ln">22</span>    <span class="o">}</span>
<span class="ln">23</span>    <span class="c1">//把子布局放到父布局中
</span><span class="ln">24</span><span class="c1"></span>    <span class="n">mWindow</span><span class="o">.</span><span class="na">setContentView</span><span class="o">(</span><span class="n">subDecor</span><span class="o">);</span>
<span class="ln">25</span>    <span class="k">return</span> <span class="n">subDecor</span><span class="o">;</span>
<span class="ln">26</span><span class="o">}</span>
</code></pre></div><p>其中abc_screen_simple.xml存在abc_screen_content_include布局，这个布局中有action_bar_activity_content布局</p>
<div class="highlight"><pre class="chroma"><code class="language-xml" data-lang="xml"><span class="ln"> 1</span><span class="c">&lt;!--androidx.appcompat:appcompat:1.3.12aar --&gt;</span>
<span class="ln"> 2</span><span class="c">&lt;!--/res/layout/abc_screen_content_include.xml --&gt;</span>
<span class="ln"> 3</span><span class="nt">&lt;merge</span> <span class="na">xmlns:android=</span><span class="s">&#34;http://schemas.android.com/apk/res/android&#34;</span><span class="nt">&gt;</span>
<span class="ln"> 4</span>
<span class="ln"> 5</span>    <span class="nt">&lt;androidx.appcompat.widget.ContentFrameLayout</span>
<span class="ln"> 6</span>            <span class="na">android:id=</span><span class="s">&#34;@id/action_bar_activity_content&#34;</span>
<span class="ln"> 7</span>            <span class="na">android:layout_width=</span><span class="s">&#34;match_parent&#34;</span>
<span class="ln"> 8</span>            <span class="na">android:layout_height=</span><span class="s">&#34;match_parent&#34;</span>
<span class="ln"> 9</span>            <span class="na">android:foregroundGravity=</span><span class="s">&#34;fill_horizontal|top&#34;</span>
<span class="ln">10</span>            <span class="na">android:foreground=</span><span class="s">&#34;?android:attr/windowContentOverlay&#34;</span> <span class="nt">/&gt;</span>
<span class="ln">11</span>
<span class="ln">12</span><span class="nt">&lt;/merge&gt;</span>
</code></pre></div><p>其中，上述的mWindow实际上PhoneWindow，mWindow.findViewById</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln">1</span><span class="c1">//frameworks/base/core/java/android/view/Window.java
</span><span class="ln">2</span><span class="c1">//可以得知这个mWindow布局是依托在DecorView中的
</span><span class="ln">3</span><span class="c1"></span><span class="nd">@Nullable</span>
<span class="ln">4</span><span class="kd">public</span> <span class="o">&lt;</span><span class="n">T</span> <span class="kd">extends</span> <span class="n">View</span><span class="o">&gt;</span> <span class="n">T</span> <span class="nf">findViewById</span><span class="o">(</span><span class="nd">@IdRes</span> <span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">5</span>    <span class="k">return</span> <span class="n">getDecorView</span><span class="o">().</span><span class="na">findViewById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
<span class="ln">6</span><span class="o">}</span>
</code></pre></div><p>getDecorView生成布局</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/core/java/com/android/internal/policy/PhoneWindow.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">protected</span> <span class="n">ViewGroup</span> <span class="nf">generateLayout</span><span class="o">(</span><span class="n">DecorView</span> <span class="n">decor</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 3</span>    <span class="c1">//这里桶前文createSubDecor类似，也是根据不同的情况生成对应的布局
</span><span class="ln"> 4</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">layoutResource</span><span class="o">;</span>
<span class="ln"> 5</span>    <span class="kt">int</span> <span class="n">features</span> <span class="o">=</span> <span class="n">getLocalFeatures</span><span class="o">();</span>
<span class="ln"> 6</span>    <span class="o">...</span>
<span class="ln"> 7</span>    <span class="k">if</span> <span class="o">((</span><span class="n">features</span> <span class="o">&amp;</span> <span class="o">(</span><span class="n">1</span> <span class="o">&lt;&lt;</span> <span class="n">FEATURE_NO_TITLE</span><span class="o">))</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 8</span>        <span class="c1">// If no other features and not embedded, only need a title.
</span><span class="ln"> 9</span><span class="c1"></span>        <span class="c1">// If the window is floating, we need a dialog layout
</span><span class="ln">10</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">mIsFloating</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">11</span>            <span class="n">TypedValue</span> <span class="n">res</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TypedValue</span><span class="o">();</span>
<span class="ln">12</span>            <span class="n">getContext</span><span class="o">().</span><span class="na">getTheme</span><span class="o">().</span><span class="na">resolveAttribute</span><span class="o">(</span>
<span class="ln">13</span>                <span class="n">R</span><span class="o">.</span><span class="na">attr</span><span class="o">.</span><span class="na">dialogTitleDecorLayout</span><span class="o">,</span> <span class="n">res</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
<span class="ln">14</span>            <span class="n">layoutResource</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="na">resourceId</span><span class="o">;</span>
<span class="ln">15</span>        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">features</span> <span class="o">&amp;</span> <span class="o">(</span><span class="n">1</span> <span class="o">&lt;&lt;</span> <span class="n">FEATURE_ACTION_BAR</span><span class="o">))</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">16</span>            <span class="n">layoutResource</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="na">getResourceId</span><span class="o">(</span>
<span class="ln">17</span>                <span class="n">R</span><span class="o">.</span><span class="na">styleable</span><span class="o">.</span><span class="na">Window_windowActionBarFullscreenDecorLayout</span><span class="o">,</span>
<span class="ln">18</span>                <span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">screen_action_bar</span><span class="o">);</span>
<span class="ln">19</span>        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="ln">20</span>            <span class="n">layoutResource</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">screen_title</span><span class="o">;</span>
<span class="ln">21</span>        <span class="o">}</span>
<span class="ln">22</span>    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">features</span> <span class="o">&amp;</span> <span class="o">(</span><span class="n">1</span> <span class="o">&lt;&lt;</span> <span class="n">FEATURE_ACTION_MODE_OVERLAY</span><span class="o">))</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">23</span>        <span class="n">layoutResource</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">screen_simple_overlay_action_mode</span><span class="o">;</span>
<span class="ln">24</span>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="ln">25</span>        <span class="c1">//本文的布局在这里
</span><span class="ln">26</span><span class="c1"></span>        <span class="n">layoutResource</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">screen_simple</span><span class="o">;</span>
<span class="ln">27</span>    <span class="o">}</span>
<span class="ln">28</span>    <span class="k">return</span> <span class="n">contentParent</span><span class="o">;</span>
<span class="ln">29</span><span class="o">}</span>
</code></pre></div><p>即getDecorView对应的布局是screen_simple.xml</p>
<div class="highlight"><pre class="chroma"><code class="language-xml" data-lang="xml"><span class="ln"> 1</span><span class="c">&lt;!--/frameworks/base/core/res/res/layout/screen_simple.xml --&gt;</span>
<span class="ln"> 2</span><span class="nt">&lt;LinearLayout</span> <span class="na">xmlns:android=</span><span class="s">&#34;http://schemas.android.com/apk/res/android&#34;</span>
<span class="ln"> 3</span>    <span class="na">android:layout_width=</span><span class="s">&#34;match_parent&#34;</span>
<span class="ln"> 4</span>    <span class="na">android:layout_height=</span><span class="s">&#34;match_parent&#34;</span>
<span class="ln"> 5</span>    <span class="na">android:fitsSystemWindows=</span><span class="s">&#34;true&#34;</span>
<span class="ln"> 6</span>    <span class="na">android:orientation=</span><span class="s">&#34;vertical&#34;</span><span class="nt">&gt;</span>
<span class="ln"> 7</span>    <span class="nt">&lt;ViewStub</span> <span class="na">android:id=</span><span class="s">&#34;@+id/action_mode_bar_stub&#34;</span>
<span class="ln"> 8</span>              <span class="na">android:inflatedId=</span><span class="s">&#34;@+id/action_mode_bar&#34;</span>
<span class="ln"> 9</span>              <span class="na">android:layout=</span><span class="s">&#34;@layout/action_mode_bar&#34;</span>
<span class="ln">10</span>              <span class="na">android:layout_width=</span><span class="s">&#34;match_parent&#34;</span>
<span class="ln">11</span>              <span class="na">android:layout_height=</span><span class="s">&#34;wrap_content&#34;</span>
<span class="ln">12</span>              <span class="na">android:theme=</span><span class="s">&#34;?attr/actionBarTheme&#34;</span> <span class="nt">/&gt;</span>
<span class="ln">13</span>    <span class="nt">&lt;FrameLayout</span>
<span class="ln">14</span>         <span class="na">android:id=</span><span class="s">&#34;@android:id/content&#34;</span>
<span class="ln">15</span>         <span class="na">android:layout_width=</span><span class="s">&#34;match_parent&#34;</span>
<span class="ln">16</span>         <span class="na">android:layout_height=</span><span class="s">&#34;match_parent&#34;</span>
<span class="ln">17</span>         <span class="na">android:foregroundInsidePadding=</span><span class="s">&#34;false&#34;</span>
<span class="ln">18</span>         <span class="na">android:foregroundGravity=</span><span class="s">&#34;fill_horizontal|top&#34;</span>
<span class="ln">19</span>         <span class="na">android:foreground=</span><span class="s">&#34;?android:attr/windowContentOverlay&#34;</span> <span class="nt">/&gt;</span>
<span class="ln">20</span><span class="nt">&lt;/LinearLayout&gt;</span>
</code></pre></div><blockquote>
<p>这里我们发现，subDecor 被添加到了 mContentParent 里面，mContentParent 是啥呢？它是DecorView里面的 id 叫 Content 的一个FrameLayout 控件。但是 subDecor 里面不也有一个 id 叫 Content 的控件吗？</p>
<p>这里解释一下，subDecor-content 在xml中的ID是 action_bar_activity_content，经过一番操作后，它的 id 会被代码替换成 R.id.content，而 decorView-content 控件的 id 被设置为了 NO_ID。由于 mContentParent  已经保存了 decorView-content 控件的引用，所以设置成 NO_ID 也没关系。</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window10.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window10.png" >
  
    </a>
  
  
</div>

</blockquote>
<h4 id="2617完整的界面的布局如下">2.6.1.7完整的界面的布局如下</h4>
<p>原理都是一样，只是使用AppCompatActivity继承的布局会多2层嵌套</p>
<p>应用程序继承<strong>Activity</strong></p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window11.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window11.png" >
  
    </a>
  
  
</div>

<p>应用程序继承<strong>AppCompatActivity</strong></p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window4.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window4.png" >
  
    </a>
  
  
</div>

<p>上屏流程如下</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window13.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window13.png" >
  
    </a>
  
  
</div>

<h3 id="262关于锁屏之后为什么看不到launcher">2.6.2关于锁屏之后为什么看不到Launcher</h3>
<p>锁屏理论上也只是一个window盖在最顶层，理论即使这个锁屏window透明，那么透看到的也是有桌面Activity的情况，但现实情况是我们只看到了壁纸，并没有看到桌面。</p>
<p>首先我们知道壁纸属于系统中一个特殊窗口，一直处于系统最底层。这个窗口在系统中有专门类进行他的显示情况</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln">1</span><span class="c1">//frameworks/services/core/java/com/android/server/wm/WallpaperController.java
</span><span class="ln">2</span><span class="c1"></span><span class="k">if</span> <span class="o">(</span><span class="n">DEBUG_WALLPAPER</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">3</span>    <span class="n">Slog</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;Wallpaper visibility: &#34;</span> <span class="o">+</span> <span class="n">visible</span> <span class="o">+</span> <span class="s">&#34; at display &#34;</span>
<span class="ln">4</span>            <span class="o">+</span> <span class="n">mDisplayContent</span><span class="o">.</span><span class="na">getDisplayId</span><span class="o">());</span>
<span class="ln">5</span><span class="o">}</span>
</code></pre></div><p>这里我们把DEBUG_WALLPAPER就可以把log打开了</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln"> 1</span>WindowManager: Win Window<span class="o">{</span>60c77f1 u0 ScreenDecorOverlayBottom<span class="o">}</span>: <span class="nv">isOnScreen</span><span class="o">=</span><span class="nb">true</span> <span class="nv">mDrawState</span><span class="o">=</span><span class="m">4</span>
<span class="ln"> 2</span>WindowManager: Win Window<span class="o">{</span>df0a78b u0 ScreenDecorOverlay<span class="o">}</span>: <span class="nv">isOnScreen</span><span class="o">=</span><span class="nb">true</span> <span class="nv">mDrawState</span><span class="o">=</span><span class="m">4</span>
<span class="ln"> 3</span>WindowManager: Win Window<span class="o">{</span>b7a35a u0 NavigationBar0<span class="o">}</span>: <span class="nv">isOnScreen</span><span class="o">=</span><span class="nb">true</span> <span class="nv">mDrawState</span><span class="o">=</span><span class="m">4</span>
<span class="ln"> 4</span>WindowManager: Win Window<span class="o">{</span>3cd76e8 u0 NotificationShade<span class="o">}</span>: <span class="nv">isOnScreen</span><span class="o">=</span><span class="nb">true</span> <span class="nv">mDrawState</span><span class="o">=</span><span class="m">4</span>
<span class="ln"> 5</span>WindowManager: Found wallpaper target: Window<span class="o">{</span>3cd76e8 u0 NotificationShade<span class="o">}</span>
<span class="ln"> 6</span>WindowManager: New wallpaper target: Window<span class="o">{</span>3cd76e8 u0 NotificationShade<span class="o">}</span> prevTarget: null
<span class="ln"> 7</span>WindowManager: Report new wp offset Window<span class="o">{</span>803c2b8 u0 com.android.systemui.ImageWallpaper<span class="o">}</span> <span class="nv">x</span><span class="o">=</span>0.0 <span class="nv">y</span><span class="o">=</span>0.5 <span class="nv">zoom</span><span class="o">=</span>0.0
<span class="ln"> 8</span>WindowManager: Wallpaper visibility: <span class="nb">true</span> at display <span class="m">0</span>
<span class="ln"> 9</span>WindowManager: Wallpaper token android.os.Binder@3a6eda2 <span class="nv">visible</span><span class="o">=</span><span class="nb">true</span>
<span class="ln">10</span>WindowManager: New wallpaper: <span class="nv">target</span><span class="o">=</span>Window<span class="o">{</span>3cd76e8 u0 NotificationShade<span class="o">}</span> <span class="nv">prev</span><span class="o">=</span>null
<span class="ln">11</span>WindowManager: powerPress: <span class="nv">eventTime</span><span class="o">=</span><span class="m">118823847</span> <span class="nv">interactive</span><span class="o">=</span><span class="nb">true</span> <span class="nv">count</span><span class="o">=</span><span class="m">0</span> <span class="nv">beganFromNonInteractive</span><span class="o">=</span><span class="nb">true</span> <span class="nv">mShortPressOnPowerBehavior</span><span class="o">=</span><span class="m">1</span>
</code></pre></div><p>打开后我们点亮锁屏和在桌面锁屏发现都有类似以下打印</p>
<p>WindowManager: Found wallpaper target: Window{3cd76e8 u0 NotificationShade}</p>
<p>看名字大家大概就知道这个log是在寻找一个wallpaper target:，而且找到的是NotificationShade即锁屏窗口</p>
<p>前面疑惑中就写到正常应该是桌面</p>
<p>WindowManager: Found wallpaper target: Window{8d79f3 u0 com.android.launcher3/com.android.launcher3.uioverrides.QuickstepLauncher}</p>
<p>这日志其实就可以给我们非常重要线索，可以找出对应代码在哪</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/services/core/java/com/android/server/wm/WallpaperController.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">final</span> <span class="kt">boolean</span> <span class="n">hasWallpaper</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="na">hasWallpaper</span><span class="o">()</span> <span class="o">||</span> <span class="n">animationWallpaper</span><span class="o">;</span>
<span class="ln"> 3</span><span class="kt">boolean</span> <span class="nf">hasWallpaper</span><span class="o">()</span> <span class="o">{</span>
<span class="ln"> 4</span>    <span class="k">return</span> <span class="o">(</span><span class="n">mAttrs</span><span class="o">.</span><span class="na">flags</span> <span class="o">&amp;</span> <span class="n">FLAG_SHOW_WALLPAPER</span><span class="o">)</span> <span class="o">!=</span> <span class="n">0</span>
<span class="ln"> 5</span>        <span class="o">||</span> <span class="o">(</span><span class="n">mActivityRecord</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">mActivityRecord</span><span class="o">.</span><span class="na">hasWallpaperBackgroudForLetterbox</span><span class="o">());</span>
<span class="ln"> 6</span><span class="o">}</span>
<span class="ln"> 7</span><span class="nl">https:</span><span class="c1">//blog.csdn.net/learnframework/article/details/127483545
</span><span class="ln"> 8</span><span class="c1"></span><span class="kd">private</span> <span class="kd">final</span> <span class="n">ToBooleanFunction</span><span class="o">&lt;</span><span class="n">WindowState</span><span class="o">&gt;</span> <span class="n">mFindWallpaperTargetFunction</span> <span class="o">=</span> <span class="n">w</span> <span class="o">-&gt;</span> <span class="o">{</span>
<span class="ln"> 9</span>    <span class="o">...</span>
<span class="ln">10</span>    <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">hasWallpaper</span> <span class="o">&amp;&amp;</span> <span class="n">w</span><span class="o">.</span><span class="na">isOnScreen</span><span class="o">()</span>
<span class="ln">11</span>    <span class="o">...</span>
<span class="ln">12</span><span class="o">};</span>
</code></pre></div><p>这里其实也就是判断window中是否有FLAG_SHOW_WALLPAPER属性，而且经过额外加log打印发现hasWallpaper值变化在锁屏window解锁前后</p>
<p>那么其实我们可以猜测是不是锁屏window会去动态改变自己的FLAG_SHOW_WALLPAPER属性，在有桌面显示时候锁屏的window实际是没有这个属性，在锁屏状态下是有这个属性。根据猜想去systemui代码中grep相关FLAG_SHOW_WALLPAPER关键字</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/packages/SystemUI/src/com/android/systemui/shade/NotificationShadeWindowControllerImpl.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">private</span> <span class="kt">void</span> <span class="nf">applyKeyguardFlags</span><span class="o">(</span><span class="n">State</span> <span class="n">state</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 3</span>    <span class="o">...</span>
<span class="ln"> 4</span>    <span class="k">if</span> <span class="o">((</span><span class="n">keyguardOrAod</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">state</span><span class="o">.</span><span class="na">mBackdropShowing</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">scrimsOccludingWallpaper</span><span class="o">)</span>
<span class="ln"> 5</span>        <span class="o">||</span> <span class="n">mKeyguardViewMediator</span><span class="o">.</span><span class="na">isAnimatingBetweenKeyguardAndSurfaceBehindOrWillBe</span><span class="o">())</span> <span class="o">{</span>
<span class="ln"> 6</span>        <span class="n">mLpChanged</span><span class="o">.</span><span class="na">flags</span> <span class="o">|=</span> <span class="n">LayoutParams</span><span class="o">.</span><span class="na">FLAG_SHOW_WALLPAPER</span><span class="o">;</span>
<span class="ln"> 7</span>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="ln"> 8</span>        <span class="n">mLpChanged</span><span class="o">.</span><span class="na">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LayoutParams</span><span class="o">.</span><span class="na">FLAG_SHOW_WALLPAPER</span><span class="o">;</span>
<span class="ln"> 9</span>    <span class="o">}</span>
<span class="ln">10</span><span class="o">}</span>
</code></pre></div><p>这里其实就是代表有锁屏时候需要有 mLpChanged.flags |= LayoutParams.FLAG_SHOW_WALLPAPER;</p>
<p>锁屏退出时清除锁屏的FLAG_SHOW_WALLPAPER</p>
<p>mLpChanged.flags &amp;= ~LayoutParams.FLAG_SHOW_WALLPAPER;</p>
<h3 id="263activity究竟对应几个window">2.6.3Activity究竟对应几个Window</h3>
<p>上面提到一个Activity对应一个PhoneWindow，那么为什么图还存在一个Activity可以出现两个Window，似乎有所矛盾</p>
<p>提到这个问题，我们必须要先复现当前问题</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>手机型号</td>
<td>红米K30pro</td>
</tr>
<tr>
<td>Android版本</td>
<td>Android10</td>
</tr>
<tr>
<td>测试场景</td>
<td>屏幕点亮的Launcher界面</td>
</tr>
<tr>
<td>后台应用</td>
<td>Wechat</td>
</tr>
</tbody>
</table>
<p>如下图所示</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window0.jpg" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window0.jpg" >
  
    </a>
  
  
</div>

<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="ln"> 1</span><span class="c1"># 这里输出简化表示</span>
<span class="ln"> 2</span>picasso:/ $ dumpsys window windows
<span class="ln"> 3</span>WINDOW MANAGER WINDOWS <span class="o">(</span>dumpsys window windows<span class="o">)</span>
<span class="ln"> 4</span>Window <span class="c1">#0 Window{54fd848 u0 InputMethod}:</span>
<span class="ln"> 5</span>  <span class="nv">mBaseLayer</span><span class="o">=</span><span class="m">141000</span> <span class="nv">mSubLayer</span><span class="o">=</span><span class="m">0</span>    <span class="nv">mToken</span><span class="o">=</span>WindowToken<span class="o">{</span>226fcc5 android.os.Binder@3f373c<span class="o">}</span>
<span class="ln"> 6</span>  <span class="nv">isVisible</span><span class="o">=</span><span class="nb">false</span>
<span class="ln"> 7</span>Window <span class="c1">#1 Window{6474d57 u0 RoundCorner}:</span>
<span class="ln"> 8</span>  <span class="nv">mBaseLayer</span><span class="o">=</span><span class="m">311000</span> <span class="nv">mSubLayer</span><span class="o">=</span><span class="m">0</span>    <span class="nv">mToken</span><span class="o">=</span>WindowToken<span class="o">{</span>7706d6 android.os.BinderProxy@359caf1<span class="o">}</span>
<span class="ln"> 9</span>  <span class="nv">isVisible</span><span class="o">=</span><span class="nb">true</span>
<span class="ln">10</span>Window <span class="c1">#2 Window{98435fe u0 RoundCorner}:</span>
<span class="ln">11</span>  <span class="nv">mBaseLayer</span><span class="o">=</span><span class="m">311000</span> <span class="nv">mSubLayer</span><span class="o">=</span><span class="m">0</span>    <span class="nv">mToken</span><span class="o">=</span>WindowToken<span class="o">{</span>a6ec0b2 android.os.BinderProxy@1af12bd<span class="o">}</span>
<span class="ln">12</span>  <span class="nv">isVisible</span><span class="o">=</span><span class="nb">true</span>
<span class="ln">13</span>Window <span class="c1">#3 Window{987738d u0 NavigationBar}:</span>
<span class="ln">14</span>  <span class="nv">mBaseLayer</span><span class="o">=</span><span class="m">231000</span> <span class="nv">mSubLayer</span><span class="o">=</span><span class="m">0</span>    <span class="nv">mToken</span><span class="o">=</span>WindowToken<span class="o">{</span>cdfac24 android.os.BinderProxy@1bf9cb7<span class="o">}</span>
<span class="ln">15</span>  <span class="nv">isVisible</span><span class="o">=</span><span class="nb">true</span>
<span class="ln">16</span>Window <span class="c1">#4 Window{85d4239 u0 StatusBar}:</span>
<span class="ln">17</span>  <span class="nv">mBaseLayer</span><span class="o">=</span><span class="m">181000</span> <span class="nv">mSubLayer</span><span class="o">=</span><span class="m">0</span>    <span class="nv">mToken</span><span class="o">=</span>WindowToken<span class="o">{</span>e3e1a00 android.os.BinderProxy@bf7a332<span class="o">}</span>
<span class="ln">18</span>  <span class="nv">isVisible</span><span class="o">=</span><span class="nb">true</span>
<span class="ln">19</span>Window <span class="c1">#5 Window{5c8904f u0 RoundCorner}:</span>
<span class="ln">20</span>  <span class="nv">mBaseLayer</span><span class="o">=</span><span class="m">171000</span> <span class="nv">mSubLayer</span><span class="o">=</span><span class="m">0</span>    <span class="nv">mToken</span><span class="o">=</span>WindowToken<span class="o">{</span>c281aae android.os.BinderProxy@485e729<span class="o">}</span>
<span class="ln">21</span>  <span class="nv">isVisible</span><span class="o">=</span><span class="nb">false</span>
<span class="ln">22</span>Window <span class="c1">#6 Window{e12503c u0 Aspect}:</span>
<span class="ln">23</span>  <span class="nv">mBaseLayer</span><span class="o">=</span><span class="m">111000</span> <span class="nv">mSubLayer</span><span class="o">=</span><span class="m">0</span>    <span class="nv">mToken</span><span class="o">=</span>WindowToken<span class="o">{</span>cb4622f android.os.BinderProxy@bba880e<span class="o">}</span>
<span class="ln">24</span>  <span class="nv">isVisible</span><span class="o">=</span><span class="nb">false</span>
<span class="ln">25</span>Window <span class="c1">#7 Window{31fbd71 u0 AssistPreviewPanel}:</span>
<span class="ln">26</span>  <span class="nv">mBaseLayer</span><span class="o">=</span><span class="m">41000</span> <span class="nv">mSubLayer</span><span class="o">=</span><span class="m">0</span>    <span class="nv">mToken</span><span class="o">=</span>WindowToken<span class="o">{</span>f8d1f18 android.os.BinderProxy@c09ec8a<span class="o">}</span>
<span class="ln">27</span>  <span class="nv">isVisible</span><span class="o">=</span><span class="nb">false</span>
<span class="ln">28</span>Window <span class="c1">#8 Window{67faf21 u0 DockedStackDivider}:</span>
<span class="ln">29</span>  <span class="nv">mBaseLayer</span><span class="o">=</span><span class="m">21000</span> <span class="nv">mSubLayer</span><span class="o">=</span><span class="m">0</span>    <span class="nv">mToken</span><span class="o">=</span>WindowToken<span class="o">{</span>f740988 android.os.BinderProxy@d47412b<span class="o">}</span>
<span class="ln">30</span>  <span class="nv">isVisible</span><span class="o">=</span><span class="nb">false</span>
<span class="ln">31</span>Window <span class="c1">#9 Window{19af82e u0 LauncherOverlayWindow:com.miui.personalassistant}:</span>
<span class="ln">32</span>  <span class="nv">mBaseLayer</span><span class="o">=</span><span class="m">21000</span> <span class="nv">mSubLayer</span><span class="o">=</span><span class="m">0</span>    <span class="nv">mToken</span><span class="o">=</span>AppWindowToken<span class="o">{</span>e921607 <span class="nv">token</span><span class="o">=</span>Token<span class="o">{</span>361c446 ActivityRecord<span class="o">{</span>6d5b688 u0 com.miui.home/.launcher.Launcher t1<span class="o">}}}</span>
<span class="ln">33</span>  <span class="nv">isVisible</span><span class="o">=</span><span class="nb">false</span>
<span class="ln">34</span>Window <span class="c1">#10 Window{6163c5a u0 com.miui.home/com.miui.home.launcher.Launcher}:</span>
<span class="ln">35</span>  <span class="nv">mBaseLayer</span><span class="o">=</span><span class="m">21000</span> <span class="nv">mSubLayer</span><span class="o">=</span><span class="m">0</span>    <span class="nv">mToken</span><span class="o">=</span>AppWindowToken<span class="o">{</span>e921607 <span class="nv">token</span><span class="o">=</span>Token<span class="o">{</span>361c446 ActivityRecord<span class="o">{</span>6d5b688 u0 com.miui.home/.launcher.Launcher t1<span class="o">}}}</span>
<span class="ln">36</span>  <span class="nv">isVisible</span><span class="o">=</span><span class="nb">true</span>
<span class="ln">37</span>Window <span class="c1">#11 Window{d7d87d0 u0 com.tencent.mm/com.tencent.mm.ui.LauncherUI}:</span>
<span class="ln">38</span>  <span class="nv">mBaseLayer</span><span class="o">=</span><span class="m">21000</span> <span class="nv">mSubLayer</span><span class="o">=</span><span class="m">0</span>    <span class="nv">mToken</span><span class="o">=</span>AppWindowToken<span class="o">{</span>e299b34 <span class="nv">token</span><span class="o">=</span>Token<span class="o">{</span>4ee9e07 ActivityRecord<span class="o">{</span>ebb6c46 u0 com.tencent.mm/.ui.LauncherUI t87<span class="o">}}}</span>
<span class="ln">39</span>  <span class="nv">isVisible</span><span class="o">=</span><span class="nb">false</span>
<span class="ln">40</span>Window <span class="c1">#12 Window{f63516 u0 com.android.keyguard.wallpaper.service.MiuiKeyguardLiveWallpaper}:</span>
<span class="ln">41</span>  <span class="nv">mBaseLayer</span><span class="o">=</span><span class="m">11000</span> <span class="nv">mSubLayer</span><span class="o">=</span><span class="m">0</span>    <span class="nv">mToken</span><span class="o">=</span>WallpaperWindowToken<span class="o">{</span>f661030 <span class="nv">token</span><span class="o">=</span>android.os.BinderProxy@3481973<span class="o">}</span>
<span class="ln">42</span>  <span class="nv">isVisible</span><span class="o">=</span><span class="nb">true</span>
<span class="ln">43</span>Window <span class="c1">#13 Window{cf10cf2 u0 com.android.systemui.ImageWallpaper}:</span>
<span class="ln">44</span>  <span class="nv">mBaseLayer</span><span class="o">=</span><span class="m">11000</span> <span class="nv">mSubLayer</span><span class="o">=</span><span class="m">0</span>    <span class="nv">mToken</span><span class="o">=</span>WallpaperWindowToken<span class="o">{</span>5182c91 <span class="nv">token</span><span class="o">=</span>android.os.Binder@2b356b8<span class="o">}</span>
<span class="ln">45</span>  <span class="nv">isVisible</span><span class="o">=</span><span class="nb">true</span>
</code></pre></div><p>可以看到有14个Window，但不是所有Window都显示的，只有7个Window才显示出来的，其中可以看到有9，10两个Window对应同一个WindowToken，并且mBaseLayer和mSubLayer都相同，根据上面的Window层级关系，实际上就是一个Activity会存在两个Window，似乎跟上文的一个一个Activity对应一个PhoneWindow矛盾了。</p>
<p>实际上不然，9和10两个Window这个Activity相同，WindowToken相同，这个类似悬浮窗，虽然是同一个Activity，前者9属于一个最小化的图标，后者10才是真正意义上的一个Activity对应一个PhoneWindow，这是一种<strong>Overlay机制</strong>。并且9通常是隐藏的，10才是可以显示出来的。Window可以两者存在，并且可以同时显示。</p>
<p>最终显示结果从上往下</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window7.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window7.png" >
  
    </a>
  
  
</div>

<h3 id="264activitydialogpopupwindow和toast-的window创建">2.6.4Activity、Dialog、PopupWindow和Toast 的Window创建</h3>
<h4 id="2641-activity的window创建">2.6.4.1 Activity的Window创建</h4>
<p>Activity在ActivityThread中调用performLaunchActivity方法中的Activity#attach</p>
<h5 id="26411activityattach">2.6.4.1.1Activity#attach</h5>
<p>通过代码可以知道在 attach 方法中，创建了 Window</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/core/java/android/app/Activity.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">private</span> <span class="n">Window</span> <span class="n">mWindow</span><span class="o">;</span>
<span class="ln"> 3</span><span class="kd">final</span> <span class="kt">void</span> <span class="nf">attach</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">ActivityThread</span> <span class="n">aThread</span><span class="o">,</span>
<span class="ln"> 4</span>            <span class="n">Instrumentation</span> <span class="n">instr</span><span class="o">,</span> <span class="n">IBinder</span> <span class="n">token</span><span class="o">,</span> <span class="kt">int</span> <span class="n">ident</span><span class="o">,</span>
<span class="ln"> 5</span>            <span class="n">Application</span> <span class="n">application</span><span class="o">,</span> <span class="n">Intent</span> <span class="n">intent</span><span class="o">,</span> <span class="n">ActivityInfo</span> <span class="n">info</span><span class="o">,</span>
<span class="ln"> 6</span>            <span class="n">CharSequence</span> <span class="n">title</span><span class="o">,</span> <span class="n">Activity</span> <span class="n">parent</span><span class="o">,</span> <span class="n">String</span> <span class="n">id</span><span class="o">,</span>
<span class="ln"> 7</span>            <span class="n">NonConfigurationInstances</span> <span class="n">lastNonConfigurationInstances</span><span class="o">,</span>
<span class="ln"> 8</span>            <span class="n">Configuration</span> <span class="n">config</span><span class="o">,</span> <span class="n">String</span> <span class="n">referrer</span><span class="o">,</span> <span class="n">IVoiceInteractor</span> <span class="n">voiceInteractor</span><span class="o">,</span>
<span class="ln"> 9</span>            <span class="n">Window</span> <span class="n">window</span><span class="o">,</span> <span class="n">ActivityConfigCallback</span> <span class="n">activityConfigCallback</span><span class="o">,</span> <span class="n">IBinder</span> <span class="n">assistToken</span><span class="o">,</span>
<span class="ln">10</span>            <span class="n">IBinder</span> <span class="n">shareableActivityToken</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">11</span>	<span class="c1">//创建 PhoneWindow
</span><span class="ln">12</span><span class="c1"></span>    <span class="n">mWindow</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PhoneWindow</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">window</span><span class="o">,</span> <span class="n">activityConfigCallback</span><span class="o">);</span>
<span class="ln">13</span>	<span class="o">...</span>
<span class="ln">14</span><span class="o">}</span>
</code></pre></div><h5 id="26412activitysetcontentview">2.6.4.1.2Activity#setContentView</h5>
<p>Activity 的视图是通过 setContentView 方法提供的，如果是AppCompatActivity类中的setContentView ，请参考2.6.1的流程，这里阐述直接的Activity 类中的setContentView</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln">1</span><span class="c1">//frameworks/base/core/java/android/app/Activity.java
</span><span class="ln">2</span><span class="c1"></span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">setContentView</span><span class="o">(</span><span class="nd">@LayoutRes</span> <span class="kt">int</span> <span class="n">layoutResID</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">3</span>    <span class="c1">//这里的getWindow对应PhoneWindow
</span><span class="ln">4</span><span class="c1"></span>    <span class="n">getWindow</span><span class="o">().</span><span class="na">setContentView</span><span class="o">(</span><span class="n">layoutResID</span><span class="o">);</span>
<span class="ln">5</span>    <span class="n">initWindowDecorActionBar</span><span class="o">();</span>
<span class="ln">6</span><span class="o">}</span>
</code></pre></div><h5 id="26413phonewindowsetcontentview">2.6.4.1.3PhoneWindow#setContentView</h5>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/core/java/com/android/internal/policy/PhoneWindow.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="nd">@Override</span>
<span class="ln"> 3</span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">setContentView</span><span class="o">(</span><span class="kt">int</span> <span class="n">layoutResID</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 4</span>    <span class="k">if</span> <span class="o">(</span><span class="n">mContentParent</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 5</span>        <span class="c1">// 1，创建 DecorView
</span><span class="ln"> 6</span><span class="c1"></span>        <span class="n">installDecor</span><span class="o">();</span>
<span class="ln"> 7</span>    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">hasFeature</span><span class="o">(</span><span class="n">FEATURE_CONTENT_TRANSITIONS</span><span class="o">))</span> <span class="o">{</span>
<span class="ln"> 8</span>        <span class="n">mContentParent</span><span class="o">.</span><span class="na">removeAllViews</span><span class="o">();</span>
<span class="ln"> 9</span>    <span class="o">}</span>
<span class="ln">10</span>
<span class="ln">11</span>    <span class="k">if</span> <span class="o">(</span><span class="n">hasFeature</span><span class="o">(</span><span class="n">FEATURE_CONTENT_TRANSITIONS</span><span class="o">))</span> <span class="o">{</span>
<span class="ln">12</span>        <span class="kd">final</span> <span class="n">Scene</span> <span class="n">newScene</span> <span class="o">=</span> <span class="n">Scene</span><span class="o">.</span><span class="na">getSceneForLayout</span><span class="o">(</span><span class="n">mContentParent</span><span class="o">,</span> <span class="n">layoutResID</span><span class="o">,</span>
<span class="ln">13</span>                                                       <span class="n">getContext</span><span class="o">());</span>
<span class="ln">14</span>        <span class="n">transitionTo</span><span class="o">(</span><span class="n">newScene</span><span class="o">);</span>
<span class="ln">15</span>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="ln">16</span>        <span class="c1">//2 添加 activity 的布局文件
</span><span class="ln">17</span><span class="c1"></span>        <span class="n">mLayoutInflater</span><span class="o">.</span><span class="na">inflate</span><span class="o">(</span><span class="n">layoutResID</span><span class="o">,</span> <span class="n">mContentParent</span><span class="o">);</span>
<span class="ln">18</span>    <span class="o">}</span>
<span class="ln">19</span>    <span class="n">mContentParent</span><span class="o">.</span><span class="na">requestApplyInsets</span><span class="o">();</span>
<span class="ln">20</span>    <span class="kd">final</span> <span class="n">Callback</span> <span class="n">cb</span> <span class="o">=</span> <span class="n">getCallback</span><span class="o">();</span>
<span class="ln">21</span>    <span class="k">if</span> <span class="o">(</span><span class="n">cb</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isDestroyed</span><span class="o">())</span> <span class="o">{</span>
<span class="ln">22</span>        <span class="c1">//通知 window 的callback 接口回调
</span><span class="ln">23</span><span class="c1"></span>        <span class="n">cb</span><span class="o">.</span><span class="na">onContentChanged</span><span class="o">();</span>
<span class="ln">24</span>    <span class="o">}</span>
<span class="ln">25</span>    <span class="n">mContentParentExplicitlySet</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
<span class="ln">26</span><span class="o">}</span>
</code></pre></div><p>如果没有 DecorView 就创建它，一般来说它内部包含了标题栏和内容栏，但是这个会随着主题的改变而发生改变。但是不管怎么样，内容栏是一定存在的，并且内容栏有固定的 id <code>content</code>，完整的 id 是 <code>android.R.id.content</code> 。</p>
<ol>
<li>通过 <code>generateDecor</code> 创建了 DecorView，接着会调用 <code>generateLayout</code> 来加载具体的布局文件到 DecorView 中，这个要加载的布局就和系统版本以及定义的主题有关了。加载完之后就会将内容区域的 View 返回出来，也就是 <code>mContentParent</code></li>
<li>将 activity 需要显示的布局添加到 <code>mcontentParent</code> 中</li>
<li>由于 activity 实现了 window 的callback 接口，这里表示 activity 的布局文件已经被添加到 decorView 的 mParentView 中了，于是通知 接口回调</li>
</ol>
<h5 id="26414-handlerresumeactivity">2.6.4.1.4 handlerResumeActivity</h5>
<p>ActivityThread 的 handlerResumeActivity 中，会调用 activity 的 onResume 方法，接着就会将 DecorView 添加到 Window 中</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="nd">@Override</span>
<span class="ln"> 2</span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleResumeActivity</span><span class="o">(</span><span class="n">ActivityClientRecord</span> <span class="n">r</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">finalStateRequest</span><span class="o">,</span>
<span class="ln"> 3</span>                                 <span class="kt">boolean</span> <span class="n">isForward</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">shouldSendCompatFakeFocus</span><span class="o">,</span> <span class="n">String</span> <span class="n">reason</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 4</span>    <span class="k">if</span> <span class="o">(!</span><span class="n">performResumeActivity</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">finalStateRequest</span><span class="o">,</span> <span class="n">reason</span><span class="o">))</span> <span class="o">{</span>
<span class="ln"> 5</span>        <span class="k">return</span><span class="o">;</span>
<span class="ln"> 6</span>    <span class="o">}</span>
<span class="ln"> 7</span>
<span class="ln"> 8</span>    <span class="kd">final</span> <span class="n">Activity</span> <span class="n">a</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="na">activity</span><span class="o">;</span>
<span class="ln"> 9</span>    <span class="k">if</span> <span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">window</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">a</span><span class="o">.</span><span class="na">mFinished</span> <span class="o">&amp;&amp;</span> <span class="n">willBeVisible</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">10</span>        <span class="n">r</span><span class="o">.</span><span class="na">window</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="na">activity</span><span class="o">.</span><span class="na">getWindow</span><span class="o">();</span>
<span class="ln">11</span>        <span class="n">View</span> <span class="n">decor</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="na">window</span><span class="o">.</span><span class="na">getDecorView</span><span class="o">();</span>
<span class="ln">12</span>        <span class="n">decor</span><span class="o">.</span><span class="na">setVisibility</span><span class="o">(</span><span class="n">View</span><span class="o">.</span><span class="na">INVISIBLE</span><span class="o">);</span>
<span class="ln">13</span>        <span class="n">ViewManager</span> <span class="n">wm</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="na">getWindowManager</span><span class="o">();</span>
<span class="ln">14</span>        <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span> <span class="n">l</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="na">window</span><span class="o">.</span><span class="na">getAttributes</span><span class="o">();</span>
<span class="ln">15</span>        <span class="n">a</span><span class="o">.</span><span class="na">mDecor</span> <span class="o">=</span> <span class="n">decor</span><span class="o">;</span>
<span class="ln">16</span>        <span class="c1">//这里可以看到type是TYPE_BASE_APPLICATION
</span><span class="ln">17</span><span class="c1"></span>        <span class="n">l</span><span class="o">.</span><span class="na">type</span> <span class="o">=</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">.</span><span class="na">TYPE_BASE_APPLICATION</span><span class="o">;</span>
<span class="ln">18</span>        <span class="n">l</span><span class="o">.</span><span class="na">softInputMode</span> <span class="o">|=</span> <span class="n">forwardBit</span><span class="o">;</span>
<span class="ln">19</span>        
<span class="ln">20</span>        <span class="k">if</span> <span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">mVisibleFromClient</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">21</span>            <span class="k">if</span> <span class="o">(!</span><span class="n">a</span><span class="o">.</span><span class="na">mWindowAdded</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">22</span>                <span class="n">a</span><span class="o">.</span><span class="na">mWindowAdded</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
<span class="ln">23</span>                <span class="c1">//这里就是addView流程了，不在展开描述
</span><span class="ln">24</span><span class="c1"></span>                <span class="n">wm</span><span class="o">.</span><span class="na">addView</span><span class="o">(</span><span class="n">decor</span><span class="o">,</span> <span class="n">l</span><span class="o">);</span>
<span class="ln">25</span>            <span class="o">}</span> 
<span class="ln">26</span>        <span class="o">}</span>
<span class="ln">27</span>    <span class="o">}</span>
<span class="ln">28</span><span class="o">}</span>
</code></pre></div><p>可以看到type类型是TYPE_BASE_APPLICATION，有上文的层级关系流程，在WindowManagerPolicy类中查找对应的主次层级的序号</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln">1</span><span class="c1">//frameworks/base/services/core/java/com/android/server/policy/WindowManagerPolicy.java
</span><span class="ln">2</span><span class="c1"></span><span class="k">default</span> <span class="kt">int</span> <span class="nf">getWindowLayerFromTypeLw</span><span class="o">(</span><span class="kt">int</span> <span class="n">type</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">canAddInternalSystemWindow</span><span class="o">,</span>
<span class="ln">3</span>                                     <span class="kt">boolean</span> <span class="n">roundedCornerOverlay</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">4</span>	<span class="o">...</span>
<span class="ln">5</span>    <span class="c1">//TYPE_BASE_APPLICATION值为1，正好在[1,99]范围内，返回APPLICATION_LAYER，值为2
</span><span class="ln">6</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">type</span> <span class="o">&gt;=</span> <span class="n">FIRST_APPLICATION_WINDOW</span> <span class="o">&amp;&amp;</span> <span class="n">type</span> <span class="o">&lt;=</span> <span class="n">LAST_APPLICATION_WINDOW</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">7</span>        <span class="k">return</span> <span class="n">APPLICATION_LAYER</span><span class="o">;</span>
<span class="ln">8</span>    <span class="o">}</span>
<span class="ln">9</span><span class="o">}</span>
</code></pre></div><p>即Activity所在层级为App层级，主层级为2</p>
<h4 id="2642dialog的window创建">2.6.4.2Dialog的Window创建</h4>
<h5 id="26421dialogdialog">2.6.4.2.1Dialog::Dialog</h5>
<p>Dialog 中创建 <code>Window</code> 是在其构造方法中完成</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/core/java/android/app/Dialog.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">private</span> <span class="kd">final</span> <span class="n">WindowManager</span> <span class="n">mWindowManager</span><span class="o">;</span>
<span class="ln"> 3</span><span class="kd">final</span> <span class="n">Context</span> <span class="n">mContext</span><span class="o">;</span>
<span class="ln"> 4</span><span class="kd">final</span> <span class="n">Window</span> <span class="n">mWindow</span><span class="o">;</span>
<span class="ln"> 5</span>
<span class="ln"> 6</span><span class="kd">public</span> <span class="nf">Dialog</span><span class="o">(</span><span class="nd">@UiContext</span> <span class="nd">@NonNull</span> <span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="nd">@StyleRes</span> <span class="kt">int</span> <span class="n">themeResId</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 7</span>    <span class="k">this</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">themeResId</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
<span class="ln"> 8</span><span class="o">}</span>
<span class="ln"> 9</span>
<span class="ln">10</span><span class="n">Dialog</span><span class="o">(</span><span class="nd">@UiContext</span> <span class="nd">@NonNull</span> <span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="nd">@StyleRes</span> <span class="kt">int</span> <span class="n">themeResId</span><span class="o">,</span>
<span class="ln">11</span>       <span class="kt">boolean</span> <span class="n">createContextThemeWrapper</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">12</span>	<span class="c1">//获取 WindowManager
</span><span class="ln">13</span><span class="c1"></span>    <span class="n">mWindowManager</span> <span class="o">=</span> <span class="o">(</span><span class="n">WindowManager</span><span class="o">)</span> <span class="n">context</span><span class="o">.</span><span class="na">getSystemService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">WINDOW_SERVICE</span><span class="o">);</span>
<span class="ln">14</span>	<span class="c1">//创建 Window
</span><span class="ln">15</span><span class="c1"></span>    <span class="kd">final</span> <span class="n">Window</span> <span class="n">w</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PhoneWindow</span><span class="o">(</span><span class="n">mContext</span><span class="o">);</span>
<span class="ln">16</span>    <span class="n">mWindow</span> <span class="o">=</span> <span class="n">w</span><span class="o">;</span>
<span class="ln">17</span>    <span class="o">...</span>
<span class="ln">18</span><span class="o">}</span>
</code></pre></div><h5 id="26422dialogsetcontentview">2.6.4.2.2Dialog#setContentView</h5>
<p>初始化 DecorView，将 dialog 的视图添加到 DecorView 中。这个和 activity 的类似，都是通过 Window 去添加指定的布局文件</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln">1</span><span class="c1">//frameworks/base/core/java/android/app/Dialog.java
</span><span class="ln">2</span><span class="c1"></span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">setContentView</span><span class="o">(</span><span class="nd">@LayoutRes</span> <span class="kt">int</span> <span class="n">layoutResID</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">3</span>    <span class="n">mWindow</span><span class="o">.</span><span class="na">setContentView</span><span class="o">(</span><span class="n">layoutResID</span><span class="o">);</span>
<span class="ln">4</span><span class="o">}</span>
</code></pre></div><h5 id="26423dialogshow">2.6.4.2.3Dialog#show</h5>
<p>将 DecorView 添加到 Window 中显示</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln">1</span><span class="c1">//frameworks/base/core/java/android/app/Dialog.java
</span><span class="ln">2</span><span class="c1"></span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">show</span><span class="o">()</span> <span class="o">{</span>
<span class="ln">3</span>	<span class="c1">//...
</span><span class="ln">4</span><span class="c1"></span>    <span class="n">mDecor</span> <span class="o">=</span> <span class="n">mWindow</span><span class="o">.</span><span class="na">getDecorView</span><span class="o">();</span>
<span class="ln">5</span>    <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span> <span class="n">l</span> <span class="o">=</span> <span class="n">mWindow</span><span class="o">.</span><span class="na">getAttributes</span><span class="o">();</span>
<span class="ln">6</span>    <span class="n">mWindowManager</span><span class="o">.</span><span class="na">addView</span><span class="o">(</span><span class="n">mDecor</span><span class="o">,</span> <span class="n">l</span><span class="o">);</span>
<span class="ln">7</span>	<span class="c1">//发送回调消息
</span><span class="ln">8</span><span class="c1"></span>    <span class="n">sendShowMessage</span><span class="o">();</span>
<span class="ln">9</span><span class="o">}</span>
</code></pre></div><h5 id="26424mwindowgetattributes">2.6.4.2.4mWindow.getAttributes</h5>
<p>这里没有显示type类型，追溯mWindow.getAttributes()</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln">1</span><span class="c1">//frameworks/base/core/java/android/view/Window.java
</span><span class="ln">2</span><span class="c1"></span><span class="kd">private</span> <span class="kd">final</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span> <span class="n">mWindowAttributes</span> <span class="o">=</span>
<span class="ln">3</span>        <span class="k">new</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">();</span>
</code></pre></div><h5 id="26425windowmanagerlayoutparams构造">2.6.4.2.5WindowManager.LayoutParams构造</h5>
<p>这里可以看出默认如果没有设置type类型，默认的类型是TYPE_APPLICATION，跟上面Activity类似，都属于主层级为2</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln">1</span><span class="c1">//frameworks/base/core/java/android/view/WindowManager.java
</span><span class="ln">2</span><span class="c1"></span><span class="kd">public</span> <span class="nf">LayoutParams</span><span class="o">()</span> <span class="o">{</span>
<span class="ln">3</span>    <span class="kd">super</span><span class="o">(</span><span class="n">LayoutParams</span><span class="o">.</span><span class="na">MATCH_PARENT</span><span class="o">,</span> <span class="n">LayoutParams</span><span class="o">.</span><span class="na">MATCH_PARENT</span><span class="o">);</span>
<span class="ln">4</span>    <span class="n">type</span> <span class="o">=</span> <span class="n">TYPE_APPLICATION</span><span class="o">;</span>
<span class="ln">5</span>    <span class="n">format</span> <span class="o">=</span> <span class="n">PixelFormat</span><span class="o">.</span><span class="na">OPAQUE</span><span class="o">;</span>
<span class="ln">6</span><span class="o">}</span>
</code></pre></div><p>从上面几个步骤可以发现，Dialog 的 Window 创建和 Activity 的 Window 创建很类似，二者几乎没有什么区别。</p>
<h5 id="26426dialogdismissdialog">2.6.4.2.6Dialog#dismissDialog</h5>
<p>当 dialog 关闭时，它会通过 WindowManager来移除 DecorView</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/core/java/android/app/Dialog.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="nd">@UnsupportedAppUsage</span>
<span class="ln"> 3</span><span class="kt">void</span> <span class="nf">dismissDialog</span><span class="o">()</span> <span class="o">{</span>
<span class="ln"> 4</span>	<span class="o">...</span>
<span class="ln"> 5</span>    <span class="k">try</span> <span class="o">{</span>
<span class="ln"> 6</span>        <span class="c1">//移除操作
</span><span class="ln"> 7</span><span class="c1"></span>        <span class="n">mWindowManager</span><span class="o">.</span><span class="na">removeViewImmediate</span><span class="o">(</span><span class="n">mDecor</span><span class="o">);</span>
<span class="ln"> 8</span>    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
<span class="ln"> 9</span>        <span class="k">if</span> <span class="o">(</span><span class="n">mActionMode</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">10</span>            <span class="n">mActionMode</span><span class="o">.</span><span class="na">finish</span><span class="o">();</span>
<span class="ln">11</span>        <span class="o">}</span>
<span class="ln">12</span>        <span class="n">mDecor</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="ln">13</span>        <span class="n">mWindow</span><span class="o">.</span><span class="na">closeAllPanels</span><span class="o">();</span>
<span class="ln">14</span>        <span class="n">onStop</span><span class="o">();</span>
<span class="ln">15</span>        <span class="n">mShowing</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
<span class="ln">16</span>
<span class="ln">17</span>        <span class="n">sendDismissMessage</span><span class="o">();</span>
<span class="ln">18</span>    <span class="o">}</span>
<span class="ln">19</span><span class="o">}</span>
</code></pre></div><p>普通的 Dialog 有一个特殊的地方，就是必须采用 Activity 的 Context，如果采用 Application 的 Context，就会报错。</p>
<p>错误信息很明确，是没有 Token 导致的，而 Token 一般只有 Activity 拥有，所以这里只需要用 Activity 作为 Context 即可。</p>
<div class="highlight"><pre class="chroma"><code class="language-txt" data-lang="txt"><span class="ln">1</span>Caused by: android.view.WindowManager$BadTokenException: Unable to add window -- token null is not valid; is your activity running?
</code></pre></div><h5 id="26427windowsettype">2.6.4.2.7window#setType</h5>
<p>系统 Window 比较特殊，他可以不需要 Token，我们可以将 Dialog 的 Window Type 修改为系统类型就可以了</p>
<p>可以调用Dialog实例化对象的window.setType()。Type类型可以是系统的<code>WindowManager.LayoutParams.TYPE_APPLICATION_OVERLAY</code>（对应主层级11）或者是<code>WindowManager.LayoutParams.TYPE_SYSTEM_ALERT</code>（对应主层级9）</p>
<p>额外需要申请需要申请悬浮窗权限即可</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln">1</span><span class="c1">//frameworks/base/core/java/android/view/Window.java
</span><span class="ln">2</span><span class="c1"></span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">setType</span><span class="o">(</span><span class="kt">int</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">3</span>    <span class="kd">final</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span> <span class="n">attrs</span> <span class="o">=</span> <span class="n">getAttributes</span><span class="o">();</span>
<span class="ln">4</span>    <span class="n">attrs</span><span class="o">.</span><span class="na">type</span> <span class="o">=</span> <span class="n">type</span><span class="o">;</span>
<span class="ln">5</span>    <span class="n">dispatchWindowAttributesChanged</span><span class="o">(</span><span class="n">attrs</span><span class="o">);</span>
<span class="ln">6</span><span class="o">}</span>
</code></pre></div><h4 id="2643popupwindow的window创建">2.6.4.3PopupWindow的Window创建</h4>
<h5 id="26431popupwindowpopupwindow">2.6.4.3.1PopupWindow#PopupWindow</h5>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/core/java/android/widget/PopupWindow.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">public</span> <span class="nf">PopupWindow</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">AttributeSet</span> <span class="n">attrs</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 3</span>    <span class="k">this</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">attrs</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">attr</span><span class="o">.</span><span class="na">popupWindowStyle</span><span class="o">);</span>
<span class="ln"> 4</span><span class="o">}</span>
<span class="ln"> 5</span>
<span class="ln"> 6</span><span class="kd">public</span> <span class="nf">PopupWindow</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">AttributeSet</span> <span class="n">attrs</span><span class="o">,</span> <span class="kt">int</span> <span class="n">defStyleAttr</span><span class="o">,</span> <span class="kt">int</span> <span class="n">defStyleRes</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 7</span>    <span class="n">mContext</span> <span class="o">=</span> <span class="n">context</span><span class="o">;</span>
<span class="ln"> 8</span>    <span class="n">mWindowManager</span> <span class="o">=</span> <span class="o">(</span><span class="n">WindowManager</span><span class="o">)</span> <span class="n">context</span><span class="o">.</span><span class="na">getSystemService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">WINDOW_SERVICE</span><span class="o">);</span>
<span class="ln"> 9</span>    <span class="o">...</span>
<span class="ln">10</span><span class="o">}</span>
</code></pre></div><h5 id="26432popupwindowsetcontentview">2.6.4.3.2PopupWindow#setContentView</h5>
<p>可以看到，和刚才看到的构造函数基本相同，保存了<code>ContentView</code>变量后，获取<code>Context</code>和<code>WindowManger</code>对象。</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/core/java/android/widget/PopupWindow.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">setContentView</span><span class="o">(</span><span class="n">View</span> <span class="n">contentView</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 3</span>    <span class="n">mContentView</span> <span class="o">=</span> <span class="n">contentView</span><span class="o">;</span>
<span class="ln"> 4</span>    <span class="k">if</span> <span class="o">(</span><span class="n">mContext</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">mContentView</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 5</span>        <span class="n">mContext</span> <span class="o">=</span> <span class="n">mContentView</span><span class="o">.</span><span class="na">getContext</span><span class="o">();</span>
<span class="ln"> 6</span>    <span class="o">}</span>
<span class="ln"> 7</span>
<span class="ln"> 8</span>    <span class="k">if</span> <span class="o">(</span><span class="n">mWindowManager</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">mContentView</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 9</span>        <span class="n">mWindowManager</span> <span class="o">=</span> <span class="o">(</span><span class="n">WindowManager</span><span class="o">)</span> <span class="n">mContext</span><span class="o">.</span><span class="na">getSystemService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">WINDOW_SERVICE</span><span class="o">);</span>
<span class="ln">10</span>    <span class="o">}</span>
<span class="ln">11</span>
<span class="ln">12</span>    <span class="k">if</span> <span class="o">(</span><span class="n">mContext</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mAttachedInDecorSet</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">13</span>
<span class="ln">14</span>        <span class="n">setAttachedInDecor</span><span class="o">(</span><span class="n">mContext</span><span class="o">.</span><span class="na">getApplicationInfo</span><span class="o">().</span><span class="na">targetSdkVersion</span>
<span class="ln">15</span>                           <span class="o">&gt;=</span> <span class="n">Build</span><span class="o">.</span><span class="na">VERSION_CODES</span><span class="o">.</span><span class="na">LOLLIPOP_MR1</span><span class="o">);</span>
<span class="ln">16</span>    <span class="o">}</span>
<span class="ln">17</span>
<span class="ln">18</span><span class="o">}</span>
</code></pre></div><h5 id="26433popupwindowshowasdropdown">2.6.4.3.3PopupWindow#showAsDropDown</h5>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/core/java/android/widget/PopupWindow.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">showAsDropDown</span><span class="o">(</span><span class="n">View</span> <span class="n">anchor</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 3</span>    <span class="n">showAsDropDown</span><span class="o">(</span><span class="n">anchor</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>
<span class="ln"> 4</span><span class="o">}</span>
<span class="ln"> 5</span>
<span class="ln"> 6</span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">showAsDropDown</span><span class="o">(</span><span class="n">View</span> <span class="n">anchor</span><span class="o">,</span> <span class="kt">int</span> <span class="n">xoff</span><span class="o">,</span> <span class="kt">int</span> <span class="n">yoff</span><span class="o">,</span> <span class="kt">int</span> <span class="n">gravity</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 7</span>    <span class="n">TransitionManager</span><span class="o">.</span><span class="na">endTransitions</span><span class="o">(</span><span class="n">mDecorView</span><span class="o">);</span>
<span class="ln"> 8</span>	<span class="c1">//绑定监听，设置变量
</span><span class="ln"> 9</span><span class="c1"></span>    <span class="n">attachToAnchor</span><span class="o">(</span><span class="n">anchor</span><span class="o">,</span> <span class="n">xoff</span><span class="o">,</span> <span class="n">yoff</span><span class="o">,</span> <span class="n">gravity</span><span class="o">);</span>
<span class="ln">10</span>
<span class="ln">11</span>    <span class="n">mIsShowing</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
<span class="ln">12</span>    <span class="n">mIsDropdown</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
<span class="ln">13</span>	<span class="c1">//创建LayoutParams
</span><span class="ln">14</span><span class="c1"></span>    <span class="kd">final</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span> <span class="n">p</span> <span class="o">=</span>
<span class="ln">15</span>        <span class="n">createPopupLayoutParams</span><span class="o">(</span><span class="n">anchor</span><span class="o">.</span><span class="na">getApplicationWindowToken</span><span class="o">());</span>
<span class="ln">16</span>    <span class="c1">//准备Popupwindow
</span><span class="ln">17</span><span class="c1"></span>    <span class="n">preparePopup</span><span class="o">(</span><span class="n">p</span><span class="o">);</span>
<span class="ln">18</span>
<span class="ln">19</span>    <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">aboveAnchor</span> <span class="o">=</span> <span class="n">findDropDownPosition</span><span class="o">(</span><span class="n">anchor</span><span class="o">,</span> <span class="n">p</span><span class="o">,</span> <span class="n">xoff</span><span class="o">,</span> <span class="n">yoff</span><span class="o">,</span>
<span class="ln">20</span>                                                     <span class="n">p</span><span class="o">.</span><span class="na">width</span><span class="o">,</span> <span class="n">p</span><span class="o">.</span><span class="na">height</span><span class="o">,</span> <span class="n">gravity</span><span class="o">,</span> <span class="n">mAllowScrollingAnchorParent</span><span class="o">);</span>
<span class="ln">21</span>    <span class="n">updateAboveAnchor</span><span class="o">(</span><span class="n">aboveAnchor</span><span class="o">);</span>
<span class="ln">22</span>    <span class="n">p</span><span class="o">.</span><span class="na">accessibilityIdOfAnchor</span> <span class="o">=</span> <span class="o">(</span><span class="n">anchor</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="n">anchor</span><span class="o">.</span><span class="na">getAccessibilityViewId</span><span class="o">()</span> <span class="o">:</span> <span class="o">-</span><span class="n">1</span><span class="o">;</span>
<span class="ln">23</span>	<span class="c1">//添加布局到Window中
</span><span class="ln">24</span><span class="c1"></span>    <span class="n">invokePopup</span><span class="o">(</span><span class="n">p</span><span class="o">);</span>
<span class="ln">25</span><span class="o">}</span>
</code></pre></div><h5 id="26434popupwindowcreatepopuplayoutparams">2.6.4.3.4PopupWindow#createPopupLayoutParams</h5>
<p>可以看到创建默认的LayoutParams时候类型为TYPE_APPLICATION_PANEL，说明PopupWindow是一个子Window，主层级关系就是2，次层级关系是1，也就是说会覆盖在App层级之上</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/core/java/android/widget/PopupWindow.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">private</span> <span class="kt">int</span> <span class="n">mWindowLayoutType</span> <span class="o">=</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">.</span><span class="na">TYPE_APPLICATION_PANEL</span><span class="o">;</span>
<span class="ln"> 3</span><span class="nd">@UnsupportedAppUsage</span>
<span class="ln"> 4</span><span class="kd">protected</span> <span class="kd">final</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span> <span class="nf">createPopupLayoutParams</span><span class="o">(</span><span class="n">IBinder</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 5</span>    <span class="kd">final</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span> <span class="n">p</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">();</span>
<span class="ln"> 6</span>
<span class="ln"> 7</span>    <span class="n">p</span><span class="o">.</span><span class="na">gravity</span> <span class="o">=</span> <span class="n">computeGravity</span><span class="o">();</span>
<span class="ln"> 8</span>    <span class="n">p</span><span class="o">.</span><span class="na">flags</span> <span class="o">=</span> <span class="n">computeFlags</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">flags</span><span class="o">);</span>
<span class="ln"> 9</span>    <span class="n">p</span><span class="o">.</span><span class="na">type</span> <span class="o">=</span> <span class="n">mWindowLayoutType</span><span class="o">;</span>
<span class="ln">10</span>    <span class="n">p</span><span class="o">.</span><span class="na">token</span> <span class="o">=</span> <span class="n">token</span><span class="o">;</span>
<span class="ln">11</span>    <span class="n">p</span><span class="o">.</span><span class="na">softInputMode</span> <span class="o">=</span> <span class="n">mSoftInputMode</span><span class="o">;</span>
<span class="ln">12</span>    <span class="n">p</span><span class="o">.</span><span class="na">windowAnimations</span> <span class="o">=</span> <span class="n">computeAnimationResource</span><span class="o">();</span>
<span class="ln">13</span>    
<span class="ln">14</span>    <span class="n">p</span><span class="o">.</span><span class="na">privateFlags</span> <span class="o">=</span> <span class="n">PRIVATE_FLAG_WILL_NOT_REPLACE_ON_RELAUNCH</span>
<span class="ln">15</span>        <span class="o">|</span> <span class="n">PRIVATE_FLAG_LAYOUT_CHILD_WINDOW_IN_PARENT_FRAME</span><span class="o">;</span>
<span class="ln">16</span>    <span class="k">return</span> <span class="n">p</span><span class="o">;</span>
<span class="ln">17</span><span class="o">}</span>
</code></pre></div><h5 id="26435popupwindowpreparepopup">2.6.4.3.5PopupWindow#preparePopup</h5>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/core/java/android/widget/PopupWindow.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="nd">@UnsupportedAppUsage</span>
<span class="ln"> 3</span><span class="kd">private</span> <span class="kt">void</span> <span class="nf">preparePopup</span><span class="o">(</span><span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span> <span class="n">p</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 4</span>    <span class="c1">//设置Background包裹
</span><span class="ln"> 5</span><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">mBackground</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 6</span>        <span class="n">mBackgroundView</span> <span class="o">=</span> <span class="n">createBackgroundView</span><span class="o">(</span><span class="n">mContentView</span><span class="o">);</span>
<span class="ln"> 7</span>        <span class="n">mBackgroundView</span><span class="o">.</span><span class="na">setBackground</span><span class="o">(</span><span class="n">mBackground</span><span class="o">);</span>
<span class="ln"> 8</span>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="ln"> 9</span>        <span class="n">mBackgroundView</span> <span class="o">=</span> <span class="n">mContentView</span><span class="o">;</span>
<span class="ln">10</span>    <span class="o">}</span>
<span class="ln">11</span>	<span class="c1">//这里创建根布局，包裹mBackground
</span><span class="ln">12</span><span class="c1"></span>    <span class="n">mDecorView</span> <span class="o">=</span> <span class="n">createDecorView</span><span class="o">(</span><span class="n">mBackgroundView</span><span class="o">);</span>
<span class="ln">13</span>    <span class="n">mDecorView</span><span class="o">.</span><span class="na">setIsRootNamespace</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
<span class="ln">14</span>    <span class="o">...</span>
<span class="ln">15</span><span class="o">}</span>
</code></pre></div><h5 id="26436popupwindowcreatebackgroundview">2.6.4.3.6PopupWindow#createBackgroundView</h5>
<p>显然它的布局就是PopupBackgroundView</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/core/java/android/widget/PopupWindow.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">private</span> <span class="n">PopupBackgroundView</span> <span class="nf">createBackgroundView</span><span class="o">(</span><span class="n">View</span> <span class="n">contentView</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 3</span>    <span class="kd">final</span> <span class="n">ViewGroup</span><span class="o">.</span><span class="na">LayoutParams</span> <span class="n">layoutParams</span> <span class="o">=</span> <span class="n">mContentView</span><span class="o">.</span><span class="na">getLayoutParams</span><span class="o">();</span>
<span class="ln"> 4</span>    <span class="kd">final</span> <span class="kt">int</span> <span class="n">height</span><span class="o">;</span>
<span class="ln"> 5</span>    <span class="k">if</span> <span class="o">(</span><span class="n">layoutParams</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">layoutParams</span><span class="o">.</span><span class="na">height</span> <span class="o">==</span> <span class="n">WRAP_CONTENT</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 6</span>        <span class="n">height</span> <span class="o">=</span> <span class="n">WRAP_CONTENT</span><span class="o">;</span>
<span class="ln"> 7</span>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="ln"> 8</span>        <span class="n">height</span> <span class="o">=</span> <span class="n">MATCH_PARENT</span><span class="o">;</span>
<span class="ln"> 9</span>    <span class="o">}</span>
<span class="ln">10</span>
<span class="ln">11</span>    <span class="kd">final</span> <span class="n">PopupBackgroundView</span> <span class="n">backgroundView</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PopupBackgroundView</span><span class="o">(</span><span class="n">mContext</span><span class="o">);</span>
<span class="ln">12</span>    <span class="kd">final</span> <span class="n">PopupBackgroundView</span><span class="o">.</span><span class="na">LayoutParams</span> <span class="n">listParams</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PopupBackgroundView</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">(</span>
<span class="ln">13</span>        <span class="n">MATCH_PARENT</span><span class="o">,</span> <span class="n">height</span><span class="o">);</span>
<span class="ln">14</span>    <span class="n">backgroundView</span><span class="o">.</span><span class="na">addView</span><span class="o">(</span><span class="n">contentView</span><span class="o">,</span> <span class="n">listParams</span><span class="o">);</span>
<span class="ln">15</span>
<span class="ln">16</span>    <span class="k">return</span> <span class="n">backgroundView</span><span class="o">;</span>
<span class="ln">17</span><span class="o">}</span>
</code></pre></div><h5 id="26437popupwindowcreatedecorview">2.6.4.3.7PopupWindow#createDecorView</h5>
<p>显然它的布局就是PopupDecorView</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/core/java/android/widget/PopupWindow.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">private</span> <span class="n">PopupDecorView</span> <span class="nf">createDecorView</span><span class="o">(</span><span class="n">View</span> <span class="n">contentView</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 3</span>    <span class="kd">final</span> <span class="n">ViewGroup</span><span class="o">.</span><span class="na">LayoutParams</span> <span class="n">layoutParams</span> <span class="o">=</span> <span class="n">mContentView</span><span class="o">.</span><span class="na">getLayoutParams</span><span class="o">();</span>
<span class="ln"> 4</span>    <span class="kd">final</span> <span class="kt">int</span> <span class="n">height</span><span class="o">;</span>
<span class="ln"> 5</span>    
<span class="ln"> 6</span>    <span class="k">if</span> <span class="o">(</span><span class="n">layoutParams</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">layoutParams</span><span class="o">.</span><span class="na">height</span> <span class="o">==</span> <span class="n">WRAP_CONTENT</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 7</span>        <span class="n">height</span> <span class="o">=</span> <span class="n">WRAP_CONTENT</span><span class="o">;</span>
<span class="ln"> 8</span>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="ln"> 9</span>        <span class="n">height</span> <span class="o">=</span> <span class="n">MATCH_PARENT</span><span class="o">;</span>
<span class="ln">10</span>    <span class="o">}</span>
<span class="ln">11</span>
<span class="ln">12</span>    <span class="kd">final</span> <span class="n">PopupDecorView</span> <span class="n">decorView</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PopupDecorView</span><span class="o">(</span><span class="n">mContext</span><span class="o">);</span>
<span class="ln">13</span>    <span class="n">decorView</span><span class="o">.</span><span class="na">addView</span><span class="o">(</span><span class="n">contentView</span><span class="o">,</span> <span class="n">MATCH_PARENT</span><span class="o">,</span> <span class="n">height</span><span class="o">);</span>
<span class="ln">14</span>    <span class="n">decorView</span><span class="o">.</span><span class="na">setClipChildren</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
<span class="ln">15</span>    <span class="n">decorView</span><span class="o">.</span><span class="na">setClipToPadding</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
<span class="ln">16</span>
<span class="ln">17</span>    <span class="k">return</span> <span class="n">decorView</span><span class="o">;</span>
<span class="ln">18</span><span class="o">}</span>
</code></pre></div>

 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window69.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window69.png" >
  
    </a>
  
  
</div>

<h5 id="26438popupwindowinvokepopup">2.6.4.3.8PopupWindow#invokePopup</h5>
<p>最终添加window，可以看出根布局是PopupDecorView，里面包裹着PopupBackgroundView，mContentView就是传入的View</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/core/java/android/widget/PopupWindow.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="nd">@UnsupportedAppUsage</span><span class="o">(</span><span class="n">maxTargetSdk</span> <span class="o">=</span> <span class="n">Build</span><span class="o">.</span><span class="na">VERSION_CODES</span><span class="o">.</span><span class="na">P</span><span class="o">)</span>
<span class="ln"> 3</span><span class="kd">private</span> <span class="kt">void</span> <span class="nf">invokePopup</span><span class="o">(</span><span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span> <span class="n">p</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 4</span>    <span class="k">if</span> <span class="o">(</span><span class="n">mContext</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 5</span>        <span class="n">p</span><span class="o">.</span><span class="na">packageName</span> <span class="o">=</span> <span class="n">mContext</span><span class="o">.</span><span class="na">getPackageName</span><span class="o">();</span>
<span class="ln"> 6</span>    <span class="o">}</span>
<span class="ln"> 7</span>
<span class="ln"> 8</span>    <span class="kd">final</span> <span class="n">PopupDecorView</span> <span class="n">decorView</span> <span class="o">=</span> <span class="n">mDecorView</span><span class="o">;</span>
<span class="ln"> 9</span>    <span class="n">decorView</span><span class="o">.</span><span class="na">setFitsSystemWindows</span><span class="o">(</span><span class="n">mLayoutInsetDecor</span><span class="o">);</span>
<span class="ln">10</span>
<span class="ln">11</span>    <span class="n">setLayoutDirectionFromAnchor</span><span class="o">();</span>
<span class="ln">12</span>	<span class="c1">//addView
</span><span class="ln">13</span><span class="c1"></span>    <span class="n">mWindowManager</span><span class="o">.</span><span class="na">addView</span><span class="o">(</span><span class="n">decorView</span><span class="o">,</span> <span class="n">p</span><span class="o">);</span>
<span class="ln">14</span>
<span class="ln">15</span>    <span class="k">if</span> <span class="o">(</span><span class="n">mEnterTransition</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">16</span>        <span class="n">decorView</span><span class="o">.</span><span class="na">requestEnterTransition</span><span class="o">(</span><span class="n">mEnterTransition</span><span class="o">);</span>
<span class="ln">17</span>    <span class="o">}</span>
<span class="ln">18</span><span class="o">}</span>
</code></pre></div><p>PopupWindow它是一个子Window，需要设置ContentView</p>
<p>利用自定义View包裹我们的ContentView，自定义View重写了键盘事件和触摸事件分发，实现了点击外部消失</p>
<p>最终利用WindowManger的addView加入布局，并没有创建新的Window</p>
<h4 id="2644toast的window创建">2.6.4.4Toast的Window创建</h4>
<p>Toast 也是基于 Window 来实现的，但是他的工作过程有些复杂。Toast有进程间的通信，Toast对应服务为NotificationManagerService和ITransientNotification。</p>
<p>Toast 属于系统 Window，内部视图有两种定义方式，一种是系统默认的，另一种是通过 setView 方法来指定一个 View(setView 方法在 android 11 以后已经废弃了，不会再展示自定义视图)，他们都对应 Toast 的一个内部成员 <code>mNextView</code>。</p>
<h5 id="26443toastmaketext">2.6.4.4.3Toast#makeText</h5>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/core/java/android/widget/Toast.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">public</span> <span class="kd">static</span> <span class="n">Toast</span> <span class="nf">makeText</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="n">Looper</span> <span class="n">looper</span><span class="o">,</span>
<span class="ln"> 3</span>                             <span class="nd">@NonNull</span> <span class="n">CharSequence</span> <span class="n">text</span><span class="o">,</span> <span class="nd">@Duration</span> <span class="kt">int</span> <span class="n">duration</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 4</span>    <span class="c1">//这里主要是构造[2.6.4.4.2]
</span><span class="ln"> 5</span><span class="c1"></span>    <span class="n">Toast</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Toast</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">looper</span><span class="o">);</span>
<span class="ln"> 6</span>
<span class="ln"> 7</span>    <span class="k">if</span> <span class="o">(</span><span class="n">Compatibility</span><span class="o">.</span><span class="na">isChangeEnabled</span><span class="o">(</span><span class="n">CHANGE_TEXT_TOASTS_IN_THE_SYSTEM</span><span class="o">))</span> <span class="o">{</span>
<span class="ln"> 8</span>        <span class="n">result</span><span class="o">.</span><span class="na">mText</span> <span class="o">=</span> <span class="n">text</span><span class="o">;</span>
<span class="ln"> 9</span>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="ln">10</span>        <span class="c1">//然后将mNextView赋值为getTextToastView[2.6.4.4.6]
</span><span class="ln">11</span><span class="c1"></span>        <span class="n">result</span><span class="o">.</span><span class="na">mNextView</span> <span class="o">=</span> <span class="n">ToastPresenter</span><span class="o">.</span><span class="na">getTextToastView</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">text</span><span class="o">);</span>
<span class="ln">12</span>    <span class="o">}</span>
<span class="ln">13</span>
<span class="ln">14</span>    <span class="n">result</span><span class="o">.</span><span class="na">mDuration</span> <span class="o">=</span> <span class="n">duration</span><span class="o">;</span>
<span class="ln">15</span>    <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
<span class="ln">16</span><span class="o">}</span>
</code></pre></div><h5 id="26442toasttoast">2.6.4.4.2Toast#Toast</h5>
<p>在Toast构造中，可以发现内部维护了一个mTN的类属性，里面还有回调的可扩容数组</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/core/java/android/widget/Toast.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">final</span> <span class="n">TN</span> <span class="n">mTN</span><span class="o">;</span>
<span class="ln"> 3</span><span class="kd">public</span> <span class="nf">Toast</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 4</span>    <span class="k">this</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
<span class="ln"> 5</span><span class="o">}</span>
<span class="ln"> 6</span>
<span class="ln"> 7</span><span class="kd">public</span> <span class="nf">Toast</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="n">Looper</span> <span class="n">looper</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 8</span>    <span class="c1">//context是外部App端调用传入的值
</span><span class="ln"> 9</span><span class="c1"></span>    <span class="n">mContext</span> <span class="o">=</span> <span class="n">context</span><span class="o">;</span>
<span class="ln">10</span>    <span class="n">mToken</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Binder</span><span class="o">();</span>
<span class="ln">11</span>    <span class="n">looper</span> <span class="o">=</span> <span class="n">getLooper</span><span class="o">(</span><span class="n">looper</span><span class="o">);</span>
<span class="ln">12</span>    <span class="n">mHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Handler</span><span class="o">(</span><span class="n">looper</span><span class="o">);</span>
<span class="ln">13</span>    <span class="c1">//回调的可扩容数组
</span><span class="ln">14</span><span class="c1"></span>    <span class="n">mCallbacks</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
<span class="ln">15</span>    <span class="n">mTN</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TN</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">context</span><span class="o">.</span><span class="na">getPackageName</span><span class="o">(),</span> <span class="n">mToken</span><span class="o">,</span>
<span class="ln">16</span>                 <span class="n">mCallbacks</span><span class="o">,</span> <span class="n">looper</span><span class="o">);</span>
<span class="ln">17</span>   <span class="o">...</span>
<span class="ln">18</span><span class="o">}</span>
</code></pre></div><h5 id="26443tntn">2.6.4.4.3TN#TN</h5>
<p>这里的ToastPresenter实例化对象很关键，是后续Toast内部维护View的桥梁，真正加载布局的地方</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/core/java/android/widget/Toast.java
</span><span class="ln"> 2</span><span class="c1">//这个就是上述服务类的实现，实现在Toast类的内部
</span><span class="ln"> 3</span><span class="c1"></span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">TN</span> <span class="kd">extends</span> <span class="n">ITransientNotification</span><span class="o">.</span><span class="na">Stub</span> <span class="o">{</span>
<span class="ln"> 4</span>    <span class="nd">@UnsupportedAppUsage</span><span class="o">(</span><span class="n">maxTargetSdk</span> <span class="o">=</span> <span class="n">Build</span><span class="o">.</span><span class="na">VERSION_CODES</span><span class="o">.</span><span class="na">P</span><span class="o">)</span>
<span class="ln"> 5</span>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span> <span class="n">mParams</span><span class="o">;</span>
<span class="ln"> 6</span>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">ToastPresenter</span> <span class="n">mPresenter</span><span class="o">;</span>
<span class="ln"> 7</span>    <span class="n">TN</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">String</span> <span class="n">packageName</span><span class="o">,</span> <span class="n">Binder</span> <span class="n">token</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Callback</span><span class="o">&gt;</span> <span class="n">callbacks</span><span class="o">,</span>
<span class="ln"> 8</span>       <span class="nd">@Nullable</span> <span class="n">Looper</span> <span class="n">looper</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 9</span>        <span class="n">IAccessibilityManager</span> <span class="n">accessibilityManager</span> <span class="o">=</span> <span class="n">IAccessibilityManager</span><span class="o">.</span><span class="na">Stub</span><span class="o">.</span><span class="na">asInterface</span><span class="o">(</span>
<span class="ln">10</span>            <span class="n">ServiceManager</span><span class="o">.</span><span class="na">getService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">ACCESSIBILITY_SERVICE</span><span class="o">));</span>
<span class="ln">11</span>        <span class="c1">//初始化ToastPresenter
</span><span class="ln">12</span><span class="c1"></span>        <span class="n">mPresenter</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ToastPresenter</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">accessibilityManager</span><span class="o">,</span> <span class="n">getService</span><span class="o">(),</span>
<span class="ln">13</span>                                        <span class="n">packageName</span><span class="o">);</span>
<span class="ln">14</span>        <span class="n">mParams</span> <span class="o">=</span> <span class="n">mPresenter</span><span class="o">.</span><span class="na">getLayoutParams</span><span class="o">();</span>
<span class="ln">15</span>        <span class="n">mPackageName</span> <span class="o">=</span> <span class="n">packageName</span><span class="o">;</span>
<span class="ln">16</span>        <span class="n">mToken</span> <span class="o">=</span> <span class="n">token</span><span class="o">;</span>
<span class="ln">17</span>        <span class="n">mCallbacks</span> <span class="o">=</span> <span class="n">callbacks</span><span class="o">;</span>
<span class="ln">18</span>        <span class="o">...</span>
<span class="ln">19</span>    <span class="o">}</span>
<span class="ln">20</span><span class="o">}</span>
</code></pre></div><h5 id="26444toastpresentertoastpresenter">2.6.4.4.4ToastPresenter#ToastPresenter</h5>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks_base/core/java/android/widget/ToastPresenter.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">public</span> <span class="nf">ToastPresenter</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">IAccessibilityManager</span> <span class="n">accessibilityManager</span><span class="o">,</span>
<span class="ln"> 3</span>                      <span class="n">INotificationManager</span> <span class="n">notificationManager</span><span class="o">,</span> <span class="n">String</span> <span class="n">packageName</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 4</span>    <span class="n">mContext</span> <span class="o">=</span> <span class="n">context</span><span class="o">;</span>
<span class="ln"> 5</span>    <span class="n">mResources</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getResources</span><span class="o">();</span>
<span class="ln"> 6</span>    <span class="n">mWindowManager</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getSystemService</span><span class="o">(</span><span class="n">WindowManager</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="ln"> 7</span>    <span class="n">mNotificationManager</span> <span class="o">=</span> <span class="n">notificationManager</span><span class="o">;</span>
<span class="ln"> 8</span>    <span class="n">mPackageName</span> <span class="o">=</span> <span class="n">packageName</span><span class="o">;</span>
<span class="ln"> 9</span>    <span class="n">mAccessibilityManager</span> <span class="o">=</span> <span class="n">accessibilityManager</span><span class="o">;</span>
<span class="ln">10</span>    <span class="c1">//创建默认的LayoutParams
</span><span class="ln">11</span><span class="c1"></span>    <span class="n">mParams</span> <span class="o">=</span> <span class="n">createLayoutParams</span><span class="o">();</span>
<span class="ln">12</span><span class="o">}</span>
</code></pre></div><h5 id="26445toastpresentercreatelayoutparams">2.6.4.4.5ToastPresenter#createLayoutParams</h5>
<p>找到Toast的window type类型为TYPE_TOAST，对应层级关系主层级为7。结果上面2.6.4.2的Dialog，如果没有设置Type那么Toast会在Dialog上面，如果设置系统Type，那么Dialog会覆盖Toast。</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks_base/core/java/android/widget/ToastPresenter.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">private</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span> <span class="nf">createLayoutParams</span><span class="o">()</span> <span class="o">{</span>
<span class="ln"> 3</span>    <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span> <span class="n">params</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">();</span>
<span class="ln"> 4</span>    <span class="n">params</span><span class="o">.</span><span class="na">height</span> <span class="o">=</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">.</span><span class="na">WRAP_CONTENT</span><span class="o">;</span>
<span class="ln"> 5</span>    <span class="n">params</span><span class="o">.</span><span class="na">width</span> <span class="o">=</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">.</span><span class="na">WRAP_CONTENT</span><span class="o">;</span>
<span class="ln"> 6</span>    <span class="n">params</span><span class="o">.</span><span class="na">format</span> <span class="o">=</span> <span class="n">PixelFormat</span><span class="o">.</span><span class="na">TRANSLUCENT</span><span class="o">;</span>
<span class="ln"> 7</span>    <span class="n">params</span><span class="o">.</span><span class="na">windowAnimations</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="na">style</span><span class="o">.</span><span class="na">Animation_Toast</span><span class="o">;</span>
<span class="ln"> 8</span>    <span class="c1">//这里的type类型是TYPE_TOAST
</span><span class="ln"> 9</span><span class="c1"></span>    <span class="n">params</span><span class="o">.</span><span class="na">type</span> <span class="o">=</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">.</span><span class="na">TYPE_TOAST</span><span class="o">;</span>
<span class="ln">10</span>    <span class="n">params</span><span class="o">.</span><span class="na">setFitInsetsIgnoringVisibility</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
<span class="ln">11</span>    <span class="n">params</span><span class="o">.</span><span class="na">setTitle</span><span class="o">(</span><span class="n">WINDOW_TITLE</span><span class="o">);</span>
<span class="ln">12</span>    <span class="n">params</span><span class="o">.</span><span class="na">flags</span> <span class="o">=</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">.</span><span class="na">FLAG_KEEP_SCREEN_ON</span>
<span class="ln">13</span>        <span class="o">|</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">.</span><span class="na">FLAG_NOT_FOCUSABLE</span>
<span class="ln">14</span>        <span class="o">|</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">.</span><span class="na">FLAG_NOT_TOUCHABLE</span><span class="o">;</span>
<span class="ln">15</span>    <span class="n">setShowForAllUsersIfApplicable</span><span class="o">(</span><span class="n">params</span><span class="o">,</span> <span class="n">mPackageName</span><span class="o">);</span>
<span class="ln">16</span>    <span class="k">return</span> <span class="n">params</span><span class="o">;</span>
<span class="ln">17</span><span class="o">}</span>
</code></pre></div><h5 id="26446toastpresentergettexttoastview">2.6.4.4.6ToastPresenter#getTextToastView</h5>
<p>这里可以发现Toast的布局，实际上是在ToastPresenter中添加对应布局，根布局为R.layout.transient_notification，我们所在的text就是内部的com.android.internal.R.id.message所在位置。</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln">1</span><span class="c1">//frameworks_base/core/java/android/widget/ToastPresenter.java
</span><span class="ln">2</span><span class="c1"></span><span class="nd">@VisibleForTesting</span>
<span class="ln">3</span><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">TEXT_TOAST_LAYOUT</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">transient_notification</span><span class="o">;</span>
<span class="ln">4</span><span class="kd">public</span> <span class="kd">static</span> <span class="n">View</span> <span class="nf">getTextToastView</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">CharSequence</span> <span class="n">text</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">5</span>    <span class="n">View</span> <span class="n">view</span> <span class="o">=</span> <span class="n">LayoutInflater</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">context</span><span class="o">).</span><span class="na">inflate</span><span class="o">(</span><span class="n">TEXT_TOAST_LAYOUT</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
<span class="ln">6</span>    <span class="n">TextView</span> <span class="n">textView</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">message</span><span class="o">);</span>
<span class="ln">7</span>    <span class="n">textView</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">text</span><span class="o">);</span>
<span class="ln">8</span>    <span class="k">return</span> <span class="n">view</span><span class="o">;</span>
<span class="ln">9</span><span class="o">}</span>
</code></pre></div><p>其中xml为</p>
<div class="highlight"><pre class="chroma"><code class="language-xml" data-lang="xml"><span class="ln"> 1</span><span class="c">&lt;!-- //frameworks/base/core/res/res/layout/transient_notification.xml--&gt;</span>
<span class="ln"> 2</span><span class="nt">&lt;LinearLayout</span>
<span class="ln"> 3</span>    <span class="na">xmlns:android=</span><span class="s">&#34;http://schemas.android.com/apk/res/android&#34;</span>
<span class="ln"> 4</span>    <span class="na">android:layout_width=</span><span class="s">&#34;wrap_content&#34;</span>
<span class="ln"> 5</span>    <span class="na">android:layout_height=</span><span class="s">&#34;wrap_content&#34;</span>
<span class="ln"> 6</span>    <span class="na">android:orientation=</span><span class="s">&#34;horizontal&#34;</span>
<span class="ln"> 7</span>    <span class="na">android:gravity=</span><span class="s">&#34;center_vertical&#34;</span>
<span class="ln"> 8</span>    <span class="na">android:maxWidth=</span><span class="s">&#34;@dimen/toast_width&#34;</span>
<span class="ln"> 9</span>    <span class="na">android:background=</span><span class="s">&#34;?android:attr/toastFrameBackground&#34;</span>
<span class="ln">10</span>    <span class="na">android:elevation=</span><span class="s">&#34;@dimen/toast_elevation&#34;</span>
<span class="ln">11</span>    <span class="na">android:layout_marginEnd=</span><span class="s">&#34;16dp&#34;</span>
<span class="ln">12</span>    <span class="na">android:layout_marginStart=</span><span class="s">&#34;16dp&#34;</span>
<span class="ln">13</span>    <span class="na">android:paddingStart=</span><span class="s">&#34;16dp&#34;</span>
<span class="ln">14</span>    <span class="na">android:paddingEnd=</span><span class="s">&#34;16dp&#34;</span><span class="nt">&gt;</span>
<span class="ln">15</span>
<span class="ln">16</span>    <span class="nt">&lt;TextView</span>
<span class="ln">17</span>        <span class="na">android:id=</span><span class="s">&#34;@android:id/message&#34;</span>
<span class="ln">18</span>        <span class="na">android:layout_width=</span><span class="s">&#34;wrap_content&#34;</span>
<span class="ln">19</span>        <span class="na">android:layout_height=</span><span class="s">&#34;wrap_content&#34;</span>
<span class="ln">20</span>        <span class="na">android:ellipsize=</span><span class="s">&#34;end&#34;</span>
<span class="ln">21</span>        <span class="na">android:maxLines=</span><span class="s">&#34;2&#34;</span>
<span class="ln">22</span>        <span class="na">android:paddingTop=</span><span class="s">&#34;12dp&#34;</span>
<span class="ln">23</span>        <span class="na">android:paddingBottom=</span><span class="s">&#34;12dp&#34;</span>
<span class="ln">24</span>        <span class="na">android:textAppearance=</span><span class="s">&#34;@style/TextAppearance.Toast&#34;</span><span class="nt">/&gt;</span>
<span class="ln">25</span><span class="nt">&lt;/LinearLayout&gt;</span>
</code></pre></div><h5 id="26447toastshow">2.6.4.4.7Toast#show</h5>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/core/java/android/widget/Toast.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">show</span><span class="o">()</span> <span class="o">{</span>
<span class="ln"> 3</span>    <span class="n">INotificationManager</span> <span class="n">service</span> <span class="o">=</span> <span class="n">getService</span><span class="o">();</span>
<span class="ln"> 4</span>    <span class="n">String</span> <span class="n">pkg</span> <span class="o">=</span> <span class="n">mContext</span><span class="o">.</span><span class="na">getOpPackageName</span><span class="o">();</span>
<span class="ln"> 5</span>    <span class="n">TN</span> <span class="n">tn</span> <span class="o">=</span> <span class="n">mTN</span><span class="o">;</span>
<span class="ln"> 6</span>    <span class="n">tn</span><span class="o">.</span><span class="na">mNextView</span> <span class="o">=</span> <span class="n">mNextView</span><span class="o">;</span>
<span class="ln"> 7</span>    <span class="kd">final</span> <span class="kt">int</span> <span class="n">displayId</span> <span class="o">=</span> <span class="n">mContext</span><span class="o">.</span><span class="na">getDisplayId</span><span class="o">();</span>
<span class="ln"> 8</span>
<span class="ln"> 9</span>    <span class="k">try</span> <span class="o">{</span>
<span class="ln">10</span>        <span class="k">if</span> <span class="o">(</span><span class="n">Compatibility</span><span class="o">.</span><span class="na">isChangeEnabled</span><span class="o">(</span><span class="n">CHANGE_TEXT_TOASTS_IN_THE_SYSTEM</span><span class="o">))</span> <span class="o">{</span>
<span class="ln">11</span>            <span class="k">if</span> <span class="o">(</span><span class="n">mNextView</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">12</span>                <span class="c1">//mNextView文字存在
</span><span class="ln">13</span><span class="c1"></span>                <span class="n">service</span><span class="o">.</span><span class="na">enqueueToast</span><span class="o">(</span><span class="n">pkg</span><span class="o">,</span> <span class="n">mToken</span><span class="o">,</span> <span class="n">tn</span><span class="o">,</span> <span class="n">mDuration</span><span class="o">,</span> <span class="n">displayId</span><span class="o">);</span>
<span class="ln">14</span>            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="ln">15</span>               <span class="o">...</span>
<span class="ln">16</span>            <span class="o">}</span>
<span class="ln">17</span>        <span class="o">}</span> 
<span class="ln">18</span>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">19</span>        <span class="c1">// Empty
</span><span class="ln">20</span><span class="c1"></span>    <span class="o">}</span>
<span class="ln">21</span><span class="o">}</span>
</code></pre></div><h5 id="26448notificationmanagerserviceenqueuetexttoast">2.6.4.4.8NotificationManagerService#enqueueTextToast</h5>
<p>上面代码中对给定应用的 toast 数量进行判断，如果超过 50 条，就直接退出，这是为了防止 DOS ，如果某个应用一直循环弹出 toast 就会导致其他应用无法弹出，这显然是不合理的。</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks_base/services/core/java/com/android/server/notification/NotificationManagerService.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="nd">@Override</span>
<span class="ln"> 3</span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">enqueueToast</span><span class="o">(</span><span class="n">String</span> <span class="n">pkg</span><span class="o">,</span> <span class="n">IBinder</span> <span class="n">token</span><span class="o">,</span> <span class="n">ITransientNotification</span> <span class="n">callback</span><span class="o">,</span>
<span class="ln"> 4</span>                         <span class="kt">int</span> <span class="n">duration</span><span class="o">,</span> <span class="kt">int</span> <span class="n">displayId</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 5</span>    <span class="n">enqueueToast</span><span class="o">(</span><span class="n">pkg</span><span class="o">,</span> <span class="n">token</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">callback</span><span class="o">,</span> <span class="n">duration</span><span class="o">,</span> <span class="n">displayId</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
<span class="ln"> 6</span><span class="o">}</span>
<span class="ln"> 7</span><span class="c1">//传入上面的callback，类型为ITransientNotificationCallback,指的是mTN
</span><span class="ln"> 8</span><span class="c1"></span><span class="kd">private</span> <span class="kt">void</span> <span class="nf">enqueueToast</span><span class="o">(</span><span class="n">String</span> <span class="n">pkg</span><span class="o">,</span> <span class="n">IBinder</span> <span class="n">token</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="n">CharSequence</span> <span class="n">text</span><span class="o">,</span>
<span class="ln"> 9</span>                          <span class="nd">@Nullable</span> <span class="n">ITransientNotification</span> <span class="n">callback</span><span class="o">,</span> <span class="kt">int</span> <span class="n">duration</span><span class="o">,</span> <span class="kt">int</span> <span class="n">displayId</span><span class="o">,</span>
<span class="ln">10</span>                          <span class="nd">@Nullable</span> <span class="n">ITransientNotificationCallback</span> <span class="n">textCallback</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">11</span>
<span class="ln">12</span>    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mToastQueue</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">13</span>        <span class="k">try</span> <span class="o">{</span>
<span class="ln">14</span>            <span class="c1">//创建对应的 ToastRecord
</span><span class="ln">15</span><span class="c1"></span>            <span class="n">ToastRecord</span> <span class="n">record</span><span class="o">;</span>
<span class="ln">16</span>            <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">indexOfToastLocked</span><span class="o">(</span><span class="n">pkg</span><span class="o">,</span> <span class="n">token</span><span class="o">);</span>
<span class="ln">17</span>            <span class="c1">// If it&#39;s already in the queue, we update it in place, we don&#39;t
</span><span class="ln">18</span><span class="c1"></span>            <span class="c1">// move it to the end of the queue.
</span><span class="ln">19</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">20</span>                <span class="c1">//实际上就是获取队列中的record元素
</span><span class="ln">21</span><span class="c1"></span>                <span class="n">record</span> <span class="o">=</span> <span class="n">mToastQueue</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
<span class="ln">22</span>                <span class="n">record</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">duration</span><span class="o">);</span>
<span class="ln">23</span>            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="ln">24</span>                <span class="o">...</span>
<span class="ln">25</span>                    <span class="c1">//如果超过 50 条，就直接退出    
</span><span class="ln">26</span><span class="c1"></span>                    <span class="k">if</span> <span class="o">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">MAX_PACKAGE_TOASTS</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">27</span>                        <span class="n">Slog</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;Package has already queued &#34;</span> <span class="o">+</span> <span class="n">count</span>
<span class="ln">28</span>                               <span class="o">+</span> <span class="s">&#34; toasts. Not showing more. Package=&#34;</span> <span class="o">+</span> <span class="n">pkg</span><span class="o">);</span>
<span class="ln">29</span>                        <span class="k">return</span><span class="o">;</span>
<span class="ln">30</span>                    <span class="o">}</span>
<span class="ln">31</span>                <span class="c1">//创建对应的 ToastRecord
</span><span class="ln">32</span><span class="c1"></span>                <span class="n">record</span> <span class="o">=</span> <span class="n">getToastRecord</span><span class="o">(</span><span class="n">callingUid</span><span class="o">,</span> <span class="n">callingPid</span><span class="o">,</span> <span class="n">pkg</span><span class="o">,</span> <span class="n">isSystemToast</span><span class="o">,</span> <span class="n">token</span><span class="o">,</span><span class="n">text</span><span class="o">,</span> <span class="n">callback</span><span class="o">,</span> <span class="n">duration</span><span class="o">,</span> <span class="n">windowToken</span><span class="o">,</span> <span class="n">displayId</span><span class="o">,</span> <span class="n">textCallback</span><span class="o">);</span>
<span class="ln">33</span>            <span class="o">}</span>
<span class="ln">34</span>            <span class="c1">// 0 表示只有一个 toast了，直接显示，否则就是还有toast，排队等待显示
</span><span class="ln">35</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">36</span>                <span class="n">showNextToastLocked</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
<span class="ln">37</span>            <span class="o">}</span>
<span class="ln">38</span>        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
<span class="ln">39</span>            <span class="n">Binder</span><span class="o">.</span><span class="na">restoreCallingIdentity</span><span class="o">(</span><span class="n">callingId</span><span class="o">);</span>
<span class="ln">40</span>        <span class="o">}</span>
<span class="ln">41</span>    <span class="o">}</span>
<span class="ln">42</span><span class="o">}</span>
</code></pre></div><h5 id="26449notificationmanagerservicegettoastrecord">2.6.4.4.9NotificationManagerService#getToastRecord</h5>
<p>说明这里的ToastRecord有两种类型，分别为TextToastRecord和CustomToastRecord，我们这里存在callback，所以为CustomToastRecord</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks_base/services/core/java/com/android/server/notification/NotificationManagerService.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">private</span> <span class="n">ToastRecord</span> <span class="nf">getToastRecord</span><span class="o">(</span><span class="kt">int</span> <span class="n">uid</span><span class="o">,</span> <span class="kt">int</span> <span class="n">pid</span><span class="o">,</span> <span class="n">String</span> <span class="n">packageName</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">isSystemToast</span><span class="o">,</span>
<span class="ln"> 3</span>                                   <span class="n">IBinder</span> <span class="n">token</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="n">CharSequence</span> <span class="n">text</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="n">ITransientNotification</span> <span class="n">callback</span><span class="o">,</span>
<span class="ln"> 4</span>                                   <span class="kt">int</span> <span class="n">duration</span><span class="o">,</span> <span class="n">Binder</span> <span class="n">windowToken</span><span class="o">,</span> <span class="kt">int</span> <span class="n">displayId</span><span class="o">,</span>
<span class="ln"> 5</span>                                   <span class="nd">@Nullable</span> <span class="n">ITransientNotificationCallback</span> <span class="n">textCallback</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 6</span>    <span class="k">if</span> <span class="o">(</span><span class="n">callback</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 7</span>        <span class="k">return</span> <span class="k">new</span> <span class="n">TextToastRecord</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">mStatusBar</span><span class="o">,</span> <span class="n">uid</span><span class="o">,</span> <span class="n">pid</span><span class="o">,</span> <span class="n">packageName</span><span class="o">,</span>
<span class="ln"> 8</span>                                   <span class="n">isSystemToast</span><span class="o">,</span> <span class="n">token</span><span class="o">,</span> <span class="n">text</span><span class="o">,</span> <span class="n">duration</span><span class="o">,</span> <span class="n">windowToken</span><span class="o">,</span> <span class="n">displayId</span><span class="o">,</span> <span class="n">textCallback</span><span class="o">);</span>
<span class="ln"> 9</span>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="ln">10</span>        <span class="k">return</span> <span class="k">new</span> <span class="n">CustomToastRecord</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">uid</span><span class="o">,</span> <span class="n">pid</span><span class="o">,</span> <span class="n">packageName</span><span class="o">,</span>
<span class="ln">11</span>                                     <span class="n">isSystemToast</span><span class="o">,</span> <span class="n">token</span><span class="o">,</span> <span class="n">callback</span><span class="o">,</span> <span class="n">duration</span><span class="o">,</span> <span class="n">windowToken</span><span class="o">,</span> <span class="n">displayId</span><span class="o">);</span>
<span class="ln">12</span>    <span class="o">}</span>
<span class="ln">13</span><span class="o">}</span>
</code></pre></div><h5 id="264410notificationmanagerserviceshownexttoastlocked">2.6.4.4.10NotificationManagerService#showNextToastLocked</h5>
<p>展示下一个Toast</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks_base/services/core/java/com/android/server/notification/NotificationManagerService.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="nd">@GuardedBy</span><span class="o">(</span><span class="s">&#34;mToastQueue&#34;</span><span class="o">)</span>
<span class="ln"> 3</span><span class="kt">void</span> <span class="nf">showNextToastLocked</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">lastToastWasTextRecord</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 4</span>    <span class="c1">//获取队头元素
</span><span class="ln"> 5</span><span class="c1"></span>    <span class="n">ToastRecord</span> <span class="n">record</span> <span class="o">=</span> <span class="n">mToastQueue</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
<span class="ln"> 6</span>    <span class="k">while</span> <span class="o">(</span><span class="n">record</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 7</span>        <span class="c1">//存在队头元素，处理元素
</span><span class="ln"> 8</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">tryShowToast</span><span class="o">(</span>
<span class="ln"> 9</span>            <span class="n">record</span><span class="o">,</span> <span class="n">rateLimitingEnabled</span><span class="o">,</span> <span class="n">isWithinQuota</span><span class="o">,</span> <span class="n">isPackageInForeground</span><span class="o">))</span> <span class="o">{</span>
<span class="ln">10</span>            <span class="n">scheduleDurationReachedLocked</span><span class="o">(</span><span class="n">record</span><span class="o">,</span> <span class="n">lastToastWasTextRecord</span><span class="o">);</span>
<span class="ln">11</span>            <span class="n">mIsCurrentToastShown</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
<span class="ln">12</span>            <span class="k">if</span> <span class="o">(</span><span class="n">rateLimitingEnabled</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isPackageInForeground</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">13</span>                <span class="n">mToastRateLimiter</span><span class="o">.</span><span class="na">noteEvent</span><span class="o">(</span><span class="n">userId</span><span class="o">,</span> <span class="n">record</span><span class="o">.</span><span class="na">pkg</span><span class="o">,</span> <span class="n">TOAST_QUOTA_TAG</span><span class="o">);</span>
<span class="ln">14</span>            <span class="o">}</span>
<span class="ln">15</span>            <span class="k">return</span><span class="o">;</span>
<span class="ln">16</span>        <span class="o">}</span>
<span class="ln">17</span>    <span class="o">}</span>
<span class="ln">18</span><span class="o">}</span>
<span class="ln">19</span>
<span class="ln">20</span><span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">tryShowToast</span><span class="o">(</span><span class="n">ToastRecord</span> <span class="n">record</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">rateLimitingEnabled</span><span class="o">,</span>
<span class="ln">21</span>                             <span class="kt">boolean</span> <span class="n">isWithinQuota</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">isPackageInForeground</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">22</span>    <span class="k">return</span> <span class="n">record</span><span class="o">.</span><span class="na">show</span><span class="o">();</span>
<span class="ln">23</span><span class="o">}</span>
</code></pre></div><h5 id="264411customtoastrecordshow">2.6.4.4.11CustomToastRecord#show</h5>
<p>显然，这里有回调到对应的Callback中，callback.show</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/services/core/java/com/android/server/notification/toast/CustomToastRecord.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">public</span> <span class="kd">final</span> <span class="n">ITransientNotification</span> <span class="n">callback</span><span class="o">;</span>
<span class="ln"> 3</span><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">show</span><span class="o">()</span> <span class="o">{</span>
<span class="ln"> 4</span>    <span class="k">if</span> <span class="o">(</span><span class="n">DBG</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 5</span>        <span class="n">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;Show pkg=&#34;</span> <span class="o">+</span> <span class="n">pkg</span> <span class="o">+</span> <span class="s">&#34; callback=&#34;</span> <span class="o">+</span> <span class="n">callback</span><span class="o">);</span>
<span class="ln"> 6</span>    <span class="o">}</span>
<span class="ln"> 7</span>    <span class="k">try</span> <span class="o">{</span>
<span class="ln"> 8</span>        <span class="c1">//这里的callback指的是mTN
</span><span class="ln"> 9</span><span class="c1"></span>        <span class="n">callback</span><span class="o">.</span><span class="na">show</span><span class="o">(</span><span class="n">windowToken</span><span class="o">);</span>
<span class="ln">10</span>        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="ln">11</span>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">12</span>		<span class="o">...</span>
<span class="ln">13</span>    <span class="o">}</span>
<span class="ln">14</span><span class="o">}</span>
</code></pre></div><h5 id="264412toasttnshow">2.6.4.4.12Toast#TN#show</h5>
<p>最终回调到Toast内部类TN的show</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="ln"> 1</span><span class="c1">//frameworks/base/core/java/android/widget/Toast.java
</span><span class="ln"> 2</span><span class="c1"></span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">TN</span> <span class="kd">extends</span> <span class="n">ITransientNotification</span><span class="o">.</span><span class="na">Stub</span> <span class="o">{</span>
<span class="ln"> 3</span>    <span class="nd">@Override</span>
<span class="ln"> 4</span>    <span class="nd">@UnsupportedAppUsage</span><span class="o">(</span><span class="n">maxTargetSdk</span> <span class="o">=</span> <span class="n">Build</span><span class="o">.</span><span class="na">VERSION_CODES</span><span class="o">.</span><span class="na">P</span><span class="o">,</span> <span class="n">trackingBug</span> <span class="o">=</span> <span class="n">115609023</span><span class="o">)</span>
<span class="ln"> 5</span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">show</span><span class="o">(</span><span class="n">IBinder</span> <span class="n">windowToken</span><span class="o">)</span> <span class="o">{</span>
<span class="ln"> 6</span>        <span class="k">if</span> <span class="o">(</span><span class="n">localLOGV</span><span class="o">)</span> <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;SHOW: &#34;</span> <span class="o">+</span> <span class="k">this</span><span class="o">);</span>
<span class="ln"> 7</span>        <span class="n">mHandler</span><span class="o">.</span><span class="na">obtainMessage</span><span class="o">(</span><span class="n">SHOW</span><span class="o">,</span> <span class="n">windowToken</span><span class="o">).</span><span class="na">sendToTarget</span><span class="o">();</span>
<span class="ln"> 8</span>    <span class="o">}</span>
<span class="ln"> 9</span><span class="o">}</span>
<span class="ln">10</span>
<span class="ln">11</span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleShow</span><span class="o">(</span><span class="n">IBinder</span> <span class="n">windowToken</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">12</span>    <span class="k">if</span> <span class="o">(</span><span class="n">mView</span> <span class="o">!=</span> <span class="n">mNextView</span><span class="o">)</span> <span class="o">{</span>
<span class="ln">13</span>        <span class="o">...</span>
<span class="ln">14</span>        <span class="c1">//最终在mPresenter中show
</span><span class="ln">15</span><span class="c1"></span>        <span class="n">mPresenter</span><span class="o">.</span><span class="na">show</span><span class="o">(</span><span class="n">mView</span><span class="o">,</span> <span class="n">mToken</span><span class="o">,</span> <span class="n">windowToken</span><span class="o">,</span> <span class="n">mDuration</span><span class="o">,</span> <span class="n">mGravity</span><span class="o">,</span> <span class="n">mX</span><span class="o">,</span> <span class="n">mY</span><span class="o">,</span>
<span class="ln">16</span>                        <span class="n">mHorizontalMargin</span><span class="o">,</span> <span class="n">mVerticalMargin</span><span class="o">,</span>
<span class="ln">17</span>                        <span class="k">new</span> <span class="n">CallbackBinder</span><span class="o">(</span><span class="n">getCallbacks</span><span class="o">(),</span> <span class="n">mHandler</span><span class="o">));</span>
<span class="ln">18</span>    <span class="o">}</span>
<span class="ln">19</span><span class="o">}</span>
</code></pre></div><p>Toast 的窗口类型是 <code>TYPE_TOAST</code>，属于系统类型，Toast 有自己的 <code>token</code>，不受 Activity 控制。</p>
<p>Toast 通过 WindowManager 将 view 直接添加到了 Window 中，并没有创建 <code>PhoneWindow</code> 和 <code>DecorView</code>，这点和 Activity 与 Dialog 不同。</p>
<h4 id="2645总结">2.6.4.5总结</h4>
<p>Activity和Dialog都会创建PhoneWindow和DecorView，即这两个是有根布局的，而Toast不创建PhoneWindow和DecorView，其根布局是transient_notification.xml。PopupWindow是子窗口，也没有所谓的PhoneWindow和DecorView，层级关系是主层级为2，子层级为1。</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window70.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window70.png" >
  
    </a>
  
  
</div>

<p>Activity和Dialog流程类似，详看2.6.1</p>
<p>PopupWindow流程</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window71.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window71.png" >
  
    </a>
  
  
</div>

<p>Toast流程</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window68.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window68.png" >
  
    </a>
  
  
</div>

<h1 id="3总结">3总结</h1>
<p>关于专业名词的罗列</p>
<table>
<thead>
<tr>
<th style="text-align:center">名称</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>Window</code></td>
<td>一个窗口，处理顶级窗口外观和行为策略的抽象类，这个窗口承载了需要绘制的<code>View</code></td>
</tr>
<tr>
<td style="text-align:center"><code>PhoneWindow</code></td>
<td><code>Window</code>的具体实现类</td>
</tr>
<tr>
<td style="text-align:center"><code>WindowManager</code></td>
<td>一个接口类，继承<code>ViewManager</code>，对<code>Window</code>进行管理</td>
</tr>
<tr>
<td style="text-align:center"><code>WindowManagerImpl</code></td>
<td><code>WindowManager</code>的具体实现类，一个<code>app</code>层面的<code>WMS</code>和<code>Window</code>的中间人</td>
</tr>
<tr>
<td style="text-align:center"><code>WMS(WindowManagerService)</code></td>
<td>真正对<code>Window</code>添加，负责管理窗口的启动、添加、删除、大小和层级、处理窗口的触摸事件、处理窗口之间切换动画等</td>
</tr>
<tr>
<td style="text-align:center"><code>WindowManagerGlobal</code></td>
<td>一个单例，一个进程只有一个实例，这里属于桥接模式</td>
</tr>
<tr>
<td style="text-align:center"><code>ViewRootImpl</code></td>
<td><code>Android</code> 视图层次结构的顶部，<code>View</code>树的树根并管理<code>View</code>树  ，但它<strong>不是View视图树</strong>的一部分。它是<code>DecorView </code> 和 <code>WindowManager</code> 之间的桥梁，是输入响应的中转站，并且触发View的测量、 布局和绘制</td>
</tr>
<tr>
<td style="text-align:center"><code>DecorView </code></td>
<td><code>FrameLayout</code>的子类，是<code>Android View</code>视图树的<strong>根布局</strong></td>
</tr>
<tr>
<td style="text-align:center"><code>Session</code></td>
<td>应用程序和<code>WMS</code>通信之间的通道，应用程序都会有一个<code>Session</code>，保存在<code>WMS</code>中的<code>mSessions</code></td>
</tr>
<tr>
<td style="text-align:center"><code>WindowContainer</code></td>
<td><code>Window</code>容器抽象，定义了一组可以直接或通过其子类以层次结构形式保存 <code>Window</code> 的类的常用功能。</td>
</tr>
<tr>
<td style="text-align:center"><code>WindowState</code></td>
<td><code>Window</code>容器，<code>WMS</code>管理的一个窗口，可以认为是<code>Window</code>容器在<code>WMS</code>中的一种<strong>事实窗口</strong>的表示</td>
</tr>
<tr>
<td style="text-align:center"><code>WindowToken</code></td>
<td><code>Window</code>容器，<code>WMS</code> 中一组<code> Window</code> 的容器，主要作用向<code>WMS</code>提供令牌、将属于同一个应用组件的窗口组织在一起</td>
</tr>
<tr>
<td style="text-align:center"><code>RootWindowContainer</code></td>
<td><code>Window</code>容器，根窗口容器。它的孩子是<code>DisplayContent</code></td>
</tr>
<tr>
<td style="text-align:center"><code>ActivityRecord</code></td>
<td><code>Window</code>容器，<code>WindowToken</code>的子类，<code>WMS</code>中一个<code>ActivityRecord</code>对象就代表一个<code>Activity</code>对象</td>
</tr>
<tr>
<td style="text-align:center"><code>WallpaperWindowToken</code></td>
<td><code>Window</code>容器，<code>WindowToken</code>的子类，用来存放和<code>Wallpaper</code>相关的窗口</td>
</tr>
<tr>
<td style="text-align:center"><code>DisplayContent.ImeContainer</code></td>
<td><code>Window</code>容器，<code>DisplayArea.Tokens</code>的子类，用来存放输入法相关的窗口</td>
</tr>
</tbody>
</table>
<p>根据android11和android13Window容器不同，这里区分开来</p>
<p>android11</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>DisplayContent</code></td>
<td><code>Window</code>容器，<code>Window</code>容器，管理一个逻辑屏上的所有窗口，有几个屏幕就会有几个<code>DisplayContent</code>，使用<code>displayId</code>来区分</td>
</tr>
<tr>
<td><code>WindowContainers</code></td>
<td><code>Window</code>容器，<code>DisplayContent</code>内部类，用于<code>App</code>中<code>Window</code>的管理集</td>
</tr>
<tr>
<td><code>NonAppWindowContainers</code></td>
<td><code>Window</code>容器，<code>DisplayContent</code>内部类，用于非<code>App</code>中<code>Window</code>的管理集</td>
</tr>
<tr>
<td><code>DisplayArea</code></td>
<td><code>Window</code>容器，<code>DisplayContent</code>之下的对<code>WindowContainer</code>进行分组的容器，受<code>DisplayAreaPolicy</code>管理</td>
</tr>
<tr>
<td><code>DisplayArea.Root</code></td>
<td><code>Window</code>容器，<code>App Window</code>的根容器</td>
</tr>
<tr>
<td><code>TaskDisplayArea</code></td>
<td><code>Window</code>容器，代表了屏幕上一块专门用来存放<code>App</code>窗口的区域</td>
</tr>
<tr>
<td><code>DisplayArea.Tokens</code></td>
<td><code>Window</code>容器，<code>DisplayArea</code>的内部类，一个只能包含<code>WindowToken</code>对象的<code>DisplayArea</code>类型的容器</td>
</tr>
<tr>
<td><code>Task</code></td>
<td><code>Window</code>容器，存放<code>ActivityRecord</code>的容器，用来管理<code>ActivityRecord</code></td>
</tr>
<tr>
<td><code>ActivityStack</code></td>
<td><code>Window</code>容器，<code>Task</code>的子类，用来记录<code>Activity</code>历史</td>
</tr>
</tbody>
</table>
<p>继承关系如下</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window6.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window6.png" >
  
    </a>
  
  
</div>

<p>android13</p>
<table>
<thead>
<tr>
<th style="text-align:center">名称</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>DisplayArea</code></td>
<td><code>Window</code>容器，<code>DisplayContent</code>之下的对<code>WindowContainer</code>进行分组的容器，受<code>DisplayAreaPolicy</code>管理</td>
</tr>
<tr>
<td style="text-align:center"><code>TaskDisplayArea</code></td>
<td><code>Window</code>容器，代表了屏幕上一块专门用来存放<code>App</code>窗口的区域</td>
</tr>
<tr>
<td style="text-align:center"><code>Task</code></td>
<td><code>Window</code>容器，存放<code>ActivityRecord</code>的容器，用来管理<code>ActivityRecord</code></td>
</tr>
<tr>
<td style="text-align:center"><code>DisplayArea.Tokens</code></td>
<td><code>Window</code>容器，<code>DisplayArea</code>的内部类，一个只能包含<code>WindowToken</code>对象的<code>DisplayArea</code>类型的容器</td>
</tr>
<tr>
<td style="text-align:center"><code>DisplayContent.ImeContainer</code></td>
<td><code>Window</code>容器，一个只能包含<code>WindowToken</code>对象的<code>DisplayArea</code>类型的容器，存放输入法窗口的容器</td>
</tr>
<tr>
<td style="text-align:center"><code>DisplayArea.Dimmable</code></td>
<td><code>Window</code>容器，<code>Dimmable</code>也是一个<code>DisplayArea</code>类型的<code>DisplayArea</code>容器，用于模糊效果。</td>
</tr>
<tr>
<td style="text-align:center"><code>RootDisplayArea</code></td>
<td><code>Window</code>容器，<code>DisplayArea</code>层级结构的根节点</td>
</tr>
<tr>
<td style="text-align:center"><code>DisplayContent</code></td>
<td><code>Window</code>容器，<code>Window</code>容器，管理一个逻辑屏上的所有窗口，有几个屏幕就会有几个<code>DisplayContent</code>，使用<code>displayId</code>来区分</td>
</tr>
<tr>
<td style="text-align:center"><code>DisplayAreaGroup</code></td>
<td><code>Window</code>容器，屏幕上的部分区域对应的<code>DisplayArea</code>层级结构的根节点，用于<strong>车载</strong></td>
</tr>
</tbody>
</table>
<p>继承关系如下</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window6_1.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window6_1.png" >
  
    </a>
  
  
</div>

<p><strong>关于Window和WIndow相关总结</strong></p>
<p>Window 的管理是基于 C/S 架构，依赖系统服务。服务端是 WMS ，客户端是 WindowManager 。</p>
<p>Window 的更新过程不涉及 WMS ，而添加和删除需要服务端与客户端一同合作，WindowManager 来请求执行，并处理 UI 渲染刷新，WMS 则是负责管理 Window 与系统其他能力结合。</p>
<p>Window 的概念不同于 View ，尽管看起来十分相似，但它们是两种概念。</p>
<ul>
<li>
<p>Window 代表一套视图树的容器，而 View 是视图树中的节点。</p>
</li>
<li>
<p>ViewRootImpl 是视图树对象。</p>
</li>
<li>
<p>WindowState 用来描述一个 Window。</p>
</li>
<li>
<p>WindowToken 用来表示一组 Window 的容器，可以代表 Activity 和嵌套窗口的父容器。</p>
</li>
</ul>
<p>WindowManager 是我们访问 Window 的入口，Window 的具体实现位于 <code>WindowManagerService</code> 中。<code>WindowManager</code> 和 <code>WindowManagerService</code> 交互是一个 IPC 的过程，最终的 IPC 是在 <code>RootViewImpl</code> 中完成的。</p>
<h1 id="4问题解答">4问题解答</h1>
<p>1）Window，WMS，Activity之间的联系（什么时候Window和Activity和WMS产生联系）</p>
<blockquote>
<p>时机：Activity和Window之间的联系是在Activity.attach的时候产生的。</p>
<p>其中new一个PhoneWindow对象并传入当前Activity引用，建立Window和Activity的一一对应关系。此Window是Window类的子类PhoneWindow的实例。Activity在Window中是以mContext属性存在。</p>
<p>时机：AMS和Window之间的联系是在addView/removeView产生的。通过</p>
</blockquote>
<p>2）Window和View区别和联系（什么时候Window和View产生联系）</p>
<blockquote>
<p>联系：每一个 Window 都对应着一个 View 和 一个 ViewRootImpl 。Window 表示一个窗口的概念，也是一个抽象的概念，它并不是实际存在的，它是以 View 的方式存在的。</p>
<p>区别：Window 的概念不同于 View ，尽管看起来十分相似，但它们是两种概念。Window 代表一套视图树的容器，而 View 是视图树中的节点。</p>
<p>时机：Window和View产生联系是在外部App调用AppCompatActivity#setContent时候，最终会生成DecorView。</p>
</blockquote>
<p>3）Window的类别和层次关系（为什么PopWindow会遮住App的显示，锁屏为什么看不到Launcher）</p>
<blockquote>
<p>Window分为不同容器，其中主要是WindowToken和WindowSate，一个ActivityRecord（WindowToken容器）可以包含多个WindowState容器。</p>
<p>每种不同的容器代表不同的层级，主要分成主层级和次层级，主层级分为[1,36]，次层级为[-2,-3]。主层级越大，离用户越近，主层级相同，次层级越大离用户越近。主层级主要看WindowToken相关容器，次层级主要看WindowState相关容器。</p>
<p>PopWindow会遮住App的显示：App主层级为2，次层级默认为0，popWindow是不能独立存在，也就是主层级和App相同为2，次层级为1大于App所在的Window，会遮住App显示</p>
<p>锁屏为什么看不到Launcher：锁屏之后显示的是锁屏界面，这个界面的主层级在App层之上，那么会遮住App的显示，即看不到Launcher。</p>
</blockquote>
<p>4）activity与 PhoneWindow与DecorView关系 （如果我添加一个View，会添加到系统层面去吗）</p>
<blockquote>
<p>PhoneWindow内部持有DecorView，而且所有跟当前Window相关的View处理，最终都在DecorView里面进行。</p>
<p>添加一个View，包括自定义View，实际上就是所在的DecorView里面添加的一个App层的布局，是不会跟系统层面相关的。</p>
</blockquote>
<h1 id="源码">源码</h1>
<p>查看方式可以直接访问下面的网站，点击<a href="http://aospxref.com/">这里</a></p>
<p>直接搜索对应变量或者方法名</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window1.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window1.png" >
  
    </a>
  
  
</div>

<p>除了上述方式之外，如果大量的查找相关的方法，上面的方式反而比较笨拙，可以下载对应的源码，/frameworks/base点击<a href="https://github1s.com/aosp-mirror/platform_frameworks_base">这里</a>，/frameworks/native点击<a href="https://github1s.com/GrapheneOS/platform_frameworks_native">这里</a></p>
<p>目前看来网页内置了VSCode，搜索还是联想确实会比直接在github上看快多了，不过有一个缺点就是直接打开文件功能比较弱</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window2.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window2.png" >
  
    </a>
  
  
</div>

<h1 id="demo下载">demo下载</h1>
<p>另外，处理本文举例的几个简单例子，可能有读者并没有android13的设备，可以下载笔者准备的几个demo，分析具体的Window容器、层级关系等，可以点击<a href="https://github.com/YangYang48/project/tree/master/window-13demo">这里</a>。</p>


 
  
  
  
  
    
  
    
      
    
  
    
      
    
  

<div class="figure center fig-100" >
  
    <a class="fancybox" href="https://yangyang48.github.io/WMS/window/window12.png" data-fancybox-group="">
  
    <img class="fig-img" src="https://yangyang48.github.io/WMS/window/window12.png" >
  
    </a>
  
  
</div>

<h1 id="参考">参考</h1>
<p>源码下载</p>
<p><a href="https://www.bbsmax.com/A/D8548N7w5E/">[1] 星辰之力, 官网 Android framework源码git地址, 2022.</a></p>
<p><a href="https://github.com/GrapheneOS/platform_frameworks_native">[2] GrapheneOS, Android framework_native, 2023.</a></p>
<p><a href="https://github.com/aosp-mirror/platform_frameworks_base">[3] aosp-mirror, Android framework_base, 2023.</a></p>
<p>AMS启动</p>
<p><a href="https://mp.weixin.qq.com/s/8Fii9ofRpAJscXJC2bIwfQ">[1] Pingred, 手把手带你搞懂AMS启动原理, 2023.</a></p>
<p><a href="https://juejin.cn/post/7125057980420063268">[2] Avengong, Android渲染(一)_系统服务WMS启动过程(基于Android10), 2022.</a></p>
<p><a href="https://juejin.cn/post/7160870305051705352">[3] 345丶, Android | WMS 解析 (一), 2022.</a></p>
<p>window and windowmanager</p>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzA5MzI3NjE2MA==&amp;mid=2650269748&amp;idx=1&amp;sn=33b385cc4ebc9a9b563d500aae3867e6&amp;chksm=8863195bbf14904d961e5ef578785424f37fc00103d9947d102f9588a1939fb51c084a5fde68&amp;scene=27">[1] Chunyu J, Android Window 机制, 2022.</a></p>
<p><a href="https://mp.weixin.qq.com/s/iidzG_xV9RhWuCiNilGtMQ">[2] 小余的自习室, 源码学习时间，Window Manager in Android, 2023.</a></p>
<p><a href="https://juejin.cn/post/7076274407416528909">[3] 345丶, Android | 理解 Window 和 WindowManager, 2022.</a></p>
<p>addView/addWindow</p>
<p><a href="https://mp.weixin.qq.com/s/q_V6JI6Ng6Huj-EIG2o24w">[1] a5right, Android View从绘制到上屏全过程解析, 2023.</a></p>
<p><a href="https://www.jianshu.com/p/579e9cc8b83c">[2] Anderson大码渣, What is DecorView and android.R.id.content?, 2017.</a></p>
<p><a href="https://juejin.cn/post/6844903506541805582">[3] 刘望舒, Android解析WindowManagerService（二）WMS的重要成员和Window的添加过程, 2017.</a></p>
<p><a href="https://juejin.cn/post/6844903560262451213">[4] 刘望舒, Android解析WindowManagerService（三）Window的删除过程, 2018.</a></p>
<p><a href="https://blog.csdn.net/learnframework/article/details/129051608?spm=1001.2014.3001.5502">[5] learnframework, android 13 WMS/AMS系统开发-SplashScreen的添加与移除分析, 2023.</a></p>
<p><a href="https://www.jianshu.com/p/9dafea9cb3c0">[6] 被代码淹没的小伙子, 【Window系列】——PopupWindow的前世今生, 2019.</a></p>
<p>window层级/windowcontainer</p>
<p><a href="https://m.ithome.com/html/647058.htm">[1] TechMerger, 你知道 Android 是如何管理复杂的 Window 层级的？, 2022.</a></p>
<p><a href="https://juejin.cn/post/7172598258064162830#heading-4">[2] 小余的自习室, “一文读懂”系列：无处不在的WMS, 2022.</a></p>
<p><a href="https://juejin.cn/post/6844903489366130701">[3] Looperjing, Android窗口系统第一篇&mdash;Window的抽象概念和WMS相关数据结构理解, 2017.</a></p>
<p><a href="https://blog.csdn.net/aofan9566/article/details/101821620">[4] aofan9566, WindowState注意事项, 2015.</a></p>
<p><a href="https://blog.csdn.net/weixin_41591109/article/details/128025338?spm=1001.2101.3001.6650.1&amp;utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-1-128025338-blog-126748372.235%5Ev27%5Epc_relevant_recovery_v2&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-1-128025338-blog-126748372.235%5Ev27%5Epc_relevant_recovery_v2&amp;utm_relevant_index=2">[5] weixin_41591109, android 11 的Window的屏幕的架构图, 2022.</a></p>
<p><a href="https://blog.csdn.net/q1165328963/article/details/127746382">[6] qluka, Android 窗口结构(一) 窗口层级构造, 2022.</a></p>
<p><a href="https://blog.csdn.net/q1165328963/article/details/127841486?spm=1001.2014.3001.5502">[7] qluka, Android 窗口结构(二) 添加Home Task, 2022.</a></p>
<p><a href="https://blog.csdn.net/ukynho/article/details/126748176?spm=1001.2014.3001.5502">[8] Geralt_z_Rivii, 2【Android 12】WindowContainer类, 2022.</a></p>
<p><a href="https://blog.csdn.net/ukynho/article/details/126748372">[9] Geralt_z_Rivii, 3【Android 12】DisplayArea层级结构, 2022.</a></p>
<p><a href="https://blog.csdn.net/jieliaoyuan8279/article/details/123157937?spm=1001.2101.3001.6650.15&amp;utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7ERate-15-123157937-blog-126748176.235%5Ev27%5Epc_relevant_recovery_v2&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7ERate-15-123157937-blog-126748176.235%5Ev27%5Epc_relevant_recovery_v2&amp;utm_relevant_index=20">[10] TigherGuo, 安卓12窗口层次: DisplayArea树, 2022.</a></p>
<p><a href="https://blog.csdn.net/shensky711/article/details/121530510?spm=1001.2101.3001.6650.9&amp;utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7ERate-9-121530510-blog-126748176.235%5Ev27%5Epc_relevant_recovery_v2&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7ERate-9-121530510-blog-126748176.235%5Ev27%5Epc_relevant_recovery_v2&amp;utm_relevant_index=14">[11] HansChen_, Android 12 - WMS 层级结构 &amp;&amp; DisplayAreaGroup 引入, 2021.</a></p>
<p><a href="https://blog.csdn.net/learnframework/article/details/129101781?spm=1001.2014.3001.5502">[12] learnframework, android 13 WMS/AMS系统开发-窗口层级相关DisplayArea,WindowContainer, 2023.</a></p>
<p><a href="https://blog.csdn.net/learnframework/article/details/129115725?spm=1001.2014.3001.5502">[13] learnframework, android 13 WMS/AMS系统开发-窗口层级相关DisplayArea,WindowContainer第二节, 2023.</a></p>
<p><a href="https://blog.csdn.net/learnframework/article/details/129175890?spm=1001.2014.3001.5502">[14] learnframework, android 13 WMS/AMS系统开发-窗口层级相关Task/ActivityRecord/WindowState/WindowToken放置图层创建 第三节, 2023.</a></p>
<p><a href="https://blog.csdn.net/learnframework/article/details/129132667?spm=1001.2014.3001.5502">[15] learnframework, android 13 WMS/AMS系统开发-窗口层级相关SurfaceFlinger图层创建 第三节, 2023.</a></p>
<p>锁屏相关</p>
<p><a href="https://blog.csdn.net/learnframework/article/details/127483545">[1] learnframework, Android 12中系统Wallpaper详解1&ndash;锁屏透看壁纸和桌面透看壁纸的切换, 2022.</a></p>
<p>view相关</p>
<p><a href="https://blog.csdn.net/qian520ao/article/details/81144167">[1] 凶残的程序员, Android 屏幕绘制机制及硬件加速, 2019.</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/464492155">[2] 沧浪之水, Android GPU硬件加速渲染流程（上）, 2022.</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/464564859">[3] 沧浪之水, Android GPU硬件加速渲染流程（下）, 2022.</a></p>
<p><a href="https://juejin.cn/post/7128779284503592991">[4] 𝓑𝓮𝓲𝓨𝓪𝓷𝓰, 软件绘制 &amp; 硬件加速绘制 【DisplayList &amp; RenderNode】, 2022.</a></p>
<p><a href="https://juejin.cn/post/7129330919990624269">[5] 𝓑𝓮𝓲𝓨𝓪𝓷𝓰, 硬件加速绘制基础知识, 2022.</a></p>
<p><a href="https://blog.csdn.net/rzleilei/article/details/126118441">[6] 失落夏天, View绘制流程3-Vsync信号是如何发送和接受的, 2022.</a></p>
<p><a href="https://blog.csdn.net/houliang120/article/details/50908098">[7] houliang120, Android垂直同步信号VSync的产生及传播结构详解, 2016.</a></p>
              
            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">标签</span><br/>
                    
  <a class="tag tag--primary tag--small" href="https://yangyang48.github.io/tags/android/">Android</a>

  <a class="tag tag--primary tag--small" href="https://yangyang48.github.io/tags/%E6%BA%90%E7%A0%81/">源码</a>

  <a class="tag tag--primary tag--small" href="https://yangyang48.github.io/tags/binder/">Binder</a>

  <a class="tag tag--primary tag--small" href="https://yangyang48.github.io/tags/wms/">WMS</a>

  <a class="tag tag--primary tag--small" href="https://yangyang48.github.io/tags/window/">Window</a>

  <a class="tag tag--primary tag--small" href="https://yangyang48.github.io/tags/windowmanager/">WindowManager</a>

  <a class="tag tag--primary tag--small" href="https://yangyang48.github.io/tags/viewrootimpl/">ViewRootImpl</a>

  <a class="tag tag--primary tag--small" href="https://yangyang48.github.io/tags/decorview/">DecorView</a>

  <a class="tag tag--primary tag--small" href="https://yangyang48.github.io/tags/windowtoken/">WindowToken</a>

  <a class="tag tag--primary tag--small" href="https://yangyang48.github.io/tags/windowstate/">WindowState</a>

  <a class="tag tag--primary tag--small" href="https://yangyang48.github.io/tags/window%E5%B1%82%E7%BA%A7/">Window层级</a>

  <a class="tag tag--primary tag--small" href="https://yangyang48.github.io/tags/window%E5%AE%B9%E5%99%A8/">Window容器</a>

                  </div>
                
              
            
            <div class="post-actions-wrap">
  
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://yangyang48.github.io/2021/07/leetcode-hot100/" data-tooltip="LeetCode hot100">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">下一篇</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://yangyang48.github.io/2023/03/service-call%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%BB%A5%E8%93%9D%E7%89%99%E6%89%93%E5%BC%80%E5%85%B3%E9%97%AD%E4%B8%BA%E4%BE%8B/" data-tooltip="service call源码分析(以蓝牙打开关闭为例)">
              
                  <span class="hide-xs hide-sm text-small icon-mr">上一篇</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#disqus_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#">
        
          <i class="fa fa-list"></i>
        </a>
      </li>
    </ul>
  
</div>

            
              
                <div id="disqus_thread">
  <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
              
            
          </div>
        </article>
		
		<div class="post-comment main-content-wrap">
		
  
  <div id="vcomments"></div>
  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src='//unpkg.com/valine/dist/Valine.min.js'></script>
  <script type="text/javascript">
    new Valine({
        el: '#vcomments' ,
        appId: 'mwl8M1aQzLnRE6JIpIY3sgE5-9Nh9j0Va',
        appKey: 'mPGr6GMC0BuzAKkxinnd0IAr',
        notify:  true , 
        verify:  false , 
        avatar:'retro', 
        placeholder: '欢迎各位宝宝留言~',
        visitor:  true 
    });
  </script>

		</div>
        <footer id="footer" class="main-content-wrap">
  
  
  
  <span class="copyrights">
    &copy; 2023 Yang Ju. All Rights Reserved
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
        <div class="post-actions-wrap">
  
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://yangyang48.github.io/2021/07/leetcode-hot100/" data-tooltip="LeetCode hot100">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">下一篇</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="https://yangyang48.github.io/2023/03/service-call%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%BB%A5%E8%93%9D%E7%89%99%E6%89%93%E5%BC%80%E5%85%B3%E9%97%AD%E4%B8%BA%E4%BE%8B/" data-tooltip="service call源码分析(以蓝牙打开关闭为例)">
              
                  <span class="hide-xs hide-sm text-small icon-mr">上一篇</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
      
        <li class="post-action">
          <a class="post-action-btn btn btn--default" href="#disqus_thread">
            <i class="fa fa-comment-o"></i>
          </a>
        </li>
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#">
        
          <i class="fa fa-list"></i>
        </a>
      </li>
    </ul>
  
</div>

      </div>
      <div id="share-options-bar" class="share-options-bar" data-behavior="4">
  <i id="btn-close-shareoptions" class="fa fa-close"></i>
  <ul class="share-options">
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fyangyang48.github.io%2F2023%2F04%2Fwms-window%2F">
          <i class="fa fa-facebook-official"></i><span>分享到 Facebook</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=https%3A%2F%2Fyangyang48.github.io%2F2023%2F04%2Fwms-window%2F">
          <i class="fa fa-twitter"></i><span>分享到 Twitter</span>
        </a>
      </li>
    
      <li class="share-option">
        <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=https%3A%2F%2Fyangyang48.github.io%2F2023%2F04%2Fwms-window%2F">
          <i class="fa fa-google-plus"></i><span>分享到 Google&#43;</span>
        </a>
      </li>
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>
    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="https://img-blog.csdnimg.cn/20210711204627625.jpg" alt="作者的图片" />
    
    <h4 id="about-card-name">Yang Ju</h4>
    
      <div id="about-card-bio">Nanjing University of Science and Technology</div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Software Development Engineer
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        NanJing,China
      </div>
    
  </div>
</div>

    

    
  
    
      <div id="cover" style="background-image:url('https://yangyang48.github.io/images/cover.jpg');"></div>
    
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.7/js/jquery.fancybox.min.js" integrity="sha256-GEAnjcTqVP+vBp3SSc8bEDQqvWAZMiHyUSIorrWwH50=" crossorigin="anonymous"></script>


<script src="https://yangyang48.github.io/js/script-pcw6v3xilnxydl1vddzazdverrnn9ctynvnxgwho987mfyqkuylcb1nlt.min.js"></script>


  
    <script src="https://yangyang48.github.io/js/copy-to-clipboard.js"></script>
  

<script lang="javascript">
window.onload = updateMinWidth;
window.onresize = updateMinWidth;
document.getElementById("sidebar").addEventListener("transitionend", updateMinWidth);
function updateMinWidth() {
  var sidebar = document.getElementById("sidebar");
  var main = document.getElementById("main");
  main.style.minWidth = "";
  var w1 = getComputedStyle(main).getPropertyValue("min-width");
  var w2 = getComputedStyle(sidebar).getPropertyValue("width");
  var w3 = getComputedStyle(sidebar).getPropertyValue("left");
  main.style.minWidth = `calc(${w1} - ${w2} - ${w3})`;
}
</script>

<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>


  
    
      <script>
        var disqus_config = function () {
          this.page.url = 'https:\/\/yangyang48.github.io\/2023\/04\/wms-window\/';
          
            this.page.identifier = '\/2023\/04\/wms-window\/'
          
        };
        (function() {
          
          
          if (window.location.hostname == "localhost") {
            return;
          }
          var d = document, s = d.createElement('script');
          var disqus_shortname = 'hugo-tranquilpeak-theme';
          s.src = '//' + disqus_shortname + '.disqus.com/embed.js';

          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();
      </script>
    
  




    
  </body>
</html>

